<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buyer Dashboard - AgriGuard AI</title>
    <style>



        /* Reset and Base Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        /* Primary Colors */
        --primary-color: #2ecc71;
        --primary-dark: #27ae60;
        --primary-light: #a8e6cf;

        /* Secondary Colors */
        --secondary-color: #3498db;
        --secondary-dark: #2980b9;

        /* Status Colors */
        --success-color: #27ae60;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --info-color: #3498db;

        /* Neutral Colors */
        --white: #ffffff;
        --light-gray: #f8f9fa;
        --gray: #ecf0f1;
        --dark-gray: #95a5a6;
        --text-dark: #2c3e50;
        --text-light: #7f8c8d;
        --border-color: #dfe6e9;

        /* Chart Colors */
        --chart-blue: #3498db;
        --chart-green: #2ecc71;
        --chart-orange: #f39c12;
        --chart-purple: #9b59b6;
        --chart-red: #e74c3c;

        /* Shadows */
        --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);

        /* Spacing */
        --spacing-xs: 0.25rem;
        --spacing-sm: 0.5rem;
        --spacing-md: 1rem;
        --spacing-lg: 1.5rem;
        --spacing-xl: 2rem;

        /* Border Radius */
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --radius-xl: 16px;

        /* Transitions */
        --transition-fast: 0.15s ease;
        --transition-base: 0.3s ease;
        --transition-slow: 0.5s ease;

        /* Layout */
        --header-height: 70px;
        --sidebar-width: 260px;
        --sidebar-collapsed-width: 70px;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--light-gray);
        color: var(--text-dark);
        line-height: 1.6;
        overflow-x: hidden;
    }

    /* Header Styles */
    .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: var(--header-height);
        background-color: var(--white);
        box-shadow: var(--shadow-md);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--spacing-xl);
        z-index: 1000;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
    }

    .menu-toggle {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-dark);
        cursor: pointer;
        padding: var(--spacing-sm);
        border-radius: var(--radius-md);
        transition: var(--transition-base);
    }

    .menu-toggle:hover {
        background-color: var(--gray);
    }

    .logo {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .logo i {
        font-size: 2rem;
    }

    .header-center {
        flex: 1;
        max-width: 600px;
        margin: 0 var(--spacing-xl);
    }

    .search-bar {
        position: relative;
        width: 100%;
    }

    .search-bar i {
        position: absolute;
        left: var(--spacing-md);
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-light);
    }

    .search-bar input {
        width: 100%;
        padding: var(--spacing-sm) var(--spacing-md) var(--spacing-sm) 2.5rem;
        border: 2px solid var(--border-color);
        border-radius: var(--radius-lg);
        font-size: 0.95rem;
        transition: var(--transition-base);
    }

    .search-bar input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
    }

    .notifications {
        position: relative;
    }

    .icon-btn {
        position: relative;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-dark);
        cursor: pointer;
        padding: var(--spacing-sm);
        border-radius: var(--radius-md);
        transition: var(--transition-base);
    }

    .icon-btn:hover {
        background-color: var(--gray);
    }

    .badge {
        position: absolute;
        top: 0;
        right: 0;
        background-color: var(--danger-color);
        color: var(--white);
        font-size: 0.7rem;
        font-weight: 700;
        padding: 0.15rem 0.4rem;
        border-radius: 10px;
        min-width: 18px;
        text-align: center;
    }

    .notifications-dropdown {
        position: absolute;
        top: calc(100% + var(--spacing-sm));
        right: 0;
        width: 350px;
        background-color: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        display: none;
        max-height: 400px;
        overflow-y: auto;
    }

    .notifications-dropdown.active {
        display: block;
    }

    .notifications-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--border-color);
    }

    .notifications-header h3 {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .mark-read {
        background: none;
        border: none;
        color: var(--primary-color);
        font-size: 0.85rem;
        cursor: pointer;
    }

    .notifications-list {
        padding: var(--spacing-sm);
    }

    .user-menu {
        position: relative;
    }

    .user-btn {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        background: none;
        border: none;
        cursor: pointer;
        padding: var(--spacing-sm);
        border-radius: var(--radius-md);
        transition: var(--transition-base);
    }

    .user-btn:hover {
        background-color: var(--gray);
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        background-color: var(--primary-light);
    }

    .user-name {
        font-weight: 600;
        color: var(--text-dark);
    }

    .user-dropdown {
        position: absolute;
        top: calc(100% + var(--spacing-sm));
        right: 0;
        width: 200px;
        background-color: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        display: none;
        overflow: hidden;
    }

    .user-dropdown.active {
        display: block;
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
        color: var(--text-dark);
        text-decoration: none;
        transition: var(--transition-base);
    }

    .dropdown-item:hover {
        background-color: var(--gray);
    }

    .dropdown-item i {
        font-size: 1.1rem;
        width: 20px;
    }







    /* Dashboard Container */
    .dashboard-container {
        display: flex;
        margin-top: var(--header-height);
        min-height: calc(100vh - var(--header-height));
    }

    /* Sidebar Styles */
.sidebar {
    position: fixed;
    left: 0;
    top: var(--header-height);
    width: var(--sidebar-width);
    height: calc(100vh - var(--header-height));
    background: linear-gradient(180deg, #e8f5e9 0%, #c8e6c9 100%);
    box-shadow: var(--shadow-md);
    overflow-y: auto;
    transition: var(--transition-base);
    z-index: 100;
}

    .sidebar.collapsed {
        width: var(--sidebar-collapsed-width);
    }

    .sidebar-nav {
        padding: var(--spacing-md);
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        color: var(--text-dark);
        text-decoration: none;
        border-radius: var(--radius-md);
        transition: var(--transition-base);
        position: relative;
        margin-bottom: var(--spacing-xs);
    }

    .nav-item:hover {
        background-color: var(--gray);
    }

    .nav-item.active {
        background-color: var(--primary-light);
        color: var(--primary-dark);
        font-weight: 600;
    }

    .nav-item i {
        font-size: 1.3rem;
        min-width: 24px;
        text-align: center;
    }

    .nav-item .badge {
        margin-left: auto;
    }








    /* Main Content Styles */
    .main-content {
        flex: 1;
        margin-left: var(--sidebar-width);
        padding: var(--spacing-xl);
        transition: var(--transition-base);
    }

    .sidebar.collapsed ~ .main-content {
        margin-left: var(--sidebar-collapsed-width);
    }

    .content-section {
        display: none;
    }

    .content-section.active {
        display: block;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-xl);
    }

    .section-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-dark);
    }

    .header-actions {
        display: flex;
        gap: var(--spacing-md);
        align-items: center;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-lg);
        border: none;
        border-radius: var(--radius-md);
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-base);
        text-decoration: none;
    }

    .btn-primary {
        background-color: var(--primary-color);
        color: var(--white);
    }

    .btn-primary:hover {
        background-color: var(--primary-dark);
    }

    .btn-secondary {
        background-color: var(--gray);
        color: var(--text-dark);
    }

    .btn-secondary:hover {
        background-color: var(--dark-gray);
        color: var(--white);
    }

    .btn-block {
        width: 100%;
        justify-content: center;
    }

    .link-btn {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
        transition: var(--transition-base);
    }

    .link-btn:hover {
        color: var(--primary-dark);
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .stat-card {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
        display: flex;
        gap: var(--spacing-md);
        transition: var(--transition-base);
    }

    .stat-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: var(--white);
    }

    .stat-icon.blue {
        background-color: var(--chart-blue);
    }

    .stat-icon.green {
        background-color: var(--chart-green);
    }

    .stat-icon.orange {
        background-color: var(--chart-orange);
    }

    .stat-icon.purple {
        background-color: var(--chart-purple);
    }

    .stat-details {
        flex: 1;
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--text-light);
        margin-bottom: var(--spacing-xs);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: var(--spacing-xs);
    }

    .stat-change {
        font-size: 0.85rem;
        color: var(--text-light);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .stat-change.positive {
        color: var(--success-color);
    }

    .stat-change.negative {
        color: var(--danger-color);
    }

    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .chart-card {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .chart-header h3 {
        font-size: 1.2rem;
        font-weight: 600;
    }

    .chart-filter {
        padding: var(--spacing-sm) var(--spacing-md);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.9rem;
        cursor: pointer;
    }

    .chart-container {
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-light);
    }

    /* Data Card */
    .data-card {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
        margin-bottom: var(--spacing-xl);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--border-color);
    }

    .card-header h3 {
        font-size: 1.2rem;
        font-weight: 600;
    }

    /* Table Styles */
    .table-container {
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table thead {
        background-color: var(--light-gray);
    }

    .data-table th {
        padding: var(--spacing-md);
        text-align: left;
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .data-table td {
        padding: var(--spacing-md);
        border-top: 1px solid var(--border-color);
    }

    .data-table tbody tr {
        transition: var(--transition-base);
    }

    .data-table tbody tr:hover {
        background-color: var(--light-gray);
    }

    /* Status Badges */
    .status-badge {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        border-radius: var(--radius-lg);
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-badge.pending {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-badge.confirmed {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .status-badge.shipped {
        background-color: #d4edda;
        color: #155724;
    }

    .status-badge.delivered {
        background-color: #d4edda;
        color: #155724;
    }

    .status-badge.cancelled {
        background-color: #f8d7da;
        color: #721c24;
    }

    .status-badge.completed {
        background-color: #d4edda;
        color: #155724;
    }

    .status-badge.failed {
        background-color: #f8d7da;
        color: #721c24;
    }

    /* Filter Styles */
    .filter-group {
        display: flex;
        gap: var(--spacing-sm);
    }

    .filter-select {
        padding: var(--spacing-sm) var(--spacing-md);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.9rem;
        cursor: pointer;
        transition: var(--transition-base);
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .filter-tabs {
        display: flex;
        gap: var(--spacing-sm);
        background-color: var(--gray);
        padding: var(--spacing-xs);
        border-radius: var(--radius-md);
    }

    .tab-btn {
        padding: var(--spacing-sm) var(--spacing-md);
        border: none;
        background: none;
        border-radius: var(--radius-sm);
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-base);
    }

    .tab-btn:hover {
        background-color: var(--white);
    }

    .tab-btn.active {
        background-color: var(--white);
        color: var(--primary-color);
    }

    /* Products Grid */
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--spacing-lg);
    }

    .product-card {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        transition: var(--transition-base);
        cursor: pointer;
    }

    .product-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-4px);
    }

    .product-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background-color: var(--gray);
    }

    .product-info {
        padding: var(--spacing-md);
    }

    .product-category {
        font-size: 0.8rem;
        color: var(--text-light);
        text-transform: uppercase;
        margin-bottom: var(--spacing-xs);
    }

    .product-name {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: var(--spacing-sm);
    }

    .product-farmer {
        font-size: 0.9rem;
        color: var(--text-light);
        margin-bottom: var(--spacing-sm);
    }

    .product-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .product-price {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .product-rating {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        color: var(--warning-color);
    }

    /* Orders List */
    .orders-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
    }

    .order-card {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
    }

    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
        padding-bottom: var(--spacing-md);
        border-bottom: 1px solid var(--border-color);
    }

    .order-id {
        font-weight: 600;
        color: var(--text-dark);
    }

    .order-date {
        color: var(--text-light);
        font-size: 0.9rem;
    }

    .order-items {
        margin-bottom: var(--spacing-md);
    }

    .order-item {
        display: flex;
        gap: var(--spacing-md);
        padding: var(--spacing-sm) 0;
    }

    .order-item-image {
        width: 60px;
        height: 60px;
        border-radius: var(--radius-md);
        object-fit: cover;
        background-color: var(--gray);
    }

    .order-item-info {
        flex: 1;
    }

    .order-item-name {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .order-item-details {
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .order-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--border-color);
    }

    .order-total {
        font-size: 1.2rem;
        font-weight: 700;
    }

    .order-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    /* Cart Styles */
    .cart-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: var(--spacing-lg);
    }

    .cart-items {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .cart-item {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        display: flex;
        gap: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
    }

    .cart-item-image {
        width: 120px;
        height: 120px;
        border-radius: var(--radius-md);
        object-fit: cover;
        background-color: var(--gray);
    }

    .cart-item-details {
        flex: 1;
    }

    .cart-item-name {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .cart-item-farmer {
        color: var(--text-light);
        margin-bottom: var(--spacing-md);
    }

    .cart-item-controls {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .quantity-control {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
    }

    .quantity-btn {
        background: none;
        border: none;
        padding: var(--spacing-sm) var(--spacing-md);
        cursor: pointer;
        font-size: 1.2rem;
        color: var(--primary-color);
    }

    .quantity-value {
        padding: 0 var(--spacing-md);
        font-weight: 600;
    }

    .cart-item-price {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .cart-item-remove {
        background: none;
        border: none;
        color: var(--danger-color);
        cursor: pointer;
        padding: var(--spacing-sm);
        font-size: 1.2rem;
    }

    .cart-summary {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
        height: fit-content;
        position: sticky;
        top: calc(var(--header-height) + var(--spacing-lg));
    }

    .cart-summary h3 {
        margin-bottom: var(--spacing-lg);
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: var(--spacing-sm) 0;
        font-size: 0.95rem;
    }

    .summary-row.total {
        border-top: 2px solid var(--border-color);
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        font-size: 1.2rem;
        font-weight: 700;
    }

    /* Farmers Grid */
    .farmers-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: var(--spacing-lg);
    }

    .farmer-card {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
        text-align: center;
        transition: var(--transition-base);
    }

    .farmer-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .farmer-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        background-color: var(--primary-light);
        margin: 0 auto var(--spacing-md);
    }

    .farmer-name {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .farmer-location {
        color: var(--text-light);
        margin-bottom: var(--spacing-md);
    }

    .farmer-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: var(--spacing-md);
        padding: var(--spacing-md) 0;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
    }

    .farmer-stat {
        text-align: center;
    }

    .farmer-stat-value {
        font-weight: 700;
        font-size: 1.1rem;
        display: block;
    }

    .farmer-stat-label {
        font-size: 0.8rem;
        color: var(--text-light);
    }

    .farmer-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    /* Tracking List */
    .tracking-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-lg);
    }

    .tracking-card {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
    }

    .tracking-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .tracking-timeline {
        position: relative;
        padding-left: var(--spacing-xl);
    }

    .tracking-step {
        position: relative;
        padding-bottom: var(--spacing-lg);
    }

    .tracking-step:last-child {
        padding-bottom: 0;
    }

    .tracking-step::before {
        content: '';
        position: absolute;
        left: -22px;
        top: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: var(--gray);
        border: 3px solid var(--white);
        box-shadow: 0 0 0 2px var(--gray);
    }

    .tracking-step.active::before {
        background-color: var(--primary-color);
        box-shadow: 0 0 0 2px var(--primary-color);
    }

    .tracking-step::after {
        content: '';
        position: absolute;
        left: -17px;
        top: 20px;
        width: 2px;
        height: calc(100% - 20px);
        background-color: var(--gray);
    }

    .tracking-step:last-child::after {
        display: none;
    }

    .tracking-step.active::after {
        background-color: var(--primary-color);
    }

    .tracking-step-title {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .tracking-step-time {
        font-size: 0.9rem;
        color: var(--text-light);
    }

    /* Quality Cards */
    .quality-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .info-card {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
        text-align: center;
    }

    .info-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto var(--spacing-md);
        border-radius: 50%;
        background-color: var(--primary-light);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: var(--primary-color);
    }

    .info-card h3 {
        margin-bottom: var(--spacing-sm);
    }

    .info-card p {
        color: var(--text-light);
    }

    /* Messages Styles */
    .messages-container {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: var(--spacing-lg);
        height: calc(100vh - var(--header-height) - 200px);
    }

    .conversations-list {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

    .conversations-header {
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--border-color);
    }

    .conversations {
        overflow-y: auto;
        height: calc(100% - 80px);
    }

    .conversation-item {
        display: flex;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        cursor: pointer;
        transition: var(--transition-base);
        border-bottom: 1px solid var(--border-color);
    }

    .conversation-item:hover {
        background-color: var(--light-gray);
    }

    .conversation-item.active {
        background-color: var(--primary-light);
    }

    .conversation-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        background-color: var(--gray);
    }

    .conversation-details {
        flex: 1;
        overflow: hidden;
    }

    .conversation-name {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .conversation-last-message {
        font-size: 0.9rem;
        color: var(--text-light);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-area {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--border-color);
    }

    .chat-user-info {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .chat-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        background-color: var(--gray);
    }

    .chat-user-name {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .chat-user-status {
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .message {
        max-width: 70%;
        padding: var(--spacing-md);
        border-radius: var(--radius-lg);
    }

    .message.sent {
        background-color: var(--primary-color);
        color: var(--white);
        align-self: flex-end;
        border-bottom-right-radius: var(--spacing-xs);
    }

    .message.received {
        background-color: var(--gray);
        align-self: flex-start;
        border-bottom-left-radius: var(--spacing-xs);
    }

    .message-time {
        font-size: 0.8rem;
        margin-top: var(--spacing-xs);
        opacity: 0.7;
    }

    .chat-input-area {
        padding: var(--spacing-md) var(--spacing-lg);
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: var(--spacing-md);
    }

    .chat-input {
        flex: 1;
        padding: var(--spacing-sm) var(--spacing-md);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-lg);
        font-size: 0.95rem;
    }

    .chat-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    /* Reports Grid */
    .reports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: var(--spacing-lg);
    }

    .report-card {
        background-color: var(--white);
        border-radius: var(--radius-lg);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
    }

    .report-card h3 {
        margin-bottom: var(--spacing-lg);
    }

    /* Input Styles */
    .search-input {
        padding: var(--spacing-sm) var(--spacing-md);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.95rem;
        min-width: 250px;
        transition: var(--transition-base);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .date-input {
        padding: var(--spacing-sm) var(--spacing-md);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 0.95rem;
        cursor: pointer;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }

        .reports-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 992px) {
        .cart-container {
            grid-template-columns: 1fr;
        }

        .messages-container {
            grid-template-columns: 1fr;
        }

        .conversations-list {
            display: none;
        }
    }

    @media (max-width: 768px) {
        .header {
            padding: 0 var(--spacing-md);
        }

        .header-center {
            display: none;
        }

        .sidebar {
            transform: translateX(-100%);
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .main-content {
            margin-left: 0;
            padding: var(--spacing-md);
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .products-grid {
            grid-template-columns: 1fr;
        }

        .farmers-grid {
            grid-template-columns: 1fr;
        }

        .quality-cards {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 576px) {
        :root {
            --header-height: 60px;
            --spacing-xl: 1rem;
        }

        .logo span {
            display: none;
        }

        .user-name {
            display: none;
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-md);
        }

        .header-actions {
            width: 100%;
            flex-wrap: wrap;
        }

        .filter-tabs {
            flex-wrap: wrap;
        }
    }

    /* Scrollbar Styles */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--light-gray);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--dark-gray);
        border-radius: var(--radius-md);
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--text-dark);
    }

    /* Loading Spinner */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid var(--gray);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--text-light);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: var(--spacing-md);
        opacity: 0.3;
    }

    .empty-state h3 {
        margin-bottom: var(--spacing-sm);
    }

    /* Action Buttons */
    .action-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        padding: var(--spacing-xs);
        font-size: 1rem;
        transition: var(--transition-base);
    }

    .action-btn:hover {
        color: var(--primary-dark);
    }

    .action-btn.danger {
        color: var(--danger-color);
    }

    .action-btn.danger:hover {
        color: #c0392b;
    }



        /* Styles pour l'affichage des produits du farmer */
.farmer-products-header {
    background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
    color: var(--white);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    text-align: center;
}

.farmer-products-header h3 {
    margin-bottom: var(--spacing-sm);
    color: var(--white);
}

.product-details {
    margin: var(--spacing-md) 0;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-xs);
    font-size: 0.9rem;
    color: var(--text-light);
}

.detail-item i {
    width: 16px;
    color: var(--primary-color);
}

.product-quality {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: var(--spacing-md) 0;
    padding: var(--spacing-sm) 0;
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
}

.quality-badge {
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.quality-organic {
    background-color: #d4edda;
    color: #155724;
}

.quality-certified {
    background-color: #cce7ff;
    color: #004085;
}

.quality-standard {
    background-color: #fff3cd;
    color: #856404;
}

.production-method {
    font-size: 0.8rem;
    color: var(--text-light);
    text-transform: capitalize;
}

.product-badge {
    position: absolute;
    top: var(--spacing-sm);
    right: var(--spacing-sm);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.product-badge.organic {
    background-color: #27ae60;
    color: white;
}

.product-badge.ready {
    background-color: #3498db;
    color: white;
}

.product-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: var(--gray);
    color: var(--text-light);
}

.product-placeholder i {
    font-size: 3rem;
    margin-bottom: var(--spacing-sm);
}





        /* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    padding: 1rem;
    overflow-y: auto;
    backdrop-filter: blur(5px);
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 20px;
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease;
    position: relative;
}

.modal-content.large {
    max-width: 1200px;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px) scale(0.9);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
    border-radius: 20px 20px 0 0;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
}

.modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    font-size: 1.5rem;
    color: white;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition-base);
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.modal-body {
    padding: 2rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem 2rem;
    border-top: 1px solid var(--border-color);
    background: var(--light-gray);
    border-radius: 0 0 20px 20px;
}

/* Product Details Grid */
.product-details-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
}

@media (min-width: 768px) {
    .product-details-grid {
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
    }
}

.product-image-section {
    position: relative;
}

.product-image-section img {
    width: 100%;
    height: 300px;
    object-fit: cover;
    border-radius: 15px;
    box-shadow: var(--shadow-lg);
}

@media (min-width: 768px) {
    .product-image-section img {
        height: 400px;
    }
}

.product-placeholder-large {
    width: 100%;
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
    border-radius: 15px;
    flex-direction: column;
    color: white;
}

@media (min-width: 768px) {
    .product-placeholder-large {
        height: 400px;
    }
}

.product-placeholder-large i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.8;
}

/* Info Grid */
.info-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
}

@media (min-width: 480px) {
    .info-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

.info-item {
    padding: 1rem;
    background: var(--white);
    border-radius: 12px;
    border: 2px solid var(--border-color);
    transition: var(--transition-base);
}

.info-item:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.info-item .label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    color: var(--text-light);
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.info-item .label i {
    width: 16px;
    color: var(--primary-color);
}

.info-item .value {
    display: block;
    font-weight: 700;
    color: var(--text-dark);
    font-size: 1.1rem;
}

/* Status Badges */
.status-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-organic {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.status-certified {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
}

.status-harvested {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.status-growing {
    background: linear-gradient(135deg, #84cc16, #65a30d);
    color: white;
}

/* Nutritional Info */
.nutritional-info {
    margin-top: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, var(--primary-light), #dbeafe);
    border-radius: 15px;
    border-left: 4px solid var(--primary-color);
}

.nutritional-info h4 {
    margin-bottom: 1rem;
    color: var(--primary-dark);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Action Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 10px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-base);
    text-decoration: none;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
}

.btn-secondary {
    background: var(--gray);
    color: var(--text-dark);
}

.btn-secondary:hover {
    background: var(--dark-gray);
    color: white;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

/* Price Highlight */
.price-highlight {
    font-size: 1.5rem !important;
    color: var(--primary-color) !important;
    font-weight: 800 !important;
}

/* Quality Badges */
.quality-badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
}

.quality-organic {
    background: #d1fae5;
    color: #065f46;
    border: 2px solid #a7f3d0;
}

.quality-certified {
    background: #dbeafe;
    color: #1e40af;
    border: 2px solid #93c5fd;
}

.quality-standard {
    background: #fef3c7;
    color: #92400e;
    border: 2px solid #fcd34d;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .modal {
        padding: 0.5rem;
    }

    .modal-content {
        border-radius: 15px;
    }

    .modal-header {
        padding: 1rem 1.5rem;
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        flex-direction: column;
        gap: 0.5rem;
    }

    .btn {
        width: 100%;
        justify-content: center;
    }

    .info-grid {
        grid-template-columns: 1fr;
    }

    .product-image-section img {
        height: 250px;
    }
}

@media (max-width: 480px) {
    .modal-header h2 {
        font-size: 1.3rem;
    }

    .info-item .value {
        font-size: 1rem;
    }

    .modal-body {
        padding: 1rem;
    }
}

/* Loading States */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Empty States */
.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-light);
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.3;
}

/* Scrollbar for Modal */
.modal-content::-webkit-scrollbar {
    width: 8px;
}

.modal-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 0 0 20px 0;
}

.modal-content::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
    background: var(--primary-dark);
}



        /* Additional badge styles for price trends */
.product-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    color: white;
    z-index: 2;
}

/* Make sure badges don't overlap */
.product-image {
    position: relative;
}

.product-image .product-badge:nth-child(2) {
    top: 40px; /* Second badge position */
}

.product-image .product-badge:nth-child(3) {
    top: 70px; /* Third badge position */
}



        /* Add to your existing CSS */
.order-summary {
    margin-bottom: 1.5rem;
}

.order-item-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
}

.order-item-summary:last-child {
    border-bottom: none;
}

.item-info {
    display: flex;
    flex-direction: column;
}

.item-info strong {
    color: var(--text-dark);
    margin-bottom: 0.25rem;
}

.item-info span {
    color: var(--text-light);
    font-size: 0.9rem;
}

.order-totals {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 2px solid var(--border-color);
}

.total-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.final-total {
    font-weight: bold;
    font-size: 1.1rem;
    color: var(--primary-color);
    border-top: 1px solid var(--border-color);
    padding-top: 0.5rem;
    margin-top: 0.5rem;
}

.delivery-info {
    background: var(--light-gray);
    padding: 1rem;
    border-radius: var(--radius-md);
    margin-top: 1rem;
}

.delivery-info h4 {
    margin-bottom: 0.5rem;
    color: var(--text-dark);
}




        /* Notification Styles */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 1rem 1.5rem;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    z-index: 10001;
    transform: translateX(400px);
    transition: transform 0.3s ease;
    min-width: 300px;
    max-width: 500px;
}

.notification.show {
    transform: translateX(0);
}

.notification i {
    font-size: 1.5rem;
}

.notification-success {
    border-left: 4px solid var(--success-color);
}

.notification-success i {
    color: var(--success-color);
}

.notification-error {
    border-left: 4px solid var(--danger-color);
}

.notification-error i {
    color: var(--danger-color);
}

.notification-warning {
    border-left: 4px solid var(--warning-color);
}

.notification-warning i {
    color: var(--warning-color);
}

.notification-info {
    border-left: 4px solid var(--info-color);
}

.notification-info i {
    color: var(--info-color);
}

.notification span {
    flex: 1;
    color: var(--text-dark);
    font-weight: 500;
}



           /* Enhanced table styles for recent orders */
.data-table tbody tr:hover {
    background-color: var(--light-gray) !important;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.btn-icon {
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-icon:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    opacity: 0.9;
}

.status-badge {
    white-space: nowrap;
    font-size: 0.75rem;
    letter-spacing: 0.3px;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .data-table td {
        padding: 0.75rem 0.5rem;
        font-size: 0.9rem;
    }
}

        .info-card:hover {
    transform: translateY(-10px);





/* Enhanced Farmer Card Styles */
.farmer-card {
    position: relative;
}

.farmer-card .farmer-avatar {
    position: relative;
}

.farmer-card .farmer-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.farmer-card .online-badge {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 15px;
    height: 15px;
    background: var(--success-color);
    border-radius: 50%;
    border: 3px solid white;
}

/* Dark mode for logout button */
body.dark-mode #headerLogoutBtn {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

body.dark-mode #headerLogoutBtn:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
}

    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>





<!-- Header -->
<header class="header" style="background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 0 2rem; height: 70px; margin-left: 280px; transition: margin-left 0.3s;">
    <div class="header-left" style="display: flex; align-items: center; gap: 2rem;">
        <!-- Menu toggle removed from here -->
    </div>

    <div class="header-center" style="flex: 1; max-width: 600px; margin: 0 2rem;">
        <div class="search-bar" style="position: relative; width: 100%;">
            <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
            <input type="text" placeholder="Search products, orders, farmers..." id="searchInput"
                   style="width: 100%; padding: 0.75rem 1rem 0.75rem 3rem; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 0.95rem; transition: all 0.3s; background: #f8fafc;">
        </div>
    </div>

    <div class="header-right" style="display: flex; align-items: center; gap: 1.5rem;">
        <!-- Dark Mode Toggle -->
        <!-- Dark Mode Toggle -->
        <button class="icon-btn" id="darkModeToggle" style="background: #f1f5f9; border: none; width: 45px; height: 45px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-size: 1.2rem; color: #64748b;">
            <i class="fas fa-moon"></i>
        </button>

        <!-- Notifications -->
        <div class="notifications" style="position: relative;">
            <button class="icon-btn" id="notificationBtn" style="background: #f1f5f9; border: none; width: 45px; height: 45px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-size: 1.2rem; color: #64748b; position: relative;">
                <i class="fas fa-bell"></i>
                <span class="badge" id="notificationBadge" style="position: absolute; top: -2px; right: -2px; background: #ef4444; color: white; font-size: 0.7rem; font-weight: 700; padding: 0.15rem 0.4rem; border-radius: 10px; min-width: 18px; text-align: center;">0</span>
            </button>
            <div class="notifications-dropdown" id="notificationsDropdown" style="display: none; position: absolute; top: calc(100% + 0.5rem); right: 0; width: 350px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); max-height: 400px; overflow-y: auto; z-index: 1000;">
                <div class="notifications-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #e2e8f0;">
                    <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">Notifications</h3>
                    <button class="mark-read" style="background: none; border: none; color: #10b981; font-size: 0.85rem; cursor: pointer; font-weight: 600;">Mark all read</button>
                </div>
                <div class="notifications-list" id="notificationsList">
                    <!-- Notifications will be loaded from backend -->
                </div>
            </div>
        </div>







        <!-- User Menu -->
        <div class="user-menu">
            <button class="user-btn" id="userBtn">
                <img src="" alt="User" class="user-avatar" id="userAvatar">
                <span class="user-name" id="userName">Loading...</span>
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="user-dropdown" id="userDropdown" style="display: none; position: absolute; top: calc(100% + 0.5rem); right: 0; width: 220px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden; z-index: 1000;">
                <a href="#" class="dropdown-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; color: #1e293b; text-decoration: none; transition: all 0.2s; border-bottom: 1px solid #f1f5f9;">
                    <i class="fas fa-user" style="font-size: 1rem; width: 20px; color: #64748b;"></i>
                    <span style="font-weight: 500;">Profile</span>
                </a>
                <a href="#" class="dropdown-item" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; color: #1e293b; text-decoration: none; transition: all 0.2s; border-bottom: 1px solid #f1f5f9;">
                    <i class="fas fa-cog" style="font-size: 1rem; width: 20px; color: #64748b;"></i>
                    <span style="font-weight: 500;">Settings</span>
                </a>
                <a href="#" class="dropdown-item" id="logoutBtn" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; color: #ef4444; text-decoration: none; transition: all 0.2s;">
                    <i class="fas fa-sign-out-alt" style="font-size: 1rem; width: 20px;"></i>
                    <span style="font-weight: 500;">Logout</span>
                </a>
            </div>
        </div>

        <!-- Logout Button (Visible) -->
        <button id="headerLogoutBtn" onclick="handleLogout(event)" style="display: flex; align-items: center; gap: 0.5rem; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
        </button>
        </div>
</header>

<div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar" style="position: fixed; left: 0; top: 0; width: 280px; height: 100vh; background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%); box-shadow: 2px 0 10px rgba(0,0,0,0.05); overflow-y: auto; transition: width 0.3s; z-index: 1001; border-right: 1px solid #e2e8f0;">

        <!-- Toggle Button -->
        <button class="menu-toggle" id="menuToggle" style="position: absolute; right: -20px; top: 20px; background: white; border: 2px solid #e2e8f0; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; z-index: 1002; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <i class="fas fa-chevron-left" style="font-size: 1rem; color: #64748b;"></i>
        </button>


        <!-- Logo Section -->
        <div style="padding: 1.5rem; border-bottom: 1px solid #a5d6a7; display: flex; align-items: center; gap: 0.75rem; background: transparent;">
            <div style="width: 45px; height: 45px; flex-shrink: 0;">
                <img src="images/logo.jpeg" alt="AgriGuard AI Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="margin: 0; font-size: 1rem; font-weight: 700; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">AgriGuard AI</div>
                <div s
                     tyle="margin: 0; font-size: 0.7rem; color: #10b981; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Buyer Portal</div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="sidebar-nav" style="padding: 1rem;">

            <!-- MAIN Section -->
            <div style="margin-bottom: 1.5rem;">
                <div style="padding: 0.5rem 1rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.75rem; font-weight: 700; color: #10b981; text-transform: uppercase; letter-spacing: 1px;">MAIN</span>
                </div>

                <a href="#overview" class="nav-item active" data-section="overview" style="display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; color: white; background: linear-gradient(135deg, #10b981, #059669); text-decoration: none; border-radius: 12px; transition: all 0.3s; margin-bottom: 0.25rem; position: relative; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                    <i class="fas fa-chart-line" style="font-size: 1.2rem; width: 24px; text-align: center;"></i>
                    <span style="font-weight: 600; font-size: 0.95rem;">Dashboard</span>
                </a>

                <a href="#marketplace" class="nav-item" data-section="marketplace" style="display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; color: #64748b; text-decoration: none; border-radius: 12px; transition: all 0.3s; margin-bottom: 0.25rem;">
                    <i class="fas fa-store" style="font-size: 1.2rem; width: 24px; text-align: center;"></i>
                    <span style="font-weight: 600; font-size: 0.95rem;">Marketplace</span>
                </a>

                <a href="#orders" class="nav-item" data-section="orders" style="display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; color: #64748b; text-decoration: none; border-radius: 12px; transition: all 0.3s; margin-bottom: 0.25rem;">
                    <i class="fas fa-shopping-cart" style="font-size: 1.2rem; width: 24px; text-align: center;"></i>
                    <span style="font-weight: 600; font-size: 0.95rem;">My Orders</span>
                </a>

                <a href="#cart" class="nav-item" data-section="cart" style="display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; color: #64748b; text-decoration: none; border-radius: 12px; transition: all 0.3s; margin-bottom: 0.25rem; position: relative;">
                    <i class="fas fa-shopping-basket" style="font-size: 1.2rem; width: 24px; text-align: center;"></i>
                    <span style="font-weight: 600; font-size: 0.95rem;">Shopping Cart</span>
                    <span class="badge" id="cartBadge" style="position: absolute; right: 1rem; background: #ef4444; color: white; font-size: 0.7rem; font-weight: 700; padding: 0.15rem 0.4rem; border-radius: 10px; min-width: 20px; text-align: center;">0</span>
                </a>
            </div>

            <!-- TRANSACTIONS Section -->
            <div style="margin-bottom: 1.5rem;">
                <div style="padding: 0.5rem 1rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.75rem; font-weight: 700; color: #10b981; text-transform: uppercase; letter-spacing: 1px;">TRANSACTIONS</span>
                </div>

                <a href="#transactions" class="nav-item" data-section="transactions" style="display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; color: #64748b; text-decoration: none; border-radius: 12px; transition: all 0.3s; margin-bottom: 0.25rem;">
                    <i class="fas fa-exchange-alt" style="font-size: 1.2rem; width: 24px; text-align: center;"></i>
                    <span style="font-weight: 600; font-size: 0.95rem;">Transactions</span>
                </a>

                <a href="#tracking" class="nav-item" data-section="tracking" style="display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; color: #64748b; text-decoration: none; border-radius: 12px; transition: all 0.3s; margin-bottom: 0.25rem;">
                    <i class="fas fa-truck" style="font-size: 1.2rem; width: 24px; text-align: center;"></i>
                    <span style="font-weight: 600; font-size: 0.95rem;">Delivery Tracking</span>
                </a>
            </div>






            <!-- QUALITY Section -->
            <div style="margin-bottom: 1.5rem;">
                <div style="padding: 0.5rem 1rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.75rem; font-weight: 700; color: #10b981; text-transform: uppercase; letter-spacing: 1px;">QUALITY</span>
                </div>



                <a href="#quality" class="nav-item" data-section="quality" style="display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; color: #64748b; text-decoration: none; border-radius: 12px; transition: all 0.3s; margin-bottom: 0.25rem;">
                    <i class="fas fa-certificate" style="font-size: 1.2rem; width: 24px; text-align: center;"></i>
                    <span style="font-weight: 600; font-size: 0.95rem;">Quality Assurance</span>
                </a>
            </div>





            <!-- COMMUNICATION Section -->
            <div style="margin-bottom: 1.5rem;">
                <div style="padding: 0.5rem 1rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.75rem; font-weight: 700; color: #10b981; text-transform: uppercase; letter-spacing: 1px;">COMMUNICATION</span>
                </div>

                <a href="#farmers" class="nav-item" data-section="farmers" style="display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; color: #64748b; text-decoration: none; border-radius: 12px; transition: all 0.3s; margin-bottom: 0.25rem;">
                    <i class="fas fa-users" style="font-size: 1.2rem; width: 24px; text-align: center;"></i>
                    <span style="font-weight: 600; font-size: 0.95rem;">Farmers</span>
                </a>

                <a href="WhatsAppFarmerBuyer.html" class="nav-item external-link" style="display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; color: #64748b; text-decoration: none; border-radius: 12px; transition: all 0.3s; margin-bottom: 0.25rem; position: relative;">
                    <i class="fas fa-envelope" style="font-size: 1.2rem; width: 24px; text-align: center;"></i>
                    <span style="font-weight: 600; font-size: 0.95rem;">Messages</span>
                    <span class="badge" id="messagesBadge" style="position: absolute; right: 1rem; background: #ef4444; color: white; font-size: 0.7rem; font-weight: 700; padding: 0.15rem 0.4rem; border-radius: 10px; min-width: 20px; text-align: center;">0</span>
                </a>
            </div>

            <!-- REPORTS Section -->
            <div style="margin-bottom: 1.5rem;">
                <div style="padding: 0.5rem 1rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 0.75rem; font-weight: 700; color: #10b981; text-transform: uppercase; letter-spacing: 1px;">REPORTS</span>
                </div>

                <a href="#reports" class="nav-item" data-section="reports" style="display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; color: #64748b; text-decoration: none; border-radius: 12px; transition: all 0.3s; margin-bottom: 0.25rem;">
                    <i class="fas fa-chart-bar" style="font-size: 1.2rem; width: 24px; text-align: center;"></i>
                    <span style="font-weight: 600; font-size: 0.95rem;">Reports & Analytics</span>
                </a>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Overview Section -->
        <section class="content-section active" id="overview">
            <div class="section-header">
                <h1>Buyer Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary">
                        <i class="fas fa-download"></i>
                        Export Report
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Total Orders</p>
                        <h2 class="stat-value" id="totalOrders">0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="ordersChange">0%</span> from last month
                        </p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Completed Orders</p>
                        <h2 class="stat-value" id="completedOrders">0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="completedChange">0%</span> from last month
                        </p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Pending Orders</p>
                        <h2 class="stat-value" id="pendingOrders">0</h2>
                        <p class="stat-change">
                            <span id="pendingChange">0</span> awaiting confirmation
                        </p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon purple">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Total Spent</p>
                        <h2 class="stat-value" id="totalSpent">$0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="spentChange">0%</span> from last month
                        </p>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Purchasing Trends</h3>
                        <select class="chart-filter">
                            <option value="week">Last 7 Days</option>
                            <option value="month">Last 30 Days</option>
                            <option value="year">Last Year</option>
                        </select>
                    </div>
                    <div class="chart-container" id="purchasingChart">
                        <!-- Chart will be rendered from backend data -->
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Order Status Distribution</h3>
                    </div>
                    <div class="chart-container" id="orderStatusChart">
                        <!-- Chart will be rendered from backend data -->
                    </div>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="data-card">
                <div class="card-header">
                    <h3>Recent Orders</h3>
                    <a href="#orders" class="link-btn">View All</a>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Farmer</th>
                            <th>Products</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="recentOrdersTable">
                        <!-- Orders will be loaded from backend -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Marketplace Section -->
        <section class="content-section" id="marketplace">
            <div class="section-header">
                <h1>Marketplace</h1>
                <div class="header-actions">
                    <div class="filter-group">
                        <select class="filter-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            <!-- Categories will be loaded from backend -->
                        </select>
                        <select class="filter-select" id="sortFilter">
                            <option value="newest">Newest First</option>
                            <option value="price-low">Price: Low to High</option>
                            <option value="price-high">Price: High to Low</option>
                            <option value="rating">Highest Rated</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="products-grid" id="productsGrid">
                <!-- Products will be loaded from backend -->
            </div>
        </section>

        <!-- Orders Section -->
        <section class="content-section" id="orders">
            <div class="section-header">
                <h1>My Orders</h1>
                <div class="header-actions">
                    <div class="filter-tabs">
                        <button class="tab-btn active" data-status="all">All</button>
                        <button class="tab-btn" data-status="pending">Pending</button>
                        <button class="tab-btn" data-status="confirmed">Confirmed</button>
                        <button class="tab-btn" data-status="shipped">Shipped</button>
                        <button class="tab-btn" data-status="delivered">Delivered</button>
                        <button class="tab-btn" data-status="cancelled">Cancelled</button>
                    </div>
                </div>
            </div>

            <div class="orders-list" id="ordersList">
                <!-- Orders will be loaded from backend -->
            </div>
        </section>

        <!-- Shopping Cart Section -->
        <section class="content-section" id="cart">
            <div class="section-header">
                <h1>Shopping Cart</h1>
            </div>

            <div class="cart-container">
                <div class="cart-items" id="cartItems">
                    <!-- Cart items will be loaded from backend -->
                </div>

                <div class="cart-summary">
                    <h3>Order Summary</h3>
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="cartSubtotal">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping:</span>
                        <span id="cartShipping">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax:</span>
                        <span id="cartTax">$0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="cartTotal">$0.00</span>
                    </div>
                    <button class="btn btn-primary btn-block" id="checkoutBtn">
                        <i class="fas fa-lock"></i>
                        Proceed to Checkout
                    </button>
                </div>
            </div>
        </section>

        <!-- Transactions Section -->
        <section class="content-section" id="transactions">
            <div class="section-header">
                <h1><i class="fas fa-exchange-alt"></i> Transactions</h1>
                <div class="header-actions">
                    <div class="filter-group" style="display: flex; gap: 0.5rem; align-items: center;">
                        <select class="filter-select" id="transactionStatusFilter" style="min-width: 150px;">
                            <option value="">All Status</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="PENDING">Pending</option>
                            <option value="FAILED">Failed</option>
                        </select>
                        <input type="date" class="date-input" id="transactionDateFilter">
                        <button class="btn btn-secondary">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Completed</p>
                        <h2 class="stat-value" id="completedTransactions">0</h2>
                        <p class="stat-change positive">This month</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Pending</p>
                        <h2 class="stat-value" id="pendingTransactions">0</h2>
                        <p class="stat-change">Awaiting processing</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Total Volume</p>
                        <h2 class="stat-value" id="totalTransactionVolume">RF 0</h2>
                        <p class="stat-change positive">All time</p>
                    </div>
                </div>
            </div>

            <!-- Transactions List -->
            <div class="transactions-list" id="transactionsList">
                <!-- Transactions will be loaded here -->
            </div>
        </section>


        <!-- Farmers Section -->
        <section class="content-section" id="farmers">
            <div class="section-header">
                <h1>Farmers</h1>
                <div class="header-actions">
                    <input type="text" class="search-input" placeholder="Search farmers..." id="farmerSearch">
                </div>
            </div>

            <div class="farmers-grid" id="farmersGrid">
                <!-- Farmers will be loaded from backend -->
            </div>
        </section>

        <!-- Delivery Tracking Section -->
        <section class="content-section" id="tracking">
            <div class="section-header">
                <h1>Delivery Tracking</h1>
                <div class="header-actions">
                    <input type="text" class="search-input" placeholder="Enter order ID or tracking number..." id="trackingSearch">
                    <button class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        Track
                    </button>
                </div>
            </div>

            <div class="tracking-list" id="trackingList">
                <!-- Tracking information will be loaded from backend -->
            </div>
        </section>



        <!-- Quality Assurance Section -->
        <section class="content-section" id="quality">
            <div class="section-header">
                <h1>Quality Assurance</h1>
            </div>

            <!-- KEEP ORIGINAL DESIGN FOR THESE CARDS -->
            <div class="quality-cards">
                <div class="info-card">
                    <div class="info-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3>Quality Certifications</h3>
                    <p>All products are certified and meet quality standards</p>
                </div>
                <div class="info-card">
                    <div class="info-icon">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <h3>Organic Verification</h3>
                    <p>Verified organic products with certifications</p>
                </div>
                <div class="info-card">
                    <div class="info-icon">
                        <i class="fas fa-microscope"></i>
                    </div>
                    <h3>Lab Testing</h3>
                    <p>Regular lab testing for quality assurance</p>
                </div>
            </div>

            <!-- NEW ENHANCED QUALITY REPORTS SECTION -->
            <div style="background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); overflow: hidden; margin-top: 2rem;">
                <div style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 1.4rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-clipboard-check"></i> Quality Reports
                    </h3>
                    <button class="btn btn-secondary" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        <i class="fas fa-filter"></i> Filter Reports
                    </button>
                </div>

                <div id="qualityReportsList" style="padding: 1.5rem;">
                    <!-- Quality reports will be loaded here -->
                </div>
            </div>
        </section>





        <!-- Messages Section -->
        <section class="content-section" id="messages">
            <div class="section-header">
                <h1>Messages</h1>
                <div class="header-actions">
                    <button class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        New Message
                    </button>
                </div>
            </div>

            <div class="messages-container">
                <div class="conversations-list">
                    <div class="conversations-header">
                        <input type="text" class="search-input" placeholder="Search conversations...">
                    </div>
                    <div class="conversations" id="conversationsList">
                        <!-- Conversations will be loaded from backend -->
                    </div>
                </div>

                <div class="chat-area">
                    <div class="chat-header">
                        <div class="chat-user-info">
                            <img src="" alt="" class="chat-avatar">
                            <div>
                                <h4 class="chat-user-name">Select a conversation</h4>
                                <p class="chat-user-status">...</p>
                            </div>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will be loaded from backend -->
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" placeholder="Type a message..." id="messageInput">
                        <button class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>





        <!-- Reports Section -->
        <section class="content-section" id="reports">
            <div class="section-header">
                <h1><i class="fas fa-chart-line"></i> Reports & Analytics</h1>
                <div class="header-actions">
                    <select class="filter-select" id="reportsPeriodFilter" style="min-width: 150px;">
                        <option value="week">Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                        <option value="quarter">Last Quarter</option>
                        <option value="year">Last Year</option>
                        <option value="all">All Time</option>
                    </select>
                    <button class="btn btn-secondary">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                </div>
            </div>

            <!-- Key Metrics Summary -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card" style="background: white; border-left: 4px solid var(--primary-color);">
                    <div class="stat-icon green">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Total Spending</p>
                        <h2 class="stat-value" style="color: var(--primary-color);" id="reportTotalSpending">RF 0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="reportSpendingChange">0%</span> vs last period
                        </p>
                    </div>
                </div>

                <div class="stat-card" style="background: white; border-left: 4px solid var(--primary-color);">
                    <div class="stat-icon green">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Total Orders</p>
                        <h2 class="stat-value" style="color: var(--primary-color);" id="reportTotalOrders">0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="reportOrdersChange">0%</span> vs last period
                        </p>
                    </div>
                </div>

                <div class="stat-card" style="background: white; border-left: 4px solid var(--primary-color);">
                    <div class="stat-icon green">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Avg Order Value</p>
                        <h2 class="stat-value" style="color: var(--primary-color);" id="reportAvgOrder">RF 0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="reportAvgChange">0%</span> vs last period
                        </p>
                    </div>
                </div>

                <div class="stat-card" style="background: white; border-left: 4px solid var(--primary-color);">
                    <div class="stat-icon green">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Active Farmers</p>
                        <h2 class="stat-value" style="color: var(--primary-color);" id="reportActiveFarmers">0</h2>
                        <p class="stat-change">
                            <span id="reportFarmersCount">0</span> suppliers
                        </p>
                    </div>
                </div>
            </div>

            <!-- Charts Grid - First Row -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                <!-- Spending Analysis Chart -->
                <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                    <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-chart-line"></i> Spending Analysis
                        </h3>
                        <select class="filter-select" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                            <option value="daily">Daily</option>
                            <option value="weekly" selected>Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="chart-container" id="spendingChart" style="padding: 1.5rem; min-height: 350px;">
                        <canvas id="spendingChartCanvas"></canvas>
                    </div>
                </div>

                <!-- Product Categories Pie Chart -->
                <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                    <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem;">
                        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-chart-pie"></i> Product Categories
                        </h3>
                    </div>
                    <div class="chart-container" id="categoriesChart" style="padding: 1.5rem; min-height: 350px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="categoriesChartCanvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Grid - Second Row -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                <!-- Top Farmers -->
                <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                    <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem;">
                        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-trophy"></i> Top Farmers
                        </h3>
                    </div>
                    <div id="topFarmersChart" style="padding: 1.5rem;">
                        <!-- Top farmers list will be rendered here -->
                    </div>
                </div>

                <!-- Order Status Distribution -->
                <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                    <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem;">
                        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-tasks"></i> Order Status
                        </h3>
                    </div>
                    <div class="chart-container" id="orderStatusChartReport" style="padding: 1.5rem; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="orderStatusChartCanvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Grid - Third Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                <!-- Monthly Trends -->
                <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                    <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem;">
                        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-calendar-alt"></i> Monthly Trends
                        </h3>
                    </div>
                    <div class="chart-container" id="trendsChart" style="padding: 1.5rem; min-height: 300px;">
                        <canvas id="trendsChartCanvas"></canvas>
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                    <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem;">
                        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-credit-card"></i> Payment Methods
                        </h3>
                    </div>
                    <div class="chart-container" id="paymentMethodsChart" style="padding: 1.5rem; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="paymentMethodsChartCanvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Table -->
            <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-history"></i> Recent Activity
                    </h3>
                    <button class="btn btn-secondary" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.5rem 1rem;">
                        <i class="fas fa-eye"></i> View All
                    </button>
                </div>
                <div id="recentActivityTable" style="padding: 1.5rem;">
                    <!-- Recent activity will be rendered here -->
                </div>
            </div>
        </section>
    </main>
</div>





<!-- Scripts -->
<script src="js/SessionTracker.js"></script>
<script src="js/user_session_handler.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>






    // BuyerDashboard.js - Complete JavaScript for Buyer Dashboard
  // Author: AgriGuard AI Development Team
  // Description: Handles all buyer dashboard functionality with real backend data

  // ==================== CONSTANTS & CONFIGURATION ====================
  const API_BASE_URL = 'http://localhost:1010/api';
  const ENDPOINTS = {
      // User endpoints
      users: `${API_BASE_URL}/users`,
      profile: (id) => `${API_BASE_URL}/users/${id}`,


 // Crop Production endpoints
    cropProductions: `${API_BASE_URL}/v1/crop-productions`,
    cropProductionById: (id) => `${API_BASE_URL}/v1/crop-productions/${id}`,
    cropProductionsByCrop: (cropId) => `${API_BASE_URL}/v1/crop-productions/crop/${cropId}`,
    cropProductionsByFarm: (farmId) => `${API_BASE_URL}/v1/crop-productions/farm/${farmId}`,
    // AJOUT: Nouvel endpoint pour farmer
    cropProductionsByFarmer: (farmerId) => `${API_BASE_URL}/v1/crop-productions/farmer/${farmerId}`,
    cropProductionsActive: `${API_BASE_URL}/v1/crop-productions/active`,

      // Crops endpoints
      crops: `${API_BASE_URL}/v1/crops`,
      cropsAll: `${API_BASE_URL}/v1/crops/all`,
      cropById: (id) => `${API_BASE_URL}/v1/crops/${id}`,
      cropsByType: (type) => `${API_BASE_URL}/v1/crops/type/${type}`,

      // Transactions endpoints
      transactions: `${API_BASE_URL}/transactions`,
      transactionById: (id) => `${API_BASE_URL}/transactions/${id}`,
      transactionsByBuyer: (buyerId) => `${API_BASE_URL}/transactions/buyer/${buyerId}`,
      transactionsByBuyerAndStatus: (buyerId, status) => `${API_BASE_URL}/transactions/buyer/${buyerId}/status/${status}`,
      buyerAnalytics: (buyerId) => `${API_BASE_URL}/transactions/buyer/${buyerId}/analytics`,

      // Market Price endpoints
      marketPrices: `${API_BASE_URL}/market-prices`,
      marketPricesByCrop: (cropId) => `${API_BASE_URL}/market-prices/crop/${cropId}`,
      latestMarketPrice: (cropId) => `${API_BASE_URL}/market-prices/crop/${cropId}/latest`,
      recentMarketPrices: (cropId, days) => `${API_BASE_URL}/market-prices/crop/${cropId}/recent?days=${days}`,
      marketOpportunities: `${API_BASE_URL}/market-prices/opportunities`,

      // Supply Chain endpoints
      supplyChain: `${API_BASE_URL}/supply-chain`,
      supplyChainByTransaction: (transactionId) => `${API_BASE_URL}/supply-chain/transaction/${transactionId}`,
      supplyChainTracking: (trackingCode) => `${API_BASE_URL}/supply-chain/track/${trackingCode}`,
  };

  // ==================== STATE MANAGEMENT ====================
  let currentUser = null;
  let shoppingCart = [];
  let notifications = [];
  let conversations = [];
  let currentSection = 'overview';

  // ==================== UTILITY FUNCTIONS ====================
  // Get Auth Token from localStorage
  function getAuthToken() {
      const sessionHandler = window.UserSessionHandler ? window.UserSessionHandler.getInstance() : null;
      if (sessionHandler) {
          return sessionHandler.getAuthToken();
      }
      return localStorage.getItem('agriguard_jwt_token');
  }


  // Get Current User from UserSessionHandler
  function getCurrentUser() {
      const sessionHandler = window.UserSessionHandler ? window.UserSessionHandler.getInstance() : null;

      if (sessionHandler) {
          const user = sessionHandler.getCurrentUser();
          if (user && user.role === 'BUYER') {
              return user;
          }
      }

      console.error('Unable to get buyer user session');
      return null;
  }



async function apiCall(url, options = {}) {
    const token = getAuthToken();

    if (!token) {
        console.error('No authentication token found');
        handleUnauthorized();
        throw new Error('Authentication required');
    }

    const defaultHeaders = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };

    try {
        console.log('=== API CALL ===');
        console.log('URL:', url);
        console.log('Method:', options.method || 'GET');

        const response = await fetch(url, {
            ...options,
            headers: {
                ...defaultHeaders,
                ...options.headers
            }
        });

        //  CRITICAL FIX: Handle 401 Unauthorized with session refresh
        if (response.status === 401) {
            console.error('Authentication failed (401)');

            // Try to refresh the token
            const refreshResult = await refreshAuthToken();

            if (refreshResult) {
                // Retry the request with new token
                const newToken = getAuthToken();
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${newToken}`
                };

                const retryResponse = await fetch(url, {
                    ...options,
                    headers: options.headers
                });

                if (!retryResponse.ok) {
                    throw new Error(`HTTP error ${retryResponse.status}`);
                }
                return await retryResponse.json();
            }

            handleUnauthorized();
            throw new Error('Authentication failed');
        }

        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }

        return await response.json();

    } catch (error) {
        console.error('API call error:', error);
        throw error;
    }
}

// Add token refresh function
async function refreshAuthToken() {
    try {
        const sessionHandler = window.UserSessionHandler?.getInstance();
        if (sessionHandler && typeof sessionHandler.refreshToken === 'function') {
            return await sessionHandler.refreshToken();
        }
        return false;
    } catch (error) {
        console.error('Token refresh failed:', error);
        return false;
    }
}




  // Handle unauthorized access
  function handleUnauthorized() {
      const sessionHandler = window.UserSessionHandler ? window.UserSessionHandler.getInstance() : null;

      if (sessionHandler) {
          sessionHandler.clearSession();
      }

      if (window.sessionTracker && currentUser) {
          window.sessionTracker.endSession(currentUser.id || currentUser.userId);
      }

      showNotification('Session expired. Please login again.', 'error');

      setTimeout(() => {
          window.location.href = '/login.html';
      }, 1500);
  }

  // Format currency
  function formatCurrency(amount) {
      return new Intl.NumberFormat('en-RW', {
          style: 'currency',
          currency: 'RWF',
          minimumFractionDigits: 0
      }).format(amount);
  }

  // Format date
  function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
      });
  }

  // Format datetime
  function formatDateTime(dateString) {
      return new Date(dateString).toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
      });
  }

  // Show notification/toast
  function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
      `;
      document.body.appendChild(notification);

      setTimeout(() => {
          notification.classList.add('show');
      }, 100);

      setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
      }, 3000);
  }


  // Initialize dashboard on page load
  document.addEventListener('DOMContentLoaded', async () => {
      try {
          console.log('Dashboard loading...');

          // Verify UserSessionHandler is available
          if (!window.UserSessionHandler) {
              console.error('UserSessionHandler not loaded');
              showNotification('System initialization failed. Please refresh.', 'error');
              return;
          }

          // Get session handler instance
          const sessionHandler = window.UserSessionHandler.getInstance();

          // Check authentication
          if (!sessionHandler.isAuthenticated()) {
              console.error('User not authenticated');
              showNotification('Please login to continue', 'error');
              setTimeout(() => {
                  window.location.href = '/login.html';
              }, 1500);
              return;
          }

          // Get current user
          currentUser = sessionHandler.getCurrentUser();

          if (!currentUser) {
              console.error('No user data found');
              showNotification('Session expired. Please login again.', 'error');
              setTimeout(() => {
                  window.location.href = '/login.html';
              }, 1500);
              return;
          }

          // Verify user role
          if (currentUser.role !== 'BUYER') {
              console.error('Invalid role for buyer dashboard:', currentUser.role);
              showNotification('Access denied. This dashboard is for buyers only.', 'error');
              setTimeout(() => {
                  const redirectUrls = {
                      'FARMER': '/farmer-dashboard.html',
                      'ADMIN': '/admin-dashboard.html',
                      'ANALYST': '/analyst-dashboard.html',
                      'GOVERNMENT': '/government-dashboard.html'
                  };
                  window.location.href = redirectUrls[currentUser.role] || '/login.html';
              }, 2000);
              return;
          }

          console.log('User verified:', currentUser);

          // Update activity in session tracker
          if (window.sessionTracker) {
              window.sessionTracker.updateLastActivity(currentUser.id || currentUser.userId);
          }

          // Initialize UI
          initializeUI();

          // Load initial data
          await loadDashboardData();

          // Setup event listeners
          setupEventListeners();

          // Start periodic updates
          startPeriodicUpdates();
              // Setup messages navigation
    setupMessagesNavigation();




      } catch (error) {
          console.error('Initialization error:', error);
          showNotification('Failed to initialize dashboard: ' + error.message, 'error');
      }
  });


// Make functions globally available
window.navigateToMessages = navigateToMessages;


console.log(' Messages navigation module loaded');

// Initialize UI elements
function initializeUI() {
    // Get session handler
    const sessionHandler = window.UserSessionHandler ? window.UserSessionHandler.getInstance() : null;

    if (!sessionHandler) {
        console.error('UserSessionHandler not available');
        showNotification('System error. Please refresh the page.', 'error');
        return;
    }

    // Get current user from session handler
    currentUser = sessionHandler.getCurrentUser();

    // Verify user exists and has BUYER role
    if (!currentUser) {
        console.error('No user session found');
        showNotification('Session expired. Please login again.', 'error');
        setTimeout(() => {
            window.location.href = '/login.html';
        }, 2000);
        return;
    }

    if (currentUser.role !== 'BUYER') {
        console.error('User is not a buyer:', currentUser.role);
        showNotification('Access denied. This dashboard is for buyers only.', 'error');
        setTimeout(() => {
            const redirectUrls = {
                'FARMER': '/farmer-dashboard.html',
                'ADMIN': '/admin-dashboard.html',
                'ANALYST': '/analyst-dashboard.html',
                'GOVERNMENT': '/government-dashboard.html'
            };
            window.location.href = redirectUrls[currentUser.role] || '/login.html';
        }, 2000);
        return;
    }

    console.log('Current user loaded:', currentUser);

    // Update last activity
    sessionHandler.updateLastActivity();

    // Update user info in header
    updateUserInfo();

    // Set active section
    setActiveSection('overview');

    // Initialize shopping cart
    loadCartFromStorage();
}

// Update user info in header
function updateUserInfo() {
    if (!currentUser) return;

    const userName = document.getElementById('userName');
    const userAvatar = document.getElementById('userAvatar');

    if (userName) {
        userName.textContent = currentUser.fullName || currentUser.username;
    }

    if (userAvatar) {
        if (currentUser.profileImageUrl) {
            userAvatar.src = currentUser.profileImageUrl;
        } else {
            // Create initials avatar
            const initials = getInitials(currentUser.fullName || currentUser.username);
            userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=2563eb&color=fff`;
        }
    }
}

// Get initials from name
function getInitials(name) {
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
}

function setupEventListeners() {
    // Menu toggle
    const menuToggle = document.getElementById('menuToggle');
    const sidebar = document.getElementById('sidebar');
    if (menuToggle) {
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
        });
    }

    // Navigation items
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const section = item.dataset.section;
            setActiveSection(section);
        });
    });

    // User dropdown
    const userBtn = document.getElementById('userBtn');
    const userDropdown = document.getElementById('userDropdown');
    if (userBtn) {
        userBtn.addEventListener('click', () => {
            userDropdown.classList.toggle('show');
        });
    }

    // Notifications dropdown
    const notificationBtn = document.getElementById('notificationBtn');
    const notificationsDropdown = document.getElementById('notificationsDropdown');
    if (notificationBtn) {
        notificationBtn.addEventListener('click', () => {
            notificationsDropdown.classList.toggle('show');
        });
    }

    // Logout button
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    }

    // Search input
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(handleSearch, 300));
    }

    // Checkout button with event delegation
    document.addEventListener('click', (e) => {
        // Checkout button
        if (e.target.id === 'checkoutBtn' || e.target.closest('#checkoutBtn')) {
            e.preventDefault();
            console.log('Checkout button clicked!');
            console.log('Shopping cart:', shoppingCart);

            if (shoppingCart.length === 0) {
                showNotification('Your cart is empty', 'warning');
                return;
            }

            showOrderConfirmationModal(shoppingCart);
        }
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.user-menu')) {
            userDropdown?.classList.remove('show');
        }
        if (!e.target.closest('.notifications')) {
            notificationsDropdown?.classList.remove('show');
        }
    });
}

// Debounce function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Handle search
async function handleSearch(e) {
    const query = e.target.value.trim();
    if (!query) return;

    try {
        // Search in different sections based on current view
        if (currentSection === 'marketplace') {
            await searchProducts(query);
        } else if (currentSection === 'orders') {
            await searchOrders(query);
        } else if (currentSection === 'farmers') {
            await searchFarmers(query);
        }
    } catch (error) {
        console.error('Search error:', error);
    }
}




  // Handle logout
  function handleLogout(e) {
      e.preventDefault();

      const sessionHandler = window.UserSessionHandler ? window.UserSessionHandler.getInstance() : null;

      if (sessionHandler) {
          // End session in tracker
          if (window.sessionTracker && currentUser) {
              window.sessionTracker.endSession(currentUser.id || currentUser.userId);
          }

          // Clear session
          sessionHandler.clearSession();
      } else {
          // Fallback: clear localStorage directly
          localStorage.removeItem('agriguard_jwt_token');
          localStorage.removeItem('agriguard_user_info');
          localStorage.removeItem('agriguard_userSession');
      }

      // Clear cart
      localStorage.removeItem('shoppingCart');

      // Redirect to login
      window.location.href = '/login.html';
  }

  // ==================== SECTION NAVIGATION ====================

  function setActiveSection(sectionName) {
      currentSection = sectionName;






      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
          if (item.dataset.section === sectionName) {
              item.classList.add('active');
          }
      });

      // Update content sections
      document.querySelectorAll('.content-section').forEach(section => {
          section.classList.remove('active');
      });

      const activeSection = document.getElementById(sectionName);
      if (activeSection) {
          activeSection.classList.add('active');
      }

      // Load section-specific data
      loadSectionData(sectionName);
  }






  async function loadSectionData(sectionName) {
      switch (sectionName) {
          case 'overview':
              await loadOverviewData();
              break;
          case 'marketplace':
              await loadMarketplaceData();
              break;
          case 'orders':
              await loadOrdersData();
              break;
          case 'cart':
              updateCartDisplay();
              break;
          case 'transactions':
              await loadTransactionsData();
              break;
          case 'farmers':
              await loadFarmersData();
              break;
          case 'tracking':
              await loadTrackingData();
              break;
          case 'quality':
              await loadQualityData();
              break;
          case 'messages':
              await loadMessagesData();
              break;
          case 'reports':
              await loadReportsData();
              break;
      }
  }

  // ==================== DASHBOARD DATA LOADING ====================

  async function loadDashboardData() {
      try {
          await Promise.all([
              loadOverviewData(),
              loadNotifications(),
              updateCartBadge()
          ]);
      } catch (error) {
          console.error('Error loading dashboard data:', error);
      }
  }








  // ==================== OVERVIEW SECTION ====================

  async function loadOverviewData() {
      try {
          // Load buyer analytics
          const analytics = await apiCall(ENDPOINTS.buyerAnalytics(currentUser.id));

          // Update stat cards
          updateStatCards(analytics);

          // Load recent orders
          await loadRecentOrders();

          // Load charts data
          await loadOverviewCharts(analytics);

      } catch (error) {
          console.error('Error loading overview data:', error);
      }
  }

  function updateStatCards(analytics) {
      // Total Orders
      const totalOrders = document.getElementById('totalOrders');
      if (totalOrders && analytics.totalTransactions !== undefined) {
          totalOrders.textContent = analytics.totalTransactions;
      }

      // Completed Orders
      const completedOrders = document.getElementById('completedOrders');
      if (completedOrders && analytics.completedTransactions !== undefined) {
          completedOrders.textContent = analytics.completedTransactions;
      }

      // Pending Orders
      const pendingOrders = document.getElementById('pendingOrders');
      if (pendingOrders && analytics.pendingTransactions !== undefined) {
          pendingOrders.textContent = analytics.pendingTransactions;
      }

      // Total Spent
      const totalSpent = document.getElementById('totalSpent');
      if (totalSpent && analytics.totalAmount !== undefined) {
          totalSpent.textContent = formatCurrency(analytics.totalAmount);
      }

      // Update change percentages (if available)
      if (analytics.changes) {
          updateChangePercentages(analytics.changes);
      }
  }

  function updateChangePercentages(changes) {
      const ordersChange = document.getElementById('ordersChange');
      const completedChange = document.getElementById('completedChange');
      const spentChange = document.getElementById('spentChange');

      if (ordersChange && changes.orders !== undefined) {
          ordersChange.textContent = `${changes.orders}%`;
      }
      if (completedChange && changes.completed !== undefined) {
          completedChange.textContent = `${changes.completed}%`;
      }
      if (spentChange && changes.spent !== undefined) {
          spentChange.textContent = `${changes.spent}%`;
      }
  }

// ==================== MESSAGES NAVIGATION ====================

/**
 * Navigate to WhatsApp messaging page
 * This function handles the navigation to the external WhatsApp chat interface
 */
function navigateToMessages() {
    try {
        // Save current session state before navigation
        if (window.UserSessionHandler) {
            const sessionHandler = window.UserSessionHandler.getInstance();
            sessionHandler.updateLastActivity();
        }

        // Navigate to WhatsApp page
        window.location.href = 'WhatsAppFarmerBuyer.html';
    } catch (error) {
        console.error('Error navigating to messages:', error);
        showNotification('Failed to open messages', 'error');
    }
}

/**
 * Setup messages link event listener
 */
function setupMessagesNavigation() {
    const messagesLink = document.querySelector('.nav-item.external-link[href="WhatsAppFarmerBuyer.html"]');

    if (messagesLink) {
        messagesLink.addEventListener('click', (e) => {
            e.preventDefault();
            navigateToMessages();
        });

        console.log(' Messages navigation setup complete');
    } else {
        console.warn(' Messages link not found in DOM');
    }
}


async function loadRecentOrders() {
      try {
          const response = await apiCall(
              `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=5&sortBy=createdAt&sortDir=desc`
          );

          let orders = response.content || response;

          //  Enrich orders with farmer and crop details
          const enrichedOrders = await Promise.all(orders.map(async (order) => {
              try {
                  // Fetch farmer details if we have farmerId
                  if (order.farmerId && !order.farmerName) {
                      const farmerResponse = await apiCall(`${API_BASE_URL}/users/${order.farmerId}`);
                      const farmer = farmerResponse.data || farmerResponse;
                      order.farmerName = farmer.fullName || farmer.username || 'Unknown Farmer';
                  }

                  // Fetch crop details if we have cropId
                  if (order.cropId && !order.cropName) {
                      const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${order.cropId}`);
                      const crop = cropResponse.data || cropResponse;
                      order.cropName = crop.cropName || crop.name || 'Unknown Product';
                  }
              } catch (error) {
                  console.warn('Error enriching order:', error);
              }

              return order;
          }));

          displayRecentOrders(enrichedOrders);
      } catch (error) {
          console.error('Error loading recent orders:', error);
      }
  }

function displayRecentOrders(orders) {
    const tableBody = document.getElementById('recentOrdersTable');
    if (!tableBody) return;

    if (!orders || orders.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-light);">
                    <i class="fas fa-inbox" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                    No orders found
                </td>
            </tr>
        `;
        return;
    }

    tableBody.innerHTML = orders.map(order => `
        <tr style="transition: all 0.2s ease;">
            <!-- Order ID with badge -->
            <td style="font-weight: 600;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-receipt" style="color: var(--primary-color);"></i>
                    <span>${order.transactionCode || 'N/A'}</span>
                </div>
            </td>

            <!-- Date with icon -->
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-calendar" style="color: var(--text-light);"></i>
                    <span>${formatDate(order.createdAt)}</span>
                </div>
            </td>

            <!-- Farmer with profile indicator -->
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 30px; height: 30px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; color: var(--primary-dark);">
                        ${(order.farmerName || order.farmer?.fullName || 'U').charAt(0).toUpperCase()}
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-weight: 500; color: var(--text-dark);">
                            ${order.farmerName || order.farmer?.fullName || order.farmer?.username || 'Unknown Farmer'}
                        </span>
                        ${order.farmer?.phoneNumber ? `
                            <span style="font-size: 0.75rem; color: var(--text-light);">
                                <i class="fas fa-phone" style="font-size: 0.7rem;"></i> ${order.farmer.phoneNumber}
                            </span>
                        ` : ''}
                    </div>
                </div>
            </td>

            <!-- Product with image/icon -->
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    ${order.cropImageUrl || order.crop?.imageUrl ? `
                        <img src="${order.cropImageUrl || order.crop?.imageUrl}"
                             style="width: 35px; height: 35px; border-radius: var(--radius-sm); object-fit: cover;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; width: 35px; height: 35px; background: var(--primary-light); border-radius: var(--radius-sm); align-items: center; justify-content: center;">
                            <i class="fas fa-seedling" style="color: var(--primary-color);"></i>
                        </div>
                    ` : `
                        <div style="width: 35px; height: 35px; background: var(--primary-light); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-seedling" style="color: var(--primary-color);"></i>
                        </div>
                    `}
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-weight: 500; color: var(--text-dark);">
                            ${order.cropName || order.crop?.cropName || order.productName || 'Unknown Product'}
                        </span>
                        <span style="font-size: 0.75rem; color: var(--text-light);">
                            <i class="fas fa-weight" style="font-size: 0.7rem;"></i> ${order.quantity || 0} kg
                        </span>
                    </div>
                </div>
            </td>

            <!-- Amount with highlight -->
            <td>
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                    <span style="font-weight: 700; color: var(--primary-color); font-size: 1.1rem;">
                        ${formatCurrency(order.totalAmount)}
                    </span>
                    ${order.pricePerUnit ? `
                        <span style="font-size: 0.75rem; color: var(--text-light);">
                            ${formatCurrency(order.pricePerUnit)}/kg
                        </span>
                    ` : ''}
                </div>
            </td>

            <!-- Status with enhanced badges -->
            <td>
                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                    <span class="status-badge status-${order.transactionStatus?.toLowerCase() || 'pending'}"
                          style="display: inline-flex; align-items: center; gap: 0.25rem;">
                        <i class="fas fa-${getStatusIcon(order.transactionStatus)}" style="font-size: 0.8rem;"></i>
                        ${order.transactionStatus || 'PENDING'}
                    </span>
                    ${order.paymentStatus ? `
                        <span style="font-size: 0.7rem; color: var(--text-light); text-transform: uppercase;">
                            ${order.paymentStatus}
                        </span>
                    ` : ''}
                </div>
            </td>

            <!-- Actions with better buttons -->
            <td>
                <div style="display: flex; gap: 0.25rem; align-items: center;">
                    <button class="btn-icon" onclick="viewOrderDetails('${order.id}')"
                            title="View Details"
                            style="background: var(--primary-light); color: var(--primary-dark); padding: 0.5rem; border-radius: var(--radius-sm); border: none; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-icon" onclick="trackOrder('${order.id}')"
                            title="Track Order"
                            style="background: var(--info-color); color: white; padding: 0.5rem; border-radius: var(--radius-sm); border: none; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-truck"></i>
                    </button>
                    ${order.transactionStatus === 'DELIVERED' ? `
                        <button class="btn-icon" onclick="leaveReview('${order.id}')"
                                title="Leave Review"
                                style="background: var(--warning-color); color: white; padding: 0.5rem; border-radius: var(--radius-sm); border: none; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-star"></i>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');
}

// Helper function for status icons
function getStatusIcon(status) {
    const icons = {
        'PENDING': 'clock',
        'CONFIRMED': 'check',
        'PROCESSING': 'cog',
        'SHIPPED': 'truck',
        'DELIVERED': 'check-circle',
        'CANCELLED': 'times-circle',
        'COMPLETED': 'check-double'
    };
    return icons[status?.toUpperCase()] || 'clock';
}

  async function loadOverviewCharts(analytics) {
      // Load purchasing trends chart
      await loadPurchasingTrendsChart();

      // Load order status distribution chart
      loadOrderStatusChart(analytics);
  }

  async function loadPurchasingTrendsChart() {
      try {
          // Get transactions for the last 30 days
          const endDate = new Date();
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - 30);

          const transactions = await apiCall(
              `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=100&sortBy=createdAt&sortDir=desc`
          );

          // Process data for chart
          const chartData = processTransactionsForChart(transactions.content || transactions);

          // Render chart (you can use Chart.js, Recharts, or any charting library)
          renderPurchasingChart(chartData);
      } catch (error) {
          console.error('Error loading purchasing trends:', error);
      }
  }

  function processTransactionsForChart(transactions) {
      const dailyData = {};

      transactions.forEach(transaction => {
          const date = formatDate(transaction.createdAt);
          if (!dailyData[date]) {
              dailyData[date] = {
                  date,
                  amount: 0,
                  count: 0
              };
          }
          dailyData[date].amount += parseFloat(transaction.totalAmount || 0);
          dailyData[date].count += 1;
      });

      return Object.values(dailyData).sort((a, b) =>
          new Date(a.date) - new Date(b.date)
      );
  }

  function renderPurchasingChart(data) {
      const chartContainer = document.getElementById('purchasingChart');
      if (!chartContainer) return;

      // Simple bar chart visualization
      const maxAmount = Math.max(...data.map(d => d.amount));

      chartContainer.innerHTML = `
          <div class="simple-chart">
              ${data.map(item => `
                  <div class="chart-bar" style="height: ${(item.amount / maxAmount) * 100}%">
                      <div class="chart-label">${item.date}</div>
                      <div class="chart-value">${formatCurrency(item.amount)}</div>
                  </div>
              `).join('')}
          </div>
      `;
  }

  function loadOrderStatusChart(analytics) {
      const chartContainer = document.getElementById('orderStatusChart');
      if (!chartContainer) return;

      const statusData = [
          { status: 'Completed', count: analytics.completedTransactions || 0, color: '#10b981' },
          { status: 'Pending', count: analytics.pendingTransactions || 0, color: '#f59e0b' },
          { status: 'In Transit', count: analytics.inTransitTransactions || 0, color: '#3b82f6' },
          { status: 'Cancelled', count: analytics.cancelledTransactions || 0, color: '#ef4444' }
      ];

      const total = statusData.reduce((sum, item) => sum + item.count, 0);

      chartContainer.innerHTML = `
          <div class="donut-chart">
              ${statusData.map(item => `
                  <div class="donut-segment" style="--percentage: ${(item.count / total) * 100}%; --color: ${item.color};">
                      <span class="segment-label">${item.status}</span>
                      <span class="segment-value">${item.count}</span>
                  </div>
              `).join('')}
          </div>
      `;
  }







async function loadMarketplaceData() {
    try {
        console.log('=== LOADING MARKETPLACE ===');

        // 1. Load active productions
        const productionsResponse = await apiCall(`${API_BASE_URL}/v1/crop-productions/active`);
        const productions = extractDataFromResponse(productionsResponse);

        console.log('=== PRODUCTIONS LOADED ===');
        console.log('Productions Count:', productions.length);

        if (productions.length === 0) {
            console.warn('No active productions found');
            showNotification('No products available in marketplace', 'info');
            displayMarketplaceProducts([]);
            return;
        }

        // 2. Load crops
        const cropsResponse = await apiCall(`${API_BASE_URL}/v1/crops/all`);
        const crops = extractDataFromResponse(cropsResponse);

        // 3.  Load all farmers
        const farmersResponse = await apiCall(`${API_BASE_URL}/users/farmers`);
        const farmers = extractDataFromResponse(farmersResponse);

        console.log('=== FARMERS LOADED ===');
        console.log('Farmers Count:', farmers.length);

        // 4. Create maps
        const cropsMap = {};
        crops.forEach(crop => {
            if (crop.id) cropsMap[crop.id] = crop;
            if (crop.cropId) cropsMap[crop.cropId] = crop;
        });

        const farmersMap = {};
        farmers.forEach(farmer => {
            if (farmer.id) {
                farmersMap[farmer.id] = farmer;
            }
        });

        // 5.  Enrich productions with crop AND farmer details
        const enrichedProductions = productions.map(prod => {
            const crop = cropsMap[prod.cropId];
            const farmer = farmersMap[prod.farmerId];

            const farmerName = farmer?.fullName || farmer?.username || 'Contact Support';

            return {
                id: prod.id,
                productionCode: prod.productionCode,
                cropId: prod.cropId,
                cropName: crop?.cropName || prod.cropName || 'Unknown Crop',
                cropType: crop?.cropType || prod.cropType || 'Unknown',
                cropImageUrl: crop?.imageUrl || prod.cropImageUrl,
                cropDescription: crop?.description || prod.notes,
                cropVariety: crop?.variety || prod.seedVariety,

                //  FARMER INFORMATION
                farmerId: prod.farmerId,
                farmerName: farmerName,
                farmerFullName: farmer?.fullName || farmerName,
                farmerEmail: farmer?.email,
                farmerPhone: farmer?.phoneNumber,
                farmId: prod.farmId,

                // Availability
                availableQuantity: prod.expectedYield || prod.actualYield || 0,
                price: prod.estimatedPrice || prod.marketPrice || 0,
                pricePerKg: prod.estimatedPrice || prod.marketPrice || 0,

                // Dates
                expectedHarvestDate: prod.expectedHarvestDate,
                actualHarvestDate: prod.actualHarvestDate,
                plantingDate: prod.plantingDate,

                // Location & Status
                location: prod.location || 'Rwanda',
                productionStatus: prod.productionStatus,
                productionMethod: prod.productionMethod,

                // Quality
                qualityGrade: prod.qualityGrade || 'STANDARD',
                isOrganic: prod.productionMethod?.includes('ORGANIC'),
                certification: prod.certification,

                // Additional info
                unit: 'Kg',
                currency: 'RWF',
                type: 'crop_production',
                productionId: prod.id
            };
        });

        console.log('=== ENRICHED PRODUCTIONS ===');
        console.log('Count:', enrichedProductions.length);
        if (enrichedProductions.length > 0) {
            console.log('First product:', enrichedProductions[0]);
        }

        populateCategoryFilter(crops);
        displayMarketplaceProducts(enrichedProductions);
        showNotification(`${enrichedProductions.length} products loaded`, 'success');

    } catch (error) {
        console.error('=== ERROR LOADING MARKETPLACE ===', error);
        showNotification('Failed to load marketplace: ' + error.message, 'error');
        displayMarketplaceProducts([]);
    }
}




//  BONUS: Also update the product card display function to use the farmer name
function createProductCard(product) {
    const harvestDate = product.actualHarvestDate || product.expectedHarvestDate;
    const harvestLabel = product.actualHarvestDate ? 'Harvested' : 'Expected';
    const timeAgo = harvestDate ? getTimeAgo(new Date(harvestDate)) : 'Date not set';

    //  Use the enriched farmer name
    const farmerDisplay = product.farmerFullName || product.farmerName || 'Contact Support';

    return `
        <div class="marketplace-card" onclick="openProductDetail('${product.id}')">
            <div class="product-image">
                ${product.cropImageUrl
                    ? `<img src="${product.cropImageUrl}" alt="${product.cropName}">`
                    : `<div class="no-image">No Image Available</div>`
                }
                ${product.certification ? `<span class="badge-certified">CERTIFIED</span>` : ''}
            </div>
            <div class="product-info">
                <h3>${product.cropName}</h3>
                <p class="product-type">${product.cropType || 'Agricultural Product'}</p>
                <div class="product-details-grid">
                    <div class="detail-item">
                        <i class="fas fa-boxes"></i>
                        <div>
                            <span class="label">Available:</span>
                            <span class="value">${product.availableQuantity} ${product.unit}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-tag"></i>
                        <div>
                            <span class="label">Price:</span>
                            <span class="value price">${product.currency} ${product.pricePerKg}/${product.unit}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-calendar"></i>
                        <div>
                            <span class="label">${harvestLabel}:</span>
                            <span class="value">${timeAgo}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-user"></i>
                        <div>
                            <span class="label">Farmer:</span>
                            <span class="value farmer-name">${farmerDisplay}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <div>
                            <span class="label">Location:</span>
                            <span class="value">${product.location}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-leaf"></i>
                        <div>
                            <span class="label">Method:</span>
                            <span class="value">${product.productionMethod || 'CONVENTIONAL'}</span>
                        </div>
                    </div>
                </div>
                <button class="btn-add-cart" onclick="event.stopPropagation(); addToCart('${product.id}')">
                    <i class="fas fa-cart-plus"></i> Add to Cart
                </button>
            </div>
        </div>
    `;
}

// Helper function for time ago display
function getTimeAgo(date) {
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const weeks = Math.floor(days / 7);
    const months = Math.floor(days / 30);

    if (months > 0) return `${months} month${months > 1 ? 's' : ''} ago`;
    if (weeks > 0) return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
    if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
    return 'Today';
}


function extractDataFromResponse(response) {
    console.log('Extracting data from response:', response);

    // If the response is already an array
    if (Array.isArray(response)) {
        console.log('Response is array, length:', response.length);
        return response;
    }

    // If the response has 'data' property (ApiResponse wrapper)
    if (response && response.data !== undefined) {
        if (Array.isArray(response.data)) {
            console.log('Response.data is array, length:', response.data.length);
            return response.data;
        }
        // If data.content exists (pagination)
        if (response.data && response.data.content && Array.isArray(response.data.content)) {
            console.log('Response.data.content is array, length:', response.data.content.length);
            return response.data.content;
        }
        // If data is an object with content
        if (response.data && Array.isArray(response.data)) {
            console.log('Response.data extracted, length:', response.data.length);
            return response.data;
        }
    }

    // If the response has 'content' property (pagination)
    if (response && response.content && Array.isArray(response.content)) {
        console.log('Response.content is array, length:', response.content.length);
        return response.content;
    }

    // If response has success/data structure from ApiResponse
    if (response && response.success && response.data) {
        if (Array.isArray(response.data)) {
            console.log('Response ApiResponse format, length:', response.data.length);
            return response.data;
        }
    }

    // Default: return empty array
    console.warn('Could not extract data from response, returning empty array. Response was:', response);
    return [];
}




//  FONCTION CORRIGE : Enrichir les market prices avec les noms des crops
function enrichMarketPricesWithCropNames(marketPrices, crops) {
    console.log('Enriching market prices...');
    console.log('Market prices to enrich:', marketPrices);
    console.log('Crops available:', crops);

    // Crer un map des crops par cropId/id
    const cropsMap = {};
    crops.forEach(crop => {
        if (crop.id) {
            cropsMap[crop.id] = crop;
        }
        if (crop.cropId) {
            cropsMap[crop.cropId] = crop;
        }
    });

    console.log('Crops map:', cropsMap);

    // Enrichir chaque market price
    const enriched = marketPrices.map(price => {
        // Chercher le crop correspondant
        const crop = cropsMap[price.cropId];

        if (!crop) {
            console.warn(`No crop found for cropId: ${price.cropId}`);
        }

        return {
            ...price,
            // Nom de la culture
            cropName: crop ? (crop.cropName || crop.name || 'Unknown Crop') : `Crop ${price.cropId}`,
            // Type de culture
            cropType: crop ? (crop.cropType || crop.type || 'Unknown') : 'Unknown',
            // Image de la culture
            cropImageUrl: crop ? (crop.imageUrl || crop.image || null) : null,
            // Description de la culture
            cropDescription: crop ? (crop.description || crop.desc || null) : null,
            // Varit (si disponible)
            cropVariety: crop ? (crop.variety || null) : null
        };
    });

    console.log('Enriched market prices result:', enriched);
    return enriched;
}

//  FONCTION CORRIGE : Fusionner les market prices avec les productions
function mergeMarketPricesWithProductions(marketPrices, productions) {
    console.log('Merging market prices with productions...');

    // Crer un map des productions par cropId
    const productionsMap = {};
    productions.forEach(prod => {
        if (!productionsMap[prod.cropId]) {
            productionsMap[prod.cropId] = [];
        }
        productionsMap[prod.cropId].push(prod);
    });

    // Fusionner les donnes
    return marketPrices.map(price => {
        const relatedProductions = productionsMap[price.cropId] || [];

        // Calculer la quantit disponible totale
        const totalAvailable = relatedProductions.reduce((sum, prod) => {
            const quantity = prod.expectedYield || prod.actualYield || 0;
            return sum + parseFloat(quantity);
        }, 0);

        return {
            id: price.id,
            cropId: price.cropId,
            cropName: price.cropName || 'Unknown Crop',
            cropType: price.cropType || 'Unknown',
            cropImageUrl: price.cropImageUrl,
            cropDescription: price.cropDescription,
            cropVariety: price.cropVariety,
            price: price.pricePerKg || price.price || 0,
            pricePerKg: price.pricePerKg || price.price || 0,
            currency: price.currency || 'RWF',
            unit: price.unit || 'Kg',
            marketName: price.marketName || 'Local Market',
            marketType: price.marketType || 'RETAIL',
            location: price.location || 'Rwanda',
            priceDate: price.priceDate || new Date().toISOString(),
            demandLevel: price.demandLevel || 'MEDIUM',
            supplyLevel: price.supplyLevel || 'MEDIUM',
            priceTrend: price.priceTrend || 'STABLE',
            availableQuantity: totalAvailable,
            productionsCount: relatedProductions.length,
            relatedProductions: relatedProductions,
            dataSource: price.dataSource || 'Manual',
            reliabilityScore: price.reliabilityScore || 3,
            notes: price.notes || ''
        };
    });
}



function displayMarketplaceProducts(products) {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;

    console.log('Displaying marketplace products:', products);

    if (!products || products.length === 0) {
        productsGrid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <i class="fas fa-inbox"></i>
                <h3>No Products Available</h3>
                <p>There are no products available in the marketplace at the moment.</p>
            </div>
        `;
        return;
    }

    productsGrid.innerHTML = products.map((product, index) => {
        console.log(`Product ${index}:`, {
            id: product.id,
            cropName: product.cropName,
            price: product.pricePerKg,
            type: product.id.startsWith('MP') ? 'market_price' : 'crop_production'
        });

        return `
            <div class="product-card">
                <div class="product-image" onclick="viewProductDetails('${product.id}')">
                    ${product.cropImageUrl ?
                        `<img src="${product.cropImageUrl}" alt="${product.cropName}">` :
                        `<div class="product-placeholder">
                            <i class="fas fa-seedling"></i>
                            <span>No Image</span>
                         </div>`
                    }
                    ${product.priceTrend === 'INCREASING' ?
                        '<span class="product-badge organic" style="background: var(--danger-color);">Price Rising </span>' :
                        product.priceTrend === 'DECREASING' ?
                        '<span class="product-badge ready" style="background: var(--success-color);">Price Falling </span>' :
                        '<span class="product-badge" style="background: var(--info-color);">Price Stable </span>'
                    }
                    ${product.id.startsWith('MP') ?
                        '<span class="product-badge" style="background: var(--primary-color); top: 40px;">Market Price</span>' :
                        '<span class="product-badge" style="background: var(--secondary-color); top: 40px;">Direct Sale</span>'
                    }
                </div>
                <div class="product-info">
                    <div class="product-category">${product.cropType || 'Agriculture'}</div>
                    <h3 class="product-name">${product.cropName}</h3>

                    <div class="product-details">
                        <div class="detail-item">
                            <i class="fas fa-weight"></i>
                            <span>${product.availableQuantity || 0} kg available</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${product.location || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-store"></i>
                            <span>${product.marketName || 'Market'}</span>
                        </div>
                    </div>

                    <div class="product-footer">
                        <div class="product-price">
                            <span class="price-value">${formatCurrency(product.pricePerKg || product.price || 0)}</span>
                            <span class="price-unit">/kg</span>
                        </div>
                        <div class="product-actions" style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm"
                                    onclick="viewProductDetails('${product.id}')"
                                    style="flex: 1; padding: 0.5rem; font-size: 0.85rem;">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                            ${(product.availableQuantity || 0) > 0 || product.id.startsWith('MP') ? `
                                <button class="btn btn-primary btn-sm"
                                        onclick="addToCart('${product.id}')"
                                        style="flex: 1; padding: 0.5rem; font-size: 0.85rem;">
                                    <i class="fas fa-shopping-cart"></i> Add
                                </button>
                            ` : `
                                <button class="btn btn-secondary btn-sm" disabled
                                        style="flex: 1; padding: 0.5rem; font-size: 0.85rem;">
                                    <i class="fas fa-ban"></i> Out of Stock
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}





// Helper functions
function formatPrice(price) {
    return parseFloat(price).toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
    return date.toLocaleDateString();
}

function getReliabilityBadge(score) {
    if (score >= 4) {
        return '<span class="badge bg-success"> Verified</span>';
    } else if (score >= 3) {
        return '<span class="badge bg-info"> Good</span>';
    } else {
        return '<span class="badge bg-warning"> Fair</span>';
    }
}

//  FONCTION AMLIORE : Peupler le filtre de catgories
function populateCategoryFilter(crops) {
    const categoryFilter = document.getElementById('categoryFilter');
    if (!categoryFilter) return;

    // Extraire les types de cultures uniques
    const cropTypes = [...new Set(crops.map(crop => crop.cropType || crop.type).filter(Boolean))];

    // Gnrer les options
    categoryFilter.innerHTML = `
        <option value="">All Categories</option>
        ${cropTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
    `;
}




// 4. FONCTION HELPER POUR LES BADGES DE QUALIT
function getQualityBadgeClass(qualityGrade) {
    if (!qualityGrade) return 'quality-standard';
    const grade = qualityGrade.toLowerCase();
    if (grade.includes('organic') || grade.includes('premium')) return 'quality-organic';
    if (grade.includes('certified') || grade.includes('grade a')) return 'quality-certified';
    return 'quality-standard';
}

// 5. AJOUTER AU PANIER AVEC PRIX DU MARCH
async function addProductToCart(productionId, marketPrice) {
    try {
        // FIX: Utiliser ENDPOINTS ou construire correctement l'URL
        const production = await apiCall(`${API_BASE_URL}/v1/crop-productions/${productionId}`);

        if (!production) {
            showNotification('Product not found', 'error');
            return;
        }

        if ((production.expectedYield || 0) <= 0) {
            showNotification('This product is out of stock', 'warning');
            return;
        }

        const existingItem = shoppingCart.find(item => item.productionId === productionId);

        if (existingItem) {
            existingItem.quantity += 1;
            showNotification('Quantity updated in cart', 'success');
        } else {
            shoppingCart.push({
                productionId: production.id,
                cropId: production.cropId,
                cropName: production.cropName,
                farmerName: production.farmerName,
                farmerId: production.farmerId,
                price: marketPrice || production.estimatedPrice || 0,
                quantity: 1,
                availableQuantity: production.expectedYield || 0,
                imageUrl: production.cropImageUrl,
                location: production.location,
                expectedHarvestDate: production.expectedHarvestDate
            });
            showNotification('Product added to cart', 'success');
        }

        saveCartToStorage();
        updateCartBadge();

    } catch (error) {
        console.error('Error adding to cart:', error);
        showNotification('Failed to add product to cart', 'error');
    }
}

// 6. VOIR LES DTAILS D'UN PRODUIT DU MARKETPLACE
function viewMarketplaceProductDetails(productId, productData) {
    try {
        const product = typeof productData === 'string' ? JSON.parse(productData) : productData;

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content large">
                <div class="modal-header">
                    <h2>${product.cropName}</h2>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="product-details-grid">
                        <div class="product-image-section">
                            ${product.cropImageUrl ?
                                `<img src="${product.cropImageUrl}" alt="${product.cropName}">` :
                                `<div class="product-placeholder-large">
                                    <i class="fas fa-seedling"></i>
                                </div>`
                            }
                        </div>

                        <div class="product-info-section">
                            <h3>Market Information</h3>

                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="label">Current Price:</span>
                                    <span class="value price-highlight">${formatCurrency(product.price)}/kg</span>
                                </div>

                                <div class="info-item">
                                    <span class="label">Market:</span>
                                    <span class="value">${product.marketName || 'N/A'}</span>
                                </div>

                                <div class="info-item">
                                    <span class="label">Location:</span>
                                    <span class="value">${product.location || 'N/A'}</span>
                                </div>

                                <div class="info-item">
                                    <span class="label">Market Type:</span>
                                    <span class="value">${product.marketType || 'N/A'}</span>
                                </div>

                                ${product.availableQuantity > 0 ? `
                                    <div class="info-item">
                                        <span class="label">Available:</span>
                                        <span class="value">${product.availableQuantity} kg</span>
                                    </div>
                                ` : ''}

                                ${product.qualityGrade ? `
                                    <div class="info-item">
                                        <span class="label">Quality Grade:</span>
                                        <span class="value">${product.qualityGrade}</span>
                                    </div>
                                ` : ''}

                                ${product.demandLevel ? `
                                    <div class="info-item">
                                        <span class="label">Demand Level:</span>
                                        <span class="value">${product.demandLevel}</span>
                                    </div>
                                ` : ''}

                                ${product.supplyLevel ? `
                                    <div class="info-item">
                                        <span class="label">Supply Level:</span>
                                        <span class="value">${product.supplyLevel}</span>
                                    </div>
                                ` : ''}

                                ${product.priceTrend ? `
                                    <div class="info-item">
                                        <span class="label">Price Trend:</span>
                                        <span class="value ${product.priceTrend.toLowerCase()}">${product.priceTrend}</span>
                                    </div>
                                ` : ''}

                                ${product.farmerName ? `
                                    <div class="info-item">
                                        <span class="label">Farmer:</span>
                                        <span class="value">${product.farmerName}</span>
                                    </div>
                                ` : ''}

                                ${product.expectedHarvestDate ? `
                                    <div class="info-item">
                                        <span class="label">Harvest Date:</span>
                                        <span class="value">${formatDate(product.expectedHarvestDate)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                        Close
                    </button>

                    ${product.isAvailable && product.productionId ? `
                        <button class="btn btn-primary"
                                onclick="addProductToCart('${product.productionId}', ${product.price}); this.closest('.modal').remove();">
                            <i class="fas fa-shopping-cart"></i>
                            Add to Cart
                        </button>
                    ` : ''}
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);

    } catch (error) {
        console.error('Error showing product details:', error);
        showNotification('Failed to load product details', 'error');
    }
}

// 7. RENDRE LES FONCTIONS GLOBALES
window.addProductToCart = addProductToCart;
window.viewMarketplaceProductDetails = viewMarketplaceProductDetails;

console.log('Marketplace fix applied successfully');

function populateCategoryFilter(crops) {
    const categoryFilter = document.getElementById('categoryFilter');
    if (!categoryFilter) return;

    // FIX: Ensure crops is an array before mapping
    if (!Array.isArray(crops) || crops.length === 0) {
        categoryFilter.innerHTML = '<option value="">All Categories</option>';
        return;
    }

    // Get unique crop types
    const cropTypes = [...new Set(crops.map(crop => crop.cropType).filter(type => type))];

    categoryFilter.innerHTML = `
        <option value="">All Categories</option>
        ${cropTypes.map(type => `
            <option value="${type}">${type}</option>
        `).join('')}
    `;
}



function displayProducts(productions) {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;

    if (!Array.isArray(productions)) {
        console.error('Productions is not an array:', productions);
        productions = [];
    }

    if (productions.length === 0) {
        productsGrid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                <i class="fas fa-inbox" style="font-size: 4rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                <h3>No Products Available</h3>
                <p>There are no products available in the marketplace at the moment.</p>
            </div>
        `;
        return;
    }

    productsGrid.innerHTML = productions.map(production => {
        //  FIX: Ensure we have the correct ID
        const productId = production.id || production.productionId || production._id;

        console.log('Production item:', {
            id: productId,
            productionCode: production.productionCode,
            cropName: production.cropName
        });

        return `
            <div class="product-card" onclick="viewProductDetails('${productId}')" style="cursor: pointer;">
                <div class="product-image" style="position: relative;">
                    ${production.cropImageUrl ?
                        `<img src="${production.cropImageUrl}" alt="${production.cropName}"
                             style="width: 100%; height: 200px; object-fit: cover;"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZWNmMGYxIi8+CjxwYXRoIGQ9Ik03NSA1MEgxMjVWMTUwSDc1VjUwWiIgZmlsbD0iIzJlY2M3MSIvPgo8Y2lyY2xlIGN4PSIxMDAiIGN5PSI3NSIgcj0iMTUiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==';">` :
                        `<div class="product-placeholder" style="width: 100%; height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--gray);">
                            <i class="fas fa-seedling" style="font-size: 3rem; color: var(--text-light);"></i>
                            <span style="color: var(--text-light); margin-top: 0.5rem;">No Image</span>
                         </div>`
                    }
                    ${production.productionMethod === 'ORGANIC' || production.productionMethod === 'CERTIFIED_ORGANIC' ?
                        '<span class="product-badge organic" style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--success-color); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem;">Organic</span>' : ''}
                    ${production.productionStatus === 'HARVESTED' ?
                        '<span class="product-badge ready" style="position: absolute; top: 0.5rem; left: 0.5rem; background: var(--info-color); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem;">Ready</span>' : ''}
                </div>
                <div class="product-info" style="padding: 1rem;">
                    <div class="product-category" style="font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; margin-bottom: 0.5rem;">
                        ${production.cropType || 'Agriculture'}
                    </div>
                    <h3 class="product-name" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">
                        ${production.cropName || 'Unknown Crop'}
                    </h3>
                    <p class="product-farmer" style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem;">
                        <i class="fas fa-user"></i>
                        ${production.farmerName || 'Unknown Farmer'}
                    </p>
                    <div class="product-details" style="margin: 1rem 0;">
                        <div class="detail-item" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                            <i class="fas fa-weight" style="width: 16px; color: var(--primary-color);"></i>
                            <span>${production.expectedYield || production.actualYield || 0} kg available</span>
                        </div>
                        <div class="detail-item" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                            <i class="fas fa-map-marker-alt" style="width: 16px; color: var(--primary-color);"></i>
                            <span>${production.location || 'Location not specified'}</span>
                        </div>
                        <div class="detail-item" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                            <i class="fas fa-calendar" style="width: 16px; color: var(--primary-color);"></i>
                            <span>Harvest: ${formatDate(production.expectedHarvestDate || production.actualHarvestDate)}</span>
                        </div>
                    </div>
                    <div class="product-footer" style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <div class="product-price">
                            <span class="price-value" style="font-size: 1.3rem; font-weight: 700; color: var(--primary-color);">
                                ${formatCurrency(production.estimatedPrice || 0)}
                            </span>
                            <span class="price-unit" style="font-size: 0.9rem; color: var(--text-light);">/kg</span>
                        </div>
                        <button class="btn btn-primary btn-sm"
                                onclick="event.stopPropagation(); addToCart('${productId}')"
                                ${(production.expectedYield || production.actualYield || 0) <= 0 ? 'disabled' : ''}
                                style="padding: 0.5rem 1rem; border: none; border-radius: var(--radius-md); background: var(--primary-color); color: white; cursor: pointer;">
                            <i class="fas fa-shopping-cart"></i>
                            ${(production.expectedYield || production.actualYield || 0) <= 0 ? 'Out of Stock' : 'Add'}
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}









async function searchProducts(query) {
    try {
        const response = await apiCall(ENDPOINTS.cropProductionsActive);

        // FIX: Ensure we have an array
        const allProductions = Array.isArray(response) ? response :
                              (response.content ? response.content : []);

        const filtered = allProductions.filter(prod =>
            prod.cropName?.toLowerCase().includes(query.toLowerCase()) ||
            prod.farmerName?.toLowerCase().includes(query.toLowerCase()) ||
            prod.location?.toLowerCase().includes(query.toLowerCase())
        );
        displayProducts(filtered);
    } catch (error) {
        console.error('Error searching products:', error);
    }
}







// Load cart from localStorage and enrich with latest data
async function loadCartFromStorage() {
    try {
        const savedCart = localStorage.getItem('buyerCart');
        if (savedCart) {
            const parsedCart = JSON.parse(savedCart);

            console.log('=== LOADING CART FROM STORAGE ===');
            console.log('Saved cart items:', parsedCart.length);

            //  ENRICH each cart item with fresh farmer data
            const enrichedCart = await Promise.all(
                parsedCart.map(async (item) => {
                    // If farmer name is missing or "Unknown Farmer", fetch it
                    if (!item.farmerName || item.farmerName === 'Unknown Farmer') {
                        if (item.farmerId) {
                            try {
                                const farmerResponse = await apiCall(`${API_BASE_URL}/users/${item.farmerId}`);
                                const farmer = farmerResponse.data || farmerResponse;

                                item.farmerName = farmer.fullName || farmer.username || 'Unknown Farmer';
                                item.farmerEmail = farmer.email;
                                item.farmerPhone = farmer.phoneNumber;

                                console.log(` Enriched cart item with farmer: ${item.farmerName}`);
                            } catch (error) {
                                console.error(`Failed to load farmer ${item.farmerId}:`, error);
                                item.farmerName = 'Farmer Info Unavailable';
                            }
                        } else {
                            console.warn('Cart item has no farmerId:', item);
                        }
                    }
                    return item;
                })
            );

            shoppingCart = enrichedCart;
            updateCartBadge();
            updateCartDisplay();

            console.log('Cart loaded and enriched:', shoppingCart);
        }
    } catch (error) {
        console.error('Error loading cart:', error);
        shoppingCart = [];
    }
}





// Save cart to localStorage
function saveCartToStorage() {
    try {
        localStorage.setItem('buyerCart', JSON.stringify(shoppingCart));
        console.log('Cart saved to storage:', shoppingCart);
    } catch (error) {
        console.error('Error saving cart:', error);
    }
}





async function addToCart(productId) {
    console.log('=== ADD TO CART CALLED ===');
    console.log('Product ID:', productId);

    try {
        showNotification('Adding to cart...', 'info');

        let productData = null;
        let productType = null;

        // STRATEGY 1: Market Price
        if (productId.startsWith('MP')) {
            console.log('Detected Market Price ID');
            try {
                const marketPriceResponse = await apiCall(`${API_BASE_URL}/market-prices/${productId}`);
                //  UNWRAP ApiResponse if needed
                productData = marketPriceResponse.data || marketPriceResponse;
                productType = 'market_price';
                console.log(' Market Price found:', productData);
            } catch (error) {
                console.error('Market Price not found:', error);
            }
        }

        // STRATEGY 2: Crop Production
        if (!productData) {
            console.log('Trying as Crop Production...');
            try {
                const productionResponse = await apiCall(`${API_BASE_URL}/v1/crop-productions/${productId}`);

                //  CRITICAL FIX: Unwrap ApiResponse wrapper
                console.log('Raw API Response:', productionResponse);

                // Check if response has a 'data' property (ApiResponse wrapper)
                if (productionResponse.data) {
                    productData = productionResponse.data;
                } else if (productionResponse.success && productionResponse.data) {
                    productData = productionResponse.data;
                } else {
                    // Response is the data itself
                    productData = productionResponse;
                }

                productType = 'crop_production';

                console.log(' Crop Production found:', productData);
                console.log(' Crop Name:', productData.cropName);
                console.log(' Farmer Name:', productData.farmerName);
                console.log(' Available quantity:', productData.expectedYield || productData.actualYield);

                //  VALIDATION: Check if enrichment succeeded
                if (!productData.cropName || productData.cropName === 'Unknown Crop') {
                    console.error(' Crop name is missing after API call!');
                    throw new Error('Product information incomplete - crop name missing');
                }

                if (!productData.farmerName || productData.farmerName === 'Unknown Farmer') {
                    console.warn(' Farmer name is missing');
                }

            } catch (error) {
                console.error('Crop Production not found:', error);
                throw error;
            }
        }

        if (!productData) {
            showNotification('Product not found or unavailable', 'error');
            return;
        }

        //  PROCESS BASED ON TYPE
        if (productType === 'market_price') {
            await addMarketPriceToCart(productData);
        } else if (productType === 'crop_production') {
            await addCropProductionToCart(productData);
        }

    } catch (error) {
        console.error('Error in addToCart:', error);
        showNotification('Failed to add product to cart: ' + error.message, 'error');
    }
}




async function addCropProductionToCart(production) {
    console.log('=== ADDING CROP PRODUCTION TO CART ===');
    console.log('Production data:', production);

    const availableQty = parseFloat(production.expectedYield || production.actualYield || 0);

    if (availableQty <= 0 || isNaN(availableQty)) {
        console.warn('Product out of stock. Quantity:', availableQty);
        showNotification('This product is out of stock', 'warning');
        return;
    }

    //  CRITICAL: Get enriched information
    const cropName = production.cropName;
    const farmerName = production.farmerName;
    const location = production.location || production.deliveryLocation || 'Location not specified';

    //  UTILISER pricePerKg avec fallback sur estimatedPrice
    let pricePerKg = parseFloat(production.pricePerKg || 0);

    // Si pricePerKg est 0, essayer d'utiliser estimatedPrice
    if (pricePerKg === 0 && production.estimatedPrice) {
        pricePerKg = parseFloat(production.estimatedPrice);
    }

    // Si toujours 0, utiliser un prix par dfaut
    if (pricePerKg === 0) {
        pricePerKg = 1000; // Prix par dfaut
        console.warn(' No price found, using default: 1000 RWF/kg');
    }

    //  VALIDATION
    if (!cropName || cropName === 'Unknown Crop') {
        console.error(' Crop name is missing!');
        showNotification('Product information incomplete - crop name missing', 'error');
        return;
    }

    if (!farmerName || farmerName === 'Unknown Farmer' || farmerName === 'Farmer Info Unavailable') {
        console.error(' Farmer name is missing!');
        showNotification('Product information incomplete - farmer information missing', 'error');
        return;
    }

    // Check if already in cart
    const existingItemIndex = shoppingCart.findIndex(item =>
        item.productionId === production.id
    );

    if (existingItemIndex !== -1) {
        const existingItem = shoppingCart[existingItemIndex];
        if (existingItem.quantity + 1 > availableQty) {
            showNotification(`Maximum ${availableQty} kg available`, 'warning');
            return;
        }
        existingItem.quantity += 1;
        showNotification('Quantity updated in cart', 'success');
    } else {
        //  Add new item with complete information
        const cartItem = {
            productionId: production.id,
            cropId: production.cropId,

            //  CROP INFO
            cropName: cropName,
            cropImageUrl: production.cropImageUrl,
            cropType: production.cropType,

            //  FARMER INFO
            farmerId: production.farmId,
            farmerName: farmerName,
            farmerEmail: production.farmerEmail,
            farmerPhone: production.farmerPhone,

            //  PRICING & QUANTITY - UTILISER pricePerKg
            pricePerKg: pricePerKg,
            price: pricePerKg, // Pour compatibilit
            quantity: 1,
            availableQuantity: availableQty,

            //  LOCATION
            location: location,
            unit: 'kg',
            type: 'crop_production',

            // Additional info
            expectedHarvestDate: production.expectedHarvestDate,
            productionMethod: production.productionMethod,
            qualityGrade: production.qualityGrade || 'STANDARD',
            packaging: production.packaging || 'BAG'
        };

        console.log(' Cart item to add:', cartItem);
        console.log(' Crop name:', cartItem.cropName);
        console.log(' Farmer name:', cartItem.farmerName);
        console.log(' Location:', cartItem.location);
        console.log(' Price per kg:', cartItem.pricePerKg, 'RWF');
        console.log(' Total for 1kg:', cartItem.pricePerKg * 1, 'RWF');

        shoppingCart.push(cartItem);
        showNotification(`Added ${cropName} to cart at ${pricePerKg} RWF/kg`, 'success');
    }

    saveCartToStorage();
    updateCartBadge();
    updateCartDisplay();

    console.log('Shopping cart after adding:', shoppingCart);
}

// Make functions globally available
window.addToCart = addToCart;
window.addCropProductionToCart = addCropProductionToCart;

console.log(' Fixed cart functions loaded');



function updateCartBadge() {
    const cartBadge = document.getElementById('cartBadge');
    if (cartBadge) {
        const itemCount = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
        cartBadge.textContent = itemCount;
        cartBadge.style.display = itemCount > 0 ? 'inline-block' : 'none';
    }
}








//  AJOUTER MARKET PRICE AU PANIER
async function addMarketPriceToCart(marketPrice) {
    console.log('Adding Market Price to cart:', marketPrice);

    // Check available quantity
    const availableQty = marketPrice.availableQuantity || 0;
    if (availableQty <= 0) {
        showNotification('This product is out of stock', 'warning');
        return;
    }

    // Get crop details if needed
    let cropDetails = null;
    if (marketPrice.cropId) {
        try {
            const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${marketPrice.cropId}`);
            cropDetails = cropResponse.data || cropResponse;
        } catch (error) {
            console.warn('Could not load crop details:', error);
        }
    }

    // Check if already in cart
    const existingItemIndex = shoppingCart.findIndex(item =>
        item.marketPriceId === marketPrice.id
    );

    if (existingItemIndex !== -1) {
        // Update quantity
        const existingItem = shoppingCart[existingItemIndex];
        if (existingItem.quantity + 1 > availableQty) {
            showNotification(`Maximum ${availableQty} kg available`, 'warning');
            return;
        }
        existingItem.quantity += 1;
        showNotification('Quantity updated in cart', 'success');
    } else {
        // Add new item
        shoppingCart.push({
            marketPriceId: marketPrice.id,
            cropId: marketPrice.cropId,
            cropName: cropDetails?.cropName || marketPrice.cropName || 'Unknown Crop',
            cropImageUrl: cropDetails?.imageUrl || marketPrice.cropImageUrl,
            price: marketPrice.pricePerKg || marketPrice.price || 0,
            quantity: 1,
            availableQuantity: availableQty,
            location: marketPrice.location || 'N/A',
            marketName: marketPrice.marketName || 'Market',
            unit: 'kg',
            type: 'market_price',
            // Additional info for checkout
            marketType: marketPrice.marketType,
            demandLevel: marketPrice.demandLevel,
            supplyLevel: marketPrice.supplyLevel
        });
        showNotification('Product added to cart', 'success');
    }

    saveCartToStorage();
    updateCartBadge();
    updateCartDisplay();
}










function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    if (!cartItems) return;

    console.log('=== UPDATING CART DISPLAY ===');
    console.log('Cart items:', shoppingCart);

    if (shoppingCart.length === 0) {
        cartItems.innerHTML = `
            <div class="empty-cart" style="text-align: center; padding: 3rem; grid-column: 1 / -1;">
                <i class="fas fa-shopping-cart" style="font-size: 4rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                <h3>Your cart is empty</h3>
                <p style="color: var(--text-light); margin-bottom: 1.5rem;">Browse our marketplace to add products</p>
                <button class="btn btn-primary" onclick="setActiveSection('marketplace')">
                    <i class="fas fa-store"></i>
                    Browse Products
                </button>
            </div>
        `;
        updateCartSummary(0, 0, 0);
        return;
    }

    cartItems.innerHTML = shoppingCart.map((item, index) => {
        console.log(`Rendering cart item ${index}:`, {
            cropName: item.cropName,
            farmerName: item.farmerName,
            farmerId: item.farmerId,
            price: item.price,
            quantity: item.quantity
        });

        return `
        <div class="cart-item" style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; display: flex; gap: 1.5rem; box-shadow: var(--shadow-sm); margin-bottom: 1rem; border: 1px solid var(--border-color); transition: all 0.2s;"
             onmouseover="this.style.boxShadow='var(--shadow-md)'"
             onmouseout="this.style.boxShadow='var(--shadow-sm)'">

            <!-- Product Image -->
            <div class="cart-item-image" style="width: 120px; height: 120px; flex-shrink: 0; border-radius: var(--radius-md); overflow: hidden; background: var(--light-gray);">
                ${item.cropImageUrl ?
                    `<img src="${item.cropImageUrl}" alt="${item.cropName}"
                         style="width: 100%; height: 100%; object-fit: cover;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div style="display: none; width: 100%; height: 100%; background: var(--primary-light); align-items: center; justify-content: center; flex-direction: column;">
                         <i class="fas fa-seedling" style="font-size: 2rem; color: var(--primary-color);"></i>
                     </div>` :
                    `<div style="width: 100%; height: 100%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; flex-direction: column;">
                         <i class="fas fa-seedling" style="font-size: 2rem; color: var(--primary-color);"></i>
                     </div>`
                }
            </div>

            <!-- Product Details -->
            <div class="cart-item-details" style="flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
                <!-- Product Name -->
                <div>
                    <h4 style="margin: 0 0 0.5rem 0; font-size: 1.15rem; font-weight: 700; color: var(--text-dark);">
                        ${item.cropName}
                    </h4>

                    <!--  FARMER NAME - HIGHLIGHTED -->
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; padding: 0.75rem; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: var(--radius-md); border-left: 3px solid var(--success-color);">
                        <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--success-color); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1rem; flex-shrink: 0;">
                            ${(item.farmerName || 'F').charAt(0).toUpperCase()}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.7rem; color: var(--success-color); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; margin-bottom: 0.15rem;">
                                <i class="fas fa-user"></i> Farmer
                            </div>
                            <div style="font-weight: 700; color: var(--text-dark); font-size: 0.95rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.farmerName || 'Farmer Info Unavailable'}">
                                ${item.farmerName || 'Farmer Info Unavailable'}
                            </div>
                            ${item.farmerPhone ? `
                                <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.15rem;">
                                    <i class="fas fa-phone" style="font-size: 0.7rem;"></i> ${item.farmerPhone}
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Location & Price -->
                    <div style="display: flex; gap: 1.5rem; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                            <i class="fas fa-map-marker-alt" style="color: var(--primary-color);"></i>
                            <span>${item.location}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                            <i class="fas fa-tag" style="color: var(--primary-color);"></i>
                            <span style="font-weight: 600; color: var(--primary-color);">${formatCurrency(item.price)}/kg</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quantity Controls & Actions -->
            <div class="cart-item-controls" style="display: flex; flex-direction: column; justify-content: space-between; align-items: flex-end; min-width: 180px;">
                <!-- Remove Button -->
                <button class="cart-item-remove" onclick="removeFromCart(${index})"
                        style="background: none; border: none; color: var(--danger-color); cursor: pointer; padding: 0.5rem; font-size: 1.2rem; transition: all 0.2s; border-radius: var(--radius-md);"
                        onmouseover="this.style.background='var(--danger-light)'"
                        onmouseout="this.style.background='none'"
                        title="Remove from cart">
                    <i class="fas fa-trash"></i>
                </button>

                <!-- Quantity Control -->
                <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); padding: 0.25rem; background: white;">
                        <button class="quantity-btn" onclick="updateCartQuantity(${index}, -1)"
                                style="background: none; border: none; padding: 0.5rem 0.75rem; cursor: pointer; font-size: 1.2rem; color: var(--primary-color); transition: all 0.2s; border-radius: var(--radius-sm);"
                                onmouseover="this.style.background='var(--primary-light)'"
                                onmouseout="this.style.background='none'">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" value="${item.quantity}" min="1" max="${item.availableQuantity}"
                               onchange="updateCartQuantity(${index}, this.value - ${item.quantity})"
                               style="width: 60px; text-align: center; border: none; font-weight: 700; font-size: 1.1rem; color: var(--text-dark);"
                               readonly>
                        <button class="quantity-btn" onclick="updateCartQuantity(${index}, 1)"
                                style="background: none; border: none; padding: 0.5rem 0.75rem; cursor: pointer; font-size: 1.2rem; color: var(--primary-color); transition: all 0.2s; border-radius: var(--radius-sm);"
                                onmouseover="this.style.background='var(--primary-light)'"
                                onmouseout="this.style.background='none'">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-light);">
                        Max: ${item.availableQuantity} kg
                    </div>
                </div>

                <!-- Subtotal -->
                <div style="text-align: right; padding: 0.75rem; background: var(--light-gray); border-radius: var(--radius-md); min-width: 140px;">
                    <div style="font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">
                        Subtotal
                    </div>
                    <div style="font-size: 1.4rem; font-weight: 800; color: var(--primary-color);">
                        ${formatCurrency(item.price * item.quantity)}
                    </div>
                </div>
            </div>
        </div>
    `}).join('');

    // Update cart summary
    const subtotal = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const shipping = calculateShipping(subtotal);
    const tax = calculateTax(subtotal);
    updateCartSummary(subtotal, shipping, tax);
}




function updateCartQuantity(index, change) {
    const item = shoppingCart[index];
    const newQuantity = item.quantity + change;

    if (newQuantity <= 0) {
        removeFromCart(index);
        return;
    }

    if (newQuantity > item.availableQuantity) {
        showNotification(`Maximum ${item.availableQuantity} kg available`, 'warning');
        return;
    }

    item.quantity = newQuantity;
    saveCartToStorage();
    updateCartDisplay();
}



function removeFromCart(index) {
    shoppingCart.splice(index, 1);
    saveCartToStorage();
    updateCartBadge();
    updateCartDisplay();
    showNotification('Product removed from cart', 'info');
}

function calculateShipping(subtotal) {
    if (subtotal === 0) return 0;
    const fixedFee = 2000;
    const percentageFee = subtotal * 0.05;
    return Math.max(fixedFee, percentageFee);
}

function calculateTax(subtotal) {
    return subtotal * 0.18;
}

function updateCartSummary(subtotal, shipping, tax) {
    const cartSubtotal = document.getElementById('cartSubtotal');
    const cartShipping = document.getElementById('cartShipping');
    const cartTax = document.getElementById('cartTax');
    const cartTotal = document.getElementById('cartTotal');

    if (cartSubtotal) cartSubtotal.textContent = formatCurrency(subtotal);
    if (cartShipping) cartShipping.textContent = formatCurrency(shipping);
    if (cartTax) cartTax.textContent = formatCurrency(tax);
    if (cartTotal) cartTotal.textContent = formatCurrency(subtotal + shipping + tax);
}




// ==================== ORDER CONFIRMATION MODAL ====================

function showOrderConfirmationModal(cartItems) {
    console.log('=== SHOWING ORDER CONFIRMATION ===');
    console.log('Cart items:', cartItems);

    if (!cartItems || cartItems.length === 0) {
        showNotification('Your cart is empty', 'warning');
        return;
    }

    // Remove any existing modals
    const existingModals = document.querySelectorAll('.modal');
    existingModals.forEach(m => m.remove());

    const modal = document.createElement('div');
    modal.className = 'modal';

    // Calculer les totaux
    const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const shipping = calculateShipping(subtotal);
    const tax = calculateTax(subtotal);
    const total = subtotal + shipping + tax;

    console.log('Totals:', { subtotal, shipping, tax, total });

    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border-radius: var(--radius-lg) var(--radius-lg) 0 0;">
                <h2><i class="fas fa-shopping-cart"></i> Confirm Your Order</h2>
                <button class="modal-close" style="color: white; background: rgba(255,255,255,0.2);">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 2rem;">
                <!-- Order Items -->
                <div class="order-summary" style="margin-bottom: 2rem;">
                    <h3 style="color: var(--text-dark); margin-bottom: 1rem; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem;">
                        <i class="fas fa-list"></i> Order Items (${cartItems.length})
                    </h3>

                   // Dans la section o vous affichez les items dans showOrderConfirmationModal
${cartItems.map((item, index) => `
    <div class="order-item-summary" style="...">
        <div class="item-info" style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                ${item.cropImageUrl || item.imageUrl ? `...` : ''}
                <div style="flex: 1;">
                    <strong style="display: block; color: var(--text-dark); font-size: 1.1rem; margin-bottom: 0.25rem;">
                        ${item.cropName}
                    </strong>
                    <span style="color: var(--text-light); font-size: 0.9rem;">
                        <i class="fas fa-weight"></i> ${item.quantity} kg  ${formatCurrency(item.price)}/kg
                    </span>
                    <!--  AFFICHER LE NOM DU FERMIER -->
                    <span style="display: block; color: var(--success-color); font-size: 0.85rem; margin-top: 0.25rem; font-weight: 600;">
                        <i class="fas fa-user"></i> ${item.farmerName || 'Farmer Info Unavailable'}
                    </span>
                </div>
            </div>
        </div>
        <div class="item-total" style="...">
            ${formatCurrency(item.price * item.quantity)}
        </div>
    </div>
`).join('')}

                <!-- Order Totals -->
                <div class="order-totals" style="background: var(--light-gray); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                    <div class="total-row" style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding: 0.5rem 0; font-size: 1rem;">
                        <span style="color: var(--text-light);">Subtotal:</span>
                        <span style="font-weight: 600; color: var(--text-dark);">${formatCurrency(subtotal)}</span>
                    </div>
                    <div class="total-row" style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding: 0.5rem 0; font-size: 1rem;">
                        <span style="color: var(--text-light);">Shipping Fee:</span>
                        <span style="font-weight: 600; color: var(--text-dark);">${formatCurrency(shipping)}</span>
                    </div>
                    <div class="total-row" style="display: flex; justify-content: space-between; margin-bottom: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); font-size: 1rem;">
                        <span style="color: var(--text-light);">Tax (18%):</span>
                        <span style="font-weight: 600; color: var(--text-dark);">${formatCurrency(tax)}</span>
                    </div>
                    <div class="total-row final-total" style="display: flex; justify-content: space-between; padding: 1rem 0; margin-top: 1rem; border-top: 3px solid var(--primary-color);">
                        <span style="font-size: 1.3rem; font-weight: bold; color: var(--text-dark);">
                            <i class="fas fa-receipt"></i> Total:
                        </span>
                        <span style="font-size: 1.8rem; font-weight: bold; color: var(--primary-color);">
                            ${formatCurrency(total)}
                        </span>
                    </div>
                </div>

                <!-- Delivery Information -->
                <div class="delivery-info" style="padding: 1.5rem; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: var(--radius-md); border-left: 4px solid var(--success-color); margin-bottom: 1rem;">
                    <h4 style="color: var(--success-color); margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-truck"></i> Delivery Information
                    </h4>
                    <p style="margin-bottom: 0.5rem; color: var(--text-dark);">
                        <strong><i class="fas fa-map-marker-alt"></i> Delivery Address:</strong><br>
                        <span style="margin-left: 1.5rem;">${currentUser.address || 'To be confirmed during checkout'}</span>
                    </p>
                    <p style="margin: 0; color: var(--text-dark);">
                        <strong><i class="fas fa-calendar-check"></i> Expected Delivery:</strong><br>
                        <span style="margin-left: 1.5rem;">Within 5-7 business days</span>
                    </p>
                </div>

                <!-- Payment Information -->
                <div style="padding: 1rem; background: #fff3cd; border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
                    <p style="margin: 0; color: #856404; font-size: 0.95rem; line-height: 1.6;">
                        <i class="fas fa-info-circle"></i>
                        <strong>Payment Method:</strong> Cash on Delivery (COD)<br>
                        <span style="margin-left: 1.5rem;">You will pay when your order is delivered.</span>
                    </p>
                </div>
            </div>

            <div class="modal-footer" style="background: var(--light-gray); display: flex; gap: 1rem; justify-content: flex-end; padding: 1.5rem; border-radius: 0 0 var(--radius-lg) var(--radius-lg);">
                <button class="btn btn-secondary modal-cancel" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary modal-confirm" style="padding: 0.75rem 2rem; font-size: 1.1rem; box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);">
                    <i class="fas fa-check-circle"></i> Confirm Order (${formatCurrency(total)})
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Show modal with animation
    setTimeout(() => {
        modal.classList.add('show');
        console.log('Modal displayed');
    }, 10);

    // Event listeners for modal
    const closeBtn = modal.querySelector('.modal-close');
    const cancelBtn = modal.querySelector('.modal-cancel');
    const confirmBtn = modal.querySelector('.modal-confirm');

    closeBtn.addEventListener('click', () => {
        console.log('Close button clicked');
        modal.remove();
    });

    cancelBtn.addEventListener('click', () => {
        console.log('Cancel button clicked');
        modal.remove();
    });

    confirmBtn.addEventListener('click', async () => {
        console.log('Confirm button clicked');
        await confirmOrder(confirmBtn, modal);
    });

    // Close on outside click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            console.log('Outside click');
            modal.remove();
        }
    });

    // Close on Escape key
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            console.log('Escape key pressed');
            modal.remove();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
}

// ==================== CONFIRM ORDER ====================

async function confirmOrder(confirmBtn, modal) {
    console.log('=== CONFIRMING ORDER ===');

    if (!confirmBtn) {
        console.error('Confirm button not found');
        return;
    }

    try {
        // Disable button and show loading
        confirmBtn.disabled = true;
        const originalHTML = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Order...';

        console.log('Calling handleCheckout...');

        // Call checkout function
        await handleCheckout();

        console.log('Checkout successful');

        // Close modal on success
        if (modal) {
            modal.remove();
        }

    } catch (error) {
        console.error('Order confirmation error:', error);

        // Re-enable button on error
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Order';
        }

        showNotification('Failed to place order. Please try again.', 'error');
    }
}

// Make functions globally available
window.showOrderConfirmationModal = showOrderConfirmationModal;
window.confirmOrder = confirmOrder;

console.log(' Order confirmation functions loaded');

// ==================== ERROR HANDLING ====================

async function handleAPIError(error, context) {
    console.error(`API Error in ${context}:`, error);

    if (error.message.includes('401') || error.message.includes('Authentication')) {
        handleUnauthorized();
        return;
    }

    if (error.message.includes('404')) {
        showNotification('Resource not found. Please try again.', 'error');
        return;
    }

    if (error.message.includes('500')) {
        showNotification('Server error. Please try again later.', 'error');
        return;
    }

    showNotification(`Error: ${error.message}`, 'error');
}



async function handleCheckout() {
    if (shoppingCart.length === 0) {
        showNotification('Your cart is empty', 'warning');
        return;
    }

    if (!currentUser || !currentUser.id) {
        showNotification('Please login to complete your order', 'error');
        return;
    }

    //  IMPROVED VALIDATION - More lenient
    const invalidItems = [];
    const validItems = [];

    shoppingCart.forEach((item, index) => {
        const errors = [];

        // Essential validations only
        if (!item.cropId) {
            errors.push('Missing crop ID');
        }
        if (!item.farmerId) {
            errors.push('Missing farmer ID');
        }
        if ((!item.pricePerKg || item.pricePerKg === 0) && (!item.price || item.price === 0)) {
            errors.push('Missing price');
        }

        if (errors.length > 0) {
            invalidItems.push({
                index: index,
                item: item,
                errors: errors
            });
        } else {
            validItems.push(item);
        }
    });

    //  FIX: Only proceed with valid items
    if (validItems.length === 0) {
        console.error(' NO VALID ITEMS:', invalidItems);
        showNotification('No valid items to checkout. Please check cart items.', 'error');
        return;
    }

    try {
        showNotification(`Processing ${validItems.length} item(s)...`, 'info');

        const transactionPromises = validItems.map(async (item) => {
            const deliveryDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
            const formattedDeliveryDate = deliveryDate.toISOString().split('T')[0];

            // Get farmer details if not already available
            let farmerName = item.farmerName;
            if (!farmerName || farmerName === 'Unknown Farmer') {
                try {
                    const farmerResponse = await apiCall(`${API_BASE_URL}/users/${item.farmerId}`);
                    const farmer = farmerResponse.data || farmerResponse;
                    farmerName = farmer.fullName || farmer.username || 'Farmer';
                } catch (error) {
                    console.warn('Could not fetch farmer details:', error);
                    farmerName = 'Farmer';
                }
            }

            // Get crop details if not already available
            let cropName = item.cropName;
            if (!cropName || cropName === 'Unknown Crop') {
                try {
                    const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${item.cropId}`);
                    const crop = cropResponse.data || cropResponse;
                    cropName = crop.cropName || 'Product';
                } catch (error) {
                    console.warn('Could not fetch crop details:', error);
                    cropName = 'Product';
                }
            }

            const priceToUse = item.pricePerKg || item.price || 1000;

            const transactionData = {
                transactionCode: generateTransactionCode(),
                buyerId: currentUser.id,
                farmerId: item.farmerId,
                cropId: item.cropId,
                cropProductionId: item.productionId,
                quantity: item.quantity,
                pricePerUnit: priceToUse,
                totalAmount: priceToUse * item.quantity,
                transactionStatus: 'PENDING',
                paymentStatus: 'PENDING',
                paymentMethod: 'CASH',
                deliveryLocation: item.location || 'To be confirmed',
                deliveryDate: formattedDeliveryDate,
                qualityGrade: item.qualityGrade || 'STANDARD',
                packaging: item.packaging || 'BAG',
                notes: `Order for ${cropName} from ${farmerName}`
            };

            console.log('Creating transaction:', transactionData);

            return await apiCall(`${API_BASE_URL}/transactions`, {
                method: 'POST',
                body: JSON.stringify(transactionData)
            });
        });

        const createdTransactions = await Promise.all(transactionPromises);

        //  Clear only successful items from cart
        shoppingCart = shoppingCart.filter((item, index) =>
            !validItems.some(validItem => validItem === item)
        );

        saveCartToStorage();
        updateCartBadge();
        updateCartDisplay();

        showNotification(` ${createdTransactions.length} order(s) placed successfully!`, 'success');

        // Refresh orders data
        setTimeout(() => {
            setActiveSection('orders');
            loadOrdersData();
        }, 2000);

    } catch (error) {
        console.error('Checkout error:', error);
        showNotification(` Order failed: ${error.message}`, 'error');
    }
}











function generateTransactionCode() {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substring(2, 8);
    return `TXN-${timestamp}-${random}`.toUpperCase();
}

// Make functions globally available
window.addToCart = addToCart;
window.addMarketPriceToCart = addMarketPriceToCart;
window.addCropProductionToCart = addCropProductionToCart;
window.updateCartQuantity = updateCartQuantity;
window.removeFromCart = removeFromCart;
window.handleCheckout = handleCheckout;
window.updateCartDisplay = updateCartDisplay;

console.log(' Shopping cart functions loaded successfully');



  // ==================== ORDERS SECTION ====================

  async function loadOrdersData(status = 'all') {
      try {
          let orders;

          if (status === 'all') {
              const response = await apiCall(
                  `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=50&sortBy=createdAt&sortDir=desc`
              );
              orders = response.content || response;
          } else {
              orders = await apiCall(
                  ENDPOINTS.transactionsByBuyerAndStatus(currentUser.id, status.toUpperCase())
              );
          }

          displayOrders(orders);

      } catch (error) {
          console.error('Error loading orders:', error);
      }
  }




function displayOrders(orders) {
    const ordersList = document.getElementById('ordersList');
    if (!ordersList) return;

    if (!orders || orders.length === 0) {
        ordersList.innerHTML = `
            <div class="empty-state" style="text-align: center; padding: 4rem 2rem; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
                <i class="fas fa-inbox" style="font-size: 5rem; color: var(--text-light); margin-bottom: 1.5rem; opacity: 0.3;"></i>
                <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-dark);">No orders found</h3>
                <p style="color: var(--text-light); margin-bottom: 2rem;">Start shopping to see your orders here</p>
                <button class="btn btn-primary" onclick="setActiveSection('marketplace')" style="padding: 0.75rem 2rem;">
                    <i class="fas fa-store"></i> Browse Marketplace
                </button>
            </div>
        `;
        return;
    }

    ordersList.innerHTML = orders.map(order => `
        <div class="order-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden; margin-bottom: var(--spacing-lg); border: 1px solid var(--border-color); transition: all 0.2s ease;">
            <!-- Order Header -->
            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 1.25rem 1.5rem; border-bottom: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 250px;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(46, 204, 113, 0.2);">
                        <i class="fas fa-receipt" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.25rem; font-weight: 600;">
                            Order ID
                        </div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-dark); font-family: 'Courier New', monospace;">
                            ${order.transactionCode}
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="text-align: right;">
                        <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.5px;">
                            Order Status
                        </div>
                        <span class="status-badge status-${order.transactionStatus?.toLowerCase() || 'pending'}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.85rem; font-weight: 700;">
                            <i class="fas fa-${getStatusIcon(order.transactionStatus)}" style="font-size: 0.9rem;"></i>
                            ${order.transactionStatus || 'PENDING'}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Order Body - Grid Layout -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0; border-bottom: 1px solid var(--border-color);">
                <!-- Order Date -->
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: white;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="width: 40px; height: 40px; background: #e8f5e9; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-calendar-alt" style="color: var(--success-color); font-size: 1.1rem;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Order Date
                            </div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem;">
                                ${formatDate(order.createdAt)}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Farmer Info -->
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: #fafafa;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="width: 40px; height: 40px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary-color); font-weight: 700; color: var(--primary-dark);">
                            ${(order.farmerName || 'F').charAt(0).toUpperCase()}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Farmer
                            </div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${order.farmerName || 'Unknown Farmer'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Info -->
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: white;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="width: 40px; height: 40px; background: #fff3e0; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-seedling" style="color: var(--warning-color); font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Product
                            </div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${order.cropName || 'N/A'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quantity -->
                <div style="padding: 1.25rem 1.5rem; background: #fafafa;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="width: 40px; height: 40px; background: #e3f2fd; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-weight-hanging" style="color: var(--info-color); font-size: 1.1rem;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Quantity
                            </div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--info-color); margin-top: 0.15rem;">
                                ${order.quantity} kg
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delivery & Payment Info -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; border-bottom: 1px solid var(--border-color);">
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: white;">
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #f3e5f5; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-map-marker-alt" style="color: var(--chart-purple); font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600; margin-bottom: 0.5rem;">
                                Delivery Location
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-dark); line-height: 1.4;">
                                ${order.deliveryLocation || 'To be confirmed'}
                            </div>
                        </div>
                    </div>
                </div>

                <div style="padding: 1.25rem 1.5rem; background: #fafafa;">
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #fce4ec; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-calendar-check" style="color: var(--chart-red); font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600; margin-bottom: 0.5rem;">
                                Expected Delivery
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-dark); line-height: 1.4;">
                                ${formatDate(order.deliveryDate)}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Amount & Payment Status -->
            <div style="background: linear-gradient(135deg, #f8f9fa, #ffffff); padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; border-bottom: 2px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--success-color), #1e8449); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(39, 174, 96, 0.2);">
                        <i class="fas fa-dollar-sign" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.25rem; font-weight: 600;">
                            Total Amount
                        </div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: var(--success-color);">
                            ${formatCurrency(order.totalAmount)}
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
                        Payment Status
                    </div>
                    <span class="status-badge status-${order.paymentStatus?.toLowerCase() || 'pending'}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.85rem;">
                        <i class="fas fa-${order.paymentStatus === 'PAID' ? 'check-circle' : 'clock'}"></i>
                        ${order.paymentStatus || 'PENDING'}
                    </span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="padding: 1.25rem 1.5rem; background: white; display: flex; gap: 0.75rem; justify-content: flex-end; flex-wrap: wrap;">
                <button class="btn btn-secondary btn-sm" onclick="viewOrderDetails('${order.id}')" style="padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); font-weight: 600; transition: all 0.2s;">
                    <i class="fas fa-eye"></i>
                    View Details
                </button>
                <button class="btn btn-primary btn-sm" onclick="trackOrder('${order.id}')" style="padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); font-weight: 600; box-shadow: 0 2px 4px rgba(46, 204, 113, 0.2); transition: all 0.2s;">
                    <i class="fas fa-truck"></i>
                    Track Order
                </button>
                ${order.transactionStatus === 'PENDING' ? `
                    <button class="btn btn-sm" onclick="cancelOrder('${order.id}')" style="background: var(--danger-color); color: white; padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); border: none; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-times-circle"></i>
                        Cancel Order
                    </button>
                ` : ''}
                ${order.transactionStatus === 'DELIVERED' ? `
                    <button class="btn btn-sm" onclick="leaveReview('${order.id}')" style="background: var(--warning-color); color: white; padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); border: none; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-star"></i>
                        Leave Review
                    </button>
                ` : ''}
            </div>
        </div>
    `).join('');
}

// Helper function for status icons (add if not exists)
function getStatusIcon(status) {
    const icons = {
        'PENDING': 'clock',
        'CONFIRMED': 'check',
        'PROCESSING': 'cog',
        'SHIPPED': 'truck',
        'DELIVERED': 'check-circle',
        'CANCELLED': 'times-circle',
        'COMPLETED': 'check-double'
    };
    return icons[status?.toUpperCase()] || 'clock';
}

  async function searchOrders(query) {
      try {
          const response = await apiCall(
              `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=100`
          );
          const allOrders = response.content || response;

          const filtered = allOrders.filter(order =>
              order.transactionCode?.toLowerCase().includes(query.toLowerCase()) ||
              order.cropName?.toLowerCase().includes(query.toLowerCase()) ||
              order.farmerName?.toLowerCase().includes(query.toLowerCase())
          );

          displayOrders(filtered);
      } catch (error) {
          console.error('Error searching orders:', error);
      }
  }

  async function viewOrderDetails(orderId) {
      try {
          const order = await apiCall(ENDPOINTS.transactionById(orderId));
          showOrderDetailsModal(order);
      } catch (error) {
          console.error('Error loading order details:', error);
          showNotification('Failed to load order details', 'error');
      }
  }

function showOrderDetailsModal(order) {
    // Remove any existing modals
    const existingModals = document.querySelectorAll('.modal');
    existingModals.forEach(m => m.remove());

    // Create and show modal with order details
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; padding: 1.5rem 2rem; border-radius: var(--radius-lg) var(--radius-lg) 0 0; position: relative;">
                <div>
                    <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">
                        <i class="fas fa-receipt"></i> Order Details
                    </h2>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">
                        ${order.transactionCode || 'N/A'}
                    </p>
                </div>
                <button class="modal-close" onclick="this.closest('.modal').remove()"
                        style="position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; transition: all 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body" style="padding: 0;">
                <!-- Farmer & Product Info Section -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; border-bottom: 2px solid var(--border-color);">
                    <!-- Farmer Info -->
                    <div style="padding: 1.5rem; border-right: 1px solid var(--border-color); background: linear-gradient(135deg, #f8f9fa, #ffffff);">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 700; color: var(--primary-dark); border: 3px solid var(--primary-color);">
                                ${(order.farmerName || order.farmer?.fullName || 'F').charAt(0).toUpperCase()}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">
                                    <i class="fas fa-user"></i> Farmer
                                </div>
                                <div style="font-weight: 700; color: var(--text-dark); font-size: 1.1rem;">
                                    ${order.farmerName || order.farmer?.fullName || order.farmer?.username || 'Unknown Farmer'}
                                </div>
                                ${order.farmer?.phoneNumber ? `
                                    <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">
                                        <i class="fas fa-phone"></i> ${order.farmer.phoneNumber}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Product Info -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, #ffffff, #f8f9fa);">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            ${order.cropImageUrl || order.crop?.imageUrl ? `
                                <img src="${order.cropImageUrl || order.crop?.imageUrl}"
                                     style="width: 50px; height: 50px; border-radius: var(--radius-md); object-fit: cover; border: 3px solid var(--primary-color);"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div style="display: none; width: 50px; height: 50px; background: var(--primary-light); border-radius: var(--radius-md); align-items: center; justify-content: center; border: 3px solid var(--primary-color);">
                                    <i class="fas fa-seedling" style="font-size: 1.5rem; color: var(--primary-color);"></i>
                                </div>
                            ` : `
                                <div style="width: 50px; height: 50px; background: var(--primary-light); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; border: 3px solid var(--primary-color);">
                                    <i class="fas fa-seedling" style="font-size: 1.5rem; color: var(--primary-color);"></i>
                                </div>
                            `}
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">
                                    <i class="fas fa-seedling"></i> Product
                                </div>
                                <div style="font-weight: 700; color: var(--text-dark); font-size: 1.1rem;">
                                    ${order.cropName || order.crop?.cropName || order.productName || 'Unknown Product'}
                                </div>
                                ${order.cropType || order.crop?.cropType ? `
                                    <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">
                                        <i class="fas fa-tag"></i> ${order.cropType || order.crop?.cropType}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Details Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; padding: 1.5rem 0;">
                    ${[
                        { icon: 'weight', label: 'Quantity', value: `${order.quantity} kg` },
                        { icon: 'dollar-sign', label: 'Price per Unit', value: formatCurrency(order.pricePerUnit) + '/kg' },
                        { icon: 'receipt', label: 'Total Amount', value: formatCurrency(order.totalAmount), highlight: true },
                        { icon: 'credit-card', label: 'Payment Method', value: order.paymentMethod || 'N/A' },
                        { icon: 'info-circle', label: 'Payment Status', value: `<span class="status-badge status-${order.paymentStatus?.toLowerCase() || 'pending'}">${order.paymentStatus || 'PENDING'}</span>`, raw: true },
                        { icon: 'clipboard-check', label: 'Order Status', value: `<span class="status-badge status-${order.transactionStatus?.toLowerCase() || 'pending'}">${order.transactionStatus || 'PENDING'}</span>`, raw: true },
                        { icon: 'map-marker-alt', label: 'Delivery Location', value: order.deliveryLocation || 'To be confirmed' },
                        { icon: 'calendar-check', label: 'Expected Delivery', value: formatDate(order.deliveryDate) },
                        { icon: 'calendar', label: 'Order Date', value: formatDate(order.createdAt) },
                        { icon: 'truck', label: 'Delivery Date', value: order.actualDeliveryDate ? formatDate(order.actualDeliveryDate) : 'Pending' }
                    ].map((item, index) => `
                        <div style="padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); ${index % 2 === 0 ? 'border-right: 1px solid var(--border-color);' : ''} ${index < 2 ? 'background: var(--light-gray);' : ''}">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 35px; height: 35px; background: ${item.highlight ? 'var(--primary-color)' : 'var(--primary-light)'}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas fa-${item.icon}" style="color: ${item.highlight ? 'white' : 'var(--primary-color)'};"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 0.25rem;">
                                        ${item.label}
                                    </div>
                                    <div style="font-weight: ${item.highlight ? '700' : '600'}; color: ${item.highlight ? 'var(--primary-color)' : 'var(--text-dark)'}; font-size: ${item.highlight ? '1.2rem' : '1rem'}; word-break: break-word;">
                                        ${item.raw ? item.value : `<span>${item.value}</span>`}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- Notes Section (if exists) -->
                ${order.notes ? `
                    <div style="padding: 1.5rem 2rem; background: var(--light-gray); border-top: 2px solid var(--border-color);">
                        <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                            <div style="width: 35px; height: 35px; background: var(--info-color); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-sticky-note" style="color: white;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 0.5rem;">
                                    <i class="fas fa-info-circle"></i> Notes
                                </div>
                                <div style="color: var(--text-dark); line-height: 1.6;">
                                    ${order.notes}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            </div>

            <div class="modal-footer" style="padding: 1.5rem 2rem; background: var(--light-gray); border-radius: 0 0 var(--radius-lg) var(--radius-lg); display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="padding: 0.75rem 1.5rem;">
                    <i class="fas fa-times"></i> Close
                </button>
                <button class="btn btn-primary" onclick="trackOrder('${order.id}'); this.closest('.modal').remove();" style="padding: 0.75rem 1.5rem;">
                    <i class="fas fa-truck"></i> Track Order
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);

    // Close on outside click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });

    // Close on Escape key
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
}

  async function cancelOrder(orderId) {
      if (!confirm('Are you sure you want to cancel this order?')) {
          return;
      }

      try {
          await apiCall(`${ENDPOINTS.transactionById(orderId)}/cancel`, {
              method: 'PUT',
              body: JSON.stringify({ reason: 'Cancelled by buyer' })
          });

          showNotification('Order cancelled successfully', 'success');
          await loadOrdersData();

      } catch (error) {
          console.error('Error cancelling order:', error);
          showNotification('Failed to cancel order', 'error');
      }
  }









  // ==================== TRANSACTIONS SECTION ====================

  async function loadTransactionsData() {
      try {
          const response = await apiCall(
              `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=100&sortBy=createdAt&sortDir=desc`
          );

          const transactions = response.content || response;
          displayTransactions(transactions);

      } catch (error) {
          console.error('Error loading transactions:', error);
      }
  }

function displayTransactions(transactions) {
    const transactionsList = document.getElementById('transactionsList');
    if (!transactionsList) return;

    if (!transactions || transactions.length === 0) {
        transactionsList.innerHTML = `
            <div class="empty-state" style="text-align: center; padding: 4rem 2rem; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
                <i class="fas fa-receipt" style="font-size: 5rem; color: var(--text-light); margin-bottom: 1.5rem; opacity: 0.3;"></i>
                <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-dark);">No transactions found</h3>
                <p style="color: var(--text-light); margin-bottom: 2rem;">Your transaction history will appear here</p>
            </div>
        `;
        return;
    }

    // Calculate statistics
    const completed = transactions.filter(t => t.paymentStatus === 'COMPLETED' || t.paymentStatus === 'PAID').length;
    const pending = transactions.filter(t => t.paymentStatus === 'PENDING').length;
    const totalVolume = transactions.reduce((sum, t) => sum + (t.totalAmount || 0), 0);

    // Update stat cards
    document.getElementById('completedTransactions').textContent = completed;
    document.getElementById('pendingTransactions').textContent = pending;
    document.getElementById('totalTransactionVolume').textContent = formatCurrency(totalVolume);

    transactionsList.innerHTML = transactions.map((txn, index) => `
        <div class="transaction-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden; margin-bottom: 1rem; border: 1px solid var(--border-color); transition: all 0.2s ease;">

            <!-- Transaction Header -->
            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 1.25rem 1.5rem; border-bottom: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 250px;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--info-color), #1e5a8e); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(52, 152, 219, 0.2);">
                        <i class="fas fa-receipt" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.25rem; font-weight: 600;">
                            Transaction ID
                        </div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-dark); font-family: 'Courier New', monospace;">
                            ${txn.transactionCode}
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="text-align: right;">
                        <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.5px;">
                            Payment Status
                        </div>
                        <span class="status-badge status-${txn.paymentStatus?.toLowerCase() || 'pending'}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.85rem; font-weight: 700;">
                            <i class="fas fa-${txn.paymentStatus === 'COMPLETED' || txn.paymentStatus === 'PAID' ? 'check-circle' : txn.paymentStatus === 'FAILED' ? 'times-circle' : 'clock'}"></i>
                            ${txn.paymentStatus || 'PENDING'}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Transaction Body - Grid Layout -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0; border-bottom: 1px solid var(--border-color);">

                <!-- Date & Time -->
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: white;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #e8f5e9; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-calendar-alt" style="color: var(--success-color); font-size: 1.1rem;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Transaction Date
                            </div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem;">
                                ${formatDateTime(txn.createdAt)}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Reference -->
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: #fafafa;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #fff3e0; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-shopping-cart" style="color: var(--warning-color); font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Order ID
                            </div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${txn.id}">
                                ${txn.id.substring(0, 12)}...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Description -->
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: white;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #e3f2fd; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-seedling" style="color: var(--info-color); font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Product
                            </div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${txn.cropName || 'N/A'}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.15rem;">
                                ${txn.quantity || 0} kg
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div style="padding: 1.25rem 1.5rem; background: #fafafa;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #f3e5f5; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-credit-card" style="color: var(--chart-purple); font-size: 1.1rem;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Payment Method
                            </div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem;">
                                ${txn.paymentMethod || 'N/A'}
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Amount & Actions -->
            <div style="background: linear-gradient(135deg, #f8f9fa, #ffffff); padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--success-color), #1e8449); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(39, 174, 96, 0.2);">
                        <i class="fas fa-dollar-sign" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.25rem; font-weight: 600;">
                            Amount
                        </div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: var(--success-color);">
                            ${formatCurrency(txn.totalAmount)}
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary btn-sm" onclick="viewTransactionDetails('${txn.id}')" style="padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); font-weight: 600; transition: all 0.2s;">
                        <i class="fas fa-eye"></i>
                        View Details
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadInvoice('${txn.id}')" style="padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); font-weight: 600; box-shadow: 0 2px 4px rgba(46, 204, 113, 0.2); transition: all 0.2s;">
                        <i class="fas fa-download"></i>
                        Invoice
                    </button>
                </div>
            </div>

        </div>
    `).join('');
}

  async function viewTransactionDetails(transactionId) {
      await viewOrderDetails(transactionId);
  }

  function downloadInvoice(transactionId) {
      showNotification('Invoice download feature coming soon', 'info');
  }





async function loadTrackingData() {
    try {
        console.log('=== LOADING TRACKING DATA ===');

        // Get all buyer transactions
        const response = await apiCall(
            `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=50`
        );

        const orders = response.content || response;
        console.log('Orders loaded:', orders.length);

        //  FIX: Get supply chain info for each order with proper error handling
        const trackingPromises = orders.map(async order => {
            try {
                //  OLD CODE (causes 404):
                // const supplyChain = await apiCall(ENDPOINTS.supplyChainByTransaction(order.id));

                //  NEW CODE: Use crop production ID to get supply chain
                if (order.cropProductionId) {
                    try {
                        const supplyChainList = await apiCall(
                            `${API_BASE_URL}/supply-chain/crop-production/${order.cropProductionId}`
                        );

                        // Get the latest/active stage
                        const latestStage = Array.isArray(supplyChainList) && supplyChainList.length > 0
                            ? supplyChainList.reduce((latest, current) => {
                                return new Date(current.stageStartDate) > new Date(latest.stageStartDate)
                                    ? current : latest;
                            })
                            : null;

                        return { order, supplyChain: latestStage };
                    } catch (error) {
                        console.warn(`No supply chain found for production ${order.cropProductionId}`);
                        return { order, supplyChain: null };
                    }
                } else {
                    console.warn(`Order ${order.transactionCode} has no cropProductionId`);
                    return { order, supplyChain: null };
                }
            } catch (error) {
                console.error(`Error loading tracking for order ${order.transactionCode}:`, error);
                return { order, supplyChain: null };
            }
        });

        const trackingData = await Promise.all(trackingPromises);
        console.log('Tracking data loaded:', trackingData.length);

        displayTrackingInfo(trackingData);

    } catch (error) {
        console.error('=== ERROR LOADING TRACKING DATA ===', error);
        showNotification('Failed to load tracking information', 'error');
    }
}




function displayTrackingInfo(trackingData) {
    const trackingList = document.getElementById('trackingList');
    if (!trackingList) return;

    if (!trackingData || trackingData.length === 0) {
        trackingList.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                <i class="fas fa-truck" style="font-size: 4rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                <h3>No deliveries to track</h3>
                <p style="color: var(--text-light);">Your orders will appear here once they are being processed</p>
            </div>
        `;
        return;
    }

    trackingList.innerHTML = trackingData.map(({ order, supplyChain }) => {
        // Determine current stage
        const currentStage = supplyChain ? supplyChain.stage : 'PENDING';
        const stages = ['HARVESTED', 'PROCESSED', 'IN_TRANSIT', 'DELIVERED'];
        const currentStageIndex = stages.indexOf(currentStage);

        return `
            <div class="tracking-card" style="background: white; border-radius: var(--radius-lg); padding: var(--spacing-lg); box-shadow: var(--shadow-sm); margin-bottom: var(--spacing-md);">
                <div class="tracking-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg); padding-bottom: var(--spacing-md); border-bottom: 2px solid var(--border-color);">
                    <div>
                        <h3 style="margin: 0; color: var(--text-dark); font-size: 1.2rem;">
                            <i class="fas fa-box"></i> ${order.transactionCode}
                        </h3>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-light); font-size: 0.9rem;">
                            Order placed on ${formatDate(order.createdAt)}
                        </p>
                    </div>
                    <span class="status-badge status-${order.transactionStatus?.toLowerCase()}" style="padding: 0.5rem 1rem; border-radius: var(--radius-md); font-weight: 600;">
                        ${order.transactionStatus || 'PENDING'}
                    </span>
                </div>

                <div class="tracking-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                    <!-- Order Information -->
                    <div class="tracking-info" style="background: var(--light-gray); padding: var(--spacing-md); border-radius: var(--radius-md);">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-dark); font-size: 1rem;">
                            <i class="fas fa-info-circle"></i> Order Details
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <p style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-seedling" style="width: 20px; color: var(--primary-color);"></i>
                                <strong>Product:</strong> ${order.cropName || 'N/A'}
                            </p>
                            <p style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-weight" style="width: 20px; color: var(--primary-color);"></i>
                                <strong>Quantity:</strong> ${order.quantity} kg
                            </p>
                            <p style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-calendar" style="width: 20px; color: var(--primary-color);"></i>
                                <strong>Expected:</strong> ${formatDate(order.deliveryDate)}
                            </p>
                            <p style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-map-marker-alt" style="width: 20px; color: var(--primary-color);"></i>
                                <strong>Location:</strong> ${order.deliveryLocation || 'N/A'}
                            </p>
                            ${supplyChain && supplyChain.currentLocation ? `
                                <p style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-location-arrow" style="width: 20px; color: var(--success-color);"></i>
                                    <strong>Current:</strong> ${supplyChain.currentLocation}
                                </p>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Tracking Timeline -->
                    <div class="tracking-timeline">
                        ${supplyChain ? `
                            <div class="timeline" style="position: relative; padding-left: 2rem;">
                                ${stages.map((stage, index) => {
                                    const isCompleted = index <= currentStageIndex;
                                    const isCurrent = stage === currentStage;
                                    const iconMap = {
                                        'HARVESTED': 'fa-seedling',
                                        'PROCESSED': 'fa-cogs',
                                        'IN_TRANSIT': 'fa-truck',
                                        'DELIVERED': 'fa-check-circle'
                                    };
                                    const labelMap = {
                                        'HARVESTED': 'Harvested',
                                        'PROCESSED': 'Processed',
                                        'IN_TRANSIT': 'In Transit',
                                        'DELIVERED': 'Delivered'
                                    };

                                    return `
                                        <div class="timeline-item" style="position: relative; padding-bottom: 2rem;">
                                            <div class="timeline-icon" style="position: absolute; left: -2rem; width: 40px; height: 40px; background: ${isCompleted ? 'var(--success-color)' : 'var(--gray)'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; ${isCurrent ? 'box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.2); animation: pulse 2s infinite;' : ''}">
                                                <i class="fas ${iconMap[stage]}"></i>
                                            </div>
                                            <div class="timeline-content" style="padding-left: 1rem;">
                                                <h4 style="margin: 0 0 0.25rem 0; color: ${isCompleted ? 'var(--text-dark)' : 'var(--text-light)'}; font-size: 1rem;">
                                                    ${labelMap[stage]}
                                                    ${isCurrent ? '<span style="color: var(--success-color); font-weight: 600; margin-left: 0.5rem;"> Current</span>' : ''}
                                                </h4>
                                                <p style="margin: 0; color: var(--text-light); font-size: 0.85rem;">
                                                    ${isCompleted && supplyChain.stageStartDate
                                                        ? formatDateTime(supplyChain.stageStartDate)
                                                        : 'Pending'}
                                                </p>
                                            </div>
                                            ${index < stages.length - 1 ? `
                                                <div style="position: absolute; left: -1.25rem; top: 40px; width: 2px; height: calc(100% - 40px); background: ${isCompleted ? 'var(--success-color)' : 'var(--gray)'};"></div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div style="padding: 2rem; text-align: center; background: var(--light-gray); border-radius: var(--radius-md);">
                                <i class="fas fa-clock" style="font-size: 2rem; color: var(--text-light); margin-bottom: 0.5rem;"></i>
                                <p style="margin: 0; color: var(--text-light);">Tracking information not available yet</p>
                                <p style="margin: 0.5rem 0 0 0; color: var(--text-light); font-size: 0.85rem;">Order is being prepared</p>
                            </div>
                        `}
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end;">
                    <button class="btn btn-secondary btn-sm" onclick="viewOrderDetails('${order.id}')" style="padding: 0.5rem 1rem;">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                    ${supplyChain && supplyChain.trackingCode ? `
                        <button class="btn btn-primary btn-sm" onclick="showTrackingDetails('${supplyChain.trackingCode}')" style="padding: 0.5rem 1rem;">
                            <i class="fas fa-map-marked-alt"></i> Full Tracking
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

//  NEW FUNCTION: Show detailed tracking information
async function showTrackingDetails(trackingCode) {
    try {
        const supplyChain = await apiCall(`${API_BASE_URL}/supply-chain/track/${trackingCode}`);

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content large">
                <div class="modal-header">
                    <h2><i class="fas fa-map-marked-alt"></i> Tracking Details</h2>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="tracking-details">
                        <div class="detail-item">
                            <span class="label">Tracking Code:</span>
                            <span class="value">${supplyChain.trackingCode}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Current Stage:</span>
                            <span class="value">${supplyChain.stage}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Current Location:</span>
                            <span class="value">${supplyChain.currentLocation || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Responsible Party:</span>
                            <span class="value">${supplyChain.responsibleParty || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Quality Status:</span>
                            <span class="value">${supplyChain.qualityStatus || 'N/A'}</span>
                        </div>
                        ${supplyChain.estimatedArrivalTime ? `
                            <div class="detail-item">
                                <span class="label">Estimated Arrival:</span>
                                <span class="value">${formatDateTime(supplyChain.estimatedArrivalTime)}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);

    } catch (error) {
        console.error('Error loading tracking details:', error);
        showNotification('Failed to load tracking details', 'error');
    }
}


//  IMPROVED trackOrder function
async function trackOrder(orderId) {
    try {
        const order = await apiCall(ENDPOINTS.transactionById(orderId));

        let supplyChain = null;
        if (order.cropProductionId) {
            try {
                const supplyChainList = await apiCall(
                    `${API_BASE_URL}/supply-chain/crop-production/${order.cropProductionId}`
                );

                supplyChain = Array.isArray(supplyChainList) && supplyChainList.length > 0
                    ? supplyChainList.reduce((latest, current) => {
                        return new Date(current.stageStartDate) > new Date(latest.stageStartDate)
                            ? current : latest;
                    })
                    : null;
            } catch {
                // Supply chain info might not exist yet
                console.warn('No supply chain data found for this order');
            }
        }

        displayTrackingInfo([{ order, supplyChain }]);
        setActiveSection('tracking');

    } catch (error) {
        console.error('Error tracking order:', error);
        showNotification('Failed to load tracking information', 'error');
    }
}

// Add CSS for pulse animation
const trackingStyles = `
@keyframes pulse {
    0%, 100% {
        box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.2);
    }
    50% {
        box-shadow: 0 0 0 8px rgba(46, 204, 113, 0.1);
    }
}

.tracking-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.tracking-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md) !important;
}

.timeline-item {
    transition: all 0.3s ease;
}
`;

const trackingStyleElement = document.createElement('style');
trackingStyleElement.textContent = trackingStyles;
document.head.appendChild(trackingStyleElement);

// Make functions globally available
window.showTrackingDetails = showTrackingDetails;
window.trackOrder = trackOrder;
window.loadTrackingData = loadTrackingData;

console.log(' Fixed tracking section loaded');


  // ==================== FARMERS SECTION ====================

async function loadFarmersData() {
    try {
        // Get all farmers (users with FARMER role)
        const response = await apiCall(`${ENDPOINTS.users}?role=FARMER`);

        // FIX: Ensure we have an array
        const farmers = Array.isArray(response) ? response :
                       (response.content ? response.content : []);

        displayFarmers(farmers);

    } catch (error) {
        console.error('Error loading farmers:', error);
        showNotification('Failed to load farmers', 'error');
    }
}





function displayFarmers(farmers) {
    const farmersGrid = document.getElementById('farmersGrid');
    if (!farmersGrid) return;

    // FIX: Ensure farmers is an array
    if (!Array.isArray(farmers)) {
        console.error('Farmers is not an array:', farmers);
        farmers = [];
    }

    if (farmers.length === 0) {
        farmersGrid.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <p>No farmers found</p>
            </div>
        `;
        return;
    }

    farmersGrid.innerHTML = farmers.map(farmer => `
        <div class="farmer-card">
            <div class="farmer-avatar" style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: 0 auto var(--spacing-md); background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; border: 4px solid var(--primary-color); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                ${farmer.profileImageUrl ?
                    `<img src="${farmer.profileImageUrl}" alt="${farmer.fullName}"
                         style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: var(--primary-dark);">
                         ${getInitials(farmer.fullName || farmer.username)}
                     </div>` :
                    `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: var(--primary-dark);">
                         ${getInitials(farmer.fullName || farmer.username)}
                     </div>`
                }
                ${farmer.isActive ? '<span class="online-badge" style="position: absolute; bottom: 5px; right: 5px; width: 15px; height: 15px; background: var(--success-color); border-radius: 50%; border: 3px solid white;"></span>' : ''}
            </div>
            <div class="farmer-info" style="text-align: center;">
                <h3 class="farmer-name">${farmer.fullName || farmer.username}</h3>
                <p class="farmer-username" style="color: var(--text-light); margin-bottom: var(--spacing-sm);">@${farmer.username}</p>
                <div class="farmer-contact" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                    <i class="fas fa-envelope"></i>
                    <span>${farmer.email}</span>
                </div>
                <div class="farmer-contact" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                    <i class="fas fa-phone"></i>
                    <span>${farmer.phoneNumber || 'N/A'}</span>
                </div>
                <div class="farmer-rating" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: var(--warning-color); margin-bottom: var(--spacing-md);">
                    <i class="fas fa-star"></i>
                    <span>4.5 (23 reviews)</span>
                </div>
            </div>
            <div class="farmer-actions" style="display: flex; gap: var(--spacing-sm); justify-content: center;">
                <button class="btn btn-primary btn-sm" onclick="viewFarmerProducts('${farmer.id}')" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-seedling"></i>
                    View Products
                </button>
                <button class="btn btn-secondary btn-sm" onclick="contactFarmer('${farmer.id}')" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-envelope"></i>
                    Contact
                </button>
            </div>
        </div>
    `).join('');
}






async function searchFarmers(query) {
    try {
        const response = await apiCall(`${ENDPOINTS.users}?role=FARMER`);

        // FIX: Ensure we have an array
        const allFarmers = Array.isArray(response) ? response :
                          (response.content ? response.content : []);

        const filtered = allFarmers.filter(farmer =>
            farmer.fullName?.toLowerCase().includes(query.toLowerCase()) ||
            farmer.username?.toLowerCase().includes(query.toLowerCase()) ||
            farmer.email?.toLowerCase().includes(query.toLowerCase())
        );
        displayFarmers(filtered);
    } catch (error) {
        console.error('Error searching farmers:', error);
    }
}








async function viewFarmerProducts(farmerId) {
    try {
        console.log('Loading products for farmer:', farmerId);

        // Utiliser le nouvel endpoint pour rcuprer les productions du farmer
        const response = await apiCall(`${ENDPOINTS.cropProductions}/farmer/${farmerId}`);

        console.log('Farmer products response:', response);

        // Vrifier si la rponse contient des donnes
        let productions = [];
        if (response && response.data) {
            productions = response.data; // Si la rponse a une structure {success, message, data}
        } else if (Array.isArray(response)) {
            productions = response; // Si la rponse est directement un tableau
        } else if (response && response.content) {
            productions = response.content; // Si pagination
        }

        console.log('Processed productions:', productions);

        if (!productions || productions.length === 0) {
            showNotification('This farmer has no products available at the moment', 'info');
            return;
        }

        // Afficher les produits dans le marketplace
        displayFarmerProducts(productions, farmerId);

        // Aller  la section marketplace
        setActiveSection('marketplace');

        showNotification(`Showing ${productions.length} products from this farmer`, 'success');

    } catch (error) {
        console.error('Error loading farmer products:', error);
        showNotification('Failed to load farmer products. Please try again.', 'error');
    }
}

// Nouvelle fonction pour afficher les produits d'un farmer spcifique
function displayFarmerProducts(productions, farmerId) {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;

    if (!productions || productions.length === 0) {
        productsGrid.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No products available from this farmer</p>
                <button class="btn btn-primary" onclick="loadMarketplaceData()">
                    Browse All Products
                </button>
            </div>
        `;
        return;
    }

    // Ajouter un en-tte pour indiquer qu'on voit les produits d'un farmer spcifique
    const farmerHeader = document.createElement('div');
    farmerHeader.className = 'farmer-products-header';
    farmerHeader.style.gridColumn = '1 / -1';
    farmerHeader.style.textAlign = 'center';
    farmerHeader.style.padding = 'var(--spacing-lg)';
    farmerHeader.style.backgroundColor = 'var(--primary-light)';
    farmerHeader.style.borderRadius = 'var(--radius-lg)';
    farmerHeader.style.marginBottom = 'var(--spacing-lg)';

    farmerHeader.innerHTML = `
        <h3>Products from ${productions[0]?.farmerName || 'This Farmer'}</h3>
        <p>Showing ${productions.length} available products</p>
        <button class="btn btn-secondary btn-sm" onclick="loadMarketplaceData()">
            <i class="fas fa-store"></i>
            View All Products
        </button>
    `;

    productsGrid.innerHTML = '';
    productsGrid.appendChild(farmerHeader);

    // Afficher les produits
    productsGrid.innerHTML += productions.map(production => `
        <div class="product-card">
            <div class="product-image">
                ${production.cropImageUrl ?
                    `<img src="${production.cropImageUrl}" alt="${production.cropName}"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZWNmMGYxIi8+CjxwYXRoIGQ9Ik03NSA1MEgxMjVWMTUwSDc1VjUwWiIgZmlsbD0iIzJlY2M3MSIvPgo8Y2lyY2xlIGN4PSIxMDAiIGN5PSI3NSIgcj0iMTUiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg=='">` :
                    `<div class="product-placeholder">
                        <i class="fas fa-seedling"></i>
                        <span>No Image</span>
                     </div>`
                }
                ${production.isOrganic ? '<span class="product-badge organic">Organic</span>' : ''}
                ${production.productionStatus === 'HARVESTED' ? '<span class="product-badge ready">Ready</span>' : ''}
            </div>
            <div class="product-info">
                <div class="product-category">${production.cropType || 'Agriculture'}</div>
                <h3 class="product-name">${production.cropName || 'Unknown Crop'}</h3>
                <p class="product-farmer">
                    <i class="fas fa-user"></i>
                    ${production.farmerName || 'Unknown Farmer'}
                </p>

                <div class="product-details">
                    <div class="detail-item">
                        <i class="fas fa-weight"></i>
                        <span>${production.expectedYield || 0} kg available</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${production.location || 'Location not specified'}</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-calendar"></i>
                        <span>Harvest: ${formatDate(production.expectedHarvestDate)}</span>
                    </div>
                </div>

                <div class="product-quality">
                    <span class="quality-badge ${getQualityClass(production)}">
                        ${getQualityText(production)}
                    </span>
                    <span class="production-method">
                        ${production.productionMethod || 'Traditional'}
                    </span>
                </div>

                <div class="product-footer">
                    <div class="product-price">
                        <span class="price-value">${formatCurrency(production.estimatedPrice || 0)}</span>
                        <span class="price-unit">/kg</span>
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-secondary btn-sm" onclick="viewProductDetails('${production.id}')">
                            <i class="fas fa-info-circle"></i>
                            Details
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="addToCart('${production.id}')"
                                ${(production.expectedYield || 0) <= 0 ? 'disabled' : ''}>
                            <i class="fas fa-shopping-cart"></i>
                            ${(production.expectedYield || 0) <= 0 ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Fonctions utilitaires pour la qualit
function getQualityClass(production) {
    if (production.isOrganic) return 'quality-organic';
    if (production.productionMethod === 'CERTIFIED_ORGANIC') return 'quality-certified';
    return 'quality-standard';
}

function getQualityText(production) {
    if (production.isOrganic) return 'Organic';
    if (production.productionMethod === 'CERTIFIED_ORGANIC') return 'Certified';
    return 'Standard';
}








  function contactFarmer(farmerId) {
      setActiveSection('messages');
      // TODO: Open conversation with farmer
  }







  // ==================== QUALITY SECTION ====================

  async function loadQualityData() {
      try {
          // Load quality reports for buyer's orders
          const response = await apiCall(
              `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=50`
          );

          const orders = response.content || response;
          displayQualityReports(orders);

      } catch (error) {
          console.error('Error loading quality data:', error);
      }
  }

function displayQualityReports(orders) {
    const reportsList = document.getElementById('qualityReportsList');
    if (!reportsList) return;

    if (!orders || orders.length === 0) {
        reportsList.innerHTML = `
            <div style="text-align: center; padding: 4rem 2rem;">
                <i class="fas fa-clipboard-list" style="font-size: 5rem; color: var(--text-light); margin-bottom: 1.5rem; opacity: 0.3;"></i>
                <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-dark);">No Quality Reports</h3>
                <p style="color: var(--text-light); margin-bottom: 2rem;">Quality reports will appear here once products are delivered</p>
            </div>
        `;
        return;
    }

    reportsList.innerHTML = orders.map((order, index) => {
        // Generate random quality score (in production, this would come from backend)
        const qualityScores = ['A+', 'A', 'A-', 'B+', 'B'];
        const qualityScore = qualityScores[Math.floor(Math.random() * qualityScores.length)];
        const scorePercentage = qualityScore === 'A+' ? 98 : qualityScore === 'A' ? 92 : qualityScore === 'A-' ? 85 : qualityScore === 'B+' ? 78 : 72;

        const certifications = ['Organic Certified', 'Quality Assured', 'Lab Tested', 'Premium Grade'];
        const certification = certifications[Math.floor(Math.random() * certifications.length)];

        const certColors = {
            'Organic Certified': 'linear-gradient(135deg, #11998e, #38ef7d)',
            'Quality Assured': 'linear-gradient(135deg, #667eea, #764ba2)',
            'Lab Tested': 'linear-gradient(135deg, #f093fb, #f5576c)',
            'Premium Grade': 'linear-gradient(135deg, #ffc837, #ff8008)'
        };

        return `
            <div style="background: ${index % 2 === 0 ? '#ffffff' : '#f8f9fa'}; border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1rem; border: 1px solid var(--border-color); transition: all 0.3s; cursor: pointer;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)';">

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: center;">

                    <!-- Order Information -->
                    <div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
                            <i class="fas fa-hashtag"></i> Order ID
                        </div>
                        <div style="font-weight: 700; color: var(--text-dark); font-size: 1rem; font-family: 'Courier New', monospace;">
                            ${order.transactionCode}
                        </div>
                    </div>

                    <!-- Product & Farmer -->
                    <div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
                            <i class="fas fa-seedling"></i> Product
                        </div>
                        <div style="font-weight: 600; color: var(--text-dark); font-size: 1rem; margin-bottom: 0.25rem;">
                            ${order.cropName || 'N/A'}
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-light); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user"></i> ${order.farmerName || 'Unknown'}
                        </div>
                    </div>

                    <!-- Quality Score -->
                    <div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
                            <i class="fas fa-star"></i> Quality Score
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem; font-weight: 800; color: ${scorePercentage >= 90 ? '#10b981' : scorePercentage >= 80 ? '#f59e0b' : '#ef4444'};">
                                ${qualityScore}
                            </div>
                            <div style="flex: 1;">
                                <div style="background: #e5e7eb; height: 8px; border-radius: 10px; overflow: hidden;">
                                    <div style="background: ${scorePercentage >= 90 ? 'linear-gradient(90deg, #10b981, #059669)' : scorePercentage >= 80 ? 'linear-gradient(90deg, #f59e0b, #d97706)' : 'linear-gradient(90deg, #ef4444, #dc2626)'}; height: 100%; width: ${scorePercentage}%; transition: width 0.5s;"></div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem;">
                                    ${scorePercentage}% Score
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Certification Badge -->
                    <div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
                            <i class="fas fa-certificate"></i> Certification
                        </div>
                        <div style="display: inline-block; background: ${certColors[certification]}; color: white; padding: 0.6rem 1rem; border-radius: 25px; font-size: 0.85rem; font-weight: 700; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                            <i class="fas fa-check-circle"></i> ${certification}
                        </div>
                    </div>

                    <!-- Test Date -->
                    <div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
                            <i class="fas fa-calendar-check"></i> Test Date
                        </div>
                        <div style="font-weight: 600; color: var(--text-dark); font-size: 0.95rem;">
                            ${formatDate(order.createdAt)}
                        </div>
                    </div>

                    <!-- Action Button -->
                    <div style="text-align: right;">
                        <button onclick="viewQualityReport('${order.id}')" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 8px rgba(46, 204, 113, 0.2); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(46, 204, 113, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(46, 204, 113, 0.2)';">
                            <i class="fas fa-file-pdf"></i>
                            View Report
                        </button>
                    </div>

                </div>
            </div>
        `;
    }).join('');
}

  function viewQualityReport(orderId) {
      showNotification('Quality report viewer coming soon', 'info');
  }







  // ==================== MESSAGES SECTION ====================

  async function loadMessagesData() {
      // TODO: Implement messaging system
      showNotification('Messaging feature coming soon', 'info');
  }







  // ==================== REPORTS SECTION ====================

async function loadReportsData() {
    try {
        // Get analytics data
        const analytics = await apiCall(ENDPOINTS.buyerAnalytics(currentUser.id));

        // Get all transactions
        const transactionsResponse = await apiCall(
            `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=100&sortBy=createdAt&sortDir=desc`
        );
        const transactions = transactionsResponse.content || transactionsResponse;

        // Update stat cards
        updateReportStats(analytics, transactions);

        // Render all charts
        renderSpendingChart(transactions);
        renderCategoriesChart(transactions);
        renderTopFarmers(transactions);
        renderOrderStatusChart(transactions);
        renderTrendsChart(transactions);
        renderPaymentMethodsChart(transactions);
        renderRecentActivity(transactions);

    } catch (error) {
        console.error('Error loading reports:', error);
        showNotification('Failed to load reports data', 'error');
    }
}

function updateReportStats(analytics, transactions) {
    // Total Spending
    const totalSpending = transactions.reduce((sum, t) => sum + (t.totalAmount || 0), 0);
    document.getElementById('reportTotalSpending').textContent = formatCurrency(totalSpending);

    // Total Orders
    document.getElementById('reportTotalOrders').textContent = transactions.length;

    // Average Order Value
    const avgOrder = transactions.length > 0 ? totalSpending / transactions.length : 0;
    document.getElementById('reportAvgOrder').textContent = formatCurrency(avgOrder);

    // Active Farmers
    const uniqueFarmers = new Set(transactions.map(t => t.farmerId).filter(Boolean));
    document.getElementById('reportActiveFarmers').textContent = uniqueFarmers.size;
    document.getElementById('reportFarmersCount').textContent = uniqueFarmers.size;

    // Calculate changes (mock for now)
    document.getElementById('reportSpendingChange').textContent = '12%';
    document.getElementById('reportOrdersChange').textContent = '8%';
    document.getElementById('reportAvgChange').textContent = '5%';
}

function renderSpendingChart(transactions) {
    const ctx = document.getElementById('spendingChartCanvas');
    if (!ctx) return;

    // Group by week
    const weeklyData = {};
    transactions.forEach(t => {
        const date = new Date(t.createdAt);
        const weekKey = getWeekKey(date);
        if (!weeklyData[weekKey]) {
            weeklyData[weekKey] = 0;
        }
        weeklyData[weekKey] += t.totalAmount || 0;
    });

    const labels = Object.keys(weeklyData).sort();
    const data = labels.map(label => weeklyData[label]);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Spending (RWF)',
                data: data,
                borderColor: '#2ecc71',
                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointBackgroundColor: '#2ecc71',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    callbacks: {
                        label: function(context) {
                            return 'Total: ' + formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function renderCategoriesChart(transactions) {
    const ctx = document.getElementById('categoriesChartCanvas');
    if (!ctx) return;

    // Group by crop type
    const categories = {};
    transactions.forEach(t => {
        const category = t.cropType || 'Other';
        categories[category] = (categories[category] || 0) + 1;
    });

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(categories),
            datasets: [{
                data: Object.values(categories),
                backgroundColor: [
                    '#2ecc71',
                    '#27ae60',
                    '#a8e6cf',
                    '#7dcea0',
                    '#52be80'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            }
        }
    });
}

function renderTopFarmers(transactions) {
    const container = document.getElementById('topFarmersChart');
    if (!container) return;

    // Group by farmer
    const farmerStats = {};
    transactions.forEach(t => {
        if (t.farmerId && t.farmerName) {
            if (!farmerStats[t.farmerId]) {
                farmerStats[t.farmerId] = {
                    name: t.farmerName,
                    orders: 0,
                    total: 0
                };
            }
            farmerStats[t.farmerId].orders++;
            farmerStats[t.farmerId].total += t.totalAmount || 0;
        }
    });

    // Sort by total amount
    const topFarmers = Object.values(farmerStats)
        .sort((a, b) => b.total - a.total)
        .slice(0, 5);

    if (topFarmers.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                <p>No farmer data available</p>
            </div>
        `;
        return;
    }

    container.innerHTML = topFarmers.map((farmer, index) => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='var(--light-gray)'" onmouseout="this.style.background='white'">
            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                <div style="width: 40px; height: 40px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary-color); font-size: 1.2rem;">
                    ${index + 1}
                </div>
                <div>
                    <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem;">
                        ${farmer.name}
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-light);">
                        ${farmer.orders} orders
                    </div>
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 700; color: var(--primary-color); font-size: 1.1rem;">
                    ${formatCurrency(farmer.total)}
                </div>
            </div>
        </div>
    `).join('');
}

function renderOrderStatusChart(transactions) {
    const ctx = document.getElementById('orderStatusChartCanvas');
    if (!ctx) return;

    // Group by status
    const statusCounts = {};
    transactions.forEach(t => {
        const status = t.transactionStatus || 'PENDING';
        statusCounts[status] = (statusCounts[status] || 0) + 1;
    });

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(statusCounts),
            datasets: [{
                label: 'Orders',
                data: Object.values(statusCounts),
                backgroundColor: '#2ecc71',
                borderWidth: 0,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function renderTrendsChart(transactions) {
    const ctx = document.getElementById('trendsChartCanvas');
    if (!ctx) return;

    // Group by month
    const monthlyData = {};
    transactions.forEach(t => {
        const date = new Date(t.createdAt);
        const monthKey = date.toLocaleString('default', { month: 'short', year: 'numeric' });
        if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = { orders: 0, amount: 0 };
        }
        monthlyData[monthKey].orders++;
        monthlyData[monthKey].amount += t.totalAmount || 0;
    });

    const labels = Object.keys(monthlyData);
    const ordersData = labels.map(label => monthlyData[label].orders);
    const amountData = labels.map(label => monthlyData[label].amount);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Orders',
                    data: ordersData,
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    yAxisID: 'y',
                    borderWidth: 2,
                    tension: 0.4
                },
                {
                    label: 'Amount (RWF)',
                    data: amountData,
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    yAxisID: 'y1',
                    borderWidth: 2,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
}

function renderPaymentMethodsChart(transactions) {
    const ctx = document.getElementById('paymentMethodsChartCanvas');
    if (!ctx) return;

    // Group by payment method
    const methods = {};
    transactions.forEach(t => {
        const method = t.paymentMethod || 'CASH';
        methods[method] = (methods[method] || 0) + 1;
    });

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(methods),
            datasets: [{
                data: Object.values(methods),
                backgroundColor: [
                    '#2ecc71',
                    '#27ae60',
                    '#a8e6cf',
                    '#7dcea0'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15
                    }
                }
            }
        }
    });
}

function renderRecentActivity(transactions) {
    const container = document.getElementById('recentActivityTable');
    if (!container) return;

    const recent = transactions.slice(0, 10);

    if (recent.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                <p>No recent activity</p>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <table class="data-table" style="width: 100%;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Order ID</th>
                    <th>Product</th>
                    <th>Farmer</th>
                    <th>Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${recent.map(t => `
                    <tr>
                        <td>${formatDate(t.createdAt)}</td>
                        <td style="font-family: monospace; font-size: 0.9rem;">${t.transactionCode}</td>
                        <td>${t.cropName || 'N/A'}</td>
                        <td>${t.farmerName || 'N/A'}</td>
                        <td style="font-weight: 600; color: var(--primary-color);">${formatCurrency(t.totalAmount)}</td>
                        <td>
                            <span class="status-badge status-${t.transactionStatus?.toLowerCase()}">${t.transactionStatus || 'PENDING'}</span>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Helper function to get week key
function getWeekKey(date) {
    const start = new Date(date.getFullYear(), 0, 1);
    const diff = date - start;
    const oneWeek = 1000 * 60 * 60 * 24 * 7;
    const week = Math.floor(diff / oneWeek);
    return `Week ${week + 1}`;
}




  // ==================== NOTIFICATIONS ====================

  async function loadNotifications() {
      try {
          // TODO: Implement notifications API
          // For now, use mock notifications
          notifications = [
              {
                  id: '1',
                  title: 'New Product Available',
                  message: 'Fresh corn available from Farmer John',
                  type: 'info',
                  timestamp: new Date(),
                  read: false
              }
          ];

          displayNotifications();

      } catch (error) {
          console.error('Error loading notifications:', error);
      }
  }

  function displayNotifications() {
      const notificationsList = document.getElementById('notificationsList');
      const notificationBadge = document.getElementById('notificationBadge');

      if (!notificationsList) return;

      const unreadCount = notifications.filter(n => !n.read).length;

      if (notificationBadge) {
          notificationBadge.textContent = unreadCount;
          notificationBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
      }

      if (notifications.length === 0) {
          notificationsList.innerHTML = `
              <div class="notification-empty">
                  <p>No notifications</p>
              </div>
          `;
          return;
      }

      notificationsList.innerHTML = notifications.map(notification => `
          <div class="notification-item ${notification.read ? 'read' : 'unread'}">
              <div class="notification-icon ${notification.type}">
                  <i class="fas fa-${notification.type === 'success' ? 'check-circle' :
                      notification.type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
              </div>
              <div class="notification-content">
                  <h4>${notification.title}</h4>
                  <p>${notification.message}</p>
                  <span class="notification-time">${formatDateTime(notification.timestamp)}</span>
              </div>
          </div>
      `).join('');
  }



async function viewProductDetails(productId) {
    console.log('=== VIEW PRODUCT DETAILS CALLED ===');
    console.log('Input value:', productId);
    console.log('Input type:', typeof productId);

    try {
        showNotification('Loading product details...', 'info');

        let productData = null;
        let searchStrategy = '';

        // STRATEGY 1: Check if it's a Market Price (starts with MP)
        if (productId.startsWith('MP')) {
            try {
                console.log('Strategy 1: Searching in market prices...');
                const marketPricesResponse = await apiCall(`${API_BASE_URL}/market-prices`);
                const marketPrices = extractDataFromResponse(marketPricesResponse);

                productData = marketPrices.find(mp => mp.id === productId);

                if (productData) {
                    searchStrategy = 'market_price';
                    console.log(' Found in market prices');

                    // Enrich with crop data
                    if (productData.cropId) {
                        try {
                            const cropResponse = await apiCall(`${ENDPOINTS.crops}/${productData.cropId}`);
                            const crop = cropResponse.data || cropResponse;
                            productData.cropDetails = crop;
                            console.log(' Crop details loaded');
                        } catch (error) {
                            console.warn('Could not load crop details:', error);
                        }
                    }

                    // Show market price details
                    showMarketPriceDetailsModal(productData);
                    return;
                }
            } catch (error) {
                console.error('Strategy 1 failed:', error);
            }
        }

        // STRATEGY 2: Search in active crop productions
        try {
            console.log('Strategy 2: Searching in active productions...');
            const allProductionsResponse = await apiCall(ENDPOINTS.cropProductionsActive);
            const allProductions = extractDataFromResponse(allProductionsResponse);

            productData = allProductions.find(p =>
                p.id === productId ||
                p.productionCode === productId
            );

            if (productData) {
                searchStrategy = 'crop_production';
                console.log(' Found in crop productions');

                // Fetch crop details
                let crop = null;
                if (productData.cropId) {
                    try {
                        const cropResponse = await apiCall(`${ENDPOINTS.crops}/${productData.cropId}`);
                        crop = cropResponse.data || cropResponse;
                    } catch (error) {
                        console.warn('Could not load crop details:', error);
                    }
                }

                showProductDetailsModal(productData, crop);
                return;
            }
        } catch (error) {
            console.error('Strategy 2 failed:', error);
        }

        // STRATEGY 3: Try direct crop production lookup
        try {
            console.log('Strategy 3: Direct crop production lookup...');
            const response = await apiCall(`${ENDPOINTS.cropProductions}/${productId}`);
            productData = response.data || response;

            if (productData) {
                searchStrategy = 'direct_crop_production';
                console.log(' Direct crop production lookup successful');

                // Fetch crop details
                let crop = null;
                if (productData.cropId) {
                    try {
                        const cropResponse = await apiCall(`${ENDPOINTS.crops}/${productData.cropId}`);
                        crop = cropResponse.data || cropResponse;
                    } catch (error) {
                        console.warn('Could not load crop details:', error);
                    }
                }

                showProductDetailsModal(productData, crop);
                return;
            }
        } catch (error) {
            console.log(' Direct crop production lookup failed:', error.message);
        }

        // If still not found
        console.error('=== PRODUCT NOT FOUND ===');
        console.error('Search value:', productId);
        showNotification('Product not found. It may have been removed or is no longer available.', 'error');

    } catch (error) {
        console.error('=== CRITICAL ERROR ===', error);
        showNotification('Failed to load product details. Please try again.', 'error');
    }
}



async function addMarketPriceToCart(marketPriceId, price) {
    try {
        // Get market price details
        const marketPriceResponse = await apiCall(`${API_BASE_URL}/market-prices/${marketPriceId}`);
        const marketPrice = marketPriceResponse.data || marketPriceResponse;

        if (!marketPrice) {
            showNotification('Market price not found', 'error');
            return;
        }

        // Check if already in cart
        const existingItem = shoppingCart.find(item => item.marketPriceId === marketPriceId);

        if (existingItem) {
            existingItem.quantity += 1;
            showNotification('Quantity updated in cart', 'success');
        } else {
            shoppingCart.push({
                marketPriceId: marketPrice.id,
                cropId: marketPrice.cropId,
                cropName: marketPrice.cropName || marketPrice.cropDetails?.cropName || 'Unknown Crop',
                price: price,
                quantity: 1,
                availableQuantity: marketPrice.availableQuantity || 0,
                imageUrl: marketPrice.cropImageUrl || marketPrice.cropDetails?.imageUrl,
                location: marketPrice.location,
                marketName: marketPrice.marketName,
                type: 'market_price', // Distinguish from crop productions
                unit: 'kg'
            });
            showNotification('Product added to cart', 'success');
        }

        saveCartToStorage();
        updateCartBadge();

    } catch (error) {
        console.error('Error adding market price to cart:', error);
        showNotification('Failed to add product to cart', 'error');
    }
}

// Helper function to get current marketplace products
async function getCurrentMarketplaceProducts() {
    try {
        const marketPricesResponse = await apiCall(`${API_BASE_URL}/market-prices/recent?days=30`);
        const productionsResponse = await apiCall(`${API_BASE_URL}/v1/crop-productions/active`);
        const cropsResponse = await apiCall(`${API_BASE_URL}/v1/crops/all`);

        const marketPrices = extractDataFromResponse(marketPricesResponse);
        const productions = extractDataFromResponse(productionsResponse);
        const crops = extractDataFromResponse(cropsResponse);

        const enrichedMarketPrices = enrichMarketPricesWithCropNames(marketPrices, crops);
        return mergeMarketPricesWithProductions(enrichedMarketPrices, productions);
    } catch (error) {
        console.error('Error getting marketplace products:', error);
        return [];
    }
}

function showMarketPriceDetailsModal(marketPrice) {
    const modal = document.createElement('div');
    modal.className = 'modal';

    // Extract data safely with fallbacks
    const cropName = marketPrice.cropDetails?.cropName || marketPrice.cropName || 'Unknown Crop';
    const cropDescription = marketPrice.cropDetails?.description || marketPrice.notes || 'Market price information';
    const cropImageUrl = marketPrice.cropDetails?.imageUrl || marketPrice.cropImageUrl || null;
    const cropType = marketPrice.cropDetails?.cropType || marketPrice.cropType || 'N/A';
    const price = marketPrice.pricePerKg || marketPrice.price || 0;
    const location = marketPrice.location || 'Location not specified';
    const marketName = marketPrice.marketName || 'Local Market';
    const marketType = marketPrice.marketType || 'RETAIL';
    const priceDate = marketPrice.priceDate || new Date();
    const demandLevel = marketPrice.demandLevel || 'MEDIUM';
    const supplyLevel = marketPrice.supplyLevel || 'MEDIUM';
    const priceTrend = marketPrice.priceTrend || 'STABLE';
    const availableQuantity = marketPrice.availableQuantity || 0;
    const reliabilityScore = marketPrice.reliabilityScore || 3;

    // Determine trend badge
    let trendBadge = '';
    let trendClass = '';
    if (priceTrend === 'INCREASING') {
        trendBadge = 'Price Rising ';
        trendClass = 'status-organic';
    } else if (priceTrend === 'DECREASING') {
        trendBadge = 'Price Falling ';
        trendClass = 'status-certified';
    } else {
        trendBadge = 'Price Stable ';
        trendClass = 'status-growing';
    }

    // Determine reliability badge
    let reliabilityBadge = '';
    if (reliabilityScore >= 4) {
        reliabilityBadge = 'High Reliability ';
    } else if (reliabilityScore >= 3) {
        reliabilityBadge = 'Good Reliability ';
    } else {
        reliabilityBadge = 'Fair Reliability ';
    }

    modal.innerHTML = `
        <div class="modal-content large">
            <div class="modal-header">
                <h2>${cropName} - Market Price</h2>
                <button class="modal-close" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="product-details-grid">
                    <!-- Image Section -->
                    <div class="product-image-section">
                        ${cropImageUrl ?
                            `<img src="${cropImageUrl}" alt="${cropName}"
                                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZWNmMGYxIi8+CjxwYXRoIGQ9Ik03NSA1MEgxMjVWMTUwSDc1VjUwWiIgZmlsbD0iIzJlY2M3MSIvPgo8Y2lyY2xlIGN4PSIxMDAiIGN5PSI3NSIgcj0iMTUiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==';">` :
                            `<div class="product-placeholder-large">
                                <i class="fas fa-chart-line"></i>
                                <span>Market Price Data</span>
                             </div>`
                        }
                        <div style="margin-top: 1rem; text-align: center;">
                            <span class="status-badge ${trendClass}">${trendBadge}</span>
                            <span class="status-badge status-harvested" style="margin-left: 0.5rem;">${reliabilityBadge}</span>
                        </div>
                    </div>

                    <!-- Info Section -->
                    <div class="product-info-section">
                        <h3 style="margin-bottom: 1rem; color: var(--text-dark);">Market Information</h3>
                        <p class="product-description" style="color: var(--text-light); margin-bottom: 1.5rem; line-height: 1.6;">
                            Current market pricing information for ${cropName} based on recent market data.
                        </p>

                        <div class="info-grid">
                            <!-- Price Information -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-dollar-sign"></i> Current Price:
                                </span>
                                <span class="value price-highlight">${formatCurrency(price)}/kg</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-store"></i> Market:
                                </span>
                                <span class="value">${marketName}</span>
                            </div>

                            <!-- Location & Availability -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-map-marker-alt"></i> Location:
                                </span>
                                <span class="value">${location}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-box"></i> Estimated Supply:
                                </span>
                                <span class="value">${availableQuantity} kg</span>
                            </div>

                            <!-- Market Conditions -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-chart-line"></i> Market Type:
                                </span>
                                <span class="value">${marketType}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-tag"></i> Category:
                                </span>
                                <span class="value">${cropType}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-fire"></i> Demand Level:
                                </span>
                                <span class="value" style="color: ${
                                    demandLevel === 'HIGH' ? 'var(--danger-color)' :
                                    demandLevel === 'MEDIUM' ? 'var(--warning-color)' : 'var(--success-color)'
                                }">${demandLevel}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-warehouse"></i> Supply Level:
                                </span>
                                <span class="value" style="color: ${
                                    supplyLevel === 'HIGH' ? 'var(--success-color)' :
                                    supplyLevel === 'MEDIUM' ? 'var(--warning-color)' : 'var(--danger-color)'
                                }">${supplyLevel}</span>
                            </div>

                            <!-- Additional Info -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-calendar"></i> Price Date:
                                </span>
                                <span class="value">${formatDate(priceDate)}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-database"></i> Data Source:
                                </span>
                                <span class="value">${marketPrice.dataSource || 'Market Data'}</span>
                            </div>
                        </div>

                        <!-- Market Insights -->
                        <div class="nutritional-info">
                            <h4>
                                <i class="fas fa-lightbulb"></i> Market Insights
                            </h4>
                            <p style="color: var(--text-dark); line-height: 1.6; margin: 0;">
                                ${getMarketInsights(demandLevel, supplyLevel, priceTrend)}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i> Close
                </button>
                ${availableQuantity > 0 ? `
                    <button class="btn btn-primary" onclick="addMarketPriceToCart('${marketPrice.id}', ${price}); this.closest('.modal').remove(); showNotification('Product added to cart!', 'success');">
                        <i class="fas fa-shopping-cart"></i> Add to Cart - ${formatCurrency(price)}
                    </button>
                ` : `
                    <button class="btn btn-secondary" disabled>
                        <i class="fas fa-ban"></i> Limited Availability
                    </button>
                `}
            </div>
        </div>
    `;

    // Add modal to page
    document.body.appendChild(modal);

    // Show modal with animation
    setTimeout(() => modal.classList.add('show'), 10);

    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });

    // Close modal with Escape key
    const closeModal = (e) => {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', closeModal);
        }
    };
    document.addEventListener('keydown', closeModal);
}

// Helper function for market insights
function getMarketInsights(demandLevel, supplyLevel, priceTrend) {
    const insights = [];

    if (demandLevel === 'HIGH' && supplyLevel === 'LOW') {
        insights.push('High demand with limited supply suggests favorable selling conditions.');
    } else if (demandLevel === 'LOW' && supplyLevel === 'HIGH') {
        insights.push('Low demand with abundant supply may indicate buying opportunities.');
    }

    if (priceTrend === 'INCREASING') {
        insights.push('Prices are trending upward, consider purchasing soon.');
    } else if (priceTrend === 'DECREASING') {
        insights.push('Prices are trending downward, you may get better deals.');
    } else {
        insights.push('Prices are stable, good time for planned purchases.');
    }

    return insights.join(' ');
}










function showProductDetailsModal(production, crop) {
    // Create modal element
    const modal = document.createElement('div');
    modal.className = 'modal';

    // Extract data safely with fallbacks
    const cropName = crop?.cropName || production.cropName || 'Unknown Crop';
    const cropDescription = crop?.description || production.notes || 'No description available';
    const cropImageUrl = crop?.imageUrl || production.cropImageUrl || null;
    const cropType = crop?.cropType || production.cropType || 'N/A';
    const variety = crop?.variety || production.seedVariety || 'N/A';
    const availableQuantity = production.expectedYield || production.actualYield || 0;
    const price = production.estimatedPrice || production.marketPrice || 0;
    const harvestDate = production.expectedHarvestDate || production.actualHarvestDate || new Date();
    const location = production.location || 'Location not specified';
    const farmerName = production.farmerName || 'Unknown Farmer';
    const productionMethod = production.productionMethod || 'N/A';
    const productionStatus = production.productionStatus || 'N/A';
    const certification = production.certification || 'None';
    const areaPlanted = production.areaPlanted || 0;
    const isOrganic = production.isOrganic || productionMethod?.includes('ORGANIC');
    const isCertified = production.certification && production.certification !== 'None';

    // Determine status badge
    let statusBadge = '';
    let statusClass = '';
    if (isOrganic) {
        statusBadge = 'Organic';
        statusClass = 'status-organic';
    } else if (isCertified) {
        statusBadge = 'Certified';
        statusClass = 'status-certified';
    } else if (productionStatus === 'HARVESTED') {
        statusBadge = 'Harvested';
        statusClass = 'status-harvested';
    } else {
        statusBadge = 'Growing';
        statusClass = 'status-growing';
    }

    modal.innerHTML = `
        <div class="modal-content large">
            <div class="modal-header">
                <h2>${cropName}</h2>
                <button class="modal-close" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="product-details-grid">
                    <!-- Image Section -->
                    <div class="product-image-section">
                        ${cropImageUrl ?
                            `<img src="${cropImageUrl}" alt="${cropName}"
                                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZWNmMGYxIi8+CjxwYXRoIGQ9Ik03NSA1MEgxMjVWMTUwSDc1VjUwWiIgZmlsbD0iIzJlY2M3MSIvPgo8Y2lyY2xlIGN4PSIxMDAiIGN5PSI3NSIgcj0iMTUiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==';">` :
                            `<div class="product-placeholder-large">
                                <i class="fas fa-seedling"></i>
                                <span>No Image Available</span>
                             </div>`
                        }
                        <div style="margin-top: 1rem; text-align: center;">
                            <span class="status-badge ${statusClass}">${statusBadge}</span>
                        </div>
                    </div>

                    <!-- Info Section -->
                    <div class="product-info-section">
                        <h3 style="margin-bottom: 1rem; color: var(--text-dark);">Product Details</h3>
                        <p class="product-description" style="color: var(--text-light); margin-bottom: 1.5rem; line-height: 1.6;">
                            ${cropDescription}
                        </p>

                        <div class="info-grid">
                            <!-- Basic Information -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-tag"></i> Category:
                                </span>
                                <span class="value">${cropType}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-seedling"></i> Variety:
                                </span>
                                <span class="value">${variety}</span>
                            </div>

                            <!-- Availability & Pricing -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-box"></i> Available:
                                </span>
                                <span class="value" style="color: ${availableQuantity > 0 ? 'var(--success-color)' : 'var(--danger-color)'}">
                                    ${availableQuantity} kg
                                </span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-dollar-sign"></i> Price:
                                </span>
                                <span class="value price-highlight">${formatCurrency(price)}/kg</span>
                            </div>

                            <!-- Dates -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-calendar"></i> Harvest Date:
                                </span>
                                <span class="value">${formatDate(harvestDate)}</span>
                            </div>

                            <!-- Location & Farmer -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-map-marker-alt"></i> Location:
                                </span>
                                <span class="value">${location}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-user"></i> Farmer:
                                </span>
                                <span class="value">${farmerName}</span>
                            </div>

                            <!-- Production Details -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-cogs"></i> Method:
                                </span>
                                <span class="value">${productionMethod}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-certificate"></i> Certification:
                                </span>
                                <span class="value">${certification}</span>
                            </div>

                            <!-- Additional Info -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-chart-area"></i> Area Planted:
                                </span>
                                <span class="value">${areaPlanted} hectares</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-info-circle"></i> Status:
                                </span>
                                <span class="value">${productionStatus}</span>
                            </div>
                        </div>

                        <!-- Nutritional Information -->
                        ${crop?.nutritionalInfo ? `
                            <div class="nutritional-info">
                                <h4>
                                    <i class="fas fa-heartbeat"></i> Nutritional Information
                                </h4>
                                <p style="color: var(--text-dark); line-height: 1.6; margin: 0;">
                                    ${crop.nutritionalInfo}
                                </p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i> Close
                </button>
                ${availableQuantity > 0 ? `
                    <button class="btn btn-primary" onclick="addToCart('${production.id}'); this.closest('.modal').remove(); showNotification('Product added to cart!', 'success');">
                        <i class="fas fa-shopping-cart"></i> Add to Cart - ${formatCurrency(price)}
                    </button>
                ` : `
                    <button class="btn btn-secondary" disabled>
                        <i class="fas fa-ban"></i> Out of Stock
                    </button>
                `}
            </div>
        </div>
    `;

    // Add modal to page
    document.body.appendChild(modal);

    // Show modal with animation
    setTimeout(() => modal.classList.add('show'), 10);

    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });

    // Close modal with Escape key
    const closeModal = (e) => {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', closeModal);
        }
    };
    document.addEventListener('keydown', closeModal);
}

// Make function globally available
window.viewProductDetails = viewProductDetails;


// Add this CSS to your <style> section
const additionalCSS = `
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    padding: 2rem;
    overflow-y: auto;
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: var(--radius-lg);
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: modalSlideIn 0.3s ease;
}

.modal-content.large {
    max-width: 1200px;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-light);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: var(--radius-md);
    transition: var(--transition-base);
}

.modal-close:hover {
    background: var(--gray);
    color: var(--text-dark);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
}
`;

// Inject the CSS
const style = document.createElement('style');
style.textContent = additionalCSS;
document.head.appendChild(style);

  // ==================== LEAVE REVIEW ====================

  function leaveReview(orderId) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
          <div class="modal-content">
              <div class="modal-header">
                  <h2>Leave a Review</h2>
                  <button class="modal-close" onclick="this.closest('.modal').remove()">
                      <i class="fas fa-times"></i>
                  </button>
              </div>
              <div class="modal-body">
                  <form id="reviewForm">
                      <div class="form-group">
                          <label>Rating</label>
                          <div class="star-rating">
                              <input type="radio" name="rating" value="5" id="star5">
                              <label for="star5"><i class="fas fa-star"></i></label>
                              <input type="radio" name="rating" value="4" id="star4">
                              <label for="star4"><i class="fas fa-star"></i></label>
                              <input type="radio" name="rating" value="3" id="star3">
                              <label for="star3"><i class="fas fa-star"></i></label>
                              <input type="radio" name="rating" value="2" id="star2">
                              <label for="star2"><i class="fas fa-star"></i></label>
                              <input type="radio" name="rating" value="1" id="star1">
                              <label for="star1"><i class="fas fa-star"></i></label>
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="reviewText">Your Review</label>
                          <textarea id="reviewText" rows="4" placeholder="Share your experience..."></textarea>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                      Cancel
                  </button>
                  <button class="btn btn-primary" onclick="submitReview('${orderId}')">
                      Submit Review
                  </button>
              </div>
          </div>
      `;
      document.body.appendChild(modal);
      setTimeout(() => modal.classList.add('show'), 10);
  }

  async function submitReview(orderId) {
      const rating = document.querySelector('input[name="rating"]:checked')?.value;
      const feedback = document.getElementById('reviewText')?.value;

      if (!rating) {
          showNotification('Please select a rating', 'warning');
          return;
      }

      try {
          await apiCall(`${ENDPOINTS.transactionById(orderId)}/rate-farmer`, {
              method: 'PUT',
              body: JSON.stringify({
                  rating: parseInt(rating),
                  feedback: feedback || ''
              })
          });

          showNotification('Thank you for your review!', 'success');
          document.querySelector('.modal')?.remove();

      } catch (error) {
          console.error('Error submitting review:', error);
          showNotification('Failed to submit review', 'error');
      }
  }



  // ==================== PERIODIC UPDATES ====================

  function startPeriodicUpdates() {
      const sessionHandler = window.UserSessionHandler ? window.UserSessionHandler.getInstance() : null;

      // Refresh data every 5 minutes
      setInterval(() => {
          // Check if still authenticated
          if (sessionHandler && !sessionHandler.isAuthenticated()) {
              handleUnauthorized();
              return;
          }

          // Update activity
          if (sessionHandler && currentUser) {
              sessionHandler.updateLastActivity();

              if (window.sessionTracker) {
                  window.sessionTracker.updateLastActivity(currentUser.id || currentUser.userId);
              }
          }

          // Refresh data if on overview
          if (currentSection === 'overview') {
              loadOverviewData();
          }

          loadNotifications();
      }, 5 * 60 * 1000);
  }



    // Enhanced Sidebar Navigation
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();

        // Remove active class from all items
        document.querySelectorAll('.nav-item').forEach(navItem => {
            navItem.style.background = 'transparent';
            navItem.style.color = '#64748b';
            navItem.style.boxShadow = 'none';
        });

        // Add active class to clicked item
        this.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        this.style.color = 'white';
        this.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';

        // Navigate to section
        const section = this.dataset.section;
        setActiveSection(section);
    });

    // Hover effects
    item.addEventListener('mouseenter', function() {
        if (!this.classList.contains('active')) {
            this.style.background = '#f1f5f9';
            this.style.color = '#1e293b';
        }
    });

    item.addEventListener('mouseleave', function() {
        if (!this.classList.contains('active')) {
            this.style.background = 'transparent';
            this.style.color = '#64748b';
        }
    });
});

  // ==================== GLOBAL FUNCTIONS ====================

  // Make functions globally accessible
  window.viewOrderDetails = viewOrderDetails;
  window.trackOrder = trackOrder;
  window.cancelOrder = cancelOrder;
  window.viewProductDetails = viewProductDetails;
  window.addToCart = addToCart;
  window.updateCartQuantity = updateCartQuantity;
  window.removeFromCart = removeFromCart;
  window.handleCheckout = handleCheckout;
  window.viewFarmerProducts = viewFarmerProducts;
  window.contactFarmer = contactFarmer;
  window.viewTransactionDetails = viewTransactionDetails;
  window.downloadInvoice = downloadInvoice;
  window.viewQualityReport = viewQualityReport;
  window.leaveReview = leaveReview;
  window.submitReview = submitReview;
  window.searchFarmers = searchFarmers;
  window.searchProducts = searchProducts;
  window.searchOrders = searchOrders;

  console.log('BuyerDashboard.js loaded successfully');

</script>
</body>
</html>
