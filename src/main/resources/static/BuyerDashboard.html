<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buyer Dashboard - AgriGuard AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ============================================================================
    BUYER DASHBOARD - COMPLETE CSS
    Identical design to Farmer Dashboard
    ============================================================================ */

 :root {
     --primary-green: #22c55e;
     --primary-color: #22c55e;
     --primary-dark: #16a34a;
     --secondary-green: #10b981;
     --accent-green: #34d399;
     --light-green: #dcfce7;
     --primary-light: #dcfce7;
     --dark-green: #166534;
     --forest-green: #065f46;
     --success-color: #22c55e;
     --warning-color: #f59e0b;
     --error-color: #ef4444;
     --info-color: #3b82f6;
     --bg-primary: #ffffff;
     --bg-secondary: #f8f9fa;
     --bg-sidebar: #e8f5e8;
     --text-primary: #333333;
     --text-secondary: #666666;
     --text-light: #94a3b8;
     --text-dark: #1e293b;
     --gray: #e2e8f0;
     --border-color: #e0e0e0;
     --hover-bg: rgba(34, 197, 94, 0.1);
     --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
     --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
     --shadow-lg: 0 8px 25px rgba(34, 197, 94, 0.15);
     --gradient-primary: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
     --gradient-bg: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
     --card-bg: #ffffff;
     --modal-bg: rgba(0, 0, 0, 0.5);
     --radius-sm: 8px;
     --radius-md: 12px;
     --radius-lg: 16px;
     --spacing-sm: 8px;
     --spacing-md: 16px;
     --spacing-lg: 24px;
     --spacing-xl: 32px;
 }

 .dark-mode {
     --bg-primary: #1a1a1a;
     --bg-secondary: #2d2d2d;
     --bg-sidebar: #1f2937;
     --text-primary: #ffffff;
     --text-secondary: #cccccc;
     --border-color: #404040;
     --hover-bg: rgba(34, 197, 94, 0.2);
     --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
     --card-bg: #374151;
     --gradient-bg: linear-gradient(135deg, #1f2937 0%, #374151 50%, #4b5563 100%);
 }

 /* ============================================================================
    RESET & BASE STYLES
    ============================================================================ */

 * {
     margin: 0;
     padding: 0;
     box-sizing: border-box;
 }

 body {
     font-family: 'Inter', sans-serif;
     background: var(--gradient-bg);
     color: var(--text-primary);
     transition: all 0.3s ease;
     overflow-x: hidden;
 }

 /* ============================================================================
    DASHBOARD CONTAINER
    ============================================================================ */

 .dashboard-container {
     display: flex;
     height: 100vh;
 }

 /* ============================================================================
    SIDEBAR STYLES
    ============================================================================ */

 .sidebar {
     width: 280px;
     background: var(--bg-sidebar);
     border-right: 1px solid var(--border-color);
     display: flex;
     flex-direction: column;
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
     position: fixed;
     height: 100vh;
     z-index: 1000;
     box-shadow: var(--shadow);
     overflow-y: auto;
 }

 .sidebar.collapsed {
     width: 70px;
 }

 .sidebar-header {
     padding: 20px;
     border-bottom: 1px solid var(--border-color);
     display: flex;
     align-items: center;
     gap: 12px;
     flex-shrink: 0;
 }

 .logo {
     width: 45px;
     height: 45px;
     border-radius: 12px;
     display: flex;
     align-items: center;
     justify-content: center;
     background: var(--gradient-primary);
     color: white;
     font-size: 24px;
     box-shadow: var(--shadow);
     animation: pulse 2s infinite;
     flex-shrink: 0;
 }

 @keyframes pulse {
     0%, 100% { transform: scale(1); }
     50% { transform: scale(1.05); }
 }

 .company-info {
     flex: 1;
     transition: opacity 0.3s ease;
     overflow: hidden;
 }

 .company-name {
     font-size: 18px;
     font-weight: 700;
     color: var(--text-primary);
     margin-bottom: 2px;
     white-space: nowrap;
 }

 .company-tagline {
     font-size: 11px;
     color: var(--primary-green);
     font-weight: 600;
     text-transform: uppercase;
     letter-spacing: 0.5px;
     white-space: nowrap;
 }

 .sidebar.collapsed .company-info {
     opacity: 0;
     width: 0;
 }

 /* Sidebar Navigation */
 .sidebar-nav {
     flex: 1;
     padding: 20px 0;
     overflow-y: auto;
 }

 .nav-section {
     margin-bottom: 30px;
 }

 .nav-section-title {
     padding: 0 20px 10px;
     font-size: 11px;
     font-weight: 700;
     color: var(--primary-green);
     text-transform: uppercase;
     letter-spacing: 1px;
     transition: opacity 0.3s ease;
 }

 .sidebar.collapsed .nav-section-title {
     opacity: 0;
     height: 0;
     margin: 0;
     padding: 0;
 }

 .nav-menu {
     list-style: none;
 }

 .nav-item {
     margin-bottom: 4px;
 }

 .nav-link {
     display: flex;
     align-items: center;
     padding: 14px 20px;
     color: var(--text-primary);
     text-decoration: none;
     border-radius: 0 25px 25px 0;
     margin-right: 20px;
     transition: all 0.3s ease;
     position: relative;
     overflow: hidden;
     cursor: pointer;
 }

 .nav-link::before {
     content: '';
     position: absolute;
     top: 0;
     left: -100%;
     width: 100%;
     height: 100%;
     background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.1), transparent);
     transition: left 0.5s ease;
 }

 .nav-link:hover::before {
     left: 100%;
 }

 .nav-link i {
     width: 22px;
     margin-right: 14px;
     font-size: 18px;
     flex-shrink: 0;
 }

 .nav-link span {
     transition: opacity 0.3s ease;
     white-space: nowrap;
     font-weight: 500;
 }

 .sidebar.collapsed .nav-link span {
     opacity: 0;
 }

 .sidebar.collapsed .nav-link {
     margin-right: 0;
     border-radius: 0;
     justify-content: center;
 }

 .nav-link:hover {
     background: var(--hover-bg);
     color: var(--primary-green);
     transform: translateX(5px);
 }

 .nav-item.active .nav-link {
     background: var(--gradient-primary);
     color: white;
     box-shadow: var(--shadow);
 }

 .nav-item.active .nav-link:hover {
     background: var(--gradient-primary);
     color: white;
 }

 /* ============================================================================
    MAIN CONTENT AREA
    ============================================================================ */

 .main-content {
     flex: 1;
     display: flex;
     flex-direction: column;
     margin-left: 280px;
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
     width: calc(100% - 280px);
 }

 .main-content.sidebar-collapsed {
     margin-left: 70px;
     width: calc(100% - 70px);
 }

 /* ============================================================================
    HEADER
    ============================================================================ */

 .header {
     background: var(--card-bg);
     border-bottom: 1px solid var(--border-color);
     padding: 0 32px;
     display: flex;
     justify-content: space-between;
     align-items: center;
     height: 80px;
     box-shadow: var(--shadow);
     backdrop-filter: blur(10px);
     flex-shrink: 0;
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
     width: 100%;
     position: relative;
     z-index: 100;
 }

 .header-left {
     display: flex;
     align-items: center;
     gap: 24px;
 }

 .sidebar-toggle {
     background: none;
     border: none;
     color: var(--text-primary);
     font-size: 20px;
     cursor: pointer;
     padding: 12px;
     border-radius: 12px;
     transition: all 0.3s ease;
 }

 .sidebar-toggle:hover {
     background: var(--hover-bg);
     color: var(--primary-green);
     transform: scale(1.1);
 }

 .greeting-section {
     display: flex;
     flex-direction: column;
 }

 .greeting-text {
     font-size: 24px;
     font-weight: 700;
     color: var(--text-primary);
     margin-bottom: 2px;
 }

 .current-date {
     font-size: 14px;
     color: var(--text-secondary);
     font-weight: 500;
 }

 /* Search Container */
 .search-container {
     position: relative;
     width: 400px;
 }

 .search-input {
     width: 100%;
     padding: 12px 50px 12px 20px;
     border: 2px solid var(--border-color);
     border-radius: 25px;
     background: var(--bg-secondary);
     color: var(--text-primary);
     font-size: 15px;
     transition: all 0.3s ease;
     font-weight: 500;
 }

 .search-input:focus {
     outline: none;
     border-color: var(--primary-green);
     box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
 }

 .search-icon {
     position: absolute;
     right: 18px;
     top: 50%;
     transform: translateY(-50%);
     color: var(--text-secondary);
     font-size: 18px;
 }

 /* Header Right */
 .header-right {
     display: flex;
     align-items: center;
     gap: 20px;
 }

 .theme-toggle {
     background: var(--card-bg);
     border: 2px solid var(--border-color);
     color: var(--text-primary);
     padding: 12px 16px;
     border-radius: 12px;
     cursor: pointer;
     transition: all 0.3s ease;
     font-size: 16px;
     display: flex;
     align-items: center;
     gap: 8px;
     font-weight: 500;
 }

 .theme-toggle:hover {
     background: var(--hover-bg);
     border-color: var(--primary-green);
     transform: translateY(-2px);
 }

 .notification-btn {
     background: none;
     border: none;
     color: var(--text-primary);
     font-size: 20px;
     cursor: pointer;
     position: relative;
     padding: 12px;
     border-radius: 12px;
     transition: all 0.3s ease;
 }

 .notification-btn:hover {
     background: var(--hover-bg);
     color: var(--primary-green);
 }

 .notification-badge {
     position: absolute;
     top: 8px;
     right: 8px;
     background: var(--error-color);
     color: white;
     border-radius: 50%;
     width: 20px;
     height: 20px;
     font-size: 11px;
     display: flex;
     align-items: center;
     justify-content: center;
     font-weight: 700;
     animation: bounce 1s infinite;
 }
 .nav-link .notification-badge.nav-badge {
     top: 50%;
     right: 1rem;
     transform: translateY(-50%);
     animation: none;
 }

 @keyframes bounce {
     0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
     40% { transform: translateY(-5px); }
     60% { transform: translateY(-3px); }
 }

 .notifications {
     position: relative;
     z-index: 9999;
 }

 .notification-dropdown {
     position: absolute;
     top: 100%;
     right: 0;
     margin-top: 0.5rem;
     background: var(--card-bg);
     border-radius: 14px;
     box-shadow: 0 12px 40px rgba(0,0,0,0.2), 0 4px 12px rgba(0,0,0,0.1);
     width: 400px;
     max-height: 480px;
     overflow-y: auto;
     z-index: 99999;
     border: 1px solid var(--border-color);
     animation: slideDown 0.25s ease;
 }

 .notification-dropdown.show {
     display: block !important;
 }

 .notification-dropdown-header {
     padding: 1rem 1.25rem;
     display: flex;
     justify-content: space-between;
     align-items: center;
     background: var(--gradient-primary);
     border-radius: 14px 14px 0 0;
     position: sticky;
     top: 0;
     z-index: 1;
 }

 .notification-dropdown-header h3 {
     margin: 0;
     color: white;
     font-size: 1.1rem;
     font-weight: 700;
     display: flex;
     align-items: center;
     gap: 8px;
 }

 .notification-dropdown-header .mark-read-btn {
     background: rgba(255,255,255,0.2);
     color: white;
     border: none;
     padding: 0.4rem 0.9rem;
     border-radius: 8px;
     cursor: pointer;
     font-size: 0.8rem;
     font-weight: 600;
     transition: background 0.2s ease;
 }

 .notification-dropdown-header .mark-read-btn:hover {
     background: rgba(255,255,255,0.35);
 }

 .notification-dropdown-body {
     max-height: 380px;
     overflow-y: auto;
 }

 @keyframes slideDown {
     from {
         opacity: 0;
         transform: translateY(-10px);
     }
     to {
         opacity: 1;
         transform: translateY(0);
     }
 }

 .notification-icon {
     width: 40px;
     height: 40px;
     border-radius: 50%;
     display: flex;
     align-items: center;
     justify-content: center;
     flex-shrink: 0;
     font-size: 1rem;
 }
 .notification-icon.success { background: rgba(34, 197, 94, 0.15); color: var(--success-color); }
 .notification-icon.warning { background: rgba(245, 158, 11, 0.15); color: var(--warning-color); }
 .notification-icon.info { background: rgba(59, 130, 246, 0.15); color: var(--info-color); }

 .notification-item {
     padding: 1rem;
     border-bottom: 1px solid #f0f0f0;
     cursor: pointer;
     transition: all 0.2s ease;
     position: relative;
     display: flex;
     gap: 12px;
     align-items: flex-start;
 }

 .notification-item:hover {
     background: #f8f9fa;
 }

 .notification-item.unread {
     background: #f0f7ff;
     border-left: 4px solid var(--primary-green);
 }

 .notification-item.unread::before {
     content: '';
     position: absolute;
     left: 0.5rem;
     top: 50%;
     transform: translateY(-50%);
     width: 8px;
     height: 8px;
     background: var(--primary-green);
     border-radius: 50%;
 }

 .notification-content { flex: 1; min-width: 0; }

 .notification-item-title {
     font-weight: 600;
     color: var(--text-primary);
     margin-bottom: 0.25rem;
     font-size: 0.95rem;
 }

 .notification-item-message {
     color: var(--text-secondary);
     font-size: 0.85rem;
     line-height: 1.4;
     margin-bottom: 0.5rem;
 }

 .notification-item-time {
     color: var(--text-secondary);
     font-size: 0.75rem;
     opacity: 0.85;
 }

 .notification-empty {
     padding: 3rem 2rem;
     text-align: center;
     color: #999;
 }

 .notification-empty i {
     font-size: 3rem;
     margin-bottom: 1rem;
     opacity: 0.3;
 }

 .profile-section {
     display: flex;
     align-items: center;
     gap: 12px;
     cursor: pointer;
     padding: 8px 16px;
     border-radius: 12px;
     transition: all 0.3s ease;
 }

 .profile-section:hover {
     background: var(--hover-bg);
 }

 .profile-avatar {
     width: 45px;
     height: 45px;
     background: var(--gradient-primary);
     color: white;
     border-radius: 50%;
     display: flex;
     align-items: center;
     justify-content: center;
     font-weight: 700;
     font-size: 16px;
     transition: all 0.3s ease;
     box-shadow: var(--shadow);
 }

 .profile-info {
     display: flex;
     flex-direction: column;
 }

 .profile-name {
     font-size: 14px;
     font-weight: 600;
     color: var(--text-primary);
 }

 .profile-role {
     font-size: 12px;
     color: var(--primary-green);
     font-weight: 500;
     text-transform: capitalize;
 }

 .logout-btn {
     background: transparent;
     border: none;
     color: var(--text-secondary);
     font-size: 20px;
     cursor: pointer;
     padding: 8px;
     border-radius: 8px;
     transition: all 0.3s ease;
     margin-left: 12px;
 }

 .logout-btn:hover {
     background: rgba(239, 68, 68, 0.1);
     color: var(--error-color);
     transform: scale(1.1);
 }

 /* ============================================================================
    CONTENT AREA – Professional layout
    ============================================================================ */

 .content {
     flex: 1;
     padding: 28px 32px 48px;
     background: linear-gradient(180deg, #f8faf9 0%, #f0f7f4 50%, #e8f5ee 100%);
     overflow-y: auto;
     min-height: calc(100vh - 80px);
 }

 .dark-mode .content {
     background: linear-gradient(180deg, #1a1d21 0%, #15181c 50%, #12151a 100%);
 }

 /* Content Sections */
 .content-section {
     display: none;
     max-width: 1400px;
     margin: 0 auto;
 }

 .content-section.active {
     display: block;
     animation: contentFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
 }

 @keyframes contentFadeIn {
     from {
         opacity: 0;
         transform: translateY(16px);
     }
     to {
         opacity: 1;
         transform: translateY(0);
     }
 }

 /* Section Header – Clean, professional */
 .section-header {
     display: flex;
     justify-content: space-between;
     align-items: center;
     margin-bottom: 28px;
     flex-wrap: wrap;
     gap: 16px;
     padding-bottom: 20px;
     border-bottom: 2px solid rgba(34, 197, 94, 0.12);
 }

 .section-header h1 {
     font-size: 1.75rem;
     font-weight: 800;
     color: var(--text-primary);
     margin: 0;
     display: flex;
     align-items: center;
     gap: 12px;
     letter-spacing: -0.02em;
 }

 .section-header h1 i {
     color: var(--primary-green);
     font-size: 1.5rem;
 }

 .section-header-left {
     flex: 1;
 }

 .section-title {
     font-size: 1.6rem;
     font-weight: 800;
     color: var(--text-primary);
     margin-bottom: 6px;
     letter-spacing: -0.02em;
 }

 .section-subtitle {
     font-size: 0.95rem;
     color: var(--text-secondary);
     font-weight: 500;
 }

 .section-header-right,
 .header-actions {
     display: flex;
     gap: 12px;
     flex-wrap: wrap;
     align-items: center;
 }

 /* ============================================================================
    STAT CARDS – Refined, professional
    ============================================================================ */

 .stats-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
     gap: 20px;
     margin-bottom: 28px;
 }

 .stat-card {
     background: var(--card-bg);
     padding: 24px;
     border-radius: 16px;
     box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06), 0 2px 6px rgba(34, 197, 94, 0.04);
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
     border: 1px solid rgba(34, 197, 94, 0.08);
     position: relative;
     overflow: hidden;
 }

 .stat-card::before {
     content: '';
     position: absolute;
     top: 0;
     left: 0;
     right: 0;
     height: 4px;
     background: var(--gradient-primary);
     opacity: 0.9;
 }

 .stat-card:hover {
     transform: translateY(-4px);
     box-shadow: 0 12px 28px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(34, 197, 94, 0.12);
     border-color: rgba(34, 197, 94, 0.2);
 }

 .stat-icon {
     width: 52px;
     height: 52px;
     border-radius: 14px;
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 1.4rem;
     color: white;
     margin-bottom: 16px;
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
 }

 .stat-icon.blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
 .stat-icon.green { background: linear-gradient(135deg, #22c55e, #16a34a); }
 .stat-icon.orange { background: linear-gradient(135deg, #f59e0b, #d97706); }
 .stat-icon.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
 .stat-icon.red { background: linear-gradient(135deg, #ef4444, #dc2626); }
 .stat-icon.primary { background: var(--gradient-primary); }
 .stat-icon.success { background: linear-gradient(135deg, #10b981, #059669); }
 .stat-icon.warning { background: linear-gradient(135deg, #fb923c, #f97316); }
 .stat-icon.danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
 .stat-icon.secondary { background: linear-gradient(135deg, #64748b, #475569); }

 .stat-details {
     display: flex;
     flex-direction: column;
 }

 .stat-value {
     font-size: 1.85rem;
     font-weight: 800;
     color: var(--text-primary);
     margin-bottom: 4px;
     letter-spacing: -0.02em;
 }

 .stat-label {
     font-size: 0.75rem;
     color: var(--text-secondary);
     font-weight: 700;
     text-transform: uppercase;
     letter-spacing: 0.08em;
     margin-bottom: 2px;
 }

 .stat-sublabel {
     font-size: 0.875rem;
     color: var(--text-secondary);
     font-weight: 500;
 }

 .stat-change {
     font-size: 0.8rem;
     color: var(--text-secondary);
     margin-top: 6px;
     display: flex;
     align-items: center;
     gap: 4px;
 }

 .stat-change.positive {
     color: var(--success-color);
     font-weight: 600;
 }

 .stat-change.negative {
     color: var(--error-color);
     font-weight: 600;
 }

 /* ============================================================================
    BUTTONS
    ============================================================================ */

 .btn {
     padding: 12px 24px;
     border: none;
     border-radius: 10px;
     font-size: 14px;
     font-weight: 600;
     cursor: pointer;
     transition: all 0.3s ease;
     display: inline-flex;
     align-items: center;
     gap: 8px;
     text-decoration: none;
 }

 .btn i {
     font-size: 16px;
 }

 .btn-primary {
     background: var(--gradient-primary);
     color: white;
     box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
 }

 .btn-primary:hover {
     transform: translateY(-2px);
     box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
 }

 .btn-secondary {
     background: var(--bg-secondary);
     color: var(--text-primary);
     border: 2px solid var(--border-color);
 }

 .btn-secondary:hover {
     background: var(--hover-bg);
     border-color: var(--primary-green);
     color: var(--primary-green);
 }

 .btn-info {
     background: linear-gradient(135deg, #3b82f6, #1d4ed8);
     color: white;
     box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
 }

 .btn-info:hover {
     transform: translateY(-2px);
     box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
 }

 .btn-danger {
     background: linear-gradient(135deg, #ef4444, #dc2626);
     color: white;
     box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
 }

 .btn-danger:hover {
     transform: translateY(-2px);
     box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
 }

 .btn-sm {
     padding: 8px 16px;
     font-size: 13px;
 }

 .btn-block {
     width: 100%;
     justify-content: center;
 }

 /* ============================================================================
    CARDS & GRIDS – Data, Chart, Info
    ============================================================================ */

 .data-card, .chart-card, .info-card {
     background: var(--card-bg);
     border-radius: 18px;
     box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(34, 197, 94, 0.04);
     border: 1px solid rgba(34, 197, 94, 0.08);
     overflow: hidden;
     margin-bottom: 24px;
     transition: box-shadow 0.3s ease;
 }

 .data-card:hover, .chart-card:hover {
     box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(34, 197, 94, 0.06);
 }

 .card-header, .chart-header, .info-card-header {
     padding: 20px 24px;
     border-bottom: 1px solid var(--border-color);
     display: flex;
     justify-content: space-between;
     align-items: center;
     flex-wrap: wrap;
     gap: 12px;
 }

 .card-header h3, .chart-header h3, .info-card-title {
     font-size: 1.1rem;
     font-weight: 700;
     color: var(--text-primary);
     display: flex;
     align-items: center;
     gap: 10px;
     margin: 0;
 }

 .link-btn {
     color: var(--primary-green);
     text-decoration: none;
     font-weight: 600;
     font-size: 0.9rem;
     transition: all 0.2s ease;
     display: inline-flex;
     align-items: center;
     gap: 6px;
 }

 .link-btn:hover {
     color: var(--primary-dark);
     text-decoration: underline;
 }

 /* ============================================================================
    TABLES – Data table
    ============================================================================ */

 .table-container {
     overflow-x: auto;
     border-radius: 0 0 18px 18px;
 }

 .data-table {
     width: 100%;
     border-collapse: collapse;
 }

 .data-table th,
 .data-table td {
     padding: 16px 20px;
     text-align: left;
     border-bottom: 1px solid var(--border-color);
 }

 .data-table th {
     background: linear-gradient(180deg, #f8faf9 0%, #f0f7f4 100%);
     font-weight: 700;
     color: var(--text-primary);
     font-size: 0.75rem;
     text-transform: uppercase;
     letter-spacing: 0.08em;
 }

 .dark-mode .data-table th {
     background: rgba(34, 197, 94, 0.08);
 }

 .data-table td {
     color: var(--text-primary);
     font-size: 0.95rem;
     font-weight: 500;
 }

 .data-table tbody tr {
     transition: background 0.2s ease;
 }

 .data-table tbody tr:hover {
     background: var(--hover-bg);
 }

 .data-table tbody tr:last-child td {
     border-bottom: none;
 }

 /* ============================================================================
    FILTERS & TABS – Professional
    ============================================================================ */

 .filter-group {
     display: flex;
     gap: 12px;
     align-items: center;
     flex-wrap: wrap;
 }

 .filter-select, .date-input {
     padding: 10px 16px;
     border: 2px solid var(--border-color);
     border-radius: 10px;
     background: var(--bg-secondary);
     color: var(--text-primary);
     font-size: 0.9rem;
     font-weight: 500;
     cursor: pointer;
     transition: all 0.2s ease;
 }

 .filter-select:focus, .date-input:focus {
     outline: none;
     border-color: var(--primary-green);
     box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
 }

 .filter-tabs {
     display: flex;
     gap: 8px;
     flex-wrap: wrap;
 }

 .tab-btn {
     padding: 10px 18px;
     border: 2px solid var(--border-color);
     background: var(--bg-secondary);
     border-radius: 10px;
     cursor: pointer;
     transition: all 0.2s ease;
     font-weight: 600;
     font-size: 0.9rem;
     color: var(--text-primary);
 }

 .tab-btn:hover {
     background: var(--hover-bg);
     border-color: var(--primary-green);
     color: var(--primary-green);
 }

 .tab-btn.active {
     background: var(--gradient-primary);
     color: white;
     border-color: transparent;
     box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
 }

 /* ============================================================================
    CHARTS – Professional
    ============================================================================ */

 .charts-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
     gap: 24px;
     margin-bottom: 28px;
 }

 .chart-container {
     position: relative;
     height: 300px;
     padding: 24px;
 }

 .chart-container-line, .chart-container-doughnut {
     min-height: 280px;
     display: flex;
     align-items: center;
     justify-content: center;
 }

 .chart-container canvas {
     max-width: 100%;
     max-height: 100%;
 }

 .chart-filter {
     padding: 10px 16px;
     border: 2px solid var(--border-color);
     border-radius: 10px;
     background: var(--bg-secondary);
     color: var(--text-primary);
     font-size: 0.9rem;
     font-weight: 500;
     cursor: pointer;
     transition: all 0.2s ease;
 }

 .chart-filter:focus {
     outline: none;
     border-color: var(--primary-green);
     box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
 }

 /* ============================================================================
    MARKETPLACE – Products Grid & Product Card
    ============================================================================ */

 .products-grid {
     display: grid;
     grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
     gap: 24px;
 }

 .product-card {
     background: var(--card-bg);
     border-radius: 18px;
     overflow: hidden;
     box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(34, 197, 94, 0.04);
     border: 1px solid rgba(34, 197, 94, 0.08);
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
 }

 .product-card:hover {
     transform: translateY(-6px);
     box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1), 0 6px 16px rgba(34, 197, 94, 0.12);
     border-color: rgba(34, 197, 94, 0.2);
 }

 .product-card .product-image {
     position: relative;
     width: 100%;
     height: 200px;
     overflow: hidden;
     background: linear-gradient(135deg, #f0f7f4 0%, #e8f5ee 100%);
 }

 .product-card .product-image img {
     width: 100%;
     height: 100%;
     object-fit: cover;
     transition: transform 0.4s ease;
 }

 .product-card:hover .product-image img {
     transform: scale(1.06);
 }

 .product-card .product-placeholder {
     width: 100%;
     height: 100%;
     display: flex;
     flex-direction: column;
     align-items: center;
     justify-content: center;
     background: linear-gradient(135deg, #f0f7f4 0%, #e8f5ee 100%);
     color: var(--text-secondary);
 }

 .product-card .product-info {
     padding: 20px;
 }

 .product-card .product-category {
     font-size: 0.75rem;
     color: var(--primary-green);
     font-weight: 700;
     text-transform: uppercase;
     letter-spacing: 0.08em;
     margin-bottom: 8px;
 }

 .product-card .product-name {
     font-size: 1.1rem;
     font-weight: 700;
     color: var(--text-primary);
     margin-bottom: 8px;
     line-height: 1.3;
 }

 .product-card .product-farmer, .product-card .product-details .detail-item {
     font-size: 0.9rem;
     color: var(--text-secondary);
     margin-bottom: 8px;
     display: flex;
     align-items: center;
     gap: 8px;
 }

 .product-card .product-details .detail-item i {
     color: var(--primary-green);
     width: 18px;
     text-align: center;
 }

 .product-card .product-footer {
     display: flex;
     justify-content: space-between;
     align-items: center;
     padding-top: 16px;
     margin-top: 16px;
     border-top: 1px solid var(--border-color);
 }

 .product-card .price-value {
     font-size: 1.35rem;
     font-weight: 800;
     color: var(--primary-green);
     letter-spacing: -0.02em;
 }

 .product-card .price-unit {
     font-size: 0.85rem;
     color: var(--text-secondary);
     font-weight: 500;
 }

 .product-card .product-badge {
     position: absolute;
     top: 12px;
     padding: 4px 10px;
     border-radius: 8px;
     font-size: 0.7rem;
     font-weight: 700;
     text-transform: uppercase;
     letter-spacing: 0.05em;
 }

 .product-card .product-badge.organic {
     right: 12px;
     background: var(--success-color);
     color: white;
 }

 .product-card .product-badge.ready {
     left: 12px;
     background: var(--info-color);
     color: white;
 }

 /* ============================================================================
    FARMERS – Farmers Grid & Farmer Card
    ============================================================================ */

 .farmers-grid {
     display: grid;
     grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
     gap: 24px;
 }

 .farmer-card {
     background: var(--card-bg);
     border-radius: 18px;
     padding: 28px;
     text-align: center;
     box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(34, 197, 94, 0.04);
     border: 1px solid rgba(34, 197, 94, 0.08);
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
 }

 .farmer-card:hover {
     transform: translateY(-6px);
     box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1), 0 6px 16px rgba(34, 197, 94, 0.12);
     border-color: rgba(34, 197, 94, 0.2);
 }

 .farmer-card .farmer-avatar {
     width: 100px;
     height: 100px;
     border-radius: 50%;
     overflow: hidden;
     margin: 0 auto 16px;
     background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
     display: flex;
     align-items: center;
     justify-content: center;
     border: 4px solid rgba(34, 197, 94, 0.2);
     box-shadow: 0 4px 16px rgba(34, 197, 94, 0.15);
     position: relative;
 }

 .farmer-card .farmer-avatar img {
     width: 100%;
     height: 100%;
     object-fit: cover;
 }

 .farmer-card .farmer-name {
     font-size: 1.15rem;
     font-weight: 700;
     color: var(--text-primary);
     margin-bottom: 4px;
 }

 .farmer-card .farmer-username {
     font-size: 0.85rem;
     color: var(--text-secondary);
     margin-bottom: 12px;
 }

 .farmer-card .farmer-contact {
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 8px;
     font-size: 0.85rem;
     color: var(--text-secondary);
     margin-bottom: 8px;
 }

 .farmer-card .farmer-contact i {
     color: var(--primary-green);
     width: 16px;
 }

 .farmer-card .farmer-rating {
     display: flex;
     align-items: center;
     justify-content: center;
     gap: 6px;
     color: var(--warning-color);
     margin: 16px 0;
     font-size: 0.9rem;
     font-weight: 600;
 }

 .farmer-card .farmer-actions {
     display: flex;
     gap: 10px;
     justify-content: center;
     flex-wrap: wrap;
 }

 .farmer-card .online-badge {
     position: absolute;
     bottom: 6px;
     right: 6px;
     width: 14px;
     height: 14px;
     background: var(--success-color);
     border-radius: 50%;
     border: 3px solid var(--card-bg);
 }

 /* ============================================================================
    ORDERS, CART, TRANSACTIONS, TRACKING – Lists
    ============================================================================ */

 .orders-list, .transactions-list, .tracking-list {
     display: flex;
     flex-direction: column;
     gap: 16px;
 }

 /* ============================================================================
    CART & ORDER SUMMARY
    ============================================================================ */

 .cart-container {
     display: grid;
     grid-template-columns: 2fr 1fr;
     gap: 28px;
 }

 .cart-items {
     display: flex;
     flex-direction: column;
     gap: 16px;
 }

 .cart-item-card {
     background: var(--card-bg);
     border-radius: 16px;
     padding: 20px;
     box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
     border: 1px solid rgba(34, 197, 94, 0.08);
     display: flex;
     gap: 20px;
     align-items: center;
     transition: box-shadow 0.2s ease;
 }

 .cart-item-card:hover {
     box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
 }

 .cart-summary {
     background: var(--card-bg);
     padding: 28px;
     border-radius: 18px;
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06), 0 2px 10px rgba(34, 197, 94, 0.04);
     border: 1px solid rgba(34, 197, 94, 0.08);
     height: fit-content;
     position: sticky;
     top: 24px;
 }

 .cart-summary h3 {
     font-size: 1.25rem;
     font-weight: 700;
     color: var(--text-primary);
     margin-bottom: 20px;
     padding-bottom: 12px;
     border-bottom: 2px solid rgba(34, 197, 94, 0.12);
 }

 .summary-row {
     display: flex;
     justify-content: space-between;
     padding: 12px 0;
     border-bottom: 1px solid var(--border-color);
     font-size: 0.95rem;
     font-weight: 500;
 }

 .summary-row.total {
     font-size: 1.2rem;
     font-weight: 800;
     color: var(--primary-green);
     border-bottom: none;
     padding-top: 16px;
     margin-top: 8px;
 }

 /* ============================================================================
    BADGES & STATUS
    ============================================================================ */

 .badge, .status-badge {
     padding: 6px 12px;
     border-radius: 20px;
     font-size: 11px;
     font-weight: 700;
     text-transform: uppercase;
     display: inline-block;
 }

 .badge-success, .status-active {
     background: rgba(34, 197, 94, 0.1);
     color: var(--success-color);
 }

 .badge-warning, .status-pending {
     background: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
 }

 .badge-danger, .status-inactive, .status-cancelled {
     background: rgba(239, 68, 68, 0.1);
     color: var(--error-color);
 }

 .badge-info, .status-completed {
     background: rgba(59, 130, 246, 0.1);
     color: var(--info-color);
 }

 .badge-secondary {
     background: rgba(107, 114, 128, 0.1);
     color: #6b7280;
 }

 /* ============================================================================
    MODALS
    ============================================================================ */

 .modal-overlay {
     position: fixed;
     top: 0;
     left: 0;
     right: 0;
     bottom: 0;
     background: rgba(0, 0, 0, 0.5);
     backdrop-filter: blur(5px);
     display: none;
     align-items: center;
     justify-content: center;
     z-index: 9999;
     opacity: 0;
     transition: opacity 0.3s ease;
     overflow-y: auto;
     padding: 20px;
 }

 .modal-overlay.show {
     display: flex !important;
     opacity: 1;
 }

 .modal-container {
     background: var(--card-bg);
     border-radius: 20px;
     width: 100%;
     max-width: 700px;
     max-height: 90vh;
     overflow-y: auto;
     box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
     animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
     margin: auto;
     position: relative;
 }

 .modal-container.modal-large {
     max-width: 1000px;
 }

 .modal-container.modal-small {
     max-width: 500px;
 }

 @keyframes slideUp {
     from {
         opacity: 0;
         transform: translateY(50px) scale(0.9);
     }
     to {
         opacity: 1;
         transform: translateY(0) scale(1);
     }
 }

 .modal-header {
     padding: 24px 32px;
     border-bottom: 2px solid var(--border-color);
     display: flex;
     justify-content: space-between;
     align-items: center;
     background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
     border-radius: 20px 20px 0 0;
     position: sticky;
     top: 0;
     z-index: 10;
 }

 .modal-title {
     font-size: 22px;
     font-weight: 700;
     color: white;
     display: flex;
     align-items: center;
     gap: 12px;
     margin: 0;
 }

 .modal-title i {
     font-size: 24px;
 }

 .modal-close {
     background: rgba(255, 255, 255, 0.2);
     border: none;
     width: 40px;
     height: 40px;
     border-radius: 50%;
     color: white;
     font-size: 20px;
     cursor: pointer;
     display: flex;
     align-items: center;
     justify-content: center;
     transition: all 0.3s ease;
     flex-shrink: 0;
 }

 .modal-close:hover {
     background: rgba(255, 255, 255, 0.3);
     transform: rotate(90deg);
 }

 .modal-body {
     padding: 32px;
     max-height: calc(90vh - 180px);
     overflow-y: auto;
 }

 .modal-body::-webkit-scrollbar {
     width: 8px;
 }

 .modal-body::-webkit-scrollbar-track {
     background: var(--bg-secondary);
     border-radius: 10px;
 }

 .modal-body::-webkit-scrollbar-thumb {
     background: var(--primary-green);
     border-radius: 10px;
 }

 .modal-body::-webkit-scrollbar-thumb:hover {
     background: var(--primary-dark);
 }

 .modal-footer {
     padding: 20px 32px;
     border-top: 2px solid var(--border-color);
     display: flex;
     gap: 12px;
     justify-content: flex-end;
     background: var(--bg-secondary);
     border-radius: 0 0 20px 20px;
     position: sticky;
     bottom: 0;
     z-index: 10;
 }

 /* ============================================================================
    FORMS
    ============================================================================ */

 .form-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
     gap: 24px;
     margin-bottom: 24px;
 }

 .form-group {
     display: flex;
     flex-direction: column;
     gap: 8px;
 }

 .form-group.form-group-full {
     grid-column: 1 / -1;
 }

 .form-label {
     font-size: 14px;
     font-weight: 600;
     color: var(--text-primary);
     display: flex;
     align-items: center;
     gap: 8px;
     margin-bottom: 4px;
 }

 .form-label i {
     color: var(--primary-green);
     font-size: 16px;
 }

 .form-input, .form-select, .form-textarea {
     width: 100%;
     padding: 14px 16px;
     border: 2px solid var(--border-color);
     border-radius: 12px;
     background: var(--bg-secondary);
     color: var(--text-primary);
     font-size: 15px;
     font-weight: 500;
     transition: all 0.3s ease;
     font-family: 'Inter', sans-serif;
 }

 .form-input:focus, .form-select:focus, .form-textarea:focus {
     outline: none;
     border-color: var(--primary-green);
     box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
     background: var(--bg-primary);
 }

 .form-input::placeholder {
     color: var(--text-secondary);
     opacity: 0.7;
 }

 .form-input:invalid:not(:placeholder-shown) {
     border-color: var(--error-color);
 }

 .form-input:valid:not(:placeholder-shown) {
     border-color: var(--success-color);
 }

 .form-select {
     cursor: pointer;
     appearance: none;
     background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2322c55e' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
     background-repeat: no-repeat;
     background-position: right 16px center;
     padding-right: 40px;
 }

 .form-textarea {
     min-height: 120px;
     resize: vertical;
 }

 .form-checkbox {
     display: flex;
     align-items: center;
     gap: 12px;
     cursor: pointer;
     user-select: none;
 }

 .form-checkbox input[type="checkbox"] {
     width: 20px;
     height: 20px;
     border: 2px solid var(--border-color);
     border-radius: 6px;
     cursor: pointer;
     transition: all 0.3s ease;
     appearance: none;
     position: relative;
 }

 .form-checkbox input[type="checkbox"]:checked {
     background: var(--primary-green);
     border-color: var(--primary-green);
 }

 .form-checkbox input[type="checkbox"]:checked::after {
     content: '\f00c';
     font-family: 'Font Awesome 5 Free';
     font-weight: 900;
     position: absolute;
     top: 50%;
     left: 50%;
     transform: translate(-50%, -50%);
     color: white;
     font-size: 12px;
 }

 .form-checkbox span {
     font-size: 15px;
     font-weight: 500;
     color: var(--text-primary);
 }

 /* ============================================================================
    LOADING & EMPTY STATES
    ============================================================================ */

 .loading-overlay {
     display: none;
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: rgba(0, 0, 0, 0.5);
     z-index: 9999;
     align-items: center;
     justify-content: center;
     backdrop-filter: blur(5px);
 }

 .loading-overlay.show {
     display: flex;
 }

 .loader {
     border: 8px solid rgba(255, 255, 255, 0.2);
     border-top: 8px solid var(--primary-green);
     border-radius: 50%;
     width: 60px;
     height: 60px;
     animation: spin 1s linear infinite;
 }

 @keyframes spin {
     to { transform: rotate(360deg); }
 }

 .empty-state {
     text-align: center;
     padding: 60px 20px;
     color: var(--text-secondary);
 }

 .empty-state i {
     font-size: 64px;
     margin-bottom: 20px;
     opacity: 0.5;
 }

 .empty-state p {
     font-size: 18px;
     margin-top: 12px;
 }

 /* ============================================================================
    TOAST NOTIFICATIONS
    ============================================================================ */

 .toast-container {
     position: fixed;
     top: 20px;
     right: 20px;
     z-index: 3000;
     display: flex;
     flex-direction: column;
     gap: 12px;
 }

 .toast {
     background: var(--card-bg);
     border-radius: 12px;
     padding: 16px 20px;
     box-shadow: var(--shadow-lg);
     border-left: 4px solid;
     animation: slideInRight 0.3s ease;
     max-width: 400px;
     display: flex;
     align-items: center;
     gap: 12px;
 }

 .toast.success { border-left-color: var(--success-color); }
 .toast.error { border-left-color: var(--error-color); }
 .toast.warning { border-left-color: var(--warning-color); }
 .toast.info { border-left-color: var(--info-color); }

 @keyframes slideInRight {
     from {
         opacity: 0;
         transform: translateX(100%);
     }
     to {
         opacity: 1;
         transform: translateX(0);
     }
 }

 .toast-icon {
     font-size: 20px;
 }

 .toast.success .toast-icon { color: var(--success-color); }
 .toast.error .toast-icon { color: var(--error-color); }
 .toast.warning .toast-icon { color: var(--warning-color); }
 .toast.info .toast-icon { color: var(--info-color); }

 .toast-message {
     color: var(--text-primary);
     font-weight: 500;
     font-size: 14px;
     flex: 1;
 }

 .toast-close {
     background: none;
     border: none;
     color: var(--text-secondary);
     cursor: pointer;
     padding: 4px;
     font-size: 18px;
     transition: all 0.3s ease;
 }

 .toast-close:hover {
     color: var(--text-primary);
 }

 /* ============================================================================
    SCROLLBAR STYLING
    ============================================================================ */

 ::-webkit-scrollbar {
     width: 8px;
     height: 8px;
 }

 ::-webkit-scrollbar-track {
     background: var(--bg-secondary);
 }

 ::-webkit-scrollbar-thumb {
     background: var(--primary-green);
     border-radius: 4px;
 }

 ::-webkit-scrollbar-thumb:hover {
     background: var(--primary-dark);
 }

 /* ============================================================================
    UTILITY CLASSES
    ============================================================================ */

 .text-center { text-align: center; }
 .text-left { text-align: left; }
 .text-right { text-align: right; }

 .mt-1 { margin-top: 8px; }
 .mt-2 { margin-top: 16px; }
 .mt-3 { margin-top: 24px; }
 .mt-4 { margin-top: 32px; }

 .mb-1 { margin-bottom: 8px; }
 .mb-2 { margin-bottom: 16px; }
 .mb-3 { margin-bottom: 24px; }
 .mb-4 { margin-bottom: 32px; }

 .p-1 { padding: 8px; }
 .p-2 { padding: 16px; }
 .p-3 { padding: 24px; }
 .p-4 { padding: 32px; }

 .flex { display: flex; }
 .flex-column { flex-direction: column; }
 .flex-wrap { flex-wrap: wrap; }
 .justify-between { justify-content: space-between; }
 .justify-center { justify-content: center; }
 .items-center { align-items: center; }
 .gap-1 { gap: 8px; }
 .gap-2 { gap: 16px; }
 .gap-3 { gap: 24px; }

 .w-full { width: 100%; }
 .h-full { height: 100%; }

 .rounded { border-radius: 8px; }
 .rounded-lg { border-radius: 12px; }
 .rounded-xl { border-radius: 16px; }

 .shadow { box-shadow: var(--shadow); }
 .shadow-lg { box-shadow: var(--shadow-lg); }

 .cursor-pointer { cursor: pointer; }

 .overflow-hidden { overflow: hidden; }
 .overflow-auto { overflow: auto; }

 .text-primary { color: var(--text-primary); }
 .text-secondary { color: var(--text-secondary); }
 .text-success { color: var(--success-color); }
 .text-warning { color: var(--warning-color); }
 .text-error { color: var(--error-color); }

 .bg-primary { background: var(--bg-primary); }
 .bg-secondary { background: var(--bg-secondary); }

 .font-bold { font-weight: 700; }
 .font-semibold { font-weight: 600; }
 .font-medium { font-weight: 500; }

 .text-xs { font-size: 12px; }
 .text-sm { font-size: 13px; }
 .text-base { font-size: 14px; }
 .text-lg { font-size: 16px; }
 .text-xl { font-size: 18px; }
 .text-2xl { font-size: 20px; }
 .text-3xl { font-size: 24px; }

 /* ============================================================================
    RESPONSIVE DESIGN
    ============================================================================ */

 @media (max-width: 1400px) {
     .charts-grid {
         grid-template-columns: 1fr;
     }
 }

 @media (max-width: 1200px) {
     .stats-grid {
         grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
     }
 }

 @media (max-width: 992px) {
     .header {
         padding: 0 20px;
     }

     .search-container {
         width: 250px;
     }

     .greeting-text {
         font-size: 20px;
     }

     .content {
         padding: 24px 20px;
     }

     .section-header {
         flex-direction: column;
         align-items: flex-start;
     }

     .section-header-right, .header-actions {
         width: 100%;
     }

     .cart-container {
         grid-template-columns: 1fr;
     }

     .products-grid {
         grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
         gap: 20px;
     }

     .farmers-grid {
         grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
     }

     .messages-container {
         grid-template-columns: 1fr;
         min-height: auto;
     }

     .chat-area {
         min-height: 420px;
     }
 }

 @media (max-width: 768px) {
     .sidebar {
         transform: translateX(-100%);
         width: 280px;
     }

     .sidebar.mobile-open {
         transform: translateX(0);
     }

     .main-content {
         margin-left: 0;
         width: 100%;
     }

     .header {
         height: auto;
         padding: 16px;
         flex-direction: column;
         gap: 16px;
     }

     .header-left {
         width: 100%;
         justify-content: space-between;
     }

     .search-container {
         width: 100%;
         order: 3;
     }

     .header-right {
         width: 100%;
         justify-content: space-between;
     }

     .greeting-section {
         flex: 1;
     }

     .greeting-text {
         font-size: 18px;
     }

     .current-date {
         font-size: 12px;
     }

     .profile-info {
         display: none;
     }

     .content {
         padding: 20px 16px;
     }

     .section-title {
         font-size: 24px;
     }

     .stats-grid {
         grid-template-columns: 1fr;
         gap: 16px;
     }

     .charts-grid {
         grid-template-columns: 1fr;
     }

     .chart-container {
         height: 250px;
     }

     .charts-grid {
         grid-template-columns: 1fr;
     }

     .filter-section {
         padding: 16px;
     }

     .filter-controls {
         flex-direction: column;
     }

     .filter-select, .date-input {
         width: 100%;
         min-width: 0;
     }

     .section-header-right, .header-actions {
         flex-direction: column;
         width: 100%;
     }

     .section-header-right .btn, .header-actions .btn {
         width: 100%;
         justify-content: center;
     }

     .products-grid {
         grid-template-columns: 1fr;
     }

     .farmers-grid {
         grid-template-columns: 1fr;
     }

     .quality-cards {
         grid-template-columns: 1fr;
     }

     .conversations-list {
         max-height: 280px;
     }

     .modal-content {
         width: 95%;
         padding: 24px 20px;
         max-height: 95vh;
     }

     .modal-title {
         font-size: 20px;
     }

     .table-responsive {
         overflow-x: auto;
     }

     .data-table {
         min-width: 600px;
     }

     .form-grid {
         grid-template-columns: 1fr;
     }

     .modal-footer {
         flex-direction: column-reverse;
     }

     .modal-footer .btn {
         width: 100%;
         justify-content: center;
     }
 }

 @media (max-width: 480px) {
     .stat-value {
         font-size: 28px;
     }

     .toast {
         max-width: calc(100vw - 40px);
     }

     .toast-container {
         left: 20px;
         right: 20px;
     }

     .notification-dropdown {
         width: calc(100vw - 40px);
         max-width: 400px;
         right: -20px;
     }
 }

 /* ============================================================================
    PRINT STYLES
    ============================================================================ */

 @media print {
     .sidebar,
     .header,
     .filter-section,
     .section-header-right,
     .btn,
     .modal,
     .toast-container,
     .loading-overlay {
         display: none !important;
     }

     .main-content {
         margin-left: 0;
         width: 100%;
     }

     .content {
         padding: 0;
     }

     .stat-card,
     .chart-card,
     .data-card {
         box-shadow: none;
         border: 1px solid #ddd;
         page-break-inside: avoid;
     }
 }

 /* ============================================================================
    DARK MODE ADJUSTMENTS
    ============================================================================ */

 .dark-mode .nav-link:hover {
     background: rgba(34, 197, 94, 0.15);
 }

 .dark-mode .data-table tr:hover {
     background: rgba(34, 197, 94, 0.1);
 }

 .dark-mode .search-input,
 .dark-mode .filter-select,
 .dark-mode .date-input,
 .dark-mode .form-input,
 .dark-mode .form-select {
     background: var(--bg-primary);
 }

 .dark-mode .loader {
     border-color: rgba(255, 255, 255, 0.1);
     border-top-color: var(--primary-green);
 }

 .dark-mode .notification-dropdown {
     background: var(--card-bg);
     border-color: var(--border-color);
     box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 4px 12px rgba(0,0,0,0.2);
 }

 .dark-mode .notification-dropdown-header {
     background: linear-gradient(135deg, #1f5a38 0%, #166534 100%);
 }

 .dark-mode .notification-item {
     border-bottom-color: var(--border-color);
 }

 .dark-mode .notification-item:hover {
     background: var(--hover-bg);
 }

 /* ============================================================================
    ANIMATIONS
    ============================================================================ */

 @keyframes fadeInUp {
     from {
         opacity: 0;
         transform: translateY(20px);
     }
     to {
         opacity: 1;
         transform: translateY(0);
     }
 }

 .animate-in {
     animation: fadeInUp 0.5s ease;
 }

 /* ============================================================================
    QUALITY – Cards & Reports
    ============================================================================ */

 .quality-cards {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
     gap: 24px;
     margin-bottom: 32px;
 }

 .info-card {
     background: var(--card-bg);
     padding: 32px;
     border-radius: 18px;
     box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(34, 197, 94, 0.04);
     border: 1px solid rgba(34, 197, 94, 0.08);
     text-align: center;
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
 }

 .info-card:hover {
     transform: translateY(-6px);
     box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1), 0 6px 16px rgba(34, 197, 94, 0.12);
     border-color: rgba(34, 197, 94, 0.2);
 }

 .info-icon {
     width: 72px;
     height: 72px;
     margin: 0 auto 20px;
     background: var(--gradient-primary);
     border-radius: 50%;
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 1.75rem;
     color: white;
     box-shadow: 0 6px 20px rgba(34, 197, 94, 0.35);
 }

 .info-card h3 {
     font-size: 1.15rem;
     font-weight: 700;
     color: var(--text-primary);
     margin-bottom: 10px;
 }

 .info-card p {
     font-size: 0.95rem;
     color: var(--text-secondary);
     line-height: 1.6;
 }

 .quality-reports-block {
     background: var(--card-bg);
     border-radius: 18px;
     box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
     overflow: hidden;
     margin-top: 28px;
     border: 1px solid rgba(34, 197, 94, 0.08);
 }

 .quality-reports-header {
     background: var(--gradient-primary);
     color: white;
     padding: 20px 24px;
     display: flex;
     justify-content: space-between;
     align-items: center;
     flex-wrap: wrap;
     gap: 12px;
 }

 .quality-reports-header h3 {
     margin: 0;
     font-size: 1.25rem;
     font-weight: 700;
     display: flex;
     align-items: center;
     gap: 10px;
 }

 .quality-reports-list {
     padding: 24px;
 }

 /* ============================================================================
    MESSAGES – Chat layout
    ============================================================================ */

 .messages-container {
     display: grid;
     grid-template-columns: 360px 1fr;
     gap: 0;
     min-height: 560px;
     background: var(--card-bg);
     border-radius: 18px;
     box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
     border: 1px solid rgba(34, 197, 94, 0.08);
     overflow: hidden;
 }

 .conversations-list {
     border-right: 1px solid var(--border-color);
     display: flex;
     flex-direction: column;
     background: linear-gradient(180deg, #fafcfb 0%, #f5f9f6 100%);
 }

 .dark-mode .conversations-list {
     background: rgba(34, 197, 94, 0.04);
 }

 .conversations-header {
     padding: 16px 20px;
     border-bottom: 1px solid var(--border-color);
 }

 .conversations-header .search-input {
     width: 100%;
     padding: 12px 16px 12px 44px;
     border-radius: 12px;
     border: 2px solid var(--border-color);
     font-size: 0.9rem;
 }

 .conversations {
     flex: 1;
     overflow-y: auto;
     padding: 8px;
 }

 .chat-area {
     display: flex;
     flex-direction: column;
     min-height: 560px;
 }

 .chat-header {
     padding: 20px 24px;
     border-bottom: 1px solid var(--border-color);
     background: linear-gradient(180deg, #fafcfb 0%, #f5f9f6 100%);
 }

 .dark-mode .chat-header {
     background: rgba(34, 197, 94, 0.04);
 }

 .chat-user-info {
     display: flex;
     align-items: center;
     gap: 14px;
 }

 .chat-avatar {
     width: 48px;
     height: 48px;
     border-radius: 50%;
     object-fit: cover;
     border: 2px solid rgba(34, 197, 94, 0.2);
 }

 .chat-user-name {
     font-size: 1.1rem;
     font-weight: 700;
     color: var(--text-primary);
     margin: 0 0 4px 0;
 }

 .chat-user-status {
     font-size: 0.85rem;
     color: var(--text-secondary);
     margin: 0;
 }

 .chat-messages {
     flex: 1;
     overflow-y: auto;
     padding: 24px;
     background: linear-gradient(180deg, #f8faf9 0%, #f0f7f4 50%);
 }

 .dark-mode .chat-messages {
     background: var(--bg-secondary);
 }

 .chat-input-area {
     display: flex;
     gap: 12px;
     padding: 20px 24px;
     border-top: 1px solid var(--border-color);
     background: var(--card-bg);
 }

 .chat-input {
     flex: 1;
     padding: 14px 20px;
     border: 2px solid var(--border-color);
     border-radius: 14px;
     font-size: 1rem;
     transition: all 0.2s ease;
 }

 .chat-input:focus {
     outline: none;
     border-color: var(--primary-green);
     box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
 }

 /* ============================================================================
    EMPTY & LOADING STATES
    ============================================================================ */

 .empty-state {
     text-align: center;
     padding: 60px 32px;
     background: var(--card-bg);
     border-radius: 18px;
     border: 2px dashed rgba(34, 197, 94, 0.2);
 }

 .empty-state i {
     font-size: 3.5rem;
     color: var(--primary-green);
     opacity: 0.5;
     margin-bottom: 16px;
     display: block;
 }

 .empty-state p {
     font-size: 1.1rem;
     color: var(--text-secondary);
     font-weight: 500;
     margin: 0;
 }

 .empty-state .btn {
     margin-top: 20px;
 }

 /* Transaction / Order / Tracking cards (generic list cards) */
 .transaction-card, .order-card, .tracking-card {
     background: var(--card-bg);
     border-radius: 16px;
     padding: 20px 24px;
     box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
     border: 1px solid rgba(34, 197, 94, 0.08);
     transition: all 0.2s ease;
 }

 .transaction-card:hover, .order-card:hover, .tracking-card:hover {
     box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
     border-color: rgba(34, 197, 94, 0.15);
 }

 /* ============================================================================
    REPORTS – Report cards grid
    ============================================================================ */

 .reports-charts-grid {
     display: grid;
     grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
     gap: 24px;
     margin-top: 24px;
 }

 .report-card {
     background: var(--card-bg);
     border-radius: var(--radius-lg);
     box-shadow: var(--shadow-sm);
     overflow: hidden;
     border: 1px solid rgba(34, 197, 94, 0.08);
     transition: all 0.3s ease;
 }

 .report-card:hover {
     box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
 }

 .section-header .search-input, .header-actions .search-input {
     max-width: 320px;
     min-width: 200px;
 }

 /* ============================================================================
    END OF BUYER.CSS
    ============================================================================ */


    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>





<div class="dashboard-container">
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo" style="width: 45px; height: 45px; background: none; animation: none; box-shadow: none;">
                <img src="images/logo.jpeg" alt="AgriGuard AI Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
            </div>
            <div class="company-info">
                <div class="company-name">AgriGuard AI</div>
                <div class="company-tagline">Buyer Portal</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">Main</h3>
                <ul class="nav-menu">
                    <li class="nav-item active" data-section="overview">
                        <a class="nav-link" href="#overview" data-section="overview">
                            <i class="fas fa-chart-line"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item" data-section="marketplace">
                        <a class="nav-link" href="#marketplace" data-section="marketplace">
                            <i class="fas fa-store"></i>
                            <span>Marketplace</span>
                        </a>
                    </li>
                    <li class="nav-item" data-section="orders">
                        <a class="nav-link" href="#orders" data-section="orders">
                            <i class="fas fa-shopping-cart"></i>
                            <span>My Orders</span>
                        </a>
                    </li>
                    <li class="nav-item" data-section="cart">
                        <a class="nav-link" href="#cart" data-section="cart">
                            <i class="fas fa-shopping-basket"></i>
                            <span>Shopping Cart</span>
                            <span class="notification-badge nav-badge" id="cartBadge" style="position: absolute; right: 1rem; min-width: 20px; text-align: center;">0</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-section-title">Transactions</h3>
                <ul class="nav-menu">
                    <li class="nav-item" data-section="transactions">
                        <a class="nav-link" href="#transactions" data-section="transactions">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Transactions</span>
                        </a>
                    </li>
                    <li class="nav-item" data-section="tracking">
                        <a class="nav-link" href="#tracking" data-section="tracking">
                            <i class="fas fa-truck"></i>
                            <span>Delivery Tracking</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-section-title">Quality</h3>
                <ul class="nav-menu">
                    <li class="nav-item" data-section="quality">
                        <a class="nav-link" href="#quality" data-section="quality">
                            <i class="fas fa-certificate"></i>
                            <span>Quality Assurance</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-section-title">Communication</h3>
                <ul class="nav-menu">
                    <li class="nav-item" data-section="farmers">
                        <a class="nav-link" href="#farmers" data-section="farmers">
                            <i class="fas fa-users"></i>
                            <span>Farmers</span>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="WhatsAppFarmerBuyer.html">
                            <i class="fas fa-envelope"></i>
                            <span>Chat</span>

                        </a>
                    </li>
                </ul>
            </div>
            <div class="nav-section">
                <h3 class="nav-section-title">Reports</h3>
                <ul class="nav-menu">
                    <li class="nav-item" data-section="reports">
                        <a class="nav-link" href="#reports" data-section="reports">
                            <i class="fas fa-chart-bar"></i>
                            <span>Reports & Analytics</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="greeting-section">
                    <div class="greeting-text" id="greetingText">Good Morning, Buyer!</div>
                    <div class="current-date" id="currentDate"></div>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search products, orders, farmers..." id="globalSearch" onkeyup="handleGlobalSearch()">
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="header-right">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                    <span>Dark Mode</span>
                </button>
                <div class="notifications" style="position: relative;">
                    <button class="notification-btn" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationsDropdown" style="display: none;">
                        <div class="notification-dropdown-header">
                            <h3><i class="fas fa-bell"></i> Notifications</h3>
                            <button class="mark-read-btn" onclick="markAllNotificationsRead()">Mark all read</button>
                        </div>
                        <div id="notificationsList" class="notification-dropdown-body">
                            <!-- Notifications will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="profile-section" id="profileSection">
                    <div class="profile-avatar" id="profileAvatar">B</div>
                    <div class="profile-info">
                        <div class="profile-name" id="profileName">Buyer</div>
                        <div class="profile-role" id="profileRole">Buyer</div>
                    </div>
                    <button class="logout-btn" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Sections -->
        <main class="content">
        <!-- Overview Section -->
        <section class="content-section active" id="overview">
            <div class="section-header">
                <h1>Buyer Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary">
                        <i class="fas fa-download"></i>
                        Export Report
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Total Orders</p>
                        <h2 class="stat-value" id="totalOrders">0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="ordersChange">0%</span> from last month
                        </p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Completed Orders</p>
                        <h2 class="stat-value" id="completedOrders">0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="completedChange">0%</span> from last month
                        </p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Pending Orders</p>
                        <h2 class="stat-value" id="pendingOrders">0</h2>
                        <p class="stat-change">
                            <span id="pendingChange">0</span> awaiting confirmation
                        </p>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon purple">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Total Spent</p>
                        <h2 class="stat-value" id="totalSpent">$0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="spentChange">0%</span> from last month
                        </p>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3><i class="fas fa-chart-line"></i> Purchasing Trends</h3>
                        <select class="chart-filter" id="purchasingChartFilter">
                            <option value="week">Last 7 Days</option>
                            <option value="month" selected>Last 30 Days</option>
                            <option value="year">Last Year</option>
                        </select>
                    </div>
                    <div class="chart-container chart-container-line" id="purchasingChart">
                        <canvas id="purchasingChartCanvas"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3><i class="fas fa-pie-chart"></i> Order Status Distribution</h3>
                    </div>
                    <div class="chart-container chart-container-doughnut" id="orderStatusChart">
                        <canvas id="orderStatusChartCanvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="data-card">
                <div class="card-header">
                    <h3>Recent Orders</h3>
                    <a href="#orders" class="link-btn">View All</a>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Farmer</th>
                            <th>Products</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="recentOrdersTable">
                        <!-- Orders will be loaded from backend -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Marketplace Section -->
        <section class="content-section" id="marketplace">
            <div class="section-header">
                <h1>Marketplace</h1>
                <div class="header-actions">
                    <div class="filter-group">
                        <select class="filter-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            <!-- Categories will be loaded from backend -->
                        </select>
                        <select class="filter-select" id="sortFilter">
                            <option value="newest">Newest First</option>
                            <option value="price-low">Price: Low to High</option>
                            <option value="price-high">Price: High to Low</option>
                            <option value="rating">Highest Rated</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="products-grid" id="productsGrid">
                <!-- Products will be loaded from backend -->
            </div>
        </section>

        <!-- Orders Section -->
        <section class="content-section" id="orders">
            <div class="section-header">
                <h1>My Orders</h1>
                <div class="header-actions">
                    <div class="filter-tabs">
                        <button class="tab-btn active" data-status="all">All</button>
                        <button class="tab-btn" data-status="pending">Pending</button>
                        <button class="tab-btn" data-status="confirmed">Confirmed</button>
                        <button class="tab-btn" data-status="shipped">Shipped</button>
                        <button class="tab-btn" data-status="delivered">Delivered</button>
                        <button class="tab-btn" data-status="cancelled">Cancelled</button>
                    </div>
                </div>
            </div>

            <div class="orders-list" id="ordersList">
                <!-- Orders will be loaded from backend -->
            </div>
        </section>

        <!-- Shopping Cart Section -->
        <section class="content-section" id="cart">
            <div class="section-header">
                <h1>Shopping Cart</h1>
            </div>

            <div class="cart-container">
                <div class="cart-items" id="cartItems">
                    <!-- Cart items will be loaded from backend -->
                </div>

                <div class="cart-summary">
                    <h3>Order Summary</h3>
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="cartSubtotal">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Shipping:</span>
                        <span id="cartShipping">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax:</span>
                        <span id="cartTax">$0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="cartTotal">$0.00</span>
                    </div>
                    <button class="btn btn-primary btn-block" id="checkoutBtn">
                        <i class="fas fa-lock"></i>
                        Proceed to Checkout
                    </button>
                </div>
            </div>
        </section>

        <!-- Transactions Section -->
        <section class="content-section" id="transactions">
            <div class="section-header">
                <h1><i class="fas fa-exchange-alt"></i> Transactions</h1>
                <div class="header-actions">
                    <div class="filter-group" style="display: flex; gap: 0.5rem; align-items: center;">
                        <select class="filter-select" id="transactionStatusFilter" style="min-width: 150px;">
                            <option value="">All Status</option>
                            <option value="COMPLETED">Completed</option>
                            <option value="PENDING">Pending</option>
                            <option value="FAILED">Failed</option>
                        </select>
                        <input type="date" class="date-input" id="transactionDateFilter">
                        <button class="btn btn-secondary">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Completed</p>
                        <h2 class="stat-value" id="completedTransactions">0</h2>
                        <p class="stat-change positive">This month</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Pending</p>
                        <h2 class="stat-value" id="pendingTransactions">0</h2>
                        <p class="stat-change">Awaiting processing</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon blue">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Total Volume</p>
                        <h2 class="stat-value" id="totalTransactionVolume">RF 0</h2>
                        <p class="stat-change positive">All time</p>
                    </div>
                </div>
            </div>

            <!-- Transactions List -->
            <div class="transactions-list" id="transactionsList">
                <!-- Transactions will be loaded here -->
            </div>
        </section>


        <!-- Farmers Section -->
        <section class="content-section" id="farmers">
            <div class="section-header">
                <h1>Farmers</h1>
                <div class="header-actions">
                    <input type="text" class="search-input" placeholder="Search farmers..." id="farmerSearch" onkeyup="handleFarmerSearch(event)" oninput="handleFarmerSearch(event)">
                </div>
            </div>

            <div class="farmers-grid" id="farmersGrid">
                <!-- Farmers will be loaded from backend -->
            </div>
        </section>

        <!-- Delivery Tracking Section -->
        <section class="content-section" id="tracking">
            <div class="section-header">
                <h1>Delivery Tracking</h1>
                <div class="header-actions">
                    <input type="text" class="search-input" placeholder="Enter order ID or tracking number..." id="trackingSearch" onkeyup="if(event.key==='Enter') searchTrackingOrder()">
                    <button class="btn btn-primary" onclick="searchTrackingOrder()">
                        <i class="fas fa-search"></i>
                        Track
                    </button>
                </div>
            </div>

            <div class="tracking-list" id="trackingList">
                <!-- Tracking information will be loaded from backend -->
            </div>
        </section>



        <!-- Quality Assurance Section -->
        <section class="content-section" id="quality">
            <div class="section-header">
                <h1>Quality Assurance</h1>
            </div>

            <!-- KEEP ORIGINAL DESIGN FOR THESE CARDS -->
            <div class="quality-cards">
                <div class="info-card">
                    <div class="info-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3>Quality Certifications</h3>
                    <p>All products are certified and meet quality standards</p>
                </div>
                <div class="info-card">
                    <div class="info-icon">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <h3>Organic Verification</h3>
                    <p>Verified organic products with certifications</p>
                </div>
                <div class="info-card">
                    <div class="info-icon">
                        <i class="fas fa-microscope"></i>
                    </div>
                    <h3>Lab Testing</h3>
                    <p>Regular lab testing for quality assurance</p>
                </div>
            </div>

            <!-- Quality Reports Section -->
            <div class="quality-reports-block">
                <div class="quality-reports-header">
                    <h3><i class="fas fa-clipboard-check"></i> Quality Reports</h3>
                    <button class="btn btn-secondary" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        <i class="fas fa-filter"></i> Filter Reports
                    </button>
                </div>
                <div class="quality-reports-list" id="qualityReportsList">
                    <!-- Quality reports will be loaded here -->
                </div>
            </div>
        </section>





        <!-- Messages Section -->
        <section class="content-section" id="messages">
            <div class="section-header">
                <h1>Messages</h1>
                <div class="header-actions">
                    <button class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        New Message
                    </button>
                </div>
            </div>

            <div class="messages-container">
                <div class="conversations-list">
                    <div class="conversations-header">
                        <input type="text" class="search-input" placeholder="Search conversations...">
                    </div>
                    <div class="conversations" id="conversationsList">
                        <!-- Conversations will be loaded from backend -->
                    </div>
                </div>

                <div class="chat-area">
                    <div class="chat-header">
                        <div class="chat-user-info">
                            <img src="" alt="" class="chat-avatar">
                            <div>
                                <h4 class="chat-user-name">Select a conversation</h4>
                                <p class="chat-user-status">...</p>
                            </div>
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <!-- Messages will be loaded from backend -->
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" placeholder="Type a message..." id="messageInput">
                        <button class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>





        <!-- Reports Section -->
        <section class="content-section" id="reports">
            <div class="section-header">
                <h1><i class="fas fa-chart-line"></i> Reports & Analytics</h1>
                <div class="header-actions">
                    <select class="filter-select" id="reportsPeriodFilter" style="min-width: 150px;" onchange="handleReportsPeriodChange()">
                        <option value="week">Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                        <option value="quarter">Last Quarter</option>
                        <option value="year">Last Year</option>
                        <option value="all">All Time</option>
                    </select>
                    <button class="btn btn-secondary" onclick="exportReportsToPDF()">
                        <i class="fas fa-download"></i>
                        Export
                    </button>
                </div>
            </div>

            <!-- Key Metrics Summary -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card" style="background: white; border-left: 4px solid var(--primary-color);">
                    <div class="stat-icon green">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Total Spending</p>
                        <h2 class="stat-value" style="color: var(--primary-color);" id="reportTotalSpending">RF 0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="reportSpendingChange">0%</span> vs last period
                        </p>
                    </div>
                </div>

                <div class="stat-card" style="background: white; border-left: 4px solid var(--primary-color);">
                    <div class="stat-icon green">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Total Orders</p>
                        <h2 class="stat-value" style="color: var(--primary-color);" id="reportTotalOrders">0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="reportOrdersChange">0%</span> vs last period
                        </p>
                    </div>
                </div>

                <div class="stat-card" style="background: white; border-left: 4px solid var(--primary-color);">
                    <div class="stat-icon green">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Avg Order Value</p>
                        <h2 class="stat-value" style="color: var(--primary-color);" id="reportAvgOrder">RF 0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span id="reportAvgChange">0%</span> vs last period
                        </p>
                    </div>
                </div>

                <div class="stat-card" style="background: white; border-left: 4px solid var(--primary-color);">
                    <div class="stat-icon green">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-details">
                        <p class="stat-label">Active Farmers</p>
                        <h2 class="stat-value" style="color: var(--primary-color);" id="reportActiveFarmers">0</h2>
                        <p class="stat-change">
                            <span id="reportFarmersCount">0</span> suppliers
                        </p>
                    </div>
                </div>
            </div>

            <!-- Charts Grid - First Row -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                <!-- Spending Analysis Chart -->
                <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                    <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-chart-line"></i> Spending Analysis
                        </h3>
                        <select class="filter-select" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                            <option value="daily">Daily</option>
                            <option value="weekly" selected>Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    <div class="chart-container" id="spendingChart" style="padding: 1.5rem; min-height: 350px;">
                        <canvas id="spendingChartCanvas"></canvas>
                    </div>
                </div>

                <!-- Product Categories Pie Chart -->
                <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                    <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem;">
                        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-chart-pie"></i> Product Categories
                        </h3>
                    </div>
                    <div class="chart-container" id="categoriesChart" style="padding: 1.5rem; min-height: 350px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="categoriesChartCanvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Grid - Second Row -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                <!-- Top Farmers -->
                <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                    <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem;">
                        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-trophy"></i> Top Farmers
                        </h3>
                    </div>
                    <div id="topFarmersChart" style="padding: 1.5rem;">
                        <!-- Top farmers list will be rendered here -->
                    </div>
                </div>

                <!-- Order Status Distribution -->
                <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                    <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem;">
                        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-tasks"></i> Order Status
                        </h3>
                    </div>
                    <div class="chart-container" id="orderStatusChartReport" style="padding: 1.5rem; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="orderStatusChartCanvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Grid - Third Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                <!-- Monthly Trends -->
                <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                    <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem;">
                        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-calendar-alt"></i> Monthly Trends
                        </h3>
                    </div>
                    <div class="chart-container" id="trendsChart" style="padding: 1.5rem; min-height: 300px;">
                        <canvas id="trendsChartCanvas"></canvas>
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                    <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem;">
                        <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-credit-card"></i> Payment Methods
                        </h3>
                    </div>
                    <div class="chart-container" id="paymentMethodsChart" style="padding: 1.5rem; min-height: 300px; display: flex; align-items: center; justify-content: center;">
                        <canvas id="paymentMethodsChartCanvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Table -->
            <div class="report-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden;">
                <div style="background: var(--primary-color); color: white; padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-history"></i> Recent Activity
                    </h3>
                    <button class="btn btn-secondary" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.5rem 1rem;">
                        <i class="fas fa-eye"></i> View All
                    </button>
                </div>
                <div id="recentActivityTable" style="padding: 1.5rem;">
                    <!-- Recent activity will be rendered here -->
                </div>
            </div>
        </section>
        </main>
    </div>
</div>





<!-- Scripts -->
<script src="js/SessionTracker.js"></script>
<script src="js/user_session_handler.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>






    // BuyerDashboard.js - Complete JavaScript for Buyer Dashboard
  // Author: AgriGuard AI Development Team
  // Description: Handles all buyer dashboard functionality with real backend data

  // ==================== CONSTANTS & CONFIGURATION ====================
  const API_BASE_URL = 'http://localhost:1010/api';
  const ENDPOINTS = {
      // User endpoints
      users: `${API_BASE_URL}/users`,
      profile: (id) => `${API_BASE_URL}/users/${id}`,


 // Crop Production endpoints
    cropProductions: `${API_BASE_URL}/v1/crop-productions`,
    cropProductionById: (id) => `${API_BASE_URL}/v1/crop-productions/${id}`,
    cropProductionsByCrop: (cropId) => `${API_BASE_URL}/v1/crop-productions/crop/${cropId}`,
    cropProductionsByFarm: (farmId) => `${API_BASE_URL}/v1/crop-productions/farm/${farmId}`,
    // AJOUT: Nouvel endpoint pour farmer
    cropProductionsByFarmer: (farmerId) => `${API_BASE_URL}/v1/crop-productions/farmer/${farmerId}`,
    cropProductionsActive: `${API_BASE_URL}/v1/crop-productions/active`,

      // Crops endpoints
      crops: `${API_BASE_URL}/v1/crops`,
      cropsAll: `${API_BASE_URL}/v1/crops/all`,
      cropById: (id) => `${API_BASE_URL}/v1/crops/${id}`,
      cropsByType: (type) => `${API_BASE_URL}/v1/crops/type/${type}`,

      // Transactions endpoints
      transactions: `${API_BASE_URL}/transactions`,
      transactionById: (id) => `${API_BASE_URL}/transactions/${id}`,
      transactionsByBuyer: (buyerId) => `${API_BASE_URL}/transactions/buyer/${buyerId}`,
      transactionsByBuyerAndStatus: (buyerId, status) => `${API_BASE_URL}/transactions/buyer/${buyerId}/status/${status}`,
      buyerAnalytics: (buyerId) => `${API_BASE_URL}/transactions/buyer/${buyerId}/analytics`,

      // Market Price endpoints
      marketPrices: `${API_BASE_URL}/market-prices`,
      marketPricesByCrop: (cropId) => `${API_BASE_URL}/market-prices/crop/${cropId}`,
      latestMarketPrice: (cropId) => `${API_BASE_URL}/market-prices/crop/${cropId}/latest`,
      recentMarketPrices: (cropId, days) => `${API_BASE_URL}/market-prices/crop/${cropId}/recent?days=${days}`,
      marketOpportunities: `${API_BASE_URL}/market-prices/opportunities`,

      // Supply Chain endpoints
      supplyChain: `${API_BASE_URL}/supply-chain`,
      supplyChainByTransaction: (transactionId) => `${API_BASE_URL}/supply-chain/transaction/${transactionId}`,
      supplyChainTracking: (trackingCode) => `${API_BASE_URL}/supply-chain/track/${trackingCode}`,
  };

  // ==================== STATE MANAGEMENT ====================
  let currentUser = null;
  let shoppingCart = [];
  let notifications = [];
  let conversations = [];
  let currentSection = 'overview';
  let purchasingChartInstance = null;
  let orderStatusChartInstance = null;

  // ==================== UTILITY FUNCTIONS ====================
  // Get Auth Token from localStorage
  function getAuthToken() {
      const sessionHandler = window.UserSessionHandler ? window.UserSessionHandler.getInstance() : null;
      if (sessionHandler) {
          return sessionHandler.getAuthToken();
      }
      return localStorage.getItem('agriguard_jwt_token');
  }


  // Get Current User from UserSessionHandler
  function getCurrentUser() {
      const sessionHandler = window.UserSessionHandler ? window.UserSessionHandler.getInstance() : null;

      if (sessionHandler) {
          const user = sessionHandler.getCurrentUser();
          if (user && user.role === 'BUYER') {
              return user;
          }
      }

      console.error('Unable to get buyer user session');
      return null;
  }



async function apiCall(url, options = {}) {
    const token = getAuthToken();

    if (!token) {
        console.error('No authentication token found');
        handleUnauthorized();
        throw new Error('Authentication required');
    }

    const defaultHeaders = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };

    try {
        console.log('=== API CALL ===');
        console.log('URL:', url);
        console.log('Method:', options.method || 'GET');

        const response = await fetch(url, {
            ...options,
            headers: {
                ...defaultHeaders,
                ...options.headers
            }
        });

        // ⭐ CRITICAL FIX: Handle 401 Unauthorized with session refresh
        if (response.status === 401) {
            console.error('Authentication failed (401)');

            // Try to refresh the token
            const refreshResult = await refreshAuthToken();

            if (refreshResult) {
                // Retry the request with new token
                const newToken = getAuthToken();
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${newToken}`
                };

                const retryResponse = await fetch(url, {
                    ...options,
                    headers: options.headers
                });

                if (!retryResponse.ok) {
                    throw new Error(`HTTP error ${retryResponse.status}`);
                }
                return await retryResponse.json();
            }

            handleUnauthorized();
            throw new Error('Authentication failed');
        }

        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }

        return await response.json();

    } catch (error) {
        console.error('API call error:', error);
        throw error;
    }
}

// Add token refresh function
async function refreshAuthToken() {
    try {
        const sessionHandler = window.UserSessionHandler?.getInstance();
        if (sessionHandler && typeof sessionHandler.refreshToken === 'function') {
            return await sessionHandler.refreshToken();
        }
        return false;
    } catch (error) {
        console.error('Token refresh failed:', error);
        return false;
    }
}




  // Handle unauthorized access
  function handleUnauthorized() {
      const sessionHandler = window.UserSessionHandler ? window.UserSessionHandler.getInstance() : null;

      if (sessionHandler) {
          sessionHandler.clearSession();
      }

      if (window.sessionTracker && currentUser) {
          window.sessionTracker.endSession(currentUser.id || currentUser.userId);
      }

      showNotification('Session expired. Please login again.', 'error');

      setTimeout(() => {
          window.location.href = '/login.html';
      }, 1500);
  }

  // Format currency
  function formatCurrency(amount) {
      return new Intl.NumberFormat('en-RW', {
          style: 'currency',
          currency: 'RWF',
          minimumFractionDigits: 0
      }).format(amount);
  }

  // Format date
  function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
      });
  }

  // Format datetime
  function formatDateTime(dateString) {
      return new Date(dateString).toLocaleString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
      });
  }

  // Show notification/toast
  function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.innerHTML = `
          <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
          <span>${message}</span>
      `;
      document.body.appendChild(notification);

      setTimeout(() => {
          notification.classList.add('show');
      }, 100);

      setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
      }, 3000);
  }


  // Initialize dashboard on page load
  document.addEventListener('DOMContentLoaded', async () => {
      try {
          console.log('Dashboard loading...');

          // Verify UserSessionHandler is available
          if (!window.UserSessionHandler) {
              console.error('UserSessionHandler not loaded');
              showNotification('System initialization failed. Please refresh.', 'error');
              return;
          }

          // Get session handler instance
          const sessionHandler = window.UserSessionHandler.getInstance();

          // Check authentication
          if (!sessionHandler.isAuthenticated()) {
              console.error('User not authenticated');
              showNotification('Please login to continue', 'error');
              setTimeout(() => {
                  window.location.href = '/login.html';
              }, 1500);
              return;
          }

          // Get current user
          currentUser = sessionHandler.getCurrentUser();

          if (!currentUser) {
              console.error('No user data found');
              showNotification('Session expired. Please login again.', 'error');
              setTimeout(() => {
                  window.location.href = '/login.html';
              }, 1500);
              return;
          }

          // Verify user role
          if (currentUser.role !== 'BUYER') {
              console.error('Invalid role for buyer dashboard:', currentUser.role);
              showNotification('Access denied. This dashboard is for buyers only.', 'error');
              setTimeout(() => {
                  const redirectUrls = {
                      'FARMER': '/farmer-dashboard.html',
                      'ADMIN': '/admin-dashboard.html',
                      'ANALYST': '/analyst-dashboard.html',
                      'GOVERNMENT': '/government-dashboard.html'
                  };
                  window.location.href = redirectUrls[currentUser.role] || '/login.html';
              }, 2000);
              return;
          }

          console.log('User verified:', currentUser);

          // Update activity in session tracker
          if (window.sessionTracker) {
              window.sessionTracker.updateLastActivity(currentUser.id || currentUser.userId);
          }

          // Initialize UI
          initializeUI();

          // Load initial data
          await loadDashboardData();

          // Setup event listeners
          setupEventListeners();

          // Start periodic updates
          startPeriodicUpdates();
              // Setup messages navigation
    setupMessagesNavigation();




      } catch (error) {
          console.error('Initialization error:', error);
          showNotification('Failed to initialize dashboard: ' + error.message, 'error');
      }
  });


// Make functions globally available
window.navigateToMessages = navigateToMessages;


console.log('✅ Messages navigation module loaded');

// Initialize UI elements
function initializeUI() {
    // Get session handler
    const sessionHandler = window.UserSessionHandler ? window.UserSessionHandler.getInstance() : null;

    if (!sessionHandler) {
        console.error('UserSessionHandler not available');
        showNotification('System error. Please refresh the page.', 'error');
        return;
    }

    // Get current user from session handler
    currentUser = sessionHandler.getCurrentUser();

    // Verify user exists and has BUYER role
    if (!currentUser) {
        console.error('No user session found');
        showNotification('Session expired. Please login again.', 'error');
        setTimeout(() => {
            window.location.href = '/login.html';
        }, 2000);
        return;
    }

    if (currentUser.role !== 'BUYER') {
        console.error('User is not a buyer:', currentUser.role);
        showNotification('Access denied. This dashboard is for buyers only.', 'error');
        setTimeout(() => {
            const redirectUrls = {
                'FARMER': '/farmer-dashboard.html',
                'ADMIN': '/admin-dashboard.html',
                'ANALYST': '/analyst-dashboard.html',
                'GOVERNMENT': '/government-dashboard.html'
            };
            window.location.href = redirectUrls[currentUser.role] || '/login.html';
        }, 2000);
        return;
    }

    console.log('Current user loaded:', currentUser);

    // Update last activity
    sessionHandler.updateLastActivity();

    // Update user info in header
    updateUserInfo();

    // Set active section
    setActiveSection('overview');

    // Initialize shopping cart
    loadCartFromStorage();
}

// Update user info in header
function updateUserInfo() {
    if (!currentUser) return;

    const userName = document.getElementById('userName');
    const userAvatar = document.getElementById('userAvatar');

    if (userName) {
        userName.textContent = currentUser.fullName || currentUser.username;
    }

    if (userAvatar) {
        if (currentUser.profileImageUrl) {
            userAvatar.src = currentUser.profileImageUrl;
        } else {
            // Create initials avatar
            const initials = getInitials(currentUser.fullName || currentUser.username);
            userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=2563eb&color=fff`;
        }
    }
}

// Get initials from name
function getInitials(name) {
    return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
}

// Toggle sidebar (Farmer-style: collapse/expand)
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    if (sidebar) sidebar.classList.toggle('collapsed');
    if (mainContent) mainContent.classList.toggle('sidebar-collapsed');
}

// Theme toggle (Farmer-style dark mode)
function toggleTheme() {
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    const isDark = body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    if (themeToggle) {
        const icon = themeToggle.querySelector('i');
        const text = themeToggle.querySelector('span');
        if (icon) icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        if (text) text.textContent = isDark ? 'Light Mode' : 'Dark Mode';
    }
}
function loadThemePreference() {
    const theme = localStorage.getItem('theme');
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    if (theme === 'dark') {
        body.classList.add('dark-mode');
        if (themeToggle) {
            const icon = themeToggle.querySelector('i');
            const text = themeToggle.querySelector('span');
            if (icon) icon.className = 'fas fa-sun';
            if (text) text.textContent = 'Light Mode';
        }
    }
}

function setupEventListeners() {
    // Sidebar toggle (header button - Farmer design)
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    if (sidebarToggle && sidebar && mainContent) {
        sidebarToggle.addEventListener('click', toggleSidebar);
    }

    // Navigation items
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const section = item.dataset.section;
            setActiveSection(section);
        });
    });

    // User dropdown
    const userBtn = document.getElementById('userBtn');
    const userDropdown = document.getElementById('userDropdown');
    if (userBtn) {
        userBtn.addEventListener('click', () => {
            userDropdown.classList.toggle('show');
        });
    }

    // Theme toggle
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
        loadThemePreference();
    }

    // Notifications dropdown
    const notificationBtn = document.getElementById('notificationBtn');
    const notificationsDropdown = document.getElementById('notificationsDropdown');
    if (notificationBtn && notificationsDropdown) {
        notificationBtn.addEventListener('click', () => {
            notificationsDropdown.classList.toggle('show');
        });
    }

    // Logout button
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    }

    // Purchasing Trends filter
    const purchasingChartFilter = document.getElementById('purchasingChartFilter');
    if (purchasingChartFilter) {
        purchasingChartFilter.addEventListener('change', () => loadPurchasingTrendsChart());
    }

    // Search input
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(handleSearch, 300));
    }

    // Checkout button with event delegation
    document.addEventListener('click', (e) => {
        // Checkout button
        if (e.target.id === 'checkoutBtn' || e.target.closest('#checkoutBtn')) {
            e.preventDefault();
            console.log('Checkout button clicked!');
            console.log('Shopping cart:', shoppingCart);

            if (shoppingCart.length === 0) {
                showNotification('Your cart is empty', 'warning');
                return;
            }

            showOrderConfirmationModal(shoppingCart);
        }
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.user-menu')) {
            userDropdown?.classList.remove('show');
        }
        if (!e.target.closest('.notifications')) {
            notificationsDropdown?.classList.remove('show');
        }
    });
}

// Debounce function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Handle search
async function handleSearch(e) {
    const query = e.target.value.trim();
    if (!query) return;

    try {
        // Search in different sections based on current view
        if (currentSection === 'marketplace') {
            await searchProducts(query);
        } else if (currentSection === 'orders') {
            await searchOrders(query);
        } else if (currentSection === 'farmers') {
            await searchFarmers(query);
        }
    } catch (error) {
        console.error('Search error:', error);
    }
}




  // Handle logout
  function handleLogout(e) {
      e.preventDefault();

      const sessionHandler = window.UserSessionHandler ? window.UserSessionHandler.getInstance() : null;

      if (sessionHandler) {
          // End session in tracker
          if (window.sessionTracker && currentUser) {
              window.sessionTracker.endSession(currentUser.id || currentUser.userId);
          }

          // Clear session
          sessionHandler.clearSession();
      } else {
          // Fallback: clear localStorage directly
          localStorage.removeItem('agriguard_jwt_token');
          localStorage.removeItem('agriguard_user_info');
          localStorage.removeItem('agriguard_userSession');
      }

      // Clear cart
      localStorage.removeItem('shoppingCart');

      // Redirect to login
      window.location.href = '/login.html';
  }

  // ==================== SECTION NAVIGATION ====================

  function setActiveSection(sectionName) {
      currentSection = sectionName;






      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
          if (item.dataset.section === sectionName) {
              item.classList.add('active');
          }
      });

      // Update content sections
      document.querySelectorAll('.content-section').forEach(section => {
          section.classList.remove('active');
      });

      const activeSection = document.getElementById(sectionName);
      if (activeSection) {
          activeSection.classList.add('active');
      }

      // Load section-specific data
      loadSectionData(sectionName);
  }






  async function loadSectionData(sectionName) {
      switch (sectionName) {
          case 'overview':
              await loadOverviewData();
              break;
          case 'marketplace':
              await loadMarketplaceData();
              break;
          case 'orders':
              await loadOrdersData();
              break;
          case 'cart':
              updateCartDisplay();
              break;
          case 'transactions':
              await loadTransactionsData();
              break;
          case 'farmers':
              await loadFarmersData();
              break;
          case 'tracking':
              await loadTrackingData();
              break;
          case 'quality':
              await loadQualityData();
              break;
          case 'messages':
              await loadMessagesData();
              break;
          case 'reports':
              await loadReportsData();
              break;
      }
  }

  // ==================== DASHBOARD DATA LOADING ====================

  async function loadDashboardData() {
      try {
          await Promise.all([
              loadOverviewData(),
              loadNotifications(),
              updateCartBadge()
          ]);
      } catch (error) {
          console.error('Error loading dashboard data:', error);
      }
  }








  // ==================== OVERVIEW SECTION ====================

  async function loadOverviewData() {
      try {
          // Load buyer analytics
          const analytics = await apiCall(ENDPOINTS.buyerAnalytics(currentUser.id));

          // Update stat cards
          updateStatCards(analytics);

          // Load recent orders
          await loadRecentOrders();

          // Load charts data
          await loadOverviewCharts(analytics);

      } catch (error) {
          console.error('Error loading overview data:', error);
      }
  }

  function updateStatCards(analytics) {
      // Total Orders
      const totalOrders = document.getElementById('totalOrders');
      if (totalOrders && analytics.totalTransactions !== undefined) {
          totalOrders.textContent = analytics.totalTransactions;
      }

      // Completed Orders
      const completedOrders = document.getElementById('completedOrders');
      if (completedOrders && analytics.completedTransactions !== undefined) {
          completedOrders.textContent = analytics.completedTransactions;
      }

      // Pending Orders
      const pendingOrders = document.getElementById('pendingOrders');
      if (pendingOrders && analytics.pendingTransactions !== undefined) {
          pendingOrders.textContent = analytics.pendingTransactions;
      }

      // Total Spent
      const totalSpent = document.getElementById('totalSpent');
      if (totalSpent && analytics.totalAmount !== undefined) {
          totalSpent.textContent = formatCurrency(analytics.totalAmount);
      }

      // Update change percentages (if available)
      if (analytics.changes) {
          updateChangePercentages(analytics.changes);
      }
  }

  function updateChangePercentages(changes) {
      const ordersChange = document.getElementById('ordersChange');
      const completedChange = document.getElementById('completedChange');
      const spentChange = document.getElementById('spentChange');

      if (ordersChange && changes.orders !== undefined) {
          ordersChange.textContent = `${changes.orders}%`;
      }
      if (completedChange && changes.completed !== undefined) {
          completedChange.textContent = `${changes.completed}%`;
      }
      if (spentChange && changes.spent !== undefined) {
          spentChange.textContent = `${changes.spent}%`;
      }
  }

// ==================== MESSAGES NAVIGATION ====================

/**
 * Navigate to WhatsApp messaging page
 * This function handles the navigation to the external WhatsApp chat interface
 */
function navigateToMessages() {
    try {
        // Save current session state before navigation
        if (window.UserSessionHandler) {
            const sessionHandler = window.UserSessionHandler.getInstance();
            sessionHandler.updateLastActivity();
        }

        // Navigate to WhatsApp page
        window.location.href = 'WhatsAppFarmerBuyer.html';
    } catch (error) {
        console.error('Error navigating to messages:', error);
        showNotification('Failed to open messages', 'error');
    }
}

/**
 * Setup messages link event listener
 */
function setupMessagesNavigation() {
    const messagesLink = document.querySelector('.nav-item.external-link[href="WhatsAppFarmerBuyer.html"]');

    if (messagesLink) {
        messagesLink.addEventListener('click', (e) => {
            e.preventDefault();
            navigateToMessages();
        });

        console.log('✅ Messages navigation setup complete');
    } else {
        console.warn('⚠️ Messages link not found in DOM');
    }
}


async function loadRecentOrders() {
      try {
          const response = await apiCall(
              `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=5&sortBy=createdAt&sortDir=desc`
          );

          let orders = response.content || response;

          // ⭐ Enrich orders with farmer and crop details
          const enrichedOrders = await Promise.all(orders.map(async (order) => {
              try {
                  // Fetch farmer details if we have farmerId
                  if (order.farmerId && !order.farmerName) {
                      const farmerResponse = await apiCall(`${API_BASE_URL}/users/${order.farmerId}`);
                      const farmer = farmerResponse.data || farmerResponse;
                      order.farmerName = farmer.fullName || farmer.username || 'Unknown Farmer';
                  }

                  // Fetch crop details if we have cropId
                  if (order.cropId && !order.cropName) {
                      const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${order.cropId}`);
                      const crop = cropResponse.data || cropResponse;
                      order.cropName = crop.cropName || crop.name || 'Unknown Product';
                  }
              } catch (error) {
                  console.warn('Error enriching order:', error);
              }

              return order;
          }));

          displayRecentOrders(enrichedOrders);
      } catch (error) {
          console.error('Error loading recent orders:', error);
      }
  }

function displayRecentOrders(orders) {
    const tableBody = document.getElementById('recentOrdersTable');
    if (!tableBody) return;

    if (!orders || orders.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-light);">
                    <i class="fas fa-inbox" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                    No orders found
                </td>
            </tr>
        `;
        return;
    }

    tableBody.innerHTML = orders.map(order => `
        <tr style="transition: all 0.2s ease;">
            <!-- Order ID with badge -->
            <td style="font-weight: 600;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-receipt" style="color: var(--primary-color);"></i>
                    <span>${order.transactionCode || 'N/A'}</span>
                </div>
            </td>

            <!-- Date with icon -->
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-calendar" style="color: var(--text-light);"></i>
                    <span>${formatDate(order.createdAt)}</span>
                </div>
            </td>

            <!-- Farmer with profile indicator -->
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 30px; height: 30px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; color: var(--primary-dark);">
                        ${(order.farmerName || order.farmer?.fullName || 'U').charAt(0).toUpperCase()}
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-weight: 500; color: var(--text-dark);">
                            ${order.farmerName || order.farmer?.fullName || order.farmer?.username || 'Unknown Farmer'}
                        </span>
                        ${order.farmer?.phoneNumber ? `
                            <span style="font-size: 0.75rem; color: var(--text-light);">
                                <i class="fas fa-phone" style="font-size: 0.7rem;"></i> ${order.farmer.phoneNumber}
                            </span>
                        ` : ''}
                    </div>
                </div>
            </td>

            <!-- Product with image/icon -->
            <td>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    ${order.cropImageUrl || order.crop?.imageUrl ? `
                        <img src="${order.cropImageUrl || order.crop?.imageUrl}"
                             style="width: 35px; height: 35px; border-radius: var(--radius-sm); object-fit: cover;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div style="display: none; width: 35px; height: 35px; background: var(--primary-light); border-radius: var(--radius-sm); align-items: center; justify-content: center;">
                            <i class="fas fa-seedling" style="color: var(--primary-color);"></i>
                        </div>
                    ` : `
                        <div style="width: 35px; height: 35px; background: var(--primary-light); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-seedling" style="color: var(--primary-color);"></i>
                        </div>
                    `}
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-weight: 500; color: var(--text-dark);">
                            ${order.cropName || order.crop?.cropName || order.productName || 'Unknown Product'}
                        </span>
                        <span style="font-size: 0.75rem; color: var(--text-light);">
                            <i class="fas fa-weight" style="font-size: 0.7rem;"></i> ${order.quantity || 0} kg
                        </span>
                    </div>
                </div>
            </td>

            <!-- Amount with highlight -->
            <td>
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                    <span style="font-weight: 700; color: var(--primary-color); font-size: 1.1rem;">
                        ${formatCurrency(order.totalAmount)}
                    </span>
                    ${order.pricePerUnit ? `
                        <span style="font-size: 0.75rem; color: var(--text-light);">
                            ${formatCurrency(order.pricePerUnit)}/kg
                        </span>
                    ` : ''}
                </div>
            </td>

            <!-- Status with enhanced badges -->
            <td>
                <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                    <span class="status-badge status-${order.transactionStatus?.toLowerCase() || 'pending'}"
                          style="display: inline-flex; align-items: center; gap: 0.25rem;">
                        <i class="fas fa-${getStatusIcon(order.transactionStatus)}" style="font-size: 0.8rem;"></i>
                        ${order.transactionStatus || 'PENDING'}
                    </span>
                    ${order.paymentStatus ? `
                        <span style="font-size: 0.7rem; color: var(--text-light); text-transform: uppercase;">
                            ${order.paymentStatus}
                        </span>
                    ` : ''}
                </div>
            </td>

            <!-- Actions with better buttons -->
            <td>
                <div style="display: flex; gap: 0.25rem; align-items: center;">
                    <button class="btn-icon" onclick="viewOrderDetails('${order.id}')"
                            title="View Details"
                            style="background: var(--primary-light); color: var(--primary-dark); padding: 0.5rem; border-radius: var(--radius-sm); border: none; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-icon" onclick="trackOrder('${order.id}')"
                            title="Track Order"
                            style="background: var(--info-color); color: white; padding: 0.5rem; border-radius: var(--radius-sm); border: none; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-truck"></i>
                    </button>
                    ${order.transactionStatus === 'DELIVERED' ? `
                        <button class="btn-icon" onclick="leaveReview('${order.id}')"
                                title="Leave Review"
                                style="background: var(--warning-color); color: white; padding: 0.5rem; border-radius: var(--radius-sm); border: none; cursor: pointer; transition: all 0.2s;">
                            <i class="fas fa-star"></i>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');
}

// Helper function for status icons
function getStatusIcon(status) {
    const icons = {
        'PENDING': 'clock',
        'CONFIRMED': 'check',
        'PROCESSING': 'cog',
        'SHIPPED': 'truck',
        'DELIVERED': 'check-circle',
        'CANCELLED': 'times-circle',
        'COMPLETED': 'check-double'
    };
    return icons[status?.toUpperCase()] || 'clock';
}

  async function loadOverviewCharts(analytics) {
      // Load purchasing trends chart
      await loadPurchasingTrendsChart();

      // Load order status distribution chart
      loadOrderStatusChart(analytics);
  }

  async function loadPurchasingTrendsChart() {
      try {
          const filterEl = document.getElementById('purchasingChartFilter');
          const range = (filterEl && filterEl.value) || 'month';
          let days = 30;
          if (range === 'week') days = 7;
          else if (range === 'year') days = 365;

          const endDate = new Date();
          const startDate = new Date();
          startDate.setDate(startDate.getDate() - days);

          const transactions = await apiCall(
              `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=500&sortBy=createdAt&sortDir=desc`
          );
          const list = transactions.content || transactions;
          const filtered = Array.isArray(list) ? list.filter(t => new Date(t.createdAt) >= startDate) : [];

          const chartData = processTransactionsForChart(filtered);
          renderPurchasingChart(chartData);
      } catch (error) {
          console.error('Error loading purchasing trends:', error);
          renderPurchasingChart([]);
      }
  }

  function processTransactionsForChart(transactions) {
      const dailyData = {};
      (transactions || []).forEach(transaction => {
          const date = formatDate(transaction.createdAt);
          if (!dailyData[date]) {
              dailyData[date] = { date, amount: 0, count: 0 };
          }
          dailyData[date].amount += parseFloat(transaction.totalAmount || 0);
          dailyData[date].count += 1;
      });
      return Object.values(dailyData).sort((a, b) => new Date(a.date) - new Date(b.date));
  }

  function renderPurchasingChart(data) {
      const canvas = document.getElementById('purchasingChartCanvas');
      if (!canvas || typeof Chart === 'undefined') return;

      if (purchasingChartInstance) {
          purchasingChartInstance.destroy();
          purchasingChartInstance = null;
      }

      const ctx = canvas.getContext('2d');
      const labels = data.length ? data.map(d => d.date) : ['No data'];
      const values = data.length ? data.map(d => d.amount) : [0];

      purchasingChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
              labels,
              datasets: [{
                  label: 'Amount (RF)',
                  data: values,
                  borderColor: '#22c55e',
                  backgroundColor: 'rgba(34, 197, 94, 0.12)',
                  fill: true,
                  tension: 0.35,
                  pointBackgroundColor: '#22c55e',
                  pointBorderColor: '#fff',
                  pointBorderWidth: 2,
                  pointRadius: 4,
                  pointHoverRadius: 6
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: { display: false },
                  tooltip: {
                      callbacks: {
                          label: (c) => ' ' + formatCurrency(c.raw)
                      }
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true,
                      grid: { color: 'rgba(0,0,0,0.06)' },
                      ticks: { callback: (v) => 'RF ' + (v >= 1000 ? (v/1000) + 'k' : v) }
                  },
                  x: {
                      grid: { display: false },
                      ticks: { maxRotation: 45, minRotation: 0, maxTicksLimit: 10 }
                  }
              }
          }
      });
  }

  function loadOrderStatusChart(analytics) {
      analytics = analytics || {};
      const canvas = document.getElementById('orderStatusChartCanvas');
      if (!canvas || typeof Chart === 'undefined') return;

      if (orderStatusChartInstance) {
          orderStatusChartInstance.destroy();
          orderStatusChartInstance = null;
      }

      const statusData = [
          { status: 'Completed', count: analytics.completedTransactions || 0, color: '#10b981' },
          { status: 'Pending', count: analytics.pendingTransactions || 0, color: '#f59e0b' },
          { status: 'In Transit', count: analytics.inTransitTransactions || 0, color: '#3b82f6' },
          { status: 'Cancelled', count: analytics.cancelledTransactions || 0, color: '#ef4444' }
      ];
      const total = statusData.reduce((sum, i) => sum + i.count, 0);
      const labels = statusData.map(s => s.status);
      const data = total > 0 ? statusData.map(s => s.count) : [1, 1, 1, 1];
      const colors = total > 0 ? statusData.map(s => s.color) : ['#e5e7eb', '#e5e7eb', '#e5e7eb', '#e5e7eb'];

      const ctx = canvas.getContext('2d');
      orderStatusChartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
              labels,
              datasets: [{
                  data,
                  backgroundColor: colors,
                  borderColor: '#fff',
                  borderWidth: 2,
                  hoverOffset: 8
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: '58%',
              plugins: {
                  legend: { position: 'bottom' },
                  title: {
                      display: total === 0,
                      text: 'No orders yet',
                      position: 'top',
                      font: { size: 14 },
                      color: '#94a3b8'
                  },
                  tooltip: {
                      callbacks: {
                          label: (c) => {
                              const v = statusData[c.dataIndex].count;
                              const pct = total > 0 ? ((v / total) * 100).toFixed(1) : '0';
                              return ` ${c.label}: ${v} (${pct}%)`;
                          }
                      }
                  }
              }
          }
      });
  }







async function loadMarketplaceData() {
    try {
        console.log('=== LOADING MARKETPLACE ===');

        // 1. Load active productions
        const productionsResponse = await apiCall(`${API_BASE_URL}/v1/crop-productions/active`);
        const productions = extractDataFromResponse(productionsResponse);

        console.log('=== PRODUCTIONS LOADED ===');
        console.log('Productions Count:', productions.length);

        if (productions.length === 0) {
            console.warn('No active productions found');
            showNotification('No products available in marketplace', 'info');
            displayMarketplaceProducts([]);
            return;
        }

        // 2. Load crops
        const cropsResponse = await apiCall(`${API_BASE_URL}/v1/crops/all`);
        const crops = extractDataFromResponse(cropsResponse);

        // 3. ⭐ Load all farmers
        const farmersResponse = await apiCall(`${API_BASE_URL}/users/farmers`);
        const farmers = extractDataFromResponse(farmersResponse);

        console.log('=== FARMERS LOADED ===');
        console.log('Farmers Count:', farmers.length);

        // 4. Create maps
        const cropsMap = {};
        crops.forEach(crop => {
            if (crop.id) cropsMap[crop.id] = crop;
            if (crop.cropId) cropsMap[crop.cropId] = crop;
        });

        const farmersMap = {};
        farmers.forEach(farmer => {
            if (farmer.id) {
                farmersMap[farmer.id] = farmer;
            }
        });

        // 5. ⭐ Enrich productions with crop AND farmer details
        const enrichedProductions = productions.map(prod => {
            const crop = cropsMap[prod.cropId];
            const farmer = farmersMap[prod.farmerId];

            const farmerName = farmer?.fullName || farmer?.username || 'Contact Support';

            return {
                id: prod.id,
                productionCode: prod.productionCode,
                cropId: prod.cropId,
                cropName: crop?.cropName || prod.cropName || 'Unknown Crop',
                cropType: crop?.cropType || prod.cropType || 'Unknown',
                cropImageUrl: crop?.imageUrl || prod.cropImageUrl,
                cropDescription: crop?.description || prod.notes,
                cropVariety: crop?.variety || prod.seedVariety,

                // ⭐ FARMER INFORMATION
                farmerId: prod.farmerId,
                farmerName: farmerName,
                farmerFullName: farmer?.fullName || farmerName,
                farmerEmail: farmer?.email,
                farmerPhone: farmer?.phoneNumber,
                farmId: prod.farmId,

                // Availability
                availableQuantity: prod.expectedYield || prod.actualYield || 0,
                price: prod.estimatedPrice || prod.marketPrice || 0,
                pricePerKg: prod.estimatedPrice || prod.marketPrice || 0,

                // Dates
                expectedHarvestDate: prod.expectedHarvestDate,
                actualHarvestDate: prod.actualHarvestDate,
                plantingDate: prod.plantingDate,

                // Location & Status
                location: prod.location || 'Rwanda',
                productionStatus: prod.productionStatus,
                productionMethod: prod.productionMethod,

                // Quality
                qualityGrade: prod.qualityGrade || 'STANDARD',
                isOrganic: prod.productionMethod?.includes('ORGANIC'),
                certification: prod.certification,

                // Additional info
                unit: 'Kg',
                currency: 'RWF',
                type: 'crop_production',
                productionId: prod.id
            };
        });

        console.log('=== ENRICHED PRODUCTIONS ===');
        console.log('Count:', enrichedProductions.length);
        if (enrichedProductions.length > 0) {
            console.log('First product:', enrichedProductions[0]);
        }

        populateCategoryFilter(crops);
        displayMarketplaceProducts(enrichedProductions);
        showNotification(`${enrichedProductions.length} products loaded`, 'success');
        if (enrichedProductions.length > 0 && !window._marketplaceNotifiedThisSession && typeof pushBuyerNotification === 'function') {
            window._marketplaceNotifiedThisSession = true;
            pushBuyerNotification('New products in Marketplace', `${enrichedProductions.length} products available to browse`, 'info');
        }

    } catch (error) {
        console.error('=== ERROR LOADING MARKETPLACE ===', error);
        showNotification('Failed to load marketplace: ' + error.message, 'error');
        displayMarketplaceProducts([]);
    }
}




// ⭐ BONUS: Also update the product card display function to use the farmer name
function createProductCard(product) {
    const harvestDate = product.actualHarvestDate || product.expectedHarvestDate;
    const harvestLabel = product.actualHarvestDate ? 'Harvested' : 'Expected';
    const timeAgo = harvestDate ? getTimeAgo(new Date(harvestDate)) : 'Date not set';

    // ⭐ Use the enriched farmer name
    const farmerDisplay = product.farmerFullName || product.farmerName || 'Contact Support';

    return `
        <div class="marketplace-card" onclick="openProductDetail('${product.id}')">
            <div class="product-image">
                ${product.cropImageUrl
                    ? `<img src="${product.cropImageUrl}" alt="${product.cropName}">`
                    : `<div class="no-image">No Image Available</div>`
                }
                ${product.certification ? `<span class="badge-certified">CERTIFIED</span>` : ''}
            </div>
            <div class="product-info">
                <h3>${product.cropName}</h3>
                <p class="product-type">${product.cropType || 'Agricultural Product'}</p>
                <div class="product-details-grid">
                    <div class="detail-item">
                        <i class="fas fa-boxes"></i>
                        <div>
                            <span class="label">Available:</span>
                            <span class="value">${product.availableQuantity} ${product.unit}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-tag"></i>
                        <div>
                            <span class="label">Price:</span>
                            <span class="value price">${product.currency} ${product.pricePerKg}/${product.unit}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-calendar"></i>
                        <div>
                            <span class="label">${harvestLabel}:</span>
                            <span class="value">${timeAgo}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-user"></i>
                        <div>
                            <span class="label">Farmer:</span>
                            <span class="value farmer-name">${farmerDisplay}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <div>
                            <span class="label">Location:</span>
                            <span class="value">${product.location}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-leaf"></i>
                        <div>
                            <span class="label">Method:</span>
                            <span class="value">${product.productionMethod || 'CONVENTIONAL'}</span>
                        </div>
                    </div>
                </div>
                <button class="btn-add-cart" onclick="event.stopPropagation(); addToCart('${product.id}')">
                    <i class="fas fa-cart-plus"></i> Add to Cart
                </button>
            </div>
        </div>
    `;
}

// Helper function for time ago display
function getTimeAgo(date) {
    const now = new Date();
    const diff = now - date;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const weeks = Math.floor(days / 7);
    const months = Math.floor(days / 30);

    if (months > 0) return `${months} month${months > 1 ? 's' : ''} ago`;
    if (weeks > 0) return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
    if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
    return 'Today';
}


function extractDataFromResponse(response) {
    console.log('Extracting data from response:', response);

    // If the response is already an array
    if (Array.isArray(response)) {
        console.log('Response is array, length:', response.length);
        return response;
    }

    // If the response has 'data' property (ApiResponse wrapper)
    if (response && response.data !== undefined) {
        if (Array.isArray(response.data)) {
            console.log('Response.data is array, length:', response.data.length);
            return response.data;
        }
        // If data.content exists (pagination)
        if (response.data && response.data.content && Array.isArray(response.data.content)) {
            console.log('Response.data.content is array, length:', response.data.content.length);
            return response.data.content;
        }
        // If data is an object with content
        if (response.data && Array.isArray(response.data)) {
            console.log('Response.data extracted, length:', response.data.length);
            return response.data;
        }
    }

    // If the response has 'content' property (pagination)
    if (response && response.content && Array.isArray(response.content)) {
        console.log('Response.content is array, length:', response.content.length);
        return response.content;
    }

    // If response has success/data structure from ApiResponse
    if (response && response.success && response.data) {
        if (Array.isArray(response.data)) {
            console.log('Response ApiResponse format, length:', response.data.length);
            return response.data;
        }
    }

    // Default: return empty array
    console.warn('Could not extract data from response, returning empty array. Response was:', response);
    return [];
}




// ⭐ FONCTION CORRIGÉE : Enrichir les market prices avec les noms des crops
function enrichMarketPricesWithCropNames(marketPrices, crops) {
    console.log('Enriching market prices...');
    console.log('Market prices to enrich:', marketPrices);
    console.log('Crops available:', crops);

    // Créer un map des crops par cropId/id
    const cropsMap = {};
    crops.forEach(crop => {
        if (crop.id) {
            cropsMap[crop.id] = crop;
        }
        if (crop.cropId) {
            cropsMap[crop.cropId] = crop;
        }
    });

    console.log('Crops map:', cropsMap);

    // Enrichir chaque market price
    const enriched = marketPrices.map(price => {
        // Chercher le crop correspondant
        const crop = cropsMap[price.cropId];

        if (!crop) {
            console.warn(`No crop found for cropId: ${price.cropId}`);
        }

        return {
            ...price,
            // Nom de la culture
            cropName: crop ? (crop.cropName || crop.name || 'Unknown Crop') : `Crop ${price.cropId}`,
            // Type de culture
            cropType: crop ? (crop.cropType || crop.type || 'Unknown') : 'Unknown',
            // Image de la culture
            cropImageUrl: crop ? (crop.imageUrl || crop.image || null) : null,
            // Description de la culture
            cropDescription: crop ? (crop.description || crop.desc || null) : null,
            // Variété (si disponible)
            cropVariety: crop ? (crop.variety || null) : null
        };
    });

    console.log('Enriched market prices result:', enriched);
    return enriched;
}

// ⭐ FONCTION CORRIGÉE : Fusionner les market prices avec les productions
function mergeMarketPricesWithProductions(marketPrices, productions) {
    console.log('Merging market prices with productions...');

    // Créer un map des productions par cropId
    const productionsMap = {};
    productions.forEach(prod => {
        if (!productionsMap[prod.cropId]) {
            productionsMap[prod.cropId] = [];
        }
        productionsMap[prod.cropId].push(prod);
    });

    // Fusionner les données
    return marketPrices.map(price => {
        const relatedProductions = productionsMap[price.cropId] || [];

        // Calculer la quantité disponible totale
        const totalAvailable = relatedProductions.reduce((sum, prod) => {
            const quantity = prod.expectedYield || prod.actualYield || 0;
            return sum + parseFloat(quantity);
        }, 0);

        return {
            id: price.id,
            cropId: price.cropId,
            cropName: price.cropName || 'Unknown Crop',
            cropType: price.cropType || 'Unknown',
            cropImageUrl: price.cropImageUrl,
            cropDescription: price.cropDescription,
            cropVariety: price.cropVariety,
            price: price.pricePerKg || price.price || 0,
            pricePerKg: price.pricePerKg || price.price || 0,
            currency: price.currency || 'RWF',
            unit: price.unit || 'Kg',
            marketName: price.marketName || 'Local Market',
            marketType: price.marketType || 'RETAIL',
            location: price.location || 'Rwanda',
            priceDate: price.priceDate || new Date().toISOString(),
            demandLevel: price.demandLevel || 'MEDIUM',
            supplyLevel: price.supplyLevel || 'MEDIUM',
            priceTrend: price.priceTrend || 'STABLE',
            availableQuantity: totalAvailable,
            productionsCount: relatedProductions.length,
            relatedProductions: relatedProductions,
            dataSource: price.dataSource || 'Manual',
            reliabilityScore: price.reliabilityScore || 3,
            notes: price.notes || ''
        };
    });
}



function displayMarketplaceProducts(products) {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;

    console.log('Displaying marketplace products:', products);

    if (!products || products.length === 0) {
        productsGrid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <i class="fas fa-inbox"></i>
                <h3>No Products Available</h3>
                <p>There are no products available in the marketplace at the moment.</p>
            </div>
        `;
        return;
    }

    productsGrid.innerHTML = products.map((product, index) => {
        console.log(`Product ${index}:`, {
            id: product.id,
            cropName: product.cropName,
            price: product.pricePerKg,
            type: product.id.startsWith('MP') ? 'market_price' : 'crop_production'
        });

        return `
            <div class="product-card">
                <div class="product-image" onclick="viewProductDetails('${product.id}')">
                    ${product.cropImageUrl ?
                        `<img src="${product.cropImageUrl}" alt="${product.cropName}">` :
                        `<div class="product-placeholder">
                            <i class="fas fa-seedling"></i>
                            <span>No Image</span>
                         </div>`
                    }
                    ${product.priceTrend === 'INCREASING' ?
                        '<span class="product-badge organic" style="background: var(--danger-color);">Price Rising ↗</span>' :
                        product.priceTrend === 'DECREASING' ?
                        '<span class="product-badge ready" style="background: var(--success-color);">Price Falling ↘</span>' :
                        '<span class="product-badge" style="background: var(--info-color);">Price Stable →</span>'
                    }
                    ${product.id.startsWith('MP') ?
                        '<span class="product-badge" style="background: var(--primary-color); top: 40px;">Market Price</span>' :
                        '<span class="product-badge" style="background: var(--secondary-color); top: 40px;">Direct Sale</span>'
                    }
                </div>
                <div class="product-info">
                    <div class="product-category">${product.cropType || 'Agriculture'}</div>
                    <h3 class="product-name">${product.cropName}</h3>

                    <div class="product-details">
                        <div class="detail-item">
                            <i class="fas fa-weight"></i>
                            <span>${product.availableQuantity || 0} kg available</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${product.location || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-store"></i>
                            <span>${product.marketName || 'Market'}</span>
                        </div>
                    </div>

                    <div class="product-footer">
                        <div class="product-price">
                            <span class="price-value">${formatCurrency(product.pricePerKg || product.price || 0)}</span>
                            <span class="price-unit">/kg</span>
                        </div>
                        <div class="product-actions" style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary btn-sm"
                                    onclick="viewProductDetails('${product.id}')"
                                    style="flex: 1; padding: 0.5rem; font-size: 0.85rem;">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                            ${(product.availableQuantity || 0) > 0 || product.id.startsWith('MP') ? `
                                <button class="btn btn-primary btn-sm"
                                        onclick="addToCart('${product.id}')"
                                        style="flex: 1; padding: 0.5rem; font-size: 0.85rem;">
                                    <i class="fas fa-shopping-cart"></i> Add
                                </button>
                            ` : `
                                <button class="btn btn-secondary btn-sm" disabled
                                        style="flex: 1; padding: 0.5rem; font-size: 0.85rem;">
                                    <i class="fas fa-ban"></i> Out of Stock
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}





// Helper functions
function formatPrice(price) {
    return parseFloat(price).toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    });
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffTime = Math.abs(now - date);
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
    return date.toLocaleDateString();
}

function getReliabilityBadge(score) {
    if (score >= 4) {
        return '<span class="badge bg-success">★★★★★ Verified</span>';
    } else if (score >= 3) {
        return '<span class="badge bg-info">★★★★ Good</span>';
    } else {
        return '<span class="badge bg-warning">★★★ Fair</span>';
    }
}

// ⭐ FONCTION AMÉLIORÉE : Peupler le filtre de catégories
function populateCategoryFilter(crops) {
    const categoryFilter = document.getElementById('categoryFilter');
    if (!categoryFilter) return;

    // Extraire les types de cultures uniques
    const cropTypes = [...new Set(crops.map(crop => crop.cropType || crop.type).filter(Boolean))];

    // Générer les options
    categoryFilter.innerHTML = `
        <option value="">All Categories</option>
        ${cropTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
    `;
}




// 4. FONCTION HELPER POUR LES BADGES DE QUALITÉ
function getQualityBadgeClass(qualityGrade) {
    if (!qualityGrade) return 'quality-standard';
    const grade = qualityGrade.toLowerCase();
    if (grade.includes('organic') || grade.includes('premium')) return 'quality-organic';
    if (grade.includes('certified') || grade.includes('grade a')) return 'quality-certified';
    return 'quality-standard';
}

// 5. AJOUTER AU PANIER AVEC PRIX DU MARCHÉ
async function addProductToCart(productionId, marketPrice) {
    try {
        // FIX: Utiliser ENDPOINTS ou construire correctement l'URL
        const production = await apiCall(`${API_BASE_URL}/v1/crop-productions/${productionId}`);

        if (!production) {
            showNotification('Product not found', 'error');
            return;
        }

        if ((production.expectedYield || 0) <= 0) {
            showNotification('This product is out of stock', 'warning');
            return;
        }

        const existingItem = shoppingCart.find(item => item.productionId === productionId);

        if (existingItem) {
            existingItem.quantity += 1;
            showNotification('Quantity updated in cart', 'success');
        } else {
            shoppingCart.push({
                productionId: production.id,
                cropId: production.cropId,
                cropName: production.cropName,
                farmerName: production.farmerName,
                farmerId: production.farmerId,
                price: marketPrice || production.estimatedPrice || 0,
                quantity: 1,
                availableQuantity: production.expectedYield || 0,
                imageUrl: production.cropImageUrl,
                location: production.location,
                expectedHarvestDate: production.expectedHarvestDate
            });
            showNotification('Product added to cart', 'success');
        }

        saveCartToStorage();
        updateCartBadge();

    } catch (error) {
        console.error('Error adding to cart:', error);
        showNotification('Failed to add product to cart', 'error');
    }
}

// 6. VOIR LES DÉTAILS D'UN PRODUIT DU MARKETPLACE
function viewMarketplaceProductDetails(productId, productData) {
    try {
        const product = typeof productData === 'string' ? JSON.parse(productData) : productData;

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content large">
                <div class="modal-header">
                    <h2>${product.cropName}</h2>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="product-details-grid">
                        <div class="product-image-section">
                            ${product.cropImageUrl ?
                                `<img src="${product.cropImageUrl}" alt="${product.cropName}">` :
                                `<div class="product-placeholder-large">
                                    <i class="fas fa-seedling"></i>
                                </div>`
                            }
                        </div>

                        <div class="product-info-section">
                            <h3>Market Information</h3>

                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="label">Current Price:</span>
                                    <span class="value price-highlight">${formatCurrency(product.price)}/kg</span>
                                </div>

                                <div class="info-item">
                                    <span class="label">Market:</span>
                                    <span class="value">${product.marketName || 'N/A'}</span>
                                </div>

                                <div class="info-item">
                                    <span class="label">Location:</span>
                                    <span class="value">${product.location || 'N/A'}</span>
                                </div>

                                <div class="info-item">
                                    <span class="label">Market Type:</span>
                                    <span class="value">${product.marketType || 'N/A'}</span>
                                </div>

                                ${product.availableQuantity > 0 ? `
                                    <div class="info-item">
                                        <span class="label">Available:</span>
                                        <span class="value">${product.availableQuantity} kg</span>
                                    </div>
                                ` : ''}

                                ${product.qualityGrade ? `
                                    <div class="info-item">
                                        <span class="label">Quality Grade:</span>
                                        <span class="value">${product.qualityGrade}</span>
                                    </div>
                                ` : ''}

                                ${product.demandLevel ? `
                                    <div class="info-item">
                                        <span class="label">Demand Level:</span>
                                        <span class="value">${product.demandLevel}</span>
                                    </div>
                                ` : ''}

                                ${product.supplyLevel ? `
                                    <div class="info-item">
                                        <span class="label">Supply Level:</span>
                                        <span class="value">${product.supplyLevel}</span>
                                    </div>
                                ` : ''}

                                ${product.priceTrend ? `
                                    <div class="info-item">
                                        <span class="label">Price Trend:</span>
                                        <span class="value ${product.priceTrend.toLowerCase()}">${product.priceTrend}</span>
                                    </div>
                                ` : ''}

                                ${product.farmerName ? `
                                    <div class="info-item">
                                        <span class="label">Farmer:</span>
                                        <span class="value">${product.farmerName}</span>
                                    </div>
                                ` : ''}

                                ${product.expectedHarvestDate ? `
                                    <div class="info-item">
                                        <span class="label">Harvest Date:</span>
                                        <span class="value">${formatDate(product.expectedHarvestDate)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                        Close
                    </button>

                    ${product.isAvailable && product.productionId ? `
                        <button class="btn btn-primary"
                                onclick="addProductToCart('${product.productionId}', ${product.price}); this.closest('.modal').remove();">
                            <i class="fas fa-shopping-cart"></i>
                            Add to Cart
                        </button>
                    ` : ''}
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);

    } catch (error) {
        console.error('Error showing product details:', error);
        showNotification('Failed to load product details', 'error');
    }
}

// 7. RENDRE LES FONCTIONS GLOBALES
window.addProductToCart = addProductToCart;
window.viewMarketplaceProductDetails = viewMarketplaceProductDetails;

console.log('Marketplace fix applied successfully');

function populateCategoryFilter(crops) {
    const categoryFilter = document.getElementById('categoryFilter');
    if (!categoryFilter) return;

    // FIX: Ensure crops is an array before mapping
    if (!Array.isArray(crops) || crops.length === 0) {
        categoryFilter.innerHTML = '<option value="">All Categories</option>';
        return;
    }

    // Get unique crop types
    const cropTypes = [...new Set(crops.map(crop => crop.cropType).filter(type => type))];

    categoryFilter.innerHTML = `
        <option value="">All Categories</option>
        ${cropTypes.map(type => `
            <option value="${type}">${type}</option>
        `).join('')}
    `;
}



function displayProducts(productions) {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;

    if (!Array.isArray(productions)) {
        console.error('Productions is not an array:', productions);
        productions = [];
    }

    if (productions.length === 0) {
        productsGrid.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                <i class="fas fa-inbox" style="font-size: 4rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                <h3>No Products Available</h3>
                <p>There are no products available in the marketplace at the moment.</p>
            </div>
        `;
        return;
    }

    productsGrid.innerHTML = productions.map(production => {
        // ⭐ FIX: Ensure we have the correct ID
        const productId = production.id || production.productionId || production._id;

        console.log('Production item:', {
            id: productId,
            productionCode: production.productionCode,
            cropName: production.cropName
        });

        return `
            <div class="product-card" onclick="viewProductDetails('${productId}')" style="cursor: pointer;">
                <div class="product-image" style="position: relative;">
                    ${production.cropImageUrl ?
                        `<img src="${production.cropImageUrl}" alt="${production.cropName}"
                             style="width: 100%; height: 200px; object-fit: cover;"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZWNmMGYxIi8+CjxwYXRoIGQ9Ik03NSA1MEgxMjVWMTUwSDc1VjUwWiIgZmlsbD0iIzJlY2M3MSIvPgo8Y2lyY2xlIGN4PSIxMDAiIGN5PSI3NSIgcj0iMTUiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==';">` :
                        `<div class="product-placeholder" style="width: 100%; height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--gray);">
                            <i class="fas fa-seedling" style="font-size: 3rem; color: var(--text-light);"></i>
                            <span style="color: var(--text-light); margin-top: 0.5rem;">No Image</span>
                         </div>`
                    }
                    ${production.productionMethod === 'ORGANIC' || production.productionMethod === 'CERTIFIED_ORGANIC' ?
                        '<span class="product-badge organic" style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--success-color); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem;">Organic</span>' : ''}
                    ${production.productionStatus === 'HARVESTED' ?
                        '<span class="product-badge ready" style="position: absolute; top: 0.5rem; left: 0.5rem; background: var(--info-color); color: white; padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); font-size: 0.75rem;">Ready</span>' : ''}
                </div>
                <div class="product-info" style="padding: 1rem;">
                    <div class="product-category" style="font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; margin-bottom: 0.5rem;">
                        ${production.cropType || 'Agriculture'}
                    </div>
                    <h3 class="product-name" style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">
                        ${production.cropName || 'Unknown Crop'}
                    </h3>
                    <p class="product-farmer" style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem;">
                        <i class="fas fa-user"></i>
                        ${production.farmerName || 'Unknown Farmer'}
                    </p>
                    <div class="product-details" style="margin: 1rem 0;">
                        <div class="detail-item" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                            <i class="fas fa-weight" style="width: 16px; color: var(--primary-color);"></i>
                            <span>${production.expectedYield || production.actualYield || 0} kg available</span>
                        </div>
                        <div class="detail-item" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                            <i class="fas fa-map-marker-alt" style="width: 16px; color: var(--primary-color);"></i>
                            <span>${production.location || 'Location not specified'}</span>
                        </div>
                        <div class="detail-item" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                            <i class="fas fa-calendar" style="width: 16px; color: var(--primary-color);"></i>
                            <span>Harvest: ${formatDate(production.expectedHarvestDate || production.actualHarvestDate)}</span>
                        </div>
                    </div>
                    <div class="product-footer" style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                        <div class="product-price">
                            <span class="price-value" style="font-size: 1.3rem; font-weight: 700; color: var(--primary-color);">
                                ${formatCurrency(production.estimatedPrice || 0)}
                            </span>
                            <span class="price-unit" style="font-size: 0.9rem; color: var(--text-light);">/kg</span>
                        </div>
                        <button class="btn btn-primary btn-sm"
                                onclick="event.stopPropagation(); addToCart('${productId}')"
                                ${(production.expectedYield || production.actualYield || 0) <= 0 ? 'disabled' : ''}
                                style="padding: 0.5rem 1rem; border: none; border-radius: var(--radius-md); background: var(--primary-color); color: white; cursor: pointer;">
                            <i class="fas fa-shopping-cart"></i>
                            ${(production.expectedYield || production.actualYield || 0) <= 0 ? 'Out of Stock' : 'Add'}
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}









async function searchProducts(query) {
    try {
        const response = await apiCall(ENDPOINTS.cropProductionsActive);

        // FIX: Ensure we have an array
        const allProductions = Array.isArray(response) ? response :
                              (response.content ? response.content : []);

        const filtered = allProductions.filter(prod =>
            prod.cropName?.toLowerCase().includes(query.toLowerCase()) ||
            prod.farmerName?.toLowerCase().includes(query.toLowerCase()) ||
            prod.location?.toLowerCase().includes(query.toLowerCase())
        );
        displayProducts(filtered);
    } catch (error) {
        console.error('Error searching products:', error);
    }
}







// Load cart from localStorage and enrich with latest data
async function loadCartFromStorage() {
    try {
        const savedCart = localStorage.getItem('buyerCart');
        if (savedCart) {
            const parsedCart = JSON.parse(savedCart);

            console.log('=== LOADING CART FROM STORAGE ===');
            console.log('Saved cart items:', parsedCart.length);

            // ⭐ ENRICH each cart item with fresh farmer data
            const enrichedCart = await Promise.all(
                parsedCart.map(async (item) => {
                    // If farmer name is missing or "Unknown Farmer", fetch it
                    if (!item.farmerName || item.farmerName === 'Unknown Farmer') {
                        if (item.farmerId) {
                            try {
                                const farmerResponse = await apiCall(`${API_BASE_URL}/users/${item.farmerId}`);
                                const farmer = farmerResponse.data || farmerResponse;

                                item.farmerName = farmer.fullName || farmer.username || 'Unknown Farmer';
                                item.farmerEmail = farmer.email;
                                item.farmerPhone = farmer.phoneNumber;

                                console.log(`✓ Enriched cart item with farmer: ${item.farmerName}`);
                            } catch (error) {
                                console.error(`Failed to load farmer ${item.farmerId}:`, error);
                                item.farmerName = 'Farmer Info Unavailable';
                            }
                        } else {
                            console.warn('Cart item has no farmerId:', item);
                        }
                    }
                    return item;
                })
            );

            shoppingCart = enrichedCart;
            updateCartBadge();
            updateCartDisplay();

            console.log('Cart loaded and enriched:', shoppingCart);
        }
    } catch (error) {
        console.error('Error loading cart:', error);
        shoppingCart = [];
    }
}





// Save cart to localStorage
function saveCartToStorage() {
    try {
        localStorage.setItem('buyerCart', JSON.stringify(shoppingCart));
        console.log('Cart saved to storage:', shoppingCart);
    } catch (error) {
        console.error('Error saving cart:', error);
    }
}





async function addToCart(productId) {
    console.log('=== ADD TO CART CALLED ===');
    console.log('Product ID:', productId);

    try {
        showNotification('Adding to cart...', 'info');

        let productData = null;
        let productType = null;

        // STRATEGY 1: Market Price
        if (productId.startsWith('MP')) {
            console.log('Detected Market Price ID');
            try {
                const marketPriceResponse = await apiCall(`${API_BASE_URL}/market-prices/${productId}`);
                // ⭐ UNWRAP ApiResponse if needed
                productData = marketPriceResponse.data || marketPriceResponse;
                productType = 'market_price';
                console.log('✓ Market Price found:', productData);
            } catch (error) {
                console.error('Market Price not found:', error);
            }
        }

        // STRATEGY 2: Crop Production
        if (!productData) {
            console.log('Trying as Crop Production...');
            try {
                const productionResponse = await apiCall(`${API_BASE_URL}/v1/crop-productions/${productId}`);

                // ⭐ CRITICAL FIX: Unwrap ApiResponse wrapper
                console.log('Raw API Response:', productionResponse);

                // Check if response has a 'data' property (ApiResponse wrapper)
                if (productionResponse.data) {
                    productData = productionResponse.data;
                } else if (productionResponse.success && productionResponse.data) {
                    productData = productionResponse.data;
                } else {
                    // Response is the data itself
                    productData = productionResponse;
                }

                productType = 'crop_production';

                console.log('✓ Crop Production found:', productData);
                console.log('✓ Crop Name:', productData.cropName);
                console.log('✓ Farmer Name:', productData.farmerName);
                console.log('✓ Available quantity:', productData.expectedYield || productData.actualYield);

                // ⭐ VALIDATION: Check if enrichment succeeded
                if (!productData.cropName || productData.cropName === 'Unknown Crop') {
                    console.error('❌ Crop name is missing after API call!');
                    throw new Error('Product information incomplete - crop name missing');
                }

                if (!productData.farmerName || productData.farmerName === 'Unknown Farmer') {
                    console.warn('⚠️ Farmer name is missing');
                }

            } catch (error) {
                console.error('Crop Production not found:', error);
                throw error;
            }
        }

        if (!productData) {
            showNotification('Product not found or unavailable', 'error');
            return;
        }

        // ⭐ PROCESS BASED ON TYPE
        if (productType === 'market_price') {
            await addMarketPriceToCart(productData);
        } else if (productType === 'crop_production') {
            await addCropProductionToCart(productData);
        }

    } catch (error) {
        console.error('Error in addToCart:', error);
        showNotification('Failed to add product to cart: ' + error.message, 'error');
    }
}




async function addCropProductionToCart(production) {
    console.log('=== ADDING CROP PRODUCTION TO CART ===');
    console.log('Production data:', production);

    const availableQty = parseFloat(production.expectedYield || production.actualYield || 0);

    if (availableQty <= 0 || isNaN(availableQty)) {
        console.warn('Product out of stock. Quantity:', availableQty);
        showNotification('This product is out of stock', 'warning');
        return;
    }

    // ⭐ CRITICAL: Get enriched information
    const cropName = production.cropName;
    const farmerName = production.farmerName;
    const location = production.location || production.deliveryLocation || 'Location not specified';

    // ⭐ UTILISER pricePerKg avec fallback sur estimatedPrice
    let pricePerKg = parseFloat(production.pricePerKg || 0);

    // Si pricePerKg est 0, essayer d'utiliser estimatedPrice
    if (pricePerKg === 0 && production.estimatedPrice) {
        pricePerKg = parseFloat(production.estimatedPrice);
    }

    // Si toujours 0, utiliser un prix par défaut
    if (pricePerKg === 0) {
        pricePerKg = 1000; // Prix par défaut
        console.warn('⚠️ No price found, using default: 1000 RWF/kg');
    }

    // ⭐ VALIDATION
    if (!cropName || cropName === 'Unknown Crop') {
        console.error('❌ Crop name is missing!');
        showNotification('Product information incomplete - crop name missing', 'error');
        return;
    }

    if (!farmerName || farmerName === 'Unknown Farmer' || farmerName === 'Farmer Info Unavailable') {
        console.error('❌ Farmer name is missing!');
        showNotification('Product information incomplete - farmer information missing', 'error');
        return;
    }

    // Check if already in cart
    const existingItemIndex = shoppingCart.findIndex(item =>
        item.productionId === production.id
    );

    if (existingItemIndex !== -1) {
        const existingItem = shoppingCart[existingItemIndex];
        if (existingItem.quantity + 1 > availableQty) {
            showNotification(`Maximum ${availableQty} kg available`, 'warning');
            return;
        }
        existingItem.quantity += 1;
        showNotification('Quantity updated in cart', 'success');
        if (typeof pushBuyerNotification === 'function') {
            pushBuyerNotification('Cart updated', `Quantity updated for ${cropName}`, 'success');
        }
    } else {
        // ⭐ Add new item with complete information
        const cartItem = {
            productionId: production.id,
            cropId: production.cropId,

            // ⭐ CROP INFO
            cropName: cropName,
            cropImageUrl: production.cropImageUrl,
            cropType: production.cropType,

            // ⭐ FARMER INFO
            farmerId: production.farmId,
            farmerName: farmerName,
            farmerEmail: production.farmerEmail,
            farmerPhone: production.farmerPhone,

            // ⭐ PRICING & QUANTITY - UTILISER pricePerKg
            pricePerKg: pricePerKg,
            price: pricePerKg, // Pour compatibilité
            quantity: 1,
            availableQuantity: availableQty,

            // ⭐ LOCATION
            location: location,
            unit: 'kg',
            type: 'crop_production',

            // Additional info
            expectedHarvestDate: production.expectedHarvestDate,
            productionMethod: production.productionMethod,
            qualityGrade: production.qualityGrade || 'STANDARD',
            packaging: production.packaging || 'BAG'
        };

        console.log('✓ Cart item to add:', cartItem);
        console.log('✓ Crop name:', cartItem.cropName);
        console.log('✓ Farmer name:', cartItem.farmerName);
        console.log('✓ Location:', cartItem.location);
        console.log('✓ Price per kg:', cartItem.pricePerKg, 'RWF');
        console.log('✓ Total for 1kg:', cartItem.pricePerKg * 1, 'RWF');

        shoppingCart.push(cartItem);
        showNotification(`Added ${cropName} to cart at ${pricePerKg} RWF/kg`, 'success');
        if (typeof pushBuyerNotification === 'function') {
            pushBuyerNotification('Product added to cart', `${cropName} added (1 kg)`, 'success');
        }
    }

    saveCartToStorage();
    updateCartBadge();
    updateCartDisplay();

    console.log('Shopping cart after adding:', shoppingCart);
}

// Make functions globally available
window.addToCart = addToCart;
window.addCropProductionToCart = addCropProductionToCart;

console.log('✅ Fixed cart functions loaded');



function updateCartBadge() {
    const cartBadge = document.getElementById('cartBadge');
    if (cartBadge) {
        const itemCount = shoppingCart.reduce((sum, item) => sum + item.quantity, 0);
        cartBadge.textContent = itemCount;
        cartBadge.style.display = itemCount > 0 ? 'inline-block' : 'none';
    }
}








// ⭐ AJOUTER MARKET PRICE AU PANIER
async function addMarketPriceToCart(marketPrice) {
    console.log('Adding Market Price to cart:', marketPrice);

    // Check available quantity
    const availableQty = marketPrice.availableQuantity || 0;
    if (availableQty <= 0) {
        showNotification('This product is out of stock', 'warning');
        return;
    }

    // Get crop details if needed
    let cropDetails = null;
    if (marketPrice.cropId) {
        try {
            const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${marketPrice.cropId}`);
            cropDetails = cropResponse.data || cropResponse;
        } catch (error) {
            console.warn('Could not load crop details:', error);
        }
    }

    // Check if already in cart
    const existingItemIndex = shoppingCart.findIndex(item =>
        item.marketPriceId === marketPrice.id
    );

    const cropName = cropDetails?.cropName || marketPrice.cropName || 'Unknown Crop';
    if (existingItemIndex !== -1) {
        const existingItem = shoppingCart[existingItemIndex];
        if (existingItem.quantity + 1 > availableQty) {
            showNotification(`Maximum ${availableQty} kg available`, 'warning');
            return;
        }
        existingItem.quantity += 1;
        showNotification('Quantity updated in cart', 'success');
        if (typeof pushBuyerNotification === 'function') {
            pushBuyerNotification('Cart updated', `Quantity updated for ${cropName}`, 'success');
        }
    } else {
        shoppingCart.push({
            marketPriceId: marketPrice.id,
            cropId: marketPrice.cropId,
            cropName,
            cropImageUrl: cropDetails?.imageUrl || marketPrice.cropImageUrl,
            price: marketPrice.pricePerKg || marketPrice.price || 0,
            quantity: 1,
            availableQuantity: availableQty,
            location: marketPrice.location || 'N/A',
            marketName: marketPrice.marketName || 'Market',
            unit: 'kg',
            type: 'market_price',
            marketType: marketPrice.marketType,
            demandLevel: marketPrice.demandLevel,
            supplyLevel: marketPrice.supplyLevel
        });
        showNotification('Product added to cart', 'success');
        if (typeof pushBuyerNotification === 'function') {
            pushBuyerNotification('Product added to cart', `${cropName} added (1 kg)`, 'success');
        }
    }

    saveCartToStorage();
    updateCartBadge();
    updateCartDisplay();
}










function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    if (!cartItems) return;

    console.log('=== UPDATING CART DISPLAY ===');
    console.log('Cart items:', shoppingCart);

    if (shoppingCart.length === 0) {
        cartItems.innerHTML = `
            <div class="empty-cart" style="text-align: center; padding: 3rem; grid-column: 1 / -1;">
                <i class="fas fa-shopping-cart" style="font-size: 4rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                <h3>Your cart is empty</h3>
                <p style="color: var(--text-light); margin-bottom: 1.5rem;">Browse our marketplace to add products</p>
                <button class="btn btn-primary" onclick="setActiveSection('marketplace')">
                    <i class="fas fa-store"></i>
                    Browse Products
                </button>
            </div>
        `;
        updateCartSummary(0, 0, 0);
        return;
    }

    cartItems.innerHTML = shoppingCart.map((item, index) => {
        console.log(`Rendering cart item ${index}:`, {
            cropName: item.cropName,
            farmerName: item.farmerName,
            farmerId: item.farmerId,
            price: item.price,
            quantity: item.quantity
        });

        return `
        <div class="cart-item" style="background: white; border-radius: var(--radius-lg); padding: 1.5rem; display: flex; gap: 1.5rem; box-shadow: var(--shadow-sm); margin-bottom: 1rem; border: 1px solid var(--border-color); transition: all 0.2s;"
             onmouseover="this.style.boxShadow='var(--shadow-md)'"
             onmouseout="this.style.boxShadow='var(--shadow-sm)'">

            <!-- Product Image -->
            <div class="cart-item-image" style="width: 120px; height: 120px; flex-shrink: 0; border-radius: var(--radius-md); overflow: hidden; background: var(--light-gray);">
                ${item.cropImageUrl ?
                    `<img src="${item.cropImageUrl}" alt="${item.cropName}"
                         style="width: 100%; height: 100%; object-fit: cover;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div style="display: none; width: 100%; height: 100%; background: var(--primary-light); align-items: center; justify-content: center; flex-direction: column;">
                         <i class="fas fa-seedling" style="font-size: 2rem; color: var(--primary-color);"></i>
                     </div>` :
                    `<div style="width: 100%; height: 100%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; flex-direction: column;">
                         <i class="fas fa-seedling" style="font-size: 2rem; color: var(--primary-color);"></i>
                     </div>`
                }
            </div>

            <!-- Product Details -->
            <div class="cart-item-details" style="flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
                <!-- Product Name -->
                <div>
                    <h4 style="margin: 0 0 0.5rem 0; font-size: 1.15rem; font-weight: 700; color: var(--text-dark);">
                        ${item.cropName}
                    </h4>

                    <!-- ⭐ FARMER NAME - HIGHLIGHTED -->
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; padding: 0.75rem; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: var(--radius-md); border-left: 3px solid var(--success-color);">
                        <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--success-color); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1rem; flex-shrink: 0;">
                            ${(item.farmerName || 'F').charAt(0).toUpperCase()}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.7rem; color: var(--success-color); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; margin-bottom: 0.15rem;">
                                <i class="fas fa-user"></i> Farmer
                            </div>
                            <div style="font-weight: 700; color: var(--text-dark); font-size: 0.95rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${item.farmerName || 'Farmer Info Unavailable'}">
                                ${item.farmerName || 'Farmer Info Unavailable'}
                            </div>
                            ${item.farmerPhone ? `
                                <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.15rem;">
                                    <i class="fas fa-phone" style="font-size: 0.7rem;"></i> ${item.farmerPhone}
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Location & Price -->
                    <div style="display: flex; gap: 1.5rem; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                            <i class="fas fa-map-marker-alt" style="color: var(--primary-color);"></i>
                            <span>${item.location}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-light);">
                            <i class="fas fa-tag" style="color: var(--primary-color);"></i>
                            <span style="font-weight: 600; color: var(--primary-color);">${formatCurrency(item.price)}/kg</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quantity Controls & Actions -->
            <div class="cart-item-controls" style="display: flex; flex-direction: column; justify-content: space-between; align-items: flex-end; min-width: 180px;">
                <!-- Remove Button -->
                <button class="cart-item-remove" onclick="removeFromCart(${index})"
                        style="background: none; border: none; color: var(--danger-color); cursor: pointer; padding: 0.5rem; font-size: 1.2rem; transition: all 0.2s; border-radius: var(--radius-md);"
                        onmouseover="this.style.background='var(--danger-light)'"
                        onmouseout="this.style.background='none'"
                        title="Remove from cart">
                    <i class="fas fa-trash"></i>
                </button>

                <!-- Quantity Control -->
                <div style="display: flex; flex-direction: column; align-items: center; gap: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; border: 2px solid var(--border-color); border-radius: var(--radius-md); padding: 0.25rem; background: white;">
                        <button class="quantity-btn" onclick="updateCartQuantity(${index}, -1)"
                                style="background: none; border: none; padding: 0.5rem 0.75rem; cursor: pointer; font-size: 1.2rem; color: var(--primary-color); transition: all 0.2s; border-radius: var(--radius-sm);"
                                onmouseover="this.style.background='var(--primary-light)'"
                                onmouseout="this.style.background='none'">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" value="${item.quantity}" min="1" max="${item.availableQuantity}"
                               onchange="updateCartQuantity(${index}, this.value - ${item.quantity})"
                               style="width: 60px; text-align: center; border: none; font-weight: 700; font-size: 1.1rem; color: var(--text-dark);"
                               readonly>
                        <button class="quantity-btn" onclick="updateCartQuantity(${index}, 1)"
                                style="background: none; border: none; padding: 0.5rem 0.75rem; cursor: pointer; font-size: 1.2rem; color: var(--primary-color); transition: all 0.2s; border-radius: var(--radius-sm);"
                                onmouseover="this.style.background='var(--primary-light)'"
                                onmouseout="this.style.background='none'">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-light);">
                        Max: ${item.availableQuantity} kg
                    </div>
                </div>

                <!-- Subtotal -->
                <div style="text-align: right; padding: 0.75rem; background: var(--light-gray); border-radius: var(--radius-md); min-width: 140px;">
                    <div style="font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">
                        Subtotal
                    </div>
                    <div style="font-size: 1.4rem; font-weight: 800; color: var(--primary-color);">
                        ${formatCurrency(item.price * item.quantity)}
                    </div>
                </div>
            </div>
        </div>
    `}).join('');

    // Update cart summary
    const subtotal = shoppingCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const shipping = calculateShipping(subtotal);
    const tax = calculateTax(subtotal);
    updateCartSummary(subtotal, shipping, tax);
}




function updateCartQuantity(index, change) {
    const item = shoppingCart[index];
    const newQuantity = item.quantity + change;

    if (newQuantity <= 0) {
        removeFromCart(index);
        return;
    }

    if (newQuantity > item.availableQuantity) {
        showNotification(`Maximum ${item.availableQuantity} kg available`, 'warning');
        return;
    }

    item.quantity = newQuantity;
    saveCartToStorage();
    updateCartDisplay();
}



function removeFromCart(index) {
    shoppingCart.splice(index, 1);
    saveCartToStorage();
    updateCartBadge();
    updateCartDisplay();
    showNotification('Product removed from cart', 'info');
}

function calculateShipping(subtotal) {
    if (subtotal === 0) return 0;
    const fixedFee = 2000;
    const percentageFee = subtotal * 0.05;
    return Math.max(fixedFee, percentageFee);
}

function calculateTax(subtotal) {
    return subtotal * 0.18;
}

function updateCartSummary(subtotal, shipping, tax) {
    const cartSubtotal = document.getElementById('cartSubtotal');
    const cartShipping = document.getElementById('cartShipping');
    const cartTax = document.getElementById('cartTax');
    const cartTotal = document.getElementById('cartTotal');

    if (cartSubtotal) cartSubtotal.textContent = formatCurrency(subtotal);
    if (cartShipping) cartShipping.textContent = formatCurrency(shipping);
    if (cartTax) cartTax.textContent = formatCurrency(tax);
    if (cartTotal) cartTotal.textContent = formatCurrency(subtotal + shipping + tax);
}




// ==================== ORDER CONFIRMATION MODAL ====================

function showOrderConfirmationModal(cartItems) {
    console.log('=== SHOWING ORDER CONFIRMATION ===');
    console.log('Cart items:', cartItems);

    if (!cartItems || cartItems.length === 0) {
        showNotification('Your cart is empty', 'warning');
        return;
    }

    // Remove any existing modals
    const existingModals = document.querySelectorAll('.modal');
    existingModals.forEach(m => m.remove());

    const modal = document.createElement('div');
    modal.className = 'modal';

    // Calculer les totaux
    const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const shipping = calculateShipping(subtotal);
    const tax = calculateTax(subtotal);
    const total = subtotal + shipping + tax;

    console.log('Totals:', { subtotal, shipping, tax, total });

    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border-radius: var(--radius-lg) var(--radius-lg) 0 0;">
                <h2><i class="fas fa-shopping-cart"></i> Confirm Your Order</h2>
                <button class="modal-close" style="color: white; background: rgba(255,255,255,0.2);">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 2rem;">
                <!-- Order Items -->
                <div class="order-summary" style="margin-bottom: 2rem;">
                    <h3 style="color: var(--text-dark); margin-bottom: 1rem; border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem;">
                        <i class="fas fa-list"></i> Order Items (${cartItems.length})
                    </h3>

                   // Dans la section où vous affichez les items dans showOrderConfirmationModal
${cartItems.map((item, index) => `
    <div class="order-item-summary" style="...">
        <div class="item-info" style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                ${item.cropImageUrl || item.imageUrl ? `...` : ''}
                <div style="flex: 1;">
                    <strong style="display: block; color: var(--text-dark); font-size: 1.1rem; margin-bottom: 0.25rem;">
                        ${item.cropName}
                    </strong>
                    <span style="color: var(--text-light); font-size: 0.9rem;">
                        <i class="fas fa-weight"></i> ${item.quantity} kg × ${formatCurrency(item.price)}/kg
                    </span>
                    <!-- ⭐ AFFICHER LE NOM DU FERMIER -->
                    <span style="display: block; color: var(--success-color); font-size: 0.85rem; margin-top: 0.25rem; font-weight: 600;">
                        <i class="fas fa-user"></i> ${item.farmerName || 'Farmer Info Unavailable'}
                    </span>
                </div>
            </div>
        </div>
        <div class="item-total" style="...">
            ${formatCurrency(item.price * item.quantity)}
        </div>
    </div>
`).join('')}

                <!-- Order Totals -->
                <div class="order-totals" style="background: var(--light-gray); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                    <div class="total-row" style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding: 0.5rem 0; font-size: 1rem;">
                        <span style="color: var(--text-light);">Subtotal:</span>
                        <span style="font-weight: 600; color: var(--text-dark);">${formatCurrency(subtotal)}</span>
                    </div>
                    <div class="total-row" style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding: 0.5rem 0; font-size: 1rem;">
                        <span style="color: var(--text-light);">Shipping Fee:</span>
                        <span style="font-weight: 600; color: var(--text-dark);">${formatCurrency(shipping)}</span>
                    </div>
                    <div class="total-row" style="display: flex; justify-content: space-between; margin-bottom: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); font-size: 1rem;">
                        <span style="color: var(--text-light);">Tax (18%):</span>
                        <span style="font-weight: 600; color: var(--text-dark);">${formatCurrency(tax)}</span>
                    </div>
                    <div class="total-row final-total" style="display: flex; justify-content: space-between; padding: 1rem 0; margin-top: 1rem; border-top: 3px solid var(--primary-color);">
                        <span style="font-size: 1.3rem; font-weight: bold; color: var(--text-dark);">
                            <i class="fas fa-receipt"></i> Total:
                        </span>
                        <span style="font-size: 1.8rem; font-weight: bold; color: var(--primary-color);">
                            ${formatCurrency(total)}
                        </span>
                    </div>
                </div>

                <!-- Delivery Information -->
                <div class="delivery-info" style="padding: 1.5rem; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: var(--radius-md); border-left: 4px solid var(--success-color); margin-bottom: 1rem;">
                    <h4 style="color: var(--success-color); margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-truck"></i> Delivery Information
                    </h4>
                    <p style="margin-bottom: 0.5rem; color: var(--text-dark);">
                        <strong><i class="fas fa-map-marker-alt"></i> Delivery Address:</strong><br>
                        <span style="margin-left: 1.5rem;">${currentUser.address || 'To be confirmed during checkout'}</span>
                    </p>
                    <p style="margin: 0; color: var(--text-dark);">
                        <strong><i class="fas fa-calendar-check"></i> Expected Delivery:</strong><br>
                        <span style="margin-left: 1.5rem;">Within 5-7 business days</span>
                    </p>
                </div>

                <!-- Payment Information -->
                <div style="padding: 1rem; background: #fff3cd; border-radius: var(--radius-md); border-left: 4px solid var(--warning-color);">
                    <p style="margin: 0; color: #856404; font-size: 0.95rem; line-height: 1.6;">
                        <i class="fas fa-info-circle"></i>
                        <strong>Payment Method:</strong> Cash on Delivery (COD)<br>
                        <span style="margin-left: 1.5rem;">You will pay when your order is delivered.</span>
                    </p>
                </div>
            </div>

            <div class="modal-footer" style="background: var(--light-gray); display: flex; gap: 1rem; justify-content: flex-end; padding: 1.5rem; border-radius: 0 0 var(--radius-lg) var(--radius-lg);">
                <button class="btn btn-secondary modal-cancel" style="padding: 0.75rem 1.5rem; font-size: 1rem;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="btn btn-primary modal-confirm" style="padding: 0.75rem 2rem; font-size: 1.1rem; box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3);">
                    <i class="fas fa-check-circle"></i> Confirm Order (${formatCurrency(total)})
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Show modal with animation
    setTimeout(() => {
        modal.classList.add('show');
        console.log('Modal displayed');
    }, 10);

    // Event listeners for modal
    const closeBtn = modal.querySelector('.modal-close');
    const cancelBtn = modal.querySelector('.modal-cancel');
    const confirmBtn = modal.querySelector('.modal-confirm');

    closeBtn.addEventListener('click', () => {
        console.log('Close button clicked');
        modal.remove();
    });

    cancelBtn.addEventListener('click', () => {
        console.log('Cancel button clicked');
        modal.remove();
    });

    confirmBtn.addEventListener('click', async () => {
        console.log('Confirm button clicked');
        await confirmOrder(confirmBtn, modal);
    });

    // Close on outside click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            console.log('Outside click');
            modal.remove();
        }
    });

    // Close on Escape key
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            console.log('Escape key pressed');
            modal.remove();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
}

// ==================== CONFIRM ORDER ====================

async function confirmOrder(confirmBtn, modal) {
    console.log('=== CONFIRMING ORDER ===');

    if (!confirmBtn) {
        console.error('Confirm button not found');
        return;
    }

    try {
        // Disable button and show loading
        confirmBtn.disabled = true;
        const originalHTML = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing Order...';

        console.log('Calling handleCheckout...');

        // Call checkout function
        await handleCheckout();

        console.log('Checkout successful');

        // Close modal on success
        if (modal) {
            modal.remove();
        }

    } catch (error) {
        console.error('Order confirmation error:', error);

        // Re-enable button on error
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirm Order';
        }

        showNotification('Failed to place order. Please try again.', 'error');
    }
}

// Make functions globally available
window.showOrderConfirmationModal = showOrderConfirmationModal;
window.confirmOrder = confirmOrder;

console.log('✅ Order confirmation functions loaded');

// ==================== ERROR HANDLING ====================

async function handleAPIError(error, context) {
    console.error(`API Error in ${context}:`, error);

    if (error.message.includes('401') || error.message.includes('Authentication')) {
        handleUnauthorized();
        return;
    }

    if (error.message.includes('404')) {
        showNotification('Resource not found. Please try again.', 'error');
        return;
    }

    if (error.message.includes('500')) {
        showNotification('Server error. Please try again later.', 'error');
        return;
    }

    showNotification(`Error: ${error.message}`, 'error');
}



async function handleCheckout() {
    if (shoppingCart.length === 0) {
        showNotification('Your cart is empty', 'warning');
        return;
    }

    if (!currentUser || !currentUser.id) {
        showNotification('Please login to complete your order', 'error');
        return;
    }

    // ⭐ IMPROVED VALIDATION - More lenient
    const invalidItems = [];
    const validItems = [];

    shoppingCart.forEach((item, index) => {
        const errors = [];

        // Essential validations only
        if (!item.cropId) {
            errors.push('Missing crop ID');
        }
        if (!item.farmerId) {
            errors.push('Missing farmer ID');
        }
        if ((!item.pricePerKg || item.pricePerKg === 0) && (!item.price || item.price === 0)) {
            errors.push('Missing price');
        }

        if (errors.length > 0) {
            invalidItems.push({
                index: index,
                item: item,
                errors: errors
            });
        } else {
            validItems.push(item);
        }
    });

    // ⭐ FIX: Only proceed with valid items
    if (validItems.length === 0) {
        console.error('❌ NO VALID ITEMS:', invalidItems);
        showNotification('No valid items to checkout. Please check cart items.', 'error');
        return;
    }

    try {
        showNotification(`Processing ${validItems.length} item(s)...`, 'info');

        const transactionPromises = validItems.map(async (item) => {
            const deliveryDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
            const formattedDeliveryDate = deliveryDate.toISOString().split('T')[0];

            // Get farmer details if not already available
            let farmerName = item.farmerName;
            if (!farmerName || farmerName === 'Unknown Farmer') {
                try {
                    const farmerResponse = await apiCall(`${API_BASE_URL}/users/${item.farmerId}`);
                    const farmer = farmerResponse.data || farmerResponse;
                    farmerName = farmer.fullName || farmer.username || 'Farmer';
                } catch (error) {
                    console.warn('Could not fetch farmer details:', error);
                    farmerName = 'Farmer';
                }
            }

            // Get crop details if not already available
            let cropName = item.cropName;
            if (!cropName || cropName === 'Unknown Crop') {
                try {
                    const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${item.cropId}`);
                    const crop = cropResponse.data || cropResponse;
                    cropName = crop.cropName || 'Product';
                } catch (error) {
                    console.warn('Could not fetch crop details:', error);
                    cropName = 'Product';
                }
            }

            const priceToUse = item.pricePerKg || item.price || 1000;

            const transactionData = {
                transactionCode: generateTransactionCode(),
                buyerId: currentUser.id,
                farmerId: item.farmerId,
                cropId: item.cropId,
                cropProductionId: item.productionId,
                quantity: item.quantity,
                pricePerUnit: priceToUse,
                totalAmount: priceToUse * item.quantity,
                transactionStatus: 'PENDING',
                paymentStatus: 'PENDING',
                paymentMethod: 'CASH',
                deliveryLocation: item.location || 'To be confirmed',
                deliveryDate: formattedDeliveryDate,
                qualityGrade: item.qualityGrade || 'STANDARD',
                packaging: item.packaging || 'BAG',
                notes: `Order for ${cropName} from ${farmerName}`
            };

            console.log('Creating transaction:', transactionData);

            return await apiCall(`${API_BASE_URL}/transactions`, {
                method: 'POST',
                body: JSON.stringify(transactionData)
            });
        });

        const createdTransactions = await Promise.all(transactionPromises);

        // ⭐ Clear only successful items from cart
        shoppingCart = shoppingCart.filter((item, index) =>
            !validItems.some(validItem => validItem === item)
        );

        saveCartToStorage();
        updateCartBadge();
        updateCartDisplay();

        showNotification(`✅ ${createdTransactions.length} order(s) placed successfully!`, 'success');
        if (typeof pushBuyerNotification === 'function') {
            pushBuyerNotification('Order placed', `${createdTransactions.length} order(s) placed successfully`, 'success');
        }

        // Refresh orders data
        setTimeout(() => {
            setActiveSection('orders');
            loadOrdersData();
        }, 2000);

    } catch (error) {
        console.error('Checkout error:', error);
        showNotification(`❌ Order failed: ${error.message}`, 'error');
    }
}











function generateTransactionCode() {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substring(2, 8);
    return `TXN-${timestamp}-${random}`.toUpperCase();
}

// Make functions globally available
window.addToCart = addToCart;
window.addMarketPriceToCart = addMarketPriceToCart;
window.addCropProductionToCart = addCropProductionToCart;
window.updateCartQuantity = updateCartQuantity;
window.removeFromCart = removeFromCart;
window.handleCheckout = handleCheckout;
window.updateCartDisplay = updateCartDisplay;

console.log('✅ Shopping cart functions loaded successfully');



  // ==================== ORDERS SECTION ====================

  async function loadOrdersData(status = 'all') {
      try {
          let orders;

          if (status === 'all') {
              const response = await apiCall(
                  `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=50&sortBy=createdAt&sortDir=desc`
              );
              orders = response.content || response;
          } else {
              orders = await apiCall(
                  ENDPOINTS.transactionsByBuyerAndStatus(currentUser.id, status.toUpperCase())
              );
          }

          // ⭐ Enrich orders with farmer and crop details
          const enrichedOrders = await Promise.all(orders.map(async (order) => {
              try {
                  // Fetch farmer details if we have farmerId
                  if (order.farmerId && !order.farmerName) {
                      const farmerResponse = await apiCall(`${API_BASE_URL}/users/${order.farmerId}`);
                      const farmer = farmerResponse.data || farmerResponse;
                      order.farmerName = farmer.fullName || farmer.username || 'Unknown Farmer';
                  }

                  // Fetch crop details if we have cropId
                  if (order.cropId && !order.cropName) {
                      const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${order.cropId}`);
                      const crop = cropResponse.data || cropResponse;
                      order.cropName = crop.cropName || crop.name || 'Unknown Product';
                  }
              } catch (error) {
                  console.warn('Error enriching order:', error);
              }

              return order;
          }));

          displayOrders(enrichedOrders);

      } catch (error) {
          console.error('Error loading orders:', error);
      }
  }




function displayOrders(orders) {
    const ordersList = document.getElementById('ordersList');
    if (!ordersList) return;

    if (!orders || orders.length === 0) {
        ordersList.innerHTML = `
            <div class="empty-state" style="text-align: center; padding: 4rem 2rem; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
                <i class="fas fa-inbox" style="font-size: 5rem; color: var(--text-light); margin-bottom: 1.5rem; opacity: 0.3;"></i>
                <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-dark);">No orders found</h3>
                <p style="color: var(--text-light); margin-bottom: 2rem;">Start shopping to see your orders here</p>
                <button class="btn btn-primary" onclick="setActiveSection('marketplace')" style="padding: 0.75rem 2rem;">
                    <i class="fas fa-store"></i> Browse Marketplace
                </button>
            </div>
        `;
        return;
    }

    ordersList.innerHTML = orders.map(order => `
        <div class="order-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden; margin-bottom: var(--spacing-lg); border: 1px solid var(--border-color); transition: all 0.2s ease;">
            <!-- Order Header -->
            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 1.25rem 1.5rem; border-bottom: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 250px;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(46, 204, 113, 0.2);">
                        <i class="fas fa-receipt" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.25rem; font-weight: 600;">
                            Order ID
                        </div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-dark); font-family: 'Courier New', monospace;">
                            ${order.transactionCode}
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="text-align: right;">
                        <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.5px;">
                            Order Status
                        </div>
                        <span class="status-badge status-${order.transactionStatus?.toLowerCase() || 'pending'}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.85rem; font-weight: 700;">
                            <i class="fas fa-${getStatusIcon(order.transactionStatus)}" style="font-size: 0.9rem;"></i>
                            ${order.transactionStatus || 'PENDING'}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Order Body - Grid Layout -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0; border-bottom: 1px solid var(--border-color);">
                <!-- Order Date -->
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: white;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="width: 40px; height: 40px; background: #e8f5e9; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-calendar-alt" style="color: var(--success-color); font-size: 1.1rem;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Order Date
                            </div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem;">
                                ${formatDate(order.createdAt)}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Farmer Info -->
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: #fafafa;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="width: 40px; height: 40px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--primary-color); font-weight: 700; color: var(--primary-dark);">
                            ${(order.farmerName || 'F').charAt(0).toUpperCase()}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Farmer
                            </div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${order.farmerName || 'Unknown Farmer'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Info -->
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: white;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="width: 40px; height: 40px; background: #fff3e0; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-seedling" style="color: var(--warning-color); font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Product
                            </div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${order.cropName || 'N/A'}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quantity -->
                <div style="padding: 1.25rem 1.5rem; background: #fafafa;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                        <div style="width: 40px; height: 40px; background: #e3f2fd; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-weight-hanging" style="color: var(--info-color); font-size: 1.1rem;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Quantity
                            </div>
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--info-color); margin-top: 0.15rem;">
                                ${order.quantity} kg
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delivery & Payment Info -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; border-bottom: 1px solid var(--border-color);">
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: white;">
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #f3e5f5; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-map-marker-alt" style="color: var(--chart-purple); font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600; margin-bottom: 0.5rem;">
                                Delivery Location
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-dark); line-height: 1.4;">
                                ${order.deliveryLocation || 'To be confirmed'}
                            </div>
                        </div>
                    </div>
                </div>

                <div style="padding: 1.25rem 1.5rem; background: #fafafa;">
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #fce4ec; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-calendar-check" style="color: var(--chart-red); font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600; margin-bottom: 0.5rem;">
                                Expected Delivery
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-dark); line-height: 1.4;">
                                ${formatDate(order.deliveryDate)}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Amount & Payment Status -->
            <div style="background: linear-gradient(135deg, #f8f9fa, #ffffff); padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; border-bottom: 2px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--success-color), #1e8449); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(39, 174, 96, 0.2);">
                        <i class="fas fa-dollar-sign" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.25rem; font-weight: 600;">
                            Total Amount
                        </div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: var(--success-color);">
                            ${formatCurrency(order.totalAmount)}
                        </div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
                        Payment Status
                    </div>
                    <span class="status-badge status-${order.paymentStatus?.toLowerCase() || 'pending'}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.85rem;">
                        <i class="fas fa-${order.paymentStatus === 'PAID' ? 'check-circle' : 'clock'}"></i>
                        ${order.paymentStatus || 'PENDING'}
                    </span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="padding: 1.25rem 1.5rem; background: white; display: flex; gap: 0.75rem; justify-content: flex-end; flex-wrap: wrap;">
                <button class="btn btn-secondary btn-sm" onclick="viewOrderDetails('${order.id}')" style="padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); font-weight: 600; transition: all 0.2s;">
                    <i class="fas fa-eye"></i>
                    View Details
                </button>
                <button class="btn btn-primary btn-sm" onclick="trackOrder('${order.id}')" style="padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); font-weight: 600; box-shadow: 0 2px 4px rgba(46, 204, 113, 0.2); transition: all 0.2s;">
                    <i class="fas fa-truck"></i>
                    Track Order
                </button>
                ${order.transactionStatus === 'PENDING' ? `
                    <button class="btn btn-sm" onclick="cancelOrder('${order.id}')" style="background: var(--danger-color); color: white; padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); border: none; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-times-circle"></i>
                        Cancel Order
                    </button>
                ` : ''}
                ${order.transactionStatus === 'DELIVERED' ? `
                    <button class="btn btn-sm" onclick="leaveReview('${order.id}')" style="background: var(--warning-color); color: white; padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); border: none; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-star"></i>
                        Leave Review
                    </button>
                ` : ''}
            </div>
        </div>
    `).join('');
}

// Helper function for status icons (add if not exists)
function getStatusIcon(status) {
    const icons = {
        'PENDING': 'clock',
        'CONFIRMED': 'check',
        'PROCESSING': 'cog',
        'SHIPPED': 'truck',
        'DELIVERED': 'check-circle',
        'CANCELLED': 'times-circle',
        'COMPLETED': 'check-double'
    };
    return icons[status?.toUpperCase()] || 'clock';
}

  async function searchOrders(query) {
      try {
          const response = await apiCall(
              `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=100`
          );
          const allOrders = response.content || response;

          const filtered = allOrders.filter(order =>
              order.transactionCode?.toLowerCase().includes(query.toLowerCase()) ||
              order.cropName?.toLowerCase().includes(query.toLowerCase()) ||
              order.farmerName?.toLowerCase().includes(query.toLowerCase())
          );

          displayOrders(filtered);
      } catch (error) {
          console.error('Error searching orders:', error);
      }
  }

  async function viewOrderDetails(orderId) {
      try {
          const order = await apiCall(ENDPOINTS.transactionById(orderId));
          
          // ⭐ Enrich order with farmer and crop details
          try {
              // Fetch farmer details if we have farmerId
              if (order.farmerId && !order.farmerName) {
                  const farmerResponse = await apiCall(`${API_BASE_URL}/users/${order.farmerId}`);
                  const farmer = farmerResponse.data || farmerResponse;
                  order.farmerName = farmer.fullName || farmer.username || 'Unknown Farmer';
                  order.farmer = order.farmer || farmer;
              }

              // Fetch crop details if we have cropId
              if (order.cropId && !order.cropName) {
                  const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${order.cropId}`);
                  const crop = cropResponse.data || cropResponse;
                  order.cropName = crop.cropName || crop.name || 'Unknown Product';
                  order.crop = order.crop || crop;
              }
          } catch (error) {
              console.warn('Error enriching order details:', error);
          }

          showOrderDetailsModal(order);
      } catch (error) {
          console.error('Error loading order details:', error);
          showNotification('Failed to load order details', 'error');
      }
  }

function showOrderDetailsModal(order) {
    // Remove any existing modals
    const existingModals = document.querySelectorAll('.modal');
    existingModals.forEach(m => m.remove());

    // Create and show modal with order details
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; padding: 1.5rem 2rem; border-radius: var(--radius-lg) var(--radius-lg) 0 0; position: relative;">
                <div>
                    <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">
                        <i class="fas fa-receipt"></i> Order Details
                    </h2>
                    <p style="margin: 0; opacity: 0.9; font-size: 0.9rem;">
                        ${order.transactionCode || 'N/A'}
                    </p>
                </div>
                <button class="modal-close" onclick="this.closest('.modal').remove()"
                        style="position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; transition: all 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body" style="padding: 0;">
                <!-- Farmer & Product Info Section -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; border-bottom: 2px solid var(--border-color);">
                    <!-- Farmer Info -->
                    <div style="padding: 1.5rem; border-right: 1px solid var(--border-color); background: linear-gradient(135deg, #f8f9fa, #ffffff);">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 50px; height: 50px; border-radius: 50%; background: var(--primary-light); display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 700; color: var(--primary-dark); border: 3px solid var(--primary-color);">
                                ${(order.farmerName || order.farmer?.fullName || 'F').charAt(0).toUpperCase()}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">
                                    <i class="fas fa-user"></i> Farmer
                                </div>
                                <div style="font-weight: 700; color: var(--text-dark); font-size: 1.1rem;">
                                    ${order.farmerName || order.farmer?.fullName || order.farmer?.username || 'Unknown Farmer'}
                                </div>
                                ${order.farmer?.phoneNumber ? `
                                    <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">
                                        <i class="fas fa-phone"></i> ${order.farmer.phoneNumber}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Product Info -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, #ffffff, #f8f9fa);">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            ${order.cropImageUrl || order.crop?.imageUrl ? `
                                <img src="${order.cropImageUrl || order.crop?.imageUrl}"
                                     style="width: 50px; height: 50px; border-radius: var(--radius-md); object-fit: cover; border: 3px solid var(--primary-color);"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div style="display: none; width: 50px; height: 50px; background: var(--primary-light); border-radius: var(--radius-md); align-items: center; justify-content: center; border: 3px solid var(--primary-color);">
                                    <i class="fas fa-seedling" style="font-size: 1.5rem; color: var(--primary-color);"></i>
                                </div>
                            ` : `
                                <div style="width: 50px; height: 50px; background: var(--primary-light); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; border: 3px solid var(--primary-color);">
                                    <i class="fas fa-seedling" style="font-size: 1.5rem; color: var(--primary-color);"></i>
                                </div>
                            `}
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">
                                    <i class="fas fa-seedling"></i> Product
                                </div>
                                <div style="font-weight: 700; color: var(--text-dark); font-size: 1.1rem;">
                                    ${order.cropName || order.crop?.cropName || order.productName || 'Unknown Product'}
                                </div>
                                ${order.cropType || order.crop?.cropType ? `
                                    <div style="font-size: 0.85rem; color: var(--text-light); margin-top: 0.25rem;">
                                        <i class="fas fa-tag"></i> ${order.cropType || order.crop?.cropType}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Details Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; padding: 1.5rem 0;">
                    ${[
                        { icon: 'weight', label: 'Quantity', value: `${order.quantity} kg` },
                        { icon: 'dollar-sign', label: 'Price per Unit', value: formatCurrency(order.pricePerUnit) + '/kg' },
                        { icon: 'receipt', label: 'Total Amount', value: formatCurrency(order.totalAmount), highlight: true },
                        { icon: 'credit-card', label: 'Payment Method', value: order.paymentMethod || 'N/A' },
                        { icon: 'info-circle', label: 'Payment Status', value: `<span class="status-badge status-${order.paymentStatus?.toLowerCase() || 'pending'}">${order.paymentStatus || 'PENDING'}</span>`, raw: true },
                        { icon: 'clipboard-check', label: 'Order Status', value: `<span class="status-badge status-${order.transactionStatus?.toLowerCase() || 'pending'}">${order.transactionStatus || 'PENDING'}</span>`, raw: true },
                        { icon: 'map-marker-alt', label: 'Delivery Location', value: order.deliveryLocation || 'To be confirmed' },
                        { icon: 'calendar-check', label: 'Expected Delivery', value: formatDate(order.deliveryDate) },
                        { icon: 'calendar', label: 'Order Date', value: formatDate(order.createdAt) },
                        { icon: 'truck', label: 'Delivery Date', value: order.actualDeliveryDate ? formatDate(order.actualDeliveryDate) : 'Pending' }
                    ].map((item, index) => `
                        <div style="padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); ${index % 2 === 0 ? 'border-right: 1px solid var(--border-color);' : ''} ${index < 2 ? 'background: var(--light-gray);' : ''}">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 35px; height: 35px; background: ${item.highlight ? 'var(--primary-color)' : 'var(--primary-light)'}; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <i class="fas fa-${item.icon}" style="color: ${item.highlight ? 'white' : 'var(--primary-color)'};"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 0.25rem;">
                                        ${item.label}
                                    </div>
                                    <div style="font-weight: ${item.highlight ? '700' : '600'}; color: ${item.highlight ? 'var(--primary-color)' : 'var(--text-dark)'}; font-size: ${item.highlight ? '1.2rem' : '1rem'}; word-break: break-word;">
                                        ${item.raw ? item.value : `<span>${item.value}</span>`}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <!-- Notes Section (if exists) -->
                ${order.notes ? `
                    <div style="padding: 1.5rem 2rem; background: var(--light-gray); border-top: 2px solid var(--border-color);">
                        <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                            <div style="width: 35px; height: 35px; background: var(--info-color); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-sticky-note" style="color: white;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 0.5rem;">
                                    <i class="fas fa-info-circle"></i> Notes
                                </div>
                                <div style="color: var(--text-dark); line-height: 1.6;">
                                    ${order.notes}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            </div>

            <div class="modal-footer" style="padding: 1.5rem 2rem; background: var(--light-gray); border-radius: 0 0 var(--radius-lg) var(--radius-lg); display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="padding: 0.75rem 1.5rem;">
                    <i class="fas fa-times"></i> Close
                </button>
                <button class="btn btn-primary" onclick="trackOrder('${order.id}'); this.closest('.modal').remove();" style="padding: 0.75rem 1.5rem;">
                    <i class="fas fa-truck"></i> Track Order
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);

    // Close on outside click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });

    // Close on Escape key
    const handleEscape = (e) => {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
}

  async function cancelOrder(orderId) {
      if (!confirm('Are you sure you want to cancel this order?')) {
          return;
      }

      try {
          await apiCall(`${ENDPOINTS.transactionById(orderId)}/cancel`, {
              method: 'PUT',
              body: JSON.stringify({ reason: 'Cancelled by buyer' })
          });

          showNotification('Order cancelled successfully', 'success');
          await loadOrdersData();

      } catch (error) {
          console.error('Error cancelling order:', error);
          showNotification('Failed to cancel order', 'error');
      }
  }









  // ==================== TRANSACTIONS SECTION ====================

  async function loadTransactionsData() {
      try {
          const response = await apiCall(
              `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=100&sortBy=createdAt&sortDir=desc`
          );

          const transactions = response.content || response;

          // ⭐ Enrich transactions with crop details
          const enrichedTransactions = await Promise.all(transactions.map(async (txn) => {
              try {
                  // Fetch crop details if we have cropId
                  if (txn.cropId && !txn.cropName) {
                      const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${txn.cropId}`);
                      const crop = cropResponse.data || cropResponse;
                      txn.cropName = crop.cropName || crop.name || 'Unknown Product';
                  }
              } catch (error) {
                  console.warn('Error enriching transaction:', error);
              }

              return txn;
          }));

          displayTransactions(enrichedTransactions);

      } catch (error) {
          console.error('Error loading transactions:', error);
      }
  }

function displayTransactions(transactions) {
    const transactionsList = document.getElementById('transactionsList');
    if (!transactionsList) return;

    if (!transactions || transactions.length === 0) {
        transactionsList.innerHTML = `
            <div class="empty-state" style="text-align: center; padding: 4rem 2rem; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm);">
                <i class="fas fa-receipt" style="font-size: 5rem; color: var(--text-light); margin-bottom: 1.5rem; opacity: 0.3;"></i>
                <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-dark);">No transactions found</h3>
                <p style="color: var(--text-light); margin-bottom: 2rem;">Your transaction history will appear here</p>
            </div>
        `;
        return;
    }

    // Calculate statistics
    const completed = transactions.filter(t => t.paymentStatus === 'COMPLETED' || t.paymentStatus === 'PAID').length;
    const pending = transactions.filter(t => t.paymentStatus === 'PENDING').length;
    const totalVolume = transactions.reduce((sum, t) => sum + (t.totalAmount || 0), 0);

    // Update stat cards
    document.getElementById('completedTransactions').textContent = completed;
    document.getElementById('pendingTransactions').textContent = pending;
    document.getElementById('totalTransactionVolume').textContent = formatCurrency(totalVolume);

    transactionsList.innerHTML = transactions.map((txn, index) => `
        <div class="transaction-card" style="background: white; border-radius: var(--radius-lg); padding: 0; box-shadow: var(--shadow-sm); overflow: hidden; margin-bottom: 1rem; border: 1px solid var(--border-color); transition: all 0.2s ease;">

            <!-- Transaction Header -->
            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 1.25rem 1.5rem; border-bottom: 2px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 250px;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--info-color), #1e5a8e); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(52, 152, 219, 0.2);">
                        <i class="fas fa-receipt" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.25rem; font-weight: 600;">
                            Transaction ID
                        </div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--text-dark); font-family: 'Courier New', monospace;">
                            ${txn.transactionCode}
                        </div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="text-align: right;">
                        <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.5px;">
                            Payment Status
                        </div>
                        <span class="status-badge status-${txn.paymentStatus?.toLowerCase() || 'pending'}" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.85rem; font-weight: 700;">
                            <i class="fas fa-${txn.paymentStatus === 'COMPLETED' || txn.paymentStatus === 'PAID' ? 'check-circle' : txn.paymentStatus === 'FAILED' ? 'times-circle' : 'clock'}"></i>
                            ${txn.paymentStatus || 'PENDING'}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Transaction Body - Grid Layout -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0; border-bottom: 1px solid var(--border-color);">

                <!-- Date & Time -->
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: white;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #e8f5e9; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-calendar-alt" style="color: var(--success-color); font-size: 1.1rem;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Transaction Date
                            </div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem;">
                                ${formatDateTime(txn.createdAt)}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Reference -->
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: #fafafa;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #fff3e0; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-shopping-cart" style="color: var(--warning-color); font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Order ID
                            </div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${txn.id}">
                                ${txn.id.substring(0, 12)}...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Description -->
                <div style="padding: 1.25rem 1.5rem; border-right: 1px solid var(--border-color); background: white;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #e3f2fd; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-seedling" style="color: var(--info-color); font-size: 1.1rem;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Product
                            </div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${txn.cropName || 'N/A'}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.15rem;">
                                ${txn.quantity || 0} kg
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Method -->
                <div style="padding: 1.25rem 1.5rem; background: #fafafa;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <div style="width: 40px; height: 40px; background: #f3e5f5; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-credit-card" style="color: var(--chart-purple); font-size: 1.1rem;"></i>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600;">
                                Payment Method
                            </div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--text-dark); margin-top: 0.15rem;">
                                ${txn.paymentMethod || 'N/A'}
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Amount & Actions -->
            <div style="background: linear-gradient(135deg, #f8f9fa, #ffffff); padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--success-color), #1e8449); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(39, 174, 96, 0.2);">
                        <i class="fas fa-dollar-sign" style="color: white; font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.25rem; font-weight: 600;">
                            Amount
                        </div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: var(--success-color);">
                            ${formatCurrency(txn.totalAmount)}
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary btn-sm" onclick="viewTransactionDetails('${txn.id}')" style="padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); font-weight: 600; transition: all 0.2s;">
                        <i class="fas fa-eye"></i>
                        View Details
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="downloadInvoice('${txn.id}')" style="padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); font-weight: 600; box-shadow: 0 2px 4px rgba(46, 204, 113, 0.2); transition: all 0.2s;">
                        <i class="fas fa-download"></i>
                        Invoice
                    </button>
                </div>
            </div>

        </div>
    `).join('');
}

  async function viewTransactionDetails(transactionId) {
      await viewOrderDetails(transactionId);
  }

  async function downloadInvoice(transactionId) {
      try {
          showNotification('Generating invoice...', 'info');
          
          // Fetch transaction details
          const response = await apiCall(ENDPOINTS.transactionById(transactionId));
          const transaction = response.data || response;

          // Enrich transaction with farmer and crop details if needed
          try {
              if (transaction.farmerId && !transaction.farmerName) {
                  const farmerResponse = await apiCall(`${API_BASE_URL}/users/${transaction.farmerId}`);
                  const farmer = farmerResponse.data || farmerResponse;
                  transaction.farmerName = farmer.fullName || farmer.username || 'Unknown Farmer';
              }

              if (transaction.cropId && !transaction.cropName) {
                  const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${transaction.cropId}`);
                  const crop = cropResponse.data || cropResponse;
                  transaction.cropName = crop.cropName || crop.name || 'Unknown Product';
              }
          } catch (error) {
              console.warn('Error enriching transaction for invoice:', error);
          }

          // Generate PDF using jsPDF
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // Colors
          const primaryColor = [34, 197, 94]; // Green #22c55e
          const darkColor = [22, 163, 74]; // Dark green #16a34a
          const textColor = [51, 51, 51]; // Dark text
          const lightGray = [200, 200, 200];

          // Header with background
          doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
          doc.rect(0, 0, 210, 50, 'F');

          // Try to add logo
          let logoAdded = false;
          try {
              const img = new Image();
              img.crossOrigin = 'anonymous';
              
              // Use a promise to handle logo loading
              await new Promise((resolve, reject) => {
                  img.onload = function() {
                      try {
                          const canvas = document.createElement('canvas');
                          canvas.width = Math.min(img.width, 100);
                          canvas.height = Math.min(img.height, 100);
                          const ctx = canvas.getContext('2d');
                          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                          
                          const imgData = canvas.toDataURL('image/jpeg');
                          doc.addImage(imgData, 'JPEG', 15, 8, 30, 30);
                          logoAdded = true;
                          resolve();
                      } catch (e) {
                          reject(e);
                      }
                  };
                  
                  img.onerror = function() {
                      reject(new Error('Failed to load logo'));
                  };
                  
                  img.src = 'images/logo.jpeg';
                  
                  // Timeout after 2 seconds
                  setTimeout(() => {
                      if (!logoAdded) {
                          reject(new Error('Logo loading timeout'));
                      }
                  }, 2000);
              });
          } catch (error) {
              console.warn('Logo not loaded, continuing without logo:', error);
              logoAdded = false;
          }

          // Company info - adjust position based on logo
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(24);
          doc.setFont(undefined, 'bold');
          doc.text('AgriGuard AI', logoAdded ? 50 : 15, 20);
          
          doc.setFontSize(12);
          doc.setFont(undefined, 'normal');
          doc.text('Smart Agriculture System', logoAdded ? 50 : 15, 28);
          doc.text('Invoice', logoAdded ? 50 : 15, 35);

          generateInvoiceContent(doc, transaction, primaryColor, darkColor, textColor, lightGray);
          
          // Save PDF
          const fileName = `Invoice_${transaction.transactionCode || transaction.id}.pdf`;
          doc.save(fileName);
          
          showNotification('Invoice downloaded successfully!', 'success');
      } catch (error) {
          console.error('Error generating invoice:', error);
          showNotification('Failed to generate invoice: ' + error.message, 'error');
      }
  }

  function generateInvoiceContent(doc, transaction, primaryColor, darkColor, textColor, lightGray) {
      let yPos = 60;

      // Invoice details section
      doc.setTextColor(textColor[0], textColor[1], textColor[2]);
      doc.setFontSize(10);
      
      // Invoice number and date
      doc.setFont(undefined, 'bold');
      doc.text('Invoice Number:', 15, yPos);
      doc.setFont(undefined, 'normal');
      doc.text(transaction.transactionCode || 'N/A', 60, yPos);
      
      yPos += 7;
      doc.setFont(undefined, 'bold');
      doc.text('Invoice Date:', 15, yPos);
      doc.setFont(undefined, 'normal');
      doc.text(formatDate(transaction.createdAt) || 'N/A', 60, yPos);
      
      yPos += 7;
      doc.setFont(undefined, 'bold');
      doc.text('Transaction ID:', 15, yPos);
      doc.setFont(undefined, 'normal');
      doc.text(transaction.id || 'N/A', 60, yPos);

      yPos += 15;

      // Divider line
      doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
      doc.line(15, yPos, 195, yPos);
      yPos += 10;

      // Buyer Information
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
      doc.text('Bill To:', 15, yPos);
      
      yPos += 7;
      doc.setFontSize(10);
      doc.setTextColor(textColor[0], textColor[1], textColor[2]);
      doc.setFont(undefined, 'normal');
      const buyerName = currentUser?.fullName || currentUser?.username || 'Buyer';
      doc.text(buyerName, 15, yPos);
      
      if (currentUser?.email) {
          yPos += 6;
          doc.text(`Email: ${currentUser.email}`, 15, yPos);
      }
      
      if (currentUser?.phoneNumber) {
          yPos += 6;
          doc.text(`Phone: ${currentUser.phoneNumber}`, 15, yPos);
      }

      yPos += 15;

      // Seller/Farmer Information
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
      doc.text('Sold By:', 15, yPos);
      
      yPos += 7;
      doc.setFontSize(10);
      doc.setTextColor(textColor[0], textColor[1], textColor[2]);
      doc.setFont(undefined, 'normal');
      doc.text(transaction.farmerName || 'Unknown Farmer', 15, yPos);

      yPos += 15;

      // Divider line
      doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
      doc.line(15, yPos, 195, yPos);
      yPos += 10;

      // Items table header
      doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
      doc.rect(15, yPos, 180, 8, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFont(undefined, 'bold');
      doc.setFontSize(10);
      doc.text('Item Description', 18, yPos + 5.5);
      doc.text('Quantity', 120, yPos + 5.5);
      doc.text('Price/Unit', 150, yPos + 5.5);
      doc.text('Amount', 175, yPos + 5.5);
      
      yPos += 8;

      // Item row
      doc.setTextColor(textColor[0], textColor[1], textColor[2]);
      doc.setFont(undefined, 'normal');
      const productName = transaction.cropName || 'Unknown Product';
      const quantity = transaction.quantity || 0;
      const pricePerUnit = transaction.pricePerUnit || 0;
      const totalAmount = transaction.totalAmount || 0;
      
      doc.text(productName, 18, yPos + 5.5);
      doc.text(`${quantity} kg`, 120, yPos + 5.5);
      doc.text(`RF ${pricePerUnit.toFixed(2)}`, 150, yPos + 5.5);
      doc.text(`RF ${totalAmount.toFixed(2)}`, 175, yPos + 5.5);
      
      yPos += 8;

      // Line separator
      doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
      doc.line(15, yPos, 195, yPos);
      yPos += 10;

      // Total section
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.text('Subtotal:', 150, yPos);
      doc.text(`RF ${totalAmount.toFixed(2)}`, 175, yPos);
      
      yPos += 7;
      
      const paymentMethod = transaction.paymentMethod || 'CASH';
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text(`Payment Method: ${paymentMethod}`, 150, yPos);
      
      yPos += 7;
      
      doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
      doc.rect(150, yPos - 5, 45, 8, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      doc.text('Total:', 152, yPos + 2);
      doc.text(`RF ${totalAmount.toFixed(2)}`, 175, yPos + 2);

      yPos += 20;

      // Payment status
      doc.setTextColor(textColor[0], textColor[1], textColor[2]);
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      const paymentStatus = transaction.paymentStatus || 'PENDING';
      doc.text(`Payment Status: ${paymentStatus}`, 15, yPos);

      yPos += 15;

      // Footer
      doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
      doc.line(15, yPos, 195, yPos);
      yPos += 10;

      doc.setFontSize(8);
      doc.setTextColor(100, 100, 100);
      doc.text('Thank you for your business!', 15, yPos);
      yPos += 5;
      doc.text('This is a computer-generated invoice.', 15, yPos);
      yPos += 5;
      doc.text('For any inquiries, please contact AgriGuard AI support.', 15, yPos);
  }





async function loadTrackingData() {
    try {
        console.log('=== LOADING TRACKING DATA ===');

        // Get all buyer transactions
        const response = await apiCall(
            `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=50`
        );

        const orders = response.content || response;
        console.log('Orders loaded:', orders.length);

        // ⭐ Enrich orders with crop details
        const enrichedOrders = await Promise.all(orders.map(async (order) => {
            try {
                // Fetch crop details if we have cropId
                if (order.cropId && !order.cropName) {
                    const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${order.cropId}`);
                    const crop = cropResponse.data || cropResponse;
                    order.cropName = crop.cropName || crop.name || 'Unknown Product';
                }
            } catch (error) {
                console.warn('Error enriching order with crop:', error);
            }
            return order;
        }));

        // ⭐ Get supply chain info for each order - Try multiple methods
        const trackingPromises = enrichedOrders.map(async order => {
            try {
                let supplyChainList = null;
                let allStages = [];

                // Method 1: Try to get supply chain by transaction ID
                try {
                    const transactionSupplyChain = await apiCall(
                        `${API_BASE_URL}/supply-chain/transaction/${order.id}`
                    );
                    if (transactionSupplyChain && (Array.isArray(transactionSupplyChain) || transactionSupplyChain.data)) {
                        supplyChainList = Array.isArray(transactionSupplyChain) ? transactionSupplyChain : transactionSupplyChain.data;
                    }
                } catch (error) {
                    console.warn(`No supply chain found by transaction ID for ${order.id}`);
                }

                // Method 2: Try to get supply chain by crop production ID
                if (!supplyChainList && order.cropProductionId) {
                    try {
                        const productionSupplyChain = await apiCall(
                            `${API_BASE_URL}/supply-chain/crop-production/${order.cropProductionId}`
                        );
                        if (productionSupplyChain && (Array.isArray(productionSupplyChain) || productionSupplyChain.data)) {
                            supplyChainList = Array.isArray(productionSupplyChain) ? productionSupplyChain : productionSupplyChain.data;
                        }
                    } catch (error) {
                        console.warn(`No supply chain found for production ${order.cropProductionId}`);
                    }
                }

                // Process supply chain data
                if (supplyChainList && Array.isArray(supplyChainList) && supplyChainList.length > 0) {
                    // Sort by stage start date
                    allStages = supplyChainList.sort((a, b) => {
                        const dateA = new Date(a.stageStartDate || a.createdAt || 0);
                        const dateB = new Date(b.stageStartDate || b.createdAt || 0);
                        return dateA - dateB;
                    });
                    
                    // Get the latest/active stage
                    const latestStage = allStages[allStages.length - 1];
                    
                    return { order, supplyChain: latestStage, allStages: allStages };
                }

                // If no supply chain found, still return order with status-based tracking
                return { order, supplyChain: null, allStages: [] };
            } catch (error) {
                console.error(`Error loading tracking for order ${order.transactionCode}:`, error);
                return { order, supplyChain: null, allStages: [] };
            }
        });

        const trackingData = await Promise.all(trackingPromises);
        console.log('Tracking data loaded:', trackingData.length);

        displayTrackingInfo(trackingData);

    } catch (error) {
        console.error('=== ERROR LOADING TRACKING DATA ===', error);
        showNotification('Failed to load tracking information', 'error');
    }
}




function displayTrackingInfo(trackingData) {
    const trackingList = document.getElementById('trackingList');
    if (!trackingList) return;

    if (!trackingData || trackingData.length === 0) {
        trackingList.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
                <i class="fas fa-truck" style="font-size: 4rem; color: var(--text-light); margin-bottom: 1rem;"></i>
                <h3>No deliveries to track</h3>
                <p style="color: var(--text-light);">Your orders will appear here once they are being processed</p>
            </div>
        `;
        return;
    }

    trackingList.innerHTML = trackingData.map(({ order, supplyChain, allStages = [] }) => {
        // Determine current stage and progress based on supply chain data or transaction status
        let currentStage = null;
        let currentStageIndex = -1;
        
        const stages = [
            { key: 'ORDERED', label: 'Order Placed', icon: 'fa-shopping-cart', description: 'Your order has been received' },
            { key: 'CONFIRMED', label: 'Order Confirmed', icon: 'fa-check-circle', description: 'Order confirmed by farmer' },
            { key: 'HARVESTED', label: 'Harvested', icon: 'fa-seedling', description: 'Product has been harvested' },
            { key: 'PROCESSED', label: 'Processed', icon: 'fa-cogs', description: 'Product is being processed' },
            { key: 'IN_TRANSIT', label: 'In Transit', icon: 'fa-truck', description: 'Product is on the way' },
            { key: 'OUT_FOR_DELIVERY', label: 'Out for Delivery', icon: 'fa-truck-fast', description: 'Out for delivery' },
            { key: 'DELIVERED', label: 'Delivered', icon: 'fa-check-double', description: 'Successfully delivered' }
        ];
        
        // If we have supply chain stages, use them
        if (allStages && allStages.length > 0) {
            // Find the highest completed stage
            const completedStages = allStages.map(sc => sc.stage).filter(Boolean);
            if (completedStages.length > 0) {
                // Find the stage in our stages array
                const lastCompletedStage = completedStages[completedStages.length - 1];
                currentStage = lastCompletedStage;
                currentStageIndex = stages.findIndex(s => s.key === lastCompletedStage);
                
                // If exact match not found, use the latest supply chain stage
                if (currentStageIndex === -1 && supplyChain) {
                    currentStage = supplyChain.stage;
                    currentStageIndex = stages.findIndex(s => s.key === supplyChain.stage);
                }
            }
        }
        
        // Fallback to transaction status mapping if no supply chain data
        if (currentStageIndex === -1) {
            const statusToStage = {
                'PENDING': 'ORDERED',
                'CONFIRMED': 'CONFIRMED',
                'PROCESSING': 'PROCESSED',
                'SHIPPED': 'IN_TRANSIT',
                'OUT_FOR_DELIVERY': 'OUT_FOR_DELIVERY',
                'DELIVERED': 'DELIVERED'
            };
            
            const mappedStage = statusToStage[order.transactionStatus] || 'ORDERED';
            currentStage = mappedStage;
            currentStageIndex = stages.findIndex(s => s.key === mappedStage);
            if (currentStageIndex === -1) currentStageIndex = 0;
        }

        // Calculate progress percentage
        const progressPercentage = ((currentStageIndex + 1) / stages.length) * 100;

        // Generate stage time from supply chain data or estimated
        const generateStageTime = (index, stageKey) => {
            // Try to find this stage in supply chain data
            const stageData = allStages.find(sc => sc.stage === stageKey);
            if (stageData && stageData.stageStartDate) {
                return formatDateTime(stageData.stageStartDate);
            }
            
            // Fallback to estimated time
            if (index > currentStageIndex) return null;
            if (index === currentStageIndex) return 'In Progress';
            const daysAgo = currentStageIndex - index;
            if (daysAgo === 0) return 'Today';
            if (daysAgo === 1) return '1 day ago';
            return `${daysAgo} days ago`;
        };

        return `
            <div class="tracking-card" style="background: white; border-radius: var(--radius-lg); padding: var(--spacing-lg); box-shadow: var(--shadow-sm); margin-bottom: var(--spacing-md); border: 1px solid var(--border-color); transition: all 0.3s ease;">
                <div class="tracking-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg); padding-bottom: var(--spacing-md); border-bottom: 2px solid var(--border-color);">
                    <div>
                        <h3 style="margin: 0; color: var(--text-dark); font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                            <i class="fas fa-box" style="color: var(--primary-color);"></i> 
                            <span>${order.transactionCode || order.id}</span>
                        </h3>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-light); font-size: 0.9rem;">
                            Order placed on ${formatDate(order.createdAt)}
                        </p>
                    </div>
                    <span class="status-badge status-${order.transactionStatus?.toLowerCase() || 'pending'}" style="padding: 0.5rem 1rem; border-radius: var(--radius-md); font-weight: 600;">
                        ${order.transactionStatus || 'PENDING'}
                    </span>
                </div>

                <div class="tracking-body" style="display: grid; grid-template-columns: 1fr 1.5fr; gap: var(--spacing-lg);">
                    <!-- Order Information -->
                    <div class="tracking-info" style="background: linear-gradient(135deg, #f8f9fa, #ffffff); padding: var(--spacing-md); border-radius: var(--radius-md); border: 1px solid var(--border-color);">
                        <h4 style="margin: 0 0 1rem 0; color: var(--text-dark); font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-info-circle" style="color: var(--primary-color);"></i> 
                            Order Details
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: var(--radius-sm); border-left: 3px solid var(--primary-color);">
                                <i class="fas fa-seedling" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 1rem;"></i>
                                <div style="flex: 1;">
                                    <div style="font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.15rem;">Product</div>
                                    <div style="font-weight: 600; color: var(--text-dark); font-size: 0.95rem;">${order.cropName || 'Unknown Product'}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: var(--radius-sm);">
                                <i class="fas fa-weight" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 1rem;"></i>
                                <div style="flex: 1;">
                                    <div style="font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.15rem;">Quantity</div>
                                    <div style="font-weight: 600; color: var(--text-dark); font-size: 0.95rem;">${order.quantity || 0} kg</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: var(--radius-sm);">
                                <i class="fas fa-calendar" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 1rem;"></i>
                                <div style="flex: 1;">
                                    <div style="font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.15rem;">Expected Delivery</div>
                                    <div style="font-weight: 600; color: var(--text-dark); font-size: 0.95rem;">${order.deliveryDate ? formatDate(order.deliveryDate) : 'To be confirmed'}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border-radius: var(--radius-sm);">
                                <i class="fas fa-map-marker-alt" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: var(--primary-color); font-size: 1rem;"></i>
                                <div style="flex: 1;">
                                    <div style="font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.15rem;">Delivery Location</div>
                                    <div style="font-weight: 600; color: var(--text-dark); font-size: 0.95rem;">${order.deliveryLocation || 'Location not specified'}</div>
                                </div>
                            </div>
                            ${supplyChain && supplyChain.currentLocation ? `
                                <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: var(--radius-sm); border-left: 3px solid var(--success-color);">
                                    <i class="fas fa-location-arrow" style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; color: var(--success-color); font-size: 1rem;"></i>
                                    <div style="flex: 1;">
                                        <div style="font-size: 0.7rem; color: var(--success-color); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.15rem; font-weight: 600;">Current Location</div>
                                        <div style="font-weight: 700; color: var(--text-dark); font-size: 0.95rem;">${supplyChain.currentLocation}</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Enhanced Tracking Timeline -->
                    <div class="tracking-timeline" style="position: relative;">
                        ${supplyChain || order.transactionStatus ? `
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-size: 0.85rem; color: var(--text-light); font-weight: 600;">Progress</span>
                                    <span style="font-size: 0.85rem; color: var(--primary-color); font-weight: 700;">${Math.round(progressPercentage)}%</span>
                                </div>
                                <div style="background: #e5e7eb; height: 8px; border-radius: 10px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, var(--primary-color), var(--primary-dark)); height: 100%; width: ${progressPercentage}%; transition: width 0.5s ease; border-radius: 10px;"></div>
                                </div>
                            </div>
                            <div class="timeline" style="position: relative; padding-left: 2.5rem;">
                                ${stages.map((stage, index) => {
                                    const isCompleted = index <= currentStageIndex;
                                    const isCurrent = index === currentStageIndex;
                                    const stageTime = generateStageTime(index, stage.key);
                                    const stageData = allStages.find(sc => sc.stage === stage.key);
                                    const stageDate = stageData && stageData.stageStartDate 
                                        ? formatDateTime(stageData.stageStartDate)
                                        : (index <= currentStageIndex && order.createdAt 
                                            ? (() => {
                                                const date = new Date(order.createdAt);
                                                date.setDate(date.getDate() + (currentStageIndex - index));
                                                return formatDateTime(date);
                                              })()
                                            : null);

                                    return `
                                        <div class="timeline-item" style="position: relative; padding-bottom: ${index < stages.length - 1 ? '2rem' : '0'};">
                                            <div class="timeline-icon" style="position: absolute; left: -2.5rem; width: 44px; height: 44px; background: ${isCompleted ? 'linear-gradient(135deg, var(--success-color), var(--primary-dark))' : '#e5e7eb'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.1rem; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 2; transition: all 0.3s ease; ${isCurrent ? 'animation: pulse 2s infinite; transform: scale(1.1);' : ''}">
                                                <i class="fas ${stage.icon}"></i>
                                            </div>
                                            <div class="timeline-content" style="padding-left: 0.5rem;">
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                                    <h4 style="margin: 0; color: ${isCompleted ? 'var(--text-dark)' : 'var(--text-light)'}; font-size: 1rem; font-weight: ${isCurrent ? '700' : '600'};">
                                                        ${stage.label}
                                                        ${isCurrent ? '<span style="color: var(--success-color); font-weight: 600; margin-left: 0.5rem; font-size: 0.85rem;">• Current</span>' : ''}
                                                        ${isCompleted && !isCurrent ? '<i class="fas fa-check" style="color: var(--success-color); margin-left: 0.5rem; font-size: 0.85rem;"></i>' : ''}
                                                </h4>
                                                </div>
                                                <p style="margin: 0 0 0.25rem 0; color: var(--text-light); font-size: 0.85rem;">
                                                    ${stage.description}
                                                </p>
                                                ${stageTime ? `
                                                    <p style="margin: 0; color: ${isCurrent ? 'var(--primary-color)' : 'var(--text-light)'}; font-size: 0.8rem; font-weight: ${isCurrent ? '600' : '400'};">
                                                        <i class="fas fa-clock" style="font-size: 0.75rem;"></i> ${stageTime}
                                                        ${stageDate ? ` • ${stageDate}` : ''}
                                                    </p>
                                                ` : ''}
                                                ${supplyChain && supplyChain.currentLocation && isCurrent ? `
                                                    <p style="margin: 0.25rem 0 0 0; color: var(--success-color); font-size: 0.8rem; font-weight: 600;">
                                                        <i class="fas fa-map-marker-alt"></i> ${supplyChain.currentLocation}
                                                    </p>
                                                ` : ''}
                                            </div>
                                            ${index < stages.length - 1 ? `
                                                <div style="position: absolute; left: -1.5rem; top: 44px; width: 3px; height: calc(100% - 44px); background: ${isCompleted ? 'linear-gradient(180deg, var(--success-color), var(--primary-color))' : '#e5e7eb'}; border-radius: 2px; z-index: 1;"></div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div style="padding: 3rem 2rem; text-align: center; background: linear-gradient(135deg, #f8f9fa, #ffffff); border-radius: var(--radius-md); border: 2px dashed var(--border-color);">
                                <div style="width: 80px; height: 80px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, #e5e7eb, #d1d5db); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-clock" style="font-size: 2.5rem; color: var(--text-light);"></i>
                                </div>
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--text-dark); font-size: 1.1rem; font-weight: 600;">Tracking information not available yet</h4>
                                <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">Order is being prepared. Tracking will be available once processing begins.</p>
                            </div>
                        `}
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-md); border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: flex-end;">
                    <button class="btn btn-secondary btn-sm" onclick="viewOrderDetails('${order.id}')" style="padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); font-weight: 600; transition: all 0.2s;">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                    ${supplyChain && supplyChain.trackingCode ? `
                        <button class="btn btn-primary btn-sm" onclick="showTrackingDetails('${supplyChain.trackingCode}')" style="padding: 0.6rem 1.25rem; display: inline-flex; align-items: center; gap: 0.5rem; border-radius: var(--radius-md); font-weight: 600; box-shadow: 0 2px 4px rgba(46, 204, 113, 0.2); transition: all 0.2s;">
                            <i class="fas fa-map-marked-alt"></i> Full Tracking
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

// ⭐ NEW FUNCTION: Show detailed tracking information
async function showTrackingDetails(trackingCode) {
    try {
        const supplyChain = await apiCall(`${API_BASE_URL}/supply-chain/track/${trackingCode}`);

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content large">
                <div class="modal-header">
                    <h2><i class="fas fa-map-marked-alt"></i> Tracking Details</h2>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="tracking-details">
                        <div class="detail-item">
                            <span class="label">Tracking Code:</span>
                            <span class="value">${supplyChain.trackingCode}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Current Stage:</span>
                            <span class="value">${supplyChain.stage}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Current Location:</span>
                            <span class="value">${supplyChain.currentLocation || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Responsible Party:</span>
                            <span class="value">${supplyChain.responsibleParty || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Quality Status:</span>
                            <span class="value">${supplyChain.qualityStatus || 'N/A'}</span>
                        </div>
                        ${supplyChain.estimatedArrivalTime ? `
                            <div class="detail-item">
                                <span class="label">Estimated Arrival:</span>
                                <span class="value">${formatDateTime(supplyChain.estimatedArrivalTime)}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);

    } catch (error) {
        console.error('Error loading tracking details:', error);
        showNotification('Failed to load tracking details', 'error');
    }
}


// ⭐ IMPROVED trackOrder function - Retrieves all tracking information
async function trackOrder(orderId) {
    try {
        showNotification('Loading tracking information...', 'info');
        
        const orderResponse = await apiCall(ENDPOINTS.transactionById(orderId));
        const order = orderResponse.data || orderResponse;

        // Enrich order with crop details
        try {
            if (order.cropId && !order.cropName) {
                const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${order.cropId}`);
                const crop = cropResponse.data || cropResponse;
                order.cropName = crop.cropName || crop.name || 'Unknown Product';
            }
        } catch (error) {
            console.warn('Error enriching order:', error);
        }

        let supplyChain = null;
        let allStages = [];

        // Method 1: Try to get supply chain by transaction ID
        try {
            const transactionSupplyChain = await apiCall(
                `${API_BASE_URL}/supply-chain/transaction/${order.id}`
            );
            if (transactionSupplyChain && (Array.isArray(transactionSupplyChain) || transactionSupplyChain.data)) {
                allStages = Array.isArray(transactionSupplyChain) ? transactionSupplyChain : transactionSupplyChain.data;
                if (allStages.length > 0) {
                    allStages = allStages.sort((a, b) => {
                        const dateA = new Date(a.stageStartDate || a.createdAt || 0);
                        const dateB = new Date(b.stageStartDate || b.createdAt || 0);
                        return dateA - dateB;
                    });
                    supplyChain = allStages[allStages.length - 1];
                }
            }
        } catch (error) {
            console.warn('No supply chain found by transaction ID');
        }

        // Method 2: Try to get supply chain by crop production ID
        if (!supplyChain && order.cropProductionId) {
            try {
                const productionSupplyChain = await apiCall(
                    `${API_BASE_URL}/supply-chain/crop-production/${order.cropProductionId}`
                );
                if (productionSupplyChain && (Array.isArray(productionSupplyChain) || productionSupplyChain.data)) {
                    allStages = Array.isArray(productionSupplyChain) ? productionSupplyChain : productionSupplyChain.data;
                    if (allStages.length > 0) {
                        allStages = allStages.sort((a, b) => {
                            const dateA = new Date(a.stageStartDate || a.createdAt || 0);
                            const dateB = new Date(b.stageStartDate || b.createdAt || 0);
                            return dateA - dateB;
                        });
                        supplyChain = allStages[allStages.length - 1];
                    }
                }
            } catch (error) {
                console.warn('No supply chain data found for this order');
            }
        }

        displayTrackingInfo([{ order, supplyChain, allStages }]);
        setActiveSection('tracking');
        
        showNotification('Tracking information loaded', 'success');

    } catch (error) {
        console.error('Error tracking order:', error);
        showNotification('Failed to load tracking information: ' + error.message, 'error');
    }
}

// Add CSS for pulse animation
const trackingStyles = `
@keyframes pulse {
    0%, 100% {
        box-shadow: 0 0 0 4px rgba(46, 204, 113, 0.2);
    }
    50% {
        box-shadow: 0 0 0 8px rgba(46, 204, 113, 0.1);
    }
}

.tracking-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.tracking-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md) !important;
}

.timeline-item {
    transition: all 0.3s ease;
}
`;

const trackingStyleElement = document.createElement('style');
trackingStyleElement.textContent = trackingStyles;
document.head.appendChild(trackingStyleElement);

// Function to search and track order by ID or tracking code
async function searchTrackingOrder() {
    const searchInput = document.getElementById('trackingSearch');
    if (!searchInput) return;
    
    const searchValue = searchInput.value.trim();
    if (!searchValue) {
        showNotification('Please enter an order ID or tracking number', 'warning');
        return;
    }
    
    try {
        showNotification('Searching for order...', 'info');
        
        // Try to find order by transaction code or ID
        const response = await apiCall(
            `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=100&sortBy=createdAt&sortDir=desc`
        );
        
        const allOrders = response.content || response;
        let foundOrder = null;
        
        // Search by transaction code or ID
        foundOrder = allOrders.find(order => 
            order.transactionCode === searchValue || 
            order.id === searchValue ||
            order.transactionCode?.toUpperCase().includes(searchValue.toUpperCase())
        );
        
        if (!foundOrder) {
            showNotification('Order not found. Please check the order ID.', 'error');
            return;
        }
        
        // Enrich order with crop details
        try {
            if (foundOrder.cropId && !foundOrder.cropName) {
                const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${foundOrder.cropId}`);
                const crop = cropResponse.data || cropResponse;
                foundOrder.cropName = crop.cropName || crop.name || 'Unknown Product';
            }
        } catch (error) {
            console.warn('Error enriching order:', error);
        }
        
        // Get supply chain information
        let supplyChain = null;
        let allStages = [];
        
        // Method 1: Try transaction ID
        try {
            const transactionSupplyChain = await apiCall(
                `${API_BASE_URL}/supply-chain/transaction/${foundOrder.id}`
            );
            if (transactionSupplyChain && (Array.isArray(transactionSupplyChain) || transactionSupplyChain.data)) {
                allStages = Array.isArray(transactionSupplyChain) ? transactionSupplyChain : transactionSupplyChain.data;
                if (allStages.length > 0) {
                    allStages = allStages.sort((a, b) => {
                        const dateA = new Date(a.stageStartDate || a.createdAt || 0);
                        const dateB = new Date(b.stageStartDate || b.createdAt || 0);
                        return dateA - dateB;
                    });
                    supplyChain = allStages[allStages.length - 1];
                }
            }
        } catch (error) {
            console.warn('No supply chain found by transaction ID');
        }
        
        // Method 2: Try crop production ID
        if (!supplyChain && foundOrder.cropProductionId) {
            try {
                const productionSupplyChain = await apiCall(
                    `${API_BASE_URL}/supply-chain/crop-production/${foundOrder.cropProductionId}`
                );
                if (productionSupplyChain && (Array.isArray(productionSupplyChain) || productionSupplyChain.data)) {
                    allStages = Array.isArray(productionSupplyChain) ? productionSupplyChain : productionSupplyChain.data;
                    if (allStages.length > 0) {
                        allStages = allStages.sort((a, b) => {
                            const dateA = new Date(a.stageStartDate || a.createdAt || 0);
                            const dateB = new Date(b.stageStartDate || b.createdAt || 0);
                            return dateA - dateB;
                        });
                        supplyChain = allStages[allStages.length - 1];
                    }
                }
            } catch (error) {
                console.warn('No supply chain found for production');
            }
        }
        
        // Display tracking info
        displayTrackingInfo([{ order: foundOrder, supplyChain, allStages }]);
        
        // Navigate to tracking section
        setActiveSection('tracking');
        
        showNotification('Order found and tracking displayed', 'success');
        
    } catch (error) {
        console.error('Error searching order:', error);
        showNotification('Failed to search order: ' + error.message, 'error');
    }
}

// Make functions globally available
window.showTrackingDetails = showTrackingDetails;
window.trackOrder = trackOrder;
window.loadTrackingData = loadTrackingData;
window.searchTrackingOrder = searchTrackingOrder;

console.log('✅ Fixed tracking section loaded');


  // ==================== FARMERS SECTION ====================

async function loadFarmersData() {
    try {
        // Get all farmers (users with FARMER role)
        const response = await apiCall(`${ENDPOINTS.users}?role=FARMER`);

        // FIX: Ensure we have an array
        const farmers = Array.isArray(response) ? response :
                       (response.content ? response.content : []);

        // Store farmers globally for search
        window.allFarmers = farmers;
        
        displayFarmers(farmers);

    } catch (error) {
        console.error('Error loading farmers:', error);
        showNotification('Failed to load farmers', 'error');
    }
}





function displayFarmers(farmers) {
    const farmersGrid = document.getElementById('farmersGrid');
    if (!farmersGrid) return;

    // FIX: Ensure farmers is an array
    if (!Array.isArray(farmers)) {
        console.error('Farmers is not an array:', farmers);
        farmers = [];
    }

    if (farmers.length === 0) {
        farmersGrid.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <p>No farmers found</p>
            </div>
        `;
        return;
    }

    farmersGrid.innerHTML = farmers.map(farmer => `
        <div class="farmer-card">
            <div class="farmer-avatar" style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; margin: 0 auto var(--spacing-md); background-color: var(--primary-light); display: flex; align-items: center; justify-content: center; border: 4px solid var(--primary-color); box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                ${farmer.profileImageUrl ?
                    `<img src="${farmer.profileImageUrl}" alt="${farmer.fullName}"
                         style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div style="display: none; width: 100%; height: 100%; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: var(--primary-dark);">
                         ${getInitials(farmer.fullName || farmer.username)}
                     </div>` :
                    `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 700; color: var(--primary-dark);">
                         ${getInitials(farmer.fullName || farmer.username)}
                     </div>`
                }
                ${farmer.isActive ? '<span class="online-badge" style="position: absolute; bottom: 5px; right: 5px; width: 15px; height: 15px; background: var(--success-color); border-radius: 50%; border: 3px solid white;"></span>' : ''}
            </div>
            <div class="farmer-info" style="text-align: center;">
                <h3 class="farmer-name">${farmer.fullName || farmer.username}</h3>
                <p class="farmer-username" style="color: var(--text-light); margin-bottom: var(--spacing-sm);">@${farmer.username}</p>
                <div class="farmer-contact" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                    <i class="fas fa-envelope"></i>
                    <span>${farmer.email}</span>
                </div>
                <div class="farmer-contact" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                    <i class="fas fa-phone"></i>
                    <span>${farmer.phoneNumber || 'N/A'}</span>
                </div>
                <div class="farmer-rating" style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: var(--warning-color); margin-bottom: var(--spacing-md);">
                    <i class="fas fa-star"></i>
                    <span>4.5 (23 reviews)</span>
                </div>
            </div>
            <div class="farmer-actions" style="display: flex; gap: var(--spacing-sm); justify-content: center;">
                <button class="btn btn-primary btn-sm" onclick="viewFarmerProducts('${farmer.id}')" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-seedling"></i>
                    View Products
                </button>
                <button class="btn btn-secondary btn-sm" onclick="contactFarmer('${farmer.id}')" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-envelope"></i>
                    Contact
                </button>
            </div>
        </div>
    `).join('');
}






async function searchFarmers(query) {
    try {
        if (!query || query.trim().length === 0) {
            // If query is empty, show all farmers
            if (window.allFarmers) {
                displayFarmers(window.allFarmers);
            } else {
                await loadFarmersData();
            }
            return;
        }

        // Use cached farmers if available, otherwise fetch
        let allFarmers = window.allFarmers;
        if (!allFarmers || allFarmers.length === 0) {
            const response = await apiCall(`${ENDPOINTS.users}?role=FARMER`);
            allFarmers = Array.isArray(response) ? response :
                        (response.content ? response.content : []);
            window.allFarmers = allFarmers;
        }

        const searchTerm = query.toLowerCase().trim();
        const filtered = allFarmers.filter(farmer =>
            farmer.fullName?.toLowerCase().includes(searchTerm) ||
            farmer.username?.toLowerCase().includes(searchTerm) ||
            farmer.email?.toLowerCase().includes(searchTerm) ||
            farmer.phoneNumber?.toLowerCase().includes(searchTerm)
        );
        
        displayFarmers(filtered);
        
        if (filtered.length === 0) {
            showNotification('No farmers found matching your search', 'info');
        }
    } catch (error) {
        console.error('Error searching farmers:', error);
        showNotification('Failed to search farmers', 'error');
    }
}








async function viewFarmerProducts(farmerId) {
    try {
        console.log('Loading products for farmer:', farmerId);

        // Utiliser le nouvel endpoint pour récupérer les productions du farmer
        const response = await apiCall(`${ENDPOINTS.cropProductions}/farmer/${farmerId}`);

        console.log('Farmer products response:', response);

        // Vérifier si la réponse contient des données
        let productions = [];
        if (response && response.data) {
            productions = response.data; // Si la réponse a une structure {success, message, data}
        } else if (Array.isArray(response)) {
            productions = response; // Si la réponse est directement un tableau
        } else if (response && response.content) {
            productions = response.content; // Si pagination
        }

        console.log('Processed productions:', productions);

        if (!productions || productions.length === 0) {
            showNotification('This farmer has no products available at the moment', 'info');
            return;
        }

        // Afficher les produits dans le marketplace
        displayFarmerProducts(productions, farmerId);

        // Aller à la section marketplace
        setActiveSection('marketplace');

        showNotification(`Showing ${productions.length} products from this farmer`, 'success');

    } catch (error) {
        console.error('Error loading farmer products:', error);
        showNotification('Failed to load farmer products. Please try again.', 'error');
    }
}

// Nouvelle fonction pour afficher les produits d'un farmer spécifique
function displayFarmerProducts(productions, farmerId) {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;

    if (!productions || productions.length === 0) {
        productsGrid.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No products available from this farmer</p>
                <button class="btn btn-primary" onclick="loadMarketplaceData()">
                    Browse All Products
                </button>
            </div>
        `;
        return;
    }

    // Ajouter un en-tête pour indiquer qu'on voit les produits d'un farmer spécifique
    const farmerHeader = document.createElement('div');
    farmerHeader.className = 'farmer-products-header';
    farmerHeader.style.gridColumn = '1 / -1';
    farmerHeader.style.textAlign = 'center';
    farmerHeader.style.padding = 'var(--spacing-lg)';
    farmerHeader.style.backgroundColor = 'var(--primary-light)';
    farmerHeader.style.borderRadius = 'var(--radius-lg)';
    farmerHeader.style.marginBottom = 'var(--spacing-lg)';

    farmerHeader.innerHTML = `
        <h3>Products from ${productions[0]?.farmerName || 'This Farmer'}</h3>
        <p>Showing ${productions.length} available products</p>
        <button class="btn btn-secondary btn-sm" onclick="loadMarketplaceData()">
            <i class="fas fa-store"></i>
            View All Products
        </button>
    `;

    productsGrid.innerHTML = '';
    productsGrid.appendChild(farmerHeader);

    // Afficher les produits
    productsGrid.innerHTML += productions.map(production => `
        <div class="product-card">
            <div class="product-image">
                ${production.cropImageUrl ?
                    `<img src="${production.cropImageUrl}" alt="${production.cropName}"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZWNmMGYxIi8+CjxwYXRoIGQ9Ik03NSA1MEgxMjVWMTUwSDc1VjUwWiIgZmlsbD0iIzJlY2M3MSIvPgo8Y2lyY2xlIGN4PSIxMDAiIGN5PSI3NSIgcj0iMTUiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg=='">` :
                    `<div class="product-placeholder">
                        <i class="fas fa-seedling"></i>
                        <span>No Image</span>
                     </div>`
                }
                ${production.isOrganic ? '<span class="product-badge organic">Organic</span>' : ''}
                ${production.productionStatus === 'HARVESTED' ? '<span class="product-badge ready">Ready</span>' : ''}
            </div>
            <div class="product-info">
                <div class="product-category">${production.cropType || 'Agriculture'}</div>
                <h3 class="product-name">${production.cropName || 'Unknown Crop'}</h3>
                <p class="product-farmer">
                    <i class="fas fa-user"></i>
                    ${production.farmerName || 'Unknown Farmer'}
                </p>

                <div class="product-details">
                    <div class="detail-item">
                        <i class="fas fa-weight"></i>
                        <span>${production.expectedYield || 0} kg available</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${production.location || 'Location not specified'}</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-calendar"></i>
                        <span>Harvest: ${formatDate(production.expectedHarvestDate)}</span>
                    </div>
                </div>

                <div class="product-quality">
                    <span class="quality-badge ${getQualityClass(production)}">
                        ${getQualityText(production)}
                    </span>
                    <span class="production-method">
                        ${production.productionMethod || 'Traditional'}
                    </span>
                </div>

                <div class="product-footer">
                    <div class="product-price">
                        <span class="price-value">${formatCurrency(production.estimatedPrice || 0)}</span>
                        <span class="price-unit">/kg</span>
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-secondary btn-sm" onclick="viewProductDetails('${production.id}')">
                            <i class="fas fa-info-circle"></i>
                            Details
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="addToCart('${production.id}')"
                                ${(production.expectedYield || 0) <= 0 ? 'disabled' : ''}>
                            <i class="fas fa-shopping-cart"></i>
                            ${(production.expectedYield || 0) <= 0 ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Fonctions utilitaires pour la qualité
function getQualityClass(production) {
    if (production.isOrganic) return 'quality-organic';
    if (production.productionMethod === 'CERTIFIED_ORGANIC') return 'quality-certified';
    return 'quality-standard';
}

function getQualityText(production) {
    if (production.isOrganic) return 'Organic';
    if (production.productionMethod === 'CERTIFIED_ORGANIC') return 'Certified';
    return 'Standard';
}








  function contactFarmer(farmerId) {
      try {
          // Store farmerId in sessionStorage for WhatsAppFarmerBuyer.html
          if (farmerId) {
              sessionStorage.setItem('selectedFarmerId', farmerId);
              sessionStorage.setItem('selectedBuyerId', currentUser?.id || currentUser?.userId);
          }
          
          // Navigate to WhatsApp messaging page
          window.location.href = 'WhatsAppFarmerBuyer.html';
      } catch (error) {
          console.error('Error navigating to WhatsApp:', error);
          showNotification('Failed to open messaging', 'error');
      }
  }
  
  // Handle farmer search input
  function handleFarmerSearch(event) {
      const query = event.target.value.trim();
      
      if (query.length === 0) {
          // If search is empty, reload all farmers
          loadFarmersData();
          return;
      }
      
      // Debounce search
      clearTimeout(window.farmerSearchTimeout);
      window.farmerSearchTimeout = setTimeout(() => {
          searchFarmers(query);
      }, 300);
  }






async function loadQualityData() {
    try {
        // Load quality reports for buyer's orders
        const response = await apiCall(
            `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=50`
        );

        const orders = response.content || response;

        // Enrich orders with crop and farmer details
        const enrichedOrders = await Promise.all(orders.map(async (order) => {
            try {
                // Fetch farmer details if missing
                if (order.farmerId && !order.farmerName) {
                    try {
                        const farmerResponse = await apiCall(`${API_BASE_URL}/users/${order.farmerId}`);
                        const farmer = farmerResponse.data || farmerResponse;
                        order.farmerName = farmer.fullName || farmer.username || 'Unknown Farmer';
                    } catch (error) {
                        console.warn(`Error fetching farmer ${order.farmerId}:`, error);
                        order.farmerName = 'Unknown Farmer';
                    }
                }

                // Fetch crop details if missing
                if (order.cropId && !order.cropName) {
                    try {
                        const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${order.cropId}`);
                        const crop = cropResponse.data || cropResponse;
                        order.cropName = crop.cropName || crop.name || 'Unknown Product';
                    } catch (error) {
                        console.warn(`Error fetching crop ${order.cropId}:`, error);
                        order.cropName = 'Unknown Product';
                    }
                }
            } catch (error) {
                console.warn('Error enriching order:', error);
            }
            return order;
        }));

        displayQualityReports(enrichedOrders);

    } catch (error) {
        console.error('Error loading quality data:', error);
        showNotification('Failed to load quality reports', 'error');
    }
}





function displayQualityReports(orders) {
    const reportsList = document.getElementById('qualityReportsList');
    if (!reportsList) return;

    if (!orders || orders.length === 0) {
        reportsList.innerHTML = `
            <div style="text-align: center; padding: 4rem 2rem;">
                <i class="fas fa-clipboard-list" style="font-size: 5rem; color: var(--text-light); margin-bottom: 1.5rem; opacity: 0.3;"></i>
                <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-dark);">No Quality Reports</h3>
                <p style="color: var(--text-light); margin-bottom: 2rem;">Quality reports will appear here once products are delivered</p>
            </div>
        `;
        return;
    }

    reportsList.innerHTML = orders.map((order, index) => {
        // Generate random quality score (in production, this would come from backend)
        const qualityScores = ['A+', 'A', 'A-', 'B+', 'B'];
        const qualityScore = qualityScores[Math.floor(Math.random() * qualityScores.length)];
        const scorePercentage = qualityScore === 'A+' ? 98 : qualityScore === 'A' ? 92 : qualityScore === 'A-' ? 85 : qualityScore === 'B+' ? 78 : 72;

        const certifications = ['Organic Certified', 'Quality Assured', 'Lab Tested', 'Premium Grade'];
        const certification = certifications[Math.floor(Math.random() * certifications.length)];

        const certColors = {
            'Organic Certified': 'linear-gradient(135deg, #11998e, #38ef7d)',
            'Quality Assured': 'linear-gradient(135deg, #667eea, #764ba2)',
            'Lab Tested': 'linear-gradient(135deg, #f093fb, #f5576c)',
            'Premium Grade': 'linear-gradient(135deg, #ffc837, #ff8008)'
        };

        return `
            <div style="background: ${index % 2 === 0 ? '#ffffff' : '#f8f9fa'}; border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1rem; border: 1px solid var(--border-color); transition: all 0.3s; cursor: pointer;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)';">

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: center;">

                    <!-- Order Information -->
                    <div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
                            <i class="fas fa-hashtag"></i> Order ID
                        </div>
                        <div style="font-weight: 700; color: var(--text-dark); font-size: 1rem; font-family: 'Courier New', monospace;">
                            ${order.transactionCode}
                        </div>
                    </div>

                    <!-- Product & Farmer -->
                    <div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
                            <i class="fas fa-seedling"></i> Product
                        </div>
                        <div style="font-weight: 600; color: var(--text-dark); font-size: 1rem; margin-bottom: 0.25rem;">
                            ${order.cropName || 'N/A'}
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-light); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user"></i> ${order.farmerName || 'Unknown'}
                        </div>
                    </div>

                    <!-- Quality Score -->
                    <div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
                            <i class="fas fa-star"></i> Quality Score
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 2rem; font-weight: 800; color: ${scorePercentage >= 90 ? '#10b981' : scorePercentage >= 80 ? '#f59e0b' : '#ef4444'};">
                                ${qualityScore}
                            </div>
                            <div style="flex: 1;">
                                <div style="background: #e5e7eb; height: 8px; border-radius: 10px; overflow: hidden;">
                                    <div style="background: ${scorePercentage >= 90 ? 'linear-gradient(90deg, #10b981, #059669)' : scorePercentage >= 80 ? 'linear-gradient(90deg, #f59e0b, #d97706)' : 'linear-gradient(90deg, #ef4444, #dc2626)'}; height: 100%; width: ${scorePercentage}%; transition: width 0.5s;"></div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.25rem;">
                                    ${scorePercentage}% Score
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Certification Badge -->
                    <div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
                            <i class="fas fa-certificate"></i> Certification
                        </div>
                        <div style="display: inline-block; background: ${certColors[certification]}; color: white; padding: 0.6rem 1rem; border-radius: 25px; font-size: 0.85rem; font-weight: 700; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                            <i class="fas fa-check-circle"></i> ${certification}
                        </div>
                    </div>

                    <!-- Test Date -->
                    <div>
                        <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); margin-bottom: 0.5rem; font-weight: 600;">
                            <i class="fas fa-calendar-check"></i> Test Date
                        </div>
                        <div style="font-weight: 600; color: var(--text-dark); font-size: 0.95rem;">
                            ${formatDate(order.createdAt)}
                        </div>
                    </div>

                    <!-- Action Button -->
                    <div style="text-align: right;">
                        <button onclick="viewQualityReport('${order.id}')" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; box-shadow: 0 4px 8px rgba(46, 204, 113, 0.2); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(46, 204, 113, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 8px rgba(46, 204, 113, 0.2)';">
                            <i class="fas fa-file-pdf"></i>
                            View Report
                        </button>
                    </div>

                </div>
            </div>
        `;
    }).join('');
}

  function viewQualityReport(orderId) {
      showNotification('Quality report viewer coming soon', 'info');
  }







  // ==================== MESSAGES SECTION ====================

  async function loadMessagesData() {
      // TODO: Implement messaging system
      showNotification('Messaging feature coming soon', 'info');
  }







  // ==================== REPORTS SECTION ====================

async function loadReportsData() {
    try {
        // Get analytics data
        const analytics = await apiCall(ENDPOINTS.buyerAnalytics(currentUser.id));

        // Get all transactions
        const transactionsResponse = await apiCall(
            `${ENDPOINTS.transactionsByBuyer(currentUser.id)}?page=0&size=100&sortBy=createdAt&sortDir=desc`
        );
        let transactions = transactionsResponse.content || transactionsResponse;

        // Enrich transactions with crop and farmer details
        transactions = await Promise.all(transactions.map(async (transaction) => {
            try {
                // Fetch farmer details if missing
                if (transaction.farmerId && !transaction.farmerName) {
                    try {
                        const farmerResponse = await apiCall(`${API_BASE_URL}/users/${transaction.farmerId}`);
                        const farmer = farmerResponse.data || farmerResponse;
                        transaction.farmerName = farmer.fullName || farmer.username || 'Unknown Farmer';
                    } catch (error) {
                        console.warn(`Error fetching farmer ${transaction.farmerId}:`, error);
                        transaction.farmerName = 'Unknown Farmer';
                    }
                }

                // Fetch crop details if missing
                if (transaction.cropId && !transaction.cropName) {
                    try {
                        const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${transaction.cropId}`);
                        const crop = cropResponse.data || cropResponse;
                        transaction.cropName = crop.cropName || crop.name || 'Unknown Product';
                    } catch (error) {
                        console.warn(`Error fetching crop ${transaction.cropId}:`, error);
                        transaction.cropName = 'Unknown Product';
                    }
                }
            } catch (error) {
                console.warn('Error enriching transaction:', error);
            }
            return transaction;
        }));

        // Store transactions globally for filtering
        window.allTransactions = transactions;

        // Apply period filter
        const periodFilter = document.getElementById('reportsPeriodFilter')?.value || 'all';
        const filteredTransactions = filterTransactionsByPeriod(transactions, periodFilter);

        // Update stat cards
        updateReportStats(analytics, filteredTransactions);

        // Render all charts
        renderSpendingChart(filteredTransactions);
        renderCategoriesChart(filteredTransactions);
        renderTopFarmers(filteredTransactions);
        renderOrderStatusChart(filteredTransactions);
        renderTrendsChart(filteredTransactions);
        renderPaymentMethodsChart(filteredTransactions);
        renderRecentActivity(filteredTransactions);

    } catch (error) {
        console.error('Error loading reports:', error);
        showNotification('Failed to load reports data', 'error');
    }
}

// Filter transactions by period
function filterTransactionsByPeriod(transactions, period) {
    if (!transactions || transactions.length === 0) return [];
    if (period === 'all') return transactions;

    const now = new Date();
    let cutoffDate = new Date();

    switch (period) {
        case 'week':
            cutoffDate.setDate(now.getDate() - 7);
            break;
        case 'month':
            cutoffDate.setDate(now.getDate() - 30);
            break;
        case 'quarter':
            cutoffDate.setMonth(now.getMonth() - 3);
            break;
        case 'year':
            cutoffDate.setFullYear(now.getFullYear() - 1);
            break;
        default:
            return transactions;
    }

    return transactions.filter(t => {
        const transactionDate = new Date(t.createdAt);
        return transactionDate >= cutoffDate;
    });
}

function updateReportStats(analytics, transactions) {
    // Total Spending
    const totalSpending = transactions.reduce((sum, t) => sum + (t.totalAmount || 0), 0);
    document.getElementById('reportTotalSpending').textContent = formatCurrency(totalSpending);

    // Total Orders
    document.getElementById('reportTotalOrders').textContent = transactions.length;

    // Average Order Value
    const avgOrder = transactions.length > 0 ? totalSpending / transactions.length : 0;
    document.getElementById('reportAvgOrder').textContent = formatCurrency(avgOrder);

    // Active Farmers
    const uniqueFarmers = new Set(transactions.map(t => t.farmerId).filter(Boolean));
    document.getElementById('reportActiveFarmers').textContent = uniqueFarmers.size;
    document.getElementById('reportFarmersCount').textContent = uniqueFarmers.size;

    // Calculate changes (mock for now)
    document.getElementById('reportSpendingChange').textContent = '12%';
    document.getElementById('reportOrdersChange').textContent = '8%';
    document.getElementById('reportAvgChange').textContent = '5%';
}

function renderSpendingChart(transactions) {
    const ctx = document.getElementById('spendingChartCanvas');
    if (!ctx) return;

    // Group by week
    const weeklyData = {};
    transactions.forEach(t => {
        const date = new Date(t.createdAt);
        const weekKey = getWeekKey(date);
        if (!weeklyData[weekKey]) {
            weeklyData[weekKey] = 0;
        }
        weeklyData[weekKey] += t.totalAmount || 0;
    });

    const labels = Object.keys(weeklyData).sort();
    const data = labels.map(label => weeklyData[label]);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Spending (RWF)',
                data: data,
                borderColor: '#2ecc71',
                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointBackgroundColor: '#2ecc71',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    callbacks: {
                        label: function(context) {
                            return 'Total: ' + formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function renderCategoriesChart(transactions) {
    const ctx = document.getElementById('categoriesChartCanvas');
    if (!ctx) return;

    // Group by crop type
    const categories = {};
    transactions.forEach(t => {
        const category = t.cropType || 'Other';
        categories[category] = (categories[category] || 0) + 1;
    });

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(categories),
            datasets: [{
                data: Object.values(categories),
                backgroundColor: [
                    '#2ecc71',
                    '#27ae60',
                    '#a8e6cf',
                    '#7dcea0',
                    '#52be80'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            }
        }
    });
}

function renderTopFarmers(transactions) {
    const container = document.getElementById('topFarmersChart');
    if (!container) return;

    // Group by farmer
    const farmerStats = {};
    transactions.forEach(t => {
        if (t.farmerId && t.farmerName) {
            if (!farmerStats[t.farmerId]) {
                farmerStats[t.farmerId] = {
                    name: t.farmerName,
                    orders: 0,
                    total: 0
                };
            }
            farmerStats[t.farmerId].orders++;
            farmerStats[t.farmerId].total += t.totalAmount || 0;
        }
    });

    // Sort by total amount
    const topFarmers = Object.values(farmerStats)
        .sort((a, b) => b.total - a.total)
        .slice(0, 5);

    if (topFarmers.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                <p>No farmer data available</p>
            </div>
        `;
        return;
    }

    container.innerHTML = topFarmers.map((farmer, index) => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background='var(--light-gray)'" onmouseout="this.style.background='white'">
            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                <div style="width: 40px; height: 40px; background: var(--primary-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--primary-color); font-size: 1.2rem;">
                    ${index + 1}
                </div>
                <div>
                    <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem;">
                        ${farmer.name}
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-light);">
                        ${farmer.orders} orders
                    </div>
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 700; color: var(--primary-color); font-size: 1.1rem;">
                    ${formatCurrency(farmer.total)}
                </div>
            </div>
        </div>
    `).join('');
}

function renderOrderStatusChart(transactions) {
    const ctx = document.getElementById('orderStatusChartCanvas');
    if (!ctx) return;

    // Group by status
    const statusCounts = {};
    transactions.forEach(t => {
        const status = t.transactionStatus || 'PENDING';
        statusCounts[status] = (statusCounts[status] || 0) + 1;
    });

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(statusCounts),
            datasets: [{
                label: 'Orders',
                data: Object.values(statusCounts),
                backgroundColor: '#2ecc71',
                borderWidth: 0,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        stepSize: 1
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

function renderTrendsChart(transactions) {
    const ctx = document.getElementById('trendsChartCanvas');
    if (!ctx) return;

    // Group by month
    const monthlyData = {};
    transactions.forEach(t => {
        const date = new Date(t.createdAt);
        const monthKey = date.toLocaleString('default', { month: 'short', year: 'numeric' });
        if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = { orders: 0, amount: 0 };
        }
        monthlyData[monthKey].orders++;
        monthlyData[monthKey].amount += t.totalAmount || 0;
    });

    const labels = Object.keys(monthlyData);
    const ordersData = labels.map(label => monthlyData[label].orders);
    const amountData = labels.map(label => monthlyData[label].amount);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Orders',
                    data: ordersData,
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    yAxisID: 'y',
                    borderWidth: 2,
                    tension: 0.4
                },
                {
                    label: 'Amount (RWF)',
                    data: amountData,
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    yAxisID: 'y1',
                    borderWidth: 2,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
}

function renderPaymentMethodsChart(transactions) {
    const ctx = document.getElementById('paymentMethodsChartCanvas');
    if (!ctx) return;

    // Group by payment method
    const methods = {};
    transactions.forEach(t => {
        const method = t.paymentMethod || 'CASH';
        methods[method] = (methods[method] || 0) + 1;
    });

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(methods),
            datasets: [{
                data: Object.values(methods),
                backgroundColor: [
                    '#2ecc71',
                    '#27ae60',
                    '#a8e6cf',
                    '#7dcea0'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15
                    }
                }
            }
        }
    });
}

function renderRecentActivity(transactions) {
    const container = document.getElementById('recentActivityTable');
    if (!container) return;

    const recent = transactions.slice(0, 10);

    if (recent.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                <p>No recent activity</p>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <table class="data-table" style="width: 100%;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Order ID</th>
                    <th>Product</th>
                    <th>Farmer</th>
                    <th>Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${recent.map(t => `
                    <tr>
                        <td>${formatDate(t.createdAt)}</td>
                        <td style="font-family: monospace; font-size: 0.9rem;">${t.transactionCode}</td>
                        <td>${t.cropName || 'N/A'}</td>
                        <td>${t.farmerName || 'N/A'}</td>
                        <td style="font-weight: 600; color: var(--primary-color);">${formatCurrency(t.totalAmount)}</td>
                        <td>
                            <span class="status-badge status-${t.transactionStatus?.toLowerCase()}">${t.transactionStatus || 'PENDING'}</span>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// Helper function to get week key
function getWeekKey(date) {
    const start = new Date(date.getFullYear(), 0, 1);
    const diff = date - start;
    const oneWeek = 1000 * 60 * 60 * 24 * 7;
    const week = Math.floor(diff / oneWeek);
    return `Week ${week + 1}`;
}

// Handle reports period filter change
async function handleReportsPeriodChange() {
    const periodFilter = document.getElementById('reportsPeriodFilter')?.value || 'all';
    
    if (!window.allTransactions) {
        await loadReportsData();
        return;
    }

    const filteredTransactions = filterTransactionsByPeriod(window.allTransactions, periodFilter);

    // Update stat cards
    try {
        const analytics = await apiCall(ENDPOINTS.buyerAnalytics(currentUser.id));
        updateReportStats(analytics, filteredTransactions);
    } catch (error) {
        console.warn('Error loading analytics:', error);
    }

    // Re-render all charts
    renderSpendingChart(filteredTransactions);
    renderCategoriesChart(filteredTransactions);
    renderTopFarmers(filteredTransactions);
    renderOrderStatusChart(filteredTransactions);
    renderTrendsChart(filteredTransactions);
    renderPaymentMethodsChart(filteredTransactions);
    renderRecentActivity(filteredTransactions);
}

// Export reports to PDF
async function exportReportsToPDF() {
    try {
        showNotification('Generating PDF report...', 'info');

        const periodFilter = document.getElementById('reportsPeriodFilter')?.value || 'all';
        const transactions = filterTransactionsByPeriod(window.allTransactions || [], periodFilter);

        if (!transactions || transactions.length === 0) {
            showNotification('No transactions to export', 'warning');
            return;
        }

        // Generate PDF using jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Colors
        const primaryColor = [34, 197, 94]; // Green #22c55e
        const darkColor = [22, 163, 74]; // Dark green #16a34a
        const textColor = [51, 51, 51]; // Dark text
        const lightGray = [200, 200, 200];

        // Header with background
        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.rect(0, 0, 210, 50, 'F');

        // Try to add logo
        let logoAdded = false;
        try {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            
            await new Promise((resolve, reject) => {
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = Math.min(img.width, 100);
                        canvas.height = Math.min(img.height, 100);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const imgData = canvas.toDataURL('image/jpeg');
                        doc.addImage(imgData, 'JPEG', 15, 8, 30, 30);
                        logoAdded = true;
                        resolve();
                    } catch (e) {
                        reject(e);
                    }
                };
                
                img.onerror = function() {
                    reject(new Error('Failed to load logo'));
                };
                
                img.src = 'images/logo.jpeg';
                
                setTimeout(() => {
                    if (!logoAdded) {
                        reject(new Error('Logo loading timeout'));
                    }
                }, 2000);
            });
        } catch (error) {
            console.warn('Logo not loaded, continuing without logo:', error);
            logoAdded = false;
        }

        // Company info - adjust position based on logo
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont(undefined, 'bold');
        doc.text('AgriGuard AI', logoAdded ? 50 : 15, 20);
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text('Smart Agriculture System', logoAdded ? 50 : 15, 28);
        
        const periodLabels = {
            'week': 'Last 7 Days',
            'month': 'Last 30 Days',
            'quarter': 'Last Quarter',
            'year': 'Last Year',
            'all': 'All Time'
        };
        doc.text(`Transaction Report - ${periodLabels[periodFilter]}`, logoAdded ? 50 : 15, 35);

        generateReportsPDFContent(doc, transactions, periodFilter, primaryColor, darkColor, textColor, lightGray);
        
        // Save PDF
        const fileName = `Transaction_Report_${periodFilter}_${formatDate(new Date()).replace(/\//g, '-')}.pdf`;
        doc.save(fileName);
        
        showNotification('PDF report downloaded successfully!', 'success');
    } catch (error) {
        console.error('Error generating PDF report:', error);
        showNotification('Failed to generate PDF report: ' + error.message, 'error');
    }
}

function generateReportsPDFContent(doc, transactions, periodFilter, primaryColor, darkColor, textColor, lightGray) {
    let yPos = 60;

    // Report summary section
    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
    doc.setFontSize(10);
    
    // Report date and period
    doc.setFont(undefined, 'bold');
    doc.text('Report Generated:', 15, yPos);
    doc.setFont(undefined, 'normal');
    doc.text(formatDate(new Date()), 60, yPos);
    
    yPos += 7;
    doc.setFont(undefined, 'bold');
    doc.text('Period:', 15, yPos);
    doc.setFont(undefined, 'normal');
    const periodLabels = {
        'week': 'Last 7 Days',
        'month': 'Last 30 Days',
        'quarter': 'Last Quarter',
        'year': 'Last Year',
        'all': 'All Time'
    };
    doc.text(periodLabels[periodFilter] || 'All Time', 60, yPos);
    
    yPos += 7;
    doc.setFont(undefined, 'bold');
    doc.text('Total Transactions:', 15, yPos);
    doc.setFont(undefined, 'normal');
    doc.text(transactions.length.toString(), 60, yPos);
    
    yPos += 7;
    doc.setFont(undefined, 'bold');
    doc.text('Total Amount:', 15, yPos);
    doc.setFont(undefined, 'normal');
    const totalAmount = transactions.reduce((sum, t) => sum + (t.totalAmount || 0), 0);
    doc.text(formatCurrency(totalAmount), 60, yPos);

    yPos += 15;

    // Divider line
    doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
    doc.line(15, yPos, 195, yPos);
    yPos += 10;

    // Transactions table header
    doc.setFont(undefined, 'bold');
    doc.setFontSize(12);
    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
    doc.text('Transaction Details', 15, yPos);
    
    yPos += 10;

    // Table header background
    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
    doc.rect(15, yPos - 5, 180, 8, 'F');
    
    // Table headers
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('Date', 17, yPos);
    doc.text('Order ID', 45, yPos);
    doc.text('Product', 80, yPos);
    doc.text('Farmer', 120, yPos);
    doc.text('Amount', 155, yPos);
    doc.text('Status', 175, yPos);

    yPos += 8;

    // Table rows
    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(8);

    let pageNumber = 1;
    const maxRowsPerPage = 25;
    let rowCount = 0;

    transactions.forEach((transaction, index) => {
        // Check if we need a new page
        if (rowCount >= maxRowsPerPage) {
            doc.addPage();
            yPos = 20;
            
            // Redraw header on new page
            doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
            doc.rect(15, yPos - 5, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(9);
            doc.text('Date', 17, yPos);
            doc.text('Order ID', 45, yPos);
            doc.text('Product', 80, yPos);
            doc.text('Farmer', 120, yPos);
            doc.text('Amount', 155, yPos);
            doc.text('Status', 175, yPos);
            yPos += 8;
            doc.setTextColor(textColor[0], textColor[1], textColor[2]);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            rowCount = 0;
            pageNumber++;
        }

        // Alternate row background
        if (rowCount % 2 === 0) {
            doc.setFillColor(245, 245, 245);
            doc.rect(15, yPos - 4, 180, 6, 'F');
        }

        // Transaction data
        doc.setTextColor(textColor[0], textColor[1], textColor[2]);
        const dateStr = formatDate(transaction.createdAt);
        const orderId = (transaction.transactionCode || transaction.id || '').substring(0, 12);
        const productName = (transaction.cropName || 'N/A').substring(0, 15);
        const farmerName = (transaction.farmerName || 'N/A').substring(0, 15);
        const amount = formatCurrency(transaction.totalAmount || 0);
        const status = (transaction.transactionStatus || 'PENDING').substring(0, 8);

        doc.text(dateStr, 17, yPos);
        doc.text(orderId, 45, yPos);
        doc.text(productName, 80, yPos);
        doc.text(farmerName, 120, yPos);
        doc.text(amount, 155, yPos);
        doc.text(status, 175, yPos);

        yPos += 6;
        rowCount++;
    });

    // Summary section at the bottom
    const pageHeight = doc.internal.pageSize.height;
    yPos = pageHeight - 40;

    // Divider line
    doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
    doc.line(15, yPos, 195, yPos);
    yPos += 10;

    // Summary statistics
    doc.setFont(undefined, 'bold');
    doc.setFontSize(10);
    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
    doc.text('Summary', 15, yPos);
    
    yPos += 7;
    doc.setFontSize(9);
    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
    doc.setFont(undefined, 'normal');
    
    const totalSpending = transactions.reduce((sum, t) => sum + (t.totalAmount || 0), 0);
    const avgOrder = transactions.length > 0 ? totalSpending / transactions.length : 0;
    const uniqueFarmers = new Set(transactions.map(t => t.farmerId).filter(Boolean)).size;
    
    doc.text(`Total Spending: ${formatCurrency(totalSpending)}`, 15, yPos);
    yPos += 6;
    doc.text(`Average Order Value: ${formatCurrency(avgOrder)}`, 15, yPos);
    yPos += 6;
    doc.text(`Total Orders: ${transactions.length}`, 15, yPos);
    yPos += 6;
    doc.text(`Active Farmers: ${uniqueFarmers}`, 15, yPos);

    // Footer
    yPos = pageHeight - 10;
    doc.setFontSize(7);
    doc.setTextColor(lightGray[0], lightGray[1], lightGray[2]);
    doc.text(`Page ${pageNumber} | Generated by AgriGuard AI on ${formatDate(new Date())}`, 15, yPos);
    doc.text('For inquiries, please contact support@agriguard.ai', 15, yPos + 4);
}




  // ==================== NOTIFICATIONS ====================

  async function loadNotifications() {
      try {
          if (!Array.isArray(notifications) || notifications.length === 0) {
              notifications = [{
                  id: 'welcome-' + Date.now(),
                  title: 'Welcome to Buyer Dashboard',
                  message: 'Your purchases, new products, and order updates will appear here.',
                  type: 'info',
                  timestamp: new Date(),
                  read: false
              }];
          }
          displayNotifications();
      } catch (error) {
          console.error('Error loading notifications:', error);
      }
  }

  function pushBuyerNotification(title, message, type) {
      type = type || 'info';
      const n = {
          id: 'n-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8),
          title,
          message,
          type,
          timestamp: new Date(),
          read: false
      };
      notifications.unshift(n);
      displayNotifications();
  }

  function markAllNotificationsRead() {
      notifications.forEach(n => { n.read = true; });
      displayNotifications();
  }

  function displayNotifications() {
      const listEl = document.getElementById('notificationsList');
      const badgeEl = document.getElementById('notificationCount');

      if (!listEl) return;

      const unreadCount = notifications.filter(n => !n.read).length;

      if (badgeEl) {
          badgeEl.textContent = unreadCount;
          badgeEl.style.display = 'flex';
          badgeEl.style.visibility = 'visible';
      }

      if (notifications.length === 0) {
          listEl.innerHTML = `
              <div class="notification-empty">
                  <i class="fas fa-bell-slash"></i>
                  <p>No notifications</p>
              </div>
          `;
          return;
      }

      listEl.innerHTML = notifications.map(n => {
          const icon = n.type === 'success' ? 'check-circle' : n.type === 'warning' ? 'exclamation-triangle' : 'info-circle';
          const ts = n.timestamp ? formatDateTime(n.timestamp) : 'Just now';
          return `
              <div class="notification-item ${n.read ? 'read' : 'unread'}">
                  <div class="notification-icon ${n.type}">
                      <i class="fas fa-${icon}"></i>
                  </div>
                  <div class="notification-content">
                      <h4 class="notification-item-title">${n.title || ''}</h4>
                      <p class="notification-item-message">${n.message || ''}</p>
                      <span class="notification-item-time">${ts}</span>
                  </div>
              </div>`;
      }).join('');
  }

async function viewQualityReport(orderId) {
    try {
        showNotification('Generating quality report...', 'info');

        // Fetch transaction/order details
        const response = await apiCall(ENDPOINTS.transactionById(orderId));
        const order = response.data || response;

        // Enrich order with farmer and crop details
        try {
            if (order.farmerId && !order.farmerName) {
                const farmerResponse = await apiCall(`${API_BASE_URL}/users/${order.farmerId}`);
                const farmer = farmerResponse.data || farmerResponse;
                order.farmerName = farmer.fullName || farmer.username || 'Unknown Farmer';
            }

            if (order.cropId && !order.cropName) {
                const cropResponse = await apiCall(`${API_BASE_URL}/v1/crops/${order.cropId}`);
                const crop = cropResponse.data || cropResponse;
                order.cropName = crop.cropName || crop.name || 'Unknown Product';
            }
        } catch (error) {
            console.warn('Error enriching order for quality report:', error);
        }

        // Generate quality score (in production, this would come from backend)
        const qualityScores = ['A+', 'A', 'A-', 'B+', 'B'];
        const qualityScore = qualityScores[Math.floor(Math.random() * qualityScores.length)];
        const scorePercentage = qualityScore === 'A+' ? 98 : qualityScore === 'A' ? 92 : qualityScore === 'A-' ? 85 : qualityScore === 'B+' ? 78 : 72;

        const certifications = ['Organic Certified', 'Quality Assured', 'Lab Tested', 'Premium Grade'];
        const certification = certifications[Math.floor(Math.random() * certifications.length)];

        // Generate PDF using jsPDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Colors
        const primaryColor = [34, 197, 94]; // Green #22c55e
        const darkColor = [22, 163, 74]; // Dark green #16a34a
        const textColor = [51, 51, 51]; // Dark text
        const lightGray = [200, 200, 200];
        const orangeColor = [245, 158, 11]; // Orange for quality score

        // Header with background
        doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
        doc.rect(0, 0, 210, 50, 'F');

        // Try to add logo
        let logoAdded = false;
        try {
            const img = new Image();
            img.crossOrigin = 'anonymous';

            await new Promise((resolve, reject) => {
                img.onload = function() {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = Math.min(img.width, 100);
                        canvas.height = Math.min(img.height, 100);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        const imgData = canvas.toDataURL('image/jpeg');
                        doc.addImage(imgData, 'JPEG', 15, 8, 30, 30);
                        logoAdded = true;
                        resolve();
                    } catch (e) {
                        reject(e);
                    }
                };

                img.onerror = function() {
                    reject(new Error('Failed to load logo'));
                };

                img.src = 'images/logo.jpeg';

                setTimeout(() => {
                    if (!logoAdded) {
                        reject(new Error('Logo loading timeout'));
                    }
                }, 2000);
            });
        } catch (error) {
            console.warn('Logo not loaded, continuing without logo:', error);
            logoAdded = false;
        }

        // Company info - adjust position based on logo
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(24);
        doc.setFont(undefined, 'bold');
        doc.text('AgriGuard AI', logoAdded ? 50 : 15, 20);

        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.text('Smart Agriculture System', logoAdded ? 50 : 15, 28);
        doc.text('Quality Assurance Report', logoAdded ? 50 : 15, 35);

        generateQualityReportContent(doc, order, qualityScore, scorePercentage, certification, primaryColor, darkColor, textColor, lightGray, orangeColor);

        // Save PDF
        const fileName = `Quality_Report_${order.transactionCode || order.id}.pdf`;
        doc.save(fileName);

        showNotification('Quality report downloaded successfully!', 'success');
    } catch (error) {
        console.error('Error generating quality report:', error);
        showNotification('Failed to generate quality report: ' + error.message, 'error');
    }
}

function generateQualityReportContent(doc, order, qualityScore, scorePercentage, certification, primaryColor, darkColor, textColor, lightGray, orangeColor) {
    let yPos = 60;

    // Report details section
    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
    doc.setFontSize(10);

    // Order ID and Date
    doc.setFont(undefined, 'bold');
    doc.text('Order ID:', 15, yPos);
    doc.setFont(undefined, 'normal');
    doc.text(order.transactionCode || 'N/A', 50, yPos);

    yPos += 7;
    doc.setFont(undefined, 'bold');
    doc.text('Report Date:', 15, yPos);
    doc.setFont(undefined, 'normal');
    doc.text(formatDate(order.createdAt) || formatDate(new Date()), 50, yPos);

    yPos += 7;
    doc.setFont(undefined, 'bold');
    doc.text('Transaction ID:', 15, yPos);
    doc.setFont(undefined, 'normal');
    doc.text(order.id || 'N/A', 50, yPos);

    yPos += 15;

    // Divider line
    doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
    doc.line(15, yPos, 195, yPos);
    yPos += 10;

    // Product Information
    doc.setFont(undefined, 'bold');
    doc.setFontSize(12);
    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
    doc.text('Product Information:', 15, yPos);

    yPos += 7;
    doc.setFontSize(10);
    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
    doc.setFont(undefined, 'normal');
    doc.text(`Product: ${order.cropName || 'Unknown Product'}`, 15, yPos);

    yPos += 7;
    doc.text(`Farmer: ${order.farmerName || 'Unknown Farmer'}`, 15, yPos);

    yPos += 7;
    doc.text(`Quantity: ${order.quantity || 'N/A'} ${order.unit || 'kg'}`, 15, yPos);

    yPos += 7;
    doc.text(`Order Date: ${formatDate(order.createdAt)}`, 15, yPos);

    yPos += 15;

    // Divider line
    doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
    doc.line(15, yPos, 195, yPos);
    yPos += 10;

    // Quality Score Section
    doc.setFont(undefined, 'bold');
    doc.setFontSize(14);
    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
    doc.text('Quality Assessment', 15, yPos);

    yPos += 10;

    // Quality Score Display
    doc.setFontSize(36);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(orangeColor[0], orangeColor[1], orangeColor[2]);
    doc.text(qualityScore, 15, yPos);

    // Score percentage
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
    doc.text(`${scorePercentage}% Score`, 60, yPos - 5);

    // Progress bar representation
    yPos += 10;
    const barWidth = 180;
    const barHeight = 8;
    const filledWidth = (barWidth * scorePercentage) / 100;

    // Background bar
    doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
    doc.rect(15, yPos, barWidth, barHeight, 'F');

    // Filled bar
    const barColor = scorePercentage >= 90 ? primaryColor : scorePercentage >= 80 ? orangeColor : [239, 68, 68];
    doc.setFillColor(barColor[0], barColor[1], barColor[2]);
    doc.rect(15, yPos, filledWidth, barHeight, 'F');

    yPos += 15;

    // Certification Badge
    doc.setFont(undefined, 'bold');
    doc.setFontSize(12);
    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
    doc.text('Certification:', 15, yPos);

    yPos += 8;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(textColor[0], textColor[1], textColor[2]);

    // Certification badge box
    const certBoxWidth = 60;
    const certBoxHeight = 12;
    doc.setFillColor(primaryColor[0], primaryColor[1], primaryColor[2]);
    doc.roundedRect(15, yPos - 8, certBoxWidth, certBoxHeight, 3, 3, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFont(undefined, 'bold');
    doc.setFontSize(9);
    doc.text(certification, 18, yPos - 1);

    yPos += 15;

    // Test Information
    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
    doc.setFont(undefined, 'bold');
    doc.setFontSize(12);
    doc.text('Test Information:', 15, yPos);

    yPos += 7;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`Test Date: ${formatDate(order.createdAt)}`, 15, yPos);

    yPos += 7;
    doc.text(`Status: ${order.transactionStatus || 'N/A'}`, 15, yPos);

    yPos += 15;

    // Quality Standards Section
    doc.setFont(undefined, 'bold');
    doc.setFontSize(12);
    doc.setTextColor(primaryColor[0], primaryColor[1], primaryColor[2]);
    doc.text('Quality Standards Met:', 15, yPos);

    yPos += 7;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(textColor[0], textColor[1], textColor[2]);

    const standards = [
        '✓ Product meets quality specifications',
        '✓ Proper storage and handling verified',
        '✓ Certification standards maintained',
        '✓ Lab testing completed successfully'
    ];

    standards.forEach(standard => {
        doc.text(standard, 20, yPos);
        yPos += 6;
    });

    yPos += 10;

    // Footer
    doc.setDrawColor(lightGray[0], lightGray[1], lightGray[2]);
    doc.line(15, yPos, 195, yPos);
    yPos += 10;

    doc.setFontSize(8);
    doc.setTextColor(lightGray[0], lightGray[1], lightGray[2]);
    doc.text('This is an automated quality assurance report generated by AgriGuard AI.', 15, yPos);
    yPos += 5;
    doc.text('For inquiries, please contact support@agriguard.ai', 15, yPos);
}


async function viewProductDetails(productId) {
    console.log('=== VIEW PRODUCT DETAILS CALLED ===');
    console.log('Input value:', productId);
    console.log('Input type:', typeof productId);

    try {
        showNotification('Loading product details...', 'info');

        let productData = null;
        let searchStrategy = '';

        // STRATEGY 1: Check if it's a Market Price (starts with MP)
        if (productId.startsWith('MP')) {
            try {
                console.log('Strategy 1: Searching in market prices...');
                const marketPricesResponse = await apiCall(`${API_BASE_URL}/market-prices`);
                const marketPrices = extractDataFromResponse(marketPricesResponse);

                productData = marketPrices.find(mp => mp.id === productId);

                if (productData) {
                    searchStrategy = 'market_price';
                    console.log('✓ Found in market prices');

                    // Enrich with crop data
                    if (productData.cropId) {
                        try {
                            const cropResponse = await apiCall(`${ENDPOINTS.crops}/${productData.cropId}`);
                            const crop = cropResponse.data || cropResponse;
                            productData.cropDetails = crop;
                            console.log('✓ Crop details loaded');
                        } catch (error) {
                            console.warn('Could not load crop details:', error);
                        }
                    }

                    // Show market price details
                    showMarketPriceDetailsModal(productData);
                    return;
                }
            } catch (error) {
                console.error('Strategy 1 failed:', error);
            }
        }

        // STRATEGY 2: Search in active crop productions
        try {
            console.log('Strategy 2: Searching in active productions...');
            const allProductionsResponse = await apiCall(ENDPOINTS.cropProductionsActive);
            const allProductions = extractDataFromResponse(allProductionsResponse);

            productData = allProductions.find(p =>
                p.id === productId ||
                p.productionCode === productId
            );

            if (productData) {
                searchStrategy = 'crop_production';
                console.log('✓ Found in crop productions');

                // Fetch crop details
                let crop = null;
                if (productData.cropId) {
                    try {
                        const cropResponse = await apiCall(`${ENDPOINTS.crops}/${productData.cropId}`);
                        crop = cropResponse.data || cropResponse;
                    } catch (error) {
                        console.warn('Could not load crop details:', error);
                    }
                }

                showProductDetailsModal(productData, crop);
                return;
            }
        } catch (error) {
            console.error('Strategy 2 failed:', error);
        }

        // STRATEGY 3: Try direct crop production lookup
        try {
            console.log('Strategy 3: Direct crop production lookup...');
            const response = await apiCall(`${ENDPOINTS.cropProductions}/${productId}`);
            productData = response.data || response;

            if (productData) {
                searchStrategy = 'direct_crop_production';
                console.log('✓ Direct crop production lookup successful');

                // Fetch crop details
                let crop = null;
                if (productData.cropId) {
                    try {
                        const cropResponse = await apiCall(`${ENDPOINTS.crops}/${productData.cropId}`);
                        crop = cropResponse.data || cropResponse;
                    } catch (error) {
                        console.warn('Could not load crop details:', error);
                    }
                }

                showProductDetailsModal(productData, crop);
                return;
            }
        } catch (error) {
            console.log('✗ Direct crop production lookup failed:', error.message);
        }

        // If still not found
        console.error('=== PRODUCT NOT FOUND ===');
        console.error('Search value:', productId);
        showNotification('Product not found. It may have been removed or is no longer available.', 'error');

    } catch (error) {
        console.error('=== CRITICAL ERROR ===', error);
        showNotification('Failed to load product details. Please try again.', 'error');
    }
}



async function addMarketPriceToCart(marketPriceId, price) {
    try {
        // Get market price details
        const marketPriceResponse = await apiCall(`${API_BASE_URL}/market-prices/${marketPriceId}`);
        const marketPrice = marketPriceResponse.data || marketPriceResponse;

        if (!marketPrice) {
            showNotification('Market price not found', 'error');
            return;
        }

        // Check if already in cart
        const existingItem = shoppingCart.find(item => item.marketPriceId === marketPriceId);

        if (existingItem) {
            existingItem.quantity += 1;
            showNotification('Quantity updated in cart', 'success');
        } else {
            shoppingCart.push({
                marketPriceId: marketPrice.id,
                cropId: marketPrice.cropId,
                cropName: marketPrice.cropName || marketPrice.cropDetails?.cropName || 'Unknown Crop',
                price: price,
                quantity: 1,
                availableQuantity: marketPrice.availableQuantity || 0,
                imageUrl: marketPrice.cropImageUrl || marketPrice.cropDetails?.imageUrl,
                location: marketPrice.location,
                marketName: marketPrice.marketName,
                type: 'market_price', // Distinguish from crop productions
                unit: 'kg'
            });
            showNotification('Product added to cart', 'success');
        }

        saveCartToStorage();
        updateCartBadge();

    } catch (error) {
        console.error('Error adding market price to cart:', error);
        showNotification('Failed to add product to cart', 'error');
    }
}

// Helper function to get current marketplace products
async function getCurrentMarketplaceProducts() {
    try {
        const marketPricesResponse = await apiCall(`${API_BASE_URL}/market-prices/recent?days=30`);
        const productionsResponse = await apiCall(`${API_BASE_URL}/v1/crop-productions/active`);
        const cropsResponse = await apiCall(`${API_BASE_URL}/v1/crops/all`);

        const marketPrices = extractDataFromResponse(marketPricesResponse);
        const productions = extractDataFromResponse(productionsResponse);
        const crops = extractDataFromResponse(cropsResponse);

        const enrichedMarketPrices = enrichMarketPricesWithCropNames(marketPrices, crops);
        return mergeMarketPricesWithProductions(enrichedMarketPrices, productions);
    } catch (error) {
        console.error('Error getting marketplace products:', error);
        return [];
    }
}

function showMarketPriceDetailsModal(marketPrice) {
    const modal = document.createElement('div');
    modal.className = 'modal';

    // Extract data safely with fallbacks
    const cropName = marketPrice.cropDetails?.cropName || marketPrice.cropName || 'Unknown Crop';
    const cropDescription = marketPrice.cropDetails?.description || marketPrice.notes || 'Market price information';
    const cropImageUrl = marketPrice.cropDetails?.imageUrl || marketPrice.cropImageUrl || null;
    const cropType = marketPrice.cropDetails?.cropType || marketPrice.cropType || 'N/A';
    const price = marketPrice.pricePerKg || marketPrice.price || 0;
    const location = marketPrice.location || 'Location not specified';
    const marketName = marketPrice.marketName || 'Local Market';
    const marketType = marketPrice.marketType || 'RETAIL';
    const priceDate = marketPrice.priceDate || new Date();
    const demandLevel = marketPrice.demandLevel || 'MEDIUM';
    const supplyLevel = marketPrice.supplyLevel || 'MEDIUM';
    const priceTrend = marketPrice.priceTrend || 'STABLE';
    const availableQuantity = marketPrice.availableQuantity || 0;
    const reliabilityScore = marketPrice.reliabilityScore || 3;

    // Determine trend badge
    let trendBadge = '';
    let trendClass = '';
    if (priceTrend === 'INCREASING') {
        trendBadge = 'Price Rising ↗';
        trendClass = 'status-organic';
    } else if (priceTrend === 'DECREASING') {
        trendBadge = 'Price Falling ↘';
        trendClass = 'status-certified';
    } else {
        trendBadge = 'Price Stable →';
        trendClass = 'status-growing';
    }

    // Determine reliability badge
    let reliabilityBadge = '';
    if (reliabilityScore >= 4) {
        reliabilityBadge = 'High Reliability ★★★★★';
    } else if (reliabilityScore >= 3) {
        reliabilityBadge = 'Good Reliability ★★★★';
    } else {
        reliabilityBadge = 'Fair Reliability ★★★';
    }

    modal.innerHTML = `
        <div class="modal-content large">
            <div class="modal-header">
                <h2>${cropName} - Market Price</h2>
                <button class="modal-close" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="product-details-grid">
                    <!-- Image Section -->
                    <div class="product-image-section">
                        ${cropImageUrl ?
                            `<img src="${cropImageUrl}" alt="${cropName}"
                                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZWNmMGYxIi8+CjxwYXRoIGQ9Ik03NSA1MEgxMjVWMTUwSDc1VjUwWiIgZmlsbD0iIzJlY2M3MSIvPgo8Y2lyY2xlIGN4PSIxMDAiIGN5PSI3NSIgcj0iMTUiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==';">` :
                            `<div class="product-placeholder-large">
                                <i class="fas fa-chart-line"></i>
                                <span>Market Price Data</span>
                             </div>`
                        }
                        <div style="margin-top: 1rem; text-align: center;">
                            <span class="status-badge ${trendClass}">${trendBadge}</span>
                            <span class="status-badge status-harvested" style="margin-left: 0.5rem;">${reliabilityBadge}</span>
                        </div>
                    </div>

                    <!-- Info Section -->
                    <div class="product-info-section">
                        <h3 style="margin-bottom: 1rem; color: var(--text-dark);">Market Information</h3>
                        <p class="product-description" style="color: var(--text-light); margin-bottom: 1.5rem; line-height: 1.6;">
                            Current market pricing information for ${cropName} based on recent market data.
                        </p>

                        <div class="info-grid">
                            <!-- Price Information -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-dollar-sign"></i> Current Price:
                                </span>
                                <span class="value price-highlight">${formatCurrency(price)}/kg</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-store"></i> Market:
                                </span>
                                <span class="value">${marketName}</span>
                            </div>

                            <!-- Location & Availability -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-map-marker-alt"></i> Location:
                                </span>
                                <span class="value">${location}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-box"></i> Estimated Supply:
                                </span>
                                <span class="value">${availableQuantity} kg</span>
                            </div>

                            <!-- Market Conditions -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-chart-line"></i> Market Type:
                                </span>
                                <span class="value">${marketType}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-tag"></i> Category:
                                </span>
                                <span class="value">${cropType}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-fire"></i> Demand Level:
                                </span>
                                <span class="value" style="color: ${
                                    demandLevel === 'HIGH' ? 'var(--danger-color)' :
                                    demandLevel === 'MEDIUM' ? 'var(--warning-color)' : 'var(--success-color)'
                                }">${demandLevel}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-warehouse"></i> Supply Level:
                                </span>
                                <span class="value" style="color: ${
                                    supplyLevel === 'HIGH' ? 'var(--success-color)' :
                                    supplyLevel === 'MEDIUM' ? 'var(--warning-color)' : 'var(--danger-color)'
                                }">${supplyLevel}</span>
                            </div>

                            <!-- Additional Info -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-calendar"></i> Price Date:
                                </span>
                                <span class="value">${formatDate(priceDate)}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-database"></i> Data Source:
                                </span>
                                <span class="value">${marketPrice.dataSource || 'Market Data'}</span>
                            </div>
                        </div>

                        <!-- Market Insights -->
                        <div class="nutritional-info">
                            <h4>
                                <i class="fas fa-lightbulb"></i> Market Insights
                            </h4>
                            <p style="color: var(--text-dark); line-height: 1.6; margin: 0;">
                                ${getMarketInsights(demandLevel, supplyLevel, priceTrend)}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i> Close
                </button>
                ${availableQuantity > 0 ? `
                    <button class="btn btn-primary" onclick="addMarketPriceToCart('${marketPrice.id}', ${price}); this.closest('.modal').remove(); showNotification('Product added to cart!', 'success');">
                        <i class="fas fa-shopping-cart"></i> Add to Cart - ${formatCurrency(price)}
                    </button>
                ` : `
                    <button class="btn btn-secondary" disabled>
                        <i class="fas fa-ban"></i> Limited Availability
                    </button>
                `}
            </div>
        </div>
    `;

    // Add modal to page
    document.body.appendChild(modal);

    // Show modal with animation
    setTimeout(() => modal.classList.add('show'), 10);

    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });

    // Close modal with Escape key
    const closeModal = (e) => {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', closeModal);
        }
    };
    document.addEventListener('keydown', closeModal);
}

// Helper function for market insights
function getMarketInsights(demandLevel, supplyLevel, priceTrend) {
    const insights = [];

    if (demandLevel === 'HIGH' && supplyLevel === 'LOW') {
        insights.push('High demand with limited supply suggests favorable selling conditions.');
    } else if (demandLevel === 'LOW' && supplyLevel === 'HIGH') {
        insights.push('Low demand with abundant supply may indicate buying opportunities.');
    }

    if (priceTrend === 'INCREASING') {
        insights.push('Prices are trending upward, consider purchasing soon.');
    } else if (priceTrend === 'DECREASING') {
        insights.push('Prices are trending downward, you may get better deals.');
    } else {
        insights.push('Prices are stable, good time for planned purchases.');
    }

    return insights.join(' ');
}










function showProductDetailsModal(production, crop) {
    // Create modal element
    const modal = document.createElement('div');
    modal.className = 'modal';

    // Extract data safely with fallbacks
    const cropName = crop?.cropName || production.cropName || 'Unknown Crop';
    const cropDescription = crop?.description || production.notes || 'No description available';
    const cropImageUrl = crop?.imageUrl || production.cropImageUrl || null;
    const cropType = crop?.cropType || production.cropType || 'N/A';
    const variety = crop?.variety || production.seedVariety || 'N/A';
    const availableQuantity = production.expectedYield || production.actualYield || 0;
    const price = production.estimatedPrice || production.marketPrice || 0;
    const harvestDate = production.expectedHarvestDate || production.actualHarvestDate || new Date();
    const location = production.location || 'Location not specified';
    const farmerName = production.farmerName || 'Unknown Farmer';
    const productionMethod = production.productionMethod || 'N/A';
    const productionStatus = production.productionStatus || 'N/A';
    const certification = production.certification || 'None';
    const areaPlanted = production.areaPlanted || 0;
    const isOrganic = production.isOrganic || productionMethod?.includes('ORGANIC');
    const isCertified = production.certification && production.certification !== 'None';

    // Determine status badge
    let statusBadge = '';
    let statusClass = '';
    if (isOrganic) {
        statusBadge = 'Organic';
        statusClass = 'status-organic';
    } else if (isCertified) {
        statusBadge = 'Certified';
        statusClass = 'status-certified';
    } else if (productionStatus === 'HARVESTED') {
        statusBadge = 'Harvested';
        statusClass = 'status-harvested';
    } else {
        statusBadge = 'Growing';
        statusClass = 'status-growing';
    }

    modal.innerHTML = `
        <div class="modal-content large">
            <div class="modal-header">
                <h2>${cropName}</h2>
                <button class="modal-close" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="product-details-grid">
                    <!-- Image Section -->
                    <div class="product-image-section">
                        ${cropImageUrl ?
                            `<img src="${cropImageUrl}" alt="${cropName}"
                                  onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjZWNmMGYxIi8+CjxwYXRoIGQ9Ik03NSA1MEgxMjVWMTUwSDc1VjUwWiIgZmlsbD0iIzJlY2M3MSIvPgo8Y2lyY2xlIGN4PSIxMDAiIGN5PSI3NSIgcj0iMTUiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==';">` :
                            `<div class="product-placeholder-large">
                                <i class="fas fa-seedling"></i>
                                <span>No Image Available</span>
                             </div>`
                        }
                        <div style="margin-top: 1rem; text-align: center;">
                            <span class="status-badge ${statusClass}">${statusBadge}</span>
                        </div>
                    </div>

                    <!-- Info Section -->
                    <div class="product-info-section">
                        <h3 style="margin-bottom: 1rem; color: var(--text-dark);">Product Details</h3>
                        <p class="product-description" style="color: var(--text-light); margin-bottom: 1.5rem; line-height: 1.6;">
                            ${cropDescription}
                        </p>

                        <div class="info-grid">
                            <!-- Basic Information -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-tag"></i> Category:
                                </span>
                                <span class="value">${cropType}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-seedling"></i> Variety:
                                </span>
                                <span class="value">${variety}</span>
                            </div>

                            <!-- Availability & Pricing -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-box"></i> Available:
                                </span>
                                <span class="value" style="color: ${availableQuantity > 0 ? 'var(--success-color)' : 'var(--danger-color)'}">
                                    ${availableQuantity} kg
                                </span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-dollar-sign"></i> Price:
                                </span>
                                <span class="value price-highlight">${formatCurrency(price)}/kg</span>
                            </div>

                            <!-- Dates -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-calendar"></i> Harvest Date:
                                </span>
                                <span class="value">${formatDate(harvestDate)}</span>
                            </div>

                            <!-- Location & Farmer -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-map-marker-alt"></i> Location:
                                </span>
                                <span class="value">${location}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-user"></i> Farmer:
                                </span>
                                <span class="value">${farmerName}</span>
                            </div>

                            <!-- Production Details -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-cogs"></i> Method:
                                </span>
                                <span class="value">${productionMethod}</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-certificate"></i> Certification:
                                </span>
                                <span class="value">${certification}</span>
                            </div>

                            <!-- Additional Info -->
                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-chart-area"></i> Area Planted:
                                </span>
                                <span class="value">${areaPlanted} hectares</span>
                            </div>

                            <div class="info-item">
                                <span class="label">
                                    <i class="fas fa-info-circle"></i> Status:
                                </span>
                                <span class="value">${productionStatus}</span>
                            </div>
                        </div>

                        <!-- Nutritional Information -->
                        ${crop?.nutritionalInfo ? `
                            <div class="nutritional-info">
                                <h4>
                                    <i class="fas fa-heartbeat"></i> Nutritional Information
                                </h4>
                                <p style="color: var(--text-dark); line-height: 1.6; margin: 0;">
                                    ${crop.nutritionalInfo}
                                </p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                    <i class="fas fa-times"></i> Close
                </button>
                ${availableQuantity > 0 ? `
                    <button class="btn btn-primary" onclick="addToCart('${production.id}'); this.closest('.modal').remove(); showNotification('Product added to cart!', 'success');">
                        <i class="fas fa-shopping-cart"></i> Add to Cart - ${formatCurrency(price)}
                    </button>
                ` : `
                    <button class="btn btn-secondary" disabled>
                        <i class="fas fa-ban"></i> Out of Stock
                    </button>
                `}
            </div>
        </div>
    `;

    // Add modal to page
    document.body.appendChild(modal);

    // Show modal with animation
    setTimeout(() => modal.classList.add('show'), 10);

    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });

    // Close modal with Escape key
    const closeModal = (e) => {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', closeModal);
        }
    };
    document.addEventListener('keydown', closeModal);
}

// Make function globally available
window.viewProductDetails = viewProductDetails;


// Add this CSS to your <style> section
const additionalCSS = `
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    padding: 2rem;
    overflow-y: auto;
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: var(--radius-lg);
    width: 100%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: modalSlideIn 0.3s ease;
}

.modal-content.large {
    max-width: 1200px;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-light);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: var(--radius-md);
    transition: var(--transition-base);
}

.modal-close:hover {
    background: var(--gray);
    color: var(--text-dark);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
}
`;

// Inject the CSS
const style = document.createElement('style');
style.textContent = additionalCSS;
document.head.appendChild(style);

  // ==================== LEAVE REVIEW ====================

  function leaveReview(orderId) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
          <div class="modal-content">
              <div class="modal-header">
                  <h2>Leave a Review</h2>
                  <button class="modal-close" onclick="this.closest('.modal').remove()">
                      <i class="fas fa-times"></i>
                  </button>
              </div>
              <div class="modal-body">
                  <form id="reviewForm">
                      <div class="form-group">
                          <label>Rating</label>
                          <div class="star-rating">
                              <input type="radio" name="rating" value="5" id="star5">
                              <label for="star5"><i class="fas fa-star"></i></label>
                              <input type="radio" name="rating" value="4" id="star4">
                              <label for="star4"><i class="fas fa-star"></i></label>
                              <input type="radio" name="rating" value="3" id="star3">
                              <label for="star3"><i class="fas fa-star"></i></label>
                              <input type="radio" name="rating" value="2" id="star2">
                              <label for="star2"><i class="fas fa-star"></i></label>
                              <input type="radio" name="rating" value="1" id="star1">
                              <label for="star1"><i class="fas fa-star"></i></label>
                          </div>
                      </div>
                      <div class="form-group">
                          <label for="reviewText">Your Review</label>
                          <textarea id="reviewText" rows="4" placeholder="Share your experience..."></textarea>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                      Cancel
                  </button>
                  <button class="btn btn-primary" onclick="submitReview('${orderId}')">
                      Submit Review
                  </button>
              </div>
          </div>
      `;
      document.body.appendChild(modal);
      setTimeout(() => modal.classList.add('show'), 10);
  }

  async function submitReview(orderId) {
      const rating = document.querySelector('input[name="rating"]:checked')?.value;
      const feedback = document.getElementById('reviewText')?.value;

      if (!rating) {
          showNotification('Please select a rating', 'warning');
          return;
      }

      try {
          await apiCall(`${ENDPOINTS.transactionById(orderId)}/rate-farmer`, {
              method: 'PUT',
              body: JSON.stringify({
                  rating: parseInt(rating),
                  feedback: feedback || ''
              })
          });

          showNotification('Thank you for your review!', 'success');
          document.querySelector('.modal')?.remove();

      } catch (error) {
          console.error('Error submitting review:', error);
          showNotification('Failed to submit review', 'error');
      }
  }



  // ==================== PERIODIC UPDATES ====================

  function startPeriodicUpdates() {
      const sessionHandler = window.UserSessionHandler ? window.UserSessionHandler.getInstance() : null;

      // Refresh data every 5 minutes
      setInterval(() => {
          // Check if still authenticated
          if (sessionHandler && !sessionHandler.isAuthenticated()) {
              handleUnauthorized();
              return;
          }

          // Update activity
          if (sessionHandler && currentUser) {
              sessionHandler.updateLastActivity();

              if (window.sessionTracker) {
                  window.sessionTracker.updateLastActivity(currentUser.id || currentUser.userId);
              }
          }

          // Refresh data if on overview
          if (currentSection === 'overview') {
              loadOverviewData();
          }

          loadNotifications();
      }, 5 * 60 * 1000);
  }



    // Enhanced Sidebar Navigation
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();

        // Remove active class from all items
        document.querySelectorAll('.nav-item').forEach(navItem => {
            navItem.style.background = 'transparent';
            navItem.style.color = '#64748b';
            navItem.style.boxShadow = 'none';
        });

        // Add active class to clicked item
        this.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        this.style.color = 'white';
        this.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';

        // Navigate to section
        const section = this.dataset.section;
        setActiveSection(section);
    });

    // Hover effects
    item.addEventListener('mouseenter', function() {
        if (!this.classList.contains('active')) {
            this.style.background = '#f1f5f9';
            this.style.color = '#1e293b';
        }
    });

    item.addEventListener('mouseleave', function() {
        if (!this.classList.contains('active')) {
            this.style.background = 'transparent';
            this.style.color = '#64748b';
        }
    });
});

  // ==================== GLOBAL FUNCTIONS ====================

  // Make functions globally accessible
  window.viewOrderDetails = viewOrderDetails;
  window.trackOrder = trackOrder;
  window.cancelOrder = cancelOrder;
  window.viewProductDetails = viewProductDetails;
  window.addToCart = addToCart;
  window.updateCartQuantity = updateCartQuantity;
  window.removeFromCart = removeFromCart;
  window.handleCheckout = handleCheckout;
  window.viewFarmerProducts = viewFarmerProducts;
  window.contactFarmer = contactFarmer;
  window.viewTransactionDetails = viewTransactionDetails;
  window.downloadInvoice = downloadInvoice;
  window.viewQualityReport = viewQualityReport;
  window.leaveReview = leaveReview;
  window.submitReview = submitReview;
  window.searchFarmers = searchFarmers;
  window.searchProducts = searchProducts;
  window.searchOrders = searchOrders;
  window.searchTrackingOrder = searchTrackingOrder;
  window.handleReportsPeriodChange = handleReportsPeriodChange;
  window.exportReportsToPDF = exportReportsToPDF;
  window.handleFarmerSearch = handleFarmerSearch;

  console.log('BuyerDashboard.js loaded successfully');

</script>
</body>
</html>
