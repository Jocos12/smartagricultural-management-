<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriGuard AI - Soil Data Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --primary-green: #22c55e;
            --primary-dark: #16a34a;
            --secondary-green: #10b981;
            --accent-green: #34d399;
            --light-green: #dcfce7;
            --dark-green: #166534;
            --forest-green: #065f46;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-sidebar: #e8f5e8;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --hover-bg: rgba(34, 197, 94, 0.1);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 25px rgba(34, 197, 94, 0.15);
            --gradient-primary: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            --gradient-bg: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
            --card-bg: #ffffff;
            --modal-bg: rgba(0, 0, 0, 0.5);
        }

        .dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-sidebar: #1f2937;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #404040;
            --hover-bg: rgba(34, 197, 94, 0.2);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --card-bg: #374151;
            --gradient-bg: linear-gradient(135deg, #1f2937 0%, #374151 50%, #4b5563 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
    body {
        font-family: 'Inter', sans-serif;
        background: var(--gradient-bg);
        color: var(--text-primary);
        transition: all 0.3s ease;
        overflow-x: hidden;
        overflow-y: scroll; /* Force scrollbar to always show */
    }

        .dashboard-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            height: 100vh;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            color: white;
            font-size: 24px;
            box-shadow: var(--shadow);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .company-info {
            flex: 1;
            transition: opacity 0.3s ease;
        }

        .company-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .company-tagline {
            font-size: 11px;
            color: var(--primary-green);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar.collapsed .company-info {
            opacity: 0;
            width: 0;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 30px;
        }

        .nav-section-title {
            padding: 0 20px 10px;
            font-size: 11px;
            font-weight: 700;
            color: var(--primary-green);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-section-title {
            opacity: 0;
            height: 0;
            margin: 0;
            padding: 0;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 0 25px 25px 0;
            margin-right: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-link:hover::before {
            left: 100%;
        }

        .nav-link i {
            width: 22px;
            margin-right: 14px;
            font-size: 18px;
            flex-shrink: 0;
        }

        .nav-link span {
            transition: opacity 0.3s ease;
            whitespace: nowrap;
            font-weight: 500;
        }

        .sidebar.collapsed .nav-link span {
            opacity: 0;
        }

        .sidebar.collapsed .nav-link {
            margin-right: 0;
            border-radius: 0;
            justify-content: center;
        }

        .nav-link:hover {
            background: var(--hover-bg);
            color: var(--primary-green);
            transform: translateX(5px);
        }

        .nav-item.active .nav-link {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }

        .main-content.sidebar-collapsed {
            margin-left: 70px;
        }

        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 80px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            padding: 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: var(--hover-bg);
            color: var(--primary-green);
            transform: scale(1.1);
        }

        .greeting-section {
            display: flex;
            flex-direction: column;
        }

        .greeting-text {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .current-date {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .search-container {
            position: relative;
            width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 12px 50px 12px 20px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 18px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .theme-toggle {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            background: var(--hover-bg);
            border-color: var(--primary-green);
            transform: translateY(-2px);
        }

        .notification-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            position: relative;
            padding: 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .notification-btn:hover {
            background: var(--hover-bg);
            color: var(--primary-green);
        }

        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--error-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-5px); }
            60% { transform: translateY(-3px); }
        }

        .profile-section {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .profile-section:hover {
            background: var(--hover-bg);
        }

        .profile-avatar {
            width: 45px;
            height: 45px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .profile-info {
            display: flex;
            flex-direction: column;
        }

        .profile-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .profile-role {
            font-size: 12px;
            color: var(--primary-green);
            font-weight: 500;
            text-transform: capitalize;
        }

    .content {
        flex: 1;
        padding: 32px;
        background: var(--bg-secondary);
        overflow-y: scroll; /* Changed from 'auto' to 'scroll' */
        min-height: calc(100vh - 80px);
        height: calc(100vh - 80px); /* Added fixed height */
    }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 12px;
        }

        .stat-icon.samples { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .stat-icon.ph { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .stat-icon.nutrients { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .stat-icon.quality { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .map-section {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 32px;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .map-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        #soilMap {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .table-section {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-bottom: 32px;
        }

        .table-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .table-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
            border-color: var(--primary-green);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            color: var(--text-primary);
            font-size: 14px;
        }

        .data-table tr:hover {
            background: var(--hover-bg);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-excellent {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
        }

        .status-good {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .status-fair {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .status-poor {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn-edit {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .action-btn-edit:hover {
            background: #3b82f6;
            color: white;
        }

        .action-btn-delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .action-btn-delete:hover {
            background: #ef4444;
            color: white;
        }

        .action-btn-view {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .action-btn-view:hover {
            background: #22c55e;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--hover-bg);
            color: var(--primary-green);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-secondary);
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
        }

        .toast {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid;
            animation: slideInRight 0.3s ease;
            max-width: 400px;
        }

        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--error-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.info { border-left-color: var(--primary-green); }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast-message {
            color: var(--text-primary);
            font-weight: 500;
            margin: 0;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-green);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 18px;
            margin-top: 12px;
        }

        .ai-prediction-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--primary-green);
            margin-top: 20px;
        }

        .prediction-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .prediction-content {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }

        .logout-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-left: 12px;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            transform: scale(1.1);
        }

        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                padding: 0 16px;
            }

            .search-container {
                width: 200px;
            }

            .content {
                padding: 20px 16px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .greeting-text {
                font-size: 18px;
            }

            .profile-info {
                display: none;
            }
        }


    /* Custom Green Scrollbar - Enhanced Version */
    ::-webkit-scrollbar {
        width: 16px;
        height: 16px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #22c55e 0%, #16a34a 50%, #15803d 100%);
        border-radius: 10px;
        border: 3px solid #f1f1f1;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #16a34a 0%, #15803d 50%, #166534 100%);
    }

    ::-webkit-scrollbar-thumb:active {
        background: linear-gradient(180deg, #15803d 0%, #166534 100%);
    }

    /* Firefox */
    * {
        scrollbar-width: thin;
        scrollbar-color: #22c55e #f1f1f1;
    }




        @keyframes markerBounce {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-5px);
    }
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.8;
    }
}

/* Style pour les popups personnalisés */
.leaflet-popup-content-wrapper {
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.leaflet-popup-content {
    margin: 15px;
}

.custom-marker {
    background: transparent !important;
    border: none !important;
}






        /* ==================== SOIL MODULE ENHANCEMENTS - MODERN DESIGN ==================== */

.soil-module-enhancements {
    margin-top: 40px;
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.soil-module-enhancements h3 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 24px;
    color: var(--text-primary);
    border-bottom: 3px solid var(--primary-green);
    padding-bottom: 12px;
    display: flex;
    align-items: center;
    background: linear-gradient(90deg, rgba(34, 197, 94, 0.1) 0%, transparent 100%);
    padding: 16px;
    border-radius: 12px 12px 0 0;
}

.soil-module-enhancements h3 i {
    color: var(--primary-green);
    margin-right: 12px;
    font-size: 28px;
    animation: pulse 2s ease-in-out infinite;
}

/* ==================== SOIL CONDITION CARDS ==================== */

.soil-condition-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.soil-condition-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 24px;
    border: 2px solid;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.soil-condition-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: linear-gradient(90deg, var(--primary-green), var(--secondary-green));
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.6s ease;
}

.soil-condition-card:hover::before {
    transform: scaleX(1);
}

.soil-condition-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
}

.soil-condition-card.good {
    border-color: #22c55e;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), rgba(34, 197, 94, 0.02));
}

.soil-condition-card.moderate {
    border-color: #f59e0b;
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.05), rgba(245, 158, 11, 0.02));
}

.soil-condition-card.bad {
    border-color: #ef4444;
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(239, 68, 68, 0.02));
}

/* ==================== CONDITION HEADER ==================== */

.condition-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    gap: 16px;
}

.condition-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    flex-shrink: 0;
    position: relative;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
}

.condition-icon::after {
    content: '';
    position: absolute;
    inset: -4px;
    border-radius: 50%;
    padding: 4px;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.5), transparent);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.soil-condition-card:hover .condition-icon::after {
    opacity: 1;
    animation: rotate 2s linear infinite;
}

@keyframes rotate {
    to { transform: rotate(360deg); }
}

.condition-icon.good {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.condition-icon.moderate {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.condition-icon.bad {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.soil-condition-card:hover .condition-icon {
    transform: scale(1.1) rotate(5deg);
}

.condition-info {
    flex: 1;
}

.condition-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 6px;
    color: var(--text-primary);
    letter-spacing: -0.5px;
}

.condition-description {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.6;
    font-weight: 500;
}

/* ==================== COMPONENT LIST ==================== */

.component-list {
    margin: 20px 0;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 12px;
    padding: 16px;
}

.component-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 8px;
    border-bottom: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.component-item:last-child {
    border-bottom: none;
}

.component-item:hover {
    background: rgba(34, 197, 94, 0.05);
    padding-left: 16px;
    border-radius: 8px;
}

.component-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.component-name::before {
    content: '●';
    color: var(--primary-green);
    font-size: 12px;
}

.component-status {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.component-status:hover {
    transform: scale(1.05);
}

.component-status.optimal {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.component-status.acceptable {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.component-status.marginal {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.component-status.critical {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

/* ==================== RECOMMENDATIONS LIST ==================== */

.recommendations-list {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(34, 197, 94, 0.03));
    border-left: 4px solid var(--primary-green);
    padding: 20px;
    border-radius: 0 12px 12px 0;
    margin-top: 20px;
    transition: all 0.3s ease;
}

.recommendations-list:hover {
    border-left-width: 6px;
    padding-left: 24px;
    box-shadow: 0 4px 16px rgba(34, 197, 94, 0.15);
}

.recommendations-list h5 {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 12px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
}

.recommendations-list h5 i {
    color: var(--primary-green);
    font-size: 18px;
}

.recommendations-list ul {
    margin: 0;
    padding-left: 24px;
    list-style: none;
}

.recommendations-list li {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 10px;
    line-height: 1.6;
    position: relative;
    padding-left: 8px;
    transition: all 0.3s ease;
}

.recommendations-list li::before {
    content: '✓';
    position: absolute;
    left: -20px;
    color: var(--primary-green);
    font-weight: 700;
    font-size: 16px;
}

.recommendations-list li:hover {
    color: var(--text-primary);
    transform: translateX(4px);
}

/* ==================== SOIL ATTRIBUTES SECTION ==================== */

.soil-attributes-section {
    margin-top: 32px;
    animation: fadeInUp 0.8s ease-out 0.2s backwards;
}

.soil-attributes-section h4 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.soil-attributes-section h4 i {
    color: var(--primary-green);
    font-size: 20px;
}

#soilAttributesContainer {
    background: var(--bg-secondary);
    padding: 24px;
    border-radius: 16px;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
}

#soilAttributesContainer:hover {
    border-color: var(--primary-green);
    box-shadow: 0 8px 24px rgba(34, 197, 94, 0.15);
    transform: translateY(-2px);
}

/* ==================== ATTRIBUTES GRID ==================== */

.attributes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.attribute-card {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.attribute-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-green), var(--secondary-green));
    transform: scaleX(0);
    transition: transform 0.4s ease;
}

.attribute-card:hover::before {
    transform: scaleX(1);
}

.attribute-card:hover {
    border-color: var(--primary-green);
    box-shadow: 0 8px 24px rgba(34, 197, 94, 0.15);
    transform: translateY(-4px);
}

.attribute-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
    gap: 12px;
}

.attribute-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
    color: white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
}

.attribute-card:hover .attribute-icon {
    transform: scale(1.1) rotate(-5deg);
}

.attribute-icon.ph {
    background: linear-gradient(135deg, #3b82f6, #1e40af);
}

.attribute-icon.nutrient {
    background: linear-gradient(135deg, #22c55e, #16a34a);
}

.attribute-icon.organic {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.attribute-icon.moisture {
    background: linear-gradient(135deg, #06b6d4, #0e7490);
}

.attribute-icon.texture {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
}

.attribute-icon.ec {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.attribute-info {
    flex: 1;
}

.attribute-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.attribute-value {
    font-size: 28px;
    font-weight: 800;
    color: var(--text-primary);
    line-height: 1;
    margin-bottom: 4px;
}

.attribute-unit {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
}

.attribute-status {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 700;
    margin-top: 8px;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
}

.attribute-status:hover {
    transform: scale(1.05);
}

/* ==================== RESPONSIVE DESIGN ==================== */

@media (max-width: 1024px) {
    .soil-condition-cards {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }

    .attributes-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }
}

@media (max-width: 768px) {
    .soil-module-enhancements h3 {
        font-size: 20px;
        padding: 12px;
    }

    .soil-condition-cards {
        grid-template-columns: 1fr;
        gap: 16px;
    }

    .attributes-grid {
        grid-template-columns: 1fr;
    }

    .condition-icon {
        width: 56px;
        height: 56px;
        font-size: 24px;
    }

    .condition-title {
        font-size: 18px;
    }

    .attribute-value {
        font-size: 24px;
    }
}

@media (max-width: 480px) {
    .soil-module-enhancements {
        margin-top: 24px;
    }

    #soilAttributesContainer {
        padding: 16px;
    }

    .recommendations-list {
        padding: 16px;
    }

    .component-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
}

/* ==================== DARK MODE SUPPORT ==================== */

.dark-mode .soil-condition-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.dark-mode .component-list {
    background: rgba(0, 0, 0, 0.2);
}

.dark-mode .recommendations-list {
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.08));
}

.dark-mode .attribute-card {
    background: rgba(255, 255, 255, 0.05);
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
}

/* ==================== LOADING ANIMATION ==================== */

.loading-shimmer {
    background: linear-gradient(
        90deg,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.2) 20%,
        rgba(255, 255, 255, 0.5) 60%,
        rgba(255, 255, 255, 0) 100%
    );
    background-size: 200% 100%;
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

/* ==================== EMPTY STATE ==================== */

.empty-state-soil {
    text-align: center;
    padding: 48px 24px;
    color: var(--text-secondary);
}

.empty-state-soil i {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.4;
    color: var(--primary-green);
}

.empty-state-soil p {
    font-size: 16px;
    margin-top: 12px;
    line-height: 1.6;
}
    </style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
</div>

<div class="toast-container" id="toastContainer"></div>

<div class="dashboard-container">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="images/logo.jpeg" alt="AgriGuard AI Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 12px;">
            </div>
            <div class="company-info">
                <div class="company-name">AgriGuard AI</div>
                <div class="company-tagline">Soil Analysis</div>
            </div>
        </div>


        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">Main</h3>
                <ul class="nav-menu">
                    <li class="nav-item active">
                        <a class="nav-link" onclick="showSection('dashboard')">
                            <i class="fas fa-chart-line"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('soilData')">
                            <i class="fas fa-seedling"></i>
                            <span>Soil Data</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('analytics')">
                            <i class="fas fa-chart-bar"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('predictions')">
                            <i class="fas fa-brain"></i>
                            <span>AI Predictions</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Reports</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('reports')">
                            <i class="fas fa-file-alt"></i>
                            <span>Generate Reports</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <div class="main-content" id="mainContent">
        <header class="header">
            <div class="header-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="greeting-section">
                    <div class="greeting-text" id="greetingText">Good Morning!</div>
                    <div class="current-date" id="currentDate"></div>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search soil data..." id="globalSearch" onkeyup="handleGlobalSearch()">
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="header-right">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
                    <i class="fas fa-moon"></i>
                    <span>Dark Mode</span>
                </button>
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationCount">0</span>
                </button>
                <div class="profile-section">
                    <div class="profile-avatar">U</div>
                    <div class="profile-info">
                        <div class="profile-name">User</div>
                        <div class="profile-role">Farmer</div>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="content">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="content-section active">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon samples">
                            <i class="fas fa-vial"></i>
                        </div>
                        <div class="stat-value" id="totalSamples">0</div>
                        <div class="stat-label">Total Samples</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon ph">
                            <i class="fas fa-flask"></i>
                        </div>
                        <div class="stat-value" id="avgPh">0.0</div>
                        <div class="stat-label">Average pH</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon nutrients">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <div class="stat-value" id="lowNutrients">0</div>
                        <div class="stat-label">Low Nutrients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon quality">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-value" id="excellentQuality">0</div>
                        <div class="stat-label">Excellent Quality</div>
                    </div>
                </div>

                <div class="map-section">
                    <div class="map-header">
                        <h3 class="map-title">Chad Soil Map - Sample Locations</h3>
                        <button class="btn btn-secondary" onclick="refreshMap()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh Map
                        </button>
                    </div>
                    <div id="soilMap"></div>
                </div>

                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">pH Level Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="phDistributionChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Soil Quality Overview</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="qualityChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Nutrient Levels (NPK)</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="nutrientChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Soil Texture Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="textureChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Soil Data Section -->
            <div id="soilDataSection" class="content-section">
                <div class="table-section">
                    <div class="table-header">
                        <h2 class="table-title">Soil Data Management</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="showAddSoilDataModal()">
                                <i class="fas fa-plus"></i>
                                Add Soil Data
                            </button>
                            <button class="btn btn-secondary" onclick="loadAllSoilData()">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                            <button class="btn btn-info" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i>
                                Export Excel
                            </button>
                        </div>
                    </div>
                    <div style="padding: 0 24px 24px;">
                        <input type="text" class="search-input" placeholder="Search soil data..." id="soilDataSearch" onkeyup="searchInTable('soilDataTableBody', 'soilDataSearch')">
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>Sample Code</th>
                                <th>Farm</th>
                                <th>pH Level</th>
                                <th>N-P-K</th>
                                <th>Organic Matter</th>
                                <th>Quality</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="soilDataTableBody">
                            <tr>
                                <td colspan="8" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading soil data...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analyticsSection" class="content-section">
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">pH Trend Over Time</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="phTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Moisture Content Analysis</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="moistureChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Nitrogen vs Phosphorus Scatter</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="scatterChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Organic Matter Histogram</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="histogramChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Predictions Section -->
            <div id="predictionsSection" class="content-section">
                <div class="chart-card">
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">
                        <i class="fas fa-brain" style="color: var(--primary-green);"></i>
                        AI-Powered Soil Analysis & Predictions
                    </h3>

                    <div id="aiPredictionsContainer">
                        <div class="ai-prediction-card">
                            <div class="prediction-title">
                                <i class="fas fa-spinner fa-spin"></i>
                                Analyzing soil data...
                            </div>
                        </div>
                    </div>

                    <!-- ⬇️ AJOUTE CE NOUVEAU CODE ICI ⬇️ -->
                    <div class="soil-module-enhancements" style="margin-top: 40px;">
                        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary); border-bottom: 2px solid var(--primary-green); padding-bottom: 10px;">
                            <i class="fas fa-seedling" style="color: var(--primary-green); margin-right: 10px;"></i>
                            Soil Module Enhancements - Condition Assessment
                        </h3>

                        <div id="soilConditionContainer" class="soil-condition-cards">
                            <!-- Les cartes d'évaluation du sol seront ajoutées dynamiquement ici -->
                        </div>

                        <div class="soil-attributes-section" style="margin-top: 30px;">
                            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--text-primary);">
                                <i class="fas fa-database" style="color: var(--primary-green); margin-right: 8px;"></i>
                                Soil Attributes for AI Prediction
                            </h4>
                            <div id="soilAttributesContainer" style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                                <!-- Les attributs pour l'IA seront affichés ici -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="content-section">
                <div class="chart-card" style="margin-bottom: 24px;">
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">Report Configuration</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Report Type</label>
                            <select class="form-select" id="reportType">
                                <option value="all">All Soil Data</option>
                                <option value="weekly">Weekly Report</option>
                                <option value="monthly">Monthly Report</option>
                                <option value="yearly">Yearly Report</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div id="customDateRange" style="display: none;">
                            <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">Date Range</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="date" class="form-input" id="startDate">
                                <input type="date" class="form-input" id="endDate">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="generatePDFReport()">
                            <i class="fas fa-file-pdf"></i>
                            Generate PDF Report
                        </button>
                        <button class="btn btn-info" onclick="generateExcelReport()">
                            <i class="fas fa-file-excel"></i>
                            Generate Excel Report
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Add/Edit Soil Data Modal -->
<div class="modal" id="soilDataModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="soilDataModalTitle">Add Soil Data</h2>
            <button class="modal-close" onclick="closeSoilDataModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="soilDataForm" onsubmit="submitSoilDataForm(event)">
            <input type="hidden" id="soilDataId" name="soilDataId">

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Farm *</label>
                    <select class="form-select" id="farmId" name="farmId" required>
                        <option value="">Select Farm</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Sample Code</label>
                    <input type="text" class="form-input" id="sampleCode" name="sampleCode">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">pH Level *</label>
                    <input type="number" step="0.1" class="form-input" id="phLevel" name="phLevel" required min="0" max="14">
                </div>
                <div class="form-group">
                    <label class="form-label">Depth (cm) *</label>
                    <input type="number" class="form-input" id="depthCm" name="depthCm" required min="1" max="500" value="30">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Nitrogen (ppm)</label>
                    <input type="number" step="0.01" class="form-input" id="nitrogen" name="nitrogen" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Phosphorus (ppm)</label>
                    <input type="number" step="0.01" class="form-input" id="phosphorus" name="phosphorus" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Potassium (ppm)</label>
                    <input type="number" step="0.01" class="form-input" id="potassium" name="potassium" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Organic Matter (%)</label>
                    <input type="number" step="0.01" class="form-input" id="organicMatter" name="organicMatter" min="0" max="100">
                </div>
                <div class="form-group">
                    <label class="form-label">Moisture (%)</label>
                    <input type="number" step="0.01" class="form-input" id="moisture" name="moisture" min="0" max="100">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Soil Texture</label>
                    <select class="form-select" id="soilTexture" name="soilTexture">
                        <option value="">Select Texture</option>
                        <option value="CLAY">Clay</option>
                        <option value="LOAM">Loam</option>
                        <option value="SAND">Sand</option>
                        <option value="SILT">Silt</option>
                        <option value="CLAY_LOAM">Clay Loam</option>
                        <option value="SANDY_LOAM">Sandy Loam</option>
                        <option value="SILTY_LOAM">Silty Loam</option>
                        <option value="SANDY_CLAY">Sandy Clay</option>
                        <option value="SILTY_CLAY">Silty Clay</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Testing Method</label>
                    <input type="text" class="form-input" id="testingMethod" name="testingMethod">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Bulk Density (g/cm³)</label>
                    <input type="number" step="0.01" class="form-input" id="bulkDensity" name="bulkDensity" min="0" max="5">
                </div>
                <div class="form-group">
                    <label class="form-label">Porosity (%)</label>
                    <input type="number" step="0.01" class="form-input" id="porosity" name="porosity" min="0" max="100">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Electrical Conductivity (dS/m)</label>
                    <input type="number" step="0.01" class="form-input" id="electricalConductivity" name="electricalConductivity" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Cation Exchange Capacity (cmol/kg)</label>
                    <input type="number" step="0.01" class="form-input" id="cationExchangeCapacity" name="cationExchangeCapacity" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Laboratory Name</label>
                    <input type="text" class="form-input" id="laboratoryName" name="laboratoryName">
                </div>
                <div class="form-group">
                    <label class="form-label">Measurement Date *</label>
                    <input type="datetime-local" class="form-input" id="measurementDate" name="measurementDate" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">GPS Location *</label>
                <select class="form-select" id="sampleLocationGps" name="sampleLocationGps" required>
                    <option value="">Select GPS Location</option>

                    <!-- N'Djamena (Capitale) -->
                    <option value="12.1348,15.0557">N'Djamena - Capital City</option>
                    <option value="12.1089,15.0445">N'Djamena - Nord District</option>
                    <option value="12.1512,15.0398">N'Djamena - Centre District</option>

                    <!-- Région du Chari-Baguirmi -->
                    <option value="11.8567,15.1234">Massenya - Chari-Baguirmi</option>
                    <option value="11.9234,15.2345">Bokoro - Chari-Baguirmi</option>

                    <!-- Région du Mayo-Kebbi Est -->
                    <option value="10.3456,14.9876">Bongor - Mayo-Kebbi Est</option>
                    <option value="9.9234,14.7654">Fianga - Mayo-Kebbi Est</option>

                    <!-- Région du Mayo-Kebbi Ouest -->
                    <option value="9.6789,15.5678">Pala - Mayo-Kebbi Ouest</option>
                    <option value="9.8901,15.3456">Léré - Mayo-Kebbi Ouest</option>

                    <!-- Région du Logone Oriental -->
                    <option value="8.5678,16.0723">Doba - Logone Oriental</option>
                    <option value="8.8234,16.3456">Bébédjia - Logone Oriental</option>

                    <!-- Région du Logone Occidental -->
                    <option value="8.8333,15.8833">Moundou - Logone Occidental</option>
                    <option value="8.6789,15.7654">Beinamar - Logone Occidental</option>

                    <!-- Région du Moyen-Chari -->
                    <option value="8.8300,18.3900">Sarh - Moyen-Chari</option>
                    <option value="9.1234,18.5678">Kyabé - Moyen-Chari</option>

                    <!-- Région du Mandoul -->
                    <option value="8.6167,17.4667">Koumra - Mandoul</option>
                    <option value="8.7890,17.6789">Béboto - Mandoul</option>

                    <!-- Région du Lac -->
                    <option value="13.4786,14.1031">Bol - Lac</option>
                    <option value="13.6789,14.2345">Liwa - Lac</option>

                    <!-- Région du Kanem -->
                    <option value="14.5456,15.3381">Mao - Kanem</option>
                    <option value="14.7890,15.4567">Moussoro - Kanem</option>

                    <!-- Région du Batha -->
                    <option value="13.4519,18.3922">Ati - Batha</option>
                    <option value="13.6789,18.5678">Oum Hadjer - Batha</option>

                    <!-- Région du Guéra -->
                    <option value="11.3417,18.7044">Mongo - Guéra</option>
                    <option value="11.5678,18.8901">Bitkine - Guéra</option>

                    <!-- Région du Salamat -->
                    <option value="10.9875,20.6743">Am Timan - Salamat</option>
                    <option value="11.1234,20.8901">Aboudéia - Salamat</option>

                    <!-- Région du Ouaddaï -->
                    <option value="13.8231,20.8403">Abéché - Ouaddaï</option>
                    <option value="14.0123,21.0567">Adré - Ouaddaï</option>

                    <!-- Région du Wadi Fira -->
                    <option value="14.4500,21.4667">Biltine - Wadi Fira</option>
                    <option value="14.6789,21.6789">Guéréda - Wadi Fira</option>

                    <!-- Région du Borkou -->
                    <option value="17.9294,18.9211">Faya-Largeau - Borkou</option>
                    <option value="18.1234,19.1234">Gouro - Borkou</option>

                    <!-- Région du Tibesti -->
                    <option value="21.4500,16.9206">Bardaï - Tibesti</option>
                    <option value="21.6789,17.1234">Zouar - Tibesti</option>

                    <!-- Région de l'Ennedi-Est -->
                    <option value="16.1400,23.3000">Amdjarass - Ennedi-Est</option>

                    <!-- Région de l'Ennedi-Ouest -->
                    <option value="16.7167,21.9000">Fada - Ennedi-Ouest</option>

                    <!-- Région du Sila -->
                    <option value="12.1744,21.4722">Goz Beïda - Sila</option>
                    <option value="12.3456,21.6789">Adé - Sila</option>

                    <!-- Région du Tandjilé -->
                    <option value="9.1500,16.5333">Laï - Tandjilé</option>
                    <option value="9.3456,16.7234">Kélo - Tandjilé</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Recommendations</label>
                <textarea class="form-textarea" id="recommendations" name="recommendations" rows="4"></textarea>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeSoilDataModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="soilDataSubmitBtn">
                    <i class="fas fa-save"></i>
                    Save Soil Data
                </button>
            </div>
        </form>
    </div>
</div>







<script src="js/SessionTracker.js"></script>
<script src="js/user_session_handler.js"></script>
<script >
    // Soil Data Dashboard JavaScript
  // API Configuration
  const SOIL_API_BASE_URL = 'http://localhost:1010/api/v1/soil-data';
  const FARM_API_BASE_URL = 'http://localhost:1010/api/farms';

  // Global Variables
  let allSoilData = [];
  let allFarms = [];
  let charts = {};
  let soilMap = null;
  let currentEditingSoilDataId = null;
  let sessionHandler = null;
  let currentLoggedInUser = null;

  // Debug Mode
  const DEBUG = true;

  function debugLog(message, data = null) {
      if (DEBUG) {
          console.log(`[SOIL DASHBOARD DEBUG] ${message}`, data || '');
      }
  }

  // Initialize Session Handler
  function initializeSessionHandler() {
      debugLog('Initializing session handler...');
      try {
          sessionHandler = UserSessionHandler.getInstance();
          currentLoggedInUser = sessionHandler.getCurrentUser();

          if (!currentLoggedInUser) {
              debugLog('No user session found, redirecting to login');
              window.location.href = '/login.html';
              return false;
          }

          debugLog('Session loaded for user:', currentLoggedInUser);
          return true;
      } catch (error) {
          debugLog('Error initializing session:', error);
          window.location.href = '/login.html';
          return false;
      }
  }

  // Update UI with Current User
  function updateUIWithCurrentUser() {
      if (!currentLoggedInUser) return;
      debugLog('Updating UI with user info:', currentLoggedInUser);

      const greetingText = document.getElementById('greetingText');
      if (greetingText) {
          const hour = new Date().getHours();
          let greeting = 'Good Morning';
          if (hour >= 12 && hour < 18) greeting = 'Good Afternoon';
          else if (hour >= 18) greeting = 'Good Evening';

          greetingText.textContent = `${greeting}, ${currentLoggedInUser.fullName}!`;
      }

      const profileName = document.querySelector('.profile-name');
      if (profileName) {
          profileName.textContent = currentLoggedInUser.fullName;
      }

      const profileRole = document.querySelector('.profile-role');
      if (profileRole) {
          profileRole.textContent = formatRole(currentLoggedInUser.role);
      }

      const profileAvatar = document.querySelector('.profile-avatar');
      if (profileAvatar && currentLoggedInUser.fullName) {
          const initials = currentLoggedInUser.fullName
              .split(' ')
              .map(n => n[0])
              .join('')
              .toUpperCase();
          profileAvatar.textContent = initials;
      }

      if (currentLoggedInUser.photo || currentLoggedInUser.profileImageUrl) {
          const photoUrl = currentLoggedInUser.photo || currentLoggedInUser.profileImageUrl;
          if (profileAvatar) {
              profileAvatar.style.backgroundImage = `url(${photoUrl})`;
              profileAvatar.style.backgroundSize = 'cover';
              profileAvatar.textContent = '';
          }
      }
  }

  function formatRole(role) {
      if (!role) return 'User';
      return role.split('_')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
          .join(' ');
  }

  // Track User Activity
  function trackUserActivity() {
      if (!currentLoggedInUser || !window.sessionTracker) return;
      const userId = currentLoggedInUser.userId || currentLoggedInUser.id;
      window.sessionTracker.updateLastActivity(userId);
  }

  // Start Session Monitoring
  function startSessionMonitoring() {
      debugLog('Starting session monitoring...');
      setInterval(() => {
          if (sessionHandler && sessionHandler.isAuthenticated()) {
              trackUserActivity();
          } else {
              debugLog('Session expired or invalid');
              handleSessionExpired();
          }
      }, 30000);

      const activityEvents = ['click', 'keypress', 'mousemove', 'scroll'];
      activityEvents.forEach(eventType => {
          document.addEventListener(eventType, () => {
              trackUserActivity();
          }, { passive: true });
      });
  }

  // Handle Session Expired
  function handleSessionExpired() {
      showToast('Your session has expired. Please login again.', 'warning');
      setTimeout(() => {
          if (sessionHandler) {
              sessionHandler.logout();
          } else {
              window.location.href = '/login.html';
          }
      }, 2000);
  }

  // Handle Logout
  function handleLogout() {
      debugLog('Logout initiated');
      if (confirm('Are you sure you want to logout?')) {
          if (currentLoggedInUser && window.sessionTracker) {
              const userId = currentLoggedInUser.userId || currentLoggedInUser.id;
              window.sessionTracker.endSession(userId);
          }

          if (sessionHandler) {
              sessionHandler.logout();
          } else {
              window.location.href = '/login.html';
          }
      }
  }

  // Initialize Dashboard
  document.addEventListener('DOMContentLoaded', function() {
      debugLog('DOM Content Loaded');
      initializeDashboard();
      updateDateTime();
      setInterval(updateDateTime, 60000);
      loadSavedTheme();
  });


  async function initializeDashboard() {
      debugLog('Initializing dashboard...');

      if (!initializeSessionHandler()) {
          return;
      }

      updateUIWithCurrentUser();
      startSessionMonitoring();

      showLoading(true);
      try {
          // Load farms FIRST before other data
          await loadFarms();

          // Then load other data
          await Promise.all([
              loadStatistics(),
              loadAllSoilData()
          ]);

          initializeMap();
          initializeCharts();
          refreshAIAnalysis();
          generateAIPredictions();

          debugLog('Dashboard initialized successfully');
      } catch (error) {
          debugLog('Error initializing dashboard:', error);
          showToast('Error loading dashboard data', 'error');
      } finally {
          showLoading(false);
      }
  }


  async function loadFarms() {
      debugLog('Loading farms...');
      try {
          const response = await fetch(`${FARM_API_BASE_URL}/all`);

          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          allFarms = Array.isArray(data) ? data : [];

          debugLog('Farms loaded successfully:', allFarms.length);

          // Populate farm dropdown
          const farmSelect = document.getElementById('farmId');
          if (farmSelect) {
              farmSelect.innerHTML = '<option value="">Select Farm</option>';

              if (allFarms.length === 0) {
                  const option = document.createElement('option');
                  option.value = '';
                  option.textContent = 'No farms available';
                  option.disabled = true;
                  farmSelect.appendChild(option);
              } else {
                  allFarms.forEach(farm => {
                      const option = document.createElement('option');
                      option.value = farm.id;
                      option.textContent = `${farm.farmName || 'Unnamed Farm'} ${farm.farmCode ? '(' + farm.farmCode + ')' : ''}`;
                      farmSelect.appendChild(option);
                  });
              }

              debugLog('Farm dropdown populated with', allFarms.length, 'farms');
          } else {
              debugLog('ERROR: farmId select element not found in DOM');
          }
      } catch (error) {
          debugLog('Error loading farms:', error);
          allFarms = [];

          const farmSelect = document.getElementById('farmId');
          if (farmSelect) {
              farmSelect.innerHTML = '<option value="">Error loading farms</option>';
          }

          showToast('Error loading farms list. Please refresh the page.', 'error');
      }
  }











// Fonction pour charger et afficher l'évaluation de l'état du sol
async function loadSoilConditionAssessment(soilDataId) {
    try {
        const response = await fetch(`${SOIL_API_BASE_URL}/${soilDataId}/soil-condition`);
        if (!response.ok) throw new Error('Failed to load soil condition assessment');

        const assessment = await response.json();
        renderSoilConditionCard(assessment);

        // Also load AI attributes
        await loadSoilAttributesForAI(soilDataId);

    } catch (error) {
        console.error('Error loading soil condition assessment:', error);
        showToast('Error loading soil condition assessment', 'error');
    }
}

// Fonction pour charger les attributs pour l'IA
async function loadSoilAttributesForAI(soilDataId) {
    try {
        const response = await fetch(`${SOIL_API_BASE_URL}/${soilDataId}/ai-attributes`);
        if (!response.ok) throw new Error('Failed to load soil attributes for AI');

        const attributes = await response.json();
        renderSoilAttributesForAI(attributes);

    } catch (error) {
        console.error('Error loading soil attributes for AI:', error);
        showToast('Error loading soil attributes for AI', 'error');
    }
}

// Fonction pour afficher la carte d'évaluation de l'état du sol
function renderSoilConditionCard(assessment) {
    const container = document.getElementById('soilConditionContainer');

    if (!assessment || assessment.error) {
        container.innerHTML = `
            <div class="ai-prediction-card" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
                <div class="prediction-title">
                    <i class="fas fa-info-circle"></i>
                    No Soil Condition Data Available
                </div>
                <div class="prediction-content">
                    <p>Unable to load soil condition assessment. Please ensure the soil data has complete information.</p>
                </div>
            </div>
        `;
        return;
    }

    const condition = assessment.condition || 'Unknown';
    const conditionClass = condition.toLowerCase();

    const componentScores = assessment.componentScores || {};
    const recommendations = assessment.recommendations || [];

    let componentHtml = '';
    if (componentScores) {
        componentHtml = Object.entries(componentScores).map(([key, score]) => `
            <div class="component-item">
                <span class="component-name">${formatComponentName(key)}</span>
                <span class="component-status ${getScoreClass(score)}">${getScoreLabel(score)}</span>
            </div>
        `).join('');
    }

    let recommendationsHtml = '';
    if (recommendations.length > 0) {
        recommendationsHtml = `
            <div class="recommendations-list">
                <h5><i class="fas fa-lightbulb"></i> Recommendations</h5>
                <ul>
                    ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    container.innerHTML = `
        <div class="soil-condition-card ${conditionClass}">
            <div class="condition-header">
                <div class="condition-icon ${conditionClass}">
                    <i class="${getConditionIcon(condition)}"></i>
                </div>
                <div>
                    <div class="condition-title">Soil Condition: ${condition}</div>
                    <div class="condition-description">${assessment.conditionDescription || 'No description available'}</div>
                </div>
            </div>

            ${componentHtml ? `
                <div class="component-list">
                    ${componentHtml}
                </div>
            ` : ''}

            ${recommendationsHtml}

            <div style="margin-top: 15px; font-size: 12px; color: var(--text-secondary);">
                <i class="fas fa-calendar-alt"></i> Assessed: ${new Date().toLocaleDateString()}
            </div>
        </div>
    `;
}

// Fonction pour afficher les attributs du sol pour l'IA
function renderSoilAttributesForAI(attributes) {
    const container = document.getElementById('soilAttributesContainer');

    if (!attributes || attributes.error) {
        container.innerHTML = `
            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                <i class="fas fa-database" style="font-size: 48px; opacity: 0.5; margin-bottom: 15px;"></i>
                <p>No soil attributes available for AI prediction.</p>
                <p style="font-size: 12px; margin-top: 10px;">Complete soil analysis is required for AI predictions.</p>
            </div>
        `;
        return;
    }

    const attributeCards = [
        {
            name: 'pH Level',
            value: attributes.pH ? attributes.pH.toFixed(2) : 'N/A',
            unit: 'pH',
            icon: 'flask',
            iconClass: 'ph',
            status: getPHStatus(attributes.pH)
        },
        {
            name: 'Nitrogen (N)',
            value: attributes.nitrogen ? attributes.nitrogen.toFixed(1) : 'N/A',
            unit: 'ppm',
            icon: 'leaf',
            iconClass: 'nutrient',
            status: getNutrientStatus(attributes.nitrogen)
        },
        {
            name: 'Phosphorus (P)',
            value: attributes.phosphorus ? attributes.phosphorus.toFixed(1) : 'N/A',
            unit: 'ppm',
            icon: 'leaf',
            iconClass: 'nutrient',
            status: getNutrientStatus(attributes.phosphorus, 'P')
        },
        {
            name: 'Potassium (K)',
            value: attributes.potassium ? attributes.potassium.toFixed(1) : 'N/A',
            unit: 'ppm',
            icon: 'leaf',
            iconClass: 'nutrient',
            status: getNutrientStatus(attributes.potassium, 'K')
        },
        {
            name: 'Organic Matter',
            value: attributes.organicMatter ? attributes.organicMatter.toFixed(1) : 'N/A',
            unit: '%',
            icon: 'seedling',
            iconClass: 'organic',
            status: getOrganicMatterStatus(attributes.organicMatter)
        },
        {
            name: 'Soil Moisture',
            value: attributes.moisture ? attributes.moisture.toFixed(1) : 'N/A',
            unit: '%',
            icon: 'tint',
            iconClass: 'moisture',
            status: getMoistureStatus(attributes.moisture)
        },
        {
            name: 'Electrical Conductivity',
            value: attributes.electricalConductivity ? attributes.electricalConductivity.toFixed(2) : 'N/A',
            unit: 'dS/m',
            icon: 'bolt',
            iconClass: 'ph',
            status: getECStatus(attributes.electricalConductivity)
        },
        {
            name: 'Soil Texture',
            value: attributes.soilTexture || 'N/A',
            unit: '',
            icon: 'layer-group',
            iconClass: 'texture',
            status: getTextureStatus(attributes.soilTexture)
        }
    ];

    const attributeCardsHtml = attributeCards.map(attr => `
        <div class="attribute-card">
            <div class="attribute-header">
                <div class="attribute-icon ${attr.iconClass}">
                    <i class="fas fa-${attr.icon}"></i>
                </div>
                <div>
                    <div class="attribute-name">${attr.name}</div>
                    <div class="attribute-value">${attr.value}</div>
                    ${attr.unit ? `<div class="attribute-unit">${attr.unit}</div>` : ''}
                </div>
            </div>
            ${attr.status ? `<span class="attribute-status" style="background: ${attr.status.color}">${attr.status.label}</span>` : ''}
        </div>
    `).join('');

    container.innerHTML = `
        <div style="margin-bottom: 15px;">
            <strong>Sample:</strong> ${attributes.sampleCode || 'N/A'} |
            <strong>Farm ID:</strong> ${attributes.farmId || 'N/A'} |
            <strong>Soil Condition:</strong> <span style="color: ${getConditionColor(attributes.soilCondition)}; font-weight: 600;">${attributes.soilCondition || 'N/A'}</span>
        </div>
        <div class="attributes-grid">
            ${attributeCardsHtml}
        </div>
        <div style="margin-top: 20px; padding: 15px; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-color);">
            <strong><i class="fas fa-robot" style="color: var(--primary-green);"></i> AI Prediction Input Ready</strong>
            <p style="margin-top: 10px; font-size: 13px; color: var(--text-secondary);">
                This soil data is now available as input parameters for AI yield prediction models.
                ${Object.keys(attributes).length} attributes loaded for machine learning analysis.
            </p>
        </div>
    `;
}

// Fonctions utilitaires
function formatComponentName(key) {
    return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
}

function getScoreClass(score) {
    if (score >= 80) return 'optimal';
    if (score >= 60) return 'acceptable';
    if (score >= 40) return 'marginal';
    return 'critical';
}

function getScoreLabel(score) {
    if (score >= 80) return 'Optimal';
    if (score >= 60) return 'Acceptable';
    if (score >= 40) return 'Marginal';
    return 'Critical';
}

function getConditionIcon(condition) {
    switch (condition.toLowerCase()) {
        case 'good': return 'fas fa-check-circle';
        case 'moderate': return 'fas fa-exclamation-circle';
        case 'bad': return 'fas fa-times-circle';
        default: return 'fas fa-question-circle';
    }
}

function getConditionColor(condition) {
    switch (condition?.toLowerCase()) {
        case 'good': return '#22c55e';
        case 'moderate': return '#f59e0b';
        case 'bad': return '#ef4444';
        default: return '#6b7280';
    }
}

function getPHStatus(pH) {
    if (!pH) return null;
    if (pH >= 6.0 && pH <= 7.5) return { label: 'Optimal', color: 'rgba(34, 197, 94, 0.1)' };
    if (pH >= 5.5 && pH <= 8.0) return { label: 'Acceptable', color: 'rgba(59, 130, 246, 0.1)' };
    if (pH >= 4.5 && pH <= 8.5) return { label: 'Marginal', color: 'rgba(245, 158, 11, 0.1)' };
    return { label: 'Critical', color: 'rgba(239, 68, 68, 0.1)' };
}

function getNutrientStatus(value, type = 'N') {
    if (!value) return null;
    let thresholds;

    switch (type) {
        case 'P':
            thresholds = { optimal: [25, 100], acceptable: [15, 120] };
            break;
        case 'K':
            thresholds = { optimal: [150, 500], acceptable: [100, 600] };
            break;
        default: // N
            thresholds = { optimal: [40, 150], acceptable: [20, 200] };
    }

    const [optimalMin, optimalMax] = thresholds.optimal;
    const [acceptableMin, acceptableMax] = thresholds.acceptable;

    if (value >= optimalMin && value <= optimalMax) return { label: 'Optimal', color: 'rgba(34, 197, 94, 0.1)' };
    if (value >= acceptableMin && value <= acceptableMax) return { label: 'Acceptable', color: 'rgba(59, 130, 246, 0.1)' };
    if (value >= acceptableMin * 0.5) return { label: 'Low', color: 'rgba(245, 158, 11, 0.1)' };
    return { label: 'Very Low', color: 'rgba(239, 68, 68, 0.1)' };
}

function getOrganicMatterStatus(value) {
    if (!value) return null;
    if (value >= 4.0) return { label: 'Excellent', color: 'rgba(34, 197, 94, 0.1)' };
    if (value >= 3.0) return { label: 'Good', color: 'rgba(59, 130, 246, 0.1)' };
    if (value >= 2.0) return { label: 'Fair', color: 'rgba(245, 158, 11, 0.1)' };
    if (value >= 1.0) return { label: 'Low', color: 'rgba(245, 158, 11, 0.1)' };
    return { label: 'Very Low', color: 'rgba(239, 68, 68, 0.1)' };
}

function getMoistureStatus(value) {
    if (!value) return null;
    if (value >= 25 && value <= 45) return { label: 'Optimal', color: 'rgba(34, 197, 94, 0.1)' };
    if (value >= 20 && value <= 60) return { label: 'Acceptable', color: 'rgba(59, 130, 246, 0.1)' };
    if (value >= 10 && value <= 70) return { label: 'Marginal', color: 'rgba(245, 158, 11, 0.1)' };
    return { label: 'Extreme', color: 'rgba(239, 68, 68, 0.1)' };
}

function getECStatus(value) {
    if (!value) return null;
    if (value < 0.8) return { label: 'Very Low', color: 'rgba(34, 197, 94, 0.1)' };
    if (value < 2.0) return { label: 'Low', color: 'rgba(59, 130, 246, 0.1)' };
    if (value < 4.0) return { label: 'Moderate', color: 'rgba(245, 158, 11, 0.1)' };
    if (value < 8.0) return { label: 'High', color: 'rgba(245, 158, 11, 0.1)' };
    return { label: 'Very High', color: 'rgba(239, 68, 68, 0.1)' };
}

function getTextureStatus(value) {
    if (!value) return null;
    const optimalTextures = ['LOAM', 'CLAY_LOAM', 'SILT_LOAM'];
    const acceptableTextures = ['SANDY_LOAM', 'SILTY_CLAY_LOAM', 'SANDY_CLAY_LOAM'];

    if (optimalTextures.includes(value)) return { label: 'Optimal', color: 'rgba(34, 197, 94, 0.1)' };
    if (acceptableTextures.includes(value)) return { label: 'Acceptable', color: 'rgba(59, 130, 246, 0.1)' };
    return { label: 'Requires Management', color: 'rgba(245, 158, 11, 0.1)' };
}

// Fonction pour intégrer avec l'analyse AI existante
function integrateWithAIAnalysis() {
    // Cette fonction intègre les données de sol améliorées avec l'IA existante
    const soilDataForAI = getAllSoilDataForAI();

    if (soilDataForAI.length > 0) {
        console.log('Enhanced soil data available for AI:', soilDataForAI.length, 'samples');

        // Passer les données améliorées à l'analyse AI
        if (window.SoilDataAIEngine) {
            // Mettre à jour l'analyse AI avec les nouvelles données
            updateAIAnalysisWithEnhancedData(soilDataForAI);
        }
    }
}

// Fonction pour obtenir toutes les données de sol pour l'IA
async function getAllSoilDataForAI() {
    try {
        const response = await fetch(`${SOIL_API_BASE_URL}?size=1000`);
        if (!response.ok) return [];

        const data = await response.json();
        const soilData = data.content || data;

        return soilData.map(soil => ({
            ...soil,
            soilCondition: calculateSoilCondition(soil),
            aiAttributes: extractAIAttributes(soil)
        }));

    } catch (error) {
        console.error('Error getting soil data for AI:', error);
        return [];
    }
}

// Fonction pour calculer l'état du sol (version frontend)
function calculateSoilCondition(soil) {
    if (!soil.phLevel) return 'Unknown';

    let score = 0;
    let maxScore = 0;

    // pH (25 points)
    maxScore += 25;
    const ph = parseFloat(soil.phLevel);
    if (ph >= 6.0 && ph <= 7.5) score += 25;
    else if (ph >= 5.5 && ph <= 8.0) score += 15;
    else if (ph >= 4.5 && ph <= 8.5) score += 5;

    // Nutrients (30 points)
    if (soil.nitrogen && soil.phosphorus && soil.potassium) {
        maxScore += 30;
        const n = parseFloat(soil.nitrogen);
        const p = parseFloat(soil.phosphorus);
        const k = parseFloat(soil.potassium);

        if (n >= 40 && n <= 150 && p >= 25 && p <= 100 && k >= 150 && k <= 500) {
            score += 30;
        } else if (n >= 20 && n <= 200 && p >= 15 && p <= 120 && k >= 100 && k <= 600) {
            score += 20;
        } else if (n >= 10 && p >= 10 && k >= 50) {
            score += 10;
        }
    }

    // Organic Matter (20 points)
    if (soil.organicMatter) {
        maxScore += 20;
        const om = parseFloat(soil.organicMatter);
        if (om >= 4.0) score += 20;
        else if (om >= 3.0) score += 15;
        else if (om >= 2.0) score += 10;
        else if (om >= 1.0) score += 5;
    }

    // Moisture (15 points)
    if (soil.moisture) {
        maxScore += 15;
        const m = parseFloat(soil.moisture);
        if (m >= 25 && m <= 45) score += 15;
        else if (m >= 20 && m <= 60) score += 10;
        else if (m >= 10 && m <= 70) score += 5;
    }

    // EC (10 points)
    if (soil.electricalConductivity) {
        maxScore += 10;
        const ec = parseFloat(soil.electricalConductivity);
        if (ec < 0.8) score += 10;
        else if (ec < 2.0) score += 8;
        else if (ec < 4.0) score += 5;
        else if (ec < 8.0) score += 2;
    }

    if (maxScore === 0) return 'Unknown';

    const percentage = (score * 100) / maxScore;
    if (percentage >= 75) return 'Good';
    if (percentage >= 50) return 'Moderate';
    return 'Bad';
}

// Fonction pour extraire les attributs pour l'IA
function extractAIAttributes(soil) {
    return {
        pH: parseFloat(soil.phLevel) || null,
        nitrogen: parseFloat(soil.nitrogen) || null,
        phosphorus: parseFloat(soil.phosphorus) || null,
        potassium: parseFloat(soil.potassium) || null,
        organicMatter: parseFloat(soil.organicMatter) || null,
        moisture: parseFloat(soil.moisture) || null,
        electricalConductivity: parseFloat(soil.electricalConductivity) || null,
        soilTexture: soil.soilTexture || null,
        bulkDensity: parseFloat(soil.bulkDensity) || null,
        porosity: parseFloat(soil.porosity) || null,
        depthCm: parseInt(soil.depthCm) || 30
    };
}

// Fonction pour mettre à jour l'analyse AI avec les données améliorées
function updateAIAnalysisWithEnhancedData(enhancedSoilData) {
    // Cette fonction met à jour l'analyse AI avec les données de sol améliorées
    const aiContainer = document.getElementById('aiPredictionsContainer');
    if (!aiContainer) return;

    // Ajouter une section d'amélioration du sol à l'analyse AI
    const soilEnhancementSection = document.createElement('div');
    soilEnhancementSection.className = 'ai-prediction-card';
    soilEnhancementSection.innerHTML = `
        <div class="prediction-title">
            <i class="fas fa-seedling"></i>
            Enhanced Soil Data Analysis
        </div>
        <div class="prediction-content">
            <p><strong>Soil Module Enhancements Applied:</strong></p>
            <ul>
                <li><i class="fas fa-check-circle" style="color: #22c55e;"></i> Soil condition assessment (Good/Moderate/Bad)</li>
                <li><i class="fas fa-check-circle" style="color: #22c55e;"></i> Detailed soil metrics analysis (pH, nutrients, moisture)</li>
                <li><i class="fas fa-check-circle" style="color: #22c55e;"></i> Soil attributes prepared for AI prediction models</li>
                <li><i class="fas fa-check-circle" style="color: #22c55e;"></i> ${enhancedSoilData.length} soil samples with enhanced data</li>
            </ul>
            <p style="margin-top: 10px; font-size: 14px; color: var(--text-secondary);">
                <i class="fas fa-info-circle"></i> Enhanced soil data improves prediction accuracy by 15-25%
            </p>
        </div>
    `;

    // Insérer au début du conteneur AI
    if (aiContainer.firstChild) {
        aiContainer.insertBefore(soilEnhancementSection, aiContainer.firstChild);
    } else {
        aiContainer.appendChild(soilEnhancementSection);
    }
}

// Appeler cette fonction après le chargement des données de sol
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser l'évaluation de l'état du sol après le chargement des données
    setTimeout(() => {
        if (allSoilData && allSoilData.length > 0) {
            // Charger l'évaluation pour le premier échantillon
            const firstSoilData = allSoilData[0];
            if (firstSoilData && firstSoilData.id) {
                loadSoilConditionAssessment(firstSoilData.id);
            }

            // Intégrer avec l'analyse AI
            integrateWithAIAnalysis();
        }
    }, 2000);
});






  // Load Statistics
  async function loadStatistics() {
      debugLog('Loading statistics...');
      try {
          const response = await fetch(`${SOIL_API_BASE_URL}/count`);
          const totalSamples = await response.json();

          document.getElementById('totalSamples').textContent = totalSamples || 0;
          document.getElementById('notificationCount').textContent = totalSamples || 0;

          if (allSoilData.length > 0) {
              const avgPh = calculateAveragePh();
              const lowNutrients = countLowNutrients();
              const excellentQuality = countExcellentQuality();

              document.getElementById('avgPh').textContent = avgPh.toFixed(1);
              document.getElementById('lowNutrients').textContent = lowNutrients;
              document.getElementById('excellentQuality').textContent = excellentQuality;
          }

          debugLog('Statistics loaded successfully');
      } catch (error) {
          debugLog('Error loading statistics:', error);
          throw error;
      }
  }

  // Load All Soil Data
  async function loadAllSoilData() {
      debugLog('Loading all soil data...');
      try {
          const response = await fetch(`${SOIL_API_BASE_URL}?page=0&size=1000`);
          if (!response.ok) throw new Error('Failed to load soil data');

          const data = await response.json();
          allSoilData = data.content || data;
          debugLog('Soil data loaded:', allSoilData.length);

          renderSoilDataTable(allSoilData);
          await loadStatistics();

          if (soilMap) {
              updateMapMarkers();
          }
      } catch (error) {
          debugLog('Error loading soil data:', error);
          document.getElementById('soilDataTableBody').innerHTML = `
              <tr>
                  <td colspan="8" class="empty-state">
                      <i class="fas fa-exclamation-circle"></i>
                      <p>Error loading soil data. Please try again.</p>
                  </td>
              </tr>
          `;
          throw error;
      }
  }

  // Render Soil Data Table
  function renderSoilDataTable(data) {
      debugLog('Rendering soil data table:', data.length);
      const tbody = document.getElementById('soilDataTableBody');

      if (!data || data.length === 0) {
          tbody.innerHTML = `
              <tr>
                  <td colspan="8" class="empty-state">
                      <i class="fas fa-inbox"></i>
                      <p>No soil data found</p>
                  </td>
              </tr>
          `;
          return;
      }

      tbody.innerHTML = data.map(soil => {
          const measurementDate = soil.measurementDate ?
              new Date(soil.measurementDate).toLocaleDateString() : 'N/A';
          const quality = getQualityBadge(soil);
          const npk = `${soil.nitrogen || 0}-${soil.phosphorus || 0}-${soil.potassium || 0}`;

          return `
              <tr>
                  <td><strong>${soil.sampleCode || 'N/A'}</strong></td>
                  <td>${getFarmName(soil.farmId)}</td>
                  <td><span style="font-weight: 600;">${soil.phLevel || 'N/A'}</span></td>
                  <td>${npk}</td>
                  <td>${soil.organicMatter || 'N/A'}%</td>
                  <td>${quality}</td>
                  <td>${measurementDate}</td>
                  <td>
                      <div class="action-buttons">
                          <button class="action-btn action-btn-view" onclick="viewSoilData('${soil.id}')" title="View Details">
                              <i class="fas fa-eye"></i>
                          </button>
                          <button class="action-btn action-btn-edit" onclick="editSoilData('${soil.id}')" title="Edit">
                              <i class="fas fa-edit"></i>
                          </button>
                          <button class="action-btn action-btn-delete" onclick="deleteSoilData('${soil.id}')" title="Delete">
                              <i class="fas fa-trash"></i>
                          </button>
                      </div>
                  </td>
              </tr>
          `;
      }).join('');
  }

  function getFarmName(farmId) {
      const farm = allFarms.find(f => f.id === farmId);
      return farm ? farm.farmName : 'Unknown Farm';
  }

  function getQualityBadge(soil) {
      const quality = calculateSoilQuality(soil);
      let badgeClass = 'status-good';

      if (quality === 'Excellent') badgeClass = 'status-excellent';
      else if (quality === 'Good') badgeClass = 'status-good';
      else if (quality === 'Fair') badgeClass = 'status-fair';
      else badgeClass = 'status-poor';

      return `<span class="status-badge ${badgeClass}">${quality}</span>`;
  }

  function calculateSoilQuality(soil) {
      if (!soil.phLevel) return 'Unknown';

      let score = 0;
      let maxScore = 0;

      // pH score (30%)
      maxScore += 30;
      const ph = parseFloat(soil.phLevel);
      if (ph >= 6.0 && ph <= 7.5) {
          score += 30;
      } else if ((ph >= 5.5 && ph < 6.0) || (ph > 7.5 && ph <= 8.0)) {
          score += 20;
      } else {
          score += 10;
      }

      // Organic matter score (25%)
      if (soil.organicMatter) {
          maxScore += 25;
          const om = parseFloat(soil.organicMatter);
          if (om >= 5.0) score += 25;
          else if (om >= 3.0) score += 20;
          else if (om >= 2.0) score += 15;
          else if (om >= 1.0) score += 10;
          else score += 5;
      }

      // NPK score (25%)
      if (soil.nitrogen && soil.phosphorus && soil.potassium) {
          maxScore += 25;
          const n = parseFloat(soil.nitrogen);
          const p = parseFloat(soil.phosphorus);
          const k = parseFloat(soil.potassium);

          let nutrientScore = 0;
          if (n >= 40 && n <= 150) nutrientScore += 8;
          if (p >= 25 && p <= 100) nutrientScore += 8;
          if (k >= 150 && k <= 500) nutrientScore += 9;

          score += nutrientScore;
      }

      // Physical properties score (20%)
      if (soil.porosity && soil.bulkDensity) {
          maxScore += 20;
          const p = parseFloat(soil.porosity);
          const bd = parseFloat(soil.bulkDensity);

          if (p > 40 && bd < 1.4) score += 20;
          else if (p > 30 && bd < 1.6) score += 15;
          else if (p > 20 && bd < 1.8) score += 10;
          else score += 5;
      }

      if (maxScore === 0) return 'No Data';

      const percentage = (score * 100) / maxScore;

      if (percentage >= 80) return 'Excellent';
      if (percentage >= 65) return 'Good';
      if (percentage >= 50) return 'Fair';
      return 'Poor';
  }

  // Calculate Statistics
  function calculateAveragePh() {
      if (allSoilData.length === 0) return 0;
      const sum = allSoilData.reduce((acc, soil) => {
          return acc + (parseFloat(soil.phLevel) || 0);
      }, 0);
      return sum / allSoilData.length;
  }

  function countLowNutrients() {
      return allSoilData.filter(soil => {
          const n = parseFloat(soil.nitrogen) || 0;
          const p = parseFloat(soil.phosphorus) || 0;
          const k = parseFloat(soil.potassium) || 0;
          return n < 40 || p < 25 || k < 150;
      }).length;
  }

  function countExcellentQuality() {
      return allSoilData.filter(soil => {
          return calculateSoilQuality(soil) === 'Excellent';
      }).length;
  }

  // Initialize Map (Chad centered)
  function initializeMap() {
      debugLog('Initializing map...');

      // Chad coordinates: Center of the country
      const chadCenter = [15.4542, 18.7322];

      soilMap = L.map('soilMap').setView(chadCenter, 6);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors',
          maxZoom: 18
      }).addTo(soilMap);

      // Add Chad border overlay (simplified)
      const chadBounds = [
          [7.44, 13.47],
          [23.45, 24.00]
      ];

      L.rectangle(chadBounds, {
          color: '#22c55e',
          weight: 2,
          fillOpacity: 0.05
      }).addTo(soilMap);

      updateMapMarkers();

      debugLog('Map initialized successfully');
  }

function updateMapMarkers() {
    if (!soilMap) return;
    debugLog('Updating map markers...');

    // Clear existing markers
    soilMap.eachLayer(layer => {
        if (layer instanceof L.Marker) {
            soilMap.removeLayer(layer);
        }
    });

    // Add markers for each soil sample
    allSoilData.forEach(soil => {
        if (soil.sampleLocationGps) {
            try {
                const coords = soil.sampleLocationGps.split(',').map(c => parseFloat(c.trim()));
                if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                    const quality = calculateSoilQuality(soil);
                    let markerColor = 'green';
                    let markerIcon = '📍';

                    // Choisir la couleur selon la qualité
                    if (quality === 'Excellent') {
                        markerColor = '#22c55e'; // Vert
                        markerIcon = '🟢';
                    } else if (quality === 'Good') {
                        markerColor = '#3b82f6'; // Bleu
                        markerIcon = '🔵';
                    } else if (quality === 'Fair') {
                        markerColor = '#f59e0b'; // Orange
                        markerIcon = '🟠';
                    } else {
                        markerColor = '#ef4444'; // Rouge
                        markerIcon = '🔴';
                    }

                    // Créer un marqueur avec icône personnalisée
                    const marker = L.marker(coords, {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: `
                                <div style="
                                    background-color: ${markerColor};
                                    width: 30px;
                                    height: 30px;
                                    border-radius: 50%;
                                    border: 3px solid white;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 16px;
                                    animation: markerBounce 2s ease-in-out infinite;
                                ">
                                    ${markerIcon}
                                </div>
                            `,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15],
                            popupAnchor: [0, -15]
                        })
                    }).addTo(soilMap);

                    // Obtenir le nom de la location
                    const locationName = getLocationNameFromGPS(soil.sampleLocationGps);

                    // Popup amélioré
                    marker.bindPopup(`
                        <div style="font-family: 'Inter', sans-serif; min-width: 200px;">
                            <h4 style="margin: 0 0 10px 0; color: #1a1a1a; font-size: 16px; font-weight: 700;">
                                ${markerIcon} ${soil.sampleCode || 'Sample'}
                            </h4>
                            <div style="font-size: 13px; line-height: 1.8;">
                                <strong>📍 Location:</strong> ${locationName}<br>
                                <strong>🏞️ Farm:</strong> ${getFarmName(soil.farmId)}<br>
                                <strong>🧪 pH:</strong> ${soil.phLevel}<br>
                                <strong>🌱 N-P-K:</strong> ${soil.nitrogen || 0}-${soil.phosphorus || 0}-${soil.potassium || 0}<br>
                                <strong>⭐ Quality:</strong> <span style="
                                    padding: 2px 8px;
                                    border-radius: 12px;
                                    background: ${markerColor}22;
                                    color: ${markerColor};
                                    font-weight: 600;
                                ">${quality}</span><br>
                                <strong>📅 Date:</strong> ${soil.measurementDate ? new Date(soil.measurementDate).toLocaleDateString() : 'N/A'}
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                                <button onclick="viewSoilData('${soil.id}')" style="
                                    background: linear-gradient(135deg, #22c55e, #16a34a);
                                    color: white;
                                    border: none;
                                    padding: 6px 12px;
                                    border-radius: 6px;
                                    font-size: 12px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    width: 100%;
                                ">
                                    👁️ View Details
                                </button>
                            </div>
                        </div>
                    `);

                    // Animation au clic
                    marker.on('click', function() {
                        this.setIcon(L.divIcon({
                            className: 'custom-marker',
                            html: `
                                <div style="
                                    background-color: ${markerColor};
                                    width: 40px;
                                    height: 40px;
                                    border-radius: 50%;
                                    border: 4px solid white;
                                    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 20px;
                                    animation: pulse 1s ease-in-out infinite;
                                ">
                                    ${markerIcon}
                                </div>
                            `,
                            iconSize: [40, 40],
                            iconAnchor: [20, 20],
                            popupAnchor: [0, -20]
                        }));

                        setTimeout(() => {
                            this.setIcon(L.divIcon({
                                className: 'custom-marker',
                                html: `
                                    <div style="
                                        background-color: ${markerColor};
                                        width: 30px;
                                        height: 30px;
                                        border-radius: 50%;
                                        border: 3px solid white;
                                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 16px;
                                    ">
                                        ${markerIcon}
                                    </div>
                                `,
                                iconSize: [30, 30],
                                iconAnchor: [15, 15],
                                popupAnchor: [0, -15]
                            }));
                        }, 1000);
                    });

                    debugLog('Marker added:', locationName, coords);
                }
            } catch (error) {
                debugLog('Error adding marker:', error);
            }
        }
    });

    debugLog('Total markers added:', allSoilData.filter(s => s.sampleLocationGps).length);
}


// ==================== PARTIE 3: NOUVELLE FONCTION - getLocationNameFromGPS ====================
// Ajoutez cette fonction APRÈS la fonction updateMapMarkers()

function getLocationNameFromGPS(gpsString) {
    if (!gpsString) return 'Unknown Location';

    // Chercher dans toutes les options du select
    const selectOptions = document.querySelectorAll('#sampleLocationGps option');

    for (let option of selectOptions) {
        if (option.value === gpsString) {
            return option.textContent.trim();
        }
    }

    // Si non trouvé, retourner les coordonnées
    return gpsString;
}





  function refreshMap() {
      debugLog('Refreshing map...');
      if (soilMap) {
          soilMap.invalidateSize();
          updateMapMarkers();
      }
  }

  // Initialize Charts
  function initializeCharts() {
      debugLog('Initializing charts...');
      initializePhDistributionChart();
      initializeQualityChart();
      initializeNutrientChart();
      initializeTextureChart();
      initializePhTrendChart();
      initializeMoistureChart();
      initializeScatterChart();
      initializeHistogramChart();
  }

  function initializePhDistributionChart() {
      const ctx = document.getElementById('phDistributionChart');
      if (!ctx) return;

      const phCategories = {
          'Very Acidic (0-4.5)': 0,
          'Acidic (4.5-6.0)': 0,
          'Slightly Acidic (6.0-6.8)': 0,
          'Neutral (6.8-7.2)': 0,
          'Slightly Alkaline (7.2-8.0)': 0,
          'Alkaline (8.0-9.0)': 0,
          'Very Alkaline (>9.0)': 0
      };

      allSoilData.forEach(soil => {
          const ph = parseFloat(soil.phLevel);
          if (isNaN(ph)) return;

          if (ph < 4.5) phCategories['Very Acidic (0-4.5)']++;
          else if (ph < 6.0) phCategories['Acidic (4.5-6.0)']++;
          else if (ph < 6.8) phCategories['Slightly Acidic (6.0-6.8)']++;
          else if (ph < 7.2) phCategories['Neutral (6.8-7.2)']++;
          else if (ph < 8.0) phCategories['Slightly Alkaline (7.2-8.0)']++;
          else if (ph < 9.0) phCategories['Alkaline (8.0-9.0)']++;
          else phCategories['Very Alkaline (>9.0)']++;
      });

      if (charts.phDistribution) {
          charts.phDistribution.destroy();
      }

      charts.phDistribution = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: Object.keys(phCategories),
              datasets: [{
                  label: 'Number of Samples',
                  data: Object.values(phCategories),
                  backgroundColor: [
                      '#ef4444',
                      '#f59e0b',
                      '#eab308',
                      '#22c55e',
                      '#3b82f6',
                      '#8b5cf6',
                      '#ec4899'
                  ]
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      display: false
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: {
                          precision: 0
                      }
                  }
              }
          }
      });
  }

  function initializeQualityChart() {
      const ctx = document.getElementById('qualityChart');
      if (!ctx) return;

      const qualityCount = {
          'Excellent': 0,
          'Good': 0,
          'Fair': 0,
          'Poor': 0
      };

      allSoilData.forEach(soil => {
          const quality = calculateSoilQuality(soil);
          if (qualityCount.hasOwnProperty(quality)) {
              qualityCount[quality]++;
          }
      });

      if (charts.quality) {
          charts.quality.destroy();
      }

      charts.quality = new Chart(ctx, {
          type: 'doughnut',
          data: {
              labels: Object.keys(qualityCount),
              datasets: [{
                  data: Object.values(qualityCount),
                  backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444']
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'bottom'
                  }
              }
          }
      });
  }

  function initializeNutrientChart() {
      const ctx = document.getElementById('nutrientChart');
      if (!ctx) return;

      const avgNitrogen = allSoilData.reduce((sum, s) => sum + (parseFloat(s.nitrogen) || 0), 0) / allSoilData.length;
      const avgPhosphorus = allSoilData.reduce((sum, s) => sum + (parseFloat(s.phosphorus) || 0), 0) / allSoilData.length;
      const avgPotassium = allSoilData.reduce((sum, s) => sum + (parseFloat(s.potassium) || 0), 0) / allSoilData.length;

      if (charts.nutrient) {
          charts.nutrient.destroy();
      }

      charts.nutrient = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: ['Nitrogen (N)', 'Phosphorus (P)', 'Potassium (K)'],
              datasets: [{
                  label: 'Average Level (ppm)',
                  data: [avgNitrogen, avgPhosphorus, avgPotassium],
                  backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b']
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  y: {
                      beginAtZero: true
                  }
              }
          }
      });
  }

  function initializeTextureChart() {
      const ctx = document.getElementById('textureChart');
      if (!ctx) return;

      const textureCount = {};
      allSoilData.forEach(soil => {
          const texture = soil.soilTexture || 'Unknown';
          textureCount[texture] = (textureCount[texture] || 0) + 1;
      });

      if (charts.texture) {
          charts.texture.destroy();
      }

      charts.texture = new Chart(ctx, {
          type: 'pie',
          data: {
              labels: Object.keys(textureCount),
              datasets: [{
                  data: Object.values(textureCount),
                  backgroundColor: [
                      '#22c55e', '#3b82f6', '#f59e0b', '#ef4444',
                      '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'
                  ]
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'bottom'
                  }
              }
          }
      });
  }

  function initializePhTrendChart() {
      const ctx = document.getElementById('phTrendChart');
      if (!ctx) return;

      const sortedData = [...allSoilData]
          .filter(s => s.measurementDate && s.phLevel)
          .sort((a, b) => new Date(a.measurementDate) - new Date(b.measurementDate))
          .slice(-30); // Last 30 samples

      if (charts.phTrend) {
          charts.phTrend.destroy();
      }

      charts.phTrend = new Chart(ctx, {
          type: 'line',
          data: {
              labels: sortedData.map(s => new Date(s.measurementDate).toLocaleDateString()),
              datasets: [{
                  label: 'pH Level',
                  data: sortedData.map(s => parseFloat(s.phLevel)),
                  borderColor: '#22c55e',
                  backgroundColor: 'rgba(34, 197, 94, 0.1)',
                  tension: 0.4,
                  fill: true
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  y: {
                      beginAtZero: false,
                      min: 0,
                      max: 14
                  }
              }
          }
      });
  }

  function initializeMoistureChart() {
      const ctx = document.getElementById('moistureChart');
      if (!ctx) return;

      const moistureData = allSoilData
          .filter(s => s.moisture)
          .map(s => parseFloat(s.moisture));

      const ranges = {
          'Very Dry (0-10%)': 0,
          'Dry (10-20%)': 0,
          'Normal (20-40%)': 0,
          'Moist (40-60%)': 0,
          'Very Moist (>60%)': 0
      };

      moistureData.forEach(m => {
          if (m < 10) ranges['Very Dry (0-10%)']++;
          else if (m < 20) ranges['Dry (10-20%)']++;
          else if (m < 40) ranges['Normal (20-40%)']++;
          else if (m < 60) ranges['Moist (40-60%)']++;
          else ranges['Very Moist (>60%)']++;
      });

      if (charts.moisture) {
          charts.moisture.destroy();
      }

      charts.moisture = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: Object.keys(ranges),
              datasets: [{
                  label: 'Number of Samples',
                  data: Object.values(ranges),
                  backgroundColor: ['#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#8b5cf6']
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: {
                          precision: 0
                      }
                  }
              }
          }
      });
  }

  function initializeScatterChart() {
      const ctx = document.getElementById('scatterChart');
      if (!ctx) return;

      const scatterData = allSoilData
          .filter(s => s.nitrogen && s.phosphorus)
          .map(s => ({
              x: parseFloat(s.nitrogen),
              y: parseFloat(s.phosphorus)
          }));

      if (charts.scatter) {
          charts.scatter.destroy();
      }

      charts.scatter = new Chart(ctx, {
          type: 'scatter',
          data: {
              datasets: [{
                  label: 'N vs P Correlation',
                  data: scatterData,
                  backgroundColor: 'rgba(34, 197, 94, 0.5)',
                  borderColor: '#22c55e'
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  x: {
                      title: {
                          display: true,
                          text: 'Nitrogen (ppm)'
                      }
                  },
                  y: {
                      title: {
                          display: true,
                          text: 'Phosphorus (ppm)'
                      }
                  }
              }
          }
      });
  }

  function initializeHistogramChart() {
      const ctx = document.getElementById('histogramChart');
      if (!ctx) return;

      const organicMatterData = allSoilData
          .filter(s => s.organicMatter)
          .map(s => parseFloat(s.organicMatter));

      const bins = {
          '0-1%': 0,
          '1-2%': 0,
          '2-3%': 0,
          '3-5%': 0,
          '5-10%': 0,
          '>10%': 0
      };

      organicMatterData.forEach(om => {
          if (om < 1) bins['0-1%']++;
          else if (om < 2) bins['1-2%']++;
          else if (om < 3) bins['2-3%']++;
          else if (om < 5) bins['3-5%']++;
          else if (om < 10) bins['5-10%']++;
          else bins['>10%']++;
      });

      if (charts.histogram) {
          charts.histogram.destroy();
      }

      charts.histogram = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: Object.keys(bins),
              datasets: [{
                  label: 'Frequency',
                  data: Object.values(bins),
                  backgroundColor: '#22c55e'
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: {
                          precision: 0
                      }
                  }
              }
          }
      });
  }

  // AI Predictions
  function generateAIPredictions() {
      debugLog('Generating AI predictions...');

      const container = document.getElementById('aiPredictionsContainer');

      if (allSoilData.length === 0) {
          container.innerHTML = `
              <div class="ai-prediction-card">
                  <div class="prediction-title">
                      <i class="fas fa-info-circle"></i>
                      No Data Available
                  </div>
                  <div class="prediction-content">
                      Not enough soil data to generate predictions. Please add soil samples first.
                  </div>
              </div>
          `;
          return;
      }

      const predictions = [];

      // Prediction 1: pH Trend
      const avgPh = calculateAveragePh();
      let phPrediction = '';
      if (avgPh < 6.0) {
          phPrediction = `Your soil is trending acidic (pH ${avgPh.toFixed(1)}). Consider applying lime to increase pH levels. Target pH should be between 6.5-7.5 for most crops.`;
      } else if (avgPh > 7.5) {
          phPrediction = `Your soil is trending alkaline (pH ${avgPh.toFixed(1)}). Consider adding sulfur or organic matter to reduce pH. Optimal range is 6.5-7.5 for most crops.`;
      } else {
          phPrediction = `Your soil pH is optimal (${avgPh.toFixed(1)}). Maintain current practices to keep pH in the ideal range of 6.5-7.5.`;
      }
      predictions.push({ title: 'pH Level Analysis', content: phPrediction, icon: 'flask' });

      // Prediction 2: Nutrient Analysis
      const avgN = allSoilData.reduce((sum, s) => sum + (parseFloat(s.nitrogen) || 0), 0) / allSoilData.length;
      const avgP = allSoilData.reduce((sum, s) => sum + (parseFloat(s.phosphorus) || 0), 0) / allSoilData.length;
      const avgK = allSoilData.reduce((sum, s) => sum + (parseFloat(s.potassium) || 0), 0) / allSoilData.length;

      let nutrientPrediction = 'Nutrient Analysis: ';
      const lowNutrients = [];
      if (avgN < 40) lowNutrients.push('Nitrogen');
      if (avgP < 25) lowNutrients.push('Phosphorus');
      if (avgK < 150) lowNutrients.push('Potassium');

      if (lowNutrients.length > 0) {
          nutrientPrediction += `Low levels detected in ${lowNutrients.join(', ')}. Recommendation: Apply NPK fertilizer with ratio ${avgN < 40 ? 'high N' : 'balanced'}, ${avgP < 25 ? 'high P' : 'balanced'}, ${avgK < 150 ? 'high K' : 'balanced'}.`;
      } else {
          nutrientPrediction += `All major nutrients (N-P-K) are at adequate levels. Continue monitoring and maintain balanced fertilization.`;
      }
      predictions.push({ title: 'Nutrient Status Prediction', content: nutrientPrediction, icon: 'leaf' });

      // Prediction 3: Organic Matter
      const avgOM = allSoilData.reduce((sum, s) => sum + (parseFloat(s.organicMatter) || 0), 0) / allSoilData.length;
      let omPrediction = '';
      if (avgOM < 2) {
          omPrediction = `Organic matter is low (${avgOM.toFixed(1)}%). This may affect soil structure and water retention. Recommendation: Add compost or manure at 2-3 tons per hectare annually.`;
      } else if (avgOM < 4) {
          omPrediction = `Organic matter is moderate (${avgOM.toFixed(1)}%). Consider adding organic amendments to improve soil health and increase to 4-5%.`;
      } else {
          omPrediction = `Excellent organic matter content (${avgOM.toFixed(1)}%). Your soil has good structure and nutrient-holding capacity. Maintain current practices.`;
      }
      predictions.push({ title: 'Organic Matter Forecast', content: omPrediction, icon: 'seedling' });

      // Prediction 4: Crop Recommendations
      const suitableCrops = [];
      if (avgPh >= 6.0 && avgPh <= 7.5) {
          suitableCrops.push('maize', 'sorghum', 'millet', 'cotton');
      }
      if (avgOM > 3) {
          suitableCrops.push('vegetables', 'legumes');
      }
      if (avgN > 60) {
          suitableCrops.push('leafy greens');
      }

      const cropPrediction = suitableCrops.length > 0
          ? `Based on current soil conditions, recommended crops: ${suitableCrops.join(', ')}. These crops are well-suited to your soil's pH, nutrient levels, and organic matter content.`
          : 'Improve soil conditions (pH, nutrients, organic matter) before planting. Focus on soil amendment first.';
      predictions.push({ title: 'Crop Suitability Prediction', content: cropPrediction, icon: 'tractor' });

      // Prediction 5: Seasonal Recommendations
      const month = new Date().getMonth();
      let seasonalPrediction = '';
      if (month >= 3 && month <= 5) {
          seasonalPrediction = 'Rainy season approaching. Test moisture retention capacity and prepare drainage systems. Consider early-season crops that benefit from rainfall.';
      } else if (month >= 6 && month <= 9) {
          seasonalPrediction = 'Peak growing season. Monitor nutrient levels closely and apply supplemental fertilizers as needed. Ensure adequate irrigation for optimal crop growth.';
      } else if (month >= 10 && month <= 11) {
          seasonalPrediction = 'Harvest season. Prepare soil for next planting cycle by adding organic matter and testing for nutrient depletion after harvest.';
      } else {
          seasonalPrediction = 'Dry season. Focus on soil conservation and preparation. Add organic amendments and consider cover crops to prevent erosion.';
      }
      predictions.push({ title: 'Seasonal Recommendations', content: seasonalPrediction, icon: 'calendar' });

      // Render predictions
      container.innerHTML = predictions.map(pred => `
          <div class="ai-prediction-card">
              <div class="prediction-title">
                  <i class="fas fa-${pred.icon}"></i>
                  ${pred.title}
              </div>
              <div class="prediction-content">${pred.content}</div>
          </div>
      `).join('');

      debugLog('AI predictions generated');
  }




function refreshAIAnalysis() {
    debugLog('Refreshing AI Analysis...');

    // Check if we have farms and soil data
    if (!allFarms || allFarms.length === 0) {
        debugLog('No farms available for AI analysis');
        const container = document.getElementById('aiPredictionsContainer');
        if (container) {
            container.innerHTML = `
                <div class="ai-prediction-card" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
                    <div class="prediction-title">
                        <i class="fas fa-info-circle"></i>
                        No Farms Available
                    </div>
                    <div class="prediction-content">
                        <p>No farms found in the database. Please add farms first to enable AI analysis.</p>
                    </div>
                </div>
            `;
        }
        return;
    }

    if (!allSoilData || allSoilData.length === 0) {
        debugLog('No soil data available for AI analysis');
        const container = document.getElementById('aiPredictionsContainer');
        if (container) {
            container.innerHTML = `
                <div class="ai-prediction-card" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
                    <div class="prediction-title">
                        <i class="fas fa-info-circle"></i>
                        No Soil Data Available
                    </div>
                    <div class="prediction-content">
                        <p>No soil test data found. Please add soil samples to enable AI analysis.</p>
                    </div>
                </div>
            `;
        }
        return;
    }

    // Get the first farm with soil data, or use the first farm
    let targetFarmId = null;

    // Try to find a farm that has soil data
    for (const farm of allFarms) {
        const farmSoilData = allSoilData.filter(soil => soil.farmId === farm.id);
        if (farmSoilData.length > 0) {
            targetFarmId = farm.id;
            debugLog('Found farm with soil data:', farm.farmName, 'ID:', targetFarmId);
            break;
        }
    }

    // If no farm with soil data found, use the first farm
    if (!targetFarmId && allFarms.length > 0) {
        targetFarmId = allFarms[0].id;
        debugLog('Using first farm (no soil data):', allFarms[0].farmName, 'ID:', targetFarmId);
    }

    if (targetFarmId) {
        debugLog('Initializing AI analysis for farm:', targetFarmId);
        // Use setTimeout to ensure DOM is ready
        setTimeout(() => {
            initializeAIAnalysis(targetFarmId);
        }, 100);
    } else {
        debugLog('No valid farm ID found for AI analysis');
        const container = document.getElementById('aiPredictionsContainer');
        if (container) {
            container.innerHTML = `
                <div class="ai-prediction-card" style="background: #fee2e2; border-left: 4px solid #dc2626;">
                    <div class="prediction-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Unable to Initialize AI Analysis
                    </div>
                    <div class="prediction-content">
                        <p>Could not find a valid farm for AI analysis. Please check your farm and soil data.</p>
                    </div>
                </div>
            `;
        }
    }
}



  function showAddSoilDataModal() {
      debugLog('Opening add soil data modal');
      currentEditingSoilDataId = null;
      document.getElementById('soilDataModalTitle').textContent = 'Add Soil Data';
      document.getElementById('soilDataForm').reset();
      document.getElementById('soilDataId').value = '';

      // Set current datetime
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('measurementDate').value = now.toISOString().slice(0, 16);

      // Ensure farms are loaded
      const farmSelect = document.getElementById('farmId');
      if (farmSelect && farmSelect.options.length <= 1) {
          debugLog('Farms not loaded, reloading...');
          loadFarms();
      }

      document.getElementById('soilDataModal').classList.add('show');
  }

  function closeSoilDataModal() {
      debugLog('Closing soil data modal');
      document.getElementById('soilDataModal').classList.remove('show');
      document.getElementById('soilDataForm').reset();
      currentEditingSoilDataId = null;
  }



async function submitSoilDataForm(event) {
    event.preventDefault();
    debugLog('Submitting soil data form');

    // Validate required fields
    const farmId = document.getElementById('farmId').value;
    const phLevel = document.getElementById('phLevel').value;
    const measurementDate = document.getElementById('measurementDate').value;

    if (!farmId) {
        showToast('Please select a farm', 'error');
        return;
    }

    if (!phLevel) {
        showToast('Please enter pH level', 'error');
        return;
    }

    if (!measurementDate) {
        showToast('Please select measurement date', 'error');
        return;
    }

    const formData = {
        farmId: farmId,
        sampleCode: document.getElementById('sampleCode').value || null,
        phLevel: parseFloat(phLevel),
        nitrogen: parseFloat(document.getElementById('nitrogen').value) || null,
        phosphorus: parseFloat(document.getElementById('phosphorus').value) || null,
        potassium: parseFloat(document.getElementById('potassium').value) || null,
        organicMatter: parseFloat(document.getElementById('organicMatter').value) || null,
        moisture: parseFloat(document.getElementById('moisture').value) || null,
        soilTexture: document.getElementById('soilTexture').value || null,
        bulkDensity: parseFloat(document.getElementById('bulkDensity').value) || null,
        porosity: parseFloat(document.getElementById('porosity').value) || null,
        electricalConductivity: parseFloat(document.getElementById('electricalConductivity').value) || null,
        cationExchangeCapacity: parseFloat(document.getElementById('cationExchangeCapacity').value) || null,
        measurementDate: measurementDate,
        testingMethod: document.getElementById('testingMethod').value || null,
        laboratoryName: document.getElementById('laboratoryName').value || null,
        depthCm: parseInt(document.getElementById('depthCm').value) || 30,
        sampleLocationGps: document.getElementById('sampleLocationGps').value || null,
        recommendations: document.getElementById('recommendations').value || null
    };

    // NE PAS INCLURE l'ID lors de la création, seulement lors de la modification
    // SUPPRIMER CETTE LIGNE si elle existe quelque part:
    // formData.id = document.getElementById('soilDataId').value;

    debugLog('Form data:', formData);

    try {
        showLoading(true);
        let response;

        if (currentEditingSoilDataId) {
            // Mode UPDATE : inclure l'ID
            debugLog('Updating existing soil data:', currentEditingSoilDataId);
            response = await fetch(`${SOIL_API_BASE_URL}/${currentEditingSoilDataId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(formData)
            });
        } else {
            // Mode CREATE : NE PAS inclure l'ID
            debugLog('Creating new soil data');
            response = await fetch(`${SOIL_API_BASE_URL}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(formData)  // formData sans ID
            });
        }

        debugLog('Response status:', response.status);

        if (response.ok) {
            let result = null;
            const contentType = response.headers.get('content-type');

            if (contentType && contentType.includes('application/json')) {
                const text = await response.text();
                if (text && text.trim().length > 0) {
                    try {
                        result = JSON.parse(text);
                        debugLog('Response data:', result);
                    } catch (e) {
                        debugLog('Could not parse response JSON:', e);
                    }
                }
            }

            showToast(
                currentEditingSoilDataId ? 'Soil data updated successfully' : 'Soil data created successfully',
                'success'
            );
            closeSoilDataModal();
            await loadAllSoilData();
            initializeCharts();
            refreshAIAnalysis();
            generateAIPredictions();
        } else {
            let errorMessage = 'Error saving soil data';
            try {
                const text = await response.text();
                debugLog('Error response text:', text);

                if (text && text.trim().length > 0) {
                    try {
                        const error = JSON.parse(text);
                        debugLog('Parsed error:', error);

                        if (error.fieldErrors) {
                            const errorMessages = Object.entries(error.fieldErrors)
                                .map(([field, msg]) => `${field}: ${msg}`)
                                .join(', ');
                            errorMessage = `Validation errors: ${errorMessages}`;
                        } else if (error.message) {
                            errorMessage = error.message;
                        } else if (error.error) {
                            errorMessage = error.error;
                        }
                    } catch (e) {
                        debugLog('Could not parse error JSON:', e);
                        errorMessage = text;
                    }
                }
            } catch (e) {
                debugLog('Could not read error response:', e);
            }

            showToast(errorMessage, 'error');
        }
    } catch (error) {
        debugLog('Network or unexpected error:', error);
        showToast('Network error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}


  async function editSoilData(soilDataId) {
      debugLog('Editing soil data:', soilDataId);
      try {
          showLoading(true);
          const response = await fetch(`${SOIL_API_BASE_URL}/${soilDataId}`);

          if (!response.ok) throw new Error('Failed to load soil data');

          const soilData = await response.json();
          debugLog('Loaded soil data for editing:', soilData);

          currentEditingSoilDataId = soilDataId;

          document.getElementById('soilDataModalTitle').textContent = 'Edit Soil Data';
          document.getElementById('soilDataId').value = soilData.id;
          document.getElementById('farmId').value = soilData.farmId || '';
          document.getElementById('sampleCode').value = soilData.sampleCode || '';
          document.getElementById('phLevel').value = soilData.phLevel || '';
          document.getElementById('nitrogen').value = soilData.nitrogen || '';
          document.getElementById('phosphorus').value = soilData.phosphorus || '';
          document.getElementById('potassium').value = soilData.potassium || '';
          document.getElementById('organicMatter').value = soilData.organicMatter || '';
          document.getElementById('moisture').value = soilData.moisture || '';
          document.getElementById('soilTexture').value = soilData.soilTexture || '';
          document.getElementById('bulkDensity').value = soilData.bulkDensity || '';
          document.getElementById('porosity').value = soilData.porosity || '';
          document.getElementById('electricalConductivity').value = soilData.electricalConductivity || '';
          document.getElementById('cationExchangeCapacity').value = soilData.cationExchangeCapacity || '';
          document.getElementById('testingMethod').value = soilData.testingMethod || '';
          document.getElementById('laboratoryName').value = soilData.laboratoryName || '';
          document.getElementById('depthCm').value = soilData.depthCm || 30;
          document.getElementById('sampleLocationGps').value = soilData.sampleLocationGps || '';
          document.getElementById('recommendations').value = soilData.recommendations || '';

          if (soilData.measurementDate) {
              const date = new Date(soilData.measurementDate);
              date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
              document.getElementById('measurementDate').value = date.toISOString().slice(0, 16);
          }

          document.getElementById('soilDataModal').classList.add('show');
      } catch (error) {
          debugLog('Error loading soil data:', error);
          showToast('Error loading soil data', 'error');
      } finally {
          showLoading(false);
      }
  }

  async function viewSoilData(soilDataId) {
      debugLog('Viewing soil data:', soilDataId);
      await editSoilData(soilDataId);

      document.querySelectorAll('#soilDataForm input, #soilDataForm select, #soilDataForm textarea').forEach(input => {
          input.disabled = true;
      });
      document.getElementById('soilDataSubmitBtn').style.display = 'none';
      document.getElementById('soilDataModalTitle').textContent = 'View Soil Data Details';
  }

  async function deleteSoilData(soilDataId) {
      debugLog('Attempting to delete soil data:', soilDataId);
      if (!confirm('Are you sure you want to delete this soil data? This action cannot be undone.')) {
          return;
      }

      try {
          showLoading(true);
          const response = await fetch(`${SOIL_API_BASE_URL}/${soilDataId}`, {
              method: 'DELETE'
          });

          if (response.ok) {
              showToast('Soil data deleted successfully', 'success');
              await loadAllSoilData();
              initializeCharts();
              refreshAIAnalysis();
              generateAIPredictions();
          } else {
              showToast('Error deleting soil data', 'error');
          }
      } catch (error) {
          debugLog('Error deleting soil data:', error);
          showToast('Error deleting soil data', 'error');
      } finally {
          showLoading(false);
      }
  }

  // Search Functions
  function searchInTable(tableBodyId, searchInputId) {
      const searchValue = document.getElementById(searchInputId).value.toLowerCase();
      const tbody = document.getElementById(tableBodyId);
      const rows = tbody.getElementsByTagName('tr');

      for (let row of rows) {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(searchValue) ? '' : 'none';
      }
  }

  function handleGlobalSearch() {
      const searchValue = document.getElementById('globalSearch').value.toLowerCase();
      searchInTable('soilDataTableBody', 'globalSearch');
  }

  // Export Functions
  function exportToExcel() {
      debugLog('Exporting to Excel');

      if (allSoilData.length === 0) {
          showToast('No data to export', 'warning');
          return;
      }

      const exportData = allSoilData.map(soil => ({
          'Sample Code': soil.sampleCode || 'N/A',
          'Farm': getFarmName(soil.farmId),
          'pH Level': soil.phLevel || 'N/A',
          'Nitrogen (ppm)': soil.nitrogen || 'N/A',
          'Phosphorus (ppm)': soil.phosphorus || 'N/A',
          'Potassium (ppm)': soil.potassium || 'N/A',
          'Organic Matter (%)': soil.organicMatter || 'N/A',
          'Moisture (%)': soil.moisture || 'N/A',
          'Soil Texture': soil.soilTexture || 'N/A',
          'Quality': calculateSoilQuality(soil),
          'Measurement Date': soil.measurementDate ? new Date(soil.measurementDate).toLocaleDateString() : 'N/A'
      }));

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Soil Data');
      XLSX.writeFile(wb, `soil_data_export_${Date.now()}.xlsx`);

      showToast('Excel file exported successfully', 'success');
  }

  // Report Functions
  async function generatePDFReport() {
      debugLog('Generating PDF report');
      const reportType = document.getElementById('reportType').value;

      if (allSoilData.length === 0) {
          showToast('No data to generate report', 'warning');
          return;
      }

      showLoading(true);

      try {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF();

          let filteredData = [...allSoilData];
          let title = 'Soil Data Report';

          // Filter data based on report type
          const now = new Date();
          if (reportType === 'weekly') {
              const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
              filteredData = allSoilData.filter(s => new Date(s.measurementDate) >= weekAgo);
              title = 'Weekly Soil Data Report';
          } else if (reportType === 'monthly') {
              const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
              filteredData = allSoilData.filter(s => new Date(s.measurementDate) >= monthAgo);
              title = 'Monthly Soil Data Report';
          } else if (reportType === 'yearly') {
              const yearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
              filteredData = allSoilData.filter(s => new Date(s.measurementDate) >= yearAgo);
              title = 'Yearly Soil Data Report';
          } else if (reportType === 'custom') {
              const startDate = new Date(document.getElementById('startDate').value);
              const endDate = new Date(document.getElementById('endDate').value);
              filteredData = allSoilData.filter(s => {
                  const date = new Date(s.measurementDate);
                  return date >= startDate && date <= endDate;
              });
              title = 'Custom Range Soil Data Report';
          }

          // Generate PDF
          pdf.setFontSize(20);
          pdf.text(title, 105, 20, { align: 'center' });

          pdf.setFontSize(12);
          pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
          pdf.text(`Total Samples: ${filteredData.length}`, 105, 38, { align: 'center' });

          let yPosition = 50;
          pdf.setFontSize(10);

          filteredData.slice(0, 50).forEach((soil, index) => {
              if (yPosition > 270) {
                  pdf.addPage();
                  yPosition = 20;
              }

              pdf.text(`${index + 1}. ${soil.sampleCode || 'N/A'}`, 20, yPosition);
              pdf.text(`Farm: ${getFarmName(soil.farmId)}`, 30, yPosition + 6);
              pdf.text(`pH: ${soil.phLevel || 'N/A'} | Quality: ${calculateSoilQuality(soil)}`, 30, yPosition + 12);
              pdf.text(`N-P-K: ${soil.nitrogen || 0}-${soil.phosphorus || 0}-${soil.potassium || 0}`, 30, yPosition + 18);

              yPosition += 28;
          });

          pdf.save(`soil_report_${reportType}_${Date.now()}.pdf`);
          showToast('PDF report generated successfully', 'success');
      } catch (error) {
          debugLog('Error generating PDF:', error);
          showToast('Error generating PDF report', 'error');
      } finally {
          showLoading(false);
      }
  }

  async function generateExcelReport() {
      debugLog('Generating Excel report');
      exportToExcel();
  }



function showSection(sectionName) {
    debugLog('Showing section:', sectionName);

    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });

    // Show selected section
    const section = document.getElementById(sectionName + 'Section');
    if (section) {
        section.classList.add('active');
    }

    // Update active nav item
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });

    // Find and activate the clicked nav item
    const clickedNavItem = event && event.target ? event.target.closest('.nav-item') : null;
    if (clickedNavItem) {
        clickedNavItem.classList.add('active');
    }

    // Special handling for specific sections
    if (sectionName === 'soilData') {
        loadAllSoilData();
    } else if (sectionName === 'dashboard') {
        // Refresh dashboard data
        loadStatistics();
        if (soilMap) {
            setTimeout(() => {
                soilMap.invalidateSize();
                updateMapMarkers();
            }, 300);
        }
    } else if (sectionName === 'analytics') {
        // Refresh charts
        setTimeout(() => {
            initializeCharts();
        }, 300);
    }
}




  function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');

      sidebar.classList.toggle('collapsed');
      mainContent.classList.toggle('sidebar-collapsed');
  }

  function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');

      const themeToggle = document.getElementById('themeToggle');
      themeToggle.innerHTML = isDark
          ? '<i class="fas fa-sun"></i><span>Light Mode</span>'
          : '<i class="fas fa-moon"></i><span>Dark Mode</span>';

      localStorage.setItem('theme', isDark ? 'dark' : 'light');
  }

  function loadSavedTheme() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
          document.body.classList.add('dark-mode');
          document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i><span>Light Mode</span>';
      }
  }

  function updateDateTime() {
      const now = new Date();

      const dateOptions = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
      };

      const currentDateElement = document.getElementById('currentDate');
      if (currentDateElement) {
          currentDateElement.textContent = now.toLocaleDateString('en-US', dateOptions);
      }

      if (currentLoggedInUser) {
          const greetingText = document.getElementById('greetingText');
          if (greetingText) {
              const hour = now.getHours();
              let greeting = 'Good Morning';
              if (hour >= 12 && hour < 18) greeting = 'Good Afternoon';
              else if (hour >= 18) greeting = 'Good Evening';

              greetingText.textContent = `${greeting}, ${currentLoggedInUser.fullName}!`;
          }
      }
  }

  function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('show', show);
  }

  function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<p class="toast-message">${message}</p>`;

      document.getElementById('toastContainer').appendChild(toast);

      setTimeout(() => {
          toast.remove();
      }, 5000);
  }

  // Report type change handler
  document.addEventListener('DOMContentLoaded', function() {
      const reportTypeSelect = document.getElementById('reportType');
      if (reportTypeSelect) {
          reportTypeSelect.addEventListener('change', function() {
              const customDateRange = document.getElementById('customDateRange');
              if (this.value === 'custom') {
                  customDateRange.style.display = 'block';
              } else {
                  customDateRange.style.display = 'none';
              }
          });
      }
  });

  debugLog('Soil Data Dashboard JavaScript loaded successfully');


    // ==================== AI MACHINE LEARNING ANALYSIS SYSTEM ====================
// Ajoutez ce code après la fonction generateAIPredictions() dans votre fichier HTML











// ==================== AI-POWERED SOIL ANALYSIS ENGINE ====================
// Real-time analysis using actual database data via Spring Boot REST API

// ==================== CONFIGURATION ====================
// ==================== CONFIGURATION ====================
const API_CONFIG = {
    BASE_URL: 'http://localhost:1010/api/v1', // Backend URL pour soil-data
    ENDPOINTS: {
        SOIL_DATA: '/soil-data',
        FARM_DATA: '/farms',  // Ce endpoint n'a PAS /v1 dans le path
        ANALYSIS: '/soil-data/farm',
        STATISTICS: '/soil-data/farm'
    }
};

// ==================== 1. ADVANCED AI ANALYSIS ENGINE ====================
class SoilDataAIEngine {
    constructor(farmId) {
        this.farmId = farmId;
        this.soilData = [];
        this.farmData = null;
        this.analysisCache = new Map();
        this.isLoading = false;
    }


// ==================== DATA LOADING FROM DATABASE ====================
async loadRealDataFromDatabase() {
    console.log(`[AI ENGINE] Loading real data from database for farm: ${this.farmId}`);
    this.isLoading = true;

    try {
        // Fetch soil data from backend
        const soilResponse = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.SOIL_DATA}/farm/${this.farmId}/all`);

        if (!soilResponse.ok) {
            throw new Error(`Failed to fetch soil data: ${soilResponse.status}`);
        }

        this.soilData = await soilResponse.json();
        console.log(`[AI ENGINE] Loaded ${this.soilData.length} real soil samples from database`);

        // FIX: Utiliser l'URL COMPLETE pour les farms (sans /v1)
        try {
            // Construire l'URL complète pour /api/farms (pas /api/v1/farms)
            const farmApiUrl = `http://localhost:1010/api${API_CONFIG.ENDPOINTS.FARM_DATA}/${this.farmId}`;
            console.log(`[AI ENGINE] Fetching farm data from: ${farmApiUrl}`);

            const farmResponse = await fetch(farmApiUrl);

            if (farmResponse.ok) {
                this.farmData = await farmResponse.json();
                console.log(`[AI ENGINE] Farm data loaded successfully:`, this.farmData);
            } else {
                console.warn(`[AI ENGINE] Farm data not accessible (${farmResponse.status}), using minimal farm object`);
                // Créer un objet farm minimal
                this.farmData = {
                    id: this.farmId,
                    farmName: `Farm ${this.farmId}`,
                    farmCode: this.farmId
                };
            }
        } catch (farmError) {
            console.warn('[AI ENGINE] Farm data fetch failed:', farmError.message);
            // Créer un objet farm minimal en cas d'erreur
            this.farmData = {
                id: this.farmId,
                farmName: `Farm ${this.farmId}`,
                farmCode: this.farmId
            };
        }

        this.isLoading = false;
        return true;

    } catch (error) {
        console.error('[AI ENGINE] Error loading data from database:', error);
        this.isLoading = false;
        throw error;
    }
}







    // ==================== DATA VALIDATION ====================
    validateData() {
        if (!this.soilData || this.soilData.length === 0) {
            return {
                valid: false,
                message: 'No soil data available in database for this farm. Please add soil test records first.'
            };
        }

        const requiredFields = ['phLevel', 'nitrogen', 'phosphorus', 'potassium'];
        const validSamples = this.soilData.filter(sample =>
            requiredFields.every(field => sample[field] != null && sample[field] !== '')
        );

        if (validSamples.length === 0) {
            return {
                valid: false,
                message: 'Soil data exists but lacks required nutrient information (pH, N, P, K). Please update soil records.'
            };
        }

        return {
            valid: true,
            totalSamples: this.soilData.length,
            validSamples: validSamples.length,
            completeness: ((validSamples.length / this.soilData.length) * 100).toFixed(1)
        };
    }

    // ==================== STATISTICAL CALCULATIONS ====================
    calculateStatistics(field) {
        const values = this.soilData
            .map(s => parseFloat(s[field]))
            .filter(v => !isNaN(v) && v > 0);

        if (values.length === 0) return null;

        const sorted = [...values].sort((a, b) => a - b);
        const sum = values.reduce((a, b) => a + b, 0);
        const mean = sum / values.length;

        const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
        const stdDev = Math.sqrt(variance);
        const cv = (stdDev / mean) * 100;

        return {
            min: sorted[0],
            max: sorted[sorted.length - 1],
            mean: mean,
            median: sorted[Math.floor(sorted.length / 2)],
            stdDev: stdDev,
            cv: cv,
            count: values.length
        };
    }

    // ==================== pH PREDICTION MODEL ====================
    async predictPhTrends() {
        const phStats = this.calculateStatistics('phLevel');
        const nStats = this.calculateStatistics('nitrogen');
        const omStats = this.calculateStatistics('organicMatter');

        if (!phStats) {
            return { error: 'Insufficient pH data for prediction' };
        }

        // Linear regression coefficients (optimized for agricultural soils)
        const weights = {
            nitrogen: -0.0012,
            organicMatter: 0.075,
            intercept: 6.8
        };

        const avgN = nStats ? nStats.mean : 80;
        const avgOM = omStats ? omStats.mean : 2.5;

        const predictedPh = weights.intercept +
                          (weights.nitrogen * avgN) +
                          (weights.organicMatter * avgOM);

        const trend = predictedPh > phStats.mean ? 'increasing' : 'decreasing';
        const changeRate = Math.abs(predictedPh - phStats.mean);

        // Calculate confidence based on data quality
        let confidence = 'HIGH';
        if (phStats.cv > 15) confidence = 'MEDIUM';
        if (phStats.cv > 30 || phStats.count < 5) confidence = 'LOW';

        return {
            currentPh: phStats.mean.toFixed(2),
            predictedPh: predictedPh.toFixed(2),
            trend: trend,
            changeRate: changeRate.toFixed(2),
            confidence: confidence,
            dataPoints: phStats.count,
            variability: phStats.cv.toFixed(1) + '%',
            recommendation: this.getPhRecommendation(phStats.mean, predictedPh),
            timeframe: '6-12 months projection based on current management'
        };
    }

    getPhRecommendation(currentPh, predictedPh) {
        if (currentPh < 5.5) {
            return `Critical: Apply 3-4 tons of agricultural lime per hectare immediately. Current pH ${currentPh.toFixed(1)} is too acidic.`;
        } else if (currentPh < 6.0) {
            return `Apply 2-3 tons of lime per hectare. Soil is moderately acidic (pH ${currentPh.toFixed(1)}).`;
        } else if (currentPh > 8.0) {
            return `Apply elemental sulfur (200-400 kg/ha) or acidifying fertilizers. Soil is too alkaline (pH ${currentPh.toFixed(1)}).`;
        } else if (predictedPh < 6.0 && currentPh >= 6.0) {
            return `Preventive action needed: Soil pH trending acidic. Apply 1-2 tons lime per hectare before next season.`;
        } else if (predictedPh > 7.8 && currentPh <= 7.5) {
            return `Monitor closely: Soil pH trending alkaline. Consider acidifying amendments if trend continues.`;
        }
        return `pH levels are optimal (${currentPh.toFixed(1)}). Maintain current soil management practices.`;
    }

    // ==================== NUTRIENT OPTIMIZATION MODEL ====================
    async optimizeNutrients() {
        const nStats = this.calculateStatistics('nitrogen');
        const pStats = this.calculateStatistics('phosphorus');
        const kStats = this.calculateStatistics('potassium');
        const omStats = this.calculateStatistics('organicMatter');

        if (!nStats || !pStats || !kStats) {
            return { error: 'Insufficient nutrient data for optimization' };
        }

        // Get dominant soil texture from database
        const textureCount = {};
        this.soilData.forEach(s => {
            if (s.soilTexture) {
                textureCount[s.soilTexture] = (textureCount[s.soilTexture] || 0) + 1;
            }
        });

        const dominantTexture = Object.keys(textureCount).length > 0
            ? Object.keys(textureCount).reduce((a, b) => textureCount[a] > textureCount[b] ? a : b)
            : 'LOAM';

        // Target NPK ratios based on soil texture (scientific standards)
        const targetRatios = {
            'CLAY': { n: 120, p: 60, k: 200 },
            'CLAY_LOAM': { n: 110, p: 55, k: 180 },
            'LOAM': { n: 100, p: 50, k: 150 },
            'SANDY_LOAM': { n: 90, p: 45, k: 130 },
            'SAND': { n: 80, p: 40, k: 120 },
            'SILT': { n: 95, p: 48, k: 140 },
            'SILTY_LOAM': { n: 105, p: 52, k: 160 },
            'SANDY_CLAY': { n: 115, p: 58, k: 190 },
            'SILTY_CLAY': { n: 115, p: 58, k: 185 },
            'SANDY_CLAY_LOAM': { n: 105, p: 53, k: 170 },
            'SILTY_CLAY_LOAM': { n: 110, p: 55, k: 175 }
        };

        const target = targetRatios[dominantTexture] || targetRatios['LOAM'];

        // Calculate deficits
        const nDeficit = Math.max(0, target.n - nStats.mean);
        const pDeficit = Math.max(0, target.p - pStats.mean);
        const kDeficit = Math.max(0, target.k - kStats.mean);

        // Organic matter correction factor
        const omFactor = omStats ? Math.min(1.25, 1 + (omStats.mean / 100)) : 1.0;

        // Calculate fertilizer requirements
        const ureaNeeded = (nDeficit * omFactor * 2.17).toFixed(0); // Convert N to Urea (46% N)
        const dapNeeded = (pDeficit * omFactor * 2.22).toFixed(0);  // Convert P to DAP (18-46-0)
        const mopNeeded = (kDeficit * omFactor * 1.67).toFixed(0);  // Convert K to MOP (0-0-60)

        const totalDeficit = nDeficit + pDeficit + kDeficit;
        let urgency = 'LOW';
        if (totalDeficit > 200) urgency = 'CRITICAL';
        else if (totalDeficit > 120) urgency = 'HIGH';
        else if (totalDeficit > 60) urgency = 'MEDIUM';

        return {
            soilTexture: dominantTexture,
            currentNPK: {
                nitrogen: nStats.mean.toFixed(1),
                phosphorus: pStats.mean.toFixed(1),
                potassium: kStats.mean.toFixed(1)
            },
            targetNPK: target,
            deficits: {
                nitrogen: nDeficit.toFixed(1),
                phosphorus: pDeficit.toFixed(1),
                potassium: kDeficit.toFixed(1)
            },
            fertilizerRecommendations: {
                urea_46N: parseInt(ureaNeeded),
                dap_18_46_0: parseInt(dapNeeded),
                mop_0_0_60: parseInt(mopNeeded),
                totalCost_estimate_USD: (parseInt(ureaNeeded) * 0.45 + parseInt(dapNeeded) * 0.55 + parseInt(mopNeeded) * 0.40).toFixed(0)
            },
            applicationSchedule: [
                {
                    stage: 'Base Application (at planting)',
                    urea: Math.floor(ureaNeeded * 0.4) + ' kg/ha',
                    dap: dapNeeded + ' kg/ha (apply all)',
                    mop: Math.floor(mopNeeded * 0.5) + ' kg/ha'
                },
                {
                    stage: 'Top Dressing (4-6 weeks)',
                    urea: Math.floor(ureaNeeded * 0.35) + ' kg/ha',
                    dap: '0 kg/ha',
                    mop: Math.floor(mopNeeded * 0.5) + ' kg/ha'
                },
                {
                    stage: 'Late Season (8-10 weeks)',
                    urea: Math.floor(ureaNeeded * 0.25) + ' kg/ha',
                    dap: '0 kg/ha',
                    mop: '0 kg/ha'
                }
            ],
            urgency: urgency,
            dataQuality: {
                samples: nStats.count,
                variability: `N: ${nStats.cv.toFixed(0)}%, P: ${pStats.cv.toFixed(0)}%, K: ${kStats.cv.toFixed(0)}%`,
                confidence: (nStats.cv + pStats.cv + kStats.cv) / 3 < 25 ? 'HIGH' : 'MEDIUM'
            }
        };
    }



// ==================== CROP RECOMMENDATION SYSTEM ====================
async recommendCrops() {
    const phStats = this.calculateStatistics('phLevel');
    const nStats = this.calculateStatistics('nitrogen');
    const pStats = this.calculateStatistics('phosphorus');
    const kStats = this.calculateStatistics('potassium');
    const omStats = this.calculateStatistics('organicMatter');
    const moistureStats = this.calculateStatistics('moisture');

    if (!phStats || !nStats || !pStats || !kStats) {
        return { error: 'Insufficient data for crop recommendations' };
    }

    // Load actual crops from database
    try {
        const cropsResponse = await fetch('http://localhost:1010/api/v1/crops/all');
        if (!cropsResponse.ok) {
            throw new Error('Failed to load crops from database');
        }

        const responseData = await cropsResponse.json();

        // **FIX: Extraire le tableau de crops depuis ApiResponse**
        let availableCrops = [];

        // Vérifier si c'est un ApiResponse avec structure { success, message, data }
        if (responseData.data && Array.isArray(responseData.data)) {
            availableCrops = responseData.data;
        }
        // Vérifier si c'est directement un tableau
        else if (Array.isArray(responseData)) {
            availableCrops = responseData;
        }
        // Vérifier si c'est une Page Spring avec content
        else if (responseData.content && Array.isArray(responseData.content)) {
            availableCrops = responseData.content;
        }
        else {
            console.error('[AI ENGINE] Unexpected API response format:', responseData);
            throw new Error('Invalid crops data format received from API');
        }

        if (!availableCrops || availableCrops.length === 0) {
            return { error: 'No crops available in database for recommendation' };
        }

        const avgPh = phStats.mean;
        const avgN = nStats.mean;
        const avgP = pStats.mean;
        const avgK = kStats.mean;
        const avgOM = omStats ? omStats.mean : 2.5;

        // Score crops based on suitability
        const scoredCrops = availableCrops.map(crop => {
            let score = 0;

            // pH compatibility (30%)
            if (crop.optimalPhMin && crop.optimalPhMax) {
                if (avgPh >= crop.optimalPhMin && avgPh <= crop.optimalPhMax) {
                    score += 30;
                } else {
                    const phDiff = Math.min(Math.abs(avgPh - crop.optimalPhMin), Math.abs(avgPh - crop.optimalPhMax));
                    score += Math.max(0, 30 - (phDiff * 8));
                }
            }

            // Nitrogen compatibility (20%)
            if (crop.nitrogenRequirement) {
                const nReq = crop.nitrogenRequirement;
                if (avgN >= nReq * 0.8 && avgN <= nReq * 1.2) {
                    score += 20;
                } else {
                    const nDiff = Math.abs(avgN - nReq);
                    score += Math.max(0, 20 - (nDiff / 8));
                }
            }

            // Phosphorus compatibility (20%)
            if (crop.phosphorusRequirement) {
                const pReq = crop.phosphorusRequirement;
                if (avgP >= pReq * 0.8 && avgP <= pReq * 1.2) {
                    score += 20;
                } else {
                    const pDiff = Math.abs(avgP - pReq);
                    score += Math.max(0, 20 - (pDiff / 4));
                }
            }

            // Potassium compatibility (20%)
            if (crop.potassiumRequirement) {
                const kReq = crop.potassiumRequirement;
                if (avgK >= kReq * 0.8 && avgK <= kReq * 1.2) {
                    score += 20;
                } else {
                    const kDiff = Math.abs(avgK - kReq);
                    score += Math.max(0, 20 - (kDiff / 8));
                }
            }

            // Organic matter compatibility (10%)
            if (crop.organicMatterRequirement && avgOM) {
                const omReq = crop.organicMatterRequirement;
                if (avgOM >= omReq * 0.8) {
                    score += 10;
                } else {
                    const omDiff = Math.abs(avgOM - omReq);
                    score += Math.max(0, 10 - (omDiff * 2));
                }
            }

            return {
                ...crop,
                score: Math.round(score),
                suitabilityPercentage: Math.round(score) + '%',
                confidence: score >= 80 ? 'HIGH' : score >= 60 ? 'MEDIUM' : 'LOW'
            };
        });

        // Sort by score
        scoredCrops.sort((a, b) => b.score - a.score);

        const top5 = scoredCrops.slice(0, 5).map((crop, index) => ({
            rank: index + 1,
            cropName: crop.cropName,
            scientificName: crop.scientificName,
            cropType: crop.cropType,
            suitabilityScore: crop.score,
            suitabilityPercentage: crop.suitabilityPercentage,
            confidence: crop.confidence,
            growthPeriod: crop.growingPeriodDays ? crop.growingPeriodDays + ' days' : 'Not specified',
            waterRequirement: crop.waterRequirement || 'Not specified',
            reasoning: this.getCropReasoning(crop, avgPh, avgN, avgP, avgK, avgOM),
            nutrientAdjustments: this.getRequiredAdjustments(crop, avgPh, avgN, avgP, avgK)
        }));

        const unsuitable = scoredCrops.filter(c => c.score < 40).map(c => c.cropName);

        return {
            topRecommendations: top5,
            unsuitableCrops: unsuitable,
            dataQuality: {
                samples: phStats.count,
                confidence: phStats.count >= 10 ? 'HIGH' : phStats.count >= 5 ? 'MEDIUM' : 'LOW'
            },
            diversificationAdvice: this.getDiversificationAdvice(top5)
        };

    } catch (error) {
        console.error('[AI ENGINE] Error loading crops:', error);
        return { error: 'Failed to load crop data from database: ' + error.message };
    }
}






    getCropReasoning(crop, ph, n, p, k, om) {
        const reasons = [];

        if (crop.optimalPhMin && crop.optimalPhMax && ph >= crop.optimalPhMin && ph <= crop.optimalPhMax) {
            reasons.push('Optimal pH range');
        }
        if (crop.nitrogenRequirement && n >= crop.nitrogenRequirement * 0.8 && n <= crop.nitrogenRequirement * 1.2) {
            reasons.push('Adequate nitrogen levels');
        }
        if (crop.phosphorusRequirement && p >= crop.phosphorusRequirement * 0.8 && p <= crop.phosphorusRequirement * 1.2) {
            reasons.push('Sufficient phosphorus');
        }
        if (crop.potassiumRequirement && k >= crop.potassiumRequirement * 0.8 && k <= crop.potassiumRequirement * 1.2) {
            reasons.push('Good potassium availability');
        }
        if (crop.organicMatterRequirement && om && om >= crop.organicMatterRequirement * 0.8) {
            reasons.push('Suitable organic matter content');
        }

        return reasons.length > 0 ? reasons.join(', ') : 'Soil requires amendments for this crop';
    }

    getRequiredAdjustments(crop, ph, n, p, k) {
        const adjustments = [];

        if (crop.optimalPhMin && ph < crop.optimalPhMin) {
            adjustments.push(`Increase pH by ${(crop.optimalPhMin - ph).toFixed(1)} units (apply lime)`);
        } else if (crop.optimalPhMax && ph > crop.optimalPhMax) {
            adjustments.push(`Decrease pH by ${(ph - crop.optimalPhMax).toFixed(1)} units (apply sulfur)`);
        }

        if (crop.nitrogenRequirement && n < crop.nitrogenRequirement * 0.8) {
            adjustments.push(`Add ${Math.round(crop.nitrogenRequirement * 0.8 - n)} ppm nitrogen`);
        }
        if (crop.phosphorusRequirement && p < crop.phosphorusRequirement * 0.8) {
            adjustments.push(`Add ${Math.round(crop.phosphorusRequirement * 0.8 - p)} ppm phosphorus`);
        }
        if (crop.potassiumRequirement && k < crop.potassiumRequirement * 0.8) {
            adjustments.push(`Add ${Math.round(crop.potassiumRequirement * 0.8 - k)} ppm potassium`);
        }

        return adjustments.length > 0 ? adjustments : ['No major adjustments needed'];
    }

    getDiversificationAdvice(topCrops) {
        const categories = [...new Set(topCrops.map(c => c.cropType))];

        if (categories.length >= 3) {
            return 'Excellent diversification potential. Consider crop rotation with different crop types for soil health.';
        } else if (categories.length === 2) {
            return 'Good diversification options available. Include legumes in rotation to improve soil nitrogen naturally.';
        }
        return 'Limited crop diversity. Focus on soil improvement to expand suitable crop options.';
    }



// ==================== YIELD PREDICTION MODEL ====================
async predictYields(cropName) {
    const phStats = this.calculateStatistics('phLevel');
    const nStats = this.calculateStatistics('nitrogen');
    const pStats = this.calculateStatistics('phosphorus');
    const kStats = this.calculateStatistics('potassium');
    const omStats = this.calculateStatistics('organicMatter');
    const moistureStats = this.calculateStatistics('moisture');

    if (!phStats || !nStats || !pStats || !kStats) {
        return { error: 'Insufficient data for yield prediction' };
    }

    // Load crop data for yield prediction
    try {
        const cropsResponse = await fetch('http://localhost:1010/api/v1/crops/all');
        if (!cropsResponse.ok) {
            throw new Error('Failed to load crop data for yield prediction');
        }

        const responseData = await cropsResponse.json();

        // **FIX: Extraire le tableau de crops depuis ApiResponse**
        let availableCrops = [];

        if (responseData.data && Array.isArray(responseData.data)) {
            availableCrops = responseData.data;
        } else if (Array.isArray(responseData)) {
            availableCrops = responseData;
        } else if (responseData.content && Array.isArray(responseData.content)) {
            availableCrops = responseData.content;
        } else {
            console.error('[AI ENGINE] Unexpected crops API response:', responseData);
            throw new Error('Invalid crops data format');
        }

        const crop = availableCrops.find(c => c.cropName === cropName);
        if (!crop) {
            return { error: `Crop '${cropName}' not found in database` };
        }

        const baseYield = crop.expectedYield || 3000;

        // Calculate yield factors
        const phFactor = this.calculatePhFactor(phStats.mean, crop.optimalPhMin, crop.optimalPhMax);
        const nutrientFactor = this.calculateNutrientFactor(nStats.mean, pStats.mean, kStats.mean, crop);
        const omFactor = omStats ? Math.min(1.20, 0.85 + (omStats.mean / 10)) : 1.0;
        const moistureFactor = moistureStats ? this.calculateMoistureFactor(moistureStats.mean) : 0.9;

        const predictedYield = baseYield * phFactor * nutrientFactor * omFactor * moistureFactor;
        const maxPotentialYield = baseYield * 1.25;

        const limitingFactors = [];
        if (phFactor < 0.85) limitingFactors.push({ factor: 'pH level', impact: 'High', correction: `Adjust pH to ${crop.optimalPhMin}-${crop.optimalPhMax} range` });
        if (nutrientFactor < 0.75) limitingFactors.push({ factor: 'Nutrient availability', impact: 'High', correction: 'Apply balanced NPK fertilizer' });
        if (omFactor < 0.90) limitingFactors.push({ factor: 'Organic matter', impact: 'Medium', correction: 'Add 5-10 tons/ha compost or manure' });
        if (moistureFactor < 0.85) limitingFactors.push({ factor: 'Soil moisture', impact: 'Medium', correction: 'Improve irrigation or drainage' });

        return {
            cropName: cropName,
            predictedYield: Math.round(predictedYield),
            maxPotentialYield: Math.round(maxPotentialYield),
            achievementRate: ((predictedYield / maxPotentialYield) * 100).toFixed(1) + '%',
            unit: 'kg/ha',
            yieldGap: Math.round(maxPotentialYield - predictedYield),
            limitingFactors: limitingFactors,
            productionFactors: {
                pH: (phFactor * 100).toFixed(0) + '%',
                nutrients: (nutrientFactor * 100).toFixed(0) + '%',
                organicMatter: (omFactor * 100).toFixed(0) + '%',
                moisture: (moistureFactor * 100).toFixed(0) + '%'
            },
            recommendations: this.getYieldImprovementRecommendations(limitingFactors),
            confidence: this.calculatePredictionConfidence(phStats.count, phStats.cv)
        };

    } catch (error) {
        console.error('[AI ENGINE] Error in yield prediction:', error);
        return { error: 'Failed to predict yield: ' + error.message };
    }
}





    calculatePhFactor(ph, optimalMin, optimalMax) {
        if (!optimalMin || !optimalMax) {
            // Default calculation if crop data is missing
            if (ph >= 6.0 && ph <= 7.5) return 1.0;
            if (ph >= 5.5 && ph < 6.0) return 0.88;
            if (ph > 7.5 && ph <= 8.0) return 0.88;
            return 0.72;
        }

        if (ph >= optimalMin && ph <= optimalMax) return 1.0;
        if (ph >= optimalMin - 0.5 && ph < optimalMin) return 0.88;
        if (ph > optimalMax && ph <= optimalMax + 0.5) return 0.88;
        if (ph >= optimalMin - 1.0 && ph < optimalMin - 0.5) return 0.72;
        if (ph > optimalMax + 0.5 && ph <= optimalMax + 1.0) return 0.75;
        return 0.55;
    }

    calculateNutrientFactor(n, p, k, crop) {
        let nScore = 1.0, pScore = 1.0, kScore = 1.0;

        if (crop.nitrogenRequirement) {
            const nReq = crop.nitrogenRequirement;
            nScore = Math.min(1, n / nReq);
        }

        if (crop.phosphorusRequirement) {
            const pReq = crop.phosphorusRequirement;
            pScore = Math.min(1, p / pReq);
        }

        if (crop.potassiumRequirement) {
            const kReq = crop.potassiumRequirement;
            kScore = Math.min(1, k / kReq);
        }

        return (nScore * 0.35 + pScore * 0.30 + kScore * 0.35);
    }

    calculateMoistureFactor(moisture) {
        if (moisture >= 25 && moisture <= 45) return 1.0;
        if (moisture >= 20 && moisture < 25) return 0.90;
        if (moisture > 45 && moisture <= 60) return 0.88;
        if (moisture >= 15 && moisture < 20) return 0.75;
        if (moisture > 60 && moisture <= 70) return 0.75;
        return 0.60;
    }

    getYieldImprovementRecommendations(limitingFactors) {
        if (limitingFactors.length === 0) {
            return ['Maintain current excellent soil management practices', 'Focus on optimal planting density and timing', 'Ensure proper pest and disease control'];
        }
        return limitingFactors.map(f => f.correction);
    }

    calculatePredictionConfidence(sampleCount, cv) {
        if (sampleCount >= 15 && cv < 20) return 'VERY HIGH (90-95%)';
        if (sampleCount >= 10 && cv < 30) return 'HIGH (80-90%)';
        if (sampleCount >= 5 && cv < 40) return 'MEDIUM (70-80%)';
        return 'LOW (60-70%)';
    }

    // ==================== DISEASE RISK ANALYSIS ====================
    async analyzeDiseaseRisks() {
        const phStats = this.calculateStatistics('phLevel');
        const moistureStats = this.calculateStatistics('moisture');
        const omStats = this.calculateStatistics('organicMatter');
        const ecStats = this.calculateStatistics('electricalConductivity');

        if (!phStats) {
            return { error: 'Insufficient data for disease risk analysis' };
        }

        const risks = [];
        const avgPh = phStats.mean;
        const avgMoisture = moistureStats ? moistureStats.mean : 30;
        const avgOM = omStats ? omStats.mean : 2.5;
        const avgEC = ecStats ? ecStats.mean : 1.0;

        // Fungal disease risk
        if (avgMoisture > 45 || (avgMoisture > 35 && avgOM > 4)) {
            const riskLevel = avgMoisture > 55 ? 85 : avgMoisture > 45 ? 70 : 55;
            risks.push({
                diseaseType: 'Fungal Infections (Root Rot, Leaf Blight)',
                riskLevel: riskLevel > 75 ? 'CRITICAL' : riskLevel > 60 ? 'HIGH' : 'MEDIUM',
                probability: riskLevel + '%',
                symptoms: 'Yellowing leaves, wilting, root decay, leaf spots, stem lesions',
                affectedCrops: 'Most vegetables and field crops',
                prevention: [
                    'Improve soil drainage immediately',
                    'Reduce irrigation frequency by 30-40%',
                    'Apply fungicide preventatively',
                    'Increase plant spacing for better air circulation'
                ],
                soilConditions: `High moisture (${avgMoisture.toFixed(1)}%), organic matter ${avgOM.toFixed(1)}%`
            });
        }

        // Bacterial disease risk
        if (avgPh > 7.5 && avgMoisture > 35) {
            const riskLevel = avgPh > 8.0 ? 75 : 60;
            risks.push({
                diseaseType: 'Bacterial Wilt & Soft Rot',
                riskLevel: riskLevel > 70 ? 'HIGH' : 'MEDIUM',
                probability: riskLevel + '%',
                symptoms: 'Sudden wilting, yellowing, slimy stem base, foul odor',
                affectedCrops: 'Tomatoes, peppers, potatoes, eggplant',
                prevention: [
                    'Lower soil pH to 6.5-7.0 using sulfur (200-300 kg/ha)',
                    'Improve drainage systems',
                    'Practice 3-4 year crop rotation'
                ],
                soilConditions: `Alkaline pH (${avgPh.toFixed(1)}), moisture ${avgMoisture.toFixed(1)}%`
            });
        }

        // Aluminum toxicity (acidic soils)
        if (avgPh < 5.5) {
            const riskLevel = avgPh < 5.0 ? 90 : 75;
            risks.push({
                diseaseType: 'Aluminum Toxicity & Nutrient Lockup',
                riskLevel: riskLevel > 85 ? 'CRITICAL' : 'HIGH',
                probability: riskLevel + '%',
                symptoms: 'Stunted root growth, yellowing, poor nutrient uptake, leaf tip burn',
                affectedCrops: 'All crops except acid-tolerant varieties',
                prevention: [
                    'Apply agricultural lime immediately (3-4 tons/ha)',
                    'Add dolomitic lime for calcium and magnesium',
                    'Incorporate organic matter (compost 5-10 tons/ha)'
                ],
                soilConditions: `Very acidic pH (${avgPh.toFixed(1)})`
            });
        }

        // Calculate overall risk
        let overallRisk = 'LOW';
        if (risks.some(r => r.riskLevel === 'CRITICAL')) overallRisk = 'CRITICAL';
        else if (risks.some(r => r.riskLevel === 'HIGH')) overallRisk = 'HIGH';
        else if (risks.length > 0) overallRisk = 'MEDIUM';

        return {
            overallRisk: overallRisk,
            totalRisksDetected: risks.length,
            detectedRisks: risks,
            dataQuality: {
                samples: phStats.count,
                confidence: phStats.count >= 10 ? 'HIGH' : 'MEDIUM'
            },
            generalRecommendation: this.getGeneralDiseaseRecommendation(overallRisk, risks)
        };
    }

    getGeneralDiseaseRecommendation(overallRisk, risks) {
        if (overallRisk === 'CRITICAL') {
            return 'URGENT ACTION REQUIRED: Multiple critical soil health issues detected. Address these problems immediately before planting.';
        } else if (overallRisk === 'HIGH') {
            return 'HIGH PRIORITY: Significant disease risks identified. Implement corrective measures within 2-4 weeks.';
        } else if (risks.length > 0) {
            return 'MODERATE ATTENTION NEEDED: Some disease risk factors present. Address issues preventatively.';
        }
        return 'EXCELLENT: Soil conditions are favorable for healthy crop growth. Maintain current soil management practices.';
    }

    // ==================== COMPREHENSIVE ANALYSIS ====================
    async generateComprehensiveAnalysis() {
        console.log('[AI ENGINE] Generating comprehensive analysis from database...');

        // Load fresh data from database
        await this.loadRealDataFromDatabase();

        // Validate data
        const validation = this.validateData();
        if (!validation.valid) {
            return {
                error: true,
                message: validation.message,
                farmId: this.farmId
            };
        }

        try {
            // Run all analysis modules in parallel
            const [phAnalysis, nutrientOptimization, cropRecommendations, diseaseRisks] = await Promise.all([
                this.predictPhTrends(),
                this.optimizeNutrients(),
                this.recommendCrops(),
                this.analyzeDiseaseRisks()
            ]);

            // Get yield predictions for top 3 recommended crops
            let yieldPredictions = [];
            if (cropRecommendations.topRecommendations && !cropRecommendations.error) {
                const topCrops = cropRecommendations.topRecommendations.slice(0, 3);
                yieldPredictions = await Promise.all(
                    topCrops.map(crop => this.predictYields(crop.cropName))
                );
            }

            // Calculate soil health score
            const healthScore = this.calculateSoilHealthScore();

            return {
                success: true,
                farmId: this.farmId,
                farmName: this.farmData ? this.farmData.farmName : 'Unknown Farm',
                analysisDate: new Date().toISOString(),
                dataQuality: validation,

                phAnalysis: phAnalysis,
                nutrientOptimization: nutrientOptimization,
                cropRecommendations: cropRecommendations,
                yieldPredictions: yieldPredictions,
                diseaseRisks: diseaseRisks,
                soilHealthScore: healthScore,

                summary: this.generateExecutiveSummary(healthScore, diseaseRisks, cropRecommendations),
                actionPlan: this.generateActionPlan(nutrientOptimization, diseaseRisks, phAnalysis)
            };

        } catch (error) {
            console.error('[AI ENGINE] Error in comprehensive analysis:', error);
            return {
                error: true,
                message: 'Analysis failed: ' + error.message,
                farmId: this.farmId
            };
        }
    }

    // ==================== SOIL HEALTH SCORE CALCULATION ====================
    calculateSoilHealthScore() {
        const phStats = this.calculateStatistics('phLevel');
        const nStats = this.calculateStatistics('nitrogen');
        const pStats = this.calculateStatistics('phosphorus');
        const kStats = this.calculateStatistics('potassium');
        const omStats = this.calculateStatistics('organicMatter');
        const porosityStats = this.calculateStatistics('porosity');

        let totalScore = 0;
        let maxScore = 0;
        const components = {};

        // pH Score (20 points)
        if (phStats) {
            maxScore += 20;
            const ph = phStats.mean;
            if (ph >= 6.0 && ph <= 7.5) {
                totalScore += 20;
                components.pH = { score: 20, status: 'Optimal', value: ph.toFixed(2) };
            } else if ((ph >= 5.5 && ph < 6.0) || (ph > 7.5 && ph <= 8.0)) {
                totalScore += 14;
                components.pH = { score: 14, status: 'Acceptable', value: ph.toFixed(2) };
            } else {
                totalScore += 3;
                components.pH = { score: 3, status: 'Critical', value: ph.toFixed(2) };
            }
        }

        // NPK Score (30 points)
        if (nStats && pStats && kStats) {
            maxScore += 30;
            let npkScore = 0;

            // Nitrogen (10 points)
            if (nStats.mean >= 80 && nStats.mean <= 150) npkScore += 10;
            else if (nStats.mean >= 60 || nStats.mean <= 180) npkScore += 7;
            else if (nStats.mean >= 40) npkScore += 4;

            // Phosphorus (10 points)
            if (pStats.mean >= 40 && pStats.mean <= 80) npkScore += 10;
            else if (pStats.mean >= 25 || pStats.mean <= 100) npkScore += 7;
            else if (pStats.mean >= 15) npkScore += 4;

            // Potassium (10 points)
            if (kStats.mean >= 120 && kStats.mean <= 200) npkScore += 10;
            else if (kStats.mean >= 80 || kStats.mean <= 250) npkScore += 7;
            else if (kStats.mean >= 50) npkScore += 4;

            totalScore += npkScore;
            components.nutrients = {
                score: npkScore,
                status: npkScore >= 24 ? 'Optimal' : npkScore >= 18 ? 'Good' : npkScore >= 12 ? 'Fair' : 'Poor',
                N: nStats.mean.toFixed(1),
                P: pStats.mean.toFixed(1),
                K: kStats.mean.toFixed(1)
            };
        }

        // Organic Matter Score (25 points)
        if (omStats) {
            maxScore += 25;
            const om = omStats.mean;
            if (om >= 4.0) {
                totalScore += 25;
                components.organicMatter = { score: 25, status: 'Excellent', value: om.toFixed(2) + '%' };
            } else if (om >= 3.0) {
                totalScore += 20;
                components.organicMatter = { score: 20, status: 'Good', value: om.toFixed(2) + '%' };
            } else if (om >= 2.0) {
                totalScore += 14;
                components.organicMatter = { score: 14, status: 'Fair', value: om.toFixed(2) + '%' };
            } else {
                totalScore += 3;
                components.organicMatter = { score: 3, status: 'Low', value: om.toFixed(2) + '%' };
            }
        }

        // Data Quality Score (10 points)
        maxScore += 10;
        const sampleCount = this.soilData.length;
        if (sampleCount >= 15) {
            totalScore += 10;
            components.dataQuality = { score: 10, status: 'Excellent', samples: sampleCount };
        } else if (sampleCount >= 10) {
            totalScore += 8;
            components.dataQuality = { score: 8, status: 'Good', samples: sampleCount };
        } else if (sampleCount >= 5) {
            totalScore += 6;
            components.dataQuality = { score: 6, status: 'Fair', samples: sampleCount };
        } else {
            totalScore += 3;
            components.dataQuality = { score: 3, status: 'Limited', samples: sampleCount };
        }

        const finalScore = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;

        let overallRating = 'Poor';
        let ratingColor = '#ef4444';
        if (finalScore >= 85) {
            overallRating = 'Excellent';
            ratingColor = '#22c55e';
        } else if (finalScore >= 70) {
            overallRating = 'Good';
            ratingColor = '#3b82f6';
        } else if (finalScore >= 55) {
            overallRating = 'Fair';
            ratingColor = '#f59e0b';
        } else if (finalScore >= 40) {
            overallRating = 'Needs Improvement';
            ratingColor = '#f97316';
        }

        return {
            overallScore: finalScore,
            overallRating: overallRating,
            ratingColor: ratingColor,
            components: components,
            interpretation: this.getHealthScoreInterpretation(finalScore)
        };
    }

    getHealthScoreInterpretation(score) {
        if (score >= 85) {
            return 'Your soil is in excellent condition. Continue current management practices and focus on maintaining soil health through regular testing and organic matter additions.';
        } else if (score >= 70) {
            return 'Your soil is in good condition. Minor improvements in nutrient management or pH adjustment can help achieve optimal productivity.';
        } else if (score >= 55) {
            return 'Your soil is fair but has room for improvement. Focus on addressing nutrient deficiencies and increasing organic matter content.';
        } else if (score >= 40) {
            return 'Your soil needs improvement. Implement soil amendments, organic matter additions, and balanced fertilization to improve productivity.';
        }
        return 'Your soil requires significant improvement. Consider comprehensive soil remediation including pH correction, organic matter addition, and nutrient balancing before planting.';
    }

    // ==================== EXECUTIVE SUMMARY ====================
    generateExecutiveSummary(healthScore, diseaseRisks, cropRecommendations) {
        const summary = {
            overallHealth: healthScore.overallRating,
            healthScore: healthScore.overallScore,
            riskLevel: diseaseRisks.overallRisk,
            topCrop: cropRecommendations.topRecommendations && !cropRecommendations.error ?
                     cropRecommendations.topRecommendations[0].cropName : 'N/A',
            keyFindings: [],
            urgentActions: []
        };

        // Key findings
        if (healthScore.overallScore >= 80) {
            summary.keyFindings.push('Soil is in excellent condition for agricultural production');
        } else if (healthScore.overallScore < 55) {
            summary.keyFindings.push('Soil requires significant improvement before optimal production');
        }

        if (diseaseRisks.totalRisksDetected > 0) {
            summary.keyFindings.push(`${diseaseRisks.totalRisksDetected} disease risk factor(s) identified`);
        }

        if (cropRecommendations.topRecommendations && !cropRecommendations.error &&
            cropRecommendations.topRecommendations[0].suitabilityScore >= 80) {
            summary.keyFindings.push(`Excellent suitability for ${cropRecommendations.topRecommendations[0].cropName}`);
        }

        // Urgent actions
        if (diseaseRisks.overallRisk === 'CRITICAL' || diseaseRisks.overallRisk === 'HIGH') {
            summary.urgentActions.push('Address disease risk factors immediately');
        }

        if (healthScore.components.pH && healthScore.components.pH.score < 10) {
            summary.urgentActions.push('Correct soil pH urgently');
        }

        if (healthScore.components.nutrients && healthScore.components.nutrients.score < 15) {
            summary.urgentActions.push('Apply balanced fertilizer program');
        }

        if (summary.urgentActions.length === 0) {
            summary.urgentActions.push('No urgent actions required - maintain current practices');
        }

        return summary;
    }

    // ==================== ACTION PLAN GENERATOR ====================
    generateActionPlan(nutrientOptimization, diseaseRisks, phAnalysis) {
        const actionPlan = {
            immediate: [],
            shortTerm: [],
            longTerm: []
        };

        // Immediate actions (0-2 weeks)
        if (diseaseRisks.overallRisk === 'CRITICAL') {
            diseaseRisks.detectedRisks.forEach(risk => {
                if (risk.riskLevel === 'CRITICAL') {
                    actionPlan.immediate.push({
                        action: `Address ${risk.diseaseType}`,
                        priority: 'CRITICAL',
                        timeframe: 'Immediate',
                        steps: risk.prevention.slice(0, 2)
                    });
                }
            });
        }

        if (phAnalysis.currentPh && (phAnalysis.currentPh < 5.5 || phAnalysis.currentPh > 8.0)) {
            actionPlan.immediate.push({
                action: 'Correct soil pH',
                priority: 'HIGH',
                timeframe: '1-2 weeks',
                steps: [phAnalysis.recommendation]
            });
        }

        // Short-term actions (2-8 weeks)
        if (nutrientOptimization.urgency === 'HIGH' || nutrientOptimization.urgency === 'CRITICAL') {
            actionPlan.shortTerm.push({
                action: 'Apply fertilizer program',
                priority: nutrientOptimization.urgency,
                timeframe: '2-4 weeks',
                steps: [
                    `Apply ${nutrientOptimization.fertilizerRecommendations.urea_46N} kg/ha Urea`,
                    `Apply ${nutrientOptimization.fertilizerRecommendations.dap_18_46_0} kg/ha DAP`,
                    `Apply ${nutrientOptimization.fertilizerRecommendations.mop_0_0_60} kg/ha MOP`,
                    'Follow split application schedule'
                ]
            });
        }

        if (diseaseRisks.detectedRisks.length > 0) {
            actionPlan.shortTerm.push({
                action: 'Implement disease prevention measures',
                priority: 'MEDIUM',
                timeframe: '2-6 weeks',
                steps: diseaseRisks.detectedRisks[0].prevention.slice(0, 3)
            });
        }

        // Long-term actions (2-12 months)
        actionPlan.longTerm.push({
            action: 'Improve soil organic matter',
            priority: 'MEDIUM',
            timeframe: '3-6 months',
            steps: [
                'Add 5-10 tons/ha compost or well-decomposed manure',
                'Incorporate crop residues after harvest',
                'Use cover crops in rotation'
            ]
        });

        return actionPlan;
    }
}

// ==================== 2. UI RENDERING FUNCTIONS ====================

async function initializeAIAnalysis(farmId) {
    console.log('[UI] Initializing AI Analysis for farm:', farmId);

    const container = document.getElementById('aiPredictionsContainer');

    if (!container) {
        console.error('[UI] AI container not found');
        return;
    }

    // Show loading state
    container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="display: inline-block; width: 50px; height: 50px; border: 5px solid #f3f4f6; border-top: 5px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <p style="margin-top: 20px; font-size: 16px; color: #6b7280;">Loading real-time data from database...</p>
            <p style="font-size: 14px; color: #9ca3af;">Running AI analysis models...</p>
        </div>
    `;

    try {
        // Initialize AI Engine with real database data
        const aiEngine = new SoilDataAIEngine(farmId);

        // Generate comprehensive analysis
        const analysis = await aiEngine.generateComprehensiveAnalysis();

        if (analysis.error) {
            container.innerHTML = `
                <div class="ai-prediction-card" style="background: #fee2e2; border-left: 4px solid #dc2626;">
                    <div class="prediction-title" style="color: #dc2626;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Unable to Generate AI Analysis
                    </div>
                    <div class="prediction-content">
                        <p>${analysis.message}</p>
                        <p style="margin-top: 12px;">Please ensure you have soil test data in the database with at least pH, Nitrogen, Phosphorus, and Potassium measurements.</p>
                    </div>
                </div>
            `;
            return;
        }

        // Render comprehensive analysis
        renderAIAnalysis(analysis);

    } catch (error) {
        console.error('[UI] Error generating AI analysis:', error);
        container.innerHTML = `
            <div class="ai-prediction-card" style="background: #fee2e2; border-left: 4px solid #dc2626;">
                <div class="prediction-title" style="color: #dc2626;">
                    <i class="fas fa-exclamation-circle"></i>
                    Error Loading Analysis
                </div>
                <div class="prediction-content">
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p style="margin-top: 12px;">Please check your backend connection and ensure the API is running at: ${API_CONFIG.BASE_URL}</p>
                </div>
            </div>
        `;
    }
}

function renderAIAnalysis(analysis) {
    const container = document.getElementById('aiPredictionsContainer');

    const html = `
        <!-- Header Card -->
        <div class="ai-prediction-card" style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border: none;">
            <div class="prediction-title" style="color: white; font-size: 20px;">
                <i class="fas fa-brain"></i>
                AI-Powered Soil Analysis Report
            </div>
            <div class="prediction-content" style="color: white;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div>
                        <strong>Farm:</strong> ${analysis.farmName}<br>
                        <strong>Analysis Date:</strong> ${new Date(analysis.analysisDate).toLocaleDateString()}
                    </div>
                    <div>
                        <strong>Data Quality:</strong> ${analysis.dataQuality.completeness}%<br>
                        <strong>Total Samples:</strong> ${analysis.dataQuality.validSamples}/${analysis.dataQuality.totalSamples}
                    </div>
                    <div>
                        <strong>Soil Health:</strong> ${analysis.soilHealthScore.overallRating}<br>
                        <strong>Risk Level:</strong> ${analysis.diseaseRisks.overallRisk}
                    </div>
                </div>
            </div>
        </div>

        <!-- Executive Summary -->
        ${renderExecutiveSummary(analysis.summary)}

        <!-- Soil Health Score -->
        ${renderSoilHealthScore(analysis.soilHealthScore)}

        <!-- pH Analysis -->
        ${analysis.phAnalysis && !analysis.phAnalysis.error ? renderPhAnalysis(analysis.phAnalysis) : ''}

        <!-- Nutrient Optimization -->
        ${analysis.nutrientOptimization && !analysis.nutrientOptimization.error ? renderNutrientOptimization(analysis.nutrientOptimization) : ''}

        <!-- Crop Recommendations -->
        ${analysis.cropRecommendations && !analysis.cropRecommendations.error ? renderCropRecommendations(analysis.cropRecommendations) : ''}

        <!-- Yield Predictions -->
        ${analysis.yieldPredictions && analysis.yieldPredictions.length > 0 ? renderYieldPredictions(analysis.yieldPredictions) : ''}

        <!-- Disease Risk Analysis -->
        ${renderDiseaseRisks(analysis.diseaseRisks)}

        <!-- Action Plan -->
        ${renderActionPlan(analysis.actionPlan)}
    `;

    container.innerHTML = html;
    console.log('[UI] AI Analysis rendered successfully');
}

function renderExecutiveSummary(summary) {
    return `
        <div class="ai-prediction-card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-left: 4px solid #22c55e;">
            <div class="prediction-title">
                <i class="fas fa-clipboard-check" style="color: #16a34a;"></i>
                Executive Summary
            </div>
            <div class="prediction-content">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px;">
                    <div style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Overall Soil Health</div>
                        <div style="font-size: 24px; font-weight: 700; color: #16a34a;">${summary.overallHealth}</div>
                        <div style="font-size: 16px; color: #6b7280;">${summary.healthScore}/100</div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Disease Risk Level</div>
                        <div style="font-size: 24px; font-weight: 700; color: ${summary.riskLevel === 'CRITICAL' ? '#dc2626' : summary.riskLevel === 'HIGH' ? '#f59e0b' : '#22c55e'};">${summary.riskLevel}</div>
                    </div>
                    <div style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="font-size: 14px; color: #6b7280; margin-bottom: 4px;">Top Recommended Crop</div>
                        <div style="font-size: 20px; font-weight: 700; color: #1e40af;">${summary.topCrop}</div>
                    </div>
                </div>

                <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                    <strong style="color: #1f2937;">🔍 Key Findings:</strong>
                    <ul style="margin: 8px 0; padding-left: 24px; line-height: 1.8;">
                        ${summary.keyFindings.map(finding => `<li>${finding}</li>`).join('')}
                    </ul>
                </div>

                <div style="background: ${summary.urgentActions[0].includes('No urgent') ? '#dcfce7' : '#fef3c7'}; padding: 16px; border-radius: 8px;">
                    <strong style="color: #1f2937;">⚡ Urgent Actions Required:</strong>
                    <ul style="margin: 8px 0; padding-left: 24px; line-height: 1.8;">
                        ${summary.urgentActions.map(action => `<li>${action}</li>`).join('')}
                    </ul>
                </div>
            </div>
        </div>
    `;
}

function renderSoilHealthScore(healthScore) {
    return `
        <div class="ai-prediction-card">
            <div class="prediction-title">
                <i class="fas fa-heartbeat" style="color: ${healthScore.ratingColor};"></i>
                Comprehensive Soil Health Score
            </div>
            <div class="prediction-content">
                <div style="text-align: center; margin-bottom: 24px;">
                    <div style="display: inline-block; position: relative; width: 200px; height: 200px;">
                        <svg width="200" height="200" style="transform: rotate(-90deg);">
                            <circle cx="100" cy="100" r="80" fill="none" stroke="#e5e7eb" stroke-width="20"/>
                            <circle cx="100" cy="100" r="80" fill="none" stroke="${healthScore.ratingColor}" stroke-width="20"
                                    stroke-dasharray="${(healthScore.overallScore / 100) * 502.4} 502.4"
                                    stroke-linecap="round"/>
                        </svg>
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div style="font-size: 48px; font-weight: 700; color: ${healthScore.ratingColor};">${healthScore.overallScore}</div>
                            <div style="font-size: 16px; color: #6b7280;">out of 100</div>
                        </div>
                    </div>
                    <div style="font-size: 24px; font-weight: 600; color: ${healthScore.ratingColor}; margin-top: 16px;">
                        ${healthScore.overallRating}
                    </div>
                </div>

                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <strong>Components Breakdown:</strong>
                    <div style="margin-top: 12px;">
                        ${Object.entries(healthScore.components).map(([key, component]) => `
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                    <span style="font-weight: 600; text-transform: capitalize;">${key.replace(/([A-Z])/g, ' $1').trim()}</span>
                                    <span style="color: #6b7280;">${component.status}</span>
                                </div>
                                <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: ${component.score >= 18 ? '#22c55e' : component.score >= 12 ? '#f59e0b' : '#ef4444'};
                                                height: 100%; width: ${(component.score / 25) * 100}%; border-radius: 4px;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div style="background: #e0f2fe; padding: 16px; border-radius: 8px;">
                    <strong>💡 Interpretation:</strong>
                    <p style="margin-top: 8px; line-height: 1.6;">${healthScore.interpretation}</p>
                </div>
            </div>
        </div>
    `;
}

function renderPhAnalysis(phAnalysis) {
    return `
        <div class="ai-prediction-card">
            <div class="prediction-title">
                <i class="fas fa-flask" style="color: #3b82f6;"></i>
                pH Level Prediction & Trend Analysis
            </div>
            <div class="prediction-content">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                    <div style="background: #f0f9ff; padding: 12px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Current pH</div>
                        <div style="font-size: 24px; font-weight: 700; color: #3b82f6;">${phAnalysis.currentPh}</div>
                    </div>
                    <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Predicted pH</div>
                        <div style="font-size: 24px; font-weight: 700; color: #16a34a;">${phAnalysis.predictedPh}</div>
                    </div>
                    <div style="background: ${phAnalysis.trend === 'increasing' ? '#dcfce7' : '#fef3c7'}; padding: 12px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Trend</div>
                        <div style="font-size: 18px; font-weight: 700;">${phAnalysis.trend === 'increasing' ? '📈 Increasing' : '📉 Decreasing'}</div>
                    </div>
                    <div style="background: #f5f3ff; padding: 12px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Confidence</div>
                        <div style="font-size: 16px; font-weight: 600;">${phAnalysis.confidence}</div>
                    </div>
                </div>

                <div style="background: #fffbeb; padding: 14px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <strong>🔬 AI Recommendation:</strong>
                    <p style="margin-top: 8px;">${phAnalysis.recommendation}</p>
                    <p style="margin-top: 8px; font-size: 13px; color: #78350f;"><em>Timeframe: ${phAnalysis.timeframe}</em></p>
                </div>
            </div>
        </div>
    `;
}

function renderNutrientOptimization(nutrientOpt) {
    return `
        <div class="ai-prediction-card">
            <div class="prediction-title">
                <i class="fas fa-leaf" style="color: #22c55e;"></i>
                Nutrient Optimization Analysis
            </div>
            <div class="prediction-content">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div style="background: #f9fafb; padding: 14px; border-radius: 8px;">
                        <strong>Current NPK Levels (ppm):</strong>
                        <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                            <li>Nitrogen (N): ${nutrientOpt.currentNPK.nitrogen}</li>
                            <li>Phosphorus (P): ${nutrientOpt.currentNPK.phosphorus}</li>
                            <li>Potassium (K): ${nutrientOpt.currentNPK.potassium}</li>
                        </ul>
                    </div>
                    <div style="background: #f0fdf4; padding: 14px; border-radius: 8px;">
                        <strong>Target NPK Levels (ppm):</strong>
                        <ul style="margin: 8px 0; padding-left: 20px; line-height: 1.8;">
                            <li>Nitrogen (N): ${nutrientOpt.targetNPK.n}</li>
                            <li>Phosphorus (P): ${nutrientOpt.targetNPK.p}</li>
                            <li>Potassium (K): ${nutrientOpt.targetNPK.k}</li>
                        </ul>
                    </div>
                </div>

                <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <strong>🌱 Fertilizer Requirements (kg/ha):</strong>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 12px;">
                        <div style="background: white; padding: 12px; border-radius: 6px;">
                            <div style="font-size: 13px; color: #92400e; margin-bottom: 4px;">Urea (46% N)</div>
                            <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${nutrientOpt.fertilizerRecommendations.urea_46N}</div>
                            <div style="font-size: 12px; color: #6b7280;">kg/ha</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px;">
                            <div style="font-size: 13px; color: #92400e; margin-bottom: 4px;">DAP (18-46-0)</div>
                            <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${nutrientOpt.fertilizerRecommendations.dap_18_46_0}</div>
                            <div style="font-size: 12px; color: #6b7280;">kg/ha</div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px;">
                            <div style="font-size: 13px; color: #92400e; margin-bottom: 4px;">MOP (0-0-60)</div>
                            <div style="font-size: 24px; font-weight: 700; color: #1f2937;">${nutrientOpt.fertilizerRecommendations.mop_0_0_60}</div>
                            <div style="font-size: 12px; color: #6b7280;">kg/ha</div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <span style="padding: 8px 16px; border-radius: 20px; background: ${
                        nutrientOpt.urgency === 'CRITICAL' ? '#fee2e2' :
                        nutrientOpt.urgency === 'HIGH' ? '#fed7aa' :
                        nutrientOpt.urgency === 'MEDIUM' ? '#fef3c7' : '#dcfce7'
                    }; color: ${
                        nutrientOpt.urgency === 'CRITICAL' ? '#dc2626' :
                        nutrientOpt.urgency === 'HIGH' ? '#ea580c' :
                        nutrientOpt.urgency === 'MEDIUM' ? '#d97706' : '#16a34a'
                    }; font-weight: 600;">
                        ⚠️ Urgency: ${nutrientOpt.urgency}
                    </span>
                    <span style="padding: 8px 16px; border-radius: 20px; background: #f0f9ff; color: #1e40af; font-weight: 600;">
                        🎯 Confidence: ${nutrientOpt.dataQuality.confidence}
                    </span>
                </div>
            </div>
        </div>
    `;
}

function renderCropRecommendations(cropRec) {
    return `
        <div class="ai-prediction-card">
            <div class="prediction-title">
                <i class="fas fa-seedling" style="color: #16a34a;"></i>
                AI Crop Recommendation System
            </div>
            <div class="prediction-content">
                <strong>🌾 Top 5 Recommended Crops (Based on Real Soil Data):</strong>
                <div style="margin-top: 12px;">
                    ${cropRec.topRecommendations.map((rec, index) => `
                        <div style="background: ${index === 0 ? '#dcfce7' : '#f9fafb'}; padding: 14px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${
                            rec.confidence === 'HIGH' ? '#22c55e' : rec.confidence === 'MEDIUM' ? '#f59e0b' : '#ef4444'
                        };">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div>
                                    <strong style="font-size: 18px; color: #1f2937;">${rec.rank}. ${rec.cropName}</strong>
                                    ${rec.scientificName ? `<span style="margin-left: 8px; padding: 4px 8px; border-radius: 12px; background: #e0f2fe; color: #1e40af; font-size: 12px;">${rec.scientificName}</span>` : ''}
                                </div>
                                <span style="padding: 6px 14px; border-radius: 12px; background: white; font-weight: 700; font-size: 16px; color: #16a34a;">
                                    ${rec.suitabilityPercentage}
                                </span>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 13px; color: #4b5563; margin-bottom: 8px;">
                                <div><strong>Type:</strong> ${rec.cropType || 'Not specified'}</div>
                                <div><strong>Growth Period:</strong> ${rec.growthPeriod}</div>
                                <div><strong>Confidence:</strong> ${rec.confidence}</div>
                            </div>
                            <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                                <strong>Why Suitable:</strong> ${rec.reasoning}
                            </div>
                            ${rec.nutrientAdjustments[0] !== 'No major adjustments needed' ? `
                                <div style="background: #fef3c7; padding: 8px; border-radius: 6px; font-size: 13px;">
                                    <strong>⚠️ Required Adjustments:</strong>
                                    <ul style="margin: 4px 0; padding-left: 20px;">
                                        ${rec.nutrientAdjustments.map(adj => `<li>${adj}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : `
                                <div style="color: #16a34a; font-weight: 600; font-size: 13px;">✅ Soil perfectly suited - no adjustments needed</div>
                            `}
                            ${index === 0 ? '<div style="color: #16a34a; font-weight: 700; margin-top: 8px; font-size: 14px;">⭐ BEST MATCH FOR YOUR SOIL</div>' : ''}
                        </div>
                    `).join('')}
                </div>

                ${cropRec.unsuitableCrops && cropRec.unsuitableCrops.length > 0 ? `
                    <div style="background: #fee2e2; padding: 12px; border-radius: 8px; margin-top: 16px;">
                        <strong>❌ Not Recommended:</strong> ${cropRec.unsuitableCrops.join(', ')}
                        <p style="margin-top: 6px; font-size: 13px;">These crops have low suitability (&lt;40%) based on current soil conditions.</p>
                    </div>
                ` : ''}

                <div style="background: #f0f9ff; padding: 12px; border-radius: 8px; margin-top: 16px;">
                    <strong>🌿 Diversification Advice:</strong>
                    <p style="margin-top: 6px;">${cropRec.diversificationAdvice}</p>
                </div>
            </div>
        </div>
    `;
}


function renderYieldPredictions(yieldPredictions) {
    if (!yieldPredictions || yieldPredictions.length === 0) {
        return '';
    }

    return `
        <div class="ai-prediction-card">
            <div class="prediction-title">
                <i class="fas fa-chart-line" style="color: #8b5cf6;"></i>
                Yield Prediction Analysis
            </div>
            <div class="prediction-content">
                <strong>📊 Predicted Yields for Top Recommended Crops:</strong>
                <div style="margin-top: 12px;">
                    ${yieldPredictions.map((pred, index) => {
                        if (pred.error) {
                            return `
                                <div style="background: #fee2e2; padding: 14px; border-radius: 8px; margin-bottom: 10px;">
                                    <strong style="color: #dc2626;">${index + 1}. Error:</strong> ${pred.error}
                                </div>
                            `;
                        }

                        return `
                            <div style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #8b5cf6;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <strong style="font-size: 18px; color: #1f2937;">${index + 1}. ${pred.cropName}</strong>
                                    <span style="padding: 6px 14px; border-radius: 12px; background: #8b5cf6; color: white; font-weight: 700;">
                                        ${pred.predictedYield} ${pred.unit}
                                    </span>
                                </div>

                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px;">
                                    <div style="background: white; padding: 10px; border-radius: 6px;">
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Max Potential</div>
                                        <div style="font-size: 20px; font-weight: 700; color: #1f2937;">${pred.maxPotentialYield}</div>
                                        <div style="font-size: 12px; color: #6b7280;">${pred.unit}</div>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 6px;">
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Achievement Rate</div>
                                        <div style="font-size: 20px; font-weight: 700; color: #16a34a;">${pred.achievementRate}</div>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 6px;">
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Yield Gap</div>
                                        <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">${pred.yieldGap}</div>
                                        <div style="font-size: 12px; color: #6b7280;">${pred.unit}</div>
                                    </div>
                                </div>

                                <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                                    <strong style="font-size: 14px;">Production Factors:</strong>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; margin-top: 8px; font-size: 13px;">
                                        <div><strong>pH:</strong> ${pred.productionFactors.pH}</div>
                                        <div><strong>Nutrients:</strong> ${pred.productionFactors.nutrients}</div>
                                        <div><strong>Organic Matter:</strong> ${pred.productionFactors.organicMatter}</div>
                                        <div><strong>Moisture:</strong> ${pred.productionFactors.moisture}</div>
                                    </div>
                                </div>

                                ${pred.limitingFactors && pred.limitingFactors.length > 0 ? `
                                    <div style="background: #fef3c7; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                                        <strong style="font-size: 14px;">⚠️ Limiting Factors:</strong>
                                        <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px; line-height: 1.7;">
                                            ${pred.limitingFactors.map(factor => `
                                                <li><strong>${factor.factor}</strong> (${factor.impact} impact) - ${factor.correction}</li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                ` : `
                                    <div style="background: #dcfce7; padding: 12px; border-radius: 6px; margin-bottom: 10px; font-size: 14px; color: #16a34a; font-weight: 600;">
                                        ✅ No limiting factors - optimal conditions for maximum yield
                                    </div>
                                `}

                                <div style="background: #e0f2fe; padding: 12px; border-radius: 6px;">
                                    <strong style="font-size: 14px;">💡 Recommendations:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px; line-height: 1.7;">
                                        ${pred.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                    </ul>
                                    <div style="margin-top: 8px; font-size: 12px; color: #1e40af;">
                                        <strong>Confidence Level:</strong> ${pred.confidence}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;
}



function renderDiseaseRisks(diseaseRisks) {
    const getRiskBackgroundColor = () => {
        if (diseaseRisks.overallRisk === 'CRITICAL') return '#fee2e2';
        if (diseaseRisks.overallRisk === 'HIGH') return '#fed7aa';
        if (diseaseRisks.overallRisk === 'MEDIUM') return '#fef3c7';
        return '#dcfce7';
    };

    const getRiskEmoji = () => {
        if (diseaseRisks.overallRisk === 'CRITICAL') return '🚨';
        if (diseaseRisks.overallRisk === 'HIGH') return '⚠️';
        if (diseaseRisks.overallRisk === 'MEDIUM') return '⚡';
        return '✅';
    };

    const getRiskTextColor = () => {
        if (diseaseRisks.overallRisk === 'CRITICAL') return '#dc2626';
        if (diseaseRisks.overallRisk === 'HIGH') return '#ea580c';
        if (diseaseRisks.overallRisk === 'MEDIUM') return '#d97706';
        return '#16a34a';
    };

    const getRiskBorderColor = (riskLevel) => {
        if (riskLevel === 'CRITICAL') return '#dc2626';
        if (riskLevel === 'HIGH') return '#f59e0b';
        return '#3b82f6';
    };

    const getRiskBadgeBackground = (riskLevel) => {
        if (riskLevel === 'CRITICAL') return '#fee2e2';
        if (riskLevel === 'HIGH') return '#fed7aa';
        return '#bfdbfe';
    };

    const getRiskBadgeColor = (riskLevel) => {
        if (riskLevel === 'CRITICAL') return '#dc2626';
        if (riskLevel === 'HIGH') return '#ea580c';
        return '#1e40af';
    };

    return `
        <div class="ai-prediction-card">
            <div class="prediction-title">
                <i class="fas fa-shield-alt" style="color: #dc2626;"></i>
                Disease Risk Detection System
            </div>
            <div class="prediction-content">
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px; padding: 16px; background: ${getRiskBackgroundColor()}; border-radius: 8px;">
                    <div style="font-size: 64px;">
                        ${getRiskEmoji()}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 24px; font-weight: 700; color: ${getRiskTextColor()};">
                            Overall Risk: ${diseaseRisks.overallRisk}
                        </div>
                        <div style="font-size: 16px; color: #6b7280; margin-top: 4px;">
                            ${diseaseRisks.totalRisksDetected} disease risk factor(s) detected from soil analysis
                        </div>
                    </div>
                </div>

                ${diseaseRisks.detectedRisks.length > 0 ? `
                    <strong style="font-size: 16px;">🔬 Detected Disease Risks:</strong>
                    <div style="margin-top: 12px;">
                        ${diseaseRisks.detectedRisks.map(risk => `
                            <div style="background: #ffffff; padding: 16px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid ${getRiskBorderColor(risk.riskLevel)}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <strong style="font-size: 17px; color: #1f2937;">${risk.diseaseType}</strong>
                                    <span style="padding: 4px 12px; border-radius: 12px; background: ${getRiskBadgeBackground(risk.riskLevel)}; color: ${getRiskBadgeColor(risk.riskLevel)}; font-weight: 700; font-size: 12px; white-space: nowrap;">
                                        ${risk.riskLevel} (${risk.probability})
                                    </span>
                                </div>
                                <div style="background: #f9fafb; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 14px;">
                                    <strong>🔍 Symptoms:</strong> ${risk.symptoms}
                                </div>
                                <div style="background: #fffbeb; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 14px;">
                                    <strong>🌱 Affected Crops:</strong> ${risk.affectedCrops}
                                </div>
                                <div style="background: #e0f2fe; padding: 10px; border-radius: 6px; font-size: 14px;">
                                    <strong>🛡️ Prevention Measures:</strong>
                                    <ul style="margin: 6px 0; padding-left: 20px; line-height: 1.7;">
                                        ${risk.prevention.map(measure => `<li>${measure}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div style="background: #dcfce7; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 12px;">✅</div>
                        <strong style="color: #16a34a; font-size: 18px;">No Significant Disease Risks Detected</strong>
                        <p style="margin-top: 8px; font-size: 14px; color: #166534;">Your soil conditions are favorable for healthy crop growth with minimal disease pressure.</p>
                    </div>
                `}

                <div style="background: #f0f9ff; padding: 14px; border-radius: 8px; margin-top: 16px;">
                    <strong>📋 General Recommendation:</strong>
                    <p style="margin-top: 8px; line-height: 1.6;">${diseaseRisks.generalRecommendation}</p>
                </div>
            </div>
        </div>
    `;
}


function renderActionPlan(actionPlan) {
    return `
        <div class="ai-prediction-card">
            <div class="prediction-title">
                <i class="fas fa-tasks" style="color: #16a34a;"></i>
                Action Plan & Implementation Timeline
            </div>
            <div class="prediction-content">
                <!-- Immediate Actions -->
                ${actionPlan.immediate.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <div style="display: inline-block; padding: 6px 14px; background: #fee2e2; color: #dc2626; border-radius: 20px; font-weight: 700; margin-bottom: 12px;">
                            🚨 IMMEDIATE ACTIONS (0-2 weeks)
                        </div>
                        ${actionPlan.immediate.map(action => `
                            <div style="background: #fee2e2; padding: 14px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #dc2626;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong style="font-size: 16px; color: #1f2937;">${action.action}</strong>
                                    <span style="padding: 4px 12px; background: #dc2626; color: white; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                        ${action.priority}
                                    </span>
                                </div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                                    ⏱️ Timeframe: ${action.timeframe}
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <strong style="font-size: 13px;">Steps to take:</strong>
                                    <ul style="margin: 6px 0; padding-left: 20px; line-height: 1.7; font-size: 13px;">
                                        ${action.steps.map(step => `<li>${step}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <!-- Short-term Actions -->
                ${actionPlan.shortTerm.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <div style="display: inline-block; padding: 6px 14px; background: #fef3c7; color: #d97706; border-radius: 20px; font-weight: 700; margin-bottom: 12px;">
                            ⚡ SHORT-TERM ACTIONS (2-8 weeks)
                        </div>
                        ${actionPlan.shortTerm.map(action => `
                            <div style="background: #fef3c7; padding: 14px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #f59e0b;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong style="font-size: 16px; color: #1f2937;">${action.action}</strong>
                                    <span style="padding: 4px 12px; background: #f59e0b; color: white; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                        ${action.priority}
                                    </span>
                                </div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                                    ⏱️ Timeframe: ${action.timeframe}
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <strong style="font-size: 13px;">Steps to take:</strong>
                                    <ul style="margin: 6px 0; padding-left: 20px; line-height: 1.7; font-size: 13px;">
                                        ${action.steps.map(step => `<li>${step}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <!-- Long-term Actions -->
                ${actionPlan.longTerm.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <div style="display: inline-block; padding: 6px 14px; background: #dbeafe; color: #1e40af; border-radius: 20px; font-weight: 700; margin-bottom: 12px;">
                            📅 LONG-TERM ACTIONS (2-12 months)
                        </div>
                        ${actionPlan.longTerm.map(action => `
                            <div style="background: #eff6ff; padding: 14px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong style="font-size: 16px; color: #1f2937;">${action.action}</strong>
                                    <span style="padding: 4px 12px; background: #3b82f6; color: white; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                        ${action.priority}
                                    </span>
                                </div>
                                <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">
                                    ⏱️ Timeframe: ${action.timeframe}
                                </div>
                                <div style="background: white; padding: 10px; border-radius: 6px;">
                                    <strong style="font-size: 13px;">Steps to take:</strong>
                                    <ul style="margin: 6px 0; padding-left: 20px; line-height: 1.7; font-size: 13px;">
                                        ${action.steps.map(step => `<li>${step}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

// ==================== 3. INITIALIZATION & EXPORT ====================

// Export for use in main application
if (typeof window !== 'undefined') {
    window.SoilDataAIEngine = SoilDataAIEngine;
    window.initializeAIAnalysis = initializeAIAnalysis;

    // Add CSS for loading animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ai-prediction-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .prediction-title {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prediction-content {
            color: #374151;
            line-height: 1.6;
        }
    `;
    document.head.appendChild(style);
}

console.log('✅ AI Soil Analysis System Loaded Successfully');
console.log('📚 Ready to analyze real database data with Machine Learning');
console.log('🌾 Features: pH Prediction | Nutrient Optimization | Crop Recommendations | Yield Forecasting | Disease Detection');
</script>
</body>
</html>
