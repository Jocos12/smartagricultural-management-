<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriGuard AI - Farmer Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>







        :root {
        --primary-green: #22c55e;
        --primary-dark: #16a34a;
        --secondary-green: #10b981;
        --accent-green: #34d399;
        --light-green: #dcfce7;
        --dark-green: #166534;
        --forest-green: #065f46;
        --success-color: #22c55e;
        --warning-color: #f59e0b;
        --error-color: #ef4444;
        --info-color: #3b82f6;
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --bg-sidebar: #e8f5e8;
        --text-primary: #333333;
        --text-secondary: #666666;
        --border-color: #e0e0e0;
        --hover-bg: rgba(34, 197, 94, 0.1);
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 8px 25px rgba(34, 197, 94, 0.15);
        --gradient-primary: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
        --gradient-bg: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
        --card-bg: #ffffff;
        --modal-bg: rgba(0, 0, 0, 0.5);
    }

    .dark-mode {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-sidebar: #1f2937;
        --text-primary: #ffffff;
        --text-secondary: #cccccc;
        --border-color: #404040;
        --hover-bg: rgba(34, 197, 94, 0.2);
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        --card-bg: #374151;
        --gradient-bg: linear-gradient(135deg, #1f2937 0%, #374151 50%, #4b5563 100%);
    }

    /* Reset & Base Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: var(--gradient-bg);
        color: var(--text-primary);
        transition: all 0.3s ease;
        overflow-x: hidden;
    }

    /* Dashboard Container */
    .dashboard-container {
        display: flex;
        height: 100vh;
    }

    /* Sidebar Styles */
    .sidebar {
        width: 280px;
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: fixed;
        height: 100vh;
        z-index: 1000;
        box-shadow: var(--shadow);
        overflow-y: auto;
    }

    .sidebar.collapsed {
        width: 70px;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
    }

    .logo {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--gradient-primary);
        color: white;
        font-size: 24px;
        box-shadow: var(--shadow);
        animation: pulse 2s infinite;
        flex-shrink: 0;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .company-info {
        flex: 1;
        transition: opacity 0.3s ease;
        overflow: hidden;
    }

    .company-name {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 2px;
        white-space: nowrap;
    }

    .company-tagline {
        font-size: 11px;
        color: var(--primary-green);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .sidebar.collapsed .company-info {
        opacity: 0;
        width: 0;
    }

    /* Sidebar Navigation */
    .sidebar-nav {
        flex: 1;
        padding: 20px 0;
        overflow-y: auto;
    }

    .nav-section {
        margin-bottom: 30px;
    }

    .nav-section-title {
        padding: 0 20px 10px;
        font-size: 11px;
        font-weight: 700;
        color: var(--primary-green);
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: opacity 0.3s ease;
    }

    .sidebar.collapsed .nav-section-title {
        opacity: 0;
        height: 0;
        margin: 0;
        padding: 0;
    }

    .nav-menu {
        list-style: none;
    }

    .nav-item {
        margin-bottom: 4px;
    }

    .nav-link {
        display: flex;
        align-items: center;
        padding: 14px 20px;
        color: var(--text-primary);
        text-decoration: none;
        border-radius: 0 25px 25px 0;
        margin-right: 20px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .nav-link::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.1), transparent);
        transition: left 0.5s ease;
    }

    .nav-link:hover::before {
        left: 100%;
    }

    .nav-link i {
        width: 22px;
        margin-right: 14px;
        font-size: 18px;
        flex-shrink: 0;
    }

    .nav-link span {
        transition: opacity 0.3s ease;
        white-space: nowrap;
        font-weight: 500;
    }

    .sidebar.collapsed .nav-link span {
        opacity: 0;
    }

    .sidebar.collapsed .nav-link {
        margin-right: 0;
        border-radius: 0;
        justify-content: center;
    }

    .nav-link:hover {
        background: var(--hover-bg);
        color: var(--primary-green);
        transform: translateX(5px);
    }

    .nav-item.active .nav-link {
        background: var(--gradient-primary);
        color: white;
        box-shadow: var(--shadow);
    }

    .nav-item.active .nav-link:hover {
        background: var(--gradient-primary);
        color: white;
    }

    /* Main Content Area */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-left: 280px;
        transition: margin-left 0.3s ease;
    }

    .main-content.sidebar-collapsed {
        margin-left: 70px;
    }

    /* Header */
    .header {
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 0 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 80px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        flex-shrink: 0;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 24px;
    }

    .sidebar-toggle {
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: 20px;
        cursor: pointer;
        padding: 12px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .sidebar-toggle:hover {
        background: var(--hover-bg);
        color: var(--primary-green);
        transform: scale(1.1);
    }

    .greeting-section {
        display: flex;
        flex-direction: column;
    }

    .greeting-text {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 2px;
    }

    .current-date {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Search Container */
    .search-container {
        position: relative;
        width: 400px;
    }

    .search-input {
        width: 100%;
        padding: 12px 50px 12px 20px;
        border: 2px solid var(--border-color);
        border-radius: 25px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 15px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
    }

    .search-icon {
        position: absolute;
        right: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 18px;
    }

    /* Header Right */
    .header-right {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .theme-toggle {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        color: var(--text-primary);
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .theme-toggle:hover {
        background: var(--hover-bg);
        border-color: var(--primary-green);
        transform: translateY(-2px);
    }

    .notification-btn {
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: 20px;
        cursor: pointer;
        position: relative;
        padding: 12px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .notification-btn:hover {
        background: var(--hover-bg);
        color: var(--primary-green);
    }

    .notification-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: var(--error-color);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        animation: bounce 1s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-5px); }
        60% { transform: translateY(-3px); }
    }

    .notification-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        width: 380px;
        max-height: 500px;
        overflow-y: auto;
        z-index: 1000;
        border: 1px solid #e9ecef;
        animation: slideDown 0.3s ease;
    }

    .notification-dropdown.show {
        display: block !important;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .notification-item {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .notification-item:hover {
        background: #f8f9fa;
    }

    .notification-item.unread {
        background: #f0f7ff;
        border-left: 4px solid var(--primary-green);
    }

    .notification-item.unread::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        background: var(--primary-green);
        border-radius: 50%;
    }

    .notification-item-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
        font-size: 0.95rem;
    }

    .notification-item-message {
        color: #666;
        font-size: 0.85rem;
        line-height: 1.4;
        margin-bottom: 0.5rem;
    }

    .notification-item-time {
        color: #999;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .notification-empty {
        padding: 3rem 2rem;
        text-align: center;
        color: #999;
    }

    .notification-empty i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    .profile-section {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .profile-section:hover {
        background: var(--hover-bg);
    }

    .profile-avatar {
        width: 45px;
        height: 45px;
        background: var(--gradient-primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 16px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
    }

    .profile-info {
        display: flex;
        flex-direction: column;
    }

    .profile-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .profile-role {
        font-size: 12px;
        color: var(--primary-green);
        font-weight: 500;
        text-transform: capitalize;
    }

    .logout-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s ease;
        margin-left: 12px;
    }

    .logout-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
        transform: scale(1.1);
    }

    /* Content Area */
    .content {
        flex: 1;
        padding: 32px;
        background: var(--bg-secondary);
        overflow-y: auto;
        min-height: calc(100vh - 80px);
    }

    /* Content Sections */
    .content-section {
        display: none;
    }

    .content-section.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Section Header */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .section-header-left {
        flex: 1;
    }

    .section-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .section-subtitle {
        font-size: 16px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .section-header-right {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    /* Welcome Banner */
    .welcome-banner {
        background: var(--gradient-primary);
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow-lg);
        color: white;
        flex-wrap: wrap;
        gap: 24px;
    }

    .welcome-content {
        flex: 1;
    }

    .welcome-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .welcome-subtitle {
        font-size: 18px;
        opacity: 0.9;
    }

    .welcome-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    /* Stat Cards */
    .stat-card {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        margin-bottom: 16px;
    }

    .stat-icon.farms { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .stat-icon.productions { background: linear-gradient(135deg, #10b981, #047857); }
    .stat-icon.inventory { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .stat-icon.alerts { background: linear-gradient(135deg, #f59e0b, #d97706); }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .stat-sublabel {
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Mini Stat Cards */
    .stats-mini-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-mini-card {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.3s ease;
    }

    .stat-mini-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }

    .stat-mini-card.alert {
        border-left: 4px solid var(--error-color);
    }

    .stat-mini-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        background: var(--hover-bg);
        color: var(--primary-green);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .stat-mini-content {
        flex: 1;
    }

    .stat-mini-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .stat-mini-label {
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Charts Section */
    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    .chart-card {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .chart-filter {
        padding: 8px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chart-filter:focus {
        outline: none;
        border-color: var(--primary-green);
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    /* Dashboard Info Grid */
    .dashboard-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    .info-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .info-card-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .info-card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .info-card-content {
        padding: 24px;
        max-height: 400px;
        overflow-y: auto;
    }

    /* Task List */
    .task-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .task-item {
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        border-left: 4px solid var(--primary-green);
        transition: all 0.3s ease;
    }

    .task-item:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow);
    }

    .task-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .task-details {
        display: flex;
        gap: 16px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    /* Activity List */
    .activity-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .activity-item {
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        display: flex;
        gap: 16px;
        transition: all 0.3s ease;
    }

    .activity-item:hover {
        box-shadow: var(--shadow);
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--hover-bg);
        color: var(--primary-green);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .activity-content {
        flex: 1;
    }

    .activity-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .activity-time {
        font-size: 12px;
        color: var(--text-secondary);
    }

    /* Alerts Section */
    .alerts-section {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 32px;
    }

    .alerts-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .alerts-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alerts-view-all {
        color: var(--primary-green);
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .alerts-view-all:hover {
        text-decoration: underline;
    }

    .alerts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;
    }

    .alert-card {
        padding: 16px;
        border-radius: 10px;
        border-left: 4px solid;
        background: var(--bg-secondary);
        transition: all 0.3s ease;
    }

    .alert-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
    }

    .alert-card.critical { border-left-color: var(--error-color); }
    .alert-card.high { border-left-color: var(--warning-color); }
    .alert-card.medium { border-left-color: var(--info-color); }
    .alert-card.low { border-left-color: var(--primary-green); }

    .alert-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .alert-level {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .alert-level.critical {
        background: var(--error-color);
        color: white;
    }

    .alert-level.high {
        background: var(--warning-color);
        color: white;
    }

    .alert-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .alert-description {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
    }

    /* Weather Widget */
    .weather-widget {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 32px;
    }

    .weather-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .weather-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .weather-location {
        font-size: 14px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .weather-content {
        display: flex;
        gap: 32px;
        align-items: center;
    }

    .weather-current {
        flex: 1;
    }

    .weather-temp {
        font-size: 48px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .weather-condition {
        font-size: 18px;
        color: var(--text-secondary);
    }

    .weather-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        flex: 2;
    }

    .weather-detail {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .weather-detail i {
        font-size: 24px;
        color: var(--primary-green);
    }

    .weather-detail span {
        font-size: 13px;
        color: var(--text-secondary);
        display: block;
    }

    .weather-detail strong {
        font-size: 18px;
        color: var(--text-primary);
        font-weight: 600;
        display: block;
    }

    /* Weather Current Card (for weather section) */
    .weather-current-card {
        background: var(--gradient-primary);
        color: white;
        padding: 40px;
        border-radius: 16px;
        margin-bottom: 32px;
        box-shadow: var(--shadow-lg);
    }

    .weather-main {
        margin-bottom: 32px;
    }

    .weather-temp-large {
        font-size: 72px;
        font-weight: 700;
        margin-bottom: 12px;
    }

    .weather-condition-large {
        font-size: 24px;
        opacity: 0.9;
        margin-bottom: 16px;
    }

    .weather-location-large {
        font-size: 16px;
        opacity: 0.8;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .weather-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .weather-detail-card {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .weather-detail-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .weather-detail-content {
        flex: 1;
    }

    .weather-detail-label {
        font-size: 13px;
        opacity: 0.8;
        margin-bottom: 4px;
    }

    .weather-detail-value {
        font-size: 20px;
        font-weight: 700;
    }

    /* Weather Farms Grid */
    .weather-farms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    .weather-farm-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .weather-farm-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .weather-farm-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border-color);
    }

    .weather-farm-info h3 {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .weather-farm-location {
        font-size: 12px;
        color: var(--text-secondary);
        margin: 0;
    }

    .weather-farm-icon {
        font-size: 3rem;
    }

    .weather-farm-main {
        margin-bottom: 20px;
    }

    .weather-temp-display {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .weather-temp-value {
        font-size: 48px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .weather-condition {
        font-size: 16px;
        color: var(--text-secondary);
        text-transform: capitalize;
    }

    .weather-update-time {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .weather-farm-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 16px;
    }

    .weather-detail-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 10px;
    }

    .weather-detail-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .weather-detail-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .weather-detail-label {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .weather-detail-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* Weather Predictions */
    .weather-predictions-content {
        padding: 20px;
    }

    .weather-prediction-section {
        margin-bottom: 32px;
    }

    .weather-prediction-section:last-child {
        margin-bottom: 0;
    }

    .weather-prediction-section h4 {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .prediction-trends {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .prediction-trend-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
    }

    .trend-icon {
        font-size: 32px;
    }

    .trend-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .trend-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
    }

    .trend-value {
        font-size: 18px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .trend-increasing {
        color: #ef4444;
    }

    .trend-decreasing {
        color: #3b82f6;
    }

    .trend-stable {
        color: var(--primary-green);
    }

    .prediction-risks {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .prediction-risk-item {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border-left: 4px solid;
    }

    .prediction-risk-item.risk-high {
        border-left-color: #ef4444;
        background: rgba(239, 68, 68, 0.05);
    }

    .prediction-risk-item.risk-medium {
        border-left-color: #f59e0b;
        background: rgba(245, 158, 11, 0.05);
    }

    .prediction-risk-item i {
        font-size: 24px;
        margin-top: 4px;
    }

    .risk-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .risk-type {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .risk-probability {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
    }

    .risk-message {
        font-size: 14px;
        color: var(--text-secondary);
        margin: 8px 0 0 0;
    }

    .prediction-impacts {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .prediction-impact-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
    }

    .prediction-impact-item i {
        font-size: 20px;
        color: var(--primary-green);
    }

    /* Weather Risk Alerts */
    .weather-risk-alert {
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        margin-bottom: 12px;
    }

    .weather-risk-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }

    .weather-risk-icon {
        font-size: 24px;
    }

    .weather-risk-info {
        flex: 1;
    }

    .weather-risk-info h4 {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 4px 0;
    }

    .weather-risk-severity {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .severity-high {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    .severity-medium {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    .weather-risk-message {
        font-size: 14px;
        color: var(--text-secondary);
        margin: 8px 0 0 0;
        line-height: 1.6;
    }

    /* Agricultural Impact */
    .agricultural-impact-item {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        margin-bottom: 12px;
    }

    .impact-icon {
        font-size: 24px;
    }

    .impact-content h4 {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 4px 0;
    }

    .impact-content p {
        font-size: 14px;
        color: var(--text-secondary);
        margin: 0;
        line-height: 1.6;
    }

    /* Filter Section */
    .filter-section {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
    }

    .search-box {
        position: relative;
        margin-bottom: 16px;
    }

    .search-box i {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 16px;
    }

    .search-box input {
        width: 100%;
        padding: 12px 20px 12px 50px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 15px;
        transition: all 0.3s ease;
    }

    .search-box input:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
    }

    .filter-controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .filter-select {
        padding: 10px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 150px;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary-green);
    }

    /* Buttons */
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

    .btn i {
        font-size: 16px;
    }

    .btn-primary {
        background: var(--gradient-primary);
        color: white;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--hover-bg);
        border-color: var(--primary-green);
        color: var(--primary-green);
    }

    .btn-info {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 13px;
    }

    /* Farms Grid */
    .farms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .farm-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .farm-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .farm-card-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .farm-card-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .farm-card-location {
        font-size: 14px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .farm-card-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .farm-card-badge.active {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .farm-card-body {
        padding: 20px;
    }

    .farm-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 16px;
    }

    .farm-info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .farm-info-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .farm-info-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .farm-card-footer {
        padding: 16px 20px;
        background: var(--bg-secondary);
        display: flex;
        gap: 8px;
    }

    .farm-action-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .farm-action-btn.view {
        background: rgba(34, 197, 94, 0.1);
        color: var(--primary-green);
    }

    .farm-action-btn.view:hover {
        background: var(--primary-green);
        color: white;
    }

    .farm-action-btn.edit {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .farm-action-btn.edit:hover {
        background: #3b82f6;
        color: white;
    }

    .farm-action-btn.delete {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .farm-action-btn.delete:hover {
        background: #ef4444;
        color: white;
    }










/* Crops Grid - IMPROVED DESIGN */
.crops-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 28px;
    margin-bottom: 32px;
}

.crop-card {
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 2px solid transparent;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.crop-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, #22c55e, #10b981, #059669);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.crop-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.3);
}

.crop-card:hover::before {
    opacity: 1;
}

.crop-card-header {
    padding: 32px 24px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
    text-align: center;
    position: relative;
}

.crop-icon {
    font-size: 64px;
    margin-bottom: 16px;
    filter: drop-shadow(0 4px 12px rgba(34, 197, 94, 0.2));
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
}

.crop-name {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 12px;
    line-height: 1.3;
}

.crop-category {
    padding: 8px 16px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border-radius: 24px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-block;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.crop-card-body {
    padding: 24px;
    display: flex;
    flex-direction: column;
    justify-content: center; /* Centers content vertically */
    min-height: 300px; /* Ensures enough space */
}

.crop-info-list {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.crop-info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    background: var(--bg-secondary);
    border-radius: 12px;
    border-left: 3px solid #22c55e;
    transition: all 0.3s ease;
}

.crop-info-item:hover {
    background: rgba(34, 197, 94, 0.08);
    transform: translateX(4px);
}

.crop-info-label {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.crop-info-label::before {
    content: 'â€¢';
    color: #22c55e;
    font-weight: bold;
    font-size: 18px;
}

.crop-info-value {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    background: rgba(34, 197, 94, 0.1);
    padding: 4px 12px;
    border-radius: 8px;
}

/* Crop Card Footer - View Details Button */
.crop-card-body .btn {
    width: 100%;
    margin-top: 20px;
    padding: 14px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.crop-card-body .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    background: linear-gradient(135deg, #16a34a, #15803d);
}

.crop-card-body .btn i {
    font-size: 16px;
}






    /* Production Timeline */
    .production-timeline {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .production-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .production-card:hover {
        box-shadow: var(--shadow-lg);
    }

    .production-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .production-title-section {
        flex: 1;
    }

    .production-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .production-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .production-status {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .production-status.planned {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .production-status.planted {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .production-status.growing {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .production-status.harvested {
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
    }

    .production-status.sold {
        background: rgba(6, 182, 212, 0.1);
        color: #06b6d4;
    }

    .production-body {
        padding: 20px;
    }

    .production-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .production-info-item {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .production-info-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: var(--hover-bg);
        color: var(--primary-green);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .production-info-content {
        flex: 1;
    }

    .production-info-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
    }

    .production-info-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .production-footer {
        padding: 16px 20px;
        background: var(--bg-secondary);
        display: flex;
        gap: 8px;
    }





    /* Inventory Grid */
    .inventory-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px;
    }

    .inventory-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .inventory-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .inventory-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
    }

    .inventory-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .inventory-badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .inventory-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .inventory-badge.available {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .inventory-badge.reserved {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .inventory-badge.sold {
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
    }

    .inventory-badge.expired {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
    }

    .inventory-body {
        padding: 20px;
    }

    .inventory-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .inventory-alerts {
        margin-bottom: 24px;
    }

    .inventory-alert {
        padding: 16px;
        border-radius: 10px;
        border-left: 4px solid;
        margin-bottom: 12px;
        background: var(--bg-secondary);
    }

    .inventory-alert.warning {
        border-left-color: var(--warning-color);
    }

    .inventory-alert.danger {
        border-left-color: var(--error-color);
    }

    .inventory-alert-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .inventory-alert-message {
        font-size: 13px;
        color: var(--text-secondary);
    }

    /* Table Section */
    .table-section {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        margin-bottom: 32px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .data-table th {
        background: var(--bg-secondary);
        font-weight: 600;
        color: var(--text-primary);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .data-table td {
        color: var(--text-primary);
        font-size: 14px;
    }

    .data-table tr:hover {
        background: var(--hover-bg);
    }

    .data-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Action Buttons in Tables */
    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .action-btn-view {
        background: rgba(34, 197, 94, 0.1);
        color: var(--primary-green);
    }

    .action-btn-view:hover {
        background: var(--primary-green);
        color: white;
    }

    .action-btn-edit {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .action-btn-edit:hover {
        background: #3b82f6;
        color: white;
    }

    .action-btn-delete {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .action-btn-delete:hover {
        background: #ef4444;
        color: white;
    }

    /* Soil Data Grid */
    .soil-data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 2rem;
        padding: 1rem 0;
    }

    @media (max-width: 768px) {
        .soil-data-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }

    /* Soil Data Card - Same style as Crop Card */
    .soil-data-card {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .soil-data-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, #22c55e, #10b981, #059669);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .soil-data-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
        border-color: rgba(34, 197, 94, 0.3);
    }

    .soil-data-card:hover::before {
        opacity: 1;
    }

    .soil-card-header {
        padding: 32px 24px;
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
        text-align: center;
        position: relative;
    }

    .soil-icon {
        font-size: 64px;
        margin-bottom: 16px;
        filter: drop-shadow(0 4px 12px rgba(34, 197, 94, 0.2));
        animation: float 3s ease-in-out infinite;
    }

    .soil-name {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1.3;
    }

    .soil-sample-badge {
        padding: 8px 16px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        border-radius: 24px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        margin-top: 8px;
    }

    .soil-card-body {
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 300px;
    }

    .soil-info-list {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .soil-info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border-left: 3px solid #22c55e;
        transition: all 0.3s ease;
    }

    .soil-info-item:hover {
        background: rgba(34, 197, 94, 0.08);
        transform: translateX(4px);
    }

    .soil-info-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .soil-info-label::before {
        content: 'â€¢';
        color: #22c55e;
        font-weight: bold;
        font-size: 18px;
    }

    .soil-info-value {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-primary);
        background: rgba(34, 197, 94, 0.1);
        padding: 4px 12px;
        border-radius: 8px;
    }

    /* Farm Card - Same style as Crop Card */
    .farm-card {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .farm-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, #22c55e, #10b981, #059669);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .farm-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
        border-color: rgba(34, 197, 94, 0.3);
    }

    .farm-card:hover::before {
        opacity: 1;
    }

    .farm-card-header {
        padding: 32px 24px;
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
        text-align: center;
        position: relative;
    }

    .farm-icon {
        font-size: 64px;
        margin-bottom: 16px;
        filter: drop-shadow(0 4px 12px rgba(34, 197, 94, 0.2));
        animation: float 3s ease-in-out infinite;
    }

    .farm-name {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1.3;
    }

    .farm-code-badge {
        padding: 8px 16px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        border-radius: 24px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        margin-top: 8px;
    }

    .farm-card-body {
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 300px;
    }

    .farm-info-list {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .farm-info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border-left: 3px solid #22c55e;
        transition: all 0.3s ease;
    }

    .farm-info-item:hover {
        background: rgba(34, 197, 94, 0.08);
        transform: translateX(4px);
    }

    .farm-info-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .farm-info-label::before {
        content: 'â€¢';
        color: #22c55e;
        font-weight: bold;
        font-size: 18px;
    }

    .farm-info-value {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-primary);
        background: rgba(34, 197, 94, 0.1);
        padding: 4px 12px;
        border-radius: 8px;
    }

    .soil-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: 24px;
        transition: all 0.3s ease;
    }

    .soil-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .soil-card-header {
        margin-bottom: 20px;
    }

    .soil-card-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .soil-card-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .soil-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .soil-metric {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 10px;
    }

    .soil-metric-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .soil-metric-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* Market Prices Grid */
    .market-prices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 24px;
    }

    .market-price-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: 24px;
        transition: all 0.3s ease;
    }

    .market-price-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .market-price-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .market-price-crop {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .market-price-trend {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .market-price-trend.increasing {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .market-price-trend.decreasing {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
    }

    .market-price-trend.stable {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .market-price-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--primary-green);
        margin-bottom: 8px;
    }

    .market-price-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    /* Supply Chain */
    .supply-chain-legend {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 24px;
        padding: 16px;
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .supply-chain-container {
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .supply-chain-item {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: 24px;
    }

    .supply-chain-header {
        margin-bottom: 24px;
    }

    .supply-chain-tracking-code {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .supply-chain-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .supply-chain-stages {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 16px;
    }

    .stage-card {
        min-width: 200px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        border-left: 4px solid;
        transition: all 0.3s ease;
    }

    .stage-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
    }

    .stage-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .stage-details {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.6;
    }

    /* Alerts List */
    .alerts-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .alert-item {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        border-left: 4px solid;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .alert-item:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow-lg);
    }

    .alert-item.critical {
        border-left-color: var(--error-color);
    }

    .alert-item.high {
        border-left-color: var(--warning-color);
    }

    .alert-item.medium {
        border-left-color: var(--info-color);
    }

    .alert-item.low {
        border-left-color: var(--primary-green);
    }

    .alert-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .alert-item-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .alert-item-message {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 12px;
    }

    .alert-item-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .alert-item-body {
        margin: 12px 0;
    }

    .alert-item-title-section {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }

    .alert-item-badges {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .ai-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .alert-affected-items {
        margin: 12px 0;
        padding: 8px 12px;
        background: rgba(0,0,0,0.05);
        border-radius: 8px;
    }

    .alert-recommendations {
        margin: 12px 0;
        padding: 12px;
        background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%);
        border-left: 3px solid #ffc107;
        border-radius: 8px;
    }

    /* AI Analysis Styles */
    .ai-analysis-content {
        padding: 20px;
    }

    .analysis-section {
        margin-bottom: 32px;
    }

    .analysis-section:last-child {
        margin-bottom: 0;
    }

    /* Policies Grid */
    .policies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .policy-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .policy-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .policy-header {
        padding: 20px;
        background: var(--hover-bg);
        border-bottom: 1px solid var(--border-color);
    }

    .policy-type {
        padding: 6px 12px;
        background: var(--primary-green);
        color: white;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
        margin-bottom: 12px;
    }

    .policy-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .policy-body {
        padding: 20px;
    }

    .policy-description {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 16px;
    }

    .policy-details {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .policy-detail-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        background: var(--bg-secondary);
        border-radius: 8px;
        font-size: 13px;
    }

    .policy-detail-label {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .policy-detail-value {
        color: var(--text-primary);
        font-weight: 600;
    }

    /* Recommendations Grid */
    .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .recommendation-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: 24px;
        transition: all 0.3s ease;
    }

    .recommendation-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .recommendation-header {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
    }

    .recommendation-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        background: var(--gradient-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
    }

    .recommendation-title-section {
        flex: 1;
    }

    .recommendation-type {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .recommendation-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .recommendation-priority {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .recommendation-priority.urgent {
        background: var(--error-color);
        color: white;
    }

    .recommendation-priority.high {
        background: var(--warning-color);
        color: white;
    }

    .recommendation-priority.medium {
        background: var(--info-color);
        color: white;
    }

    .recommendation-priority.low {
        background: var(--primary-green);
        color: white;
    }

    .recommendation-description {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 16px;
    }

    .recommendation-details {
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        font-size: 13px;
        color: var(--text-primary);
    }

    .recommendation-footer {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .recommendation-confidence {
        font-size: 12px;
        color: var(--text-secondary);
    }

    .recommendation-confidence strong {
        color: var(--primary-green);
        font-weight: 700;
    }

    /* Predictions Grid */
    .predictions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .prediction-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .prediction-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .prediction-header {
        padding: 20px;
        background: var(--gradient-primary);
        color: white;
    }

    .prediction-crop {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .prediction-season {
        font-size: 14px;
        opacity: 0.9;
    }

    .prediction-body {
        padding: 24px;
    }

    .prediction-yield {
        text-align: center;
        margin-bottom: 24px;
    }

    .prediction-yield-label {
        font-size: 13px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .prediction-yield-value {
        font-size: 48px;
        font-weight: 700;
        color: var(--primary-green);
    }

    .prediction-yield-unit {
        font-size: 16px;
        color: var(--text-secondary);
    }

    .prediction-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .prediction-metric {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 10px;
        text-align: center;
    }

    .prediction-metric-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }

    .prediction-metric-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* Report Configuration */
    .report-config-card {
        background: var(--card-bg);
        padding: 32px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 32px;
    }

    .report-config-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 24px;
    }

    .report-config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .form-input,
    .form-select {
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
    }

    .report-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    /* Report Preview */
    .report-preview-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .report-preview-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-secondary);
    }

    .report-preview-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .report-preview-content {
        padding: 32px;
        max-height: 600px;
        overflow-y: auto;
    }

    /* Status Badges */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
    }

    .status-active {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .status-inactive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
    }

    .status-pending {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .status-completed {
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: var(--modal-bg);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 32px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: var(--hover-bg);
        color: var(--primary-green);
    }

    .modal-body {
        margin-bottom: 24px;
    }

    .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    /* Loading Overlay */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }

    .loading-overlay.show {
        display: flex;
    }

    .loader {
        border: 8px solid rgba(255, 255, 255, 0.2);
        border-top: 8px solid var(--primary-green);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .toast {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: var(--shadow-lg);
        border-left: 4px solid;
        animation: slideInRight 0.3s ease;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toast.success { border-left-color: var(--success-color); }
    .toast.error { border-left-color: var(--error-color); }
    .toast.warning { border-left-color: var(--warning-color); }
    .toast.info { border-left-color: var(--info-color); }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .toast-icon {
        font-size: 20px;
    }

    .toast.success .toast-icon { color: var(--success-color); }
    .toast.error .toast-icon { color: var(--error-color); }
    .toast.warning .toast-icon { color: var(--warning-color); }
    .toast.info .toast-icon { color: var(--info-color); }

    .toast-message {
        color: var(--text-primary);
        font-weight: 500;
        font-size: 14px;
        flex: 1;
    }

    .toast-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 4px;
        font-size: 18px;
        transition: all 0.3s ease;
    }

    .toast-close:hover {
        color: var(--text-primary);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-state p {
        font-size: 18px;
        margin-top: 12px;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary-green);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }

    /* Responsive Design */
    @media (max-width: 1400px) {
        .charts-section {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 1200px) {
        .dashboard-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .farms-grid,
        .crops-grid,
        .inventory-grid,
        .market-prices-grid,
        .policies-grid,
        .recommendations-grid,
        .predictions-grid {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
    }

    @media (max-width: 992px) {
        .header {
            padding: 0 20px;
        }

        .search-container {
            width: 250px;
        }

        .greeting-text {
            font-size: 20px;
        }

        .content {
            padding: 24px 20px;
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .section-header-right {
            width: 100%;
        }

        .welcome-banner {
            padding: 32px 24px;
        }

        .welcome-title {
            font-size: 28px;
        }

        .dashboard-info-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
            width: 280px;
        }

        .sidebar.mobile-open {
            transform: translateX(0);
        }

        .main-content {
            margin-left: 0;
        }

        .header {
            height: auto;
            padding: 16px;
            flex-direction: column;
            gap: 16px;
        }

        .header-left {
            width: 100%;
            justify-content: space-between;
        }

        .search-container {
            width: 100%;
            order: 3;
        }

        .header-right {
            width: 100%;
            justify-content: space-between;
        }

        .greeting-section {
            flex: 1;
        }

        .greeting-text {
            font-size: 18px;
        }

        .current-date {
            font-size: 12px;
        }

        .profile-info {
            display: none;
        }

        .content {
            padding: 20px 16px;
        }

        .section-title {
            font-size: 24px;
        }

        .welcome-banner {
            padding: 24px 20px;
            flex-direction: column;
        }

        .welcome-title {
            font-size: 24px;
        }

        .welcome-subtitle {
            font-size: 16px;
        }

        .welcome-actions {
            width: 100%;
            flex-direction: column;
        }

        .welcome-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .dashboard-grid,
        .stats-mini-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .charts-section {
            grid-template-columns: 1fr;
        }

        .chart-container {
            height: 250px;
        }

        .farms-grid,
        .crops-grid,
        .inventory-grid,
        .market-prices-grid,
        .soil-data-grid,
        .policies-grid,
        .recommendations-grid,
        .predictions-grid {
            grid-template-columns: 1fr;
        }

        .filter-section {
            padding: 16px;
        }

        .filter-controls {
            flex-direction: column;
        }

        .filter-select {
            width: 100%;
        }

        .section-header-right {
            flex-direction: column;
        }

        .section-header-right .btn {
            width: 100%;
            justify-content: center;
        }

        .weather-content {
            flex-direction: column;
        }

        .weather-details {
            grid-template-columns: repeat(2, 1fr);
        }

        .weather-current-card {
            padding: 24px 20px;
        }

        .weather-temp-large {
            font-size: 56px;
        }

        .weather-details-grid {
            grid-template-columns: 1fr;
        }

        .production-info-grid {
            grid-template-columns: 1fr;
        }

        .modal-content {
            width: 95%;
            padding: 24px 20px;
            max-height: 95vh;
        }

        .modal-title {
            font-size: 20px;
        }

        .report-config-grid {
            grid-template-columns: 1fr;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            min-width: 600px;
        }
    }

    @media (max-width: 480px) {
        .stat-value {
            font-size: 28px;
        }

        .stat-mini-value {
            font-size: 20px;
        }

        .chart-title {
            font-size: 16px;
        }

        .farm-info-grid,
        .soil-metrics,
        .prediction-metrics {
            grid-template-columns: 1fr;
        }

        .weather-details {
            grid-template-columns: 1fr;
        }

        .supply-chain-stages {
            flex-direction: column;
        }

        .stage-card {
            min-width: 100%;
        }

        .toast {
            max-width: calc(100vw - 40px);
        }

        .toast-container {
            left: 20px;
            right: 20px;
        }
    }

    /* Print Styles */
    @media print {
        .sidebar,
        .header,
        .filter-section,
        .section-header-right,
        .btn,
        .action-buttons,
        .farm-card-footer,
        .production-footer,
        .modal,
        .toast-container,
        .loading-overlay {
            display: none !important;
        }

        .main-content {
            margin-left: 0;
        }

        .content {
            padding: 0;
        }

        .card,
        .stat-card,
        .chart-card,
        .farm-card,
        .crop-card,
        .inventory-card {
            box-shadow: none;
            border: 1px solid #ddd;
            page-break-inside: avoid;
        }
    }

    /* Dark Mode Adjustments */
    .dark-mode .nav-link:hover {
        background: rgba(34, 197, 94, 0.15);
    }

    .dark-mode .data-table tr:hover {
        background: rgba(34, 197, 94, 0.1);
    }

    .dark-mode .search-input,
    .dark-mode .filter-select,
    .dark-mode .form-input,
    .dark-mode .form-select {
        background: var(--bg-primary);
    }

    .dark-mode .loader {
        border-color: rgba(255, 255, 255, 0.1);
        border-top-color: var(--primary-green);
    }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-in {
        animation: fadeInUp 0.5s ease;
    }

    /* Utility Classes */
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }

    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mt-3 { margin-top: 24px; }
    .mt-4 { margin-top: 32px; }

    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 24px; }
    .mb-4 { margin-bottom: 32px; }

    .p-1 { padding: 8px; }
    .p-2 { padding: 16px; }
    .p-3 { padding: 24px; }
    .p-4 { padding: 32px; }

    .flex { display: flex; }
    .flex-column { flex-direction: column; }
    .flex-wrap { flex-wrap: wrap; }
    .justify-between { justify-content: space-between; }
    .justify-center { justify-content: center; }
    .items-center { align-items: center; }
    .gap-1 { gap: 8px; }
    .gap-2 { gap: 16px; }
    .gap-3 { gap: 24px; }

    .w-full { width: 100%; }
    .h-full { height: 100%; }

    .rounded { border-radius: 8px; }
    .rounded-lg { border-radius: 12px; }
    .rounded-xl { border-radius: 16px; }

    .shadow { box-shadow: var(--shadow); }
    .shadow-lg { box-shadow: var(--shadow-lg); }

    .cursor-pointer { cursor: pointer; }

    .overflow-hidden { overflow: hidden; }
    .overflow-auto { overflow: auto; }

    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-success { color: var(--success-color); }
    .text-warning { color: var(--warning-color); }
    .text-error { color: var(--error-color); }

    .bg-primary { background: var(--bg-primary); }
    .bg-secondary { background: var(--bg-secondary); }

    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .font-medium { font-weight: 500; }

    .text-xs { font-size: 12px; }
    .text-sm { font-size: 13px; }
    .text-base { font-size: 14px; }
    .text-lg { font-size: 16px; }
    .text-xl { font-size: 18px; }
    .text-2xl { font-size: 20px; }
    .text-3xl { font-size: 24px; }





        /* ============================================================================
   MODAL IMPROVEMENTS - RESPONSIVE & CENTERED
   ============================================================================ */

/* Modal Overlay - AmÃ©lioration */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(5px);
  z-index: 9999;
  overflow-y: auto;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

.modal-overlay.show {
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Modal Container - CentrÃ© et Responsive */
.modal-container {
  background: var(--card-bg);
  border-radius: 20px;
  width: 100%;
  max-width: 700px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  margin: auto;
  position: relative;
}

.modal-container.modal-large {
  max-width: 1000px;
}

.modal-container.modal-small {
  max-width: 500px;
}

/* Modal Header - AmÃ©liorÃ© */
.modal-header {
  padding: 24px 32px;
  border-bottom: 2px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
  border-radius: 20px 20px 0 0;
  position: sticky;
  top: 0;
  z-index: 10;
}

.modal-title {
  font-size: 22px;
  font-weight: 700;
  color: white;
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 0;
}

.modal-title i {
  font-size: 24px;
}

.modal-close {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  color: white;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

/* Modal Body - AmÃ©liorÃ© */
.modal-body {
  padding: 32px;
  max-height: calc(90vh - 180px);
  overflow-y: auto;
}

/* Scrollbar personnalisÃ© pour modal */
.modal-body::-webkit-scrollbar {
  width: 8px;
}

.modal-body::-webkit-scrollbar-track {
  background: var(--bg-secondary);
  border-radius: 10px;
}

.modal-body::-webkit-scrollbar-thumb {
  background: var(--primary-green);
  border-radius: 10px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
  background: var(--primary-dark);
}

/* Modal Footer - AmÃ©liorÃ© */
.modal-footer {
  padding: 20px 32px;
  border-top: 2px solid var(--border-color);
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  background: var(--bg-secondary);
  border-radius: 0 0 20px 20px;
  position: sticky;
  bottom: 0;
  z-index: 10;
}

/* Form Grid - Responsive */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 24px;
  margin-bottom: 24px;
}

/* Form Group - AmÃ©liorÃ© */
.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group.form-group-full {
  grid-column: 1 / -1;
}

/* Form Label - Avec icÃ´nes */
.form-label {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.form-label i {
  color: var(--primary-green);
  font-size: 16px;
}

.form-label::after {
  content: '';
  display: none;
}

/* Form Input & Select - Design moderne */
.form-input,
.form-select {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-size: 15px;
  font-weight: 500;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
}

.form-input:focus,
.form-select:focus {
  outline: none;
  border-color: var(--primary-green);
  box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
  background: var(--bg-primary);
}

.form-input::placeholder {
  color: var(--text-secondary);
  opacity: 0.7;
}

.form-input:invalid:not(:placeholder-shown) {
  border-color: var(--error-color);
}

.form-input:valid:not(:placeholder-shown) {
  border-color: var(--success-color);
}

/* Form Select - AmÃ©lioration */
.form-select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2322c55e' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 16px center;
  padding-right: 40px;
}

/* Form Checkbox - Style personnalisÃ© */
.form-checkbox {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  user-select: none;
}

.form-checkbox input[type="checkbox"] {
  width: 20px;
  height: 20px;
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  appearance: none;
  position: relative;
}

.form-checkbox input[type="checkbox"]:checked {
  background: var(--primary-green);
  border-color: var(--primary-green);
}

.form-checkbox input[type="checkbox"]:checked::after {
  content: '\f00c';
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 12px;
}

.form-checkbox span {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
}

/* Buttons dans modal - AmÃ©liorÃ© */
.modal-footer .btn {
  padding: 14px 28px;
  font-size: 15px;
  font-weight: 600;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
}

.modal-footer .btn i {
  font-size: 16px;
}

.modal-footer .btn-primary {
  background: var(--gradient-primary);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.modal-footer .btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
}

.modal-footer .btn-secondary {
  background: transparent;
  color: var(--text-primary);
  border: 2px solid var(--border-color);
}

.modal-footer .btn-secondary:hover {
  background: var(--hover-bg);
  border-color: var(--primary-green);
  color: var(--primary-green);
}

/* Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* Responsive Design pour Modaux */
@media (max-width: 768px) {
  .modal-overlay {
    padding: 10px;
  }

  .modal-container {
    max-width: 100%;
    max-height: 95vh;
    border-radius: 16px;
  }

  .modal-header {
    padding: 20px 24px;
    border-radius: 16px 16px 0 0;
  }

  .modal-title {
    font-size: 18px;
  }

  .modal-body {
    padding: 24px 20px;
    max-height: calc(95vh - 160px);
  }

  .modal-footer {
    padding: 16px 20px;
    flex-direction: column-reverse;
    border-radius: 0 0 16px 16px;
  }

  .modal-footer .btn {
    width: 100%;
    justify-content: center;
  }

  .form-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }

  .modal-close {
    width: 36px;
    height: 36px;
    font-size: 18px;
  }
}

@media (max-width: 480px) {
  .modal-container {
    border-radius: 12px;
  }

  .modal-header {
    padding: 16px 20px;
    border-radius: 12px 12px 0 0;
  }

  .modal-title {
    font-size: 16px;
  }

  .modal-title i {
    font-size: 20px;
  }

  .modal-body {
    padding: 20px 16px;
  }

  .modal-footer {
    padding: 12px 16px;
    border-radius: 0 0 12px 12px;
  }

  .form-input,
  .form-select {
    padding: 12px 14px;
    font-size: 14px;
  }

  .form-label {
    font-size: 13px;
  }

  .modal-footer .btn {
    padding: 12px 20px;
    font-size: 14px;
  }
}

/* Dark Mode pour Modaux */
.dark-mode .modal-overlay {
  background: rgba(0, 0, 0, 0.8);
}

.dark-mode .modal-container {
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
}

.dark-mode .form-input:focus,
.dark-mode .form-select:focus {
  background: var(--bg-primary);
}


        /* Supply Chain Styles */
.supply-chain-group {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.supply-chain-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #f0f0f0;
}

.supply-chain-timeline {
    position: relative;
    padding-left: 40px;
}

.timeline-item {
    position: relative;
    padding-bottom: 32px;
}

.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: -28px;
    top: 40px;
    width: 2px;
    height: calc(100% - 40px);
    background: #e0e0e0;
}

.timeline-item.completed:not(:last-child)::after {
    background: #22c55e;
}

.timeline-marker {
    position: absolute;
    left: -40px;
    top: 0;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: white;
    border: 3px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
}

.timeline-item.completed .timeline-marker {
    border-color: #22c55e;
    background: #22c55e;
    color: white;
}

.timeline-item.active .timeline-marker {
    border-color: #3b82f6;
    background: #3b82f6;
    color: white;
}

.timeline-content {
    background: #f9fafb;
    border-radius: 8px;
    padding: 20px;
    border-left: 4px solid #e0e0e0;
}

.timeline-item.completed .timeline-content {
    border-left-color: #22c55e;
}

.timeline-item.active .timeline-content {
    border-left-color: #3b82f6;
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.timeline-header h4 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
}

.timeline-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.detail-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #6b7280;
}

.detail-row i {
    width: 20px;
    color: #9ca3af;
}

.detail-row.alert-warning {
    color: #d97706;
    background: #fef3c7;
    padding: 8px;
    border-radius: 4px;
}

.timeline-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.stat-icon.primary { background: #dbeafe; color: #3b82f6; }
.stat-icon.success { background: #dcfce7; color: #22c55e; }
.stat-icon.warning { background: #fef3c7; color: #f59e0b; }
.stat-icon.danger { background: #fee2e2; color: #ef4444; }

.stat-content {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #1f2937;
}

.stat-content small {
    font-size: 12px;
    color: #9ca3af;
}



        .policy-full-details {
  max-height: 70vh;
  overflow-y: auto;
  padding: 10px;
}

.detail-section {
  margin-bottom: 25px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #3498db;
}

.detail-section h4 {
  margin: 0 0 15px 0;
  color: #2c3e50;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
}

.detail-section h4 i {
  color: #3498db;
}

.detail-section p {
  line-height: 1.8;
  color: #495057;
  margin: 0;
}

.details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 10px;
}

.detail-item {
  padding: 12px;
  background: white;
  border-radius: 6px;
  border: 1px solid #dee2e6;
}

.detail-item label {
  display: block;
  font-size: 0.875rem;
  color: #6c757d;
  margin-bottom: 5px;
  font-weight: 500;
}


.market-prices-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    padding: 20px 0;
}

.trend-increasing { background: #dcfce7; color: #166534; }
.trend-decreasing { background: #fee2e2; color: #991b1b; }
.trend-stable { background: #fef3c7; color: #92400e; }
.trend-volatile { background: #dbeafe; color: #1e40af; }

.demand-high { background: #dcfce7; color: #166534; }
.demand-medium { background: #fef3c7; color: #92400e; }
.demand-low { background: #fee2e2; color: #991b1b; }
.demand-unknown { background: #f1f5f9; color: #475569; }

.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
}

.detail-item value {
  display: block;
  font-size: 1rem;
  font-weight: 600;
  color: #2c3e50;
}

.badges-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 500;
}

.badge-success {
  background: #d4edda;
  color: #155724;
}

.badge-info {
  background: #d1ecf1;
  color: #0c5460;
}

.badge i {
  font-size: 0.9rem;
}

@media (max-width: 768px) {
  .details-grid {
    grid-template-columns: 1fr;
  }

  .policy-full-details {
    max-height: 60vh;
  }
}




        /* ===== MODAL STYLES - CORRECTION AFFICHAGE ===== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: none; /* CachÃ© par dÃ©faut */
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.modal-overlay.show {
  display: flex !important; /* Force l'affichage */
  opacity: 1;
}

.modal-container {
  background: white;
  border-radius: 12px;
  max-width: 800px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.show .modal-container {
  transform: scale(1);
}



/* CORRECTION CRITIQUE : Styles pour modal de production */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: none; /* CachÃ© par dÃ©faut */
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.modal-overlay.show {
  display: flex !important; /* Force l'affichage */
  opacity: 1 !important;
}

.modal-container {
  background: white;
  border-radius: 12px;
  max-width: 800px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.show .modal-container {
  transform: scale(1);
}



        /* ===================================
   PRODUCTION CARDS ENHANCED STYLES
   =================================== */

.production-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    border-left: 4px solid #22c55e;
    margin-bottom: 20px;
}

.production-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.production-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.production-info {
    flex: 1;
}

.production-title {
    margin: 0 0 8px 0;
    font-size: 1.25rem;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 10px;
}

.production-title i {
    color: #22c55e;
}

.production-code {
    font-size: 0.875rem;
    color: #7f8c8d;
    font-weight: 500;
}

.production-badges {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: flex-end;
}

.production-countdown {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: #fff8e1;
    color: #f57c00;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
}

.production-countdown i {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.production-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.production-detail-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.production-detail-item label {
    font-size: 0.875rem;
    color: #7f8c8d;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
}

.production-detail-item label i {
    color: #3498db;
    width: 16px;
}

.production-detail-item span {
    font-size: 1rem;
    color: #2c3e50;
    font-weight: 600;
}

.production-dates {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.date-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
    color: #495057;
}

.date-item i {
    color: #3498db;
    width: 16px;
}


/* FORCER L'AFFICHAGE DE LA SECTION MARKET PRICES */
#marketPricesSection.active {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
}
.date-item.success i {
    color: #22c55e;
}

.production-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    padding-top: 15px;
    border-top: 1px solid #ecf0f1;
}

/* Status badges colors */
.status-planned {
    background: #e3f2fd;
    color: #1976d2;
}

.status-planted {
    background: #f3e5f5;
    color: #7b1fa2;
}

.status-growing {
    background: #e8f5e9;
    color: #388e3c;
}

.status-harvested {
    background: #fff8e1;
    color: #f57c00;
}

.status-failed {
    background: #ffebee;
    color: #c62828;
}

/* Responsive */
@media (max-width: 768px) {
    .production-header {
        flex-direction: column;
        gap: 15px;
    }

    .production-badges {
        align-items: flex-start;
    }

    .production-details {
        grid-template-columns: 1fr;
    }
}




        /* Styles pour le tableau des fertilisants */
.fertilizer-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.fertilizer-table th {
    background: #f8f9fa;
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #e9ecef;
}

.fertilizer-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #e9ecef;
}

.fertilizer-table tr:hover {
    background-color: #f8f9fa;
}

.table-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-start;
}

.btn-icon {
    background: none;
    border: none;
    padding: 6px;
    border-radius: 4px;
    cursor: pointer;
    color: #666;
    transition: all 0.2s ease;
}

.btn-icon:hover {
    background: #f1f3f4;
    color: #333;
}

.btn-danger {
    color: #dc3545;
}

.btn-danger:hover {
    background: #f8d7da;
    color: #721c24;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.empty-icon {
    font-size: 48px;
    color: #ddd;
    margin-bottom: 16px;
}

.empty-state h3 {
    margin: 0 0 8px 0;
    color: #333;
}

.empty-state p {
    margin: 0 0 20px 0;
    font-size: 14px;
}





        /* Supply Level Badges */
.supply-badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.supply-high {
    background: #f0fdf4;
    color: #166534;
}

.supply-medium {
    background: #fefce8;
    color: #854d0e;
}

.supply-low {
    background: #fef2f2;
    color: #dc2626;
}

/* Trend Badges */
.trend-badge {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
}

.trend-volatile {
    background: #fef3c7;
    color: #92400e;
}

.trend-fluctuating {
    background: #e0e7ff;
    color: #3730a3;
}

/* Reliability Stars */
.reliability-stars {
    color: #fbbf24;
    font-size: 1rem;
}

.score-text {
    color: #6b7280;
    font-size: 0.75rem;
    margin-left: 8px;
}

/* Text Colors for Price Changes */
.text-success {
    color: #059669;
}

.text-error {
    color: #dc2626;
}

.text-warning {
    color: #d97706;
}








        /* ============================================================================
   SUPPLY CHAIN STYLES - VERSION COMPLÃˆTE
   ============================================================================ */

/* Supply Chain Legend */
.supply-chain-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    padding: 20px;
    background: white;
    border-radius: 12px;
    margin-bottom: 25px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
    color: #475569;
}

.legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
}

/* Supply Chain Container */
.supply-chain-container {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

/* Supply Chain Group */
.supply-chain-group {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.supply-chain-group:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.supply-chain-group-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f1f5f9;
}

.supply-chain-group-info h3 {
    margin: 0 0 8px 0;
    color: #1e293b;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.supply-chain-production-id {
    margin: 0;
    color: #64748b;
    font-size: 0.875rem;
}

.supply-chain-group-progress {
    min-width: 250px;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.875rem;
    color: #475569;
}

.progress-percent {
    font-weight: 600;
    color: #10b981;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    transition: width 0.5s ease;
}

/* Supply Chain Timeline */
.supply-chain-timeline {
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: relative;
}

/* Timeline Stage */
.timeline-stage {
    display: flex;
    gap: 20px;
    position: relative;
    padding: 20px;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.timeline-stage.completed {
    background: rgba(16, 185, 129, 0.05);
    border: 2px solid rgba(16, 185, 129, 0.2);
}

.timeline-stage.active {
    background: rgba(251, 146, 60, 0.05);
    border: 2px solid rgba(251, 146, 60, 0.3);
    box-shadow: 0 4px 12px rgba(251, 146, 60, 0.15);
}

.timeline-stage.pending {
    background: rgba(148, 163, 184, 0.05);
    border: 2px solid rgba(148, 163, 184, 0.2);
    opacity: 0.7;
}

.timeline-stage:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Timeline Connector */
.timeline-connector {
    position: absolute;
    left: 39px;
    top: 80px;
    bottom: -20px;
    width: 2px;
    background: linear-gradient(180deg, #e2e8f0 0%, #cbd5e1 100%);
}

.timeline-connector.last {
    display: none;
}

.timeline-stage.completed .timeline-connector {
    background: linear-gradient(180deg, #10b981 0%, #059669 100%);
}

.timeline-stage.active .timeline-connector {
    background: linear-gradient(180deg, #fb923c 0%, #f97316 100%);
}

/* Timeline Marker */
.timeline-marker {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
    position: relative;
    z-index: 1;
    transition: all 0.3s ease;
}

.timeline-stage.completed .timeline-marker {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.timeline-stage.active .timeline-marker {
    background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
    animation: pulse 2s infinite;
}

.timeline-stage.pending .timeline-marker {
    background: #f1f5f9;
    color: #94a3b8;
    border: 2px solid #cbd5e1;
}

.stage-check {
    position: absolute;
    top: -5px;
    right: -5px;
    background: white;
    border-radius: 50%;
    padding: 3px;
    font-size: 0.875rem;
    color: #10b981;
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
    }
    50% {
        box-shadow: 0 4px 20px rgba(251, 146, 60, 0.6);
    }
}

/* Timeline Content */
.timeline-content {
    flex: 1;
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.stage-name {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: #1e293b;
}

.stage-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-success {
    background: #d1fae5;
    color: #065f46;
}

.badge-warning {
    background: #fed7aa;
    color: #92400e;
}

.badge-secondary {
    background: #e2e8f0;
    color: #475569;
}

/* Timeline Details */
.timeline-details {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}

.detail-row {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 12px;
    background: #f8fafc;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #475569;
}

.detail-row i {
    color: #64748b;
    margin-top: 2px;
    flex-shrink: 0;
}

.detail-row.success {
    background: #d1fae5;
    color: #065f46;
}

.detail-row.success i {
    color: #10b981;
}

.detail-row.alert {
    background: #fee2e2;
    color: #991b1b;
}

.detail-row.alert i {
    color: #ef4444;
}

/* Timeline Actions */
.timeline-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e2e8f0;
}

.timeline-actions .btn-icon {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    background: white;
    color: #475569;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.875rem;
}

.timeline-actions .btn-icon:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
    transform: translateY(-2px);
}

.timeline-actions .btn-icon.btn-primary {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.timeline-actions .btn-icon.btn-primary:hover {
    background: #2563eb;
    border-color: #2563eb;
}

.timeline-actions .btn-icon.btn-success {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

.timeline-actions .btn-icon.btn-success:hover {
    background: #059669;
    border-color: #059669;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 12px;
    color: #64748b;
}

.empty-icon {
    font-size: 4rem;
    color: #cbd5e1;
    margin-bottom: 20px;
}

.empty-state h3 {
    margin: 0 0 10px 0;
    color: #475569;
    font-size: 1.5rem;
}

.empty-state p {
    margin: 10px 0;
    font-size: 1rem;
    line-height: 1.6;
}

.empty-state-hint {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: #e0f2fe;
    border-radius: 8px;
    color: #0369a1;
    font-size: 0.875rem;
    margin: 20px 0;
}

.empty-state .btn {
    margin-top: 25px;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    flex-shrink: 0;
}

.stat-icon.primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

.stat-icon.success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.stat-icon.warning {
    background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
}

.stat-icon.secondary {
    background: linear-gradient(135deg, #64748b 0%, #475569 100%);
}

.stat-icon.danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.stat-content {
    flex: 1;
}

.stat-label {
    display: block;
    font-size: 0.875rem;
    color: #64748b;
    margin-bottom: 4px;
}

.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
}

.stat-content small {
    display: block;
    font-size: 0.75rem;
    color: #94a3b8;
    margin-top: 4px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .supply-chain-group-header {
        flex-direction: column;
        gap: 20px;
    }

    .supply-chain-group-progress {
        width: 100%;
    }

    .timeline-stage {
        flex-direction: column;
        gap: 15px;
    }

    .timeline-connector {
        display: none;
    }

    .timeline-actions {
        flex-wrap: wrap;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .supply-chain-legend {
        gap: 10px;
        font-size: 0.75rem;
    }
}

/* Print Styles */
@media print {
    .timeline-actions,
    .supply-chain-group-header button,
    .btn {
        display: none !important;
    }

    .timeline-stage {
        break-inside: avoid;
    }

    .supply-chain-group {
        box-shadow: none;
        border: 1px solid #e2e8f0;
    }
}









/* ============================================================================
   IMPROVED INVENTORY CARD DESIGN - PROFESSIONAL & MODERN
   ============================================================================ */

.inventory-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 28px;
    margin-bottom: 32px;
}

.inventory-card {
    background: var(--card-bg, #ffffff);
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 2px solid transparent;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    display: flex;
    flex-direction: column;
}

.inventory-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, #22c55e, #10b981, #059669);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.inventory-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.3);
}

.inventory-card:hover::before {
    opacity: 1;
}

/* Header Section */
.inventory-header {
    padding: 24px 24px 16px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
    border-bottom: 2px solid rgba(34, 197, 94, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.inventory-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-primary, #1f2937);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.inventory-title::before {
    content: 'ðŸ“¦';
    font-size: 28px;
    filter: drop-shadow(0 2px 4px rgba(34, 197, 94, 0.2));
}

/* Status Badge */
.inventory-status {
    padding: 8px 16px;
    border-radius: 24px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.inventory-status.status-available {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.inventory-status.status-reserved {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.inventory-status.status-sold {
    background: linear-gradient(135deg, #8b5cf6, #6d28d9);
    color: white;
}

.inventory-status.status-expired {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

/* Details Section */
.inventory-details {
    padding: 24px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    flex-grow: 1;
}

.inventory-detail-item {
    padding: 14px 16px;
    background: var(--bg-secondary, #f9fafb);
    border-radius: 12px;
    border-left: 3px solid #22c55e;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.inventory-detail-item:hover {
    background: rgba(34, 197, 94, 0.08);
    transform: translateX(4px);
}

.inventory-detail-item label {
    font-size: 12px;
    color: var(--text-secondary, #6b7280);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 0;
}

.inventory-detail-item label::before {
    content: 'â€¢';
    color: #22c55e;
    font-weight: bold;
    font-size: 16px;
}

.inventory-detail-item span {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary, #1f2937);
}

/* Quality Badge */
.quality-badge {
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}

.quality-badge.quality-premium,
.quality-badge.quality-a {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.quality-badge.quality-standard,
.quality-badge.quality-b {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.quality-badge.quality-basic,
.quality-badge.quality-c {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.quality-badge.quality-n\/a {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
}

/* Actions Section */
.inventory-actions {
    padding: 16px 24px 24px;
    display: flex;
    gap: 10px;
    justify-content: space-between;
    border-top: 1px solid rgba(34, 197, 94, 0.1);
}

.inventory-actions .btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 16px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.inventory-actions .btn i {
    font-size: 14px;
}

.inventory-actions .btn-secondary {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
}

.inventory-actions .btn-secondary:hover {
    background: linear-gradient(135deg, #4b5563, #374151);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
}

.inventory-actions .btn-primary {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.inventory-actions .btn-primary:hover {
    background: linear-gradient(135deg, #1d4ed8, #1e40af);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.inventory-actions .btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.inventory-actions .btn-danger:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.inventory-actions .btn-sm {
    padding: 10px 14px;
    font-size: 13px;
}

/* Empty State */
.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 80px 40px;
    background: var(--card-bg, #ffffff);
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.empty-state i {
    font-size: 80px;
    color: #d1d5db;
    margin-bottom: 24px;
    display: block;
}

.empty-state p {
    font-size: 18px;
    color: var(--text-secondary, #6b7280);
    margin-bottom: 32px;
    font-weight: 500;
}

.empty-state .btn {
    padding: 14px 32px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 10px;
}

.empty-state .btn-primary {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.empty-state .btn-primary:hover {
    background: linear-gradient(135deg, #16a34a, #15803d);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
}

/* Responsive Design */
@media (max-width: 768px) {
    .inventory-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .inventory-details {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .inventory-actions {
        flex-direction: column;
    }

    .inventory-actions .btn {
        width: 100%;
    }
}







/* Quality Badges */
.quality-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.quality-premium {
    background: #ffd700;
    color: #856404;
}

.quality-grade_a {
    background: #d4edda;
    color: #155724;
}

.quality-grade_b {
    background: #d1ecf1;
    color: #0c5460;
}

.quality-standard {
    background: #e9ecef;
    color: #495057;
}

/* Inventory Actions */
.inventory-actions {
    display: flex;
    gap: 10px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.inventory-actions .btn {
    flex: 1;
}

/* Alerts Banner */
.alerts-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.alerts-banner h4 {
    margin: 0 0 15px 0;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
}

.alerts-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.alert-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.alert-item i {
    font-size: 1.2rem;
}

.alert-critical {
    background: rgba(220, 53, 69, 0.2);
    border-left: 4px solid #dc3545;
}

.alert-high {
    background: rgba(255, 193, 7, 0.2);
    border-left: 4px solid #ffc107;
}

.alert-medium {
    background: rgba(23, 162, 184, 0.2);
    border-left: 4px solid #17a2b8;
}

/* Filter Buttons */
.filter-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.filter-group label {
    font-weight: 600;
    color: #495057;
}

.filter-btn {
    padding: 8px 16px;
    border: 2px solid #e9ecef;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.filter-btn:hover {
    background: #f8f9fa;
    border-color: #dee2e6;
}

.filter-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 4rem;
    color: #dee2e6;
    margin-bottom: 20px;
}

.empty-state h3 {
    margin: 0 0 10px 0;
    color: #495057;
}

.empty-state p {
    margin: 10px 0;
    font-size: 1rem;
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .inventory-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .inventory-actions {
        flex-direction: column;
    }

    .filter-controls {
        flex-direction: column;
        align-items: stretch;
    }

    .filter-group {
        flex-direction: column;
        align-items: flex-start;
    }
}




        /* ============================================
   MODAL FIXES - Ajouter Ã  votre CSS
   ============================================ */

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.modal-overlay.show {
  display: flex !important;
  opacity: 1;
}

.modal-container {
  background: white;
  border-radius: 8px;
  max-width: 800px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.show .modal-container {
  transform: scale(1);
}
    </style>
</head>
<body>





<div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
</div>

<div class="toast-container" id="toastContainer"></div>

<div class="dashboard-container">
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo" style="width: 45px; height: 45px; background: none; animation: none; box-shadow: none;">
                <img src="images/logo.jpeg" alt="AgriGuard AI Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
            </div>
            <div class="company-info">
                <div class="company-name">AgriGuard AI</div>
                <div class="company-tagline">Smart Farming</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">Main</h3>
                <ul class="nav-menu">
                    <li class="nav-item active">
                        <a class="nav-link" data-section="dashboard">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="farms">
                            <i class="fas fa-map-marked-alt"></i>
                            <span>My Farms</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="crops">
                            <i class="fas fa-seedling"></i>
                            <span>Crop Catalog</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="production">
                            <i class="fas fa-tractor"></i>
                            <span>Productions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="inventory">
                            <i class="fas fa-warehouse"></i>
                            <span>Inventory</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Resources</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="fertilizer">
                            <i class="fas fa-flask"></i>
                            <span>Fertilizer Usage</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="irrigation">
                            <i class="fas fa-tint"></i>
                            <span>Irrigation Data</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="soil">
                            <i class="fas fa-mountain"></i>
                            <span>Soil Data</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Market</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="market-prices">
                            <i class="fas fa-chart-line"></i>
                            <span>Market Prices</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="transactions">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Transactions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="supply-chain">
                            <i class="fas fa-truck"></i>
                            <span>Supply Chain</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Information</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="weather">
                            <i class="fas fa-cloud-sun"></i>
                            <span>Weather Data</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="alerts">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Security Alerts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="policies">
                            <i class="fas fa-gavel"></i>
                            <span>Policies & Subsidies</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="recommendations">
                            <i class="fas fa-lightbulb"></i>
                            <span>AI Recommendations</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Analytics</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="predictions">
                            <i class="fas fa-chart-area"></i>
                            <span>Production Predictions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="reports">
                            <i class="fas fa-file-alt"></i>
                            <span>Reports</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="greeting-section">
                    <div class="greeting-text" id="greetingText">Good Morning, Farmer!</div>
                    <div class="current-date" id="currentDate"></div>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search..." id="globalSearch">
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="header-right">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                    <span>Dark Mode</span>
                </button>
                <div style="position: relative;">
                    <button class="notification-btn" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); width: 380px; max-height: 500px; overflow-y: auto; z-index: 1000; border: 1px solid #e9ecef;">
                        <div style="padding: 1rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, var(--primary-green), var(--secondary-green)); border-radius: 12px 12px 0 0;">
                            <h3 style="margin: 0; color: white; font-size: 1.1rem; font-weight: 700;">
                                <i class="fas fa-bell"></i> Notifications
                            </h3>
                            <button onclick="markAllNotificationsAsRead()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;" onmouseover="this.style.background='rgba(255,255,255,0.3)';" onmouseout="this.style.background='rgba(255,255,255,0.2)';">
                                Mark all read
                            </button>
                        </div>
                        <div id="notificationsList" style="max-height: 400px; overflow-y: auto;">
                            <div style="padding: 2rem; text-align: center; color: #999;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                <p>Loading notifications...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="profile-section" id="profileSection">
                    <div class="profile-avatar" id="profileAvatar">F</div>
                    <div class="profile-info">
                        <div class="profile-name" id="profileName">Farmer Name</div>
                        <div class="profile-role">Farmer</div>
                    </div>
                    <button class="logout-btn" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Sections -->
        <main class="content">
            <!-- Dashboard Home Section -->
            <div id="dashboardSection" class="content-section active">
                <div class="welcome-banner">
                    <div class="welcome-content">
                        <h1 class="welcome-title">Welcome to Your Dashboard</h1>
                        <p class="welcome-subtitle">Manage your farms, track production, and grow smarter</p>
                    </div>
                    <div class="welcome-actions">
                        <button class="btn btn-primary" data-action="add-farm">
                            <i class="fas fa-plus"></i>
                            Add New Farm
                        </button>
                        <button class="btn btn-primary" data-action="add-production">
                            <i class="fas fa-plus"></i>
                            Start Production
                        </button>
                    </div>
                </div>

                <!-- Quick Statistics -->
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon farms">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div class="stat-value" id="dashTotalFarms">0</div>
                        <div class="stat-label">Total Farms</div>
                        <div class="stat-sublabel" id="dashTotalArea">0 hectares</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon productions">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-value" id="dashActiveProductions">0</div>
                        <div class="stat-label">Active Productions</div>
                        <div class="stat-sublabel" id="dashTotalProductions">0 total</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon inventory">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <div class="stat-value" id="dashInventoryValue">RWF 0</div>
                        <div class="stat-label">Inventory Value</div>
                        <div class="stat-sublabel" id="dashInventoryItems">0 items</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon alerts">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-value" id="dashCriticalAlerts">0</div>
                        <div class="stat-label">Critical Alerts</div>
                        <div class="stat-sublabel" id="dashTotalAlerts">0 total alerts</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Production Trends (Last 6 Months)</h3>
                            <select class="chart-filter" id="productionTrendFilter">
                                <option value="all">All Crops</option>
                                <option value="cereals">Cereals</option>
                                <option value="vegetables">Vegetables</option>
                                <option value="fruits">Fruits</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="productionTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Cost Breakdown</h3>
                            <select class="chart-filter" id="costBreakdownFilter">
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="costBreakdownChart"></canvas>
                        </div>
                    </div>
                </div>





                <!-- Upcoming Tasks and Recent Activities -->
                <div class="dashboard-info-grid">
                    <div class="info-card">
                        <div class="info-card-header">
                            <h3 class="info-card-title">
                                <i class="fas fa-tasks"></i>
                                Upcoming Tasks
                            </h3>
                            <button class="btn btn-secondary btn-sm" data-action="refresh-tasks">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="info-card-content">
                            <div class="task-list" id="upcomingTasksList">
                                <div class="empty-state">
                                    <i class="fas fa-tasks"></i>
                                    <p>Loading upcoming tasks...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-card-header">
                            <h3 class="info-card-title">
                                <i class="fas fa-history"></i>
                                Recent Activities
                            </h3>
                            <button class="btn btn-secondary btn-sm" data-action="refresh-activities">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="info-card-content">
                            <div class="activity-list" id="recentActivitiesList">
                                <div class="empty-state">
                                    <i class="fas fa-history"></i>
                                    <p>Loading recent activities...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Critical Alerts Section -->
                <div class="alerts-section">
                    <div class="alerts-header">
                        <h3 class="alerts-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Critical Alerts
                        </h3>
                        <a href="#" class="alerts-view-all" data-section="alerts">View All Alerts</a>
                    </div>
                    <div class="alerts-grid" id="criticalAlertsGrid">
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <p>No critical alerts at the moment</p>
                        </div>
                    </div>
                </div>

                <!-- Weather Widget -->
                <div class="weather-widget">
                    <div class="weather-header">
                        <h3 class="weather-title">
                            <i class="fas fa-cloud-sun"></i>
                            Current Weather
                        </h3>
                        <div class="weather-location" id="weatherLocation">
                            <i class="fas fa-map-marker-alt"></i>
                            Loading...
                        </div>
                    </div>
                    <div class="weather-content" id="weatherContent">
                        <div class="weather-current">
                            <div class="weather-temp" id="weatherTemp">--Â°C</div>
                            <div class="weather-condition" id="weatherCondition">Loading...</div>
                        </div>
                        <div class="weather-details">
                            <div class="weather-detail">
                                <i class="fas fa-tint"></i>
                                <span>Humidity</span>
                                <strong id="weatherHumidity">--%</strong>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-wind"></i>
                                <span>Wind Speed</span>
                                <strong id="weatherWind">-- km/h</strong>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-cloud-rain"></i>
                                <span>Rainfall</span>
                                <strong id="weatherRainfall">-- mm</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Farms Section -->
            <div id="farmsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">My Farms</h2>
                        <p class="section-subtitle">Manage your agricultural lands</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-farm">
                            <i class="fas fa-plus"></i>
                            Add New Farm
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-farms">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-farms">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Farms Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-map"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="farmsTotalCount">0</div>
                            <div class="stat-mini-label">Total Farms</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-ruler-combined"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="farmsTotalArea">0 ha</div>
                            <div class="stat-mini-label">Total Area</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="farmsIrrigated">0</div>
                            <div class="stat-mini-label">Irrigated Farms</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="farmsActive">0</div>
                            <div class="stat-mini-label">Active Farms</div>
                        </div>
                    </div>
                </div>

                <!-- Farms Filter and Search -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search farms by name or location..." id="farmsSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="farmsSoilTypeFilter">
                            <option value="">All Soil Types</option>
                            <option value="clay">Clay</option>
                            <option value="loam">Loam</option>
                            <option value="sand">Sand</option>
                            <option value="silt">Silt</option>
                        </select>
                        <select class="filter-select" id="farmsIrrigationFilter">
                            <option value="">All Irrigation Systems</option>
                            <option value="RAIN_FED">Rain Fed</option>
                            <option value="SPRINKLER">Sprinkler</option>
                            <option value="DRIP">Drip Irrigation</option>
                            <option value="FLOOD">Flood Irrigation</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Farms Grid -->
                <div class="farms-grid" id="farmsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading your farms...</p>
                    </div>
                </div>
            </div>

            <!-- Crops Catalog Section -->
            <div id="cropsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Crop Catalog</h2>
                        <p class="section-subtitle">Browse available crops and their requirements</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-crops">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Crops Filter and Search -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search crops by name..." id="cropsSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="cropsTypeFilter">
                            <option value="">All Crop Types</option>
                            <option value="CEREALS">Cereals</option>
                            <option value="VEGETABLES">Vegetables</option>
                            <option value="FRUITS">Fruits</option>
                            <option value="LEGUMES">Legumes</option>
                            <option value="TUBERS">Tubers</option>
                            <option value="CASH_CROPS">Cash Crops</option>
                        </select>
                        <select class="filter-select" id="cropsSeasonFilter">
                            <option value="">All Seasons</option>
                            <option value="SEASON_A">Season A</option>
                            <option value="SEASON_B">Season B</option>
                            <option value="SEASON_C">Season C</option>
                        </select>
                        <select class="filter-select" id="cropsDemandFilter">
                            <option value="">All Demand Levels</option>
                            <option value="HIGH">High Demand</option>
                            <option value="MEDIUM">Medium Demand</option>
                            <option value="LOW">Low Demand</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-crop-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Crops Grid -->
                <div class="crops-grid" id="cropsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading crop catalog...</p>
                    </div>
                </div>
            </div>





            <!-- Production Section -->
            <div id="productionSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Crop Productions</h2>
                        <p class="section-subtitle">Track your planting and harvest activities</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-production">
                            <i class="fas fa-plus"></i>
                            Start Production
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-productions">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-productions">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Production Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="prodTotalCount">0</div>
                            <div class="stat-mini-label">Total Productions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="prodActive">0</div>
                            <div class="stat-mini-label">Active Productions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="prodHarvested">0</div>
                            <div class="stat-mini-label">Harvested</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="prodTotalYield">0 T</div>
                            <div class="stat-mini-label">Total Yield</div>
                        </div>
                    </div>
                </div>

                <!-- Production Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search productions..." id="productionSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="productionStatusFilter">
                            <option value="">All Status</option>
                            <option value="PLANNED">Planned</option>
                            <option value="PLANTED">Planted</option>
                            <option value="GROWING">Growing</option>
                            <option value="HARVESTED">Harvested</option>
                            <option value="SOLD">Sold</option>
                        </select>
                        <select class="filter-select" id="productionSeasonFilter">
                            <option value="">All Seasons</option>
                            <option value="SEASON_A">Season A</option>
                            <option value="SEASON_B">Season B</option>
                            <option value="SEASON_C">Season C</option>
                        </select>
                        <select class="filter-select" id="productionYearFilter">
                            <option value="">All Years</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-production-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Production Timeline View -->
                <div class="production-timeline" id="productionTimeline">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading productions...</p>
                    </div>
                </div>
            </div>






            <!-- Inventory Section -->
            <div id="inventorySection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Inventory Management</h2>
                        <p class="section-subtitle">Track your stored products</p>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-primary" data-action="add-inventory">
                            <i class="fas fa-plus"></i>
                            Add Stock
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-inventory">
                            <i class="fas fa-redo"></i>
                            Refresh
                        </button>
                        <button class="btn btn-secondary" data-action="export-inventory">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Inventory Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="invTotalItems">0</div>
                            <div class="stat-mini-label">Total Items</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-weight"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="invTotalQuantity">0 KG</div>
                            <div class="stat-mini-label">Total Quantity</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="invTotalValue">RWF 0</div>
                            <div class="stat-mini-label">Total Value</div>
                        </div>
                    </div>
                    <div class="stat-mini-card alert">
                        <div class="stat-mini-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="invAlerts">0</div>
                            <div class="stat-mini-label">Active Alerts</div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Alerts -->
                <div class="inventory-alerts" id="inventoryAlerts">
                    <!-- Alerts will be dynamically inserted here -->
                </div>

                <!-- Inventory Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search inventory..." id="inventorySearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="inventoryStatusFilter">
                            <option value="">All Status</option>
                            <option value="AVAILABLE">Available</option>
                            <option value="RESERVED">Reserved</option>
                            <option value="SOLD">Sold</option>
                            <option value="EXPIRED">Expired</option>
                        </select>
                        <select class="filter-select" id="inventoryQualityFilter">
                            <option value="">All Quality</option>
                            <option value="EXCELLENT">Excellent</option>
                            <option value="GOOD">Good</option>
                            <option value="FAIR">Fair</option>
                            <option value="POOR">Poor</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-inventory-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Inventory Grid -->
                <div class="inventory-grid" id="inventoryGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading inventory...</p>
                    </div>
                </div>
            </div>




            <!-- Fertilizer Usage Section -->
            <div id="fertilizerSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Fertilizer Usage</h2>
                        <p class="section-subtitle">Track fertilizer applications and costs</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-fertilizer">
                            <i class="fas fa-plus"></i>
                            Record Usage
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-fertilizer">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-fertilizer">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Fertilizer Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-flask"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="fertTotalApplications">0</div>
                            <div class="stat-mini-label">Total Applications</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-weight-hanging"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="fertTotalQuantity">0 KG</div>
                            <div class="stat-mini-label">Total Quantity</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="fertTotalCost">RWF 0</div>
                            <div class="stat-mini-label">Total Cost</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="fertAvgEffectiveness">0</div>
                            <div class="stat-mini-label">Avg Effectiveness</div>
                        </div>
                    </div>
                </div>

                <!-- Fertilizer Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Cost by Fertilizer Type</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="fertilizerCostChart"></canvas>
                    </div>
                </div>

                <!-- Fertilizer Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search fertilizer records..." id="fertilizerSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="fertilizerTypeFilter">
                            <option value="">All Types</option>
                            <option value="ORGANIC">Organic</option>
                            <option value="NPK">NPK</option>
                            <option value="NITROGEN">Nitrogen</option>
                            <option value="PHOSPHATE">Phosphate</option>
                            <option value="POTASH">Potash</option>
                        </select>
                        <input type="date" class="filter-select" id="fertilizerDateFrom" placeholder="From Date">
                        <input type="date" class="filter-select" id="fertilizerDateTo" placeholder="To Date">
                        <button class="btn btn-secondary" data-action="clear-fertilizer-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Fertilizer Table -->
                <div class="table-section">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>Date</th>
                                <th>Crop Production</th>
                                <th>Fertilizer Type</th>
                                <th>Name</th>
                                <th>Quantity</th>
                                <th>Method</th>
                                <th>Cost</th>
                                <th>Effectiveness</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="fertilizerTableBody">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading fertilizer records...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Irrigation Data Section -->
            <div id="irrigationSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Irrigation Data</h2>
                        <p class="section-subtitle">Monitor water usage and efficiency</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-irrigation">
                            <i class="fas fa-plus"></i>
                            Record Irrigation
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-irrigation">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-irrigation">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Irrigation Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="irrigTotalSessions">0</div>
                            <div class="stat-mini-label">Total Sessions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-water"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="irrigTotalWater">0 L</div>
                            <div class="stat-mini-label">Total Water Used</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="irrigTotalCost">RWF 0</div>
                            <div class="stat-mini-label">Total Cost</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="irrigAvgEfficiency">0%</div>
                            <div class="stat-mini-label">Avg Efficiency</div>
                        </div>
                    </div>
                </div>

                <!-- Irrigation Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Water Usage Trends</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="irrigationTrendChart"></canvas>
                    </div>
                </div>

                <!-- Irrigation Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search irrigation records..." id="irrigationSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="irrigationMethodFilter">
                            <option value="">All Methods</option>
                            <option value="SPRINKLER">Sprinkler</option>
                            <option value="DRIP">Drip</option>
                            <option value="FLOOD">Flood</option>
                            <option value="FURROW">Furrow</option>
                            <option value="MANUAL">Manual</option>
                        </select>
                        <select class="filter-select" id="irrigationSourceFilter">
                            <option value="">All Sources</option>
                            <option value="WELL">Well</option>
                            <option value="RIVER">River</option>
                            <option value="LAKE">Lake</option>
                            <option value="RAINWATER">Rainwater</option>
                        </select>
                        <input type="date" class="filter-select" id="irrigationDateFrom" placeholder="From Date">
                        <input type="date" class="filter-select" id="irrigationDateTo" placeholder="To Date">
                        <button class="btn btn-secondary" data-action="clear-irrigation-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Irrigation Table -->
                <div class="table-section">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>Date</th>
                                <th>Farm</th>
                                <th>Water Amount</th>
                                <th>Duration</th>
                                <th>Method</th>
                                <th>Source</th>
                                <th>Moisture Before</th>
                                <th>Moisture After</th>
                                <th>Cost</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="irrigationTableBody">
                            <tr>
                                <td colspan="10" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading irrigation records...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Soil Data Section -->
            <div id="soilSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Soil Data</h2>
                        <p class="section-subtitle">Monitor soil health and quality</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-soil">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Soil Data Grid -->
                <div class="soil-data-grid" id="soilDataGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading soil data...</p>
                    </div>
                </div>
            </div>











                <!-- Market Prices Section -->
                <div id="marketPricesSection" class="content-section">
                    <div class="section-header">
                        <div class="section-header-left">
                            <h2 class="section-title">Market Prices</h2>
                            <p class="section-subtitle">Track real-time crop prices</p>
                        </div>
                        <div class="section-header-right">
                            <button class="btn btn-secondary" data-action="refresh-market-prices">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Market Prices Filter -->
                    <div class="filter-section">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Search crops or markets..." id="marketPricesSearchInput">
                        </div>
                        <div class="filter-controls">
                            <select class="filter-select" id="marketPricesTypeFilter">
                                <option value="">All Market Types</option>
                                <option value="WHOLESALE">Wholesale</option>
                                <option value="RETAIL">Retail</option>
                                <option value="FARM_GATE">Farm Gate</option>
                                <option value="EXPORT">Export</option>
                            </select>
                            <select class="filter-select" id="marketPricesTrendFilter">
                                <option value="">All Trends</option>
                                <option value="INCREASING">Increasing</option>
                                <option value="STABLE">Stable</option>
                                <option value="DECREASING">Decreasing</option>
                            </select>
                            <button class="btn btn-secondary" data-action="clear-market-prices-filters">
                                <i class="fas fa-times"></i>
                                Clear Filters
                            </button>
                        </div>
                    </div>

                    <!-- Market Prices Grid -->
                    <div class="market-prices-grid" id="marketPricesGrid">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading market prices...</p>
                        </div>
                    </div>
                </div>

            <!-- Transactions Section -->
            <div id="transactionsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">My Transactions</h2>
                        <p class="section-subtitle">Track your sales and purchases</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-transactions">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-transactions">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Transactions Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="txTotalCount">0</div>
                            <div class="stat-mini-label">Total Transactions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="txCompleted">0</div>
                            <div class="stat-mini-label">Completed</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="txTotalAmount">RWF 0</div>
                            <div class="stat-mini-label">Total Amount</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="txNetAmount">RWF 0</div>
                            <div class="stat-mini-label">Net Amount</div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search transactions..." id="transactionsSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="transactionsStatusFilter">
                            <option value="">All Status</option>
                            <option value="PENDING">Pending</option>
                            <option value="CONFIRMED">Confirmed</option>
                            <option value="DELIVERED">Delivered</option>
                            <option value="PAID">Paid</option>
                            <option value="CANCELLED">Cancelled</option>
                        </select>
                        <input type="date" class="filter-select" id="transactionsDateFrom" placeholder="From Date">
                        <input type="date" class="filter-select" id="transactionsDateTo" placeholder="To Date">
                        <button class="btn btn-secondary" data-action="clear-transactions-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="table-section">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>Transaction Code</th>
                                <th>Date</th>
                                <th>Buyer</th>
                                <th>Crop</th>
                                <th>Quantity</th>
                                <th>Total Amount</th>
                                <th>Net Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading transactions...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>



            <!-- Supply Chain Section -->
            <div id="supplyChainSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Supply Chain Tracking</h2>
                        <p class="section-subtitle">Track your products through the supply chain</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-supply-chain">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Supply Chain Search -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search by tracking code or production..." id="supplyChainSearchInput">
                    </div>
                </div>

                <!-- Supply Chain Stages Legend -->
                <div class="supply-chain-legend">
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #22c55e;"></span>
                        <span>Harvest</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #3b82f6;"></span>
                        <span>Collection</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #f59e0b;"></span>
                        <span>Storage</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #8b5cf6;"></span>
                        <span>Processing</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #ec4899;"></span>
                        <span>Packaging</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #14b8a6;"></span>
                        <span>Transport</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #f97316;"></span>
                        <span>Distribution</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #06b6d4;"></span>
                        <span>Retail</span>
                    </div>
                </div>

                <!-- Supply Chain Timeline -->
                <div class="supply-chain-container" id="supplyChainContainer">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading supply chain data...</p>
                    </div>
                </div>
            </div>

            <!-- Weather Data Section -->
            <div id="weatherSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Weather Data</h2>
                        <p class="section-subtitle">Monitor weather conditions</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-weather">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Weather Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            <i class="fas fa-thermometer-half"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="weatherAvgTemp">--Â°C</div>
                            <div class="stat-mini-label">Avg Temperature</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green);">
                            <i class="fas fa-cloud-rain"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="weatherTotalRainfall">-- mm</div>
                            <div class="stat-mini-label">Total Rainfall (7d)</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="weatherAvgHumidity">--%</div>
                            <div class="stat-mini-label">Avg Humidity</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="weatherRiskCount">0</div>
                            <div class="stat-mini-label">Active Risks</div>
                        </div>
                    </div>
                </div>

                <!-- Current Weather Cards -->
                <div class="weather-farms-grid" id="weatherFarmsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading weather data...</p>
                    </div>
                </div>

                <!-- Weather History Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Temperature & Rainfall Trends (Last 7 Days)</h3>
                        <div class="chart-actions">
                            <select class="filter-select" id="weatherChartDays" style="width: auto;">
                                <option value="7">Last 7 Days</option>
                                <option value="14">Last 14 Days</option>
                                <option value="30">Last 30 Days</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="weatherHistoryChart"></canvas>
                    </div>
                </div>

                <!-- AI Weather Predictions -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-brain"></i>
                            AI Weather Predictions & Analysis
                        </h3>
                        <button class="btn btn-primary" onclick="generateWeatherPrediction()" id="generatePredictionBtn">
                            <i class="fas fa-magic"></i>
                            Generate Prediction
                        </button>
                    </div>
                    <div id="weatherPredictionsContainer">
                        <div class="empty-state" style="padding: 3rem;">
                            <i class="fas fa-brain" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;"></i>
                            <p style="color: #666;">Click "Generate Prediction" to get AI-powered weather forecasts and agricultural insights</p>
                        </div>
                    </div>
                </div>

                <!-- Weather Risk Alerts -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Weather Risk Alerts
                        </h3>
                    </div>
                    <div id="weatherRiskAlertsContainer">
                        <div class="empty-state" style="padding: 2rem;">
                            <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--primary-green); margin-bottom: 0.5rem;"></i>
                            <p style="color: #666;">No active weather risks detected</p>
                        </div>
                    </div>
                </div>

                <!-- Agricultural Impact Analysis -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-seedling"></i>
                            Agricultural Impact Analysis
                        </h3>
                    </div>
                    <div id="agriculturalImpactContainer">
                        <div class="empty-state" style="padding: 2rem;">
                            <i class="fas fa-info-circle" style="font-size: 2rem; color: #3b82f6; margin-bottom: 0.5rem;"></i>
                            <p style="color: #666;">Agricultural impact analysis will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Food Security Alerts Section -->
            <div id="alertsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Food Security Alerts</h2>
                        <p class="section-subtitle">Stay informed about agricultural alerts</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-alerts">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Alerts Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search alerts..." id="alertsSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="alertsLevelFilter">
                            <option value="">All Levels</option>
                            <option value="CRITICAL">Critical</option>
                            <option value="HIGH">High</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="LOW">Low</option>
                            <option value="INFO">Info</option>
                        </select>
                        <select class="filter-select" id="alertsCategoryFilter">
                            <option value="">All Categories</option>
                            <option value="PRODUCTION">Production</option>
                            <option value="WEATHER">Weather</option>
                            <option value="MARKET">Market</option>
                            <option value="DISEASE">Disease</option>
                            <option value="POLICY">Policy</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-alerts-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Alerts Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="alertsCriticalCount">0</div>
                            <div class="stat-mini-label">Critical Alerts</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="alertsHighCount">0</div>
                            <div class="stat-mini-label">High Priority</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="alertsTotalCount">0</div>
                            <div class="stat-mini-label">Total Alerts</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green);">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="aiAlertsCount">0</div>
                            <div class="stat-mini-label">AI-Generated</div>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Section -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-brain"></i>
                            AI-Powered Alert Analysis
                        </h3>
                        <button class="btn btn-primary" onclick="generateAIAnalysis()" id="generateAIAnalysisBtn">
                            <i class="fas fa-magic"></i>
                            Generate AI Analysis
                        </button>
                    </div>
                    <div id="aiAnalysisContainer">
                        <div class="empty-state" style="padding: 3rem;">
                            <i class="fas fa-brain" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;"></i>
                            <p style="color: #666;">Click "Generate AI Analysis" to get intelligent insights based on your real farm data</p>
                        </div>
                    </div>
                </div>

                <!-- Alerts Grid -->
                <div class="alerts-list" id="alertsList">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading alerts...</p>
                    </div>
                </div>
            </div>

            <!-- Policies Section -->
            <div id="policiesSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Agricultural Policies & Subsidies</h2>
                        <p class="section-subtitle">Explore available government support</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-policies">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Policies Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search policies..." id="policiesSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="policiesTypeFilter">
                            <option value="">All Types</option>
                            <option value="SUBSIDY">Subsidy</option>
                            <option value="CREDIT_PROGRAM">Credit Program</option>
                            <option value="INSURANCE">Insurance</option>
                            <option value="REGULATION">Regulation</option>
                            <option value="SUPPORT_PROGRAM">Support Program</option>
                        </select>
                        <select class="filter-select" id="policiesStatusFilter">
                            <option value="">All Status</option>
                            <option value="ACTIVE">Active</option>
                            <option value="DRAFT">Draft</option>
                            <option value="EXPIRED">Expired</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-policies-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Policies Grid -->
                <div class="policies-grid" id="policiesGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading policies...</p>
                    </div>
                </div>
            </div>

            <!-- AI Recommendations Section -->
            <div id="recommendationsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">AI Recommendations & Predictions</h2>
                        <p class="section-subtitle">Get intelligent insights and predictions for your farm</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" onclick="generateAIRecommendations()" id="generateAIRecommendationsBtn">
                            <i class="fas fa-brain"></i>
                            Generate AI Analysis
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-recommendations">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- AI Chat Assistant -->
                <div class="chart-card" style="margin-bottom: 32px;">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-robot"></i>
                            AI Agricultural Assistant
                        </h3>
                        <span style="font-size: 12px; color: var(--text-secondary);">
                            Ask me anything about agriculture, your farm, or get recommendations
                        </span>
                    </div>
                    <div id="aiChatContainer" style="max-height: 500px; overflow-y: auto; padding: 20px; background: var(--bg-secondary); border-radius: 12px;">
                        <div id="aiChatMessages" style="display: flex; flex-direction: column; gap: 16px; min-height: 200px;">
                            <div class="ai-message ai-assistant" style="padding: 16px; background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--primary-green); border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i class="fas fa-robot" style="color: var(--primary-green);"></i>
                                    <strong style="color: var(--text-primary);">AI Assistant</strong>
                                </div>
                                <p style="color: var(--text-secondary); margin: 0; line-height: 1.6;">
                                    Hello! I'm your AI agricultural assistant. I can help you with:
                                </p>
                                <ul style="margin: 8px 0 0 20px; color: var(--text-secondary); line-height: 1.8;">
                                    <li>Farm management recommendations</li>
                                    <li>Crop production predictions</li>
                                    <li>Weather impact analysis</li>
                                    <li>Market insights</li>
                                    <li>Best practices for your specific crops</li>
                                </ul>
                                <p style="color: var(--text-secondary); margin: 8px 0 0 0; line-height: 1.6;">
                                    Ask me anything about your farm or agriculture in general!
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <input type="text" id="aiChatInput" placeholder="Ask a question about agriculture, your farm, or get recommendations..." 
                                   style="flex: 1; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px;"
                                   onkeypress="if(event.key === 'Enter') sendAIChatMessage()">
                            <button class="btn btn-primary" onclick="sendAIChatMessage()" id="sendChatBtn">
                                <i class="fas fa-paper-plane"></i>
                                Send
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green);">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="recommendationsTotalCount">0</div>
                            <div class="stat-mini-label">Total Recommendations</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="recommendationsUrgentCount">0</div>
                            <div class="stat-mini-label">Urgent Actions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="recommendationsImplementedCount">0</div>
                            <div class="stat-mini-label">Implemented</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="aiConfidenceScore">--</div>
                            <div class="stat-mini-label">AI Confidence</div>
                        </div>
                    </div>
                </div>

                <!-- Comparison Charts Section -->
                <div class="chart-card" style="margin-bottom: 32px;">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            Data Comparison & Trends
                        </h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
                        <div>
                            <h4 style="margin-bottom: 12px; color: var(--text-primary);">Production Trends</h4>
                            <canvas id="productionTrendsChart" style="max-height: 300px;"></canvas>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 12px; color: var(--text-primary);">Cost Analysis</h4>
                            <canvas id="costAnalysisChart" style="max-height: 300px;"></canvas>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 12px; color: var(--text-primary);">Yield Predictions</h4>
                            <canvas id="yieldPredictionsChart" style="max-height: 300px;"></canvas>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 12px; color: var(--text-primary);">Resource Usage</h4>
                            <canvas id="resourceUsageChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recommendations Filter -->
                <div class="filter-section">
                    <div class="filter-controls">
                        <select class="filter-select" id="recommendationsTypeFilter">
                            <option value="">All Types</option>
                            <option value="FERTILIZER">Fertilizer</option>
                            <option value="WATER">Water</option>
                            <option value="IRRIGATION">Irrigation</option>
                            <option value="SEEDS">Seeds</option>
                            <option value="PESTICIDE">Pesticide</option>
                            <option value="SOIL_MANAGEMENT">Soil Management</option>
                            <option value="HARVEST">Harvest</option>
                            <option value="PLANTING">Planting</option>
                            <option value="WEATHER_ADAPTATION">Weather Adaptation</option>
                            <option value="MARKET_TIMING">Market Timing</option>
                        </select>
                        <select class="filter-select" id="recommendationsPriorityFilter">
                            <option value="">All Priorities</option>
                            <option value="URGENT">Urgent</option>
                            <option value="HIGH">High</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="LOW">Low</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-recommendations-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Recommendations Grid -->
                <div class="recommendations-grid" id="recommendationsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading AI recommendations...</p>
                    </div>
                </div>
            </div>

            <!-- Production Predictions Section -->
            <div id="predictionsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Production Predictions</h2>
                        <p class="section-subtitle">AI-powered production forecasts</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-predictions">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Predictions Grid -->
                <div class="predictions-grid" id="predictionsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading predictions...</p>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Reports & Analytics</h2>
                        <p class="section-subtitle">Generate comprehensive farm reports</p>
                    </div>
                </div>

                <!-- Report Configuration -->
                <div class="report-config-card">
                    <h3 class="report-config-title">Report Configuration</h3>
                    <div class="report-config-grid">
                        <div class="form-group">
                            <label class="form-label">Report Type</label>
                            <select class="form-select" id="reportType">
                                <option value="farm-overview">Farm Overview</option>
                                <option value="production-summary">Production Summary</option>
                                <option value="financial-report">Financial Report</option>
                                <option value="resource-usage">Resource Usage</option>
                                <option value="inventory-report">Inventory Report</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Time Period</label>
                            <select class="form-select" id="reportPeriod">
                                <option value="this-month">This Month</option>
                                <option value="last-month">Last Month</option>
                                <option value="this-quarter">This Quarter</option>
                                <option value="this-year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">From Date</label>
                            <input type="date" class="form-input" id="reportDateFrom">
                        </div>
                        <div class="form-group">
                            <label class="form-label">To Date</label>
                            <input type="date" class="form-input" id="reportDateTo">
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary" data-action="generate-pdf-report">
                            <i class="fas fa-file-pdf"></i>
                            Generate PDF Report
                        </button>
                        <button class="btn btn-info" data-action="generate-excel-report">
                            <i class="fas fa-file-excel"></i>
                            Generate Excel Report
                        </button>
                        <button class="btn btn-secondary" data-action="preview-report">
                            <i class="fas fa-eye"></i>
                            Preview Report
                        </button>
                    </div>
                </div>

                <!-- Report Preview -->
                <div class="report-preview-card" id="reportPreview" style="display: none;">
                    <div class="report-preview-header">
                        <h3 class="report-preview-title">Report Preview</h3>
                        <button class="btn btn-secondary btn-sm" data-action="close-preview">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="report-preview-content" id="reportPreviewContent">
                        <!-- Report content will be inserted here -->
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>




<!-- Modals will be added via JavaScript -->
<div id="modalContainer"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="js/SessionTracker.js"></script>
<script src="js/user_session_handler.js"></script>
<script >




    // ============================================================================
    // GLOBAL CONFIGURATION
    // ============================================================================
    const DEBUG_MODE = false; // <-- AJOUTER CETTE LIGNE ICI (ligne ~20)
    const API_CONFIG = {
      BASE_URL: 'http://localhost:1010/api',
      TIMEOUT: 30000,
      RETRY_ATTEMPTS: 3
    };
      // Authentication state
      let currentUser = null;
      let authToken = null;

      // Charts instances
      let charts = {
      productionTrend: null,
      costBreakdown: null,
      fertilizerCost: null,
      irrigationTrend: null,
      weatherHistory: null
      };

      // ============================================================================
      // UTILITY FUNCTIONS
      // ============================================================================

      /**
      * Show loading overlay
      */
      function showLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'flex';
      }

      /**
      * Hide loading overlay
      */
      function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'none';
      }

      /**
      * Show toast notification
      */
      function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;

      const icon = {
      success: 'fa-check-circle',
      error: 'fa-exclamation-circle',
      warning: 'fa-exclamation-triangle',
      info: 'fa-info-circle'
      }[type] || 'fa-info-circle';

      toast.innerHTML = `
      <i class="fas ${icon}"></i>
      <span>${message}</span>
      <button class="toast-close" onclick="this.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
      `;

      container.appendChild(toast);

      setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease forwards';
      setTimeout(() => toast.remove(), 300);
      }, 5000);
      }




/**
 * Format currency amÃ©liorÃ©
 */
function formatCurrency(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) {
        return 'RWF --';
    }

    // Formater avec sÃ©parateurs de milliers
    const formatted = new Intl.NumberFormat('en-RW', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);

    return `RWF ${formatted}`;
}





      /**
      * Format date
      */
      function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
      }).format(date);
      }

      /**
      * Format datetime
      */
      function formatDateTime(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
      }).format(date);
      }

      /**
      * Get auth headers
      */
      function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      return {
      'Content-Type': 'application/json',
      'Authorization': token ? `Bearer ${token}` : ''
      };
      }





// FarmerDashboard.html - Corrections JavaScript






async function apiRequest(endpoint, options = {}) {
    const url = `${API_CONFIG.BASE_URL}${endpoint}`;

    const config = {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': localStorage.getItem('authToken') ? `Bearer ${localStorage.getItem('authToken')}` : ''
        },
        ...options
    };

    try {
        console.log(`ðŸ”„ API Call: ${config.method} ${url}`);

        const response = await fetch(url, config);

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`âŒ HTTP Error ${response.status}:`, errorText);

            if (response.status === 401) {
                handleUnauthorized();
                throw new Error('Authentication required');
            }

            if (response.status === 500) {
                // âœ… CORRECTION: Pour les endpoints de liste, retourner un tableau vide
                if (endpoint.includes('/v1/inventories/farmer/') ||
                    endpoint.includes('/farms/farmer/') ||
                    endpoint.includes('/v1/crop-productions/farm/')) {  // âœ… CHANGÃ‰ ICI
                    console.warn('Server error for list endpoint, returning empty array');
                    return [];
                }
                throw new Error('Server error: ' + (errorText || 'Internal server error'));
            }

            throw new Error(`HTTP ${response.status}: ${errorText || 'Request failed'}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.warn('âš ï¸ Non-JSON response received');
            return null;
        }

        const data = await response.json();
        console.log(`âœ… API Success: ${endpoint}`, data);
        return data;

    } catch (error) {
        console.error('ðŸ’¥ API Request Failed:', error);

        // âœ… CORRECTION: Pour les endpoints de liste en cas d'erreur rÃ©seau
        if (endpoint.includes('/v1/inventories/farmer/') ||
            endpoint.includes('/farms/farmer/') ||
            endpoint.includes('/v1/crop-productions/farm/')) {  // âœ… CHANGÃ‰ ICI
            console.warn('Network error for list endpoint, returning empty array');
            return [];
        }

        throw error;
    }
}













      /**
      * Handle unauthorized access
      */
      function handleUnauthorized() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = '/login.html';
      }

/**
   * Load user session - VERSION CORRIGÃ‰E
   */
  function loadUserSession() {
    const sessionHandler = UserSessionHandler.getInstance();

    // VÃ©rifier l'authentification
    if (!sessionHandler.isAuthenticated()) {
      handleUnauthorized();
      return null;
    }

    // RÃ©cupÃ©rer l'utilisateur
    const user = sessionHandler.getCurrentUser();
    if (!user) {
      handleUnauthorized();
      return null;
    }

    try {
      // âœ… FIX: S'assurer que currentUser a un ID valide
      currentUser = {
        ...user,
        id: user.id || user.userId || user.farmerId,
        fullName: user.fullName || user.username || 'Farmer',
        email: user.email || '',
        role: user.role || 'FARMER'
      };

      authToken = user.token || sessionHandler.getAuthToken();

      console.log('âœ… User session loaded:', currentUser);
      return currentUser;
    } catch (error) {
      console.error('âŒ Error loading user session:', error);
      handleUnauthorized();
      return null;
    }
  }



  /**
   * Update profile display
   */
  function updateProfileDisplay() {
    if (!currentUser) {
      const sessionHandler = UserSessionHandler.getInstance();
      currentUser = sessionHandler.getCurrentUser();
    }

    if (!currentUser) return;

    const profileName = document.getElementById('profileName');
    const profileAvatar = document.getElementById('profileAvatar');
    const greetingText = document.getElementById('greetingText');

    if (profileName) profileName.textContent = currentUser.fullName || 'Farmer';

    if (greetingText) {
      const hour = new Date().getHours();
      const greeting = hour < 12 ? 'Good Morning' : hour < 18 ? 'Good Afternoon' : 'Good Evening';
      greetingText.textContent = `${greeting}, ${currentUser.fullName || 'Farmer'}!`;
    }

    if (profileAvatar) {
      const photoData = currentUser.photo || currentUser.photoBase64 || currentUser.profileImageUrl;
      if (photoData) {
        const imgSrc = photoData.startsWith('data:image/') || photoData.startsWith('http')
          ? photoData
          : `data:image/jpeg;base64,${photoData}`;
        profileAvatar.innerHTML = `<img src="${imgSrc}" alt="Profile" onerror="this.parentElement.textContent='${(currentUser.fullName || 'F').charAt(0).toUpperCase()}'">`;
      } else {
        profileAvatar.textContent = (currentUser.fullName || 'F').charAt(0).toUpperCase();
      }
    }
  }

      /**
      * Update current date display
      */
      function updateCurrentDate() {
      const dateElement = document.getElementById('currentDate');
      if (dateElement) {
      const today = new Date();
      dateElement.textContent = new Intl.DateTimeFormat('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
      }).format(today);
      }


      }





      // ============================================================================
      // NAVIGATION AND UI MANAGEMENT
      // ============================================================================

      /**
      * Initialize navigation
      */
      function initNavigation() {
      const navLinks = document.querySelectorAll('.nav-link');

      navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
      e.preventDefault();
      const section = link.getAttribute('data-section');
      if (section) {
      navigateToSection(section);
      }
      });
      });

      // Sidebar toggle
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('sidebar');

      if (sidebarToggle && sidebar) {
      sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      });
      }

      // Theme toggle
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
      themeToggle.addEventListener('click', toggleTheme);
      loadThemePreference();
      }

      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
      logoutBtn.addEventListener('click', handleLogout);
      }
      }






      /**
 * Navigate to a specific section
 */
function navigateToSection(sectionName) {
    console.log('ðŸ”„ Navigating to section:', sectionName);

    // Hide all sections
    const sections = document.querySelectorAll('.content-section');
    sections.forEach(section => {
        section.classList.remove('active');
        section.style.display = 'none'; // âœ… Force hide
    });

    // â­ CORRECTION: Trouver la section correcte
    let targetSection;

    // Mapping des noms de section vers les IDs
    const sectionMapping = {
        'dashboard': 'dashboardSection',
        'farms': 'farmsSection',
        'crops': 'cropsSection',
        'productions': 'productionsSection',
        'fertilizers': 'fertilizersSection',
        'supply-chain': 'supplyChainSection', // âœ… Mapping correct
        'weather': 'weatherSection',
        'market-prices': 'marketPricesSection',
        'reports': 'reportsSection',
        'settings': 'settingsSection'
    };

    const sectionId = sectionMapping[sectionName] || `${sectionName}Section`;
    targetSection = document.getElementById(sectionId);

    if (targetSection) {
        // âœ… Force l'affichage de la section
        targetSection.classList.add('active');
        targetSection.style.display = 'block';
        targetSection.style.opacity = '1';
        targetSection.style.visibility = 'visible';

        console.log('âœ… Section found and activated:', sectionName);

        // Scroll to top
        window.scrollTo(0, 0);
    } else {
        console.error('âŒ Section not found:', sectionName, 'with ID:', sectionId);

        // Debug: List all available sections
        console.log('ðŸ“‹ Available sections:',
            Array.from(document.querySelectorAll('.content-section'))
                .map(s => s.id)
        );
    }

    // Update nav active state
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        const parentLi = link.closest('li');
        if (parentLi) {
            parentLi.classList.remove('active');
        }
        if (link.getAttribute('data-section') === sectionName) {
            const parentLi = link.closest('li');
            if (parentLi) {
                parentLi.classList.add('active');
            }
        }
    });

    // Load section data
    console.log('ðŸ“Š Loading data for section:', sectionName);
    loadSectionData(sectionName);
}

/**
 * Load data for specific section - VERSION CORRIGÃ‰E
 */
async function loadSectionData(sectionName) {
    console.log('ðŸ“Š loadSectionData called for:', sectionName);

    try {
        switch (sectionName) {
            case 'dashboard':
                await loadDashboardData();
                break;
            case 'farms':
                await loadFarmData();
                break;
            case 'crops':
                await loadCropData();
                break;
            case 'productions':
                await loadProductionData();
                break;
            case 'inventory': // â­ AJOUTER CE CAS
                await loadInventoryData();
                break;
            case 'fertilizers':
                await loadFertilizerData();
                break;
            case 'supply-chain':
                await loadSupplyChainData();
                break;
            case 'weather':
                await loadWeatherData();
                break;
            case 'market-prices':
                await loadMarketPricesData();
                break;
            case 'reports':
                // Load reports if needed
                break;
            case 'settings':
                // Load settings if needed
                break;
            default:
                console.warn('âš ï¸ No data loader for section:', sectionName);
        }
    } catch (error) {
        console.error(`âŒ Error loading data for ${sectionName}:`, error);
    }
}




/**
 * Toggle theme - VERSION CORRIGÃ‰E
 */
function toggleTheme() {
  const body = document.body;
  const themeToggle = document.getElementById('themeToggle');

  // Toggle dark mode class
  const isDark = body.classList.toggle('dark-mode');

  // Save preference
  localStorage.setItem('theme', isDark ? 'dark' : 'light');

  // Update button
  if (themeToggle) {
    const icon = themeToggle.querySelector('i');
    const text = themeToggle.querySelector('span');

    if (isDark) {
      if (icon) icon.className = 'fas fa-sun';
      if (text) text.textContent = 'Light Mode';
    } else {
      if (icon) icon.className = 'fas fa-moon';
      if (text) text.textContent = 'Dark Mode';
    }
  }

  console.log('âœ… Theme toggled to:', isDark ? 'dark' : 'light');
}

/**
 * Load theme preference - VERSION CORRIGÃ‰E
 */
function loadThemePreference() {
  const theme = localStorage.getItem('theme');
  const body = document.body;
  const themeToggle = document.getElementById('themeToggle');

  if (theme === 'dark') {
    body.classList.add('dark-mode');

    if (themeToggle) {
      const icon = themeToggle.querySelector('i');
      const text = themeToggle.querySelector('span');

      if (icon) icon.className = 'fas fa-sun';
      if (text) text.textContent = 'Light Mode';
    }

    console.log('âœ… Dark mode loaded from preferences');
  }
}
      /**
      * Handle logout
      */
      function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = '/login.html';
      }
      }

      // ============================================================================
      // DASHBOARD HOME MODULE
      // ============================================================================

      /**
      * Load dashboard data
      */
      async function loadDashboardData() {
      try {
      showLoading();

      // Load all dashboard components in parallel
      await Promise.all([
      loadDashboardStats(),
      loadDashboardCharts(),
      loadUpcomingTasks(),
      loadRecentActivities(),
      loadCriticalAlerts(),
      loadWeatherWidget()
      ]);

      } catch (error) {
      console.error('Error loading dashboard:', error);
      showToast('Error loading dashboard data', 'error');
      } finally {
      hideLoading();
      }
      }




/**
 * Load dashboard stats - VERSION AMÃ‰LIORÃ‰E
 */
async function loadDashboardStats() {
    try {
        // âœ… VALIDATION UTILISATEUR ROBUSTE
        if (!currentUser || !currentUser.id) {
            console.warn('âš ï¸ No current user found in dashboard stats');
            displayDefaultStats();
            return;
        }

        console.log('ðŸ”„ Loading dashboard stats for user:', currentUser.id);

        // RÃ‰CUPÃ‰RATION FERMES avec gestion d'erreur
        let farms = [];
        try {
            const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
            farms = Array.isArray(farmsResponse) ? farmsResponse : [];
            console.log(`âœ… Loaded ${farms.length} farms for stats`);
        } catch (error) {
            console.warn('âš ï¸ Farms load warning:', error.message);
            farms = [];
        }





        const totalFarms = farms.length;
        const totalArea = farms.reduce((sum, farm) =>
            sum + (parseFloat(farm.farmSize || farm.sizeHectares) || 0), 0);

        // âœ… CORRECTION : RÃ‰CUPÃ‰RATION PRODUCTIONS POUR CHAQUE FERME
        let allProductions = [];
        if (farms.length > 0) {
            try {
                const productionPromises = farms.map(farm =>
                    apiRequest(`/v1/crop-productions/farm/${farm.id}`)
                        .then(response => {
                            // Gestion des diffÃ©rents formats de rÃ©ponse
                            if (Array.isArray(response)) {
                                return response;
                            } else if (response && response.data && Array.isArray(response.data)) {
                                return response.data;
                            } else if (response && response.content && Array.isArray(response.content)) {
                                return response.content;
                            }
                            return [];
                        })
                        .catch(err => {
                            console.warn(`âš ï¸ Production load failed for farm ${farm.id}`);
                            return [];
                        })
                );

                const productionArrays = await Promise.all(productionPromises);
                allProductions = productionArrays.flat().filter(p => p && p.productionStatus);

                console.log(`âœ… Total productions loaded: ${allProductions.length}`);

            } catch (error) {
                console.warn('âš ï¸ Productions load warning:', error.message);
            }
        }
const activeProductions = allProductions.filter(p => {
    if (!p.productionStatus) return false;
    const status = p.productionStatus.toUpperCase();
    return ['PLANTED', 'GROWING', 'PLANNED', 'IN_PROGRESS', 'ACTIVE'].includes(status);
}).length;
        const totalProductions = allProductions.length;

        // RÃ‰CUPÃ‰RATION INVENTAIRE
        let inventory = [];
        let inventoryValue = 0;
        let inventoryItems = 0;

        try {
            const inventoryResponse = await apiRequest(`/v1/inventories/farmer/${currentUser.id}`);

            if (inventoryResponse) {
                if (Array.isArray(inventoryResponse)) {
                    inventory = inventoryResponse;
                } else if (inventoryResponse.data && Array.isArray(inventoryResponse.data)) {
                    inventory = inventoryResponse.data;
                } else if (inventoryResponse.content && Array.isArray(inventoryResponse.content)) {
                    inventory = inventoryResponse.content;
                }
            }

            inventoryValue = inventory.reduce((sum, item) => {
                const value = parseFloat(item.totalMarketValue || 0);
                return sum + (isNaN(value) ? 0 : value);
            }, 0);

            inventoryItems = inventory.length;

        } catch (error) {
            console.warn('âš ï¸ Inventory load warning:', error.message);
        }

        // RÃ‰CUPÃ‰RATION ALERTES
        let alerts = [];
        let criticalAlerts = 0;
        try {
            const alertsResponse = await apiRequest('/food-security-alerts/active');

            if (alertsResponse) {
                if (Array.isArray(alertsResponse)) {
                    alerts = alertsResponse;
                } else if (alertsResponse.data && Array.isArray(alertsResponse.data)) {
                    alerts = alertsResponse.data;
                } else if (alertsResponse.content && Array.isArray(alertsResponse.content)) {
                    alerts = alertsResponse.content;
                }
            }

            criticalAlerts = alerts.filter(a =>
                a && a.alertLevel && ['CRITICAL', 'HIGH'].includes(a.alertLevel)
            ).length;

        } catch (error) {
            console.warn('âš ï¸ Alerts load warning:', error.message);
        }

        // âœ… MISE Ã€ JOUR UI
        updateElement('dashTotalFarms', totalFarms);
        updateElement('dashTotalArea', `${totalArea.toFixed(2)} ha`);
        updateElement('dashActiveProductions', activeProductions);
        updateElement('dashTotalProductions', `${totalProductions} total`);
        updateElement('dashInventoryValue', formatCurrency(inventoryValue));
        updateElement('dashInventoryItems', `${inventoryItems} items`);
        updateElement('dashCriticalAlerts', criticalAlerts);
        updateElement('dashTotalAlerts', `${alerts.length} total alerts`);

        if (DEBUG_MODE) {
            console.log('âœ… Dashboard stats updated:', {
                farms: totalFarms,
                activeProductions,
                totalProductions,
                inventoryItems,
                alerts: alerts.length
            });
        }

    } catch (error) {
        console.error('ðŸ’¥ Error loading dashboard stats:', error);
        displayDefaultStats();
    }
}






/**
 * Reload user session safely
 */
function reloadUserSession() {
    try {
        const sessionHandler = UserSessionHandler.getInstance();

        if (!sessionHandler.isAuthenticated()) {
            console.error('âŒ User not authenticated');
            return null;
        }

        const user = sessionHandler.getCurrentUser();
        if (!user) {
            console.error('âŒ Cannot retrieve user from session');
            return null;
        }

        // Mettre Ã  jour currentUser avec une structure cohÃ©rente
        currentUser = {
            ...user,
            id: user.id || user.userId || user.farmerId,
            fullName: user.fullName || user.username || 'Farmer',
            email: user.email || '',
            role: user.role || 'FARMER'
        };

        authToken = user.token || sessionHandler.getAuthToken();

        console.log('âœ… User session reloaded:', currentUser.id);
        return currentUser;

    } catch (error) {
        console.error('âŒ Error reloading user session:', error);
        return null;
    }
}



/**
 * Afficher des statistiques par dÃ©faut en cas d'erreur
 */
function displayDefaultStats() {
    updateElement('dashTotalFarms', 0);
    updateElement('dashTotalArea', '0 ha');
    updateElement('dashActiveProductions', 0);
    updateElement('dashTotalProductions', '0 total');
    updateElement('dashInventoryValue', formatCurrency(0));
    updateElement('dashInventoryItems', '0 items');
    updateElement('dashCriticalAlerts', 0);
    updateElement('dashTotalAlerts', '0 total alerts');
}







/**
 * Load dashboard charts - VERSION CORRIGÃ‰E
 */
async function loadDashboardCharts() {
    try {
        console.log('ðŸ”„ Loading dashboard charts...');

        // âœ… VALIDATION ROBUSTE DE L'UTILISATEUR
        if (!currentUser || !currentUser.id) {
            console.warn('âš ï¸ No user found for charts, trying to reload session...');

            // Tentative de rechargement de la session
            const sessionHandler = UserSessionHandler.getInstance();
            const user = sessionHandler.getCurrentUser();

            if (user && user.id) {
                currentUser = {
                    ...user,
                    id: user.id || user.userId || user.farmerId,
                    fullName: user.fullName || user.username || 'Farmer'
                };
                console.log('âœ… User session reloaded for charts:', currentUser.id);
            } else {
                console.error('âŒ Cannot load charts: No user ID available');
                createEmptyCharts(); // CrÃ©er des graphiques vides
                return;
            }
        }

        console.log('ðŸ‘¤ Loading charts for user ID:', currentUser.id);

        // RÃ©cupÃ©rer les fermes
        let farms = [];
        try {
            const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
            farms = Array.isArray(farmsResponse) ? farmsResponse : [];
            console.log(`âœ… Loaded ${farms.length} farms for charts`);
        } catch (error) {
            console.warn('âš ï¸ Error loading farms for charts:', error.message);
            farms = [];
        }

        // DonnÃ©es par dÃ©faut pour les graphiques
        let chartData = {
            productionTrend: Array(6).fill(0).map((_, i) => ({
                month: new Date(new Date().getFullYear(), new Date().getMonth() - (5 - i), 1)
                    .toLocaleString('default', { month: 'short' }),
                year: new Date().getFullYear(),
                value: 0
            })),
            costBreakdown: {
                fertilizer: 0,
                irrigation: 0,
                storage: 0
            }
        };

        // Si des fermes existent, essayer de rÃ©cupÃ©rer les donnÃ©es rÃ©elles
        if (farms.length > 0) {
            try {
                // RÃ©cupÃ©rer les productions pour toutes les fermes
                let productions = [];
                const productionPromises = farms.map(farm =>
                    apiRequest(`/v1/crop-productions/farm/${farm.id}`).catch(() => [])
                );
                const productionArrays = await Promise.all(productionPromises);
                productions = productionArrays.flat().filter(p => p);

                // Calculer les donnÃ©es de production pour les 6 derniers mois
                const last6Months = [];
                const today = new Date();
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    last6Months.push({
                        month: date.toLocaleString('default', { month: 'short' }),
                        year: date.getFullYear(),
                        value: 0
                    });
                }

                productions.forEach(prod => {
                    if (prod.actualYield && prod.actualHarvestDate) {
                        const harvestDate = new Date(prod.actualHarvestDate);
                        const monthKey = harvestDate.toLocaleString('default', { month: 'short' });
                        const monthData = last6Months.find(m =>
                            m.month === monthKey && m.year === harvestDate.getFullYear()
                        );
                        if (monthData) {
                            monthData.value += parseFloat(prod.actualYield) || 0;
                        }
                    }
                });

                chartData.productionTrend = last6Months;

                // DonnÃ©es de coÃ»ts
                let fertilizers = [];
                try {
                    const fertilizerResponse = await apiRequest(`/fertilizer-usages/farmer/${currentUser.id}`);
                    fertilizers = Array.isArray(fertilizerResponse) ? fertilizerResponse : [];
                } catch (error) {
                    console.warn('Error loading fertilizer data for charts:', error);
                    fertilizers = [];
                }

                let irrigations = [];
                try {
                    const irrigationResponse = await apiRequest(`/irrigation/farmer/${currentUser.id}`);
                    irrigations = Array.isArray(irrigationResponse) ? irrigationResponse :
                                (irrigationResponse && Array.isArray(irrigationResponse.content)) ? irrigationResponse.content : [];
                } catch (error) {
                    console.warn('Error loading irrigation data for charts:', error);
                    irrigations = [];
                }

                chartData.costBreakdown = {
                    fertilizer: fertilizers.reduce((sum, f) => sum + (parseFloat(f.totalCost) || 0), 0),
                    irrigation: irrigations.reduce((sum, i) => sum + (parseFloat(i.totalCost) || 0), 0),
                    storage: 50000 // Valeur par dÃ©faut
                };

            } catch (error) {
                console.warn('âš ï¸ Error loading detailed chart data, using defaults:', error.message);
            }
        }

        // CrÃ©er les graphiques avec les donnÃ©es disponibles
        createProductionTrendChart(chartData.productionTrend);
        createCostBreakdownChart(chartData.costBreakdown);

        console.log('âœ… Dashboard charts loaded successfully');

    } catch (error) {
        console.error('âŒ Error loading dashboard charts:', error);
        createEmptyCharts(); // CrÃ©er des graphiques vides en cas d'erreur
    }
}

/**
 * Create empty charts as fallback
 */
function createEmptyCharts() {
    console.log('ðŸ“Š Creating empty charts as fallback...');

    // Graphique de tendance de production vide
    const emptyProductionData = Array(6).fill(0).map((_, i) => ({
        month: new Date(new Date().getFullYear(), new Date().getMonth() - (5 - i), 1)
            .toLocaleString('default', { month: 'short' }),
        value: 0
    }));

    createProductionTrendChart(emptyProductionData);

    // Graphique de rÃ©partition des coÃ»ts vide
    createCostBreakdownChart({
        fertilizer: 0,
        irrigation: 0,
        storage: 0
    });
}




function createProductionTrendChart(data) {
    const ctx = document.getElementById('productionTrendChart');
    if (!ctx) {
        console.warn('âš ï¸ Production trend chart canvas not found');
        return;
    }

    // âœ… VALIDATION DES DONNÃ‰ES
    if (!Array.isArray(data) || data.length === 0) {
        console.warn('âš ï¸ No data for production trend chart');
        return;
    }

    try {
        // âœ… DÃ‰TRUIRE L'ANCIEN GRAPHIQUE
        if (charts.productionTrend) {
            charts.productionTrend.destroy();
            charts.productionTrend = null;
        }

        // âœ… PRÃ‰PARER LES DONNÃ‰ES
        const labels = data.map(d => d.month || 'N/A');
        const values = data.map(d => {
            const val = parseFloat(d.value);
            return isNaN(val) ? 0 : val;
        });

        console.log('ðŸ“Š Chart Labels:', labels);
        console.log('ðŸ“Š Chart Values:', values);

        // âœ… CRÃ‰ER LE NOUVEAU GRAPHIQUE
        charts.productionTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Production (Tonnes)',
                    data: values,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#22c55e',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y || 0;
                                return `Production: ${value.toFixed(2)} T`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + ' T';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        console.log('âœ… Production trend chart created successfully');

    } catch (error) {
        console.error('âŒ Error creating production trend chart:', error);
    }
}




      /**
      * Create cost breakdown chart
      */
      function createCostBreakdownChart(costs) {
      const ctx = document.getElementById('costBreakdownChart');
      if (!ctx) return;

      if (charts.costBreakdown) {
      charts.costBreakdown.destroy();
      }

      charts.costBreakdown = new Chart(ctx, {
      type: 'doughnut',
      data: {
      labels: ['Fertilizer', 'Irrigation', 'Storage'],
      datasets: [{
      data: [costs.fertilizer, costs.irrigation, costs.storage],
      backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b'],
      borderWidth: 0
      }]
      },
      options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
      legend: {
      position: 'bottom'
      }
      }
      }
      });
      }



/**
 * Load upcoming tasks - VERSION CORRIGÃ‰E
 */
async function loadUpcomingTasks() {
    try {
        const container = document.getElementById('upcomingTasksList');
        if (!container) return;

        // âœ… VALIDATION UTILISATEUR AVEC FALLBACK
        if (!currentUser || !currentUser.id) {
            console.warn('âš ï¸ No user for tasks, displaying empty state');
            displayEmptyTasks(container);
            return;
        }

        let farms = [];
        try {
            const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
            farms = farmsResponse || [];
        } catch (error) {
            console.warn('âš ï¸ Error loading farms for tasks:', error.message);
            farms = [];
        }

        let productions = [];
        if (farms.length > 0) {
            try {
                const productionPromises = farms.map(farm =>
                    apiRequest(`/v1/crop-productions/farm/${farm.id}`).catch(() => [])
                );
                const productionArrays = await Promise.all(productionPromises);
                productions = productionArrays.flat();
            } catch (error) {
                console.warn('âš ï¸ Error loading productions for tasks:', error.message);
                productions = [];
            }
        }

        const today = new Date();
        const upcoming = productions
            .filter(p => p && p.expectedHarvestDate && new Date(p.expectedHarvestDate) > today)
            .sort((a, b) => new Date(a.expectedHarvestDate) - new Date(b.expectedHarvestDate))
            .slice(0, 5);

        if (upcoming.length === 0) {
            displayEmptyTasks(container);
            return;
        }

        container.innerHTML = upcoming.map(prod => {
            const daysUntil = Math.ceil((new Date(prod.expectedHarvestDate) - today) / (1000 * 60 * 60 * 24));
            return `
                <div class="task-item">
                    <div class="task-icon">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <div class="task-content">
                        <div class="task-title">Harvest ${prod.cropName || 'Crop'}</div>
                        <div class="task-date">Expected in ${daysUntil} days</div>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('âŒ Error loading upcoming tasks:', error);
        const container = document.getElementById('upcomingTasksList');
        if (container) displayEmptyTasks(container);
    }
}

/**
 * Display empty tasks state
 */
function displayEmptyTasks(container) {
    container.innerHTML = `
        <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <p>No upcoming tasks</p>
        </div>
    `;
}

/**
 * â­ FONCTION MISE Ã€ JOUR: Load recent activities with crop names
 */
async function loadRecentActivities() {
    try {
        const container = document.getElementById('recentActivitiesList');
        if (!container) return;

        // âœ… VALIDATION UTILISATEUR AVEC FALLBACK
        if (!currentUser || !currentUser.id) {
            console.warn('âš ï¸ No user for activities, displaying empty state');
            displayEmptyActivities(container);
            return;
        }

        console.log('ðŸ”„ Loading recent activities for user:', currentUser.id);

        const activities = [];

        // â­ Ã‰TAPE 1: Charger tous les crops UNE SEULE FOIS
        let cropsMap = {};
        try {
            const cropsResponse = await apiRequest('/v1/crops/all');
            let crops = [];

            if (Array.isArray(cropsResponse)) {
                crops = cropsResponse;
            } else if (cropsResponse && cropsResponse.data) {
                crops = Array.isArray(cropsResponse.data) ? cropsResponse.data : [];
            }

            // CrÃ©er une map cropId -> cropName pour lookup rapide
            crops.forEach(crop => {
                if (crop && crop.id && crop.cropName) {
                    cropsMap[crop.id] = crop.cropName;
                }
            });

            console.log(`âœ… Loaded ${Object.keys(cropsMap).length} crops for activities`);

        } catch (error) {
            console.warn('âš ï¸ Error loading crops:', error.message);
        }

        // â­ Ã‰TAPE 2: Charger les productions directement par farmer ID
        let productions = [];
        try {
            const productionsResponse = await apiRequest(`/v1/crop-productions/by-farmer/${currentUser.id}`);

            if (Array.isArray(productionsResponse)) {
                productions = productionsResponse;
            } else if (productionsResponse && productionsResponse.data) {
                if (Array.isArray(productionsResponse.data)) {
                    productions = productionsResponse.data;
                } else if (productionsResponse.data.content && Array.isArray(productionsResponse.data.content)) {
                    productions = productionsResponse.data.content;
                }
            } else if (productionsResponse && productionsResponse.content && Array.isArray(productionsResponse.content)) {
                productions = productionsResponse.content;
            }

            console.log(`âœ… Loaded ${productions.length} productions for activities`);

        } catch (error) {
            console.warn('âš ï¸ Error loading productions:', error.message);
            productions = [];
        }

        // â­ Ã‰TAPE 3: Enrichir et crÃ©er les activitÃ©s
        const recentProductions = productions
            .filter(prod => prod && prod.productionStatus) // Filtrer les productions valides
            .slice(0, 10); // Limiter Ã  10 plus rÃ©centes

        recentProductions.forEach(prod => {
            // RÃ©cupÃ©rer le nom de la culture depuis la map
            const cropName = cropsMap[prod.cropId] || 'Unknown Crop';

            // Formatter le statut
            const status = prod.productionStatus || 'Unknown';

            // CrÃ©er l'activitÃ©
            activities.push({
                icon: 'fa-seedling',
                title: `${status} - ${cropName}`,
                date: prod.plantingDate || prod.createdAt || new Date().toISOString(),
                type: 'production',
                details: {
                    season: prod.season,
                    year: prod.year,
                    area: prod.areaPlanted
                }
            });

            console.log(`âœ… Activity created: ${status} - ${cropName}`);
        });

        // â­ Ã‰TAPE 4: Trier par date (plus rÃ©cent en premier)
        activities.sort((a, b) => new Date(b.date) - new Date(a.date));
        const recent = activities.slice(0, 10);

        // â­ Ã‰TAPE 5: Afficher les activitÃ©s
        if (recent.length === 0) {
            displayEmptyActivities(container);
            return;
        }

        container.innerHTML = recent.map(activity => `
            <div class="activity-item">
                <div class="activity-icon">
                    <i class="fas ${activity.icon}"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-title">${activity.title}</div>
                    <div class="activity-date">${formatDateTime(activity.date)}</div>
                    ${activity.details ? `
                        <div class="activity-details">
                            <small>
                                ${activity.details.season ? `${activity.details.season} ${activity.details.year || ''}` : ''}
                                ${activity.details.area ? ` â€¢ ${activity.details.area} ha` : ''}
                            </small>
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('');

        console.log(`âœ… Displayed ${recent.length} recent activities`);

    } catch (error) {
        console.error('âŒ Error loading recent activities:', error);
        const container = document.getElementById('recentActivitiesList');
        if (container) displayEmptyActivities(container);
    }
}

/**
 * Display empty activities state
 */
function displayEmptyActivities(container) {
    container.innerHTML = `
        <div class="empty-state">
            <i class="fas fa-history"></i>
            <p>No recent activities</p>
        </div>
    `;
}

/**
 * Format date time pour les activitÃ©s
 */
function formatDateTime(dateString) {
    if (!dateString) return 'N/A';

    try {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        // Si moins de 7 jours, afficher "il y a X jours"
        if (diffDays === 0) {
            return 'Today';
        } else if (diffDays === 1) {
            return 'Yesterday';
        } else if (diffDays < 7) {
            return `${diffDays} days ago`;
        } else if (diffDays < 30) {
            const weeks = Math.floor(diffDays / 7);
            return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
        } else {
            // Sinon, afficher la date formatÃ©e
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            };
            return date.toLocaleDateString('en-US', options);
        }
    } catch (error) {
        console.error('Error formatting date:', error);
        return 'N/A';
    }
}






/**
 * Load critical alerts
 */
async function loadCriticalAlerts() {
    try {
        const container = document.getElementById('criticalAlertsGrid');
        if (!container) return;

        const alertsResponse = await apiRequest('/food-security-alerts/active');
        // CORRECTION: S'assurer que c'est toujours un tableau
        const allAlerts = Array.isArray(alertsResponse) ? alertsResponse : [];
        const criticalAlerts = allAlerts.filter(a =>
            ['CRITICAL', 'HIGH'].includes(a.alertLevel)
        ).slice(0, 3);

        if (criticalAlerts.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>No critical alerts at the moment</p>
                </div>
            `;
            return;
        }

        container.innerHTML = criticalAlerts.map(alert => `
            <div class="alert-card alert-${alert.alertLevel.toLowerCase()}">
                <div class="alert-header">
                    <span class="alert-badge">${alert.alertLevel}</span>
                    <span class="alert-date">${formatDate(alert.alertDate)}</span>
                </div>
                <h4 class="alert-title">${alert.alertTitle}</h4>
                <p class="alert-description">${alert.description ? alert.description.substring(0, 100) + '...' : 'No description'}</p>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading critical alerts:', error);
        const container = document.getElementById('criticalAlertsGrid');
        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading alerts</p>
                </div>
            `;
        }
    }
}
      /**
      * Load weather widget
      */
      async function loadWeatherWidget() {
      try {
      const weatherResponse = await apiRequest('/weather-data/recent?days=1');
      const weatherData = weatherResponse && weatherResponse.length > 0 ? weatherResponse[0] : null;

      if (weatherData) {
      updateElement('weatherTemp', `${weatherData.temperature || '--'}Â°C`);
      updateElement('weatherCondition', weatherData.weatherCondition || 'Loading...');
      updateElement('weatherHumidity', `${weatherData.humidity || '--'}%`);
      updateElement('weatherWind', `${weatherData.windSpeed || '--'} km/h`);
      updateElement('weatherRainfall', `${weatherData.rainfall || '--'} mm`);
      updateElement('weatherLocation', `
      <i class="fas fa-map-marker-alt"></i>
      ${weatherData.location || 'Location'}
      `);
      }

      } catch (error) {
      console.error('Error loading weather widget:', error);
      }
      }

      // ============================================================================
      // FARMS MODULE
      // ============================================================================



      /**
      * Display farms grid
      */
      function displayFarmsGrid(farms) {
      const container = document.getElementById('farmsGrid');
      if (!container) return;

      if (farms.length === 0) {
      container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-map-marked-alt"></i>
        <p>No farms registered yet</p>
        <button class="btn btn-primary" onclick="openAddFarmModal()">
          <i class="fas fa-plus"></i>
          Add Your First Farm
        </button>
      </div>
      `;
      return;
      }

      container.innerHTML = farms.map(farm => `
      <div class="farm-card">
        <div class="farm-header">
          <h3 class="farm-name">${farm.farmName}</h3>
          <div class="farm-actions">
            <button class="btn-icon" onclick="editFarm('${farm.id}')" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon" onclick="viewFarmDetails('${farm.id}')" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
        <div class="farm-info">
          <div class="farm-info-item">
            <i class="fas fa-map-marker-alt"></i>
            <span>${farm.location || 'N/A'}</span>
          </div>
          <div class="farm-info-item">
            <i class="fas fa-ruler-combined"></i>
            <span>${farm.sizeHectares} hectares</span>
          </div>
          <div class="farm-info-item">
            <i class="fas fa-mountain"></i>
            <span>${farm.soilType || 'N/A'}</span>
          </div>
          <div class="farm-info-item">
            <i class="fas fa-tint"></i>
            <span>${formatIrrigationSystem(farm.irrigationSystem)}</span>
          </div>
          ${farm.electricityAvailable ?
          '<div class="farm-badge"><i class="fas fa-bolt"></i> Electricity</div>' : ''
          }
        </div>
        <div class="farm-coordinates">
          <small>
            <i class="fas fa-map-pin"></i>
            ${farm.latitude}, ${farm.longitude}
          </small>
        </div>
      </div>
      `).join('');
      }

      /**
      * Format irrigation system
      */
      function formatIrrigationSystem(system) {
      const systems = {
      'RAIN_FED': 'Rain Fed',
      'SPRINKLER': 'Sprinkler',
      'DRIP': 'Drip Irrigation',
      'FLOOD': 'Flood Irrigation',
      'FURROW': 'Furrow Irrigation'
      };
      return systems[system] || system;
      }







/**
 * ============================================
 * FARM MANAGEMENT - FIXED VERSION
 * ============================================
 * Corrections apportÃ©es:
 * 1. Mapping correct des champs: sizeHectares -> farmSize
 * 2. Validation amÃ©liorÃ©e
 * 3. Gestion des erreurs optimisÃ©e
 * 4. Support complet de tous les champs du modÃ¨le backend
 */

/**
 * Open add farm modal - VERSION COMPLÃˆTE CORRIGÃ‰E
 */
function openAddFarmModal() {
  const modalHTML = `
    <div class="modal-overlay show" id="farmModal" onclick="if(event.target === this) closeFarmModal()">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-map-marked-alt"></i>
            Add New Farm
          </h3>
          <button class="modal-close" onclick="closeFarmModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="addFarmForm">
            <div class="form-grid">

              <!-- Farm Name -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-tag"></i>
                  Farm Name *
                </label>
                <input
                  type="text"
                  class="form-input"
                  name="farmName"
                  placeholder="e.g., Green Valley Farm"
                  required
                  minlength="3"
                  maxlength="100"
                >
                <small class="form-hint">Between 3-100 characters</small>
              </div>

              <!-- Farm Code -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-barcode"></i>
                  Farm Code
                </label>
                <input
                  type="text"
                  class="form-input"
                  name="farmCode"
                  placeholder="Auto-generated if empty"
                  maxlength="20"
                >
                <small class="form-hint">Leave empty to auto-generate</small>
              </div>

              <!-- Size (Hectares) -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-ruler-combined"></i>
                  Size (Hectares) *
                </label>
                <input
                  type="number"
                  class="form-input"
                  name="farmSize"
                  step="0.01"
                  min="0.01"
                  max="999999.99"
                  placeholder="e.g., 5.50"
                  required
                >
                <small class="form-hint">Must be greater than 0</small>
              </div>

              <!-- Location -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-map-marker-alt"></i>
                  Location
                </label>
                <input
                  type="text"
                  class="form-input"
                  name="location"
                  placeholder="e.g., Kigali, Gasabo District"
                  maxlength="200"
                >
                <small class="form-hint">Optional: City, District, Province</small>
              </div>

              <!-- Latitude -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-globe"></i>
                  Latitude *
                </label>
                <input
                  type="number"
                  class="form-input"
                  name="latitude"
                  step="0.000001"
                  min="-90"
                  max="90"
                  placeholder="e.g., -1.9536"
                  required
                >
                <small class="form-hint">Between -90 and 90</small>
              </div>

              <!-- Longitude -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-globe-americas"></i>
                  Longitude *
                </label>
                <input
                  type="number"
                  class="form-input"
                  name="longitude"
                  step="0.000001"
                  min="-180"
                  max="180"
                  placeholder="e.g., 30.0606"
                  required
                >
                <small class="form-hint">Between -180 and 180</small>
              </div>

              <!-- Altitude (Optional) -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-mountain"></i>
                  Altitude (meters)
                </label>
                <input
                  type="number"
                  class="form-input"
                  name="altitude"
                  step="0.01"
                  min="0"
                  placeholder="e.g., 1500"
                >
                <small class="form-hint">Optional: Elevation in meters</small>
              </div>

              <!-- Soil Type -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-layer-group"></i>
                  Soil Type *
                </label>
                <select class="form-select" name="soilType" required>
                  <option value="">Select Soil Type</option>
                  <option value="Clay">ðŸŸ¤ Clay</option>
                  <option value="Loam">ðŸŸ« Loam</option>
                  <option value="Sand">ðŸŸ¡ Sand</option>
                  <option value="Silt">âšª Silt</option>
                  <option value="Sandy Loam">ðŸŸ¨ Sandy Loam</option>
                  <option value="Clay Loam">ðŸŸ« Clay Loam</option>
                  <option value="Silty Clay">ðŸŸ¤ Silty Clay</option>
                  <option value="Sandy Clay">ðŸŸ§ Sandy Clay</option>
                </select>
              </div>

              <!-- Irrigation System -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-tint"></i>
                  Irrigation System
                </label>
                <select class="form-select" name="irrigationSystem">
                  <option value="RAIN_FED">ðŸŒ§ï¸ Rain Fed (Default)</option>
                  <option value="SPRINKLER">ðŸ’¦ Sprinkler System</option>
                  <option value="DRIP">ðŸ’§ Drip Irrigation</option>
                  <option value="FLOOD">ðŸŒŠ Flood Irrigation</option>
                  <option value="MANUAL">âœ‹ Manual Irrigation</option>
                </select>
              </div>

              <!-- Topography -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-chart-area"></i>
                  Topography
                </label>
                <select class="form-select" name="topography">
                  <option value="">Select Topography (Optional)</option>
                  <option value="Flat">â¬œ Flat Terrain</option>
                  <option value="Gentle Slope">ðŸ“ Gentle Slope (0-5Â°)</option>
                  <option value="Moderate Slope">â›°ï¸ Moderate Slope (5-15Â°)</option>
                  <option value="Steep Slope">ðŸ”ï¸ Steep Slope (15-30Â°)</option>
                  <option value="Hilly">ðŸ—» Hilly Terrain</option>
                  <option value="Valley">â›°ï¸ Valley</option>
                  <option value="Terraced">ðŸžï¸ Terraced Land</option>
                </select>
              </div>

              <!-- Water Source -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-water"></i>
                  Water Source
                </label>
                <input
                  type="text"
                  class="form-input"
                  name="waterSource"
                  placeholder="e.g., River, Well, Borehole"
                  maxlength="100"
                >
                <small class="form-hint">Optional: Main water source</small>
              </div>

              <!-- Road Access Quality -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-road"></i>
                  Road Access Quality
                </label>
                <select class="form-select" name="roadAccessQuality">
                  <option value="MODERATE">ðŸš— Moderate (Default)</option>
                  <option value="GOOD">âœ… Good Access</option>
                  <option value="POOR">âš ï¸ Poor Access</option>
                </select>
              </div>

              <!-- Electricity Available -->
              <div class="form-group form-group-full">
                <div class="form-checkbox-container">
                  <label class="form-checkbox">
                    <input type="checkbox" name="electricityAvailable">
                    <span>
                      <i class="fas fa-bolt"></i>
                      Electricity Available on this Farm
                    </span>
                  </label>
                  <small class="form-hint">Check if the farm has electrical power access</small>
                </div>
              </div>

            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeFarmModal()">
                <i class="fas fa-times"></i>
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Save Farm
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;

  // Ajouter l'Ã©couteur d'Ã©vÃ©nement pour le formulaire
  const form = document.getElementById('addFarmForm');
  if (form) {
    form.addEventListener('submit', handleAddFarm);
  }

  // Ajouter validation en temps rÃ©el
  addFormValidation();
}

/**
 * Ajouter validation en temps rÃ©el aux champs du formulaire
 */
function addFormValidation() {
  const form = document.getElementById('addFarmForm');
  if (!form) return;

  // Validation pour la latitude
  const latitudeInput = form.querySelector('input[name="latitude"]');
  if (latitudeInput) {
    latitudeInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (isNaN(value)) {
        this.setCustomValidity('Please enter a valid number');
      } else if (value < -90 || value > 90) {
        this.setCustomValidity('Latitude must be between -90 and 90');
      } else {
        this.setCustomValidity('');
      }
    });
  }

  // Validation pour la longitude
  const longitudeInput = form.querySelector('input[name="longitude"]');
  if (longitudeInput) {
    longitudeInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (isNaN(value)) {
        this.setCustomValidity('Please enter a valid number');
      } else if (value < -180 || value > 180) {
        this.setCustomValidity('Longitude must be between -180 and 180');
      } else {
        this.setCustomValidity('');
      }
    });
  }

  // Validation pour la taille (farmSize)
  const sizeInput = form.querySelector('input[name="farmSize"]');
  if (sizeInput) {
    sizeInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (isNaN(value)) {
        this.setCustomValidity('Please enter a valid number');
      } else if (value <= 0) {
        this.setCustomValidity('Farm size must be greater than 0');
      } else if (value > 999999.99) {
        this.setCustomValidity('Farm size is too large');
      } else {
        this.setCustomValidity('');
      }
    });
  }

  // Validation pour l'altitude
  const altitudeInput = form.querySelector('input[name="altitude"]');
  if (altitudeInput) {
    altitudeInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (this.value && (isNaN(value) || value < 0)) {
        this.setCustomValidity('Altitude must be a positive number');
      } else {
        this.setCustomValidity('');
      }
    });
  }

  // Auto-gÃ©nÃ©ration du Farm Code
  const farmNameInput = form.querySelector('input[name="farmName"]');
  const farmCodeInput = form.querySelector('input[name="farmCode"]');

  if (farmNameInput && farmCodeInput) {
    farmNameInput.addEventListener('blur', function() {
      if (!farmCodeInput.value) {
        const name = this.value.trim();
        if (name) {
          const year = new Date().getFullYear();
          const prefix = name.substring(0, 3).toUpperCase().replace(/[^A-Z]/g, 'X');
          const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
          const code = `FARM-${year}-${prefix}${random}`;
          farmCodeInput.value = code;
        }
      }
    });
  }
}

/**
 * Handle add farm - VERSION CORRIGÃ‰E
 * FIX: Mapping correct des champs selon le modÃ¨le backend
 */
async function handleAddFarm(e) {
  e.preventDefault();

  const formData = new FormData(e.target);

  // CORRECTION PRINCIPALE: Utiliser les bons noms de champs
  const farmData = {
    farmerId: currentUser.id,
    farmName: formData.get('farmName').trim(),
    farmCode: formData.get('farmCode')?.trim() || null,
    farmSize: parseFloat(formData.get('farmSize')), // CORRIGÃ‰: Ã©tait "sizeHectares"
    soilType: formData.get('soilType'),
    latitude: parseFloat(formData.get('latitude')),
    longitude: parseFloat(formData.get('longitude')),
    altitude: formData.get('altitude') ? parseFloat(formData.get('altitude')) : null,
    irrigationSystem: formData.get('irrigationSystem') || 'RAIN_FED',
    topography: formData.get('topography') || null,
    waterSource: formData.get('waterSource')?.trim() || null,
    electricityAvailable: formData.get('electricityAvailable') === 'on',
    roadAccessQuality: formData.get('roadAccessQuality') || 'MODERATE'
  };

  // Validation cÃ´tÃ© client
  const validationErrors = validateFarmData(farmData);
  if (validationErrors.length > 0) {
    showToast('âŒ Validation errors: ' + validationErrors.join(', '), 'error');
    return;
  }

  try {
    showLoading();

    console.log('ðŸ“¤ Sending farm data:', farmData);

    const response = await apiRequest('/farms', {
      method: 'POST',
      body: JSON.stringify(farmData)
    });

    console.log('âœ… Farm created:', response);
    showToast('âœ… Farm added successfully!', 'success');
    closeFarmModal();

    // Recharger les donnÃ©es
    await loadFarmsData();

  } catch (error) {
    console.error('âŒ Error adding farm:', error);

    // Gestion d'erreur amÃ©liorÃ©e
    let errorMessage = 'Error adding farm';

    if (error.message.includes('Farm size is required')) {
      errorMessage = 'Farm size is required and must be greater than 0';
    } else if (error.message.includes('validation')) {
      errorMessage = 'Validation error: Please check all required fields';
    } else if (error.message.includes('duplicate')) {
      errorMessage = 'Farm code already exists. Please use a different code';
    } else {
      errorMessage = error.message;
    }

    showToast('âŒ ' + errorMessage, 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Valider les donnÃ©es du formulaire
 */
function validateFarmData(data) {
  const errors = [];

  // Validations obligatoires
  if (!data.farmName || data.farmName.length < 3) {
    errors.push('Farm name must be at least 3 characters');
  }
  if (!data.farmSize || data.farmSize <= 0) {
    errors.push('Farm size must be greater than 0');
  }
  if (!data.soilType) {
    errors.push('Soil type is required');
  }
  if (!data.latitude || data.latitude < -90 || data.latitude > 90) {
    errors.push('Valid latitude is required (-90 to 90)');
  }
  if (!data.longitude || data.longitude < -180 || data.longitude > 180) {
    errors.push('Valid longitude is required (-180 to 180)');
  }

  // Validations optionnelles
  if (data.altitude !== null && data.altitude < 0) {
    errors.push('Altitude must be positive');
  }
  if (data.farmCode && data.farmCode.length > 20) {
    errors.push('Farm code must not exceed 20 characters');
  }

  return errors;
}





/**
 * ============================================
 * FIX COMPLET: openEditFarmModal
 * ============================================
 */
async function openEditFarmModal(farmId) {
  try {
    showLoading();
    console.log('ðŸ“ Opening edit modal for farm ID:', farmId);

    // âœ… RÃ‰CUPÃ‰RATION DES DONNÃ‰ES DE LA FARM
    const farm = await apiRequest(`/farms/${farmId}`, {
      method: 'GET'
    });

    console.log('âœ… Farm data loaded:', farm);

    // âœ… Helper function pour valeurs sÃ»res
    const safeValue = (value, defaultValue = '') => {
      return (value !== null && value !== undefined) ? value : defaultValue;
    };

    // âœ… CRÃ‰ATION DU HTML DU MODAL
    const modalHTML = `
      <div class="modal-overlay show" id="farmModal" style="display: flex !important;">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fas fa-edit"></i>
              Edit Farm: ${escapeHtml(farm.farmName)}
            </h3>
            <button class="modal-close" onclick="closeFarmModal()" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <form id="editFarmForm" data-farm-id="${farm.id}">
              <div class="form-grid">

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-tag"></i>
                    Farm Name *
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="farmName"
                    value="${escapeHtml(safeValue(farm.farmName))}"
                    required
                    minlength="3"
                    maxlength="100"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-barcode"></i>
                    Farm Code
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="farmCode"
                    value="${escapeHtml(safeValue(farm.farmCode))}"
                    maxlength="20"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-ruler-combined"></i>
                    Size (Hectares) *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="farmSize"
                    value="${safeValue(farm.farmSize || farm.sizeHectares, 0)}"
                    step="0.01"
                    min="0.01"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-map-marker-alt"></i>
                    Location
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="location"
                    value="${escapeHtml(safeValue(farm.location))}"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-globe"></i>
                    Latitude *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="latitude"
                    value="${safeValue(farm.latitude, 0)}"
                    step="0.000001"
                    min="-90"
                    max="90"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-globe-americas"></i>
                    Longitude *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="longitude"
                    value="${safeValue(farm.longitude, 0)}"
                    step="0.000001"
                    min="-180"
                    max="180"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-mountain"></i>
                    Altitude (meters)
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="altitude"
                    value="${safeValue(farm.altitude, '')}"
                    step="0.01"
                    min="0"
                    placeholder="Optional"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-layer-group"></i>
                    Soil Type *
                  </label>
                  <select class="form-select" name="soilType" required>
                    <option value="">Select Soil Type</option>
                    <option value="Clay" ${farm.soilType === 'Clay' ? 'selected' : ''}>ðŸŸ¤ Clay</option>
                    <option value="Loam" ${farm.soilType === 'Loam' ? 'selected' : ''}>ðŸŸ« Loam</option>
                    <option value="Sand" ${farm.soilType === 'Sand' ? 'selected' : ''}>ðŸŸ¡ Sand</option>
                    <option value="Silt" ${farm.soilType === 'Silt' ? 'selected' : ''}>âšª Silt</option>
                    <option value="Sandy Loam" ${farm.soilType === 'Sandy Loam' ? 'selected' : ''}>ðŸŸ¨ Sandy Loam</option>
                    <option value="Clay Loam" ${farm.soilType === 'Clay Loam' ? 'selected' : ''}>ðŸŸ« Clay Loam</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-tint"></i>
                    Irrigation System
                  </label>
                  <select class="form-select" name="irrigationSystem">
                    <option value="RAIN_FED" ${farm.irrigationSystem === 'RAIN_FED' ? 'selected' : ''}>ðŸŒ§ï¸ Rain Fed</option>
                    <option value="SPRINKLER" ${farm.irrigationSystem === 'SPRINKLER' ? 'selected' : ''}>ðŸ’¦ Sprinkler</option>
                    <option value="DRIP" ${farm.irrigationSystem === 'DRIP' ? 'selected' : ''}>ðŸ’§ Drip</option>
                    <option value="FLOOD" ${farm.irrigationSystem === 'FLOOD' ? 'selected' : ''}>ðŸŒŠ Flood</option>
                    <option value="MANUAL" ${farm.irrigationSystem === 'MANUAL' ? 'selected' : ''}>âœ‹ Manual</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-chart-area"></i>
                    Topography
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="topography"
                    value="${escapeHtml(safeValue(farm.topography))}"
                    maxlength="50"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-water"></i>
                    Water Source
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="waterSource"
                    value="${escapeHtml(safeValue(farm.waterSource))}"
                    maxlength="100"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-road"></i>
                    Road Access Quality
                  </label>
                  <select class="form-select" name="roadAccessQuality">
                    <option value="GOOD" ${farm.roadAccessQuality === 'GOOD' ? 'selected' : ''}>âœ… Good</option>
                    <option value="MODERATE" ${(!farm.roadAccessQuality || farm.roadAccessQuality === 'MODERATE') ? 'selected' : ''}>ðŸš— Moderate</option>
                    <option value="POOR" ${farm.roadAccessQuality === 'POOR' ? 'selected' : ''}>âš ï¸ Poor</option>
                  </select>
                </div>

                <div class="form-group form-group-full">
                  <div class="form-checkbox-container">
                    <label class="form-checkbox">
                      <input type="checkbox" name="electricityAvailable" ${farm.electricityAvailable ? 'checked' : ''}>
                      <span>
                        <i class="fas fa-bolt"></i>
                        Electricity Available
                      </span>
                    </label>
                  </div>
                </div>

              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeFarmModal()">
                  <i class="fas fa-times"></i>
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  Update Farm
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `;

    // âœ… INJECTION DANS LE DOM
    const modalContainer = document.getElementById('modalContainer');
    if (!modalContainer) {
      console.error('âŒ modalContainer not found in DOM!');
      showToast('âŒ Modal container not found', 'error');
      return;
    }

    modalContainer.innerHTML = modalHTML;

    // âœ… FORCER L'AFFICHAGE
    setTimeout(() => {
      const modal = document.getElementById('farmModal');
      if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('show');
        console.log('âœ… Modal displayed');
      } else {
        console.error('âŒ Modal element not found after injection');
      }
    }, 50);

    // âœ… ATTACHER L'EVENT LISTENER
    const form = document.getElementById('editFarmForm');
    if (form) {
      form.removeEventListener('submit', handleEditFarmSubmit);
      form.addEventListener('submit', handleEditFarmSubmit);
      console.log('âœ… Form listener attached');
    } else {
      console.error('âŒ Form not found!');
    }

    console.log('âœ… Edit modal setup complete');

  } catch (error) {
    console.error('âŒ Error in openEditFarmModal:', error);
    showToast('âŒ Error loading farm: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}








/**
 * Delete farm with confirmation
 */
async function deleteFarm(farmId, farmName) {
  if (!confirm(`Are you sure you want to delete "${farmName}"?\n\nThis action cannot be undone.`)) {
    return;
  }

  try {
    showLoading();

    await apiRequest(`/farms/${farmId}`, {
      method: 'DELETE'
    });

    showToast('âœ… Farm deleted successfully!', 'success');
    await loadFarmsData();

  } catch (error) {
    console.error('Error deleting farm:', error);
    showToast('âŒ Error deleting farm: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Close farm modal
 */
function closeFarmModal() {
  const modal = document.getElementById('farmModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}





/**
 * ============================================
 * FARMS DISPLAY - COMPLETE FIXED VERSION
 * ============================================
 * Corrections:
 * 1. Added missing displayEmptyFarmsState function
 * 2. Fixed loadFarmsData to properly handle responses
 * 3. Added proper error handling
 * 4. Fixed navigation integration
 */





/**
 * ============================================
 * FARMS DISPLAY - COMPLETE FIXED VERSION
 * ============================================
 * Corrections:
 * 1. Added missing displayEmptyFarmsState function
 * 2. Fixed loadFarmsData to properly handle responses
 * 3. Added proper error handling
 * 4. Fixed navigation integration
 */








/**
 * ============================================
 * FARMS DISPLAY - COMPLETE FIXED VERSION
 * ============================================
 * Corrections:
 * 1. Added missing displayEmptyFarmsState function
 * 2. Fixed loadFarmsData to properly handle responses
 * 3. Added proper error handling
 * 4. Fixed navigation integration
 */

/**
 * Load farms data - FIXED VERSION
 */
async function loadFarmsData() {
  try {
    showLoading();

    // âœ… VALIDATION USER
    if (!currentUser || !currentUser.id) {
      console.error('âŒ No current user found');
      displayEmptyFarmsState();
      return;
    }

    console.log('ðŸ”„ Loading farms for farmer:', currentUser.id);

    // âœ… RÃ‰CUPÃ‰RATION DES FARMS
    let farms = [];
    try {
      const response = await apiRequest(`/farms/farmer/${currentUser.id}/all`, {
        method: 'GET'
      });

      // Gestion multi-format de la rÃ©ponse
      if (Array.isArray(response)) {
        farms = response;
      } else if (response && response.data && Array.isArray(response.data)) {
        farms = response.data;
      } else if (response && response.content && Array.isArray(response.content)) {
        farms = response.content;
      } else {
        console.warn('âš ï¸ Unexpected farms response format:', response);
        farms = [];
      }

      console.log(`âœ… Farms loaded successfully: ${farms.length} farms`);

    } catch (error) {
      console.error('âŒ Error loading farms:', error);
      farms = [];
    }

    // âœ… AFFICHAGE
    if (farms.length === 0) {
      displayEmptyFarmsState();
    } else {
      displayFarms(farms);
      updateFarmStatistics(farms);
    }

  } catch (error) {
    console.error('ðŸ’¥ Critical error in loadFarmsData:', error);
    showToast('âŒ Unable to load farms', 'error');
    displayEmptyFarmsState();
  } finally {
    hideLoading();
  }
}

/**
 * Display empty state when no farms exist - NEW FUNCTION
 */
function displayEmptyFarmsState() {
  const container = document.getElementById('farmsGrid');
  const statsContainer = document.querySelector('.stats-mini-grid');

  if (container) {
    container.innerHTML = `
      <div class="empty-state" style="text-align: center; padding: 60px 20px;">
        <div class="empty-icon" style="font-size: 80px; color: #4CAF50; margin-bottom: 20px;">
          <i class="fas fa-tractor"></i>
        </div>
        <h3 style="font-size: 24px; font-weight: 600; color: #333; margin-bottom: 10px;">
          No Farms Yet
        </h3>
        <p style="font-size: 16px; color: #666; margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto;">
          Start by adding your first farm to begin managing your agricultural operations.
        </p>
        <button class="btn btn-primary" onclick="openAddFarmModal()" style="padding: 12px 30px; font-size: 16px;">
          <i class="fas fa-plus"></i>
          Add Your First Farm
        </button>
      </div>
    `;
  }

  if (statsContainer) {
    // Update stats using existing IDs
    updateElement('farmsTotalCount', '0');
    updateElement('farmsTotalArea', '0 ha');
    updateElement('farmsIrrigated', '0');
    updateElement('farmsActive', '0');
  }
}





/**
 * ============================================
 * DEBUG & FIX: Edit Farm Button Click
 * ============================================
 */

/**
 * Version corrigÃ©e de displayFarms avec debugging
 */
function displayFarms(farms) {
  const container = document.getElementById('farmsGrid');
  if (!container) {
    console.error('âŒ farmsGrid element not found');
    return;
  }

  if (!farms || farms.length === 0) {
    displayEmptyFarmsState();
    return;
  }

  const farmsHTML = farms.map(farm => `
    <div class="farm-card" data-farm-id="${farm.id}">
      <div class="farm-card-header">
        <div class="farm-icon">ðŸšœ</div>
        <h3 class="farm-name">${escapeHtml(farm.farmName)}</h3>
        ${farm.farmCode ? `<span class="farm-code-badge">${escapeHtml(farm.farmCode)}</span>` : ''}
      </div>
      <div class="farm-card-body">
        <div class="farm-info-list">
          <div class="farm-info-item">
            <span class="farm-info-label">Size</span>
            <span class="farm-info-value">${farm.farmSize} ha</span>
          </div>
          <div class="farm-info-item">
            <span class="farm-info-label">Soil Type</span>
            <span class="farm-info-value">${escapeHtml(farm.soilType || 'N/A')}</span>
          </div>
          <div class="farm-info-item">
            <span class="farm-info-label">Irrigation</span>
            <span class="farm-info-value">${formatIrrigationSystem(farm.irrigationSystem)}</span>
          </div>
          <div class="farm-info-item">
            <span class="farm-info-label">Coordinates</span>
            <span class="farm-info-value">${farm.latitude ? farm.latitude.toFixed(4) : 'N/A'}, ${farm.longitude ? farm.longitude.toFixed(4) : 'N/A'}</span>
          </div>
          <div class="farm-info-item">
            <span class="farm-info-label">Electricity</span>
            <span class="farm-info-value">${farm.electricityAvailable ? 'Available' : 'Not Available'}</span>
          </div>
          <div class="farm-info-item">
            <span class="farm-info-label">Farm Size</span>
            <span class="farm-info-value">${getSizeCategory(farm.farmSize)}</span>
          </div>
          <div class="farm-info-item">
            <span class="farm-info-label">Created</span>
            <span class="farm-info-value">${formatDate(farm.createdAt)}</span>
          </div>
        </div>
        <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
          <button class="btn" onclick="editFarm('${farm.id}')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)';">
            <i class="fas fa-edit"></i>
            Edit
          </button>
          <button class="btn" onclick="deleteFarm('${farm.id}', '${farm.farmName.replace(/'/g, "\\'")}')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)';">
            <i class="fas fa-trash"></i>
            Delete
          </button>
        </div>
      </div>
    </div>
  `).join('');

  container.innerHTML = farmsHTML;

  console.log('âœ… Farms displayed:', farms.length);
}








/**
 * Update farm statistics - ENHANCED VERSION
 */
function updateFarmStatistics(farms) {
  const totalFarms = farms.length;
  const totalArea = farms.reduce((sum, farm) => sum + parseFloat(farm.farmSize), 0);

  // Count irrigated farms (not RAIN_FED)
  const irrigatedFarms = farms.filter(f =>
    f.irrigationSystem && f.irrigationSystem !== 'RAIN_FED'
  ).length;

  // All farms are considered active by default
  const activeFarms = totalFarms;

  // Update the mini stats cards
  updateElement('farmsTotalCount', totalFarms);
  updateElement('farmsTotalArea', `${totalArea.toFixed(2)} ha`);
  updateElement('farmsIrrigated', irrigatedFarms);
  updateElement('farmsActive', activeFarms);

  console.log('ðŸ“Š Farm Stats Updated:', {
    total: totalFarms,
    area: totalArea.toFixed(2),
    irrigated: irrigatedFarms,
    active: activeFarms
  });
}

/**
 * Initialize navigation for farms section
 */
function initializeFarmsNavigation() {
  // Initialize action buttons for farms only
  document.querySelectorAll('[data-action="add-farm"]').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      openAddFarmModal();
    });
  });

  document.querySelectorAll('[data-action="refresh-farms"]').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      loadFarmsData();
    });
  });

  document.querySelectorAll('[data-action="export-farms"]').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      // Get current farms from the grid
      const farmCards = document.querySelectorAll('.farm-card');
      if (farmCards.length > 0) {
        showToast('âœ… Export functionality coming soon', 'info');
      } else {
        showToast('âš ï¸ No farms to export', 'warning');
      }
    });
  });
}

/**
 * Initialize main navigation for all sections
 */
function initializeMainNavigation() {
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();

      const section = this.getAttribute('data-section');

      // Hide all sections
      document.querySelectorAll('.content-section').forEach(contentSection => {
        contentSection.classList.remove('active');
        contentSection.style.display = 'none';
      });

      // Update active nav item
      document.querySelectorAll('.nav-link').forEach(navLink => {
        navLink.parentElement.classList.remove('active');
      });
      this.parentElement.classList.add('active');

      // Show selected section
      const targetSection = document.getElementById(`${section}Section`);
      if (targetSection) {
        targetSection.classList.add('active');
        targetSection.style.display = 'block';

        // Load data only for the specific section
        switch(section) {
          case 'farms':
            loadFarmsData();
            break;
          case 'dashboard':
            loadDashboardData();
            break;
          case 'crops':
            loadCropsData();
            break;
          case 'production':
            loadProductionData();
            break;
          case 'inventory':
            loadInventoryData();
            break;
          case 'fertilizer':
            loadFertilizerData();
            break;
          case 'irrigation':
            loadIrrigationData();
            break;
          case 'soil':
            loadSoilData();
            break;
          case 'market-prices':
            loadMarketPricesData();
            break;
          case 'transactions':
            loadTransactionsData();
            break;
          case 'supply-chain':
            loadSupplyChainData();
            break;
          case 'weather':
            loadWeatherData();
            break;
          case 'alerts':
            loadAlertsData();
            break;
          case 'policies':
            loadPoliciesData();
            break;
          case 'recommendations':
            loadRecommendationsData();
            break;
          case 'predictions':
            loadPredictionsData();
            break;
          case 'reports':
            // Reports section doesn't need auto-load
            break;
        }
      }
    });
  });
}

/**
 * Helper function to update element content safely
 */
function updateElement(elementId, content) {
  const element = document.getElementById(elementId);
  if (element) {
    element.textContent = content;
  } else {
    console.warn(`âš ï¸ Element ${elementId} not found`);
  }
}



// ============ INITIALISATION AU CHARGEMENT ============
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Page loaded - Initializing Market Prices...');

    // VÃ©rifier que la section existe
    const section = document.getElementById('marketPricesSection');
    if (section) {
        console.log('âœ… Market Prices section found');
        // S'assurer qu'elle est visible
        section.style.display = 'block';
    } else {
        console.error('âŒ Market Prices section NOT found');
    }

    // Initialiser Market Prices
    if (typeof initMarketPrices === 'function') {
        initMarketPrices();
    } else {
        console.error('âŒ initMarketPrices function not found');
    }
});


/**
 * Initialize when DOM is ready
 */
document.addEventListener('DOMContentLoaded', function() {
  console.log('âœ… Initializing Farms Module');

  // Initialize main navigation for all sections
  initializeMainNavigation();

  // Initialize farms-specific action buttons
  initializeFarmsNavigation();

  // Only load dashboard on initial page load
  const dashboardSection = document.getElementById('dashboardSection');
  if (dashboardSection && dashboardSection.classList.contains('active')) {
    loadDashboardData();
  }
});





/**
 * Helper: Format irrigation system
 */
function formatIrrigationSystem(system) {
  const systems = {
    'RAIN_FED': 'ðŸŒ§ï¸ Rain Fed',
    'SPRINKLER': 'ðŸ’¦ Sprinkler',
    'DRIP': 'ðŸ’§ Drip',
    'FLOOD': 'ðŸŒŠ Flood',
    'MANUAL': 'âœ‹ Manual'
  };
  return systems[system] || system;
}

/**
 * Helper: Format road access
 */
function formatRoadAccess(quality) {
  const qualities = {
    'GOOD': 'âœ… Good',
    'MODERATE': 'ðŸš— Moderate',
    'POOR': 'âš ï¸ Poor'
  };
  return qualities[quality] || quality;
}

/**
 * Helper: Get size category
 */
function getSizeCategory(size) {
  const sizeNum = parseFloat(size);
  if (sizeNum <= 2) return 'Small Farm';
  if (sizeNum <= 10) return 'Medium Farm';
  return 'Large Farm';
}

/**
 * Helper: Format date
 */
function formatDate(dateString) {
  if (!dateString) return 'N/A';

  const date = new Date(dateString);
  const options = {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };

  return date.toLocaleDateString('en-US', options);
}

/**
 * View farm details
 */
async function viewFarmDetails(farmId) {
  try {
    showLoading();

    const farm = await apiRequest(`/farms/${farmId}`, { method: 'GET' });

    const modalHTML = `
      <div class="modal-overlay show" id="farmDetailsModal" onclick="if(event.target === this) closeDetailsModal()">
        <div class="modal-container modal-large">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fas fa-info-circle"></i>
              Farm Details: ${farm.farmName}
            </h3>
            <button class="modal-close" onclick="closeDetailsModal()" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="details-grid">
              <div class="details-section">
                <h4><i class="fas fa-info"></i> Basic Information</h4>
                <dl class="details-list">
                  <dt>Farm Name:</dt>
                  <dd>${farm.farmName}</dd>

                  <dt>Farm Code:</dt>
                  <dd>${farm.farmCode || 'N/A'}</dd>

                  <dt>Size:</dt>
                  <dd>${farm.farmSize} hectares (${getSizeCategory(farm.farmSize)})</dd>

                  <dt>Soil Type:</dt>
                  <dd>${farm.soilType}</dd>
                </dl>
              </div>

              <div class="details-section">
                <h4><i class="fas fa-map-marker-alt"></i> Location</h4>
                <dl class="details-list">
                  <dt>Latitude:</dt>
                  <dd>${farm.latitude}Â°</dd>

                  <dt>Longitude:</dt>
                  <dd>${farm.longitude}Â°</dd>

                  ${farm.altitude ? `
                  <dt>Altitude:</dt>
                  <dd>${farm.altitude} meters</dd>
                  ` : ''}

                  ${farm.topography ? `
                  <dt>Topography:</dt>
                  <dd>${farm.topography}</dd>
                  ` : ''}
                </dl>
              </div>

              <div class="details-section">
                <h4><i class="fas fa-tools"></i> Infrastructure</h4>
                <dl class="details-list">
                  <dt>Irrigation System:</dt>
                  <dd>${formatIrrigationSystem(farm.irrigationSystem)}</dd>

                  ${farm.waterSource ? `
                  <dt>Water Source:</dt>
                  <dd>${farm.waterSource}</dd>
                  ` : ''}

                  <dt>Electricity:</dt>
                  <dd>
                    <span class="badge ${farm.electricityAvailable ? 'badge-success' : 'badge-secondary'}">
                      ${farm.electricityAvailable ? 'âœ… Available' : 'âŒ Not Available'}
                    </span>
                  </dd>

                  <dt>Road Access:</dt>
                  <dd>${formatRoadAccess(farm.roadAccessQuality)}</dd>
                </dl>
              </div>

              <div class="details-section">
                <h4><i class="fas fa-clock"></i> Timestamps</h4>
                <dl class="details-list">
                  <dt>Created:</dt>
                  <dd>${formatDate(farm.createdAt)}</dd>

                  <dt>Last Updated:</dt>
                  <dd>${formatDate(farm.updatedAt)}</dd>
                </dl>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDetailsModal()">
              <i class="fas fa-times"></i>
              Close
            </button>
            <button type="button" class="btn btn-primary" onclick="closeDetailsModal(); openEditFarmModal('${farm.id}')">
              <i class="fas fa-edit"></i>
              Edit Farm
            </button>
          </div>
        </div>
      </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;

  } catch (error) {
    console.error('Error loading farm details:', error);
    showToast('âŒ Error loading farm details', 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Close details modal
 */
function closeDetailsModal() {
  const modal = document.getElementById('farmDetailsModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}

/**
 * Export farms to CSV
 */
function exportFarmsToCSV(farms) {
  if (!farms || farms.length === 0) {
    showToast('âš ï¸ No farms to export', 'warning');
    return;
  }

  const headers = [
    'Farm Name', 'Farm Code', 'Size (ha)', 'Soil Type',
    'Latitude', 'Longitude', 'Altitude (m)', 'Irrigation System',
    'Topography', 'Water Source', 'Electricity', 'Road Access',
    'Created At', 'Updated At'
  ];

  const rows = farms.map(farm => [
    farm.farmName,
    farm.farmCode || '',
    farm.farmSize,
    farm.soilType,
    farm.latitude,
    farm.longitude,
    farm.altitude || '',
    farm.irrigationSystem,
    farm.topography || '',
    farm.waterSource || '',
    farm.electricityAvailable ? 'Yes' : 'No',
    farm.roadAccessQuality,
    farm.createdAt,
    farm.updatedAt
  ]);

  let csvContent = headers.join(',') + '\n';
  rows.forEach(row => {
    csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
  });

  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `farms_export_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);

  showToast('âœ… Farms exported successfully!', 'success');
}

/**
 * Initialize farms module on page load
 */
document.addEventListener('DOMContentLoaded', function() {
  if (window.location.pathname.includes('farmer') || window.location.pathname.includes('farms')) {
    loadFarmsData();
  }
});






/**
 * Helper pour obtenir les noms depuis les relations
 */
async function enrichTransactionsWithNames(transactions) {
  for (let tx of transactions) {
    try {
      // RÃ©cupÃ©rer le nom du buyer
      if (tx.buyerId && !tx.buyerName) {
        try {
          const buyer = await apiRequest(`/users/${tx.buyerId}`);
          tx.buyerName = buyer.fullName || buyer.username || 'Unknown Buyer';
        } catch (err) {
          tx.buyerName = 'Unknown Buyer';
        }
      }

      // RÃ©cupÃ©rer le nom du crop
      if (tx.cropId && !tx.cropName) {
        try {
          const crop = await apiRequest(`/v1/crops/${tx.cropId}`);
          tx.cropName = crop.cropName || 'Unknown Crop';
        } catch (err) {
          tx.cropName = 'Unknown Crop';
        }
      }
    } catch (error) {
      console.warn(`Error enriching transaction ${tx.id}:`, error);
    }
  }
  return transactions;
}


/**
 * âœ… CORRECTION COMPLÃˆTE: Fonction editFarm avec debugging
 */
async function editFarm(farmId) {
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘  ðŸ”„ EDIT FARM CALLED                   â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ðŸ“‹ Farm ID:', farmId);
    console.log('ðŸ“‹ Farm ID Type:', typeof farmId);

    if (!farmId) {
        console.error('âŒ No farm ID provided!');
        showToast('âŒ Farm ID is missing', 'error');
        return;
    }

    try {
        showLoading();
        console.log('â³ Loading started...');

        // âœ… RÃ‰CUPÃ‰RATION DES DONNÃ‰ES
        console.log('ðŸ“¡ Fetching farm data from API...');
        console.log('ðŸ”— URL:', `/farms/${farmId}`);

        const farm = await apiRequest(`/farms/${farmId}`, {
            method: 'GET'
        });

        console.log('âœ… Farm data received:', farm);

        if (!farm) {
            throw new Error('Farm data is null or undefined');
        }

        // âœ… Helper function
        const safeValue = (value, defaultValue = '') => {
            const result = (value !== null && value !== undefined) ? value : defaultValue;
            console.log(`ðŸ”’ SafeValue: ${value} â†’ ${result}`);
            return result;
        };

        console.log('ðŸŽ¨ Creating modal HTML...');

        // âœ… CRÃ‰ATION DU HTML
        const modalHTML = `
            <div class="modal-overlay" id="farmModal" style="display: flex !important; opacity: 1 !important; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 9999;">
                <div class="modal-container" style="background: white; border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                        <h3 class="modal-title" style="margin: 0; font-size: 20px; font-weight: 600;">
                            <i class="fas fa-edit"></i>
                            Edit Farm: ${escapeHtml(farm.farmName)}
                        </h3>
                        <button class="modal-close" onclick="closeFarmModal()" type="button" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <form id="editFarmForm" data-farm-id="${farm.id}">
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-tag"></i> Farm Name *
                                    </label>
                                    <input type="text" class="form-input" name="farmName"
                                           value="${escapeHtml(safeValue(farm.farmName))}"
                                           required minlength="3" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-barcode"></i> Farm Code
                                    </label>
                                    <input type="text" class="form-input" name="farmCode"
                                           value="${escapeHtml(safeValue(farm.farmCode))}"
                                           maxlength="20"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-ruler-combined"></i> Size (Hectares) *
                                    </label>
                                    <input type="number" class="form-input" name="farmSize"
                                           value="${safeValue(farm.farmSize || farm.sizeHectares, 0)}"
                                           step="0.01" min="0.01" required
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-map-marker-alt"></i> Location
                                    </label>
                                    <input type="text" class="form-input" name="location"
                                           value="${escapeHtml(safeValue(farm.location))}"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-globe"></i> Latitude *
                                    </label>
                                    <input type="number" class="form-input" name="latitude"
                                           value="${safeValue(farm.latitude, 0)}"
                                           step="0.000001" min="-90" max="90" required
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-globe-americas"></i> Longitude *
                                    </label>
                                    <input type="number" class="form-input" name="longitude"
                                           value="${safeValue(farm.longitude, 0)}"
                                           step="0.000001" min="-180" max="180" required
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-mountain"></i> Altitude (m)
                                    </label>
                                    <input type="number" class="form-input" name="altitude"
                                           value="${safeValue(farm.altitude, '')}"
                                           step="0.01" min="0" placeholder="Optional"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-layer-group"></i> Soil Type *
                                    </label>
                                    <select class="form-select" name="soilType" required
                                            style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <option value="">Select Soil Type</option>
                                        <option value="Clay" ${farm.soilType === 'Clay' ? 'selected' : ''}>Clay</option>
                                        <option value="Loam" ${farm.soilType === 'Loam' ? 'selected' : ''}>Loam</option>
                                        <option value="Sand" ${farm.soilType === 'Sand' ? 'selected' : ''}>Sand</option>
                                        <option value="Silt" ${farm.soilType === 'Silt' ? 'selected' : ''}>Silt</option>
                                        <option value="Sandy Loam" ${farm.soilType === 'Sandy Loam' ? 'selected' : ''}>Sandy Loam</option>
                                        <option value="Clay Loam" ${farm.soilType === 'Clay Loam' ? 'selected' : ''}>Clay Loam</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-tint"></i> Irrigation System
                                    </label>
                                    <select class="form-select" name="irrigationSystem"
                                            style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <option value="RAIN_FED" ${farm.irrigationSystem === 'RAIN_FED' ? 'selected' : ''}>Rain Fed</option>
                                        <option value="SPRINKLER" ${farm.irrigationSystem === 'SPRINKLER' ? 'selected' : ''}>Sprinkler</option>
                                        <option value="DRIP" ${farm.irrigationSystem === 'DRIP' ? 'selected' : ''}>Drip</option>
                                        <option value="FLOOD" ${farm.irrigationSystem === 'FLOOD' ? 'selected' : ''}>Flood</option>
                                        <option value="MANUAL" ${farm.irrigationSystem === 'MANUAL' ? 'selected' : ''}>Manual</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-chart-area"></i> Topography
                                    </label>
                                    <input type="text" class="form-input" name="topography"
                                           value="${escapeHtml(safeValue(farm.topography))}"
                                           maxlength="50"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-water"></i> Water Source
                                    </label>
                                    <input type="text" class="form-input" name="waterSource"
                                           value="${escapeHtml(safeValue(farm.waterSource))}"
                                           maxlength="100"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-road"></i> Road Access Quality
                                    </label>
                                    <select class="form-select" name="roadAccessQuality"
                                            style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <option value="GOOD" ${farm.roadAccessQuality === 'GOOD' ? 'selected' : ''}>Good</option>
                                        <option value="MODERATE" ${(!farm.roadAccessQuality || farm.roadAccessQuality === 'MODERATE') ? 'selected' : ''}>Moderate</option>
                                        <option value="POOR" ${farm.roadAccessQuality === 'POOR' ? 'selected' : ''}>Poor</option>
                                    </select>
                                </div>

                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-checkbox" style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" name="electricityAvailable" ${farm.electricityAvailable ? 'checked' : ''}>
                                        <span><i class="fas fa-bolt"></i> Electricity Available</span>
                                    </label>
                                </div>

                            </div>

                            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                <button type="button" class="btn btn-secondary" onclick="closeFarmModal()"
                                        style="padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="submit" class="btn btn-primary"
                                        style="padding: 10px 20px; border: none; border-radius: 6px; background: #10b981; color: white; cursor: pointer;">
                                    <i class="fas fa-save"></i> Update Farm
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        // âœ… INJECTION
        const modalContainer = document.getElementById('modalContainer');
        if (!modalContainer) {
            throw new Error('Modal container not found in DOM!');
        }

        console.log('ðŸ’‰ Injecting modal HTML...');
        modalContainer.innerHTML = modalHTML;

        // âœ… VÃ‰RIFICATION
        const modal = document.getElementById('farmModal');
        if (!modal) {
            throw new Error('Modal element not found after injection!');
        }

        console.log('âœ… Modal element found:', modal);
        console.log('ðŸ“ Modal dimensions:', {
            width: modal.offsetWidth,
            height: modal.offsetHeight,
            display: window.getComputedStyle(modal).display,
            opacity: window.getComputedStyle(modal).opacity,
            zIndex: window.getComputedStyle(modal).zIndex
        });

        // âœ… EVENT LISTENER
        const form = document.getElementById('editFarmForm');
        if (!form) {
            throw new Error('Form not found after injection!');
        }

        console.log('âœ… Form found:', form);
        console.log('ðŸ“‹ Form dataset:', form.dataset);

        form.removeEventListener('submit', handleEditFarmSubmit);
        form.addEventListener('submit', handleEditFarmSubmit);
        console.log('âœ… Submit handler attached');

        console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        console.log('â•‘  âœ… EDIT FARM MODAL READY              â•‘');
        console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    } catch (error) {
        console.error('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        console.error('â•‘  âŒ EDIT FARM ERROR                    â•‘');
        console.error('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.error('Error details:', error);
        console.error('Stack trace:', error.stack);
        showToast('âŒ Error: ' + error.message, 'error');
    } finally {
        hideLoading();
        console.log('â³ Loading finished');
    }
}

// âœ… S'assurer que la fonction est globale
if (typeof window !== 'undefined') {
    window.editFarm = editFarm;
    console.log('âœ… editFarm function exported to window');
}






function openEditFarmModal(farm) {
  // Helper function pour gÃ©rer les valeurs undefined/null
  const safeValue = (value, defaultValue = '') => {
    return (value !== null && value !== undefined) ? value : defaultValue;
  };

  const modalHTML = `
  <div class="modal-overlay" id="farmModal">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Edit Farm</h3>
        <button class="modal-close" onclick="closeFarmModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="editFarmForm" data-farm-id="${farm.id}">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Farm Name *</label>
              <input type="text" class="form-input" name="farmName" value="${escapeHtml(safeValue(farm.farmName))}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Farm Code *</label>
              <input type="text" class="form-input" name="farmCode" value="${escapeHtml(safeValue(farm.farmCode))}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Size (Hectares) *</label>
              <input type="number" class="form-input" name="farmSize" value="${safeValue(farm.sizeHectares || farm.farmSize, 0)}" step="0.01" min="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">Location *</label>
              <input type="text" class="form-input" name="location" value="${escapeHtml(safeValue(farm.location))}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Latitude *</label>
              <input type="number" class="form-input" name="latitude" value="${safeValue(farm.latitude, 0)}" step="0.000001" min="-90" max="90" required>
            </div>
            <div class="form-group">
              <label class="form-label">Longitude *</label>
              <input type="number" class="form-input" name="longitude" value="${safeValue(farm.longitude, 0)}" step="0.000001" min="-180" max="180" required>
            </div>
            <div class="form-group">
              <label class="form-label">Soil Type *</label>
              <select class="form-select" name="soilType" required>
                <option value="">Select Soil Type</option>
                <option value="Clay" ${farm.soilType === 'Clay' ? 'selected' : ''}>Clay</option>
                <option value="Loam" ${farm.soilType === 'Loam' ? 'selected' : ''}>Loam</option>
                <option value="Sand" ${farm.soilType === 'Sand' ? 'selected' : ''}>Sand</option>
                <option value="Silt" ${farm.soilType === 'Silt' ? 'selected' : ''}>Silt</option>
                <option value="Sandy Loam" ${farm.soilType === 'Sandy Loam' ? 'selected' : ''}>Sandy Loam</option>
                <option value="Clay Loam" ${farm.soilType === 'Clay Loam' ? 'selected' : ''}>Clay Loam</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Irrigation System *</label>
              <select class="form-select" name="irrigationSystem" required>
                <option value="">Select Irrigation System</option>
                <option value="RAIN_FED" ${farm.irrigationSystem === 'RAIN_FED' ? 'selected' : ''}>Rain Fed</option>
                <option value="SPRINKLER" ${farm.irrigationSystem === 'SPRINKLER' ? 'selected' : ''}>Sprinkler</option>
                <option value="DRIP" ${farm.irrigationSystem === 'DRIP' ? 'selected' : ''}>Drip Irrigation</option>
                <option value="FLOOD" ${farm.irrigationSystem === 'FLOOD' ? 'selected' : ''}>Flood Irrigation</option>
                <option value="FURROW" ${farm.irrigationSystem === 'FURROW' ? 'selected' : ''}>Furrow Irrigation</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Topography</label>
              <input type="text" class="form-input" name="topography" value="${escapeHtml(safeValue(farm.topography))}">
            </div>
            <div class="form-group">
              <label class="form-label">Water Source</label>
              <input type="text" class="form-input" name="waterSource" value="${escapeHtml(safeValue(farm.waterSource))}">
            </div>
            <div class="form-group">
              <label class="form-label">Altitude (m)</label>
              <input type="number" class="form-input" name="altitude" value="${safeValue(farm.altitude, '')}" step="0.01" placeholder="Optional">
            </div>
            <div class="form-group">
              <label class="form-label">Road Access Quality</label>
              <select class="form-select" name="roadAccessQuality">
                <option value="POOR" ${farm.roadAccessQuality === 'POOR' ? 'selected' : ''}>Poor</option>
                <option value="MODERATE" ${(!farm.roadAccessQuality || farm.roadAccessQuality === 'MODERATE') ? 'selected' : ''}>Moderate</option>
                <option value="GOOD" ${farm.roadAccessQuality === 'GOOD' ? 'selected' : ''}>Good</option>
              </select>
            </div>
            <div class="form-group form-group-full">
              <label class="form-checkbox">
                <input type="checkbox" name="electricityAvailable" ${farm.electricityAvailable ? 'checked' : ''}>
                <span>Electricity Available</span>
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeFarmModal()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              Update Farm
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;

  document.getElementById('editFarmForm').addEventListener('submit', handleEditFarmSubmit);
}






// ============================================
// FIX 2: Ajouter la fonction de validation manquante
// ============================================
function validateFarmData(farmData) {
  const errors = [];

  if (!farmData.farmName || farmData.farmName.trim() === '') {
    errors.push('Farm name is required');
  }

  if (!farmData.farmSize || farmData.farmSize <= 0) {
    errors.push('Valid farm size is required');
  }

  if (!farmData.soilType) {
    errors.push('Soil type is required');
  }

  if (!farmData.latitude || isNaN(farmData.latitude)) {
    errors.push('Valid latitude is required');
  }

  if (!farmData.longitude || isNaN(farmData.longitude)) {
    errors.push('Valid longitude is required');
  }

  return errors;
}

// ============================================
// FIX 3: CrÃ©er l'alias loadFarmData â†’ loadFarmsData
// ============================================
async function loadFarmData() {
  return await loadFarmsData();
}




// ============================================
// FIX: AmÃ©liorer handleEditFarmSubmit
// ============================================
async function handleEditFarmSubmit(e) {
  e.preventDefault();
  console.log('ðŸ“¤ Form submitted');

  const form = e.target;
  const farmId = form.dataset.farmId;
  const formData = new FormData(form);

  if (!farmId) {
    showToast('âŒ Farm ID not found', 'error');
    return;
  }

  console.log('ðŸ“¤ Updating farm ID:', farmId);

  // Helper pour parser les nombres en toute sÃ©curitÃ©
  const safeParseFloat = (value) => {
    const parsed = parseFloat(value);
    return isNaN(parsed) ? null : parsed;
  };

  // âœ… Collect form data avec validation
  const farmData = {
    farmerId: currentUser.id,
    farmName: formData.get('farmName')?.trim() || null,
    farmCode: formData.get('farmCode')?.trim() || null,
    farmSize: safeParseFloat(formData.get('farmSize')),
    soilType: formData.get('soilType') || null,
    latitude: safeParseFloat(formData.get('latitude')),
    longitude: safeParseFloat(formData.get('longitude')),
    altitude: safeParseFloat(formData.get('altitude')),
    irrigationSystem: formData.get('irrigationSystem') || 'RAIN_FED',
    topography: formData.get('topography')?.trim() || null,
    waterSource: formData.get('waterSource')?.trim() || null,
    electricityAvailable: formData.get('electricityAvailable') === 'on',
    roadAccessQuality: formData.get('roadAccessQuality') || 'MODERATE'
  };

  // Supprimer les valeurs null non requises
  Object.keys(farmData).forEach(key => {
    if (farmData[key] === null && ['altitude', 'topography', 'waterSource'].includes(key)) {
      delete farmData[key];
    }
  });

  console.log('ðŸ“‹ Farm data to update:', farmData);

  // âœ… Validate data
  const validationErrors = validateFarmData(farmData);
  if (validationErrors.length > 0) {
    console.error('âŒ Validation errors:', validationErrors);
    showToast('âŒ ' + validationErrors.join(', '), 'error');
    return;
  }

  try {
    showLoading();

    // âœ… Send PUT request
    const response = await apiRequest(`/farms/${farmId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(farmData)
    });

    console.log('âœ… Farm updated successfully:', response);
    showToast('âœ… Farm updated successfully!', 'success');

    closeFarmModal();
    await loadFarmsData();

  } catch (error) {
    console.error('âŒ Error updating farm:', error);

    let errorMessage = 'Error updating farm';
    if (error.message) {
      if (error.message.includes('500')) {
        errorMessage = 'Server error. Please try again.';
      } else if (error.message.includes('400')) {
        errorMessage = 'Invalid data. Please check all fields.';
      } else if (error.message.includes('404')) {
        errorMessage = 'Farm not found.';
      } else {
        errorMessage = error.message;
      }
    }

    showToast('âŒ ' + errorMessage, 'error');
  } finally {
    hideLoading();
  }
}








// ============================================
// HELPER: escapeHtml (if not already defined)
// ============================================
/**
 * Escape HTML to prevent XSS attacks
 */
function escapeHtml(text) {
  if (!text) return '';
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}


// ============================================
// VERIFICATION SCRIPT
// ============================================
/**
 * Run this to verify all functions are defined
 */
function verifyFarmEditFunctions() {
  const requiredFunctions = [
    'openEditFarmModal',
    'handleEditFarmSubmit',
    'validateFarmData',
    'closeFarmModal',
    'loadFarmsData',
    'escapeHtml',
    'showToast',
    'showLoading',
    'hideLoading',
    'apiRequest'
  ];

  console.log('ðŸ” Verifying required functions...');

  const missing = [];
  requiredFunctions.forEach(funcName => {
    if (typeof window[funcName] !== 'function') {
      missing.push(funcName);
      console.error(`âŒ Missing: ${funcName}`);
    } else {
      console.log(`âœ… Found: ${funcName}`);
    }
  });

  if (missing.length === 0) {
    console.log('âœ… All required functions are defined!');
    return true;
  } else {
    console.error(`âŒ Missing ${missing.length} functions:`, missing);
    return false;
  }
}

// Run verification on page load
if (typeof window !== 'undefined') {
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(verifyFarmEditFunctions, 1000);
  });
}



      /**
      * View farm details
      */
      async function viewFarmDetails(farmId) {
      try {
      showLoading();

      const farm = await apiRequest(`/farms/${farmId}`);

      // Show farm details modal
      showFarmDetailsModal(farm);

      } catch (error) {
      console.error('Error loading farm details:', error);
      showToast('Error loading farm details', 'error');
      } finally {
      hideLoading();
      }
      }

      /**
      * Show farm details modal
      */
      function showFarmDetailsModal(farm) {
      const modalHTML = `
      <div class="modal-overlay" id="farmModal">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">${farm.farmName}</h3>
            <button class="modal-close" onclick="closeFarmModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="details-grid">
              <div class="detail-item">
                <label>Farm Code</label>
                <value>${farm.farmCode}</value>
              </div>
              <div class="detail-item">
                <label>Size</label>
                <value>${farm.sizeHectares} hectares</value>
              </div>
              <div class="detail-item">
                <label>Location</label>
                <value>${farm.location}</value>
              </div>
              <div class="detail-item">
                <label>Coordinates</label>
                <value>${farm.latitude}, ${farm.longitude}</value>
              </div>
              <div class="detail-item">
                <label>Soil Type</label>
                <value>${farm.soilType}</value>
              </div>
              <div class="detail-item">
                <label>Irrigation System</label>
                <value>${formatIrrigationSystem(farm.irrigationSystem)}</value>
              </div>
              <div class="detail-item">
                <label>Topography</label>
                <value>${farm.topography || 'N/A'}</value>
              </div>
              <div class="detail-item">
                <label>Electricity</label>
                <value>${farm.electricityAvailable ? 'Available' : 'Not Available'}</value>
              </div>
              <div class="detail-item">
                <label>Created At</label>
                <value>${formatDateTime(farm.createdAt)}</value>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeFarmModal()">
              Close
            </button>
            <button class="btn btn-primary" onclick="editFarm('${farm.id}')">
              <i class="fas fa-edit"></i>
              Edit Farm
            </button>
          </div>
        </div>
      </div>
      `;

      document.getElementById('modalContainer').innerHTML = modalHTML;
      }

      // ============================================================================
      // CROPS CATALOG MODULE
      // ============================================================================

     /**
 * Load crops data - CORRECTION
 */
async function loadCropsData() {
  try {
    showLoading();

    const response = await apiRequest('/v1/crops/all');

    // CORRECTION: GÃ©rer les diffÃ©rents formats de rÃ©ponse
    let crops = [];
    if (Array.isArray(response)) {
      crops = response;
    } else if (response && response.data && Array.isArray(response.data)) {
      crops = response.data;
    } else if (response && response.content && Array.isArray(response.content)) {
      crops = response.content;
    } else {
      console.warn('âš ï¸ Unexpected crops response format:', response);
      crops = [];
    }

    displayCropsGrid(crops);

  } catch (error) {
    console.error('Error loading crops:', error);
    showToast('Error loading crops catalog', 'error');

    // Afficher un Ã©tat vide en cas d'erreur
    const container = document.getElementById('cropsGrid');
    if (container) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Unable to load crops catalog</p>
          <button class="btn btn-primary mt-4" onclick="loadCropsData()">
            <i class="fas fa-redo"></i>
            Try Again
          </button>
        </div>
      `;
    }
  } finally {
    hideLoading();
  }
}


/**
 * Display crops grid
 */
function displayCropsGrid(crops) {
  const container = document.getElementById('cropsGrid');
  if (!container) return;

  if (crops.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-seedling"></i>
        <p>No crops available</p>
      </div>
    `;
    return;
  }

  container.innerHTML = crops.map(crop => `
    <div class="crop-card">
      <div class="crop-card-header">
        <div class="crop-icon">ðŸŒ¾</div>
        <h3 class="crop-name">${crop.cropName}</h3>
        <span class="crop-category">${crop.cropType}</span>
      </div>
      <div class="crop-card-body">
        <div class="crop-info-list">
          <div class="crop-info-item">
            <span class="crop-info-label">Scientific Name</span>
            <span class="crop-info-value">${crop.scientificName || 'N/A'}</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Variety</span>
            <span class="crop-info-value">${crop.variety || 'N/A'}</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Growing Period</span>
            <span class="crop-info-value">${crop.growingPeriodDays} days</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Planting Season</span>
            <span class="crop-info-value">${crop.plantingSeason}</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Harvest Season</span>
            <span class="crop-info-value">${crop.harvestSeason}</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Market Demand</span>
            <span class="crop-info-value">${crop.marketDemandLevel}</span>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="viewCropDetails('${crop.id}')">
          <i class="fas fa-eye"></i>
          View Details
        </button>
      </div>
    </div>
  `).join('');
}






/**
      * View crop details
      */
      let isLoadingCropDetails = false;

      async function viewCropDetails(cropId) {
      if (isLoadingCropDetails) {
        console.log('â³ Already loading crop details, ignoring...');
        return;
      }

      try {
      isLoadingCropDetails = true;
      console.log('ðŸ” Loading crop details for ID:', cropId);
      showLoading();

      const response = await apiRequest(`/v1/crops/${cropId}`);

      console.log('ðŸ“¦ Crop response:', response);

      // CORRECTION: Extraire la donnÃ©e du bon format de rÃ©ponse
      let crop = null;
      if (response && response.data) {
        crop = response.data;
      } else if (response && !response.success && !response.data) {
        crop = response;
      }

      if (!crop) {
        throw new Error('Crop data not found');
      }

      console.log('âœ… Crop data extracted:', crop);

      // CRITIQUE: Attendre un peu avant de cacher le loading
      hideLoading();

      console.log('ðŸŽ¬ About to call showCropDetailsModal...');
      showCropDetailsModal(crop);
      console.log('ðŸŽ¬ showCropDetailsModal called!');

      } catch (error) {
      console.error('âŒ Error loading crop details:', error);
      showToast('Error loading crop details', 'error');
      hideLoading();
      } finally {
      isLoadingCropDetails = false;
      }
      }





/**
      * Close crop details modal
      */
      function closeCropModal() {
        console.log('ðŸšª Closing crop modal...');
        const modal = document.getElementById('cropModal');
        if (modal) {
          modal.style.opacity = '0';
          modal.classList.remove('show');
          setTimeout(() => {
            modal.remove();
            console.log('âœ… Modal closed and removed');
          }, 300);
        } else {
          console.warn('âš ï¸ Modal not found when trying to close');
        }
      }

      // âœ… Gestionnaire global pour fermer le modal en cliquant en dehors
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
          console.log('ðŸ–±ï¸ Click detected on modal overlay, closing...');
          const modalId = e.target.id;
          if (modalId === 'cropModal') {
            closeCropModal();
          } else if (modalId === 'productionModal') {
            closeProductionModal();
          }
        }
      });




/**
      * Show crop details modal - VERSION CORRIGÃ‰E AVEC DEBUG
      */
      function showCropDetailsModal(crop) {
      console.log('ðŸŽ¯ showCropDetailsModal called with crop:', crop);

      const modalContainer = document.getElementById('modalContainer');
      if (!modalContainer) {
        console.error('âŒ Modal container not found!');
        showToast('Error: Modal container not found', 'error');
        return;
      }

      console.log('âœ… Modal container found:', modalContainer);

      const modalHTML = `
      <div class="modal-overlay" id="cropModal">
        <div class="modal-container modal-large">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fas fa-leaf"></i>
              ${crop.cropName}
            </h3>
            <button class="modal-close" onclick="closeCropModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="crop-details">
              <div class="details-section">
                <h4><i class="fas fa-info-circle"></i> Basic Information</h4>
                <div class="details-grid">
                  <div class="detail-item">
                    <label>Scientific Name</label>
                    <value>${crop.scientificName || 'N/A'}</value>
                  </div>
                  <div class="detail-item">
                    <label>Crop Type</label>
                    <value>${crop.cropType}</value>
                  </div>
                  <div class="detail-item">
                    <label>Variety</label>
                    <value>${crop.variety || 'N/A'}</value>
                  </div>
                  <div class="detail-item">
                    <label>Market Demand</label>
                    <value><span class="demand-${crop.marketDemandLevel?.toLowerCase() || 'medium'}">${crop.marketDemandLevel}</span></value>
                  </div>
                </div>
              </div>

              <div class="details-section">
                <h4><i class="fas fa-seedling"></i> Growing Requirements</h4>
                <div class="details-grid">
                  <div class="detail-item">
                    <label>Growing Period</label>
                    <value>${crop.growingPeriodDays} days</value>
                  </div>
                  <div class="detail-item">
                    <label>Planting Season</label>
                    <value>${crop.plantingSeason}</value>
                  </div>
                  <div class="detail-item">
                    <label>Harvest Season</label>
                    <value>${crop.harvestSeason}</value>
                  </div>
                  <div class="detail-item">
                    <label>Temperature Range</label>
                    <value>${crop.optimalTemperatureMin}Â°C - ${crop.optimalTemperatureMax}Â°C</value>
                  </div>
                  <div class="detail-item">
                    <label>Rainfall</label>
                    <value>${crop.rainfallRequirementMm} mm</value>
                  </div>
                  <div class="detail-item">
                    <label>Water Requirement</label>
                    <value>${crop.waterRequirementMm} mm</value>
                  </div>
                </div>
              </div>

              <div class="details-section">
                <h4><i class="fas fa-mountain"></i> Soil Requirements</h4>
                <div class="details-grid">
                  <div class="detail-item">
                    <label>pH Range</label>
                    <value>${crop.soilPhMin} - ${crop.soilPhMax}</value>
                  </div>
                  <div class="detail-item">
                    <label>Soil Type</label>
                    <value>${crop.soilType || 'N/A'}</value>
                  </div>
                  <div class="detail-item">
                    <label>Soil Moisture</label>
                    <value>${crop.soilMoistureLevel || 'N/A'}</value>
                  </div>
                </div>
              </div>

              ${crop.description ? `
              <div class="details-section">
                <h4><i class="fas fa-file-alt"></i> Description</h4>
                <p>${crop.description}</p>
              </div>
              ` : ''}

              ${crop.nutritionalValue ? `
              <div class="details-section">
                <h4><i class="fas fa-apple-alt"></i> Nutritional Value</h4>
                <p>${crop.nutritionalValue}</p>
              </div>
              ` : ''}
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCropModal()">
              <i class="fas fa-times"></i>
              Close
            </button>
          </div>
        </div>
      </div>
      `;

      console.log('ðŸ“ Setting modal HTML...');
      modalContainer.innerHTML = modalHTML;

      console.log('â±ï¸ Waiting for DOM update...');

      // âœ… CRITIQUE: Attendre que le DOM soit mis Ã  jour puis afficher le modal
      setTimeout(() => {
        const modal = document.getElementById('cropModal');
        if (modal) {
          console.log('âœ… Modal found in DOM, showing...');
          modal.classList.add('show');
          modal.style.display = 'flex';
          modal.style.opacity = '1';
          console.log('ðŸŽ‰ Modal should now be visible!');
        } else {
          console.error('âŒ Modal not found in DOM after insertion!');
          showToast('Error: Modal could not be displayed', 'error');
        }
      }, 10);
      }




/**
 * Recharger les productions pour le formulaire de fertilisant
 */
async function loadProductionsForFertilizer() {
    try {
        showLoading();
        console.log('ðŸ”„ Manually reloading productions for fertilizer...');

        // RÃ©ouvrir le modal aprÃ¨s rechargement
        setTimeout(() => {
            openAddFertilizerModal();
        }, 500);

    } catch (error) {
        console.error('Error reloading productions:', error);
        showToast('Error reloading productions', 'error');
    } finally {
        hideLoading();
    }
}




/**
 * Load production data with crop names enrichment
 */
async function loadProductionData() {
    try {
        showLoading();

        // âœ… VALIDATION UTILISATEUR
        if (!currentUser || !currentUser.id) {
            console.error('âŒ No current user found');
            displayEmptyProductionState();
            return;
        }

        console.log('ðŸ”„ Loading production data for farmer user ID:', currentUser.id);

        // âœ… RÃ‰CUPÃ‰RATION DES PRODUCTIONS
        let allProductions = [];
        try {
            const productionsResponse = await apiRequest(`/v1/crop-productions/by-farmer/${currentUser.id}`);

            // âœ… GESTION MULTI-FORMAT DE LA RÃ‰PONSE
            if (productionsResponse) {
                if (Array.isArray(productionsResponse)) {
                    allProductions = productionsResponse;
                } else if (productionsResponse.data) {
                    if (Array.isArray(productionsResponse.data)) {
                        allProductions = productionsResponse.data;
                    } else if (productionsResponse.data.content && Array.isArray(productionsResponse.data.content)) {
                        allProductions = productionsResponse.data.content;
                    }
                } else if (productionsResponse.content && Array.isArray(productionsResponse.content)) {
                    allProductions = productionsResponse.content;
                }
            }

            // âœ… FILTRAGE DES PRODUCTIONS VALIDES
            allProductions = allProductions.filter(p => {
                return p && typeof p === 'object' && p.productionStatus;
            });

            console.log(`âœ… Total productions loaded: ${allProductions.length}`);

        } catch (error) {
            console.warn('âš ï¸ Productions load error:', error.message);
            allProductions = [];
        }

        // â­ NOUVEAU: ENRICHIR AVEC LES NOMS DE CULTURES
        if (allProductions.length > 0) {
            allProductions = await enrichProductionsWithCropNames(allProductions);
        }

        // âœ… CALCUL DES STATISTIQUES
        const totalCount = allProductions.length;

        // âœ… CALCUL DES PRODUCTIONS ACTIVES
        const active = allProductions.filter(p => {
            if (!p.productionStatus) return false;
            const status = String(p.productionStatus).toUpperCase();
            return ['PLANTED', 'GROWING', 'PLANNED', 'IN_PROGRESS', 'ACTIVE'].includes(status);
        }).length;

        // âœ… CALCUL DES PRODUCTIONS RÃ‰COLTÃ‰ES
        const harvested = allProductions.filter(p => {
            if (!p.productionStatus) return false;
            return String(p.productionStatus).toUpperCase() === 'HARVESTED';
        }).length;

        // âœ… CALCUL DU RENDEMENT TOTAL
        const totalYield = allProductions.reduce((sum, p) => {
            const yield = parseFloat(p.actualYield);
            return sum + (isNaN(yield) ? 0 : yield);
        }, 0);

        // âœ… MISE Ã€ JOUR DES Ã‰LÃ‰MENTS UI
        updateElement('prodTotalCount', totalCount);
        updateElement('prodActive', active);
        updateElement('prodHarvested', harvested);
        updateElement('prodTotalYield', `${totalYield.toFixed(2)} T`);

        console.log('ðŸ“Š Production Stats:', {
            total: totalCount,
            active: active,
            harvested: harvested,
            yield: totalYield.toFixed(2)
        });

        // âœ… AFFICHER LA TIMELINE
        displayProductionTimeline(allProductions);

        // âœ… AFFICHER Ã‰TAT VIDE SI NÃ‰CESSAIRE
        if (totalCount === 0) {
            displayEmptyProductionState();
        }

    } catch (error) {
        console.error('âŒ Error loading productions:', error);
        showToast('Unable to load production data', 'warning');
        displayEmptyProductionState();
    } finally {
        hideLoading();
    }
}


/**
 * â­ NOUVELLE FONCTION: Enrichir les productions avec les noms de cultures
 */
async function enrichProductionsWithCropNames(productions) {
    console.log('ðŸ”„ Enriching productions with crop names...');

    // RÃ©cupÃ©rer tous les crops une seule fois (pour optimisation)
    let cropsMap = {};
    try {
        const cropsResponse = await apiRequest('/v1/crops/all');
        let crops = [];

        if (Array.isArray(cropsResponse)) {
            crops = cropsResponse;
        } else if (cropsResponse && cropsResponse.data) {
            crops = Array.isArray(cropsResponse.data) ? cropsResponse.data : [];
        }

        // CrÃ©er une map cropId -> cropName
        crops.forEach(crop => {
            if (crop && crop.id && crop.cropName) {
                cropsMap[crop.id] = crop.cropName;
            }
        });

        console.log(`âœ… Loaded ${Object.keys(cropsMap).length} crops`);

    } catch (error) {
        console.warn('âš ï¸ Error loading crops:', error.message);
    }

    // Enrichir chaque production avec le nom de la culture
    productions.forEach(prod => {
        if (prod.cropId && cropsMap[prod.cropId]) {
            prod.cropName = cropsMap[prod.cropId];
        } else {
            prod.cropName = 'Unknown Crop';
            console.warn(`âš ï¸ Crop not found for production ${prod.id}, cropId: ${prod.cropId}`);
        }
    });

    return productions;
}











function displayEmptyProductionState() {
    // âœ… MISE Ã€ JOUR DES STATS
    updateElement('prodTotalCount', 0);
    updateElement('prodActive', 0);
    updateElement('prodHarvested', 0);
    updateElement('prodTotalYield', '0 T');

    // âœ… AFFICHAGE Ã‰TAT VIDE
    const container = document.getElementById('productionTimeline');
    if (container) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-seedling"></i>
                <p>No crop productions registered yet</p>
                <button class="btn btn-primary" onclick="openAddProductionModal()">
                    <i class="fas fa-plus"></i>
                    Start First Production
                </button>
            </div>
        `;
    }
}






/**
 * Utility function to safely handle API responses
 */
function safeApiResponse(data, defaultValue = []) {
    if (Array.isArray(data)) {
        return data;
    }
    if (data && Array.isArray(data.content)) {
        return data.content;
    }
    if (data && typeof data === 'object') {
        // Si c'est un objet unique, le mettre dans un tableau
        return [data];
    }
    return defaultValue;
}




function displayProductionTimeline(productions) {
    const container = document.getElementById('productionTimeline');
    if (!container) return;

    if (!productions || productions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-seedling"></i>
                <p>No crop productions registered yet</p>
                <button class="btn btn-primary" onclick="openAddProductionModal()">
                    <i class="fas fa-plus"></i>
                    Start First Production
                </button>
            </div>
        `;
        return;
    }

    // âœ… TRI PAR DATE DE PLANTATION (PLUS RÃ‰CENT EN PREMIER)
    const sortedProductions = [...productions].sort((a, b) => {
        const dateA = new Date(a.plantingDate || a.createdAt);
        const dateB = new Date(b.plantingDate || b.createdAt);
        return dateB - dateA;
    });

    container.innerHTML = sortedProductions.map(prod => {
        if (!prod || !prod.productionStatus) {
            return '';
        }

        const statusLower = prod.productionStatus.toLowerCase();
        const cropName = prod.cropName || 'Unknown Crop'; // â­ Maintenant disponible!
        const productionCode = prod.productionCode || 'N/A';
        const season = prod.season || 'N/A';
        const year = prod.year || '';
        const areaPlanted = prod.areaPlanted || 0;
        const expectedYield = prod.expectedYield || 'N/A';
        const actualYield = prod.actualYield || null;
        const plantingDate = prod.plantingDate ? formatDate(prod.plantingDate) : 'N/A';
        const expectedHarvestDate = prod.expectedHarvestDate ? formatDate(prod.expectedHarvestDate) : 'N/A';
        const actualHarvestDate = prod.actualHarvestDate ? formatDate(prod.actualHarvestDate) : null;

        // âœ… CALCUL DES JOURS JUSQU'Ã€ LA RÃ‰COLTE
        let daysUntilHarvest = null;
        if (prod.expectedHarvestDate && ['PLANTED', 'GROWING'].includes(prod.productionStatus)) {
            const today = new Date();
            const harvestDate = new Date(prod.expectedHarvestDate);
            daysUntilHarvest = Math.ceil((harvestDate - today) / (1000 * 60 * 60 * 24));
        }

        return `
            <div class="production-card">
                <div class="production-header">
                    <div class="production-info">
                        <h3 class="production-title">
                            <i class="fas fa-seedling"></i>
                            ${cropName}
                        </h3>
                        <span class="production-code">${productionCode}</span>
                    </div>
                    <div class="production-badges">
                        <span class="production-status status-${statusLower}">${prod.productionStatus}</span>
                        ${daysUntilHarvest !== null && daysUntilHarvest >= 0 ? `
                            <span class="production-countdown">
                                <i class="fas fa-clock"></i>
                                ${daysUntilHarvest} days to harvest
                            </span>
                        ` : ''}
                    </div>
                </div>

                <div class="production-details">
                    <div class="production-detail-item">
                        <label><i class="fas fa-calendar"></i> Season:</label>
                        <span>${season} ${year}</span>
                    </div>
                    <div class="production-detail-item">
                        <label><i class="fas fa-ruler-combined"></i> Area:</label>
                        <span>${areaPlanted} ha</span>
                    </div>
                    <div class="production-detail-item">
                        <label><i class="fas fa-chart-line"></i> Expected Yield:</label>
                        <span>${expectedYield} T/ha</span>
                    </div>
                    ${actualYield ? `
                        <div class="production-detail-item">
                            <label><i class="fas fa-warehouse"></i> Actual Yield:</label>
                            <span><strong>${actualYield} T/ha</strong></span>
                        </div>
                    ` : ''}
                </div>

                <div class="production-dates">
                    <div class="date-item">
                        <i class="fas fa-calendar-plus"></i>
                        <span><strong>Planted:</strong> ${plantingDate}</span>
                    </div>
                    <div class="date-item">
                        <i class="fas fa-calendar-check"></i>
                        <span><strong>Expected Harvest:</strong> ${expectedHarvestDate}</span>
                    </div>
                    ${actualHarvestDate ? `
                        <div class="date-item success">
                            <i class="fas fa-check-circle"></i>
                            <span><strong>Harvested:</strong> ${actualHarvestDate}</span>
                        </div>
                    ` : ''}
                </div>

                <div class="production-actions">
                    <button class="btn btn-secondary btn-sm" onclick="viewProductionDetails('${prod.id}')">
                        <i class="fas fa-eye"></i>
                        View Details
                    </button>
                    ${['PLANNED', 'PLANTED', 'GROWING'].includes(prod.productionStatus) ? `
                        <button class="btn btn-primary btn-sm" onclick="editProduction('${prod.id}')">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                    ` : ''}
                    ${prod.productionStatus === 'GROWING' ? `
                        <button class="btn btn-success btn-sm" onclick="markAsHarvested('${prod.id}')">
                            <i class="fas fa-warehouse"></i>
                            Mark Harvested
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }).filter(html => html !== '').join('');

    if (container.innerHTML.trim() === '') {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-seedling"></i>
                <p>No valid production data to display</p>
                <button class="btn btn-primary" onclick="loadProductionData()">
                    <i class="fas fa-redo"></i>
                    Reload
                </button>
            </div>
        `;
    }
}

/**
 * âœ… FIX CRITIQUE: Initialize all event listeners for farms
 */
function initializeFarmsEventListeners() {
  console.log('ðŸ”„ Initializing farms event listeners...');

  // Ã‰couteur pour le bouton "Add Farm"
  const addFarmBtn = document.getElementById('addFarmBtn');
  if (addFarmBtn) {
    addFarmBtn.addEventListener('click', openAddFarmModal);
    console.log('âœ… Add Farm button listener attached');
  } else {
    console.warn('âš ï¸ Add Farm button not found');
  }

  // Ã‰couteurs pour les boutons Edit dans le tableau des farms
  document.addEventListener('click', function(e) {
    // GÃ©rer les boutons Edit Farm
    if (e.target.closest('.btn-edit-farm')) {
      e.preventDefault();
      const farmId = e.target.closest('.btn-edit-farm').dataset.farmId;
      console.log('âœï¸ Edit farm clicked:', farmId);
      if (farmId) {
        editFarm(farmId);
      }
    }

    // GÃ©rer les boutons View Details
    if (e.target.closest('.btn-view-farm')) {
      e.preventDefault();
      const farmId = e.target.closest('.btn-view-farm').dataset.farmId;
      console.log('ðŸ‘ï¸ View farm clicked:', farmId);
      if (farmId) {
        viewFarmDetails(farmId);
      }
    }

    // GÃ©rer les boutons Delete
    if (e.target.closest('.btn-delete-farm')) {
      e.preventDefault();
      const farmId = e.target.closest('.btn-delete-farm').dataset.farmId;
      console.log('ðŸ—‘ï¸ Delete farm clicked:', farmId);
      if (farmId) {
        deleteFarm(farmId);
      }
    }
  });

  console.log('âœ… All farms event listeners initialized');
}



async function openAddProductionModal() {
  try {
    showLoading();

    if (!currentUser || !currentUser.id) {
      showToast('âŒ User session not found. Please login again.', 'error');
      hideLoading();
      return;
    }

    console.log('ðŸ‘¤ Current user (Farmer ID):', currentUser.id);

    // Fetch crops
    const cropsResponse = await apiRequest('/v1/crops/all');
    let crops = [];
    if (cropsResponse && cropsResponse.data) {
      crops = Array.isArray(cropsResponse.data) ? cropsResponse.data : [];
    }

    if (crops.length === 0) {
      showToast('âš ï¸ No crops available. Please contact administrator.', 'warning');
      hideLoading();
      return;
    }

    const modalHTML = `
      <div class="modal-overlay" id="productionModal">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fas fa-seedling"></i>
              Start New Production
            </h3>
            <button class="modal-close" onclick="closeProductionModal()" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <form id="addProductionForm">
              <div class="form-grid">

                <!-- Info Farmer -->
                <div class="form-group form-group-full">
                  <div class="alert alert-info">
                    <i class="fas fa-user-tie"></i>
                    <strong>Farmer:</strong> ${currentUser.fullName || currentUser.username}
                    <br><small>Your production will be tracked under your farmer account</small>
                  </div>
                </div>

                <!-- Crop Selection -->
                <div class="form-group">
                  <label class="form-label required">
                    <i class="fas fa-leaf"></i>
                    Select Crop *
                  </label>
                  <select class="form-select" name="cropId" required>
                    <option value="">Choose a crop...</option>
                    ${crops.map(crop => `
                      <option value="${crop.id}" data-growing-days="${crop.growingPeriodDays || 90}">
                        ${crop.cropName} (${crop.growingPeriodDays || 90} days)
                      </option>
                    `).join('')}
                  </select>
                </div>

                <!-- Production Code -->
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-barcode"></i>
                    Production Code
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="productionCode"
                    placeholder="Auto-generated if empty"
                    maxlength="30"
                  >
                </div>

                <!-- Season -->
                <div class="form-group">
                  <label class="form-label required">
                    <i class="fas fa-calendar"></i>
                    Season *
                  </label>
                  <select class="form-select" name="season" required>
                    <option value="">Select Season...</option>
                    <option value="SEASON_A">ðŸŒ± Season A (Sep-Jan)</option>
                    <option value="SEASON_B">ðŸŒ¾ Season B (Feb-Jun)</option>
                    <option value="SEASON_C">ðŸŒ¿ Season C (Jul-Aug)</option>
                  </select>
                </div>

                <!-- Year -->
                <div class="form-group">
                  <label class="form-label required">
                    <i class="fas fa-calendar-alt"></i>
                    Year *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="year"
                    value="${new Date().getFullYear()}"
                    min="2020"
                    max="2030"
                    required
                  >
                </div>

                <!-- Area Planted -->
                <div class="form-group">
                  <label class="form-label required">
                    <i class="fas fa-ruler-combined"></i>
                    Area Planted (hectares) *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="areaPlanted"
                    step="0.01"
                    min="0.01"
                    placeholder="e.g., 2.5"
                    required
                  >
                </div>

                <!-- Expected Yield -->
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-chart-line"></i>
                    Expected Yield (T/ha)
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="expectedYield"
                    step="0.01"
                    min="0"
                    placeholder="e.g., 3.5"
                  >
                </div>

                <!-- Planting Date -->
                <div class="form-group">
                  <label class="form-label required">
                    <i class="fas fa-calendar-plus"></i>
                    Planting Date *
                  </label>
                  <input
                    type="date"
                    class="form-input"
                    name="plantingDate"
                    max="${new Date().toISOString().split('T')[0]}"
                    value="${new Date().toISOString().split('T')[0]}"
                    required
                  >
                </div>

                <!-- Expected Harvest Date -->
                <div class="form-group">
                  <label class="form-label required">
                    <i class="fas fa-calendar-check"></i>
                    Expected Harvest Date *
                  </label>
                  <input
                    type="date"
                    class="form-input"
                    name="expectedHarvestDate"
                    required
                  >
                </div>

                <!-- Seed Variety -->
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-seedling"></i>
                    Seed Variety
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="seedVariety"
                    placeholder="e.g., Hybrid A123"
                    maxlength="100"
                  >
                </div>

                <!-- Production Method -->
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-cogs"></i>
                    Production Method
                  </label>
                  <select class="form-select" name="productionMethod">
                    <option value="CONVENTIONAL">ðŸšœ Conventional</option>
                    <option value="ORGANIC">ðŸŒ± Organic</option>
                    <option value="INTEGRATED">ðŸ”„ Integrated</option>
                  </select>
                </div>

              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProductionModal()">
                  <i class="fas fa-times"></i>
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  Start Production
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;

    setTimeout(() => {
      const modal = document.getElementById('productionModal');
      if (modal) {
        modal.classList.add('show');
        modal.style.display = 'flex';
      }
    }, 10);

    const form = document.getElementById('addProductionForm');
    if (form) {
      form.addEventListener('submit', handleAddProduction);
    }

    // Auto-calculate harvest date
    const plantingDateInput = form.querySelector('input[name="plantingDate"]');
    const cropSelect = form.querySelector('select[name="cropId"]');
    const harvestDateInput = form.querySelector('input[name="expectedHarvestDate"]');

    function updateExpectedHarvestDate() {
      if (plantingDateInput.value && cropSelect.value) {
        const selectedOption = cropSelect.options[cropSelect.selectedIndex];
        const growingDays = parseInt(selectedOption.dataset.growingDays) || 90;

        const plantingDate = new Date(plantingDateInput.value);
        const harvestDate = new Date(plantingDate);
        harvestDate.setDate(harvestDate.getDate() + growingDays);

        harvestDateInput.value = harvestDate.toISOString().split('T')[0];
      }
    }

    plantingDateInput.addEventListener('change', updateExpectedHarvestDate);
    cropSelect.addEventListener('change', updateExpectedHarvestDate);
    updateExpectedHarvestDate();

    console.log('âœ… Production modal opened');

  } catch (error) {
    console.error('âŒ Error opening modal:', error);
    showToast('Error loading form data: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}







async function handleAddProduction(e) {
  e.preventDefault();
  const formData = new FormData(e.target);

  // âœ… farmId = currentUser.id (USER ID du farmer)
  const productionData = {
    farmId: currentUser.id,  // âœ… USER ID (pas un Farm ID)
    cropId: formData.get('cropId'),
    productionCode: formData.get('productionCode')?.trim() || null,
    season: formData.get('season'),
    year: parseInt(formData.get('year')),
    areaPlanted: parseFloat(formData.get('areaPlanted')),
    expectedYield: formData.get('expectedYield') ? parseFloat(formData.get('expectedYield')) : null,
    plantingDate: formData.get('plantingDate'),
    expectedHarvestDate: formData.get('expectedHarvestDate'),
    seedVariety: formData.get('seedVariety')?.trim() || null,
    productionMethod: formData.get('productionMethod') || 'CONVENTIONAL',
    productionStatus: 'PLANNED'
  };

  console.log('ðŸ“‹ Production data to send:', productionData);
  console.log('âœ… Using Farmer USER ID as farmId:', productionData.farmId);

  // Validation
  if (!productionData.cropId) {
    showToast('âŒ Please select a crop', 'error');
    return;
  }

  if (!productionData.season) {
    showToast('âŒ Please select a season', 'error');
    return;
  }

  if (!productionData.plantingDate || !productionData.expectedHarvestDate) {
    showToast('âŒ Please provide both planting and harvest dates', 'error');
    return;
  }

  if (productionData.areaPlanted <= 0) {
    showToast('âŒ Area planted must be greater than 0', 'error');
    return;
  }

  // Validate date order
  const plantingDate = new Date(productionData.plantingDate);
  const harvestDate = new Date(productionData.expectedHarvestDate);

  if (harvestDate <= plantingDate) {
    showToast('âŒ Harvest date must be after planting date', 'error');
    return;
  }

  try {
    showLoading();

    console.log('ðŸ“¤ Sending production data to API...');

    const response = await apiRequest('/v1/crop-productions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(productionData)
    });

    console.log('âœ… Production created successfully:', response);
    showToast('âœ… Production started successfully!', 'success');

    closeProductionModal();

    // Reload data
    setTimeout(async () => {
      await loadProductionData();
      await loadDashboardData();
    }, 500);

  } catch (error) {
    console.error('âŒ Error adding production:', error);

    let errorMessage = 'Error starting production';
    if (error.message.includes('500')) {
      errorMessage = 'Server error. Please check all fields and try again.';
    } else if (error.message.includes('400')) {
      errorMessage = 'Invalid data. Please check all required fields.';
    } else {
      errorMessage = error.message || errorMessage;
    }

    showToast(`âŒ ${errorMessage}`, 'error');
  } finally {
    hideLoading();
  }
}







/**
 * Close production modal
 */
function closeProductionModal() {
  const modal = document.getElementById('productionModal');
  if (modal) {
    modal.style.opacity = '0';
    setTimeout(() => {
      modal.remove();
    }, 300);
  }
}






      /**
      * View production details
      */
      async function viewProductionDetails(productionId) {
      try {
      showLoading();

      const production = await apiRequest(`/crop-productions/${productionId}`);

      showProductionDetailsModal(production);

      } catch (error) {
      console.error('Error loading production details:', error);
      showToast('Error loading production details', 'error');
      } finally {
      hideLoading();
      }
      }

      /**
      * Show production details modal
      */
      function showProductionDetailsModal(production) {
      const modalHTML = `
      <div class="modal-overlay" id="productionModal">
        <div class="modal-container modal-large">
          <div class="modal-header">
            <h3 class="modal-title">Production Details</h3>
            <button class="modal-close" onclick="closeProductionModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="details-grid">
              <div class="detail-item">
                <label>Production Code</label>
                <value>${production.productionCode}</value>
              </div>
              <div class="detail-item">
                <label>Crop</label>
                <value>${production.cropName || 'N/A'}</value>
              </div>
              <div class="detail-item">
                <label>Season</label>
                <value>${production.season} ${production.year}</value>
              </div>
              <div class="detail-item">
                <label>Status</label>
                <value><span class="status-badge status-${production.productionStatus.toLowerCase()}">${production.productionStatus}</span></value>
              </div>
              <div class="detail-item">
                <label>Area Planted</label>
                <value>${production.areaPlanted} ha</value>
              </div>
              <div class="detail-item">
                <label>Expected Yield</label>
                <value>${production.expectedYield || 'N/A'} T/ha</value>
              </div>
              ${production.actualYield ? `
              <div class="detail-item">
                <label>Actual Yield</label>
                <value>${production.actualYield} T/ha</value>
              </div>
              <div class="detail-item">
                <label>Total Production</label>
                <value>${production.totalProduction || 'N/A'} T</value>
              </div>
              ` : ''}
              <div class="detail-item">
                <label>Planting Date</label>
                <value>${formatDate(production.plantingDate)}</value>
              </div>
              <div class="detail-item">
                <label>Expected Harvest Date</label>
                <value>${formatDate(production.expectedHarvestDate)}</value>
              </div>
              ${production.actualHarvestDate ? `
              <div class="detail-item">
                <label>Actual Harvest Date</label>
                <value>${formatDate(production.actualHarvestDate)}</value>
              </div>
              ` : ''}
              ${production.productionMethod ? `
              <div class="detail-item">
                <label>Production Method</label>
                <value>${production.productionMethod}</value>
              </div>
              ` : ''}
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeProductionModal()">
              Close
            </button>
            <button class="btn btn-primary" onclick="editProduction('${production.id}')">
              <i class="fas fa-edit"></i>
              Edit
            </button>
          </div>
        </div>
      </div>
      `;

      document.getElementById('modalContainer').innerHTML = modalHTML;
      }

      /**
      * Edit production
      */
      function editProduction(productionId) {
      // Implementation similar to editFarm
      showToast('Edit production feature - To be implemented', 'info');
      }

      /**
      * Mark as harvested
      */
      function markAsHarvested(productionId) {
      // Implementation to update production status and add harvest details
      showToast('Mark as harvested feature - To be implemented', 'info');
      }










/**
 * Load inventory data - VERSION CORRIGÃ‰E avec enrichissement des crops
 */
async function loadInventoryData() {
    const container = document.getElementById('inventoryGrid');
    if (!container) {
        console.error('âŒ Inventory grid container not found');
        return;
    }

    try {
        showLoading();
        console.log('ðŸ”„ Loading inventory data for farmer:', currentUser.id);

        // Afficher loader dans le container
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading inventory...</p>
            </div>
        `;

        // â­ Ã‰TAPE 1: Charger tous les crops UNE SEULE FOIS
        let cropsMap = {};
        try {
            const cropsResponse = await apiRequest('/v1/crops/all');
            let crops = [];

            if (Array.isArray(cropsResponse)) {
                crops = cropsResponse;
            } else if (cropsResponse && cropsResponse.data && Array.isArray(cropsResponse.data)) {
                crops = cropsResponse.data;
            }

            // CrÃ©er une map cropId -> cropName
            crops.forEach(crop => {
                if (crop && crop.id && crop.cropName) {
                    cropsMap[crop.id] = crop.cropName;
                }
            });

            console.log(`âœ… Loaded ${Object.keys(cropsMap).length} crops for inventory`);

        } catch (error) {
            console.warn('âš ï¸ Error loading crops:', error.message);
        }

        // â­ Ã‰TAPE 2: Charger l'inventaire
        let inventory = [];

        try {
            const response = await apiRequest(`/v1/inventories/farmer/${currentUser.id}`);
            console.log('ðŸ“¦ Raw API Response:', response);

            // âœ… GESTION MULTI-FORMAT DE LA RÃ‰PONSE
            if (Array.isArray(response)) {
                inventory = response;
            } else if (response && response.data && Array.isArray(response.data)) {
                inventory = response.data;
            } else if (response && response.content && Array.isArray(response.content)) {
                inventory = response.content;
            } else if (response && Array.isArray(response.inventories)) {
                inventory = response.inventories;
            } else if (response && typeof response === 'object') {
                inventory = [response];
            } else {
                console.warn('âš ï¸ Unexpected inventory response format:', response);
                inventory = [];
            }

            // Filtrer les items nulls ou invalides
            inventory = inventory.filter(item => item && item.id);

            console.log(`âœ… Loaded ${inventory.length} inventory items`);

        } catch (error) {
            console.warn('âš ï¸ Inventory load warning:', error.message);
            inventory = [];
        }

        // â­ Ã‰TAPE 3: Enrichir chaque item avec le nom de la culture
        inventory.forEach(item => {
            if (item.cropId && cropsMap[item.cropId]) {
                item.cropName = cropsMap[item.cropId];
            } else {
                item.cropName = 'Unknown Crop';
                console.warn(`âš ï¸ Crop not found for inventory ${item.id}, cropId: ${item.cropId}`);
            }
        });

        // Mise Ã  jour des statistiques
        updateInventoryStats(inventory);

        // Affichage des donnÃ©es
        displayInventoryGrid(inventory);
        displayInventoryAlerts(inventory);

    } catch (error) {
        console.error('âŒ Inventory load error:', error);
        showToast('Unable to load inventory data', 'warning');

        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Unable to load inventory</p>
                <button class="btn btn-primary mt-4" onclick="loadInventoryData()">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;
    } finally {
        hideLoading();
    }
}

/**
 * Update inventory statistics - VERSION SÃ‰CURISÃ‰E
 */
function updateInventoryStats(inventory) {
    if (!Array.isArray(inventory)) {
        console.warn('âš ï¸ Invalid inventory array');
        inventory = [];
    }

    const totalItems = inventory.length;

    const totalQuantity = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.currentQuantity) || 0), 0
    );

    const totalValue = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.totalMarketValue) || 0), 0
    );

    const alertsCount = calculateAlertsCount(inventory);

    // Mise Ã  jour des Ã©lÃ©ments UI avec vÃ©rification
    updateElement('invTotalItems', totalItems);
    updateElement('invTotalQuantity', `${totalQuantity.toFixed(2)} KG`);
    updateElement('invTotalValue', formatCurrency(totalValue));
    updateElement('invAlerts', alertsCount);

    console.log('ðŸ“Š Inventory Stats:', {
        items: totalItems,
        quantity: totalQuantity.toFixed(2),
        value: totalValue.toFixed(2),
        alerts: alertsCount
    });
}

/**
 * Calculate alerts count - VERSION SÃ‰CURISÃ‰E
 */
function calculateAlertsCount(inventory) {
    if (!Array.isArray(inventory) || inventory.length === 0) {
        return 0;
    }

    const today = new Date();
    let alertsCount = 0;

    inventory.forEach(item => {
        try {
            // Alerte pour les articles expirÃ©s ou expirant bientÃ´t
            if (item.expiryDate) {
                const expiry = new Date(item.expiryDate);
                if (!isNaN(expiry.getTime())) {
                    const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil <= 30) {
                        alertsCount++;
                    }
                }
            }

            // Alerte pour stock faible
            const available = parseFloat(item.availableQuantity) || 0;
            const current = parseFloat(item.currentQuantity) || 0;
            if (current > 0 && available < current * 0.2) {
                alertsCount++;
            }

        } catch (error) {
            console.error('Error calculating alert for item:', item.id, error);
        }
    });

    return alertsCount;
}





/**
 * Display inventory grid - VERSION AMÃ‰LIORÃ‰E
 */
function displayInventoryGrid(inventory) {
    const container = document.getElementById('inventoryGrid');
    if (!container) return;

    if (!inventory || inventory.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-box"></i>
                <p>No inventory items yet</p>
                <button class="btn btn-primary" onclick="openAddInventoryModal()">
                    <i class="fas fa-plus"></i>
                    Add First Item
                </button>
            </div>
        `;
        return;
    }

    const inventoryHTML = inventory.map(item => {
        const cropName = item.cropName || 'Unknown Crop';
        const currentQty = parseFloat(item.currentQuantity) || 0;
        const availableQty = parseFloat(item.availableQuantity) || 0;
        const unit = item.unit || 'KG';
        const qualityGrade = item.qualityGrade || 'N/A';
        const status = item.status || 'AVAILABLE';
        const totalValue = parseFloat(item.totalMarketValue) || 0;
        const expiryDate = item.expiryDate ? formatDate(item.expiryDate) : 'N/A';

        return `
            <div class="inventory-card">
                <div class="inventory-header">
                    <h3 class="inventory-title">${cropName}</h3>
                    <span class="inventory-status status-${status.toLowerCase()}">${status}</span>
                </div>
                <div class="inventory-details">
                    <div class="inventory-detail-item">
                        <label>Code:</label>
                        <span>${item.inventoryCode || 'N/A'}</span>
                    </div>
                    <div class="inventory-detail-item">
                        <label>Quantity:</label>
                        <span>${currentQty.toFixed(2)} ${unit}</span>
                    </div>
                    <div class="inventory-detail-item">
                        <label>Available:</label>
                        <span>${availableQty.toFixed(2)} ${unit}</span>
                    </div>
                    <div class="inventory-detail-item">
                        <label>Quality:</label>
                        <span class="quality-badge quality-${qualityGrade.toLowerCase()}">${qualityGrade}</span>
                    </div>
                    <div class="inventory-detail-item">
                        <label>Value:</label>
                        <span>${formatCurrency(totalValue)}</span>
                    </div>
                    ${expiryDate !== 'N/A' ? `
                    <div class="inventory-detail-item">
                        <label>Expires:</label>
                        <span>${expiryDate}</span>
                    </div>
                    ` : ''}
                </div>
                <div class="inventory-actions">
                    <button class="btn btn-secondary btn-sm" onclick="viewInventoryDetails('${item.id}')">
                        <i class="fas fa-eye"></i>
                        View
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="editInventory('${item.id}')">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteInventory('${item.id}', '${cropName}')">
                        <i class="fas fa-trash"></i>
                        Delete
                    </button>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = inventoryHTML;
}






/**
 * Display inventory alerts - VERSION CORRIGÃ‰E
 */
function displayInventoryAlerts(inventory) {
    const container = document.getElementById('inventoryAlerts');
    if (!container) return;

    const today = new Date();
    const alerts = [];

    inventory.forEach(item => {
        if (!item || !item.expiryDate) return;

        try {
            const expiry = new Date(item.expiryDate);
            if (isNaN(expiry.getTime())) {
                console.warn('Invalid expiry date for item:', item.id);
                return;
            }

            const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));

            if (daysUntil <= 0) {
                alerts.push({
                    level: 'critical',
                    icon: 'fa-exclamation-triangle',
                    message: `${item.cropName || 'Unknown item'} has expired`,
                    item: item
                });
            } else if (daysUntil <= 7) {
                alerts.push({
                    level: 'high',
                    icon: 'fa-exclamation-circle',
                    message: `${item.cropName || 'Unknown item'} expires in ${daysUntil} days`,
                    item: item
                });
            } else if (daysUntil <= 30) {
                alerts.push({
                    level: 'medium',
                    icon: 'fa-clock',
                    message: `${item.cropName || 'Unknown item'} expires in ${daysUntil} days`,
                    item: item
                });
            }
        } catch (error) {
            console.error('Error processing expiry date for item:', item.id, error);
        }

        // Low stock alerts
        try {
            const available = parseFloat(item.availableQuantity) || 0;
            const current = parseFloat(item.currentQuantity) || 0;

            if (current > 0 && available < current * 0.2) {
                alerts.push({
                    level: 'medium',
                    icon: 'fa-box',
                    message: `Low stock: ${item.cropName || 'Unknown item'} (${available} ${item.unit || 'units'} remaining)`,
                    item: item
                });
            }
        } catch (error) {
            console.error('Error processing stock levels for item:', item.id, error);
        }
    });

    if (alerts.length === 0) {
        container.innerHTML = '';
        return;
    }

    container.innerHTML = `
        <div class="alerts-banner">
            <h4><i class="fas fa-bell"></i> Inventory Alerts</h4>
            <div class="alerts-list">
                ${alerts.map(alert => `
                    <div class="alert-item alert-${alert.level}">
                        <i class="fas ${alert.icon}"></i>
                        <span>${alert.message}</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}



/**
 * ============================================
 * INVENTORY MODAL FUNCTIONS
 * ============================================
 */

/**
 * Open Add Inventory Modal
 */
async function openAddInventoryModal() {
    try {
        showLoading();

        // Fetch crops for dropdown
        const cropsResponse = await apiRequest('/v1/crops/all');
        const crops = Array.isArray(cropsResponse) ? cropsResponse :
                     (cropsResponse && Array.isArray(cropsResponse.data)) ? cropsResponse.data : [];

        if (crops.length === 0) {
            showToast('âš ï¸ No crops available. Please add crops first.', 'warning');
            hideLoading();
            return;
        }

        const modalHTML = `
            <div class="modal-overlay show" id="inventoryModal" onclick="if(event.target === this) closeInventoryModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-plus-circle"></i>
                            Add New Inventory Item
                        </h3>
                        <button class="modal-close" onclick="closeInventoryModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addInventoryForm">
                            <div class="form-grid">

                                <!-- Crop Selection -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-leaf"></i>
                                        Select Crop *
                                    </label>
                                    <select class="form-select" name="cropId" required>
                                        <option value="">Choose a crop...</option>
                                        ${crops.map(crop => `
                                            <option value="${crop.id}">${crop.cropName}</option>
                                        `).join('')}
                                    </select>
                                </div>

                                <!-- Facility Type -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-warehouse"></i>
                                        Facility Type *
                                    </label>
                                    <select class="form-select" name="facilityType" required>
                                        <option value="">Select facility...</option>
                                        <option value="FARM_STORAGE">Farm Storage</option>
                                        <option value="WAREHOUSE">Warehouse</option>
                                        <option value="SILO">Silo</option>
                                        <option value="COLD_STORAGE">Cold Storage</option>
                                    </select>
                                </div>

                                <!-- Storage Location -->
                                <div class="form-group form-group-full">
                                    <label class="form-label required">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Storage Location *
                                    </label>
                                    <input type="text" class="form-input" name="storageLocation"
                                           placeholder="e.g., Warehouse A, Section 3" required>
                                </div>

                                <!-- Current Quantity -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-balance-scale"></i>
                                        Current Quantity (KG) *
                                    </label>
                                    <input type="number" class="form-input" name="currentQuantity"
                                           step="0.01" min="0.01" placeholder="e.g., 1000" required>
                                </div>

                                <!-- Quality Grade -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-star"></i>
                                        Quality Grade *
                                    </label>
                                    <select class="form-select" name="qualityGrade" required>
                                        <option value="">Select quality...</option>
                                        <option value="PREMIUM">Premium</option>
                                        <option value="GRADE_A">Grade A</option>
                                        <option value="GRADE_B">Grade B</option>
                                        <option value="STANDARD">Standard</option>
                                    </select>
                                </div>

                                <!-- Market Value Per Unit -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-money-bill-wave"></i>
                                        Market Value per KG (RWF)
                                    </label>
                                    <input type="number" class="form-input" name="marketValuePerUnit"
                                           step="0.01" min="0" placeholder="e.g., 500">
                                </div>

                                <!-- Storage Date -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-calendar"></i>
                                        Storage Date *
                                    </label>
                                    <input type="date" class="form-input" name="storageDate"
                                           value="${new Date().toISOString().split('T')[0]}" required>
                                </div>

                                <!-- Expected Shelf Life -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-clock"></i>
                                        Expected Shelf Life (days)
                                    </label>
                                    <input type="number" class="form-input" name="expectedShelfLifeDays"
                                           min="1" placeholder="e.g., 90">
                                </div>

                                <!-- Certifications -->
                                <div class="form-group form-group-full">
                                    <label class="form-checkbox">
                                        <input type="checkbox" name="organicCertified">
                                        <span>Organic Certified</span>
                                    </label>
                                    <label class="form-checkbox">
                                        <input type="checkbox" name="fairTradeCertified">
                                        <span>Fair Trade Certified</span>
                                    </label>
                                </div>

                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeInventoryModal()">
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Save Inventory
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

        // Add form submit handler
        const form = document.getElementById('addInventoryForm');
        if (form) {
            form.addEventListener('submit', handleAddInventory);
        }

    } catch (error) {
        console.error('âŒ Error opening add inventory modal:', error);
        showToast('Error opening form', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Handle Add Inventory Form Submit
 */
async function handleAddInventory(e) {
    e.preventDefault();

    const formData = new FormData(e.target);

    const inventoryData = {
        cropId: formData.get('cropId'),
        farmerId: currentUser.id,
        facilityType: formData.get('facilityType'),
        storageLocation: formData.get('storageLocation').trim(),
        currentQuantity: parseFloat(formData.get('currentQuantity')),
        qualityGrade: formData.get('qualityGrade'),
        marketValuePerUnit: formData.get('marketValuePerUnit') ? parseFloat(formData.get('marketValuePerUnit')) : null,
        storageDate: formData.get('storageDate'),
        expectedShelfLifeDays: formData.get('expectedShelfLifeDays') ? parseInt(formData.get('expectedShelfLifeDays')) : null,
        organicCertified: formData.get('organicCertified') === 'on',
        fairTradeCertified: formData.get('fairTradeCertified') === 'on'
    };

    // Validation
    if (!inventoryData.cropId) {
        showToast('âŒ Please select a crop', 'error');
        return;
    }
    if (!inventoryData.facilityType) {
        showToast('âŒ Please select facility type', 'error');
        return;
    }
    if (!inventoryData.currentQuantity || inventoryData.currentQuantity <= 0) {
        showToast('âŒ Quantity must be greater than 0', 'error');
        return;
    }

    try {
        showLoading();

        console.log('ðŸ“¤ Submitting inventory data:', inventoryData);

        const response = await apiRequest('/v1/inventories', {
            method: 'POST',
            body: JSON.stringify(inventoryData)
        });

        console.log('âœ… Inventory created:', response);
        showToast('âœ… Inventory item added successfully!', 'success');

        closeInventoryModal();

        // Reload data
        setTimeout(async () => {
            await loadInventoryData();
        }, 500);

    } catch (error) {
        console.error('âŒ Error adding inventory:', error);
        showToast(`âŒ Error: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * View Inventory Details
 */
async function viewInventoryDetails(inventoryId) {
    try {
        showLoading();

        const inventory = await apiRequest(`/v1/inventories/${inventoryId}`);

        const modalHTML = `
            <div class="modal-overlay show" id="inventoryDetailsModal" onclick="if(event.target === this) closeInventoryDetailsModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-info-circle"></i>
                            Inventory Details
                        </h3>
                        <button class="modal-close" onclick="closeInventoryDetailsModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Inventory Code</label>
                                <value>${inventory.inventoryCode || 'N/A'}</value>
                            </div>
                            <div class="detail-item">
                                <label>Crop</label>
                                <value>${inventory.cropName || 'Unknown'}</value>
                            </div>
                            <div class="detail-item">
                                <label>Facility Type</label>
                                <value>${inventory.facilityType || 'N/A'}</value>
                            </div>
                            <div class="detail-item">
                                <label>Storage Location</label>
                                <value>${inventory.storageLocation || 'N/A'}</value>
                            </div>
                            <div class="detail-item">
                                <label>Current Quantity</label>
                                <value>${parseFloat(inventory.currentQuantity || 0).toFixed(2)} ${inventory.unit || 'KG'}</value>
                            </div>
                            <div class="detail-item">
                                <label>Available Quantity</label>
                                <value>${parseFloat(inventory.availableQuantity || 0).toFixed(2)} ${inventory.unit || 'KG'}</value>
                            </div>
                            <div class="detail-item">
                                <label>Quality Grade</label>
                                <value>${inventory.qualityGrade || 'N/A'}</value>
                            </div>
                            <div class="detail-item">
                                <label>Status</label>
                                <value><span class="status-badge status-${(inventory.status || 'AVAILABLE').toLowerCase()}">${inventory.status || 'AVAILABLE'}</span></value>
                            </div>
                            <div class="detail-item">
                                <label>Total Market Value</label>
                                <value>${formatCurrency(inventory.totalMarketValue || 0)}</value>
                            </div>
                            <div class="detail-item">
                                <label>Storage Date</label>
                                <value>${formatDate(inventory.storageDate)}</value>
                            </div>
                            ${inventory.expiryDate ? `
                            <div class="detail-item">
                                <label>Expiry Date</label>
                                <value>${formatDate(inventory.expiryDate)}</value>
                            </div>
                            ` : ''}
                            <div class="detail-item">
                                <label>Organic Certified</label>
                                <value>${inventory.organicCertified ? 'âœ… Yes' : 'âŒ No'}</value>
                            </div>
                            <div class="detail-item">
                                <label>Fair Trade Certified</label>
                                <value>${inventory.fairTradeCertified ? 'âœ… Yes' : 'âŒ No'}</value>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeInventoryDetailsModal()">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                        <button type="button" class="btn btn-primary" onclick="editInventory('${inventory.id}')">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

    } catch (error) {
        console.error('âŒ Error loading inventory details:', error);
        showToast('Error loading details', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Edit Inventory
 */
async function editInventory(inventoryId) {
    try {
        showLoading();

        const inventory = await apiRequest(`/v1/inventories/${inventoryId}`);

        const modalHTML = `
            <div class="modal-overlay show" id="inventoryModal" onclick="if(event.target === this) closeInventoryModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-edit"></i>
                            Edit Inventory
                        </h3>
                        <button class="modal-close" onclick="closeInventoryModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editInventoryForm" data-inventory-id="${inventory.id}">
                            <div class="form-grid">

                                <div class="form-group">
                                    <label class="form-label">Current Quantity (KG)</label>
                                    <input type="number" class="form-input" name="currentQuantity"
                                           value="${inventory.currentQuantity}" step="0.01" min="0.01" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Quality Grade</label>
                                    <select class="form-select" name="qualityGrade" required>
                                        <option value="PREMIUM" ${inventory.qualityGrade === 'PREMIUM' ? 'selected' : ''}>Premium</option>
                                        <option value="GRADE_A" ${inventory.qualityGrade === 'GRADE_A' ? 'selected' : ''}>Grade A</option>
                                        <option value="GRADE_B" ${inventory.qualityGrade === 'GRADE_B' ? 'selected' : ''}>Grade B</option>
                                        <option value="STANDARD" ${inventory.qualityGrade === 'STANDARD' ? 'selected' : ''}>Standard</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Market Value per KG (RWF)</label>
                                    <input type="number" class="form-input" name="marketValuePerUnit"
                                           value="${inventory.marketValuePerUnit || ''}" step="0.01" min="0">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Storage Location</label>
                                    <input type="text" class="form-input" name="storageLocation"
                                           value="${inventory.storageLocation}" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" name="status" required>
                                        <option value="AVAILABLE" ${inventory.status === 'AVAILABLE' ? 'selected' : ''}>Available</option>
                                        <option value="RESERVED" ${inventory.status === 'RESERVED' ? 'selected' : ''}>Reserved</option>
                                        <option value="SOLD" ${inventory.status === 'SOLD' ? 'selected' : ''}>Sold</option>
                                        <option value="EXPIRED" ${inventory.status === 'EXPIRED' ? 'selected' : ''}>Expired</option>
                                    </select>
                                </div>

                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeInventoryModal()">
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Update Inventory
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

        const form = document.getElementById('editInventoryForm');
        if (form) {
            form.addEventListener('submit', handleEditInventory);
        }

    } catch (error) {
        console.error('âŒ Error loading inventory for editing:', error);
        showToast('Error loading inventory', 'error');
    } finally {
        hideLoading();
    }
}




/**
 * Handle Edit Inventory Submit
 */
async function handleEditInventory(e) {
    e.preventDefault();

    const inventoryId = e.target.dataset.inventoryId;
    const formData = new FormData(e.target);

    const updateData = {
        currentQuantity: parseFloat(formData.get('currentQuantity')),
        qualityGrade: formData.get('qualityGrade'),
        marketValuePerUnit: formData.get('marketValuePerUnit') ? parseFloat(formData.get('marketValuePerUnit')) : null,
        storageLocation: formData.get('storageLocation').trim(),
        status: formData.get('status')
    };

    try {
        showLoading();

        console.log('ðŸ“¤ Updating inventory:', updateData);

        const response = await apiRequest(`/v1/inventories/${inventoryId}`, {
            method: 'PUT',
            body: JSON.stringify(updateData)
        });

        console.log('âœ… Inventory updated:', response);
        showToast('âœ… Inventory updated successfully!', 'success');

        closeInventoryModal();

        // Reload data
        setTimeout(async () => {
            await loadInventoryData();
        }, 500);

    } catch (error) {
        console.error('âŒ Error updating inventory:', error);
        showToast(`âŒ Error: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Delete Inventory
 */
async function deleteInventory(inventoryId, cropName) {
    if (!confirm(`Are you sure you want to delete "${cropName}" inventory?\n\nThis action cannot be undone.`)) {
        return;
    }

    try {
        showLoading();

        await apiRequest(`/v1/inventories/${inventoryId}`, {
            method: 'DELETE'
        });

        showToast('âœ… Inventory deleted successfully!', 'success');

        // Reload data
        await loadInventoryData();

    } catch (error) {
        console.error('âŒ Error deleting inventory:', error);
        showToast(`âŒ Error: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Close Inventory Modal
 */
function closeInventoryModal() {
    const modal = document.getElementById('inventoryModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}

/**
 * Close Inventory Details Modal
 */
function closeInventoryDetailsModal() {
    const modal = document.getElementById('inventoryDetailsModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}








/**
 * ============================================
 * INVENTORY EVENT LISTENERS
 * ============================================
 */

/**
 * Initialize Inventory Event Listeners
 */
function initializeInventoryEventListeners() {
    console.log('ðŸš€ Initializing Inventory Event Listeners...');

    // Add Stock Button
    const addStockBtn = document.querySelector('[data-action="add-inventory"]');
    if (addStockBtn) {
        addStockBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('ðŸ–±ï¸ Add inventory button clicked');
            openAddInventoryModal();
        });
    }

    // Refresh Button
    const refreshBtn = document.querySelector('[data-action="refresh-inventory"]');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('ðŸ”„ Refresh inventory button clicked');
            loadInventoryData();
        });
    }

    // Export Button
    const exportBtn = document.querySelector('[data-action="export-inventory"]');
    if (exportBtn) {
        exportBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('ðŸ“¥ Export inventory button clicked');
            exportInventoryToCSV();
        });
    }

    // Filter Buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const filterType = this.dataset.filter;
            const filterValue = this.dataset.value;
            filterInventory(filterType, filterValue);
        });
    });

    // Clear Filters Button
    const clearFiltersBtn = document.querySelector('[data-action="clear-inventory-filters"]');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', (e) => {
            e.preventDefault();
            clearInventoryFilters();
        });
    }

    console.log('âœ… Inventory event listeners initialized');
}

/**
 * Filter Inventory Items
 */
function filterInventory(filterType, filterValue) {
    console.log(`ðŸ” Filtering inventory by ${filterType}: ${filterValue}`);

    const cards = document.querySelectorAll('.inventory-card');

    cards.forEach(card => {
        const status = card.querySelector('.inventory-status')?.textContent.trim().toUpperCase();
        const quality = card.querySelector('.quality-badge')?.textContent.trim().toUpperCase();

        let shouldShow = true;

        if (filterType === 'status' && filterValue !== 'all') {
            shouldShow = status === filterValue.toUpperCase();
        }

        if (filterType === 'quality' && filterValue !== 'all') {
            shouldShow = quality === filterValue.toUpperCase();
        }

        if (shouldShow) {
            card.style.display = '';
            card.style.animation = 'fadeIn 0.3s ease';
        } else {
            card.style.display = 'none';
        }
    });

    // Update active filter button
    document.querySelectorAll(`.filter-btn[data-filter="${filterType}"]`).forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === filterValue);
    });
}

/**
 * Clear Inventory Filters
 */
function clearInventoryFilters() {
    console.log('ðŸ§¹ Clearing inventory filters...');

    // Show all cards
    document.querySelectorAll('.inventory-card').forEach(card => {
        card.style.display = '';
    });

    // Remove active class from filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Set "All" buttons as active
    document.querySelectorAll('.filter-btn[data-value="all"]').forEach(btn => {
        btn.classList.add('active');
    });

    showToast('Filters cleared', 'info');
}

/**
 * Export Inventory to CSV
 */
async function exportInventoryToCSV() {
    try {
        showLoading();

        const response = await apiRequest(`/v1/inventories/farmer/${currentUser.id}`);
        let inventory = [];

        if (Array.isArray(response)) {
            inventory = response;
        } else if (response && response.data && Array.isArray(response.data)) {
            inventory = response.data;
        } else if (response && response.content && Array.isArray(response.content)) {
            inventory = response.content;
        }

        if (inventory.length === 0) {
            showToast('âš ï¸ No inventory data to export', 'warning');
            hideLoading();
            return;
        }

        // CSV Headers
        const headers = [
            'Inventory Code', 'Crop', 'Facility Type', 'Storage Location',
            'Current Quantity', 'Available Quantity', 'Unit', 'Quality Grade',
            'Status', 'Market Value', 'Storage Date', 'Expiry Date',
            'Organic', 'Fair Trade', 'Created Date'
        ];

        // CSV Rows
        const rows = inventory.map(item => [
            item.inventoryCode || '',
            item.cropName || 'Unknown',
            item.facilityType || '',
            item.storageLocation || '',
            item.currentQuantity || 0,
            item.availableQuantity || 0,
            item.unit || 'KG',
            item.qualityGrade || '',
            item.status || '',
            item.totalMarketValue || 0,
            item.storageDate || '',
            item.expiryDate || '',
            item.organicCertified ? 'Yes' : 'No',
            item.fairTradeCertified ? 'Yes' : 'No',
            item.createdDate || ''
        ]);

        // Create CSV content
        let csvContent = headers.join(',') + '\n';
        rows.forEach(row => {
            csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
        });

        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `inventory_export_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        window.URL.revokeObjectURL(url);

        showToast('âœ… Inventory exported successfully!', 'success');

    } catch (error) {
        console.error('âŒ Error exporting inventory:', error);
        showToast('âŒ Error exporting inventory', 'error');
    } finally {
        hideLoading();
    }
}













async function loadFertilizerData() {
    try {
        showLoading();

        if (!currentUser || !currentUser.id) {
            console.warn('âš ï¸ No current user found');
            displayEmptyFertilizerData();
            return;
        }

        const farmerId = currentUser.id;
        console.log('ðŸ”„ Loading fertilizer data for farmer:', farmerId);

        // TEST: Appeler l'endpoint de test d'abord
        const testResponse = await apiRequest(`/fertilizer-usages/test/farmer/${farmerId}`);
        console.log('ðŸ§ª TEST RESPONSE:', testResponse);

        // Utiliser la vraie rÃ©ponse
        let fertilizers = testResponse.allFertilizers || [];

        console.log(`ðŸ“Š Total fertilizers found: ${fertilizers.length}`);

        if (fertilizers.length === 0) {
            displayEmptyFertilizerData();
            return;
        }

        // Enrichir les donnÃ©es avec les informations de crop production
        const enrichedFertilizers = await Promise.all(fertilizers.map(async (fert) => {
            try {
                if (fert.cropProductionId && !fert.cropProductionName) {
                    try {
                        const cropProdResponse = await apiRequest(`/v1/crop-productions/${fert.cropProductionId}`);
                        const cropProd = cropProdResponse.data || cropProdResponse;
                        
                        // RÃ©cupÃ©rer le nom du crop
                        if (cropProd.cropId) {
                            try {
                                const cropResponse = await apiRequest(`/v1/crops/${cropProd.cropId}`);
                                const crop = cropResponse.data || cropResponse;
                                fert.cropProductionName = crop.cropName || crop.name || cropProd.productionCode || 'Unknown Crop';
                            } catch (error) {
                                console.warn(`Error fetching crop ${cropProd.cropId}:`, error);
                                fert.cropProductionName = cropProd.productionCode || 'Unknown Production';
                            }
                        } else {
                            fert.cropProductionName = cropProd.productionCode || 'Unknown Production';
                        }
                    } catch (error) {
                        console.warn(`Error fetching crop production ${fert.cropProductionId}:`, error);
                        fert.cropProductionName = 'Unknown Production';
                    }
                }
            } catch (error) {
                console.warn('Error enriching fertilizer:', error);
            }
            return fert;
        }));

        const stats = calculateFertilizerStatistics(enrichedFertilizers);
        updateFertilizerStatistics(stats);
        displayFertilizerTable(enrichedFertilizers);
        createFertilizerCharts(enrichedFertilizers);

    } catch (error) {
        console.error('âŒ Error:', error);
        displayEmptyFertilizerData();
    } finally {
        hideLoading();
    }
}

// ============================================================
// STATISTICS CALCULATION
// ============================================================

function calculateFertilizerStatistics(fertilizers) {
    console.log('ðŸ”¢ Calculating statistics for', fertilizers.length, 'fertilizers');

    const totalApplications = fertilizers.length;

    const totalQuantity = fertilizers.reduce((sum, f) => {
        const qty = parseFloat(f.quantity) || 0;
        return sum + qty;
    }, 0);

    const totalCost = fertilizers.reduce((sum, f) => {
        const cost = parseFloat(f.totalCost) || 0;
        return sum + cost;
    }, 0);

    const ratedFertilizers = fertilizers.filter(f =>
        f.effectivenessRating && f.effectivenessRating > 0);

    const avgEffectiveness = ratedFertilizers.length > 0
        ? ratedFertilizers.reduce((sum, f) =>
            sum + (parseFloat(f.effectivenessRating) || 0), 0) / ratedFertilizers.length
        : 0;

    // Groupement par type
    const byType = {};
    fertilizers.forEach(f => {
        const type = f.fertilizerType || 'UNKNOWN';
        if (!byType[type]) {
            byType[type] = { count: 0, quantity: 0, cost: 0 };
        }
        byType[type].count++;
        byType[type].quantity += parseFloat(f.quantity) || 0;
        byType[type].cost += parseFloat(f.totalCost) || 0;
    });

    // Fertilizers expirant bientÃ´t
    const now = new Date();
    const threeMonthsLater = new Date();
    threeMonthsLater.setMonth(now.getMonth() + 3);

    const expiringSoon = fertilizers.filter(f => {
        if (!f.expiryDate) return false;
        const expiryDate = new Date(f.expiryDate);
        return expiryDate > now && expiryDate <= threeMonthsLater;
    }).length;

    const expired = fertilizers.filter(f => {
        if (!f.expiryDate) return false;
        return new Date(f.expiryDate) < now;
    }).length;

    return {
        totalApplications,
        totalQuantity,
        totalCost,
        avgEffectiveness,
        byType,
        expiringSoon,
        expired,
        ratedCount: ratedFertilizers.length
    };
}

// ============================================================
// UI UPDATE FUNCTIONS
// ============================================================

function updateFertilizerStatistics(stats) {
    console.log('ðŸ“Š Updating UI with stats:', stats);

    updateElement('fertTotalApplications', stats.totalApplications);
    updateElement('fertTotalQuantity', `${stats.totalQuantity.toFixed(2)} KG`);
    updateElement('fertTotalCost', formatCurrency(stats.totalCost));
    updateElement('fertAvgEffectiveness',
        stats.avgEffectiveness > 0 ? `${stats.avgEffectiveness.toFixed(1)}/5` : 'N/A');

    // Statistiques additionnelles si Ã©lÃ©ments disponibles
    if (document.getElementById('fertExpiringSoon')) {
        updateElement('fertExpiringSoon', stats.expiringSoon);
    }
    if (document.getElementById('fertExpired')) {
        updateElement('fertExpired', stats.expired);
    }
    if (document.getElementById('fertRatedCount')) {
        updateElement('fertRatedCount', stats.ratedCount);
    }
}







// ============================================================
// STATISTICS CALCULATION
// ============================================================

function calculateFertilizerStatistics(fertilizers) {
    console.log('ðŸ”¢ Calculating statistics for', fertilizers.length, 'fertilizers');

    const totalApplications = fertilizers.length;

    const totalQuantity = fertilizers.reduce((sum, f) => {
        const qty = parseFloat(f.quantity) || 0;
        return sum + qty;
    }, 0);

    const totalCost = fertilizers.reduce((sum, f) => {
        const cost = parseFloat(f.totalCost) || 0;
        return sum + cost;
    }, 0);

    const ratedFertilizers = fertilizers.filter(f =>
        f.effectivenessRating && f.effectivenessRating > 0);

    const avgEffectiveness = ratedFertilizers.length > 0
        ? ratedFertilizers.reduce((sum, f) =>
            sum + (parseFloat(f.effectivenessRating) || 0), 0) / ratedFertilizers.length
        : 0;

    // Groupement par type
    const byType = {};
    fertilizers.forEach(f => {
        const type = f.fertilizerType || 'UNKNOWN';
        if (!byType[type]) {
            byType[type] = { count: 0, quantity: 0, cost: 0 };
        }
        byType[type].count++;
        byType[type].quantity += parseFloat(f.quantity) || 0;
        byType[type].cost += parseFloat(f.totalCost) || 0;
    });

    // Fertilizers expirant bientÃ´t
    const now = new Date();
    const threeMonthsLater = new Date();
    threeMonthsLater.setMonth(now.getMonth() + 3);

    const expiringSoon = fertilizers.filter(f => {
        if (!f.expiryDate) return false;
        const expiryDate = new Date(f.expiryDate);
        return expiryDate > now && expiryDate <= threeMonthsLater;
    }).length;

    const expired = fertilizers.filter(f => {
        if (!f.expiryDate) return false;
        return new Date(f.expiryDate) < now;
    }).length;

    return {
        totalApplications,
        totalQuantity,
        totalCost,
        avgEffectiveness,
        byType,
        expiringSoon,
        expired,
        ratedCount: ratedFertilizers.length
    };
}

// ============================================================
// UI UPDATE FUNCTIONS
// ============================================================

function updateFertilizerStatistics(stats) {
    console.log('ðŸ“Š Updating UI with stats:', stats);

    updateElement('fertTotalApplications', stats.totalApplications);
    updateElement('fertTotalQuantity', `${stats.totalQuantity.toFixed(2)} KG`);
    updateElement('fertTotalCost', formatCurrency(stats.totalCost));
    updateElement('fertAvgEffectiveness',
        stats.avgEffectiveness > 0 ? `${stats.avgEffectiveness.toFixed(1)}/5` : 'N/A');

    // Statistiques additionnelles si Ã©lÃ©ments disponibles
    if (document.getElementById('fertExpiringSoon')) {
        updateElement('fertExpiringSoon', stats.expiringSoon);
    }
    if (document.getElementById('fertExpired')) {
        updateElement('fertExpired', stats.expired);
    }
    if (document.getElementById('fertRatedCount')) {
        updateElement('fertRatedCount', stats.ratedCount);
    }
}

function displayFertilizerTable(fertilizers) {
    console.log('ðŸ“Š Displaying fertilizers in table:', fertilizers.length);

    const tableBody = document.getElementById('fertilizerTableBody');
    if (!tableBody) {
        console.error('âŒ Fertilizer table body element not found');
        return;
    }

    if (fertilizers.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4" style="padding: 3rem 2rem;">
                    <div class="text-muted">
                        <i class="fas fa-seedling" style="font-size: 4rem; color: #ddd; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p style="font-size: 1.1rem; color: #666; margin-bottom: 0.5rem;">No fertilizer applications recorded yet</p>
                        <p style="font-size: 0.9rem; color: #999; margin-bottom: 1.5rem;">Start tracking your fertilizer usage to optimize your crop production</p>
                        <button class="btn btn-primary btn-sm" onclick="showAddFertilizerModal()" style="padding: 0.75rem 1.5rem; border-radius: 8px;">
                            <i class="fas fa-plus"></i> Add First Application
                        </button>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    // Afficher tous les fertilizers avec toutes les colonnes correctement alignÃ©es
    const rows = fertilizers.map((fert, index) => {
        console.log(`Row ${index}:`, fert);
        
        // Format crop production name
        const cropProductionName = fert.cropProductionName || 
                                   fert.cropProduction?.cropName || 
                                   fert.cropProduction?.productionCode || 
                                   fert.cropProductionId || 
                                   'N/A';
        
        // Format date
        const applicationDate = formatDate(fert.applicationDate);
        const expiryDate = fert.expiryDate ? formatDate(fert.expiryDate) : null;
        
        // Format quantity with unit
        const quantity = formatQuantity(fert.quantity, fert.unit);
        
        // Format cost
        const totalCost = formatCurrency(fert.totalCost || 0);
        const costPerUnit = fert.costPerUnit ? formatCurrency(fert.costPerUnit) : null;
        const unit = fert.unit || 'KG';
        
        // Format effectiveness
        const effectiveness = formatEffectiveness(fert.effectivenessRating);
        
        return `
        <tr data-id="${fert.id || index}" style="transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#f8f9fa';" onmouseout="this.style.backgroundColor='transparent';">
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 600; color: #333; margin-bottom: 0.25rem;">
                    <i class="fas fa-calendar-alt" style="color: var(--primary-green); margin-right: 0.5rem;"></i>
                    ${applicationDate}
                </div>
                ${expiryDate ? `<small style="color: #999; font-size: 0.85rem;">Exp: ${expiryDate}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 600; color: #333;">
                    <i class="fas fa-seedling" style="color: var(--primary-green); margin-right: 0.5rem;"></i>
                    ${escapeHtml(cropProductionName)}
                </div>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <span class="badge" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">
                    ${getFertilizerTypeLabel(fert.fertilizerType)}
                </span>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 600; color: #333; margin-bottom: 0.25rem;">
                    ${escapeHtml(fert.fertilizerName || 'N/A')}
                </div>
                ${fert.brand ? `<small style="color: #666; font-size: 0.85rem;">Brand: ${escapeHtml(fert.brand)}</small>` : ''}
                ${fert.composition ? `<br><small style="color: #3b82f6; font-size: 0.85rem;">${escapeHtml(fert.composition)}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 700; color: #333; font-size: 1rem;">
                    ${quantity}
                </div>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <span class="badge" style="background: linear-gradient(135deg, #64748b, #475569); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">
                    ${getApplicationMethodLabel(fert.applicationMethod)}
                </span>
                ${fert.applicationStage ? `<br><small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">${escapeHtml(fert.applicationStage)}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 700; color: var(--primary-green); font-size: 1rem; margin-bottom: 0.25rem;">
                    ${totalCost}
                </div>
                ${costPerUnit ? `<small style="color: #666; font-size: 0.85rem;">${costPerUnit}/${unit}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                ${effectiveness}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="btn-icon" onclick="viewFertilizerDetails('${fert.id}')" title="View Details" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#3b82f6'; this.style.color='white';" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'; this.style.color='#3b82f6';">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-icon" onclick="editFertilizer('${fert.id}')" title="Edit" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f59e0b'; this.style.color='white';" onmouseout="this.style.background='rgba(245, 158, 11, 0.1)'; this.style.color='#f59e0b';">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon" onclick="deleteFertilizer('${fert.id}')" title="Delete" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ef4444'; this.style.color='white';" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.color='#ef4444';">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
    }).join('');

    tableBody.innerHTML = rows;
    console.log('âœ… Table populated with', fertilizers.length, 'rows');
}

function displayEmptyFertilizerData() {
    console.log('ðŸ“Š Displaying empty fertilizer state');

    // RÃ©initialiser les statistiques
    updateElement('fertTotalApplications', 0);
    updateElement('fertTotalQuantity', '0.00 KG');
    updateElement('fertTotalCost', formatCurrency(0));
    updateElement('fertAvgEffectiveness', 'N/A');

    // Afficher message vide dans le tableau
    const tableBody = document.getElementById('fertilizerTableBody');
    if (tableBody) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-5">
                    <div class="text-muted">
                        <i class="fas fa-seedling fa-4x mb-3 opacity-50"></i>
                        <h5>No Fertilizer Data Available</h5>
                        <p>Start tracking your fertilizer applications to optimize your crop production</p>
                        <button class="btn btn-primary mt-3" onclick="showAddFertilizerModal()">
                            <i class="fas fa-plus"></i> Add Fertilizer Application
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }

    // RÃ©initialiser les graphiques de maniÃ¨re sÃ»re
    safeDestroyChart('fertilizerCostChart');
    safeDestroyChart('fertilizerTypeChart');
    safeDestroyChart('fertilizerEffectivenessChart');
}

// ============================================================
// CHART CREATION
// ============================================================

function createFertilizerCharts(fertilizers) {
    console.log('ðŸ“ˆ Creating fertilizer charts');
    try {
        createFertilizerCostChart(fertilizers);
        createFertilizerTypeChart(fertilizers);
        createFertilizerEffectivenessChart(fertilizers);
    } catch (error) {
        console.error('âŒ Error creating charts:', error);
    }
}

function createFertilizerCostChart(fertilizers) {
    const ctx = document.getElementById('fertilizerCostChart');
    if (!ctx) {
        console.warn('âš ï¸ fertilizerCostChart canvas not found');
        return;
    }

    safeDestroyChart('fertilizerCostChart');

    // Grouper par mois
    const monthlyData = {};
    fertilizers.forEach(f => {
        if (!f.applicationDate) return;

        try {
            const date = new Date(f.applicationDate);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

            if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = { cost: 0, count: 0, quantity: 0 };
            }
            monthlyData[monthKey].cost += parseFloat(f.totalCost) || 0;
            monthlyData[monthKey].count++;
            monthlyData[monthKey].quantity += parseFloat(f.quantity) || 0;
        } catch (e) {
            console.warn('Invalid date:', f.applicationDate);
        }
    });

    const sortedMonths = Object.keys(monthlyData).sort();
    const labels = sortedMonths.map(m => {
        const [year, month] = m.split('-');
        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    });
    const costs = sortedMonths.map(m => monthlyData[m].cost);

    window.fertilizerCostChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Monthly Fertilizer Cost',
                data: costs,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true },
                tooltip: {
                    callbacks: {
                        label: (context) => `Cost: ${formatCurrency(context.parsed.y)}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: (value) => formatCurrency(value)
                    }
                }
            }
        }
    });

    console.log('âœ… Cost chart created');
}

function createFertilizerTypeChart(fertilizers) {
    const ctx = document.getElementById('fertilizerTypeChart');
    if (!ctx) {
        console.warn('âš ï¸ fertilizerTypeChart canvas not found');
        return;
    }

    safeDestroyChart('fertilizerTypeChart');

    // Grouper par type
    const typeData = {};
    fertilizers.forEach(f => {
        const type = f.fertilizerType || 'UNKNOWN';
        if (!typeData[type]) {
            typeData[type] = { count: 0, cost: 0 };
        }
        typeData[type].count++;
        typeData[type].cost += parseFloat(f.totalCost) || 0;
    });

    const labels = Object.keys(typeData).map(getFertilizerTypeLabel);
    const data = Object.keys(typeData).map(k => typeData[k].count);

    window.fertilizerTypeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#28a745', '#17a2b8', '#ffc107',
                    '#dc3545', '#6f42c1', '#fd7e14'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const type = Object.keys(typeData)[context.dataIndex];
                            return `${context.label}: ${context.parsed} applications (${formatCurrency(typeData[type].cost)})`;
                        }
                    }
                }
            }
        }
    });

    console.log('âœ… Type chart created');
}

function createFertilizerEffectivenessChart(fertilizers) {
    const ctx = document.getElementById('fertilizerEffectivenessChart');
    if (!ctx) {
        console.warn('âš ï¸ fertilizerEffectivenessChart canvas not found');
        return;
    }

    safeDestroyChart('fertilizerEffectivenessChart');

    // Grouper par note d'efficacitÃ©
    const ratingData = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    fertilizers.forEach(f => {
        if (f.effectivenessRating && f.effectivenessRating >= 1 && f.effectivenessRating <= 5) {
            ratingData[f.effectivenessRating]++;
        }
    });

    window.fertilizerEffectivenessChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
            datasets: [{
                label: 'Number of Applications',
                data: Object.values(ratingData),
                backgroundColor: [
                    '#dc3545', '#fd7e14', '#ffc107', '#28a745', '#20c997'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });

    console.log('âœ… Effectiveness chart created');
}

// ============================================================
// HELPER FUNCTIONS
// ============================================================

function getFertilizerTypeLabel(type) {
    const labels = {
        'ORGANIC': 'Organic',
        'NPK': 'NPK',
        'NITROGEN': 'Nitrogen',
        'PHOSPHATE': 'Phosphate',
        'POTASH': 'Potash',
        'MICRONUTRIENTS': 'Micronutrients'
    };
    return labels[type] || type || 'Unknown';
}

function getApplicationMethodLabel(method) {
    const labels = {
        'BROADCAST': 'Broadcast',
        'BAND': 'Band',
        'FOLIAR': 'Foliar',
        'FERTIGATION': 'Fertigation',
        'SPOT': 'Spot'
    };
    return labels[method] || method || 'N/A';
}

function formatQuantity(quantity, unit) {
    if (!quantity) return 'N/A';
    const unitLabels = {
        'KG': 'kg',
        'TONNES': 't',
        'LITERS': 'L',
        'BAGS': 'bags'
    };
    return `${parseFloat(quantity).toFixed(2)} ${unitLabels[unit] || unit || ''}`;
}

function formatEffectiveness(rating) {
    if (!rating) return '<span class="text-muted">Not rated</span>';

    const stars = 'â˜…'.repeat(rating) + 'â˜†'.repeat(5 - rating);
    const colors = ['', 'text-danger', 'text-warning', 'text-info', 'text-success', 'text-success'];

    return `<span class="${colors[rating]}" title="Rating: ${rating}/5">${stars}</span>`;
}

// ============================================================
// SAFE CHART DESTRUCTION
// ============================================================

function safeDestroyChart(chartName) {
    try {
        if (window[chartName] && typeof window[chartName].destroy === 'function') {
            window[chartName].destroy();
            window[chartName] = null;
            console.log(`âœ… Chart destroyed: ${chartName}`);
        }
    } catch (error) {
        console.warn(`âš ï¸ Error destroying chart ${chartName}:`, error);
        window[chartName] = null;
    }
}

function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    } else {
        console.warn(`âš ï¸ Element not found: ${id}`);
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================
// MODAL FUNCTIONS
// ============================================================

function showAddFertilizerModal() {
    console.log('Opening add fertilizer modal...');
    // Si vous avez un modal Bootstrap
    const modal = document.getElementById('addFertilizerModal');
    if (modal) {
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    } else {
        showToast('Add fertilizer modal not implemented yet', 'info');
    }
}

function viewFertilizerDetails(id) {
    console.log('Viewing fertilizer details:', id);
    // ImplÃ©menter selon votre structure
    showToast('View details feature - To be implemented', 'info');
}

function editFertilizer(id) {
    console.log('Editing fertilizer:', id);
    showToast('Edit feature - To be implemented', 'info');
}

async function deleteFertilizer(id) {
    if (!confirm('Are you sure you want to delete this fertilizer application?')) {
        return;
    }

    try {
        showLoading();
        await apiRequest(`/fertilizer-usages/${id}`, 'DELETE');
        showToast('Fertilizer application deleted successfully', 'success');
        await loadFertilizerData(); // Recharger les donnÃ©es
    } catch (error) {
        console.error('Error deleting fertilizer:', error);
        showToast('Failed to delete fertilizer application', 'error');
    } finally {
        hideLoading();
    }
}

// ============================================================
// UTILITY FUNCTIONS
// ============================================================

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    } catch (e) {
        return dateString;
    }
}

function formatCurrency(amount) {
    if (amount === null || amount === undefined) return 'RWF 0.00';
    try {
        return new Intl.NumberFormat('en-RW', {
            style: 'currency',
            currency: 'RWF',
            minimumFractionDigits: 0
        }).format(amount);
    } catch (e) {
        return `RWF ${parseFloat(amount).toFixed(2)}`;
    }
}

function showToast(message, type = 'info') {
    console.log(`Toast [${type}]:`, message);
    // ImplÃ©menter selon votre systÃ¨me de notifications
    if (typeof displayToast === 'function') {
        displayToast(message, type);
    }
}

function showLoading() {
    const loader = document.getElementById('pageLoader');
    if (loader) loader.style.display = 'flex';
}

function hideLoading() {
    const loader = document.getElementById('pageLoader');
    if (loader) loader.style.display = 'none';
}

// ============================================================
// INITIALIZATION
// ============================================================

console.log('âœ… Fertilizer management script loaded');

// Auto-load si sur la page fertilizer
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('fertilizerTableBody')) {
            console.log('ðŸš€ Auto-loading fertilizer data...');
            setTimeout(() => loadFertilizerData(), 500);
        }
    });
} else {
    if (document.getElementById('fertilizerTableBody')) {
        console.log('ðŸš€ Loading fertilizer data immediately...');
        setTimeout(() => loadFertilizerData(), 500);
    }
}


/**
 * Debug function to test fertilizer data loading
 */
async function debugFertilizerData() {
    console.log('=== DEBUG FERTILIZER DATA ===');
    console.log('Current User:', currentUser);

    if (!currentUser) {
        console.error('âŒ No current user');
        return;
    }

    // Test direct API call
    try {
        const response = await fetch(`http://localhost:1010/api/fertilizer-usages/farmer/${currentUser.id}`);
        const data = await response.json();
        console.log('ðŸ“¡ Direct API Response:', data);

        // Test all fertilizer records
        const allFertilizers = await apiRequest('/fertilizer-usages');
        console.log('ðŸ“¦ All Fertilizers:', allFertilizers);

    } catch (error) {
        console.error('âŒ Debug API Error:', error);
    }
}

// Appelez cette fonction dans la console du navigateur pour dÃ©boguer
window.debugFertilizerData = debugFertilizerData;





function displayFertilizerTable(fertilizers) {
    console.log('ðŸ“Š Displaying fertilizers in table:', fertilizers.length);

    const tableBody = document.getElementById('fertilizerTableBody');
    if (!tableBody) {
        console.error('âŒ Fertilizer table body element not found');
        return;
    }

    if (fertilizers.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4" style="padding: 3rem 2rem;">
                    <div class="text-muted">
                        <i class="fas fa-seedling" style="font-size: 4rem; color: #ddd; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p style="font-size: 1.1rem; color: #666; margin-bottom: 0.5rem;">No fertilizer applications recorded yet</p>
                        <p style="font-size: 0.9rem; color: #999; margin-bottom: 1.5rem;">Start tracking your fertilizer usage to optimize your crop production</p>
                        <button class="btn btn-primary btn-sm" onclick="showAddFertilizerModal()" style="padding: 0.75rem 1.5rem; border-radius: 8px;">
                            <i class="fas fa-plus"></i> Add First Application
                        </button>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    // Afficher tous les fertilizers avec toutes les colonnes correctement alignÃ©es
    const rows = fertilizers.map((fert, index) => {
        console.log(`Row ${index}:`, fert);
        
        // Format crop production name
        const cropProductionName = fert.cropProductionName || 
                                   fert.cropProduction?.cropName || 
                                   fert.cropProduction?.productionCode || 
                                   fert.cropProductionId || 
                                   'N/A';
        
        // Format date
        const applicationDate = formatDate(fert.applicationDate);
        const expiryDate = fert.expiryDate ? formatDate(fert.expiryDate) : null;
        
        // Format quantity with unit
        const quantity = formatQuantity(fert.quantity, fert.unit);
        
        // Format cost
        const totalCost = formatCurrency(fert.totalCost || 0);
        const costPerUnit = fert.costPerUnit ? formatCurrency(fert.costPerUnit) : null;
        const unit = fert.unit || 'KG';
        
        // Format effectiveness
        const effectiveness = formatEffectiveness(fert.effectivenessRating);
        
        return `
        <tr data-id="${fert.id || index}" style="transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#f8f9fa';" onmouseout="this.style.backgroundColor='transparent';">
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 600; color: #333; margin-bottom: 0.25rem;">
                    <i class="fas fa-calendar-alt" style="color: var(--primary-green); margin-right: 0.5rem;"></i>
                    ${applicationDate}
                </div>
                ${expiryDate ? `<small style="color: #999; font-size: 0.85rem;">Exp: ${expiryDate}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 600; color: #333;">
                    <i class="fas fa-seedling" style="color: var(--primary-green); margin-right: 0.5rem;"></i>
                    ${escapeHtml(cropProductionName)}
                </div>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <span class="badge" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">
                    ${getFertilizerTypeLabel(fert.fertilizerType)}
                </span>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 600; color: #333; margin-bottom: 0.25rem;">
                    ${escapeHtml(fert.fertilizerName || 'N/A')}
                </div>
                ${fert.brand ? `<small style="color: #666; font-size: 0.85rem;">Brand: ${escapeHtml(fert.brand)}</small>` : ''}
                ${fert.composition ? `<br><small style="color: #3b82f6; font-size: 0.85rem;">${escapeHtml(fert.composition)}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 700; color: #333; font-size: 1rem;">
                    ${quantity}
                </div>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <span class="badge" style="background: linear-gradient(135deg, #64748b, #475569); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">
                    ${getApplicationMethodLabel(fert.applicationMethod)}
                </span>
                ${fert.applicationStage ? `<br><small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">${escapeHtml(fert.applicationStage)}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 700; color: var(--primary-green); font-size: 1rem; margin-bottom: 0.25rem;">
                    ${totalCost}
                </div>
                ${costPerUnit ? `<small style="color: #666; font-size: 0.85rem;">${costPerUnit}/${unit}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                ${effectiveness}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="btn-icon" onclick="viewFertilizerDetails('${fert.id}')" title="View Details" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#3b82f6'; this.style.color='white';" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'; this.style.color='#3b82f6';">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-icon" onclick="editFertilizer('${fert.id}')" title="Edit" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f59e0b'; this.style.color='white';" onmouseout="this.style.background='rgba(245, 158, 11, 0.1)'; this.style.color='#f59e0b';">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon" onclick="deleteFertilizer('${fert.id}')" title="Delete" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ef4444'; this.style.color='white';" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.color='#ef4444';">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
    }).join('');

    tableBody.innerHTML = rows;
    console.log('âœ… Table populated with', fertilizers.length, 'rows');
}













/**
 * Open Add Fertilizer Modal - FIXED VERSION WITH CORRECT PRODUCTION LOADING
 */
async function openAddFertilizerModal() {
    try {
        showLoading();

        console.log('ðŸ”“ Opening fertilizer modal...');

        // âœ… VÃ©rifier l'utilisateur
        if (!currentUser || !currentUser.id) {
            showToast('âŒ No user logged in', 'error');
            hideLoading();
            return;
        }

        console.log('ðŸ‘¤ Current user (Farmer ID):', currentUser.id);



// âœ… CORRECTION PRINCIPALE: RÃ©cupÃ©rer TOUTES les productions du farmer
let allProductions = [];

try {
    console.log('ðŸ”„ Fetching productions for farmer:', currentUser.id);

    // Essayer plusieurs endpoints possibles
    let prodResponse;

    // Essayer d'abord l'endpoint principal
    try {
        prodResponse = await apiRequest(`/v1/crop-productions/farmer/${currentUser.id}`);
        console.log('ðŸ“¦ Main productions endpoint response:', prodResponse);
    } catch (error1) {
        console.log('âš ï¸ Main endpoint failed, trying alternative...');
        // Essayer l'endpoint alternatif
        try {
            prodResponse = await apiRequest(`/v1/crop-productions/by-farmer/${currentUser.id}`);
            console.log('ðŸ“¦ Alternative productions endpoint response:', prodResponse);
        } catch (error2) {
            console.log('âš ï¸ Alternative endpoint failed, trying farm-based approach...');
            // DerniÃ¨re tentative: rÃ©cupÃ©rer via les fermes
            const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
            const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

            if (farms.length > 0) {
                const productionPromises = farms.map(farm =>
                    apiRequest(`/v1/crop-productions/farm/${farm.id}`).catch(() => [])
                );
                const productionArrays = await Promise.all(productionPromises);
                prodResponse = productionArrays.flat();
                console.log('ðŸ“¦ Farm-based productions response:', prodResponse);
            } else {
                prodResponse = [];
            }
        }
    }

    console.log('ðŸŒ¾ Raw Productions Response:', prodResponse);

    // Extraire les productions selon le format de rÃ©ponse
    if (prodResponse) {
        if (Array.isArray(prodResponse)) {
            allProductions = prodResponse;
        } else if (prodResponse.data && Array.isArray(prodResponse.data)) {
            allProductions = prodResponse.data;
        } else if (prodResponse.content && Array.isArray(prodResponse.content)) {
            allProductions = prodResponse.content;
        } else if (prodResponse.success && Array.isArray(prodResponse.data)) {
            allProductions = prodResponse.data;
        } else {
            console.warn('âš ï¸ Unexpected production response format:', prodResponse);
            allProductions = [];
        }
    }

    console.log('ðŸŒ¾ Productions extracted:', allProductions.length);

    // Filtrer pour ne garder que les productions valides
    allProductions = allProductions.filter(p => {
        const isValid = p && p.id && (p.cropName || p.cropId);
        if (!isValid) {
            console.warn('âš ï¸ Invalid production filtered out:', p);
        }
        return isValid;
    });

    console.log('âœ… Valid productions after filter:', allProductions.length);

    // Afficher les dÃ©tails des productions pour debug
    allProductions.forEach((prod, index) => {
        console.log(`ðŸ“ Production ${index + 1}:`, {
            id: prod.id,
            cropName: prod.cropName,
            productionCode: prod.productionCode,
            status: prod.productionStatus
        });
    });

} catch (err) {
    console.error('âŒ Error loading productions:', err);
    allProductions = [];

    // Afficher l'erreur spÃ©cifique
    showToast('âš ï¸ Could not load crop productions. Please check your connection.', 'warning');
}

console.log('ðŸŒ¾ Total valid productions loaded:', allProductions.length);



        // âœ… CrÃ©er le modal HTML
        const modalHTML = `
            <div class="modal-overlay show" id="fertilizerModal">
                <div class="modal-container modal-large" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <h3 class="modal-title">
                            <i class="fas fa-flask"></i>
                            Record Fertilizer Usage
                        </h3>
                        <button class="modal-close" onclick="closeFertilizerModal()" type="button"
                                style="color: white; opacity: 0.9;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="modal-body" style="padding: 25px;">
                        <form id="addFertilizerForm">
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">

                                <!-- Crop Production -->
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-seedling" style="color: #10b981;"></i>
                                        Crop Production *
                                    </label>
                                    ${allProductions.length === 0 ? `
                                        <div style="padding: 15px; background-color: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; margin-bottom: 10px;">
                                            <p style="margin: 0; color: #92400e; font-weight: 500;">
                                                âš ï¸ No crop productions available. Please add a crop production first.
                                            </p>
                                            <button type="button" onclick="window.location.href='#productions'"
                                                    style="margin-top: 10px; padding: 8px 15px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                                <i class="fas fa-plus"></i> Add Crop Production
                                            </button>
                                        </div>
                                    ` : ''}
                                    <select class="form-select" name="cropProductionId" ${allProductions.length === 0 ? 'disabled' : 'required'}
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                        <option value="">Select Production...</option>
                                        ${allProductions.map(prod => `
                                            <option value="${prod.id}">
                                                ${prod.cropName || 'Unknown'} - ${prod.season || ''} ${prod.year || ''}
                                                (${prod.productionStatus || ''})
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <!-- Fertilizer Type -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-tags" style="color: #10b981;"></i>
                                        Fertilizer Type *
                                    </label>
                                    <select class="form-select" name="fertilizerType" required
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Select Type...</option>
                                        <option value="ORGANIC">ðŸŒ± Organic</option>
                                        <option value="NPK">ðŸ”¬ NPK</option>
                                        <option value="NITROGEN">ðŸ’¨ Nitrogen</option>
                                        <option value="PHOSPHATE">ðŸ§ª Phosphate</option>
                                        <option value="POTASH">ðŸ’Ž Potash</option>
                                        <option value="MICRONUTRIENTS">âš—ï¸ Micronutrients</option>
                                    </select>
                                </div>

                                <!-- Fertilizer Name -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-signature" style="color: #10b981;"></i>
                                        Fertilizer Name *
                                    </label>
                                    <input type="text" class="form-input" name="fertilizerName"
                                           placeholder="e.g., Urea, DAP, Compost" required maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Brand -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-trademark" style="color: #10b981;"></i>
                                        Brand
                                    </label>
                                    <input type="text" class="form-input" name="brand"
                                           placeholder="e.g., Yara, Omex" maxlength="50"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Composition -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-microscope" style="color: #10b981;"></i>
                                        Composition (NPK)
                                    </label>
                                    <input type="text" class="form-input" name="composition"
                                           placeholder="e.g., 10-20-10" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Quantity -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-balance-scale" style="color: #10b981;"></i>
                                        Quantity *
                                    </label>
                                    <input type="number" class="form-input" name="quantity" id="fertQuantity"
                                           step="0.01" min="0.01" placeholder="e.g., 50.00" required
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Unit -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-ruler" style="color: #10b981;"></i>
                                        Unit *
                                    </label>
                                    <select class="form-select" name="unit" required
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Select Unit...</option>
                                        <option value="KG" selected>KG (Kilograms)</option>
                                        <option value="TONNES">Tonnes</option>
                                        <option value="LITERS">Liters</option>
                                        <option value="BAGS">Bags</option>
                                    </select>
                                </div>

                                <!-- Application Date -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-calendar" style="color: #10b981;"></i>
                                        Application Date *
                                    </label>
                                    <input type="date" class="form-input" name="applicationDate"
                                           value="${new Date().toISOString().split('T')[0]}"
                                           max="${new Date().toISOString().split('T')[0]}" required
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Application Method -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-spray-can" style="color: #10b981;"></i>
                                        Application Method *
                                    </label>
                                    <select class="form-select" name="applicationMethod" required
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Select Method...</option>
                                        <option value="BROADCAST">ðŸ“¡ Broadcast</option>
                                        <option value="BAND">ðŸŽ¯ Band</option>
                                        <option value="FOLIAR">ðŸŒ¿ Foliar</option>
                                        <option value="FERTIGATION">ðŸ’§ Fertigation</option>
                                        <option value="SPOT">ðŸ“ Spot</option>
                                    </select>
                                </div>

                                <!-- Application Stage -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-layer-group" style="color: #10b981;"></i>
                                        Application Stage
                                    </label>
                                    <input type="text" class="form-input" name="applicationStage"
                                           placeholder="e.g., PLANTING, FLOWERING" maxlength="50"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Cost Per Unit -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-money-bill-wave" style="color: #10b981;"></i>
                                        Cost Per Unit (RWF)
                                    </label>
                                    <input type="number" class="form-input" name="costPerUnit" id="fertCostPerUnit"
                                           step="0.01" min="0" placeholder="e.g., 1500.00"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Total Cost (auto-calculated) -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-calculator" style="color: #10b981;"></i>
                                        Total Cost (RWF)
                                    </label>
                                    <input type="number" class="form-input" name="totalCost" id="fertTotalCost"
                                           step="0.01" min="0" placeholder="Auto-calculated" readonly
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; background-color: #f9fafb;">
                                </div>

                                <!-- Supplier -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-building" style="color: #10b981;"></i>
                                        Supplier
                                    </label>
                                    <input type="text" class="form-input" name="supplier"
                                           placeholder="e.g., AgriSupply Ltd" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Batch Number -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-barcode" style="color: #10b981;"></i>
                                        Batch Number
                                    </label>
                                    <input type="text" class="form-input" name="batchNumber"
                                           placeholder="e.g., BAT-2024-001" maxlength="50"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Expiry Date -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-hourglass-end" style="color: #10b981;"></i>
                                        Expiry Date
                                    </label>
                                    <input type="date" class="form-input" name="expiryDate"
                                           min="${new Date().toISOString().split('T')[0]}"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Weather Conditions -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-cloud-sun" style="color: #10b981;"></i>
                                        Weather Conditions
                                    </label>
                                    <input type="text" class="form-input" name="weatherConditions"
                                           placeholder="e.g., Sunny, Cloudy" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Soil Conditions -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-mountain" style="color: #10b981;"></i>
                                        Soil Conditions
                                    </label>
                                    <input type="text" class="form-input" name="soilConditions"
                                           placeholder="e.g., Dry, Moist" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Operator Name -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-user-tie" style="color: #10b981;"></i>
                                        Operator Name
                                    </label>
                                    <input type="text" class="form-input" name="operatorName"
                                           placeholder="Who applied the fertilizer?" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Effectiveness Rating -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-star" style="color: #10b981;"></i>
                                        Effectiveness Rating (1-5)
                                    </label>
                                    <select class="form-select" name="effectivenessRating"
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Not rated yet</option>
                                        <option value="1">â­ 1 - Very Poor</option>
                                        <option value="2">â­â­ 2 - Poor</option>
                                        <option value="3">â­â­â­ 3 - Fair</option>
                                        <option value="4">â­â­â­â­ 4 - Good</option>
                                        <option value="5">â­â­â­â­â­ 5 - Excellent</option>
                                    </select>
                                </div>

                                <!-- Notes -->
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-sticky-note" style="color: #10b981;"></i>
                                        Notes
                                    </label>
                                    <textarea class="form-input" name="notes" rows="3"
                                              placeholder="Additional observations or remarks..." maxlength="3000"
                                              style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
                                </div>

                            </div>

                            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                <button type="button" class="btn btn-secondary" onclick="closeFertilizerModal()"
                                        style="padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary" ${allProductions.length === 0 ? 'disabled' : ''}
                                        style="padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; ${allProductions.length === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                    <i class="fas fa-save"></i>
                                    Save Fertilizer Usage
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        // âœ… Injecter le modal dans le DOM
        const modalContainer = document.getElementById('modalContainer');
        if (!modalContainer) {
            console.error('âŒ Modal container not found!');
            showToast('âŒ Error: Modal container not found', 'error');
            hideLoading();
            return;
        }

        modalContainer.innerHTML = modalHTML;

        console.log('âœ… Modal HTML injected');

        // âœ… Ajouter l'event listener pour le formulaire
        const form = document.getElementById('addFertilizerForm');
        if (form) {
            form.addEventListener('submit', handleAddFertilizer);
            console.log('âœ… Form submit handler attached');

            // Auto-calculate total cost
            const quantityInput = document.getElementById('fertQuantity');
            const costPerUnitInput = document.getElementById('fertCostPerUnit');
            const totalCostInput = document.getElementById('fertTotalCost');

            const calculateTotal = () => {
                const qty = parseFloat(quantityInput.value) || 0;
                const cost = parseFloat(costPerUnitInput.value) || 0;
                totalCostInput.value = (qty * cost).toFixed(2);
            };

            if (quantityInput && costPerUnitInput) {
                quantityInput.addEventListener('input', calculateTotal);
                costPerUnitInput.addEventListener('input', calculateTotal);
                console.log('âœ… Cost calculation handlers attached');
            }
        } else {
            console.error('âŒ Form not found after injection!');
        }

        // âœ… Forcer l'affichage du modal
        setTimeout(() => {
            const modal = document.getElementById('fertilizerModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.opacity = '1';
                console.log('âœ… Modal displayed');
            }
        }, 100);

    } catch (error) {
        console.error('âŒ Error opening fertilizer modal:', error);
        showToast('âŒ Error loading form: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Close Fertilizer Modal
 */
function closeFertilizerModal() {
    console.log('ðŸ”’ Closing fertilizer modal...');
    const modal = document.getElementById('fertilizerModal');
    if (modal) {
        modal.classList.remove('show');
        modal.style.opacity = '0';
        setTimeout(() => {
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.innerHTML = '';
            }
            console.log('âœ… Modal closed and removed');
        }, 300);
    }
}

/**
 * Handle Add Fertilizer - COMPLETE
 */
async function handleAddFertilizer(e) {
    e.preventDefault();

    console.log('ðŸ“ Submitting fertilizer form...');

    const formData = new FormData(e.target);

    const fertilizerData = {
        cropProductionId: formData.get('cropProductionId'),
        fertilizerType: formData.get('fertilizerType'),
        fertilizerName: formData.get('fertilizerName').trim(),
        brand: formData.get('brand')?.trim() || null,
        composition: formData.get('composition')?.trim() || null,
        quantity: parseFloat(formData.get('quantity')),
        unit: formData.get('unit'),
        applicationDate: formData.get('applicationDate'),
        applicationMethod: formData.get('applicationMethod'),
        applicationStage: formData.get('applicationStage')?.trim() || null,
        costPerUnit: formData.get('costPerUnit') ? parseFloat(formData.get('costPerUnit')) : null,
        totalCost: formData.get('totalCost') ? parseFloat(formData.get('totalCost')) : null,
        supplier: formData.get('supplier')?.trim() || null,
        batchNumber: formData.get('batchNumber')?.trim() || null,
        expiryDate: formData.get('expiryDate') || null,
        weatherConditions: formData.get('weatherConditions')?.trim() || null,
        soilConditions: formData.get('soilConditions')?.trim() || null,
        operatorName: formData.get('operatorName')?.trim() || null,
        effectivenessRating: formData.get('effectivenessRating') ? parseInt(formData.get('effectivenessRating')) : null,
        notes: formData.get('notes')?.trim() || null
    };

    // Validation
    if (!fertilizerData.cropProductionId) {
        showToast('âŒ Please select a crop production', 'error');
        return;
    }
    if (!fertilizerData.fertilizerType) {
        showToast('âŒ Please select fertilizer type', 'error');
        return;
    }
    if (!fertilizerData.quantity || fertilizerData.quantity <= 0) {
        showToast('âŒ Quantity must be greater than 0', 'error');
        return;
    }

    try {
        showLoading();

        console.log('ðŸ“¤ Sending fertilizer data:', fertilizerData);

        const response = await apiRequest('/fertilizer-usages', {
            method: 'POST',
            body: JSON.stringify(fertilizerData)
        });

        console.log('âœ… Fertilizer usage created:', response);
        showToast('âœ… Fertilizer usage recorded successfully!', 'success');

        closeFertilizerModal();

        // Recharger les donnÃ©es
        setTimeout(async () => {
            await loadFertilizerData();
        }, 500);

    } catch (error) {
        console.error('âŒ Error adding fertilizer:', error);
        showToast('âŒ Error: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Initialize Fertilizer Module
 */
function initializeFertilizerModule() {
    console.log('ðŸš€ Initializing Fertilizer Module...');

    // Action buttons
    document.querySelectorAll('[data-action="add-fertilizer"]').forEach(btn => {
        btn.removeEventListener('click', openAddFertilizerModal); // Remove old listeners
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('ðŸ–±ï¸ Add fertilizer button clicked');
            openAddFertilizerModal();
        });
    });

    document.querySelectorAll('[data-action="refresh-fertilizer"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            loadFertilizerData();
        });
    });

    console.log('âœ… Fertilizer module initialized');
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    console.log('ðŸ“„ DOM Content Loaded - Initializing...');
    setTimeout(initializeFertilizerModule, 500);
});

// Export functions
if (typeof window !== 'undefined') {
    window.openAddFertilizerModal = openAddFertilizerModal;
    window.closeFertilizerModal = closeFertilizerModal;
    window.handleAddFertilizer = handleAddFertilizer;
    window.initializeFertilizerModule = initializeFertilizerModule;
    console.log('âœ… Functions exported to window');
}







      /**
      * Create fertilizer cost chart
      */
      function createFertilizerCostChart(fertilizers) {
      const ctx = document.getElementById('fertilizerCostChart');
      if (!ctx) return;

      // Group by fertilizer type
      const costByType = {};
      fertilizers.forEach(fert => {
      const type = fert.fertilizerType;
      if (!costByType[type]) {
      costByType[type] = 0;
      }
      costByType[type] += parseFloat(fert.totalCost) || 0;
      });

      if (charts.fertilizerCost) {
      charts.fertilizerCost.destroy();
      }

      charts.fertilizerCost = new Chart(ctx, {
      type: 'bar',
      data: {
      labels: Object.keys(costByType),
      datasets: [{
      label: 'Total Cost (RWF)',
      data: Object.values(costByType),
      backgroundColor: '#3b82f6',
      borderWidth: 0
      }]
      },
      options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
      legend: {
      display: false
      }
      },
      scales: {
      y: {
      beginAtZero: true,
      ticks: {
      callback: function(value) {
      return formatCurrency(value);
      }
      }
      }
      }
      }
      });
      }

      /**
      * View fertilizer details
      */
      function viewFertilizerDetails(fertilizerId) {
      showToast('View fertilizer details feature - To be implemented', 'info');
      }

      /**
      * Edit fertilizer
      */
      function editFertilizer(fertilizerId) {
      showToast('Edit fertilizer feature - To be implemented', 'info');
      }







/**
 * Load irrigation data - VERSION CORRIGÃ‰E POUR SPRING BOOT
 */
async function loadIrrigationData() {
    try {
        showLoading();

        if (!currentUser || !currentUser.id) {
            console.warn('âš ï¸ No current user found');
            displayEmptyIrrigationData();
            return;
        }

        console.log('ðŸ”„ Loading irrigation data for farmer:', currentUser.id);

        // RÃ©cupÃ©rer les fermes d'abord
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

        let irrigations = [];

        if (farms.length > 0) {
            // RÃ©cupÃ©rer les irrigations pour chaque ferme
            const irrigationPromises = farms.map(farm =>
                apiRequest(`/irrigation/farm/${farm.id}`).catch(() => [])
            );

            const irrigationArrays = await Promise.all(irrigationPromises);

            // âœ… CORRECTION: GÃ©rer le format Page<IrrigationData> de Spring
            irrigationArrays.forEach(response => {
                let farmIrrigations = [];
                if (Array.isArray(response)) {
                    farmIrrigations = response;
                } else if (response && response.content && Array.isArray(response.content)) {
                    farmIrrigations = response.content;
                } else if (response && response.data && Array.isArray(response.data)) {
                    farmIrrigations = response.data;
                } else if (response && Array.isArray(response)) {
                    farmIrrigations = response;
                }
                irrigations = irrigations.concat(farmIrrigations);
            });

            // âœ… CORRECTION: Ajouter le nom de la ferme Ã  chaque irrigation
            irrigations = irrigations.map(irrig => {
                const farm = farms.find(f => f.id === irrig.farmId);
                return {
                    ...irrig,
                    farmName: farm ? farm.farmName : 'Unknown Farm'
                };
            });
        }

        console.log(`âœ… Loaded ${irrigations.length} irrigation records`);

        // Calculer les statistiques
        const totalSessions = irrigations.length;
        const totalWater = irrigations.reduce((sum, i) =>
            sum + (parseFloat(i.waterAmount) || 0), 0
        );
        const totalCost = irrigations.reduce((sum, i) =>
            sum + (parseFloat(i.totalCost) || 0), 0
        );

        // âœ… CORRECTION: Calculer l'efficacitÃ© moyenne basÃ©e sur les donnÃ©es
        let avgEfficiency = 0;
        const irrigationsWithEfficiency = irrigations.filter(i =>
            i.soilMoistureBefore != null && i.soilMoistureAfter != null
        );

        if (irrigationsWithEfficiency.length > 0) {
            const totalEfficiency = irrigationsWithEfficiency.reduce((sum, i) => {
                const moistureIncrease = parseFloat(i.soilMoistureAfter) - parseFloat(i.soilMoistureBefore);
                const waterAmount = parseFloat(i.waterAmount) || 1;
                const efficiency = (moistureIncrease / waterAmount) * 100;
                return sum + efficiency;
            }, 0);
            avgEfficiency = totalEfficiency / irrigationsWithEfficiency.length;
        }

        // Mettre Ã  jour les statistiques
        updateElement('irrigTotalSessions', totalSessions);
        updateElement('irrigTotalWater', `${totalWater.toFixed(2)} L`);
        updateElement('irrigTotalCost', formatCurrency(totalCost));
        updateElement('irrigAvgEfficiency', avgEfficiency > 0 ? `${avgEfficiency.toFixed(1)}%` : 'N/A');

        // Afficher les donnÃ©es
        displayIrrigationTable(irrigations);
        createIrrigationTrendChart(irrigations);

    } catch (error) {
        console.error('âŒ Error loading irrigation data:', error);
        showToast('Unable to load irrigation data', 'warning');
        displayEmptyIrrigationData();
    } finally {
        hideLoading();
    }
}

/**
 * Display irrigation table - VERSION CORRIGÃ‰E POUR SPRING BOOT
 */
function displayIrrigationTable(irrigations) {
    const tbody = document.getElementById('irrigationTableBody');
    if (!tbody) return;

    if (irrigations.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="empty-state">
                    <i class="fas fa-tint"></i>
                    <p>No irrigation records yet</p>
                    <button class="btn btn-primary mt-3" onclick="openAddIrrigationModal()">
                        <i class="fas fa-plus"></i>
                        Add First Irrigation Record
                    </button>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = irrigations.map(irrig => {
        // âœ… CORRECTION: GÃ©rer toutes les valeurs avec des valeurs par dÃ©faut
        const irrigationDate = irrig.irrigationDate ? formatDate(irrig.irrigationDate) : 'N/A';
        const farmName = irrig.farmName || 'Unknown Farm';
        const waterAmount = irrig.waterAmount ? parseFloat(irrig.waterAmount).toFixed(2) : '0.00';
        const duration = irrig.duration || 0;
        const irrigationMethod = irrig.irrigationMethod || 'N/A';
        const waterSource = irrig.waterSource || 'N/A';
        const moistureBefore = irrig.soilMoistureBefore ? parseFloat(irrig.soilMoistureBefore).toFixed(1) : 'N/A';
        const moistureAfter = irrig.soilMoistureAfter ? parseFloat(irrig.soilMoistureAfter).toFixed(1) : 'N/A';
        const totalCost = irrig.totalCost ? formatCurrency(irrig.totalCost) : formatCurrency(0);
        const irrigId = irrig.id || '';

        return `
            <tr>
                <td>${irrigationDate}</td>
                <td>${farmName}</td>
                <td>${waterAmount} L</td>
                <td>${duration} min</td>
                <td><span class="badge badge-info">${irrigationMethod}</span></td>
                <td><span class="badge badge-secondary">${waterSource}</span></td>
                <td>${moistureBefore}%</td>
                <td>${moistureAfter}%</td>
                <td><strong>${totalCost}</strong></td>
                <td>
                    <button class="btn-icon" onclick="viewIrrigationDetails('${irrigId}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-icon" onclick="editIrrigation('${irrigId}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon btn-danger" onclick="deleteIrrigation('${irrigId}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

/**
 * Open modal to add new irrigation - VERSION CORRIGÃ‰E POUR SPRING BOOT
 */
async function openAddIrrigationModal() {
    try {
        showLoading();

        // RÃ©cupÃ©rer les fermes de l'utilisateur
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

        if (farms.length === 0) {
            showToast('âŒ You need to create a farm first before recording irrigation', 'error');
            hideLoading();
            return;
        }

        const modalHTML = `
            <div class="modal-overlay show" id="irrigationModal" onclick="if(event.target === this) closeIrrigationModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-plus-circle"></i>
                            Record Irrigation
                        </h3>
                        <button class="modal-close" onclick="closeIrrigationModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form id="irrigationForm" onsubmit="submitIrrigationForm(event)">
                        <div class="modal-body">
                            <div class="form-grid">
                                <!-- Farm Selection -->
                                <div class="form-group full-width">
                                    <label class="required">Select Farm</label>
                                    <select name="farmId" class="form-control" required>
                                        <option value="">-- Select Farm --</option>
                                        ${farms.map(farm =>
                                            `<option value="${farm.id}">${farm.farmName} (${farm.location || 'No location'})</option>`
                                        ).join('')}
                                    </select>
                                </div>

                                <!-- Irrigation Date -->
                                <div class="form-group">
                                    <label class="required">Irrigation Date & Time</label>
                                    <input type="datetime-local" name="irrigationDate" class="form-control"
                                           value="${new Date().toISOString().slice(0, 16)}" required>
                                </div>

                                <!-- Water Amount -->
                                <div class="form-group">
                                    <label class="required">Water Amount (Liters)</label>
                                    <input type="number" name="waterAmount" class="form-control"
                                           min="0.01" step="0.01" placeholder="e.g., 1000" required>
                                </div>

                                <!-- Duration -->
                                <div class="form-group">
                                    <label class="required">Duration (Minutes)</label>
                                    <input type="number" name="duration" class="form-control"
                                           min="1" max="1440" placeholder="e.g., 60" required>
                                </div>

                                <!-- Irrigation Method -->
                                <div class="form-group">
                                    <label class="required">Irrigation Method</label>
                                    <select name="irrigationMethod" class="form-control" required>
                                        <option value="">-- Select Method --</option>
                                        <option value="SPRINKLER">SPRINKLER</option>
                                        <option value="DRIP">DRIP</option>
                                        <option value="FLOOD">FLOOD</option>
                                        <option value="FURROW">FURROW</option>
                                        <option value="MANUAL">MANUAL</option>
                                    </select>
                                </div>

                                <!-- Water Source -->
                                <div class="form-group">
                                    <label class="required">Water Source</label>
                                    <select name="waterSource" class="form-control" required>
                                        <option value="">-- Select Source --</option>
                                        <option value="WELL">WELL</option>
                                        <option value="RIVER">RIVER</option>
                                        <option value="LAKE">LAKE</option>
                                        <option value="RAINWATER">RAINWATER</option>
                                        <option value="MUNICIPAL">MUNICIPAL</option>
                                    </select>
                                </div>

                                <!-- Water Cost -->
                                <div class="form-group">
                                    <label>Water Cost per Liter (RWF)</label>
                                    <input type="number" name="waterCost" class="form-control"
                                           min="0" step="0.01" placeholder="e.g., 0.5">
                                </div>

                                <!-- Soil Moisture Before -->
                                <div class="form-group">
                                    <label>Soil Moisture Before (%)</label>
                                    <input type="number" name="soilMoistureBefore" class="form-control"
                                           min="0" max="100" step="0.01" placeholder="e.g., 45.5">
                                </div>

                                <!-- Soil Moisture After -->
                                <div class="form-group">
                                    <label>Soil Moisture After (%)</label>
                                    <input type="number" name="soilMoistureAfter" class="form-control"
                                           min="0" max="100" step="0.01" placeholder="e.g., 65.5">
                                </div>

                                <!-- Weather Condition -->
                                <div class="form-group">
                                    <label>Weather Condition</label>
                                    <input type="text" name="weatherCondition" class="form-control"
                                           placeholder="e.g., Sunny, Cloudy" maxlength="100">
                                </div>

                                <!-- Operator Name -->
                                <div class="form-group">
                                    <label>Operator Name</label>
                                    <input type="text" name="operatorName" class="form-control"
                                           placeholder="e.g., John Doe" maxlength="100">
                                </div>

                                <!-- Equipment Used -->
                                <div class="form-group">
                                    <label>Equipment Used</label>
                                    <input type="text" name="equipmentUsed" class="form-control"
                                           placeholder="e.g., Sprinkler System X200" maxlength="100">
                                </div>

                                <!-- Water Quality -->
                                <div class="form-group">
                                    <label>Water Quality</label>
                                    <input type="text" name="waterQuality" class="form-control"
                                           placeholder="e.g., Good, Excellent" maxlength="100">
                                </div>

                                <!-- Fertilizer Applied -->
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="fertilizerApplied" value="true">
                                        Fertilizer Applied During Irrigation
                                    </label>
                                </div>

                                <!-- Notes -->
                                <div class="form-group full-width">
                                    <label>Additional Notes</label>
                                    <textarea name="notes" class="form-control" rows="3"
                                              placeholder="Any additional observations or notes..." maxlength="3000"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeIrrigationModal()">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Save Irrigation Record
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

    } catch (error) {
        console.error('Error opening irrigation modal:', error);
        showToast('âŒ Error opening form', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Submit irrigation form - VERSION CORRIGÃ‰E POUR SPRING BOOT
 */
async function submitIrrigationForm(event) {
    event.preventDefault();

    try {
        showLoading();

        const form = event.target;
        const formData = new FormData(form);

        // âœ… CORRECTION: Construire l'objet irrigation selon le modÃ¨le Spring
        const irrigationData = {
            farmId: formData.get('farmId'),
            irrigationDate: formData.get('irrigationDate') + ':00', // Ajouter les secondes
            waterAmount: parseFloat(formData.get('waterAmount')),
            duration: parseInt(formData.get('duration')),
            irrigationMethod: formData.get('irrigationMethod'),
            waterSource: formData.get('waterSource'),
            waterCost: formData.get('waterCost') ? parseFloat(formData.get('waterCost')) : null,
            soilMoistureBefore: formData.get('soilMoistureBefore') ? parseFloat(formData.get('soilMoistureBefore')) : null,
            soilMoistureAfter: formData.get('soilMoistureAfter') ? parseFloat(formData.get('soilMoistureAfter')) : null,
            weatherCondition: formData.get('weatherCondition') || null,
            operatorName: formData.get('operatorName') || null,
            equipmentUsed: formData.get('equipmentUsed') || null,
            waterQuality: formData.get('waterQuality') || null,
            fertilizerApplied: formData.get('fertilizerApplied') === 'true',
            notes: formData.get('notes') || null
        };

        console.log('ðŸ“¤ Submitting irrigation data to Spring backend:', irrigationData);

        // Envoyer au serveur Spring
        const response = await apiRequest('/irrigation', {
            method: 'POST',
            body: JSON.stringify(irrigationData)
        });

        console.log('âœ… Irrigation created in Spring backend:', response);

        showToast('âœ… Irrigation record saved successfully!', 'success');
        closeIrrigationModal();

        // Recharger les donnÃ©es
        await loadIrrigationData();

    } catch (error) {
        console.error('âŒ Error saving irrigation:', error);
        showToast(`âŒ Error saving irrigation: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Display empty irrigation data
 */
function displayEmptyIrrigationData() {
    updateElement('irrigTotalSessions', 0);
    updateElement('irrigTotalWater', '0 L');
    updateElement('irrigTotalCost', formatCurrency(0));
    updateElement('irrigAvgEfficiency', 'N/A');

    const tbody = document.getElementById('irrigationTableBody');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="empty-state">
                    <i class="fas fa-tint"></i>
                    <p>No irrigation records yet</p>
                    <button class="btn btn-primary mt-3" onclick="openAddIrrigationModal()">
                        <i class="fas fa-plus"></i>
                        Record First Irrigation
                    </button>
                </td>
            </tr>
        `;
    }
}

/**
 * Close irrigation modal
 */
function closeIrrigationModal() {
    const modal = document.getElementById('irrigationModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}

/**
 * View irrigation details - VERSION CORRIGÃ‰E POUR SPRING BOOT
 */
async function viewIrrigationDetails(irrigationId) {
    try {
        showLoading();
        const irrigation = await apiRequest(`/irrigation/${irrigationId}`);

        // RÃ©cupÃ©rer le nom de la ferme
        let farmName = 'Unknown Farm';
        if (irrigation.farmId) {
            try {
                const farm = await apiRequest(`/farms/${irrigation.farmId}`);
                farmName = farm.farmName || farmName;
            } catch (e) {
                console.warn('Could not fetch farm name:', e);
            }
        }

        const modalHTML = `
            <div class="modal-overlay show" id="irrigationDetailsModal" onclick="if(event.target === this) closeIrrigationDetailsModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-info-circle"></i>
                            Irrigation Details
                        </h3>
                        <button class="modal-close" onclick="closeIrrigationDetailsModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Irrigation ID</label>
                                <value>${irrigation.id}</value>
                            </div>
                            <div class="detail-item">
                                <label>Farm</label>
                                <value>${farmName}</value>
                            </div>
                            <div class="detail-item">
                                <label>Date & Time</label>
                                <value>${formatDateTime(irrigation.irrigationDate)}</value>
                            </div>
                            <div class="detail-item">
                                <label>Water Amount</label>
                                <value>${irrigation.waterAmount} L</value>
                            </div>
                            <div class="detail-item">
                                <label>Duration</label>
                                <value>${irrigation.duration} minutes</value>
                            </div>
                            <div class="detail-item">
                                <label>Method</label>
                                <value><span class="badge badge-info">${irrigation.irrigationMethod}</span></value>
                            </div>
                            <div class="detail-item">
                                <label>Water Source</label>
                                <value><span class="badge badge-secondary">${irrigation.waterSource}</span></value>
                            </div>
                            ${irrigation.waterCost ? `
                            <div class="detail-item">
                                <label>Water Cost</label>
                                <value>${formatCurrency(irrigation.waterCost)} per liter</value>
                            </div>
                            ` : ''}
                            ${irrigation.totalCost ? `
                            <div class="detail-item">
                                <label>Total Cost</label>
                                <value class="text-success"><strong>${formatCurrency(irrigation.totalCost)}</strong></value>
                            </div>
                            ` : ''}
                            ${irrigation.soilMoistureBefore ? `
                            <div class="detail-item">
                                <label>Soil Moisture Before</label>
                                <value>${irrigation.soilMoistureBefore}%</value>
                            </div>
                            ` : ''}
                            ${irrigation.soilMoistureAfter ? `
                            <div class="detail-item">
                                <label>Soil Moisture After</label>
                                <value>${irrigation.soilMoistureAfter}%</value>
                            </div>
                            ` : ''}
                            ${irrigation.weatherCondition ? `
                            <div class="detail-item">
                                <label>Weather</label>
                                <value>${irrigation.weatherCondition}</value>
                            </div>
                            ` : ''}
                            ${irrigation.operatorName ? `
                            <div class="detail-item">
                                <label>Operator</label>
                                <value>${irrigation.operatorName}</value>
                            </div>
                            ` : ''}
                            ${irrigation.equipmentUsed ? `
                            <div class="detail-item">
                                <label>Equipment</label>
                                <value>${irrigation.equipmentUsed}</value>
                            </div>
                            ` : ''}
                            ${irrigation.waterQuality ? `
                            <div class="detail-item">
                                <label>Water Quality</label>
                                <value>${irrigation.waterQuality}</value>
                            </div>
                            ` : ''}
                            <div class="detail-item">
                                <label>Fertilizer Applied</label>
                                <value>${irrigation.fertilizerApplied ? 'âœ… Yes' : 'âŒ No'}</value>
                            </div>
                            ${irrigation.notes ? `
                            <div class="detail-item full-width">
                                <label>Notes</label>
                                <value>${irrigation.notes}</value>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeIrrigationDetailsModal()">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                        <button type="button" class="btn btn-primary" onclick="editIrrigation('${irrigation.id}')">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

    } catch (error) {
        console.error('Error loading irrigation details:', error);
        showToast('âŒ Error loading details', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Close irrigation details modal
 */
function closeIrrigationDetailsModal() {
    const modal = document.getElementById('irrigationDetailsModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}

/**
 * Delete irrigation - VERSION CORRIGÃ‰E POUR SPRING BOOT
 */
async function deleteIrrigation(irrigationId) {
    if (!confirm('Are you sure you want to delete this irrigation record?')) {
        return;
    }

    try {
        showLoading();
        await apiRequest(`/irrigation/${irrigationId}`, { method: 'DELETE' });
        showToast('âœ… Irrigation record deleted successfully', 'success');
        await loadIrrigationData();
    } catch (error) {
        console.error('Error deleting irrigation:', error);
        showToast('âŒ Error deleting irrigation', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Edit irrigation - VERSION CORRIGÃ‰E POUR SPRING BOOT
 */
async function editIrrigation(irrigationId) {
    try {
        showLoading();

        // RÃ©cupÃ©rer les donnÃ©es actuelles
        const irrigation = await apiRequest(`/irrigation/${irrigationId}`);

        // RÃ©cupÃ©rer les fermes
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

        // Formater la date pour l'input datetime-local
        const irrigationDate = irrigation.irrigationDate ?
            irrigation.irrigationDate.replace('Z', '').substring(0, 16) :
            new Date().toISOString().slice(0, 16);

        const modalHTML = `
            <div class="modal-overlay show" id="irrigationModal" onclick="if(event.target === this) closeIrrigationModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-edit"></i>
                            Edit Irrigation
                        </h3>
                        <button class="modal-close" onclick="closeIrrigationModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form id="editIrrigationForm" onsubmit="updateIrrigation(event, '${irrigationId}')">
                        <div class="modal-body">
                            <div class="form-grid">
                                <!-- Farm Selection -->
                                <div class="form-group full-width">
                                    <label class="required">Select Farm</label>
                                    <select name="farmId" class="form-control" required>
                                        <option value="">-- Select Farm --</option>
                                        ${farms.map(farm =>
                                            `<option value="${farm.id}" ${farm.id === irrigation.farmId ? 'selected' : ''}>
                                                ${farm.farmName} (${farm.location || 'No location'})
                                            </option>`
                                        ).join('')}
                                    </select>
                                </div>

                                <!-- Irrigation Date -->
                                <div class="form-group">
                                    <label class="required">Irrigation Date & Time</label>
                                    <input type="datetime-local" name="irrigationDate" class="form-control"
                                           value="${irrigationDate}" required>
                                </div>

                                <!-- Water Amount -->
                                <div class="form-group">
                                    <label class="required">Water Amount (Liters)</label>
                                    <input type="number" name="waterAmount" class="form-control"
                                           min="0.01" step="0.01" value="${irrigation.waterAmount || ''}" required>
                                </div>

                                <!-- Duration -->
                                <div class="form-group">
                                    <label class="required">Duration (Minutes)</label>
                                    <input type="number" name="duration" class="form-control"
                                           min="1" max="1440" value="${irrigation.duration || ''}" required>
                                </div>

                                <!-- Irrigation Method -->
                                <div class="form-group">
                                    <label class="required">Irrigation Method</label>
                                    <select name="irrigationMethod" class="form-control" required>
                                        <option value="">-- Select Method --</option>
                                        <option value="SPRINKLER" ${irrigation.irrigationMethod === 'SPRINKLER' ? 'selected' : ''}>SPRINKLER</option>
                                        <option value="DRIP" ${irrigation.irrigationMethod === 'DRIP' ? 'selected' : ''}>DRIP</option>
                                        <option value="FLOOD" ${irrigation.irrigationMethod === 'FLOOD' ? 'selected' : ''}>FLOOD</option>
                                        <option value="FURROW" ${irrigation.irrigationMethod === 'FURROW' ? 'selected' : ''}>FURROW</option>
                                        <option value="MANUAL" ${irrigation.irrigationMethod === 'MANUAL' ? 'selected' : ''}>MANUAL</option>
                                    </select>
                                </div>

                                <!-- Water Source -->
                                <div class="form-group">
                                    <label class="required">Water Source</label>
                                    <select name="waterSource" class="form-control" required>
                                        <option value="">-- Select Source --</option>
                                        <option value="WELL" ${irrigation.waterSource === 'WELL' ? 'selected' : ''}>WELL</option>
                                        <option value="RIVER" ${irrigation.waterSource === 'RIVER' ? 'selected' : ''}>RIVER</option>
                                        <option value="LAKE" ${irrigation.waterSource === 'LAKE' ? 'selected' : ''}>LAKE</option>
                                        <option value="RAINWATER" ${irrigation.waterSource === 'RAINWATER' ? 'selected' : ''}>RAINWATER</option>
                                        <option value="MUNICIPAL" ${irrigation.waterSource === 'MUNICIPAL' ? 'selected' : ''}>MUNICIPAL</option>
                                    </select>
                                </div>

                                <!-- Autres champs similaires avec les valeurs actuelles -->
                                ${generateEditFormFields(irrigation)}

                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeIrrigationModal()">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Update Irrigation
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

    } catch (error) {
        console.error('Error opening edit irrigation modal:', error);
        showToast('âŒ Error opening edit form', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Update irrigation - VERSION CORRIGÃ‰E POUR SPRING BOOT
 */
async function updateIrrigation(event, irrigationId) {
    event.preventDefault();

    try {
        showLoading();

        const form = event.target;
        const formData = new FormData(form);

        // Construire l'objet irrigation pour la mise Ã  jour
        const irrigationData = {
            farmId: formData.get('farmId'),
            irrigationDate: formData.get('irrigationDate') + ':00',
            waterAmount: parseFloat(formData.get('waterAmount')),
            duration: parseInt(formData.get('duration')),
            irrigationMethod: formData.get('irrigationMethod'),
            waterSource: formData.get('waterSource'),
            waterCost: formData.get('waterCost') ? parseFloat(formData.get('waterCost')) : null,
            soilMoistureBefore: formData.get('soilMoistureBefore') ? parseFloat(formData.get('soilMoistureBefore')) : null,
            soilMoistureAfter: formData.get('soilMoistureAfter') ? parseFloat(formData.get('soilMoistureAfter')) : null,
            weatherCondition: formData.get('weatherCondition') || null,
            operatorName: formData.get('operatorName') || null,
            equipmentUsed: formData.get('equipmentUsed') || null,
            waterQuality: formData.get('waterQuality') || null,
            fertilizerApplied: formData.get('fertilizerApplied') === 'true',
            notes: formData.get('notes') || null
        };

        console.log('ðŸ“¤ Updating irrigation data:', irrigationData);

        // Appel PUT vers Spring backend
        const response = await apiRequest(`/irrigation/${irrigationId}`, {
            method: 'PUT',
            body: JSON.stringify(irrigationData)
        });

        console.log('âœ… Irrigation updated successfully:', response);

        showToast('âœ… Irrigation record updated successfully!', 'success');
        closeIrrigationModal();
        await loadIrrigationData();

    } catch (error) {
        console.error('âŒ Error updating irrigation:', error);
        showToast(`âŒ Error updating irrigation: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

// ============================================================================
// SETUP EVENT LISTENERS FOR IRRIGATION SECTION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Ã‰couter le clic sur le bouton "Record Irrigation"
    const addIrrigationBtn = document.querySelector('[data-action="add-irrigation"]');
    if (addIrrigationBtn) {
        addIrrigationBtn.addEventListener('click', openAddIrrigationModal);
    }

    // Ã‰couter le clic sur le bouton "Refresh"
    const refreshIrrigationBtn = document.querySelector('[data-action="refresh-irrigation"]');
    if (refreshIrrigationBtn) {
        refreshIrrigationBtn.addEventListener('click', loadIrrigationData);
    }
});



/**
 * Create irrigation trend chart
 */
function createIrrigationTrendChart(irrigations) {
    const ctx = document.getElementById('irrigationTrendChart');
    if (!ctx) return;

    // Group by month
    const monthlyData = {};
    irrigations.forEach(irrig => {
        const date = new Date(irrig.irrigationDate);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = 0;
        }
        monthlyData[monthKey] += parseFloat(irrig.waterAmount) || 0;
    });

    const sortedKeys = Object.keys(monthlyData).sort();
    const labels = sortedKeys.map(key => {
        const [year, month] = key.split('-');
        return new Date(year, parseInt(month) - 1).toLocaleString('default', { month: 'short', year: 'numeric' });
    });
    const data = sortedKeys.map(key => monthlyData[key]);

    if (window.charts && window.charts.irrigationTrend) {
        window.charts.irrigationTrend.destroy();
    }

    if (!window.charts) window.charts = {};

    window.charts.irrigationTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Water Usage (Liters)',
                data: data,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' L';
                        }
                    }
                }
            }
        }
    });
}

// ============================================================================
// SETUP EVENT LISTENERS FOR IRRIGATION SECTION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Ã‰couter le clic sur le bouton "Record Irrigation"
    const addIrrigationBtn = document.querySelector('[data-action="add-irrigation"]');
    if (addIrrigationBtn) {
        addIrrigationBtn.addEventListener('click', openAddIrrigationModal);
    }

    // Ã‰couter le clic sur le bouton "Refresh"
    const refreshIrrigationBtn = document.querySelector('[data-action="refresh-irrigation"]');
    if (refreshIrrigationBtn) {
        refreshIrrigationBtn.addEventListener('click', loadIrrigationData);
    }
});

      /**
      * View irrigation details
      */
      function viewIrrigationDetails(irrigationId) {
      showToast('View irrigation details feature - To be implemented', 'info');
      }


// ============================================================================
// SOIL DATA MODULE - CORRECTED VERSION
// ============================================================================

/**
 * Load soil data - CORRECTION COMPLÃˆTE
 * Fix: Utiliser le bon endpoint v1 et gÃ©rer les erreurs proprement
 */
async function loadSoilData() {
  try {
    showLoading();

    if (!currentUser || !currentUser.id) {
      console.warn('âš ï¸ No current user found');
      displayEmptySoilData();
      return;
    }

    console.log('ðŸ”„ Loading soil data for farmer:', currentUser.id);

    // CORRECTION 1: RÃ©cupÃ©rer d'abord les fermes de l'utilisateur
    let farms = [];
    try {
      const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
      farms = Array.isArray(farmsResponse) ? farmsResponse : [];
      console.log(`âœ… Loaded ${farms.length} farms`);
    } catch (error) {
      console.warn('âš ï¸ Error loading farms:', error.message);
      farms = [];
    }

    if (farms.length === 0) {
      console.warn('âš ï¸ No farms found for user');
      displayEmptySoilData();
      return;
    }

    // CORRECTION 2: RÃ©cupÃ©rer les donnÃ©es de sol pour chaque ferme avec le bon endpoint
    let allSoilData = [];

    for (const farm of farms) {
      try {
        console.log(`ðŸ”„ Fetching soil data for farm ${farm.id}`);

        // CORRECTION 3: Utiliser le bon endpoint /api/v1/soil-data/farm/{farmId}
        const soilResponse = await apiRequest(`/v1/soil-data/farm/${farm.id}/all`);

        // CORRECTION 4: GÃ©rer diffÃ©rents formats de rÃ©ponse
        let farmSoilData = [];
        if (Array.isArray(soilResponse)) {
          farmSoilData = soilResponse;
        } else if (soilResponse && soilResponse.content && Array.isArray(soilResponse.content)) {
          farmSoilData = soilResponse.content;
        } else if (soilResponse && soilResponse.data && Array.isArray(soilResponse.data)) {
          farmSoilData = soilResponse.data;
        } else if (soilResponse && typeof soilResponse === 'object') {
          // Si c'est un objet unique, le mettre dans un tableau
          farmSoilData = [soilResponse];
        } else {
          console.warn(`âš ï¸ Unexpected soil data format for farm ${farm.id}:`, soilResponse);
          farmSoilData = [];
        }

        console.log(`âœ… Loaded ${farmSoilData.length} soil records for farm ${farm.id}`);
        allSoilData = allSoilData.concat(farmSoilData);

      } catch (error) {
        console.warn(`âš ï¸ Error loading soil data for farm ${farm.id}:`, error.message);
        // Continue avec les autres fermes mÃªme en cas d'erreur
      }
    }

    console.log(`âœ… Total soil data records loaded: ${allSoilData.length}`);

    // Afficher les donnÃ©es
    displaySoilDataGrid(allSoilData, farms);
    updateSoilDataStatistics(allSoilData);

  } catch (error) {
    console.error('âŒ Error loading soil data:', error);
    showToast('Unable to load soil data', 'warning');
    displayEmptySoilData();
  } finally {
    hideLoading();
  }
}

/**
 * Display soil data grid - VERSION AMÃ‰LIORÃ‰E
 */
function displaySoilDataGrid(soilData, farms) {
  const container = document.getElementById('soilDataGrid');
  if (!container) {
    console.warn('âš ï¸ Soil data container not found');
    return;
  }

  if (!soilData || soilData.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-mountain"></i>
        </div>
        <h3>No Soil Data Available</h3>
        <p>No soil analysis records found for your farms.</p>
        <p class="empty-state-hint">
          <i class="fas fa-info-circle"></i>
          Contact your agricultural advisor for soil testing services
        </p>
        <button class="btn btn-primary mt-4" onclick="showSoilTestingInfo()">
          <i class="fas fa-flask"></i>
          Learn About Soil Testing
        </button>
      </div>
    `;
    return;
  }

  // CrÃ©er une map des fermes pour un accÃ¨s rapide
  const farmMap = new Map();
  if (farms && Array.isArray(farms)) {
    farms.forEach(farm => farmMap.set(farm.id, farm));
  }

  container.innerHTML = soilData.map(soil => {
    const farm = farmMap.get(soil.farmId);
    const farmName = farm ? farm.farmName : 'Unknown Farm';

    // GÃ©rer les valeurs nulles proprement
    const phLevel = soil.phLevel ? parseFloat(soil.phLevel).toFixed(2) : 'N/A';
    const phStatus = soil.phLevel ? getPhStatus(soil.phLevel) : 'unknown';
    const phLabel = soil.phLevel ? getPhLabel(soil.phLevel) : 'Unknown';

    const nitrogenLevel = soil.nitrogenLevel || 'N/A';
    const phosphorusLevel = soil.phosphorusLevel || 'N/A';
    const potassiumLevel = soil.potassiumLevel || 'N/A';
    const organicMatter = soil.organicMatter ? parseFloat(soil.organicMatter).toFixed(2) : 'N/A';
    const moisture = soil.moisture ? parseFloat(soil.moisture).toFixed(2) : 'N/A';

    const measurementDate = soil.measurementDate ? formatDate(soil.measurementDate) : 'N/A';
    const sampleCode = soil.sampleCode || 'N/A';
    const depthCm = soil.depthCm || 'N/A';

    return `
      <div class="soil-data-card" data-soil-id="${soil.id}">
        <div class="soil-card-header">
          <div class="soil-icon">ðŸŒ±</div>
          <h3 class="soil-name">${escapeHtml(farmName)}</h3>
          <span class="soil-sample-badge">Sample: ${escapeHtml(sampleCode)}</span>
        </div>
        <div class="soil-card-body">
          <div class="soil-info-list">
            <div class="soil-info-item">
              <span class="soil-info-label">pH Level</span>
              <span class="soil-info-value" style="background: ${phStatus === 'good' ? 'rgba(34, 197, 94, 0.15)' : phStatus === 'moderate' ? 'rgba(255, 193, 7, 0.15)' : 'rgba(239, 68, 68, 0.15)'}; color: ${phStatus === 'good' ? 'var(--primary-green)' : phStatus === 'moderate' ? '#f59e0b' : '#ef4444'}; font-weight: 800; font-size: 16px;">${phLevel} (${phLabel})</span>
            </div>
            <div class="soil-info-item">
              <span class="soil-info-label">Nitrogen (N)</span>
              <span class="soil-info-value">${escapeHtml(nitrogenLevel)}</span>
            </div>
            <div class="soil-info-item">
              <span class="soil-info-label">Phosphorus (P)</span>
              <span class="soil-info-value">${escapeHtml(phosphorusLevel)}</span>
            </div>
            <div class="soil-info-item">
              <span class="soil-info-label">Potassium (K)</span>
              <span class="soil-info-value">${escapeHtml(potassiumLevel)}</span>
            </div>
            <div class="soil-info-item">
              <span class="soil-info-label">Organic Matter</span>
              <span class="soil-info-value">${organicMatter}%</span>
            </div>
            <div class="soil-info-item">
              <span class="soil-info-label">Moisture</span>
              <span class="soil-info-value">${moisture}%</span>
            </div>
            <div class="soil-info-item">
              <span class="soil-info-label">Depth</span>
              <span class="soil-info-value">${depthCm} cm</span>
            </div>
            ${soil.soilTexture ? `
            <div class="soil-info-item">
              <span class="soil-info-label">Texture</span>
              <span class="soil-info-value">${escapeHtml(soil.soilTexture)}</span>
            </div>
            ` : ''}
            <div class="soil-info-item">
              <span class="soil-info-label">Measurement Date</span>
              <span class="soil-info-value">${measurementDate}</span>
            </div>
            ${soil.laboratoryName ? `
            <div class="soil-info-item">
              <span class="soil-info-label">Laboratory</span>
              <span class="soil-info-value">${escapeHtml(soil.laboratoryName)}</span>
            </div>
            ` : ''}
            ${soil.testingMethod ? `
            <div class="soil-info-item">
              <span class="soil-info-label">Testing Method</span>
              <span class="soil-info-value">${escapeHtml(soil.testingMethod)}</span>
            </div>
            ` : ''}
          </div>
          ${soil.recommendations ? `
          <div style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); border-left: 4px solid #ffc107; border-radius: 8px;">
            <h4 style="margin: 0 0 0.5rem 0; color: #856404; font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-lightbulb" style="color: #ffc107;"></i>
              Recommendations
            </h4>
            <p style="margin: 0; color: #666; line-height: 1.6; font-size: 0.9rem;">${escapeHtml(soil.recommendations)}</p>
          </div>
          ` : ''}
          <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
            <button class="btn" onclick="viewSoilDetails('${soil.id}')" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)';">
              <i class="fas fa-eye"></i>
              View Report
            </button>
            <button class="btn" onclick="downloadSoilReport('${soil.id}')" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(34, 197, 94, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.3)';">
              <i class="fas fa-download"></i>
              Download PDF
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

/**
 * Update soil data statistics
 */
function updateSoilDataStatistics(soilData) {
  const statsContainer = document.getElementById('soilStats');
  if (!statsContainer || !soilData || soilData.length === 0) return;

  try {
    // Calculer les statistiques
    const totalSamples = soilData.length;

    // pH moyen
    const phValues = soilData
      .filter(s => s.phLevel)
      .map(s => parseFloat(s.phLevel));
    const avgPh = phValues.length > 0
      ? (phValues.reduce((a, b) => a + b, 0) / phValues.length).toFixed(2)
      : 0;

    // Organic matter moyen
    const organicValues = soilData
      .filter(s => s.organicMatter)
      .map(s => parseFloat(s.organicMatter));
    const avgOrganic = organicValues.length > 0
      ? (organicValues.reduce((a, b) => a + b, 0) / organicValues.length).toFixed(2)
      : 0;

    // Compter les sols avec problÃ¨mes
    let problematicSoils = 0;
    soilData.forEach(soil => {
      if (soil.phLevel) {
        const ph = parseFloat(soil.phLevel);
        if (ph < 5.5 || ph > 8.0) problematicSoils++;
      }
      if (soil.organicMatter && parseFloat(soil.organicMatter) < 2.0) {
        problematicSoils++;
      }
    });

    // Tests nÃ©cessaires (simulÃ© - basÃ© sur la date du dernier test)
    const today = new Date();
    let testsDue = 0;
    soilData.forEach(soil => {
      if (soil.nextTestDueDate) {
        const dueDate = new Date(soil.nextTestDueDate);
        if (dueDate <= today) testsDue++;
      }
    });

    // Afficher les statistiques
    const statsHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon primary">
            <i class="fas fa-vial"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Total Samples</span>
            <span class="stat-value">${totalSamples}</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon info">
            <i class="fas fa-tint"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Average pH</span>
            <span class="stat-value">${avgPh}</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon success">
            <i class="fas fa-recycle"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Avg Organic Matter</span>
            <span class="stat-value">${avgOrganic}%</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon ${problematicSoils > 0 ? 'warning' : 'success'}">
            <i class="fas fa-${problematicSoils > 0 ? 'exclamation-triangle' : 'check-circle'}"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Problematic Soils</span>
            <span class="stat-value">${problematicSoils}</span>
          </div>
        </div>

        ${testsDue > 0 ? `
        <div class="stat-card">
          <div class="stat-icon warning">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Tests Due</span>
            <span class="stat-value">${testsDue}</span>
          </div>
        </div>
        ` : ''}
      </div>
    `;

    statsContainer.innerHTML = statsHTML;

  } catch (error) {
    console.error('Error updating soil statistics:', error);
  }
}

/**
 * Display empty soil data state
 */
function displayEmptySoilData() {
  const container = document.getElementById('soilDataGrid');
  if (!container) return;

  container.innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">
        <i class="fas fa-mountain"></i>
      </div>
      <h3>No Soil Data Available</h3>
      <p>Start managing your soil health by conducting soil tests.</p>
      <div class="empty-state-actions">
        <button class="btn btn-primary" onclick="showSoilTestingInfo()">
          <i class="fas fa-flask"></i>
          Learn About Soil Testing
        </button>
      </div>
    </div>
  `;

  // RÃ©initialiser les stats
  const statsContainer = document.getElementById('soilStats');
  if (statsContainer) {
    statsContainer.innerHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-vial"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Total Samples</span>
            <span class="stat-value">0</span>
          </div>
        </div>
      </div>
    `;
  }
}

/**
 * Get pH status class
 */
function getPhStatus(ph) {
  const phValue = parseFloat(ph);
  if (isNaN(phValue)) return 'unknown';

  if (phValue >= 6.0 && phValue <= 7.5) return 'good';
  if ((phValue >= 5.5 && phValue < 6.0) || (phValue > 7.5 && phValue <= 8.0)) return 'moderate';
  return 'poor';
}

/**
 * Get pH label
 */
function getPhLabel(ph) {
  const phValue = parseFloat(ph);
  if (isNaN(phValue)) return 'Unknown';

  if (phValue >= 6.0 && phValue <= 7.5) return 'Optimal';
  if (phValue < 6.0) return 'Acidic';
  return 'Alkaline';
}

/**
 * View soil details - CORRECTION
 */
async function viewSoilDetails(soilId) {
  try {
    showLoading();

    // CORRECTION: Utiliser le bon endpoint
    const soil = await apiRequest(`/v1/soil-data/${soilId}`);

    showSoilDetailsModal(soil);

  } catch (error) {
    console.error('Error loading soil details:', error);
    showToast('âŒ Error loading soil details', 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Show soil details modal
 */
function showSoilDetailsModal(soil) {
  if (!soil) return;

  const modalHTML = `
    <div class="modal-overlay show" id="soilModal" onclick="if(event.target === this) closeSoilModal()">
      <div class="modal-container modal-large">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-flask"></i>
            Soil Analysis Report
          </h3>
          <button class="modal-close" onclick="closeSoilModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="soil-report">

            <!-- Sample Information -->
            <div class="report-section">
              <h4><i class="fas fa-info-circle"></i> Sample Information</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <label>Sample Code:</label>
                  <value>${soil.sampleCode || 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Measurement Date:</label>
                  <value>${soil.measurementDate ? formatDate(soil.measurementDate) : 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Depth:</label>
                  <value>${soil.depthCm || 'N/A'} cm</value>
                </div>
                <div class="detail-item">
                  <label>Soil Texture:</label>
                  <value>${soil.soilTexture || 'N/A'}</value>
                </div>
              </div>
            </div>

            <!-- Chemical Properties -->
            <div class="report-section">
              <h4><i class="fas fa-flask"></i> Chemical Properties</h4>
              <div class="details-grid">
                <div class="detail-item highlight">
                  <label>pH Level:</label>
                  <value class="${getPhStatus(soil.phLevel)}">
                    ${soil.phLevel ? parseFloat(soil.phLevel).toFixed(2) : 'N/A'}
                    <span class="status-badge">${getPhLabel(soil.phLevel)}</span>
                  </value>
                </div>
                <div class="detail-item">
                  <label>Nitrogen (N):</label>
                  <value>${soil.nitrogenLevel || 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Phosphorus (P):</label>
                  <value>${soil.phosphorusLevel || 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Potassium (K):</label>
                  <value>${soil.potassiumLevel || 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Organic Matter:</label>
                  <value>${soil.organicMatter ? parseFloat(soil.organicMatter).toFixed(2) + '%' : 'N/A'}</value>
                </div>
                ${soil.electricalConductivity ? `
                <div class="detail-item">
                  <label>EC (Salinity):</label>
                  <value>${soil.electricalConductivity} dS/m</value>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Physical Properties -->
            <div class="report-section">
              <h4><i class="fas fa-layer-group"></i> Physical Properties</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <label>Moisture:</label>
                  <value>${soil.moisture ? parseFloat(soil.moisture).toFixed(2) + '%' : 'N/A'}</value>
                </div>
                ${soil.bulkDensity ? `
                <div class="detail-item">
                  <label>Bulk Density:</label>
                  <value>${soil.bulkDensity} g/cmÂ³</value>
                </div>
                ` : ''}
                ${soil.porosity ? `
                <div class="detail-item">
                  <label>Porosity:</label>
                  <value>${soil.porosity}%</value>
                </div>
                ` : ''}
                ${soil.drainageClass ? `
                <div class="detail-item">
                  <label>Drainage Class:</label>
                  <value>${soil.drainageClass}</value>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Laboratory Information -->
            ${soil.laboratoryName || soil.testingMethod ? `
            <div class="report-section">
              <h4><i class="fas fa-microscope"></i> Laboratory Information</h4>
              <div class="details-grid">
                ${soil.laboratoryName ? `
                <div class="detail-item">
                  <label>Laboratory:</label>
                  <value>${soil.laboratoryName}</value>
                </div>
                ` : ''}
                ${soil.testingMethod ? `
                <div class="detail-item">
                  <label>Testing Method:</label>
                  <value>${soil.testingMethod}</value>
                </div>
                ` : ''}
                ${soil.testedBy ? `
                <div class="detail-item">
                  <label>Tested By:</label>
                  <value>${soil.testedBy}</value>
                </div>
                ` : ''}
              </div>
            </div>
            ` : ''}

            <!-- Recommendations -->
            ${soil.recommendations ? `
            <div class="report-section recommendations">
              <h4><i class="fas fa-lightbulb"></i> Recommendations</h4>
              <div class="recommendations-content">
                <p>${soil.recommendations}</p>
              </div>
            </div>
            ` : ''}

            <!-- Notes -->
            ${soil.notes ? `
            <div class="report-section">
              <h4><i class="fas fa-sticky-note"></i> Additional Notes</h4>
              <div class="notes-content">
                <p>${soil.notes}</p>
              </div>
            </div>
            ` : ''}

            <!-- Next Test Due -->
            ${soil.nextTestDueDate ? `
            <div class="report-section">
              <h4><i class="fas fa-calendar-check"></i> Next Test Schedule</h4>
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Next soil test recommended by: <strong>${formatDate(soil.nextTestDueDate)}</strong>
              </div>
            </div>
            ` : ''}

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeSoilModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
          <button type="button" class="btn btn-primary" onclick="downloadSoilReport('${soil.id}')">
            <i class="fas fa-download"></i>
            Download PDF
          </button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close soil modal
 */
function closeSoilModal() {
  const modal = document.getElementById('soilModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}

/**
 * Download soil report as PDF
 */
async function downloadSoilReport(soilId) {
  try {
    showLoading();
    showToast('Generating PDF report...', 'info');

    // RÃ©cupÃ©rer les donnÃ©es complÃ¨tes
    const soil = await apiRequest(`/v1/soil-data/${soilId}`);

    // CrÃ©er le contenu HTML pour le PDF
    const reportHTML = generateSoilReportHTML(soil);

    // CrÃ©er un conteneur temporaire
    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = reportHTML;
    tempContainer.style.padding = '20px';
    tempContainer.style.backgroundColor = 'white';
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    document.body.appendChild(tempContainer);

    // GÃ©nÃ©rer le PDF avec html2canvas et jsPDF
    const canvas = await html2canvas(tempContainer);
    const imgData = canvas.toDataURL('image/png');

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgWidth = 210;
    const pageHeight = 295;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    // Nettoyer
    document.body.removeChild(tempContainer);

    // Sauvegarder
    const fileName = `soil_report_${soil.sampleCode || soil.id}_${new Date().toISOString().split('T')[0]}.pdf`;
    pdf.save(fileName);

    showToast('âœ… PDF report downloaded successfully', 'success');

  } catch (error) {
    console.error('Error generating PDF:', error);
    showToast('âŒ Error generating PDF report', 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Generate HTML for soil report PDF
 */
function generateSoilReportHTML(soil) {
  return `
    <div style="font-family: Arial, sans-serif; padding: 20px;">
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #2c3e50; margin-bottom: 10px;">Soil Analysis Report</h1>
        <p style="color: #7f8c8d;">Sample Code: ${soil.sampleCode || 'N/A'}</p>
        <p style="color: #7f8c8d;">Date: ${soil.measurementDate ? formatDate(soil.measurementDate) : 'N/A'}</p>
      </div>

      <div style="margin-bottom: 20px;">
        <h3 style="color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px;">Chemical Properties</h3>
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;"><strong>pH Level:</strong></td>
            <td style="padding: 8px; border: 1px solid #ddd;">${soil.phLevel ? parseFloat(soil.phLevel).toFixed(2) : 'N/A'} (${getPhLabel(soil.phLevel)})</td>
          </tr>
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Nitrogen (N):</strong></td>
            <td style="padding: 8px; border: 1px solid #ddd;">${soil.nitrogenLevel || 'N/A'}</td>
          </tr>
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Phosphorus (P):</strong></td>
            <td style="padding: 8px; border: 1px solid #ddd;">${soil.phosphorusLevel || 'N/A'}</td>
          </tr>
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Potassium (K):</strong></td>
            <td style="padding: 8px; border: 1px solid #ddd;">${soil.potassiumLevel || 'N/A'}</td>
          </tr>
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Organic Matter:</strong></td>
            <td style="padding: 8px; border: 1px solid #ddd;">${soil.organicMatter ? parseFloat(soil.organicMatter).toFixed(2) + '%' : 'N/A'}</td>
          </tr>
        </table>
      </div>

      <div style="margin-bottom: 20px;">
        <h3 style="color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px;">Physical Properties</h3>
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Moisture:</strong></td>
            <td style="padding: 8px; border: 1px solid #ddd;">${soil.moisture ? parseFloat(soil.moisture).toFixed(2) + '%' : 'N/A'}</td>
          </tr>
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Soil Texture:</strong></td>
            <td style="padding: 8px; border: 1px solid #ddd;">${soil.soilTexture || 'N/A'}</td>
          </tr>
          <tr>
            <td style="padding: 8px; border: 1px solid #ddd;"><strong>Depth:</strong></td>
            <td style="padding: 8px; border: 1px solid #ddd;">${soil.depthCm || 'N/A'} cm</td>
          </tr>
        </table>
      </div>

      ${soil.recommendations ? `
      <div style="margin-bottom: 20px;">
        <h3 style="color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px;">Recommendations</h3>
        <p style="padding: 15px; background-color: #ecf0f1; border-left: 4px solid #3498db;">${soil.recommendations}</p>
      </div>
      ` : ''}

      ${soil.laboratoryName ? `
      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
        <p style="color: #7f8c8d; font-size: 12px;">
          <strong>Laboratory:</strong> ${soil.laboratoryName}<br>
          ${soil.testingMethod ? `<strong>Testing Method:</strong> ${soil.testingMethod}` : ''}
        </p>
      </div>
      ` : ''}

      <div style="margin-top: 40px; text-align: center; color: #95a5a6; font-size: 11px;">
        <p>Generated on ${formatDateTime(new Date().toISOString())}</p>
        <p>Smart Agriculture Management System</p>
      </div>
    </div>
  `;
}

/**
 * Show soil testing info
 */
function showSoilTestingInfo() {
  const modalHTML = `
    <div class="modal-overlay show" id="infoModal" onclick="if(event.target === this) closeInfoModal()">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-info-circle"></i>
            About Soil Testing
          </h3>
          <button class="modal-close" onclick="closeInfoModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="info-content">
            <h4><i class="fas fa-question-circle"></i> Why Test Your Soil?</h4>
            <p>Regular soil testing is essential for:</p>
            <ul>
              <li>Understanding nutrient levels in your soil</li>
              <li>Optimizing fertilizer application</li>
              <li>Improving crop yields</li>
              <li>Preventing nutrient deficiencies</li>
              <li>Managing soil pH levels</li>
              <li>Making informed farming decisions</li>
            </ul>

            <h4 style="margin-top: 20px;"><i class="fas fa-calendar-check"></i> When to Test?</h4>
            <p>It's recommended to test your soil:</p>
            <ul>
              <li>Before the growing season (every 1-3 years)</li>
              <li>When starting a new farm or field</li>
              <li>If you notice poor crop performance</li>
              <li>After significant changes in management practices</li>
            </ul>

            <h4 style="margin-top: 20px;"><i class="fas fa-flask"></i> What Gets Tested?</h4>
            <p>A comprehensive soil test typically measures:</p>
            <ul>
              <li><strong>pH Level:</strong> Soil acidity/alkalinity</li>
              <li><strong>NPK:</strong> Nitrogen, Phosphorus, Potassium</li>
              <li><strong>Organic Matter:</strong> Soil health indicator</li>
              <li><strong>Micronutrients:</strong> Essential trace elements</li>
              <li><strong>Salinity:</strong> Salt content in soil</li>
            </ul>

            <h4 style="margin-top: 20px;"><i class="fas fa-phone"></i> How to Get Started?</h4>
            <p>Contact your local agricultural extension office or:</p>
            <ul>
              <li>Visit a certified soil testing laboratory</li>
              <li>Consult with an agricultural advisor</li>
              <li>Contact the Ministry of Agriculture</li>
            </ul>

            <div class="alert alert-info" style="margin-top: 20px;">
              <i class="fas fa-lightbulb"></i>
              <strong>Pro Tip:</strong> Keep records of all soil tests to track changes over time and make better management decisions.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="closeInfoModal()">
            <i class="fas fa-check"></i>
            Got It
          </button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close info modal
 */
function closeInfoModal() {
  const modal = document.getElementById('infoModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}

/**
 * Helper function to update element content safely
 */
function updateElement(elementId, content) {
    try {
        const element = document.getElementById(elementId);
        if (!element) {
            console.warn(`âš ï¸ Element not found: ${elementId}`);
            return;
        }

        if (typeof content === 'object' && content !== null) {
            element.innerHTML = content;
        } else {
            element.textContent = content;
        }
    } catch (error) {
        console.error(`âŒ Error updating element ${elementId}:`, error);
    }
}





/**
 * Format date amÃ©liorÃ©
 */
function formatDate(dateString) {
    if (!dateString) return 'N/A';

    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';

        return new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }).format(date);
    } catch (error) {
        return 'N/A';
    }
}

/**
 * Format datetime helper
 */
function formatDateTime(dateString) {
  if (!dateString) return 'N/A';

  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'N/A';

    return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }).format(date);
  } catch (error) {
    return 'N/A';
  }
}

// ============================================================================
// STYLES POUR LE MODULE SOIL DATA
// ============================================================================

/**
 * Ajouter ces styles CSS Ã  votre fichier principal
 */
const soilDataStyles = `
<style>
/* Soil Data Card Styles */
.soil-data-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border-radius: 20px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  padding: 0;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid rgba(34, 197, 94, 0.1);
  overflow: hidden;
  position: relative;
}

.soil-data-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  background: linear-gradient(90deg, var(--primary-green), var(--secondary-green), var(--accent-green));
  z-index: 1;
}

.soil-data-card:hover {
  box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
  transform: translateY(-8px) scale(1.02);
  border-color: rgba(34, 197, 94, 0.3);
}

.soil-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0;
  padding: 1.75rem 1.5rem;
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.06), rgba(16, 185, 129, 0.03));
  border-bottom: 2px solid rgba(34, 197, 94, 0.15);
  position: relative;
}

.soil-farm-name {
  margin: 0 0 0.5rem 0;
  font-size: 1.35rem;
  color: #1a1a1a;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  line-height: 1.3;
}

.soil-farm-name i {
  color: var(--primary-green);
  font-size: 1.25rem;
}

.soil-sample-code {
  display: inline-block;
  font-size: 0.8rem;
  color: #555;
  margin-top: 0.5rem;
  padding: 0.35rem 0.85rem;
  background: rgba(34, 197, 94, 0.12);
  border: 1px solid rgba(34, 197, 94, 0.2);
  border-radius: 10px;
  font-weight: 600;
}

.soil-date {
  font-size: 0.875rem;
  color: #555;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0.6rem 1.1rem;
  background: white;
  border: 1px solid rgba(34, 197, 94, 0.15);
  border-radius: 10px;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
}

.soil-date i {
  color: var(--primary-green);
  font-size: 0.9rem;
}

/* Soil Metrics Grid - Table Format */
.soil-metrics {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0;
  margin: 0;
  padding: 0;
  background: white;
  border: 1px solid rgba(34, 197, 94, 0.15);
  border-radius: 12px;
  overflow: hidden;
}

@media (max-width: 600px) {
  .soil-metrics {
    grid-template-columns: 1fr;
  }
}

.soil-metric {
  display: flex;
  align-items: center;
  padding: 1.25rem 1.5rem;
  background: #ffffff;
  border-right: 1px solid rgba(34, 197, 94, 0.1);
  border-bottom: 1px solid rgba(34, 197, 94, 0.1);
  transition: all 0.2s ease;
  position: relative;
}

.soil-metric:nth-child(even) {
  border-right: none;
}

.soil-metric:nth-last-child(-n+2) {
  border-bottom: none;
}

.soil-metric:hover {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.03), rgba(16, 185, 129, 0.02));
  transform: scale(1.02);
}

.soil-metric-primary {
  grid-column: span 2;
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(16, 185, 129, 0.04));
  border: none;
  border-bottom: 2px solid rgba(34, 197, 94, 0.2);
  padding: 2rem 1.5rem;
  border-radius: 0;
}

.soil-metric-primary::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary-green), var(--secondary-green));
}
  gap: 12px;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.soil-metric:hover {
  background: #e9ecef;
}

.soil-metric-primary {
  grid-column: 1 / -1;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
}

.metric-icon {
  width: 48px;
  height: 48px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  flex-shrink: 0;
  margin-right: 1.25rem;
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.12), rgba(16, 185, 129, 0.08));
  color: var(--primary-green);
  transition: all 0.2s ease;
}

.soil-metric:hover .metric-icon {
  transform: scale(1.05);
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.15));
}

.soil-metric-primary .metric-icon {
  width: 64px;
  height: 64px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
  color: var(--primary-green);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.metric-icon.good {
  background: linear-gradient(135deg, #d4edda, #c3e6cb);
  color: #155724;
}

.metric-icon.moderate {
  background: linear-gradient(135deg, #fff3cd, #ffeaa7);
  color: #856404;
}

.metric-icon.poor {
  background: linear-gradient(135deg, #f8d7da, #f5c6cb);
  color: #721c24;
}

.metric-content {
  flex: 1;
  min-width: 0;
}

.metric-label {
  display: block;
  font-size: 0.75rem;
  color: #666;
  margin-bottom: 0.5rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.soil-metric-primary .metric-label {
  color: #333;
  font-size: 0.85rem;
  margin-bottom: 0.75rem;
}

.metric-value {
  font-size: 1.3rem;
  font-weight: 700;
  color: #1a1a1a;
  line-height: 1.3;
}

.soil-metric-primary .metric-value {
  color: #1a1a1a;
}

.metric-value-large {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--primary-green);
  line-height: 1;
  margin: 0.5rem 0;
  text-shadow: none;
}

.metric-status {
  display: inline-block;
  padding: 0.35rem 0.9rem;
  border-radius: 16px;
  font-size: 0.7rem;
  font-weight: 700;
  margin-top: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
}

.metric-status.good {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.1));
  color: var(--primary-green);
  border: 1px solid rgba(34, 197, 94, 0.2);
}

.metric-status.moderate {
  background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 152, 0, 0.1));
  color: #f59e0b;
  border: 1px solid rgba(255, 193, 7, 0.2);
}

.metric-status.poor {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.2);
}

/* Recommendations Section */
.soil-recommendations,
.soil-notes {
  margin: 0;
  padding: 1.5rem;
  background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%);
  border-left: 5px solid #ffc107;
  border-radius: 0;
  box-shadow: inset 0 2px 10px rgba(255, 193, 7, 0.1);
}

.soil-recommendations h4,
.soil-notes h4 {
  margin: 0 0 0.75rem 0;
  color: #856404;
  font-size: 1rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.soil-recommendations h4 i,
.soil-notes h4 i {
  color: #ffc107;
  font-size: 1.2rem;
}

.soil-recommendations p,
.soil-notes p {
  margin: 0;
  color: #666;
  line-height: 1.6;
  font-size: 0.95rem;
}

.soil-recommendations h4,
.soil-notes h4 {
  margin: 0 0 10px 0;
  color: #f57c00;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 1rem;
}

.soil-recommendations p,
.soil-notes p {
  margin: 0;
  line-height: 1.6;
  color: #5d4037;
}

/* Soil Footer */
.soil-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 0;
  padding: 1.5rem;
  border-top: 2px solid rgba(34, 197, 94, 0.15);
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.03), rgba(16, 185, 129, 0.02));
  gap: 1.25rem;
  flex-wrap: wrap;
}

.soil-meta {
  display: flex;
  gap: 1.25rem;
  flex-wrap: wrap;
  flex: 1;
}

.soil-meta-item {
  font-size: 0.85rem;
  color: #666;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  background: white;
  border-radius: 8px;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease;
}

.soil-meta-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.soil-meta-item i {
  color: var(--primary-green);
  font-size: 0.9rem;
}

.soil-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

/* Report Modal Styles */
.soil-report {
  max-height: 70vh;
  overflow-y: auto;
  padding: 10px;
}

.report-section {
  margin-bottom: 25px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
}

.report-section h4 {
  margin: 0 0 15px 0;
  color: #2c3e50;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
  border-bottom: 2px solid #3498db;
  padding-bottom: 10px;
}

.report-section.recommendations {
  background: #e8f5e9;
  border-left: 4px solid #4caf50;
}

.recommendations-content,
.notes-content {
  padding: 10px;
  line-height: 1.8;
  color: #2c3e50;
}

.details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.detail-item {
  padding: 12px;
  background: white;
  border-radius: 6px;
  border: 1px solid #dee2e6;
}

.detail-item.highlight {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
}

.detail-item label {
  display: block;
  font-size: 0.875rem;
  color: #6c757d;
  margin-bottom: 5px;
  font-weight: 500;
}

.detail-item.highlight label {
  color: rgba(255, 255, 255, 0.9);
}

.detail-item value {
  display: block;
  font-size: 1.1rem;
  font-weight: 600;
  color: #2c3e50;
}

.detail-item.highlight value {
  color: white;
  font-size: 1.5rem;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #6c757d;
}

.empty-icon {
  font-size: 4rem;
  color: #dee2e6;
  margin-bottom: 20px;
}

.empty-state h3 {
  margin: 0 0 10px 0;
  color: #495057;
}

.empty-state p {
  margin: 10px 0;
  font-size: 1rem;
}

.empty-state-hint {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background: #e3f2fd;
  border-radius: 8px;
  color: #1976d2;
  font-size: 0.875rem;
  margin-top: 15px;
}

.empty-state-actions {
  margin-top: 25px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .soil-metrics {
    grid-template-columns: 1fr;
  }

  .soil-header {
    flex-direction: column;
    gap: 15px;
  }

  .soil-footer {
    flex-direction: column;
    align-items: flex-start;
  }

  .details-grid {
    grid-template-columns: 1fr;
  }
}

/* Info Modal Content Styles */
.info-content h4 {
  color: #2c3e50;
  margin-top: 20px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.info-content ul {
  padding-left: 20px;
  line-height: 1.8;
}

.info-content li {
  margin-bottom: 8px;
  color: #495057;
}

.alert {
  padding: 15px;
  border-radius: 8px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.alert-info {
  background: #e3f2fd;
  border-left: 4px solid #2196f3;
  color: #0d47a1;
}

.alert i {
  font-size: 1.2rem;
  flex-shrink: 0;
  margin-top: 2px;
}
</style>
`;

// Export pour utilisation
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    loadSoilData,
    viewSoilDetails,
    downloadSoilReport,
    showSoilTestingInfo
  };
}













// ============================================================================
// MARKET PRICES - VERSION COMPLÃˆTE ET CORRIGÃ‰E
// ============================================================================

/**
 * Initialize Market Prices Section
 * Appelez cette fonction au chargement de la page
 */
function initMarketPrices() {
    console.log('ðŸš€ Initializing Market Prices Section...');

    // Ajouter les styles CSS
    addMarketPricesStyles();

    // Initialiser les filtres
    initMarketPricesFilters();

    // Charger les donnÃ©es
    loadMarketPricesData();

    // Ajouter les event listeners pour les boutons
    setupMarketPricesEventListeners();

    console.log('âœ… Market Prices Section initialized');
}

/**
 * Setup Event Listeners
 */
function setupMarketPricesEventListeners() {
    // Bouton Refresh
    const refreshBtn = document.querySelector('[data-action="refresh-market-prices"]');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
            console.log('ðŸ”„ Refreshing market prices...');
            loadMarketPricesData();
        });
    }

    // Bouton Clear Filters
    const clearFiltersBtn = document.querySelector('[data-action="clear-market-prices-filters"]');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearMarketPricesFilters);
    }
}



async function loadMarketPricesData() {
    const container = document.getElementById('marketPricesGrid');

    try {
        console.log('ðŸ”„ Loading market prices...');

        // Afficher loading
        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading market prices...</p>
                </div>
            `;
        }

        const response = await apiRequest('/market-prices?page=0&size=20&sortBy=priceDate&sortDirection=desc');
        console.log('ðŸ“¦ API Response:', response);

        // Extraction des donnÃ©es
        let prices = [];
        if (Array.isArray(response)) {
            prices = response;
        } else if (response?.content && Array.isArray(response.content)) {
            prices = response.content;
        } else if (response?.data?.content && Array.isArray(response.data.content)) {
            prices = response.data.content;
        } else if (response?.data && Array.isArray(response.data)) {
            prices = response.data;
        }

        console.log(`âœ… Extracted ${prices.length} prices`);

        // Afficher les donnÃ©es
        displayMarketPricesGrid(prices);

    } catch (error) {
        console.error('âŒ Error loading market prices:', error);

        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                    <h3>Unable to Load Market Prices</h3>
                    <p>${error.message || 'An error occurred'}</p>
                    <button class="btn btn-primary" onclick="loadMarketPricesData()" style="margin-top: 15px;">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </div>
            `;
        }
    }
}





/**
 * Get trend color for badges
 */
function getTrendColor(trend) {
    const colors = {
        'INCREASING': '#d4edda',
        'DECREASING': '#f8d7da',
        'STABLE': '#fff3cd',
        'VOLATILE': '#d1ecf1'
    };
    return colors[trend] || '#e9ecef';
}

/**
 * Get demand color for badges
 */
function getDemandColor(demand) {
    const colors = {
        'HIGH': '#d4edda; color: #155724',
        'MEDIUM': '#fff3cd; color: #856404',
        'LOW': '#f8d7da; color: #721c24',
        'UNKNOWN': '#e9ecef; color: #6c757d'
    };
    return colors[demand] || '#e9ecef; color: #6c757d';
}

/**
 * Get trend icon
 */
function getTrendIcon(trend) {
    const icons = {
        'INCREASING': 'fa-arrow-up',
        'DECREASING': 'fa-arrow-down',
        'STABLE': 'fa-minus',
        'VOLATILE': 'fa-random'
    };
    return icons[trend] || 'fa-minus';
}


function displayMarketPricesGrid(prices) {
    const container = document.getElementById('marketPricesGrid');

    if (!container) {
        console.error('âŒ Container #marketPricesGrid not found!');
        return;
    }

    // VÃ©rification des donnÃ©es
    const pricesList = Array.isArray(prices) ? prices : [];
    console.log(`ðŸ“Š Displaying ${pricesList.length} prices`);

    if (pricesList.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-line" style="font-size: 4rem; color: #cbd5e1;"></i>
                <h3 style="margin-top: 20px;">No Market Prices Available</h3>
                <p style="color: #64748b;">There are currently no market price records to display.</p>
                <button class="btn btn-primary" onclick="loadMarketPricesData()" style="margin-top: 15px;">
                    <i class="fas fa-redo"></i> Reload
                </button>
            </div>
        `;
        return;
    }

    // GÃ©nÃ©rer les cartes
    const cards = pricesList.map(price => {
        if (!price || !price.id) return '';

        const cropName = price.cropName || `Crop ${price.cropId || 'Unknown'}`;
        const priceValue = price.pricePerKg ? `RWF ${price.pricePerKg.toLocaleString()}` : 'N/A';
        const marketName = price.marketName || 'Unknown Market';
        const location = price.location || 'N/A';
        const marketType = price.marketType || 'N/A';
        const demand = price.demandLevel || 'UNKNOWN';
        const trend = price.priceTrend || 'STABLE';
        const date = price.priceDate ? new Date(price.priceDate).toLocaleDateString() : 'N/A';

        return `
            <div class="market-price-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
                    <div>
                        <h3 class="crop-name" style="margin: 0 0 8px 0; font-size: 1.25rem; color: #1e293b;">${cropName}</h3>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${priceValue}/kg</div>
                    </div>
                    <div class="trend-badge trend-${trend.toLowerCase()}" style="padding: 6px 12px; border-radius: 20px; height: fit-content; font-size: 0.875rem; font-weight: 600;">
                        <i class="fas ${getTrendIcon(trend)}"></i> ${trend}
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                        <span style="color: #64748b;"><i class="fas fa-store"></i> Market:</span>
                        <span style="font-weight: 500;">${marketName}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                        <span style="color: #64748b;"><i class="fas fa-map-marker-alt"></i> Location:</span>
                        <span style="font-weight: 500;">${location}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                        <span style="color: #64748b;"><i class="fas fa-tag"></i> Type:</span>
                        <span class="market-type-badge" style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">${marketType}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                        <span style="color: #64748b;"><i class="fas fa-chart-bar"></i> Demand:</span>
                        <span class="demand-badge demand-${demand.toLowerCase()}" style="padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${demand}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <span style="color: #64748b;"><i class="fas fa-calendar"></i> Date:</span>
                        <span style="font-weight: 500;">${date}</span>
                    </div>
                </div>

                ${price.notes ? `
                <div style="padding: 12px; background: #f8fafc; border-radius: 6px; margin-bottom: 15px;">
                    <div style="font-weight: 600; color: #475569; margin-bottom: 5px; font-size: 0.875rem;">
                        <i class="fas fa-sticky-note"></i> Notes:
                    </div>
                    <p style="margin: 0; color: #64748b; font-size: 0.875rem;">${price.notes}</p>
                </div>
                ` : ''}

                <div style="display: flex; justify-content: flex-end; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                    <button class="btn btn-primary btn-sm" onclick="viewPriceDetails('${price.id}')" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-chart-bar"></i> Analyze
                    </button>
                </div>
            </div>
        `;
    }).filter(card => card !== '').join('');

    container.innerHTML = cards || `
        <div class="empty-state">
            <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #f59e0b;"></i>
            <p style="margin-top: 20px;">No valid data to display</p>
        </div>
    `;

    console.log('âœ… Market prices displayed successfully');
}






/**
 * Ajouter les styles CSS pour les market prices - NOUVELLE FONCTION
 */
function addMarketPricesStyles() {
    // VÃ©rifier si les styles sont dÃ©jÃ  ajoutÃ©s
    if (document.getElementById('market-prices-styles')) {
        return;
    }

    const styles = `
        <style id="market-prices-styles">
        /* Market Prices Grid Layout */
        .market-prices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        /* Market Price Card */
        .market-price-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: all 0.3s ease;
            border: 1px solid #e1e5e9;
        }

        .market-price-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Header */
        .price-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .price-main-info {
            flex: 1;
        }

        .crop-name {
            margin: 0 0 8px 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .price-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #27ae60;
        }

        /* Price Trend */
        .price-trend {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .trend-increasing {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .trend-decreasing {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .trend-stable {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .trend-volatile {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Price Details */
        .price-details {
            margin-bottom: 15px;
        }

        .price-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .price-detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6c757d;
            font-size: 0.875rem;
        }

        .detail-value {
            font-weight: 500;
            color: #2c3e50;
        }

        /* Badges */
        .market-type-badge {
            padding: 4px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .demand-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .demand-high {
            background: #d4edda;
            color: #155724;
        }

        .demand-medium {
            background: #fff3cd;
            color: #856404;
        }

        .demand-low {
            background: #f8d7da;
            color: #721c24;
        }

        .demand-unknown {
            background: #e9ecef;
            color: #6c757d;
        }

        /* Notes */
        .price-notes {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .notes-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.875rem;
        }

        .notes-content {
            margin: 0;
            color: #6c757d;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Footer */
        .price-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .price-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #6c757d;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-icon {
            font-size: 4rem;
            color: #dee2e6;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.5rem;
        }

        .empty-state p {
            margin: 10px 0;
            font-size: 1rem;
        }

        .empty-state-hint {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #e3f2fd;
            border-radius: 8px;
            color: #1976d2;
            font-size: 0.875rem;
            margin-top: 15px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .market-prices-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px 0;
            }

            .price-card-header {
                flex-direction: column;
                gap: 10px;
            }

            .price-card-footer {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .price-actions {
                align-self: stretch;
            }

            .price-actions .btn {
                width: 100%;
            }
        }

        /* Animation pour les nouvelles donnÃ©es */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .market-price-card {
            animation: fadeInUp 0.5s ease;
        }
        </style>
    `;

    document.head.insertAdjacentHTML('beforeend', styles);
}















/**
 * Get trend icon
 */
function getTrendIcon(trend) {
    const icons = {
        'INCREASING': 'fa-arrow-up',
        'DECREASING': 'fa-arrow-down',
        'STABLE': 'fa-minus',
        'VOLATILE': 'fa-random',
        'FLUCTUATING': 'fa-wave-square',
        'UPWARD': 'fa-arrow-up',
        'DOWNWARD': 'fa-arrow-down',
        'SIDEWAYS': 'fa-arrows-left-right'
    };
    return icons[trend] || 'fa-minus';
}




/**
 * View Price Details
 */
async function viewPriceDetails(priceId) {
    if (!priceId) {
        showToast('Invalid price ID', 'error');
        return;
    }

    try {
        showLoading();
        const price = await apiRequest(`/market-prices/${priceId}`);

        if (!price) {
            showToast('Price data not found', 'error');
            return;
        }

        showPriceDetailsModal(price);

    } catch (error) {
        console.error('Error loading price details:', error);
        showToast('Error loading price details', 'error');
    } finally {
        hideLoading();
    }
}






/**
 * Show price history modal
 */
function showPriceHistoryModal(history) {
    // Trier par date (plus rÃ©cent en premier)
    const sortedHistory = history.sort((a, b) =>
        new Date(b.priceDate) - new Date(a.priceDate)
    );

    const modalHTML = `
        <div class="modal-overlay show" id="priceHistoryModal">
            <div class="modal-container modal-large">
                <div class="modal-header">
                    <h3><i class="fas fa-history"></i> Price History</h3>
                    <button class="modal-close" onclick="closePriceHistoryModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="price-history-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Price (RWF/kg)</th>
                                    <th>Market</th>
                                    <th>Trend</th>
                                    <th>Demand</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedHistory.map(item => `
                                    <tr>
                                        <td>${formatDate(item.priceDate)}</td>
                                        <td><strong>${formatCurrency(item.pricePerKg)}</strong></td>
                                        <td>${item.marketName || 'N/A'}</td>
                                        <td>
                                            <span class="trend-badge trend-${(item.priceTrend || 'STABLE').toLowerCase()}">
                                                ${item.priceTrend || 'STABLE'}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="demand-badge demand-${(item.demandLevel || 'UNKNOWN').toLowerCase()}">
                                                ${item.demandLevel || 'UNKNOWN'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closePriceHistoryModal()">Close</button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close price history modal
 */
function closePriceHistoryModal() {
    const modal = document.getElementById('priceHistoryModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}


/**
 * Show Price Details Modal
 */
function showPriceDetailsModal(price) {
    if (!price) return;

    const cropName = price.cropName || `Crop ${price.cropId || 'Unknown'}`;
    const pricePerKg = price.pricePerKg ? formatCurrency(price.pricePerKg) : 'N/A';
    const marketName = price.marketName || 'Unknown Market';
    const location = price.location || 'N/A';
    const marketType = price.marketType || 'N/A';
    const demandLevel = price.demandLevel || 'UNKNOWN';
    const supplyLevel = price.supplyLevel || 'UNKNOWN';
    const priceTrend = price.priceTrend || 'STABLE';
    const priceDate = price.priceDate ? formatDateTime(price.priceDate) : 'N/A';

    const modalHTML = `
        <div class="modal-overlay show" id="priceModal" onclick="if(event.target === this) closePriceModal()">
            <div class="modal-container modal-large">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-chart-line"></i>
                        Market Price Analysis - ${cropName}
                    </h3>
                    <button class="modal-close" onclick="closePriceModal()" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="price-analysis-details">
                        <div class="detail-section">
                            <h4><i class="fas fa-info-circle"></i> Price Information</h4>
                            <div class="details-grid">
                                <div class="detail-item highlight">
                                    <label>Current Price:</label>
                                    <value class="price-value-large">${pricePerKg}</value>
                                </div>
                                <div class="detail-item">
                                    <label>Market:</label>
                                    <value>${marketName}</value>
                                </div>
                                <div class="detail-item">
                                    <label>Location:</label>
                                    <value>${location}</value>
                                </div>
                                <div class="detail-item">
                                    <label>Market Type:</label>
                                    <value>${marketType}</value>
                                </div>
                                <div class="detail-item">
                                    <label>Date:</label>
                                    <value>${priceDate}</value>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4><i class="fas fa-chart-bar"></i> Market Conditions</h4>
                            <div class="details-grid">
                                <div class="detail-item">
                                    <label>Price Trend:</label>
                                    <value>
                                        <span class="trend-badge trend-${priceTrend.toLowerCase()}">
                                            <i class="fas ${getTrendIcon(priceTrend)}"></i>
                                            ${priceTrend}
                                        </span>
                                    </value>
                                </div>
                                <div class="detail-item">
                                    <label>Demand Level:</label>
                                    <value>
                                        <span class="demand-badge demand-${demandLevel.toLowerCase()}">
                                            ${demandLevel}
                                        </span>
                                    </value>
                                </div>
                                <div class="detail-item">
                                    <label>Supply Level:</label>
                                    <value>
                                        <span class="supply-badge supply-${supplyLevel.toLowerCase()}">
                                            ${supplyLevel}
                                        </span>
                                    </value>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section recommendations">
                            <h4><i class="fas fa-lightbulb"></i> Trading Recommendations</h4>
                            <div class="recommendations-content">
                                ${generatePriceRecommendations(price)}
                            </div>
                        </div>

                        ${price.notes ? `
                        <div class="detail-section">
                            <h4><i class="fas fa-sticky-note"></i> Additional Information</h4>
                            <div class="notes-content">
                                <p>${price.notes}</p>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closePriceModal()">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close Price Modal
 */
function closePriceModal() {
    const modal = document.getElementById('priceModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}

/**
 * Generate Price Recommendations
 */
function generatePriceRecommendations(price) {
    const recommendations = [];

    if (price.priceTrend === 'INCREASING') {
        recommendations.push('ðŸ“ˆ <strong>Good time to sell</strong> - Prices are trending upward');
    } else if (price.priceTrend === 'DECREASING') {
        recommendations.push('ðŸ“‰ <strong>Consider holding</strong> - Prices are trending downward');
    } else if (price.priceTrend === 'STABLE') {
        recommendations.push('âš–ï¸ <strong>Market is stable</strong> - Monitor for changes');
    }

    if (price.demandLevel === 'HIGH') {
        recommendations.push('ðŸ”¥ <strong>High demand</strong> - Favorable market conditions');
    } else if (price.demandLevel === 'LOW') {
        recommendations.push('ðŸ’¤ <strong>Low demand</strong> - Consider alternative markets');
    }

    if (price.supplyLevel === 'LOW') {
        recommendations.push('ðŸ“¦ <strong>Low supply</strong> - Potential for price increases');
    } else if (price.supplyLevel === 'HIGH') {
        recommendations.push('ðŸ“Š <strong>High supply</strong> - Prices may decrease');
    }

    if (recommendations.length === 0) {
        recommendations.push('â„¹ï¸ <strong>Monitor market</strong> - No specific recommendations available');
    }

    return recommendations.map(rec => `<p>${rec}</p>`).join('');
}


/**
 * Close price modal
 */
function closePriceModal() {
    const modal = document.getElementById('priceModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}






/**
 * View price history
 */
async function viewPriceHistory(cropId) {
    if (!cropId) {
        showToast('âŒ Crop ID not available', 'error');
        return;
    }

    try {
        showLoading();

        // RÃ©cupÃ©rer l'historique des prix pour ce crop
        const history = await apiRequest(`/market-prices/crop/${cropId}/history`);

        if (history && history.length > 0) {
            showPriceHistoryModal(history);
        } else {
            showToast('â„¹ï¸ No price history available for this crop', 'info');
        }

    } catch (error) {
        console.error('Error loading price history:', error);
        showToast('âŒ Error loading price history', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Initialize Market Prices Filters
 */
function initMarketPricesFilters() {
    const searchInput = document.getElementById('marketPricesSearchInput');
    const typeFilter = document.getElementById('marketPricesTypeFilter');
    const trendFilter = document.getElementById('marketPricesTrendFilter');

    if (searchInput) {
        searchInput.addEventListener('input', debounce(() => {
            filterMarketPrices();
        }, 300));
    }

    if (typeFilter) {
        typeFilter.addEventListener('change', filterMarketPrices);
    }

    if (trendFilter) {
        trendFilter.addEventListener('change', filterMarketPrices);
    }
}




/**
 * Filter Market Prices
 */
function filterMarketPrices() {
    const searchTerm = document.getElementById('marketPricesSearchInput')?.value.toLowerCase() || '';
    const typeFilter = document.getElementById('marketPricesTypeFilter')?.value || '';
    const trendFilter = document.getElementById('marketPricesTrendFilter')?.value || '';

    const priceCards = document.querySelectorAll('.market-price-card');

    let visibleCount = 0;

    priceCards.forEach(card => {
        const cropName = card.querySelector('.crop-name')?.textContent.toLowerCase() || '';
        const marketType = card.querySelector('.market-type-badge')?.textContent || '';
        const priceTrend = card.querySelector('.price-trend span')?.textContent.trim() || '';

        const matchesSearch = cropName.includes(searchTerm);
        const matchesType = !typeFilter || marketType === typeFilter;
        const matchesTrend = !trendFilter || priceTrend === trendFilter;

        if (matchesSearch && matchesType && matchesTrend) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });

    console.log(`ðŸ“Š Showing ${visibleCount} of ${priceCards.length} prices`);
}



/**
 * Clear Market Prices Filters
 */
function clearMarketPricesFilters() {
    document.getElementById('marketPricesSearchInput').value = '';
    document.getElementById('marketPricesTypeFilter').value = '';
    document.getElementById('marketPricesTrendFilter').value = '';

    const priceCards = document.querySelectorAll('.market-price-card');
    priceCards.forEach(card => {
        card.style.display = 'block';
    });

    showToast('Filters cleared', 'info');
}



/**
 * Debounce function for search input
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}







async function loadTransactionsData() {
  try {
    showLoading();

    // âœ… VALIDATION UTILISATEUR
    if (!currentUser || !currentUser.id) {
      console.error('âŒ No current user found');
      displayEmptyTransactions();
      return;
    }

    if (DEBUG_MODE) {
      console.log('ðŸ”„ Loading transactions for farmer user ID:', currentUser.id);
    }

    // âœ… RÃ‰CUPÃ‰RATION DES TRANSACTIONS
    let transactions = [];
    try {
      const response = await apiRequest(`/transactions/farmer/${currentUser.id}`);

      // âœ… CORRECTION: GÃ©rer les diffÃ©rents formats de rÃ©ponse
      if (response) {
        if (Array.isArray(response)) {
          transactions = response;
        } else if (response.data && Array.isArray(response.data)) {
          transactions = response.data;
        } else if (response.content && Array.isArray(response.content)) {
          transactions = response.content;
        } else if (response.data && response.data.content && Array.isArray(response.data.content)) {
          transactions = response.data.content;
        }
      }

      console.log(`âœ… Total transactions loaded: ${transactions.length}`);
      console.log('ðŸ“¦ Transactions data:', transactions);

    } catch (error) {
      console.warn('âš ï¸ Transactions load error:', error.message);
      transactions = [];
    }

    // âœ… VALIDATION MINIMALE (au lieu de stricte)
    const validTransactions = transactions.filter(tx => {
      // On vÃ©rifie juste que c'est un objet avec un ID
      return tx && typeof tx === 'object' && tx.id;
    });

    console.log(`âœ… Valid transactions: ${validTransactions.length}`);

    // âœ… ENRICHIR LES TRANSACTIONS AVEC BUYER ET CROP NAMES
    const enrichedTransactions = await Promise.all(validTransactions.map(async (tx) => {
      try {
        // Enrichir avec buyer name
        if (tx.buyerId && !tx.buyerName) {
          try {
            const buyerResponse = await apiRequest(`/users/${tx.buyerId}`);
            const buyer = buyerResponse.data || buyerResponse;
            tx.buyerName = buyer.fullName || buyer.username || buyer.email || 'Unknown Buyer';
          } catch (error) {
            console.warn(`Error fetching buyer ${tx.buyerId}:`, error);
            tx.buyerName = 'Unknown Buyer';
          }
        }

        // Enrichir avec crop name
        if (tx.cropId && !tx.cropName) {
          try {
            const cropResponse = await apiRequest(`/v1/crops/${tx.cropId}`);
            const crop = cropResponse.data || cropResponse;
            tx.cropName = crop.cropName || crop.name || 'Unknown Crop';
          } catch (error) {
            console.warn(`Error fetching crop ${tx.cropId}:`, error);
            tx.cropName = 'Unknown Crop';
          }
        }
      } catch (error) {
        console.warn('Error enriching transaction:', error);
      }
      return tx;
    }));

    // Update statistics
    const totalCount = enrichedTransactions.length;
    const completed = enrichedTransactions.filter(t =>
      (t.status === 'PAID' || t.status === 'COMPLETED') || 
      (t.transactionStatus === 'PAID' || t.transactionStatus === 'COMPLETED')
    ).length;

    const totalAmount = enrichedTransactions.reduce((sum, t) => {
      const amount = parseFloat(t.totalAmount || 0);
      return sum + (isNaN(amount) ? 0 : amount);
    }, 0);

    const netAmount = enrichedTransactions.reduce((sum, t) => {
      const amount = parseFloat(t.netAmountFarmer || t.netAmount || 0);
      return sum + (isNaN(amount) ? 0 : amount);
    }, 0);

    // âœ… MISE Ã€ JOUR UI
    updateElement('txTotalCount', totalCount);
    updateElement('txCompleted', completed);
    updateElement('txTotalAmount', formatCurrency(totalAmount));
    updateElement('txNetAmount', formatCurrency(netAmount));

    // âœ… AFFICHAGE DU TABLEAU
    displayTransactionsTable(enrichedTransactions);

  } catch (error) {
    console.error('âŒ Error loading transactions:', error);
    showToast('Unable to load transactions data', 'warning');
    displayEmptyTransactions();
  } finally {
    hideLoading();
  }
}






/**
 * Afficher un Ã©tat vide pour les transactions
 */
function displayEmptyTransactions() {
  // RÃ©initialiser les statistiques
  updateElement('txTotalCount', 0);
  updateElement('txCompleted', 0);
  updateElement('txTotalAmount', formatCurrency(0));
  updateElement('txNetAmount', formatCurrency(0));

  // Afficher l'Ã©tat vide dans le tableau
  const tbody = document.getElementById('transactionsTableBody');
  if (tbody) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="empty-state">
          <div class="empty-icon">
            <i class="fas fa-exchange-alt"></i>
          </div>
          <p>No transactions available</p>
          <p class="empty-state-hint">
            Your transaction history will appear here once you start selling your produce
          </p>
        </td>
      </tr>
    `;
  }
}





function displayTransactionsTable(transactions) {
  const tbody = document.getElementById('transactionsTableBody');
  if (!tbody) {
    console.error('âŒ transactionsTableBody not found');
    return;
  }

  if (!transactions || transactions.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="empty-state" style="padding: 3rem 2rem; text-align: center;">
          <div style="font-size: 4rem; color: #ddd; margin-bottom: 1rem; opacity: 0.5;">
            <i class="fas fa-exchange-alt"></i>
          </div>
          <p style="font-size: 1.1rem; color: #666; margin-bottom: 0.5rem;">No transactions yet</p>
          <p style="font-size: 0.9rem; color: #999;">Your transaction history will appear here once you start selling your produce</p>
        </td>
      </tr>
    `;
    return;
  }

  console.log(`ðŸ“Š Displaying ${transactions.length} transactions`);

  tbody.innerHTML = transactions.map((tx, index) => {
    // âœ… VALIDATION MINIMALE
    if (!tx || !tx.id) {
      console.warn(`âš ï¸ Invalid transaction at index ${index}:`, tx);
      return '';
    }

    // âœ… VALEURS PAR DÃ‰FAUT SÃ‰CURISÃ‰ES
    const transactionCode = tx.transactionCode || tx.id || 'N/A';
    const transactionDate = tx.transactionDate ? formatDate(tx.transactionDate) : (tx.createdAt ? formatDate(tx.createdAt) : 'N/A');
    const buyerName = tx.buyerName || tx.buyer?.fullName || tx.buyer?.username || 'Unknown Buyer';
    const cropName = tx.cropName || tx.crop?.cropName || tx.crop?.name || 'N/A';
    const quantity = tx.quantity || 0;
    const unit = tx.unit || 'KG';
    const totalAmount = tx.totalAmount ? parseFloat(tx.totalAmount) : 0;
    const netAmount = tx.netAmountFarmer || tx.netAmount || 0;
    const status = tx.status || tx.transactionStatus || 'PENDING';
    const statusLower = status.toLowerCase();
    const transactionId = tx.id;

    // Status badge colors
    const statusColors = {
      'pending': 'background: rgba(255, 193, 7, 0.15); color: #f59e0b; border: 1px solid rgba(255, 193, 7, 0.3);',
      'confirmed': 'background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3);',
      'delivered': 'background: rgba(139, 92, 246, 0.15); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.3);',
      'paid': 'background: rgba(34, 197, 94, 0.15); color: var(--primary-green); border: 1px solid rgba(34, 197, 94, 0.3);',
      'completed': 'background: rgba(34, 197, 94, 0.15); color: var(--primary-green); border: 1px solid rgba(34, 197, 94, 0.3);',
      'cancelled': 'background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);',
      'disputed': 'background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);'
    };
    const statusStyle = statusColors[statusLower] || statusColors['pending'];

    return `
      <tr style="transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#f8f9fa';" onmouseout="this.style.backgroundColor='transparent';">
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
          <strong style="color: #333; font-family: 'Courier New', monospace; font-size: 0.9rem;">${escapeHtml(transactionCode)}</strong>
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef; color: #666;">
          <i class="fas fa-calendar-alt" style="color: var(--primary-green); margin-right: 0.5rem;"></i>
          ${transactionDate}
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-user" style="color: #3b82f6;"></i>
            <span style="font-weight: 600; color: #333;">${escapeHtml(buyerName)}</span>
          </div>
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-seedling" style="color: var(--primary-green);"></i>
            <span style="font-weight: 600; color: #333;">${escapeHtml(cropName)}</span>
          </div>
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef; font-weight: 700; color: #333;">
          ${quantity} ${unit}
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef; font-weight: 700; color: #333;">
          ${formatCurrency(totalAmount)}
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef; font-weight: 700; color: var(--primary-green);">
          ${formatCurrency(netAmount)}
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
          <span style="padding: 0.4rem 0.9rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; ${statusStyle}">
            ${status}
          </span>
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button class="btn-icon" onclick="viewTransactionDetails('${transactionId}')" title="View Details" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#3b82f6'; this.style.color='white';" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'; this.style.color='#3b82f6';">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn-icon" onclick="downloadTransactionPDF('${transactionId}')" title="Download PDF" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green); padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-green)'; this.style.color='white';" onmouseout="this.style.background='rgba(34, 197, 94, 0.1)'; this.style.color='var(--primary-green)';">
              <i class="fas fa-file-pdf"></i>
            </button>
            ${status === 'PENDING' || status === 'CONFIRMED' ? `
            <button class="btn-icon" onclick="updateTransactionStatus('${transactionId}', 'CONFIRMED')" title="Confirm" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green); padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-green)'; this.style.color='white';" onmouseout="this.style.background='rgba(34, 197, 94, 0.1)'; this.style.color='var(--primary-green)';">
              <i class="fas fa-check"></i>
            </button>
            ` : ''}
          </div>
        </td>
      </tr>
    `;
  }).filter(html => html !== '').join('');

  console.log(`âœ… Table displayed with ${transactions.length} rows`);
}







/**
 * View transaction details - VERSION SÃ‰CURISÃ‰E
 */
async function viewTransactionDetails(transactionId) {
  if (!transactionId) {
    showToast('âŒ Invalid transaction ID', 'error');
    return;
  }

  try {
    showLoading();

    const transaction = await apiRequest(`/transactions/${transactionId}`);

    if (!transaction) {
      showToast('âŒ Transaction not found', 'error');
      return;
    }

    showTransactionDetailsModal(transaction);

  } catch (error) {
    console.error('Error loading transaction details:', error);
    showToast('âŒ Error loading transaction details', 'error');
  } finally {
    hideLoading();
  }
}


/**
 * Show transaction details modal - VERSION SÃ‰CURISÃ‰E
 */
function showTransactionDetailsModal(tx) {
  if (!tx) return;

  // âœ… Validation et valeurs par dÃ©faut
  const transactionCode = tx.transactionCode || 'N/A';
  const transactionDate = tx.transactionDate ? formatDateTime(tx.transactionDate) : 'N/A';
  const buyerName = tx.buyerName || 'Unknown Buyer';
  const cropName = tx.cropName || 'N/A';
  const quantity = tx.quantity || 0;
  const unit = tx.unit || 'KG';
  const pricePerUnit = tx.pricePerUnit ? formatCurrency(tx.pricePerUnit) : formatCurrency(0);
  const totalAmount = tx.totalAmount ? formatCurrency(tx.totalAmount) : formatCurrency(0);
  const transactionFee = tx.transactionFee ? formatCurrency(tx.transactionFee) : formatCurrency(0);
  const netAmount = tx.netAmount ? formatCurrency(tx.netAmount) : formatCurrency(0);
  const paymentMethod = tx.paymentMethod || 'N/A';
  const transactionStatus = tx.transactionStatus || 'UNKNOWN';
  const statusLower = transactionStatus.toLowerCase();
  const deliveryAddress = tx.deliveryAddress || null;
  const notes = tx.notes || null;

  const modalHTML = `
    <div class="modal-overlay show" id="transactionModal" onclick="if(event.target === this) closeTransactionModal()">
      <div class="modal-container modal-large">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-receipt"></i>
            Transaction Details
          </h3>
          <button class="modal-close" onclick="closeTransactionModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="details-grid">
            <div class="detail-item">
              <label>Transaction Code</label>
              <value><strong>${transactionCode}</strong></value>
            </div>
            <div class="detail-item">
              <label>Date</label>
              <value>${transactionDate}</value>
            </div>
            <div class="detail-item">
              <label>Buyer</label>
              <value>${buyerName}</value>
            </div>
            <div class="detail-item">
              <label>Crop</label>
              <value>${cropName}</value>
            </div>
            <div class="detail-item">
              <label>Quantity</label>
              <value>${quantity} ${unit}</value>
            </div>
            <div class="detail-item">
              <label>Price per Unit</label>
              <value>${pricePerUnit}</value>
            </div>
            <div class="detail-item">
              <label>Total Amount</label>
              <value>${totalAmount}</value>
            </div>
            <div class="detail-item">
              <label>Transaction Fee</label>
              <value>${transactionFee}</value>
            </div>
            <div class="detail-item">
              <label>Net Amount</label>
              <value class="text-success"><strong>${netAmount}</strong></value>
            </div>
            <div class="detail-item">
              <label>Payment Method</label>
              <value>${paymentMethod}</value>
            </div>
            <div class="detail-item">
              <label>Status</label>
              <value><span class="status-badge status-${statusLower}">${transactionStatus}</span></value>
            </div>
            ${deliveryAddress ? `
            <div class="detail-item full-width">
              <label>Delivery Address</label>
              <value>${deliveryAddress}</value>
            </div>
            ` : ''}
            ${notes ? `
            <div class="detail-item full-width">
              <label>Notes</label>
              <value>${notes}</value>
            </div>
            ` : ''}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeTransactionModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
          ${transactionStatus === 'PENDING' ? `
            <button type="button" class="btn btn-primary" onclick="updateTransactionStatus('${tx.id}', 'CONFIRMED')">
              <i class="fas fa-check"></i>
              Confirm Transaction
            </button>
          ` : ''}
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;
}



/**
 * Close transaction modal
 */
function closeTransactionModal() {
  const modal = document.getElementById('transactionModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}

/**
 * Download transaction as PDF with logo
 */
async function downloadTransactionPDF(transactionId) {
  if (!transactionId) {
    showToast('âŒ Invalid transaction ID', 'error');
    return;
  }

  try {
    showLoading();
    showToast('Generating PDF report...', 'info');

    // Fetch transaction details
    const tx = await apiRequest(`/transactions/${transactionId}`);
    
    if (!tx) {
      showToast('âŒ Transaction not found', 'error');
      hideLoading();
      return;
    }

    // Enrich with buyer and crop names if not present
    if (tx.buyerId && !tx.buyerName) {
      try {
        const buyerResponse = await apiRequest(`/users/${tx.buyerId}`);
        const buyer = buyerResponse.data || buyerResponse;
        tx.buyerName = buyer.fullName || buyer.username || buyer.email || 'Unknown Buyer';
      } catch (error) {
        console.warn('Error fetching buyer:', error);
        tx.buyerName = 'Unknown Buyer';
      }
    }

    if (tx.cropId && !tx.cropName) {
      try {
        const cropResponse = await apiRequest(`/v1/crops/${tx.cropId}`);
        const crop = cropResponse.data || cropResponse;
        tx.cropName = crop.cropName || crop.name || 'Unknown Crop';
      } catch (error) {
        console.warn('Error fetching crop:', error);
        tx.cropName = 'Unknown Crop';
      }
    }

    // Get farmer name
    const farmerName = currentUser?.fullName || currentUser?.username || 'Farmer';

    // Create PDF content HTML
    const pdfHTML = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <style>
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 40px;
            background: #fff;
            color: #333;
          }
          .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #22c55e;
          }
          .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
          }
          .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
          }
          .logo-text {
            display: flex;
            flex-direction: column;
          }
          .logo-text h1 {
            font-size: 24px;
            color: #22c55e;
            font-weight: 700;
            margin: 0;
          }
          .logo-text p {
            font-size: 12px;
            color: #666;
            margin: 0;
          }
          .invoice-info {
            text-align: right;
          }
          .invoice-info h2 {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 700;
          }
          .invoice-info p {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
          }
          .content {
            margin: 40px 0;
          }
          .section {
            margin-bottom: 30px;
          }
          .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #22c55e;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
          }
          .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
          }
          .info-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
          }
          .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
          }
          .info-value {
            font-size: 16px;
            color: #333;
            font-weight: 700;
          }
          .table-section {
            margin-top: 30px;
          }
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
          }
          th {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }
          td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
          }
          .total-row {
            background: #f8f9fa;
            font-weight: 700;
          }
          .total-row td {
            padding: 20px 15px;
            font-size: 16px;
            color: #22c55e;
          }
          .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
            text-align: center;
            color: #666;
            font-size: 12px;
          }
          .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
          }
          .status-pending { background: #fff3cd; color: #856404; }
          .status-confirmed { background: #cfe2ff; color: #084298; }
          .status-delivered { background: #e2d9f3; color: #5a32a3; }
          .status-paid { background: #d1e7dd; color: #0f5132; }
          .status-completed { background: #d1e7dd; color: #0f5132; }
          .status-cancelled { background: #f8d7da; color: #842029; }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="logo-section">
            <div class="logo">AG</div>
            <div class="logo-text">
              <h1>AgriGuard AI</h1>
              <p>SMART FARMING SYSTEM</p>
            </div>
          </div>
          <div class="invoice-info">
            <h2>TRANSACTION RECEIPT</h2>
            <p><strong>Code:</strong> ${tx.transactionCode || tx.id}</p>
            <p><strong>Date:</strong> ${tx.transactionDate ? formatDate(tx.transactionDate) : 'N/A'}</p>
            <p><strong>Status:</strong> <span class="status-badge status-${(tx.status || tx.transactionStatus || 'PENDING').toLowerCase()}">${tx.status || tx.transactionStatus || 'PENDING'}</span></p>
          </div>
        </div>

        <div class="content">
          <div class="section">
            <h3 class="section-title">Transaction Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Transaction Code</span>
                <span class="info-value">${tx.transactionCode || tx.id}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Transaction Date</span>
                <span class="info-value">${tx.transactionDate ? formatDate(tx.transactionDate) : 'N/A'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Buyer</span>
                <span class="info-value">${tx.buyerName || 'Unknown Buyer'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Farmer</span>
                <span class="info-value">${farmerName}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Crop</span>
                <span class="info-value">${tx.cropName || 'N/A'}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Payment Method</span>
                <span class="info-value">${tx.paymentMethod || 'N/A'}</span>
              </div>
            </div>
          </div>

          <div class="section">
            <h3 class="section-title">Transaction Details</h3>
            <div class="table-section">
              <table>
                <thead>
                  <tr>
                    <th>Description</th>
                    <th style="text-align: right;">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <strong>Quantity:</strong> ${tx.quantity || 0} ${tx.unit || 'KG'}<br>
                      <strong>Price per Unit:</strong> ${tx.pricePerUnit ? formatCurrency(tx.pricePerUnit) : formatCurrency(0)}
                    </td>
                    <td style="text-align: right;">${tx.totalAmount ? formatCurrency(tx.totalAmount) : formatCurrency(0)}</td>
                  </tr>
                  ${tx.transactionFee ? `
                  <tr>
                    <td><strong>Transaction Fee</strong></td>
                    <td style="text-align: right;">- ${formatCurrency(tx.transactionFee)}</td>
                  </tr>
                  ` : ''}
                  ${tx.brokerCommission ? `
                  <tr>
                    <td><strong>Broker Commission</strong></td>
                    <td style="text-align: right;">- ${formatCurrency(tx.brokerCommission)}</td>
                  </tr>
                  ` : ''}
                  ${tx.governmentTax ? `
                  <tr>
                    <td><strong>Government Tax</strong></td>
                    <td style="text-align: right;">- ${formatCurrency(tx.governmentTax)}</td>
                  </tr>
                  ` : ''}
                  <tr class="total-row">
                    <td><strong>NET AMOUNT (Farmer Receives)</strong></td>
                    <td style="text-align: right; font-size: 20px;">${formatCurrency(tx.netAmountFarmer || tx.netAmount || 0)}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          ${tx.notes ? `
          <div class="section">
            <h3 class="section-title">Notes</h3>
            <p style="color: #666; line-height: 1.6;">${tx.notes}</p>
          </div>
          ` : ''}
        </div>

        <div class="footer">
          <p><strong>AgriGuard AI - Smart Farming System</strong></p>
          <p>This is an official transaction receipt generated by the system.</p>
          <p>Generated on: ${new Date().toLocaleString()}</p>
        </div>
      </body>
      </html>
    `;

    // Create a temporary container for the PDF content
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = pdfHTML;
    tempDiv.style.position = 'absolute';
    tempDiv.style.left = '-9999px';
    document.body.appendChild(tempDiv);

    // Generate PDF using html2canvas and jsPDF
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    await html2canvas(tempDiv, {
      scale: 2,
      useCORS: true,
      logging: false,
      backgroundColor: '#ffffff'
    }).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 210; // A4 width in mm
      const pageHeight = 297; // A4 height in mm
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      let heightLeft = imgHeight;
      let position = 0;

      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft >= 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      // Save the PDF
      const fileName = `Transaction_${tx.transactionCode || tx.id}_${new Date().toISOString().split('T')[0]}.pdf`;
      pdf.save(fileName);
    });

    // Clean up
    document.body.removeChild(tempDiv);

    showToast('âœ… PDF generated successfully!', 'success');
    hideLoading();

  } catch (error) {
    console.error('Error generating PDF:', error);
    showToast('âŒ Error generating PDF: ' + error.message, 'error');
    hideLoading();
  }
}

/**
 * Update transaction status - VERSION SÃ‰CURISÃ‰E
 */
async function updateTransactionStatus(transactionId, newStatus) {
  if (!transactionId) {
    showToast('âŒ Invalid transaction ID', 'error');
    return;
  }

  if (!confirm(`Are you sure you want to change the status to ${newStatus}?`)) {
    return;
  }

  try {
    showLoading();

    await apiRequest(`/transactions/${transactionId}/status`, {
      method: 'PUT',
      body: JSON.stringify({ status: newStatus })
    });

    showToast('âœ… Transaction status updated successfully', 'success');
    closeTransactionModal();
    await loadTransactionsData();

  } catch (error) {
    console.error('Error updating transaction status:', error);
    showToast('âŒ Error updating transaction status: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}


// ============================================================================
// SUPPLY CHAIN MODULE - VERSION CORRIGÃ‰E COMPLÃˆTE
// ============================================================================

/**
 * Load supply chain data - VERSION ULTRA-ROBUSTE
 */
async function loadSupplyChainData() {
    try {
        showLoading();

        // âœ… VALIDATION UTILISATEUR
        if (!currentUser || !currentUser.id) {
            console.error('âŒ No current user found');
            displayEmptySupplyChainState();
            return;
        }

        console.log('ðŸ”„ Loading supply chain data for farmer:', currentUser.id);

        // âœ… MÃ‰THODE 1: RÃ©cupÃ©rer directement par farmerId (endpoint principal)
        let allSupplyChains = [];
        try {
            console.log('ðŸ”„ Trying endpoint: /supply-chain/farmer/' + currentUser.id);
            const farmerResponse = await apiRequest(`/supply-chain/farmer/${currentUser.id}`);
            
            // Gestion multi-format de la rÃ©ponse
            if (Array.isArray(farmerResponse)) {
                allSupplyChains = farmerResponse;
            } else if (farmerResponse && farmerResponse.content && Array.isArray(farmerResponse.content)) {
                allSupplyChains = farmerResponse.content;
            } else if (farmerResponse && farmerResponse.data && Array.isArray(farmerResponse.data)) {
                allSupplyChains = farmerResponse.data;
            }
            
            console.log(`âœ… Loaded ${allSupplyChains.length} supply chain records from farmer endpoint`);
        } catch (error) {
            console.warn('âš ï¸ Error loading from farmer endpoint, trying alternative method:', error.message);
            allSupplyChains = [];
        }

        // âœ… MÃ‰THODE 2: Si aucune donnÃ©e, rÃ©cupÃ©rer par crop productions
        if (allSupplyChains.length === 0) {
            console.log('ðŸ”„ Trying alternative method: loading via crop productions');
            
            try {
                // RÃ©cupÃ©rer toutes les crop productions du farmer
                const productionsResponse = await apiRequest(`/v1/crop-productions/farmer/${currentUser.id}`);
                let productions = [];
                
                if (productionsResponse && productionsResponse.data && Array.isArray(productionsResponse.data)) {
                    productions = productionsResponse.data;
                } else if (Array.isArray(productionsResponse)) {
                    productions = productionsResponse;
                }
                
                console.log(`âœ… Found ${productions.length} crop productions`);
                
                // Pour chaque production, rÃ©cupÃ©rer les supply chains
                for (const production of productions) {
                    if (!production.id) continue;
                    
                    try {
                        const scResponse = await apiRequest(`/supply-chain/crop-production/${production.id}`);
                        let productionSupplyChains = [];
                        
                        if (Array.isArray(scResponse)) {
                            productionSupplyChains = scResponse;
                        } else if (scResponse && scResponse.content && Array.isArray(scResponse.content)) {
                            productionSupplyChains = scResponse.content;
                        } else if (scResponse && scResponse.data && Array.isArray(scResponse.data)) {
                            productionSupplyChains = scResponse.data;
                        }
                        
                        // Enrichir avec les informations de production
                        productionSupplyChains = productionSupplyChains.map(stage => ({
                            ...stage,
                            cropProductionId: production.id,
                            productionName: production.cropName || production.name || 'Unknown Production',
                            farmId: production.farmId || 'Unknown'
                        }));
                        
                        allSupplyChains = allSupplyChains.concat(productionSupplyChains);
                        console.log(`âœ… Loaded ${productionSupplyChains.length} supply chain records for production ${production.id}`);
                    } catch (error) {
                        console.warn(`âš ï¸ Error loading supply chain for production ${production.id}:`, error.message);
                    }
                }
            } catch (error) {
                console.warn('âš ï¸ Error loading crop productions:', error.message);
            }
        }

        // âœ… MÃ‰THODE 3: Si toujours aucune donnÃ©e, essayer par farms
        if (allSupplyChains.length === 0) {
            console.log('ðŸ”„ Trying method 3: loading via farms');
            
            try {
                const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
                const farms = Array.isArray(farmsResponse) ? farmsResponse : [];
                
                console.log(`âœ… Found ${farms.length} farms`);
                
                for (const farm of farms) {
                    if (!farm.id) continue;
                    
                    try {
                        const farmScResponse = await apiRequest(`/supply-chain/farm/${farm.id}`);
                        let farmSupplyChains = [];
                        
                        if (Array.isArray(farmScResponse)) {
                            farmSupplyChains = farmScResponse;
                        } else if (farmScResponse && farmScResponse.content && Array.isArray(farmScResponse.content)) {
                            farmSupplyChains = farmScResponse.content;
                        } else if (farmScResponse && farmScResponse.data && Array.isArray(farmScResponse.data)) {
                            farmSupplyChains = farmScResponse.data;
                        }
                        
                        // Enrichir avec le nom de la ferme
                        farmSupplyChains = farmSupplyChains.map(stage => ({
                            ...stage,
                            farmName: farm.farmName || 'Unknown Farm',
                            farmId: farm.id
                        }));
                        
                        allSupplyChains = allSupplyChains.concat(farmSupplyChains);
                        console.log(`âœ… Loaded ${farmSupplyChains.length} supply chain records for farm ${farm.id}`);
                    } catch (error) {
                        console.warn(`âš ï¸ Error loading supply chain for farm ${farm.id}:`, error.message);
                    }
                }
            } catch (error) {
                console.warn('âš ï¸ Error loading farms:', error.message);
            }
        }

        console.log(`âœ… Total supply chain records loaded: ${allSupplyChains.length}`);

        // âœ… ENRICHIR LES DONNÃ‰ES AVEC INFORMATIONS DE PRODUCTION ET FARM
        if (allSupplyChains.length > 0) {
            // CrÃ©er un map des productions pour enrichir
            const productionsMap = new Map();
            try {
                const productionsResponse = await apiRequest(`/v1/crop-productions/farmer/${currentUser.id}`);
                let productions = [];
                
                if (productionsResponse && productionsResponse.data && Array.isArray(productionsResponse.data)) {
                    productions = productionsResponse.data;
                } else if (Array.isArray(productionsResponse)) {
                    productions = productionsResponse;
                }
                
                productions.forEach(prod => {
                    if (prod.id) {
                        productionsMap.set(prod.id, prod);
                    }
                });
            } catch (error) {
                console.warn('âš ï¸ Error loading productions for enrichment:', error.message);
            }
            
            // CrÃ©er un map des farms pour enrichir
            const farmsMap = new Map();
            try {
                const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
                const farms = Array.isArray(farmsResponse) ? farmsResponse : [];
                
                farms.forEach(farm => {
                    if (farm.id) {
                        farmsMap.set(farm.id, farm);
                    }
                });
            } catch (error) {
                console.warn('âš ï¸ Error loading farms for enrichment:', error.message);
            }
            
            // Enrichir chaque supply chain
            allSupplyChains = allSupplyChains.map(stage => {
                const enriched = { ...stage };
                
                // Enrichir avec production info
                if (stage.cropProductionId && productionsMap.has(stage.cropProductionId)) {
                    const prod = productionsMap.get(stage.cropProductionId);
                    enriched.productionName = prod.cropName || prod.name || 'Unknown Production';
                    enriched.farmId = prod.farmId || enriched.farmId;
                }
                
                // Enrichir avec farm info
                if (enriched.farmId && farmsMap.has(enriched.farmId)) {
                    const farm = farmsMap.get(enriched.farmId);
                    enriched.farmName = farm.farmName || 'Unknown Farm';
                }
                
                return enriched;
            });
        }

        // âœ… AFFICHAGE DES DONNÃ‰ES
        if (allSupplyChains.length === 0) {
            displayEmptySupplyChainState();
        } else {
            displaySupplyChainData(allSupplyChains, []);
        }

        // âœ… MISE Ã€ JOUR DES STATISTIQUES
        updateSupplyChainStatistics(allSupplyChains);

    } catch (error) {
        console.error('âŒ Error loading supply chain:', error);
        showToast('Unable to load supply chain data', 'warning');
        displayEmptySupplyChainState();
    } finally {
        hideLoading();
    }
}

/**
 * Display supply chain data - VERSION COMPLÃˆTE
 */
function displaySupplyChainData(supplyChains, farms) {
    const container = document.getElementById('supplyChainContainer');
    if (!container) {
        console.error('âŒ supplyChainContainer not found');
        return;
    }

    // âœ… VALIDATION DES DONNÃ‰ES
    if (!supplyChains || supplyChains.length === 0) {
        displayEmptySupplyChainState();
        return;
    }

    console.log(`ðŸ“Š Displaying ${supplyChains.length} supply chain records`);

    // âœ… GROUPER PAR PRODUCTION
    const groupedByProduction = {};
    supplyChains.forEach(stage => {
        const key = stage.cropProductionId || 'unknown';
        if (!groupedByProduction[key]) {
            groupedByProduction[key] = {
                productionId: key,
                farmName: stage.farmName || 'Unknown Farm',
                stages: []
            };
        }
        groupedByProduction[key].stages.push(stage);
    });

    // âœ… TRIER LES STAGES PAR ORDRE
    Object.values(groupedByProduction).forEach(production => {
        production.stages.sort((a, b) =>
            (a.stageOrder || 0) - (b.stageOrder || 0)
        );
    });

    // âœ… GÃ‰NÃ‰RER LE HTML
    let html = '';

    Object.values(groupedByProduction).forEach(production => {
        const completedStages = production.stages.filter(s => s.stageEndDate).length;
        const totalStages = production.stages.length;
        const progressPercent = totalStages > 0 ? (completedStages / totalStages) * 100 : 0;

        html += `
            <div class="supply-chain-group">
                <div class="supply-chain-group-header">
                    <div class="supply-chain-group-info">
                        <h3>
                            <i class="fas fa-seedling"></i>
                            ${production.farmName}
                        </h3>
                        <p class="supply-chain-production-id">Production: ${production.productionId}</p>
                    </div>
                    <div class="supply-chain-group-progress">
                        <div class="progress-info">
                            <span>${completedStages}/${totalStages} stages completed</span>
                            <span class="progress-percent">${progressPercent.toFixed(0)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                </div>

                <div class="supply-chain-timeline">
                    ${production.stages.map((stage, index) => {
                        const isCompleted = stage.stageEndDate ? true : false;
                        const isActive = !isCompleted && index === completedStages;
                        const stageName = stage.stage || 'UNKNOWN';
                        const stageIcon = getStageIcon(stageName);

                        return `
                        <div class="timeline-stage ${isCompleted ? 'completed' : isActive ? 'active' : 'pending'}">
                            <div class="timeline-connector ${index === 0 ? 'first' : ''} ${index === production.stages.length - 1 ? 'last' : ''}"></div>

                            <div class="timeline-marker">
                                <i class="fas ${stageIcon}"></i>
                                ${isCompleted ? '<i class="fas fa-check stage-check"></i>' : ''}
                            </div>

                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <h4 class="stage-name">${stageName}</h4>
                                    <span class="stage-badge ${isCompleted ? 'badge-success' : isActive ? 'badge-warning' : 'badge-secondary'}">
                                        ${isCompleted ? 'Completed' : isActive ? 'In Progress' : 'Pending'}
                                    </span>
                                </div>

                                <div class="timeline-details">
                                    ${stage.location ? `
                                        <div class="detail-row">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span><strong>Location:</strong> ${stage.location}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.facilityName ? `
                                        <div class="detail-row">
                                            <i class="fas fa-building"></i>
                                            <span><strong>Facility:</strong> ${stage.facilityName}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.responsibleParty ? `
                                        <div class="detail-row">
                                            <i class="fas fa-user"></i>
                                            <span><strong>Handler:</strong> ${stage.responsibleParty}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.quantityIn ? `
                                        <div class="detail-row">
                                            <i class="fas fa-box"></i>
                                            <span><strong>Quantity In:</strong> ${stage.quantityIn} ${stage.unit || 'KG'}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.quantityOut ? `
                                        <div class="detail-row">
                                            <i class="fas fa-shipping-fast"></i>
                                            <span><strong>Quantity Out:</strong> ${stage.quantityOut} ${stage.unit || 'KG'}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.qualityStatus ? `
                                        <div class="detail-row">
                                            <i class="fas fa-star"></i>
                                            <span><strong>Quality:</strong> ${stage.qualityStatus}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.stageStartDate ? `
                                        <div class="detail-row">
                                            <i class="fas fa-calendar-plus"></i>
                                            <span><strong>Started:</strong> ${formatDateTime(stage.stageStartDate)}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.stageEndDate ? `
                                        <div class="detail-row success">
                                            <i class="fas fa-calendar-check"></i>
                                            <span><strong>Completed:</strong> ${formatDateTime(stage.stageEndDate)}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.lossQuantity && parseFloat(stage.lossQuantity) > 0 ? `
                                        <div class="detail-row alert">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span><strong>Loss:</strong> ${stage.lossQuantity} ${stage.unit || 'KG'}
                                                ${stage.lossPercentage ? `(${stage.lossPercentage}%)` : ''}
                                            </span>
                                        </div>
                                        ${stage.lossReason ? `
                                            <div class="detail-row">
                                                <i class="fas fa-info-circle"></i>
                                                <span><strong>Loss Reason:</strong> ${stage.lossReason}</span>
                                            </div>
                                        ` : ''}
                                    ` : ''}

                                    ${stage.trackingCode ? `
                                        <div class="detail-row">
                                            <i class="fas fa-barcode"></i>
                                            <span><strong>Tracking Code:</strong> ${stage.trackingCode}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.notes ? `
                                        <div class="detail-row">
                                            <i class="fas fa-sticky-note"></i>
                                            <span><strong>Notes:</strong> ${stage.notes}</span>
                                        </div>
                                    ` : ''}
                                </div>

                                <div class="timeline-actions">
                                    <button class="btn-icon" onclick="viewSupplyChainDetails('${stage.id}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${isActive ? `
                                        <button class="btn-icon btn-primary" onclick="editSupplyChainStage('${stage.id}')" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-icon btn-success" onclick="completeStage('${stage.id}')" title="Complete">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('')}
                </div>
            </div>
        `;
    });

    container.innerHTML = html || `
        <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Unable to display supply chain data</p>
        </div>
    `;

    console.log('âœ… Supply chain data displayed successfully');
}





/**
 * Display empty supply chain state - VERSION CORRIGÃ‰E
 */
function displayEmptySupplyChainState() {
    const container = document.getElementById('supplyChainContainer');
    if (!container) return;

    container.innerHTML = `
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-link"></i>
            </div>
            <h3>No Supply Chain Data Available</h3>
            <p>Start tracking your product journey from harvest to market.</p>
            <div class="empty-state-hint">
                <i class="fas fa-info-circle"></i>
                Create your first supply chain stage to begin tracking
            </div>
            <div class="empty-state-actions" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="openAddSupplyChainModal()">
                    <i class="fas fa-plus"></i>
                    Start Tracking Supply Chain
                </button>
                <button class="btn btn-secondary" onclick="showSupplyChainTutorial()">
                    <i class="fas fa-play-circle"></i>
                    Watch Tutorial
                </button>
            </div>
        </div>
    `;

    // RÃ©initialiser les statistiques
    updateSupplyChainStatistics([]);
}


/**
 * Open modal to add new supply chain stage - FONCTION COMPLÃˆTE
 */
async function openAddSupplyChainModal() {
    try {
        showLoading();

        // RÃ©cupÃ©rer les fermes de l'utilisateur
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

        if (farms.length === 0) {
            showToast('âŒ You need to create a farm first before tracking supply chain', 'error');
            hideLoading();
            return;
        }

        // RÃ©cupÃ©rer les productions disponibles
        let productions = [];
        try {
            const productionsResponse = await apiRequest(`/v1/crop-productions/farmer/${currentUser.id}`);

            // Gestion multi-format de la rÃ©ponse
            if (Array.isArray(productionsResponse)) {
                productions = productionsResponse;
            } else if (productionsResponse && productionsResponse.data) {
                productions = Array.isArray(productionsResponse.data) ? productionsResponse.data : [];
            } else if (productionsResponse && productionsResponse.content) {
                productions = Array.isArray(productionsResponse.content) ? productionsResponse.content : [];
            }

            // Filtrer les productions valides
            productions = productions.filter(p => p && p.id && p.cropName);

        } catch (error) {
            console.warn('âš ï¸ Error loading productions:', error.message);
            productions = [];
        }

        const modalHTML = `
            <div class="modal-overlay show" id="supplyChainModal" onclick="if(event.target === this) closeSupplyChainModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-plus-circle"></i>
                            Start Supply Chain Tracking
                        </h3>
                        <button class="modal-close" onclick="closeSupplyChainModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form id="addSupplyChainForm" onsubmit="handleAddSupplyChain(event)">
                        <div class="modal-body">
                            <div class="form-grid">
                                <!-- Farm Selection -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-tractor"></i>
                                        Select Farm *
                                    </label>
                                    <select name="farmId" class="form-select" required>
                                        <option value="">-- Select Farm --</option>
                                        ${farms.map(farm =>
                                            `<option value="${farm.id}">${farm.farmName}</option>`
                                        ).join('')}
                                    </select>
                                </div>

                                <!-- Crop Production Selection -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-seedling"></i>
                                        Select Crop Production *
                                    </label>
                                    ${productions.length === 0 ? `
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            No crop productions available. Please create a crop production first.
                                        </div>
                                    ` : ''}
                                    <select name="cropProductionId" class="form-select" ${productions.length === 0 ? 'disabled' : 'required'}>
                                        <option value="">-- Select Production --</option>
                                        ${productions.map(prod =>
                                            `<option value="${prod.id}">
                                                ${prod.cropName} - ${prod.season || ''} ${prod.year || ''}
                                            </option>`
                                        ).join('')}
                                    </select>
                                </div>

                                <!-- Stage Information -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-layer-group"></i>
                                        Supply Chain Stage *
                                    </label>
                                    <select name="stage" class="form-select" required>
                                        <option value="">-- Select Stage --</option>
                                        <option value="HARVEST">ðŸŒ¾ Harvest</option>
                                        <option value="COLLECTION">ðŸ“¦ Collection</option>
                                        <option value="STORAGE">ðŸª Storage</option>
                                        <option value="PROCESSING">ðŸ­ Processing</option>
                                        <option value="PACKAGING">ðŸ“¦ Packaging</option>
                                        <option value="TRANSPORT">ðŸšš Transport</option>
                                        <option value="DISTRIBUTION">ðŸš› Distribution</option>
                                        <option value="RETAIL">ðŸª Retail</option>
                                        <option value="QUALITY_CHECK">âœ… Quality Check</option>
                                    </select>
                                </div>

                                <!-- Stage Order -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-sort-numeric-down"></i>
                                        Stage Order *
                                    </label>
                                    <input type="number" name="stageOrder" class="form-input"
                                           min="1" max="10" value="1" required>
                                    <small class="form-hint">The sequence order of this stage (1 = first stage)</small>
                                </div>

                                <!-- Location -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Location *
                                    </label>
                                    <input type="text" name="location" class="form-input"
                                           placeholder="e.g., Farm Warehouse, Processing Facility" required>
                                </div>

                                <!-- Facility Name -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-building"></i>
                                        Facility Name
                                    </label>
                                    <input type="text" name="facilityName" class="form-input"
                                           placeholder="e.g., Main Storage Facility">
                                </div>

                                <!-- Responsible Party -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-user-tie"></i>
                                        Responsible Party *
                                    </label>
                                    <input type="text" name="responsibleParty" class="form-input"
                                           placeholder="e.g., John Doe, Logistics Team" required>
                                </div>

                                <!-- Quantity Information -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-balance-scale"></i>
                                        Quantity In (KG) *
                                    </label>
                                    <input type="number" name="quantityIn" class="form-input"
                                           step="0.01" min="0.01" placeholder="e.g., 1000.50" required>
                                </div>

                                <!-- Unit -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-ruler"></i>
                                        Unit *
                                    </label>
                                    <select name="unit" class="form-select" required>
                                        <option value="KG">Kilograms (KG)</option>
                                        <option value="TONNES">Tonnes</option>
                                        <option value="BAGS">Bags</option>
                                        <option value="CRATES">Crates</option>
                                    </select>
                                </div>

                                <!-- Tracking Code -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-barcode"></i>
                                        Tracking Code
                                    </label>
                                    <input type="text" name="trackingCode" class="form-input"
                                           placeholder="Auto-generated if empty">
                                    <small class="form-hint">Leave empty for auto-generation</small>
                                </div>

                                <!-- Stage Start Date -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-calendar-plus"></i>
                                        Stage Start Date *
                                    </label>
                                    <input type="datetime-local" name="stageStartDate" class="form-input"
                                           value="${new Date().toISOString().slice(0, 16)}" required>
                                </div>

                                <!-- Expected Duration -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-clock"></i>
                                        Expected Duration (days)
                                    </label>
                                    <input type="number" name="expectedDurationDays" class="form-input"
                                           min="1" max="365" placeholder="e.g., 7">
                                </div>

                                <!-- Quality Status -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-star"></i>
                                        Initial Quality Status
                                    </label>
                                    <select name="qualityStatus" class="form-select">
                                        <option value="EXCELLENT">â­ Excellent</option>
                                        <option value="GOOD">ðŸ‘ Good</option>
                                        <option value="FAIR">ðŸ‘Œ Fair</option>
                                        <option value="POOR">ðŸ‘Ž Poor</option>
                                        <option value="REJECTED">âŒ Rejected</option>
                                    </select>
                                </div>

                                <!-- Notes -->
                                <div class="form-group full-width">
                                    <label class="form-label">
                                        <i class="fas fa-sticky-note"></i>
                                        Additional Notes
                                    </label>
                                    <textarea name="notes" class="form-input" rows="3"
                                              placeholder="Any additional information about this stage..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeSupplyChainModal()">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" ${productions.length === 0 ? 'disabled' : ''}>
                                <i class="fas fa-save"></i>
                                Start Tracking
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

    } catch (error) {
        console.error('Error opening supply chain modal:', error);
        showToast('âŒ Error loading form: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Handle add supply chain form submission
 */
async function handleAddSupplyChain(event) {
    event.preventDefault();

    try {
        showLoading();

        const formData = new FormData(event.target);

        // PrÃ©parer les donnÃ©es
        const supplyChainData = {
            farmId: formData.get('farmId'),
            cropProductionId: formData.get('cropProductionId'),
            stage: formData.get('stage'),
            stageOrder: parseInt(formData.get('stageOrder')),
            location: formData.get('location'),
            facilityName: formData.get('facilityName') || null,
            responsibleParty: formData.get('responsibleParty'),
            quantityIn: parseFloat(formData.get('quantityIn')),
            unit: formData.get('unit'),
            trackingCode: formData.get('trackingCode')?.trim() || null,
            stageStartDate: formData.get('stageStartDate') + ':00', // Ajouter les secondes
            expectedDurationDays: formData.get('expectedDurationDays') ?
                parseInt(formData.get('expectedDurationDays')) : null,
            qualityStatus: formData.get('qualityStatus') || 'GOOD',
            notes: formData.get('notes')?.trim() || null
        };

        console.log('ðŸ“¤ Creating supply chain stage:', supplyChainData);

        // Validation supplÃ©mentaire
        if (!supplyChainData.cropProductionId) {
            showToast('âŒ Please select a crop production', 'error');
            return;
        }

        if (supplyChainData.quantityIn <= 0) {
            showToast('âŒ Quantity must be greater than 0', 'error');
            return;
        }

        // Appel API pour crÃ©er la supply chain
        const response = await apiRequest('/supply-chain', {
            method: 'POST',
            body: JSON.stringify(supplyChainData)
        });

        console.log('âœ… Supply chain created:', response);

        showToast('âœ… Supply chain tracking started successfully!', 'success');
        closeSupplyChainModal();

        // Recharger les donnÃ©es
        setTimeout(async () => {
            await loadSupplyChainData();
        }, 500);

    } catch (error) {
        console.error('âŒ Error creating supply chain:', error);

        let errorMessage = 'Error creating supply chain stage';
        if (error.message.includes('400')) {
            errorMessage = 'Invalid data. Please check all required fields.';
        } else if (error.message.includes('500')) {
            errorMessage = 'Server error. Please try again.';
        } else {
            errorMessage = error.message || errorMessage;
        }

        showToast(`âŒ ${errorMessage}`, 'error');
    } finally {
        hideLoading();
    }
}


/**
 * Show supply chain tutorial
 */
function showSupplyChainTutorial() {
    const modalHTML = `
        <div class="modal-overlay show" id="tutorialModal" onclick="if(event.target === this) closeTutorialModal()">
            <div class="modal-container">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-graduation-cap"></i>
                        Supply Chain Tracking Tutorial
                    </h3>
                    <button class="modal-close" onclick="closeTutorialModal()" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="tutorial-content">
                        <h4>ðŸ“‹ How to Track Your Supply Chain</h4>

                        <div class="tutorial-step">
                            <h5>Step 1: Create Crop Production</h5>
                            <p>First, you need to create a crop production record in the "Production" section.</p>
                        </div>

                        <div class="tutorial-step">
                            <h5>Step 2: Start Supply Chain Tracking</h5>
                            <p>Click "Start Tracking Supply Chain" and select your farm and crop production.</p>
                        </div>

                        <div class="tutorial-step">
                            <h5>Step 3: Choose the Stage</h5>
                            <p>Select the current stage of your product (Harvest, Storage, Transport, etc.)</p>
                        </div>

                        <div class="tutorial-step">
                            <h5>Step 4: Enter Details</h5>
                            <p>Provide location, quantity, responsible party, and other important information.</p>
                        </div>

                        <div class="tutorial-step">
                            <h5>Step 5: Track Progress</h5>
                            <p>As your product moves through the supply chain, update each stage with completion details.</p>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-lightbulb"></i>
                            <strong>Tip:</strong> You can track multiple stages for the same production to see the complete journey from farm to market.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="closeTutorialModal(); openAddSupplyChainModal()">
                        <i class="fas fa-play"></i>
                        Start Tracking Now
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeTutorialModal()">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close tutorial modal
 */
function closeTutorialModal() {
    const modal = document.getElementById('tutorialModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}




/**
 * Update supply chain statistics
 */
function updateSupplyChainStatistics(supplyChains) {
    const statsContainer = document.getElementById('supplyChainStats');
    if (!statsContainer) return;

    const totalStages = supplyChains.length;
    const completedStages = supplyChains.filter(s => s.stageEndDate).length;
    const activeStages = supplyChains.filter(s =>
        !s.stageEndDate && s.stageStartDate
    ).length;
    const pendingStages = totalStages - completedStages - activeStages;

    const totalLoss = supplyChains.reduce((sum, s) =>
        sum + (parseFloat(s.lossQuantity) || 0), 0
    );

    const avgLossPercentage = supplyChains.length > 0
        ? (supplyChains.reduce((sum, s) =>
            sum + (parseFloat(s.lossPercentage) || 0), 0) / supplyChains.length).toFixed(2)
        : 0;

    const statsHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="fas fa-link"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Total Stages</span>
                    <span class="stat-value">${totalStages}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Completed</span>
                    <span class="stat-value">${completedStages}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon warning">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Active</span>
                    <span class="stat-value">${activeStages}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon secondary">
                    <i class="fas fa-hourglass-half"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Pending</span>
                    <span class="stat-value">${pendingStages}</span>
                </div>
            </div>

            ${totalLoss > 0 ? `
            <div class="stat-card">
                <div class="stat-icon danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Total Loss</span>
                    <span class="stat-value">${totalLoss.toFixed(2)} KG</span>
                    <small>${avgLossPercentage}% avg</small>
                </div>
            </div>
            ` : ''}
        </div>
    `;

    statsContainer.innerHTML = statsHTML;
}

/**
 * Get stage icon
 */
function getStageIcon(stage) {
    const icons = {
        'HARVEST': 'fa-seedling',
        'COLLECTION': 'fa-hand-holding',
        'STORAGE': 'fa-warehouse',
        'PROCESSING': 'fa-industry',
        'PACKAGING': 'fa-box',
        'TRANSPORT': 'fa-truck',
        'DISTRIBUTION': 'fa-shipping-fast',
        'RETAIL': 'fa-store',
        'QUALITY_CHECK': 'fa-clipboard-check',
        'LOADING': 'fa-dolly',
        'UNLOADING': 'fa-box-open'
    };
    return icons[stage] || 'fa-circle';
}

// ============================================================================
// WEATHER DATA MODULE - COMPLETE IMPLEMENTATION
// ============================================================================

/**
 * Load weather data for all farmer's farms
 */
async function loadWeatherData() {
    try {
        showLoading();
        console.log('ðŸŒ¤ï¸ Starting weather data load...');

        if (!currentUser || !currentUser.id) {
            console.error('âŒ No current user found');
            displayEmptyWeatherState('No user session found. Please login again.');
            hideLoading();
            return;
        }

        console.log('ðŸŒ¤ï¸ Loading weather data for farmer:', currentUser.id);

        // âœ… STEP 1: Try to get recent weather data first (most reliable)
        let allWeatherData = [];
        try {
            console.log('ðŸ”„ Fetching recent weather data...');
            const recentResponse = await apiRequest(`/weather-data/recent?days=30`);
            
            if (Array.isArray(recentResponse)) {
                allWeatherData = recentResponse;
                console.log(`âœ… Loaded ${allWeatherData.length} recent weather records`);
            } else if (recentResponse && recentResponse.data && Array.isArray(recentResponse.data)) {
                allWeatherData = recentResponse.data;
                console.log(`âœ… Loaded ${allWeatherData.length} recent weather records (from data field)`);
            } else if (recentResponse && recentResponse.content && Array.isArray(recentResponse.content)) {
                allWeatherData = recentResponse.content;
                console.log(`âœ… Loaded ${allWeatherData.length} recent weather records (from content field)`);
            } else {
                console.warn('âš ï¸ Unexpected response format:', recentResponse);
            }
        } catch (error) {
            console.error('âŒ Error loading recent weather data:', error);
            console.error('Error details:', error.message, error.stack);
        }

        // âœ… STEP 2: Get all farms for the farmer
        let farms = [];
        try {
            console.log('ðŸ”„ Fetching farms...');
            const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
            farms = Array.isArray(farmsResponse) ? farmsResponse : [];
            console.log(`âœ… Loaded ${farms.length} farms`);
        } catch (error) {
            console.warn('âš ï¸ Error loading farms:', error.message);
            farms = [];
        }

        // âœ… STEP 3: If we have farms with coordinates, try to get location-specific data
        const weatherDataByFarm = [];
        
        if (farms.length > 0 && allWeatherData.length === 0) {
            console.log('ðŸ”„ Trying to get location-specific weather data...');
            
            for (const farm of farms) {
                if (!farm.latitude || !farm.longitude) {
                    console.warn(`âš ï¸ Farm ${farm.id} missing coordinates`);
                    continue;
                }

                try {
                    // Try location/radius endpoint
                    const weatherResponse = await apiRequest(
                        `/weather-data/location/radius?latitude=${farm.latitude}&longitude=${farm.longitude}&radius=1.0`
                    );

                    let locationWeather = [];
                    if (Array.isArray(weatherResponse)) {
                        locationWeather = weatherResponse;
                    } else if (weatherResponse && weatherResponse.data && Array.isArray(weatherResponse.data)) {
                        locationWeather = weatherResponse.data;
                    }

                    if (locationWeather.length > 0) {
                        const latestWeather = locationWeather.sort((a, b) => 
                            new Date(b.recordDate || b.createdAt || 0) - new Date(a.recordDate || a.createdAt || 0)
                        )[0];

                        weatherDataByFarm.push({
                            farm: farm,
                            latestWeather: latestWeather,
                            allWeather: locationWeather
                        });

                        allWeatherData.push(...locationWeather);
                        console.log(`âœ… Found ${locationWeather.length} weather records for farm ${farm.farmName || farm.id}`);
                    }
                } catch (error) {
                    console.warn(`âš ï¸ Error loading weather for farm ${farm.id}:`, error.message);
                }
            }
        }

        // âœ… STEP 4: If we have general weather data but no farm-specific data, assign to farms
        if (allWeatherData.length > 0 && weatherDataByFarm.length === 0 && farms.length > 0) {
            console.log('ðŸ”„ Assigning general weather data to farms...');
            
            // Sort weather data by date (most recent first)
            const sortedWeather = allWeatherData.sort((a, b) => 
                new Date(b.recordDate || b.createdAt || 0) - new Date(a.recordDate || a.createdAt || 0)
            );

            // Assign the most recent weather to each farm
            farms.forEach(farm => {
                if (sortedWeather.length > 0) {
                    weatherDataByFarm.push({
                        farm: farm,
                        latestWeather: sortedWeather[0],
                        allWeather: sortedWeather.slice(0, 7) // Last 7 records
                    });
                }
            });
        }

        console.log(`âœ… Total weather records: ${allWeatherData.length}`);
        console.log(`âœ… Weather data for farms: ${weatherDataByFarm.length}`);

        // âœ… STEP 5: Display weather data
        if (weatherDataByFarm.length === 0 && allWeatherData.length === 0) {
            console.warn('âš ï¸ No weather data available');
            displayEmptyWeatherState('No weather data found in the database. Weather data will appear here once available.');
        } else if (weatherDataByFarm.length === 0 && allWeatherData.length > 0) {
            // We have data but no farms, show general weather
            displayGeneralWeatherData(allWeatherData);
        } else {
            displayWeatherData(weatherDataByFarm, allWeatherData);
        }

        // âœ… STEP 6: Update statistics
        updateWeatherStatistics(allWeatherData);

        // âœ… STEP 7: Load and display charts
        if (allWeatherData.length > 0) {
            displayWeatherCharts(allWeatherData);
        }

        // âœ… STEP 8: Analyze and display risks
        analyzeWeatherRisks(allWeatherData, farms);

        // âœ… STEP 9: Display agricultural impact
        displayAgriculturalImpact(allWeatherData, farms);

        if (allWeatherData.length > 0) {
            showToast(`âœ… Loaded ${allWeatherData.length} weather records`, 'success');
        }

    } catch (error) {
        console.error('âŒ Error loading weather data:', error);
        console.error('Error stack:', error.stack);
        showToast('Unable to load weather data: ' + error.message, 'error');
        displayEmptyWeatherState('Error loading weather data. Please check your connection and try again.');
    } finally {
        hideLoading();
    }
}

/**
 * Display general weather data when no farms are available
 */
function displayGeneralWeatherData(allWeatherData) {
    const container = document.getElementById('weatherFarmsGrid');
    if (!container) {
        console.error('âŒ weatherFarmsGrid not found');
        return;
    }

    if (!allWeatherData || allWeatherData.length === 0) {
        displayEmptyWeatherState();
        return;
    }

    // Get the most recent weather data
    const latestWeather = allWeatherData.sort((a, b) => 
        new Date(b.recordDate || b.createdAt || 0) - new Date(a.recordDate || a.createdAt || 0)
    )[0];

    const temp = latestWeather.temperature ? parseFloat(latestWeather.temperature).toFixed(1) : '--';
    const humidity = latestWeather.humidity ? parseFloat(latestWeather.humidity).toFixed(1) : '--';
    const rainfall = latestWeather.rainfall ? parseFloat(latestWeather.rainfall).toFixed(2) : '--';
    const windSpeed = latestWeather.windSpeed ? parseFloat(latestWeather.windSpeed).toFixed(1) : '--';
    const pressure = latestWeather.atmosphericPressure ? parseFloat(latestWeather.atmosphericPressure).toFixed(0) : '--';
    const uvIndex = latestWeather.uvIndex || '--';
    const condition = latestWeather.weatherCondition || 'Unknown';
    const recordDate = latestWeather.recordDate ? formatDateTime(latestWeather.recordDate) : 'N/A';
    const location = latestWeather.latitude && latestWeather.longitude 
        ? `${latestWeather.latitude}Â°N, ${latestWeather.longitude}Â°E`
        : 'General Location';

    const weatherIcon = getWeatherIcon(condition, temp);

    container.innerHTML = `
        <div class="weather-farm-card" style="grid-column: 1 / -1;">
            <div class="weather-farm-header">
                <div class="weather-farm-info">
                    <h3>
                        <i class="fas fa-map-marker-alt"></i>
                        General Weather Data
                    </h3>
                    <p class="weather-farm-location">
                        ${location}
                    </p>
                </div>
                <div class="weather-farm-icon">
                    ${weatherIcon}
                </div>
            </div>

            <div class="weather-farm-main">
                <div class="weather-temp-display">
                    <span class="weather-temp-value">${temp}Â°C</span>
                    <span class="weather-condition">${condition}</span>
                </div>
                <div class="weather-update-time">
                    <i class="fas fa-clock"></i>
                    Last update: ${recordDate}
                </div>
            </div>

            <div class="weather-farm-details">
                <div class="weather-detail-item">
                    <div class="weather-detail-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="weather-detail-info">
                        <span class="weather-detail-label">Humidity</span>
                        <span class="weather-detail-value">${humidity}%</span>
                    </div>
                </div>

                <div class="weather-detail-item">
                    <div class="weather-detail-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green);">
                        <i class="fas fa-cloud-rain"></i>
                    </div>
                    <div class="weather-detail-info">
                        <span class="weather-detail-label">Rainfall</span>
                        <span class="weather-detail-value">${rainfall} mm</span>
                    </div>
                </div>

                <div class="weather-detail-item">
                    <div class="weather-detail-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                        <i class="fas fa-wind"></i>
                    </div>
                    <div class="weather-detail-info">
                        <span class="weather-detail-label">Wind Speed</span>
                        <span class="weather-detail-value">${windSpeed} km/h</span>
                    </div>
                </div>

                <div class="weather-detail-item">
                    <div class="weather-detail-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                        <i class="fas fa-compress-arrows-alt"></i>
                    </div>
                    <div class="weather-detail-info">
                        <span class="weather-detail-label">Pressure</span>
                        <span class="weather-detail-value">${pressure} hPa</span>
                    </div>
                </div>

                ${uvIndex !== '--' ? `
                <div class="weather-detail-item">
                    <div class="weather-detail-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        <i class="fas fa-sun"></i>
                    </div>
                    <div class="weather-detail-info">
                        <span class="weather-detail-label">UV Index</span>
                        <span class="weather-detail-value">${uvIndex}</span>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

/**
 * Display weather data for all farms
 */
function displayWeatherData(weatherDataByFarm, allWeatherData) {
    const container = document.getElementById('weatherFarmsGrid');
    if (!container) {
        console.error('âŒ weatherFarmsGrid not found');
        return;
    }

    if (!weatherDataByFarm || weatherDataByFarm.length === 0) {
        displayEmptyWeatherState();
        return;
    }

    container.innerHTML = weatherDataByFarm.map(({ farm, latestWeather }) => {
        const temp = latestWeather.temperature ? parseFloat(latestWeather.temperature).toFixed(1) : '--';
        const humidity = latestWeather.humidity ? parseFloat(latestWeather.humidity).toFixed(1) : '--';
        const rainfall = latestWeather.rainfall ? parseFloat(latestWeather.rainfall).toFixed(2) : '--';
        const windSpeed = latestWeather.windSpeed ? parseFloat(latestWeather.windSpeed).toFixed(1) : '--';
        const pressure = latestWeather.atmosphericPressure ? parseFloat(latestWeather.atmosphericPressure).toFixed(0) : '--';
        const uvIndex = latestWeather.uvIndex || '--';
        const condition = latestWeather.weatherCondition || 'Unknown';
        const recordDate = latestWeather.recordDate ? formatDateTime(latestWeather.recordDate) : 'N/A';

        // Get weather icon based on condition
        const weatherIcon = getWeatherIcon(condition, temp);

        return `
            <div class="weather-farm-card">
                <div class="weather-farm-header">
                    <div class="weather-farm-info">
                        <h3>
                            <i class="fas fa-map-marker-alt"></i>
                            ${escapeHtml(farm.farmName || 'Unknown Farm')}
                        </h3>
                        <p class="weather-farm-location">
                            ${farm.latitude}Â°N, ${farm.longitude}Â°E
                        </p>
                    </div>
                    <div class="weather-farm-icon">
                        ${weatherIcon}
                    </div>
                </div>

                <div class="weather-farm-main">
                    <div class="weather-temp-display">
                        <span class="weather-temp-value">${temp}Â°C</span>
                        <span class="weather-condition">${condition}</span>
                    </div>
                    <div class="weather-update-time">
                        <i class="fas fa-clock"></i>
                        Last update: ${recordDate}
                    </div>
                </div>

                <div class="weather-farm-details">
                    <div class="weather-detail-item">
                        <div class="weather-detail-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="weather-detail-info">
                            <span class="weather-detail-label">Humidity</span>
                            <span class="weather-detail-value">${humidity}%</span>
                        </div>
                    </div>

                    <div class="weather-detail-item">
                        <div class="weather-detail-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green);">
                            <i class="fas fa-cloud-rain"></i>
                        </div>
                        <div class="weather-detail-info">
                            <span class="weather-detail-label">Rainfall</span>
                            <span class="weather-detail-value">${rainfall} mm</span>
                        </div>
                    </div>

                    <div class="weather-detail-item">
                        <div class="weather-detail-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            <i class="fas fa-wind"></i>
                        </div>
                        <div class="weather-detail-info">
                            <span class="weather-detail-label">Wind Speed</span>
                            <span class="weather-detail-value">${windSpeed} km/h</span>
                        </div>
                    </div>

                    <div class="weather-detail-item">
                        <div class="weather-detail-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                            <i class="fas fa-compress-arrows-alt"></i>
                        </div>
                        <div class="weather-detail-info">
                            <span class="weather-detail-label">Pressure</span>
                            <span class="weather-detail-value">${pressure} hPa</span>
                        </div>
                    </div>

                    ${uvIndex !== '--' ? `
                    <div class="weather-detail-item">
                        <div class="weather-detail-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                            <i class="fas fa-sun"></i>
                        </div>
                        <div class="weather-detail-info">
                            <span class="weather-detail-label">UV Index</span>
                            <span class="weather-detail-value">${uvIndex}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

/**
 * Update weather statistics
 */
function updateWeatherStatistics(allWeatherData) {
    if (!allWeatherData || allWeatherData.length === 0) {
        updateElement('weatherAvgTemp', '--Â°C');
        updateElement('weatherTotalRainfall', '-- mm');
        updateElement('weatherAvgHumidity', '--%');
        updateElement('weatherRiskCount', '0');
        return;
    }

    // Calculate average temperature
    const temps = allWeatherData
        .map(w => parseFloat(w.temperature))
        .filter(t => !isNaN(t));
    const avgTemp = temps.length > 0 
        ? (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1)
        : '--';

    // Calculate total rainfall (last 7 days)
    const recentData = allWeatherData.filter(w => {
        const date = new Date(w.recordDate || w.createdAt || 0);
        const daysAgo = (Date.now() - date.getTime()) / (1000 * 60 * 60 * 24);
        return daysAgo <= 7;
    });
    const totalRainfall = recentData
        .map(w => parseFloat(w.rainfall || 0))
        .filter(r => !isNaN(r))
        .reduce((a, b) => a + b, 0)
        .toFixed(2);

    // Calculate average humidity
    const humidities = allWeatherData
        .map(w => parseFloat(w.humidity))
        .filter(h => !isNaN(h));
    const avgHumidity = humidities.length > 0
        ? (humidities.reduce((a, b) => a + b, 0) / humidities.length).toFixed(1)
        : '--';

    updateElement('weatherAvgTemp', `${avgTemp}Â°C`);
    updateElement('weatherTotalRainfall', `${totalRainfall} mm`);
    updateElement('weatherAvgHumidity', `${avgHumidity}%`);
}

/**
 * Display weather charts
 */
function displayWeatherCharts(allWeatherData) {
    const canvas = document.getElementById('weatherHistoryChart');
    if (!canvas) {
        console.warn('âš ï¸ weatherHistoryChart canvas not found');
        return;
    }

    if (!allWeatherData || allWeatherData.length === 0) {
        console.warn('âš ï¸ No weather data to display in chart');
        // Destroy existing chart if it exists
        if (window.weatherChart) {
            window.weatherChart.destroy();
            window.weatherChart = null;
        }
        return;
    }

    // Sort data by date
    const sortedData = allWeatherData
        .filter(w => w.recordDate || w.createdAt)
        .sort((a, b) => new Date(a.recordDate || a.createdAt) - new Date(b.recordDate || b.createdAt))
        .slice(-30); // Last 30 records

    const labels = sortedData.map(w => {
        const date = new Date(w.recordDate || w.createdAt);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    const temperatures = sortedData.map(w => parseFloat(w.temperature || 0));
    const rainfalls = sortedData.map(w => parseFloat(w.rainfall || 0));

    // Destroy existing chart if it exists
    if (window.weatherChart) {
        window.weatherChart.destroy();
    }

    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('âŒ Chart.js is not loaded');
        canvas.parentElement.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: #666;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; color: #f59e0b;"></i>
                <p>Chart.js library is not loaded. Please refresh the page.</p>
            </div>
        `;
        return;
    }

    try {
        const ctx = canvas.getContext('2d');
        window.weatherChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Temperature (Â°C)',
                        data: temperatures,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4
                    },
                    {
                        label: 'Rainfall (mm)',
                        data: rainfalls,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4,
                        type: 'bar'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Temperature (Â°C)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Rainfall (mm)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
        console.log('âœ… Weather chart created successfully');
    } catch (error) {
        console.error('âŒ Error creating weather chart:', error);
        canvas.parentElement.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: #666;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; color: #ef4444;"></i>
                <p>Error displaying chart: ${error.message}</p>
            </div>
        `;
    }
}

/**
 * Analyze weather risks
 */
function analyzeWeatherRisks(allWeatherData, farms) {
    const risks = [];
    
    if (!allWeatherData || allWeatherData.length === 0) {
        displayWeatherRisks(risks);
        return;
    }

    // Get recent data (last 7 days)
    const recentData = allWeatherData.filter(w => {
        const date = new Date(w.recordDate || w.createdAt || 0);
        const daysAgo = (Date.now() - date.getTime()) / (1000 * 60 * 60 * 24);
        return daysAgo <= 7;
    });

    if (recentData.length === 0) {
        displayWeatherRisks(risks);
        return;
    }

    // Calculate averages
    const avgTemp = recentData
        .map(w => parseFloat(w.temperature))
        .filter(t => !isNaN(t))
        .reduce((a, b) => a + b, 0) / recentData.length;

    const totalRainfall = recentData
        .map(w => parseFloat(w.rainfall || 0))
        .filter(r => !isNaN(r))
        .reduce((a, b) => a + b, 0);

    const avgHumidity = recentData
        .map(w => parseFloat(w.humidity))
        .filter(h => !isNaN(h))
        .reduce((a, b) => a + b, 0) / recentData.length;

    // Flood Risk: High rainfall (>50mm in 7 days)
    if (totalRainfall > 50) {
        risks.push({
            type: 'FLOOD',
            severity: totalRainfall > 100 ? 'HIGH' : 'MEDIUM',
            message: `High rainfall detected: ${totalRainfall.toFixed(2)}mm in the last 7 days. Risk of flooding.`,
            icon: 'fa-water',
            color: '#3b82f6'
        });
    }

    // Drought Risk: Low rainfall (<5mm in 7 days) and low humidity
    if (totalRainfall < 5 && avgHumidity < 40) {
        risks.push({
            type: 'DROUGHT',
            severity: totalRainfall < 2 ? 'HIGH' : 'MEDIUM',
            message: `Drought conditions: Only ${totalRainfall.toFixed(2)}mm rainfall and ${avgHumidity.toFixed(1)}% humidity. Irrigation needed.`,
            icon: 'fa-sun',
            color: '#f59e0b'
        });
    }

    // Heat Stress: High temperature (>35Â°C)
    if (avgTemp > 35) {
        risks.push({
            type: 'HEAT_STRESS',
            severity: avgTemp > 40 ? 'HIGH' : 'MEDIUM',
            message: `High temperature: ${avgTemp.toFixed(1)}Â°C. Risk of heat stress for crops.`,
            icon: 'fa-thermometer-full',
            color: '#ef4444'
        });
    }

    // Cold Stress: Low temperature (<10Â°C)
    if (avgTemp < 10) {
        risks.push({
            type: 'COLD_STRESS',
            severity: avgTemp < 5 ? 'HIGH' : 'MEDIUM',
            message: `Low temperature: ${avgTemp.toFixed(1)}Â°C. Risk of cold stress for crops.`,
            icon: 'fa-snowflake',
            color: '#06b6d4'
        });
    }

    displayWeatherRisks(risks);
    updateElement('weatherRiskCount', risks.length);
}

/**
 * Display weather risks
 */
function displayWeatherRisks(risks) {
    const container = document.getElementById('weatherRiskAlertsContainer');
    if (!container) return;

    if (!risks || risks.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 2rem;">
                <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--primary-green); margin-bottom: 0.5rem;"></i>
                <p style="color: #666;">No active weather risks detected</p>
            </div>
        `;
        return;
    }

    container.innerHTML = risks.map(risk => `
        <div class="weather-risk-alert" style="border-left: 4px solid ${risk.color};">
            <div class="weather-risk-header">
                <div class="weather-risk-icon" style="color: ${risk.color};">
                    <i class="fas ${risk.icon}"></i>
                </div>
                <div class="weather-risk-info">
                    <h4>${risk.type.replace('_', ' ')} Risk</h4>
                    <span class="weather-risk-severity severity-${risk.severity.toLowerCase()}">${risk.severity}</span>
                </div>
            </div>
            <p class="weather-risk-message">${risk.message}</p>
        </div>
    `).join('');
}

/**
 * Generate AI Weather Prediction
 */
async function generateWeatherPrediction() {
    try {
        const btn = document.getElementById('generatePredictionBtn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        }

        showLoading();

        // Get recent weather data for analysis
        let allWeatherData = [];
        try {
            const recentResponse = await apiRequest(`/weather-data/recent?days=30`);
            if (Array.isArray(recentResponse)) {
                allWeatherData = recentResponse;
            } else if (recentResponse && recentResponse.data && Array.isArray(recentResponse.data)) {
                allWeatherData = recentResponse.data;
            }
        } catch (error) {
            console.warn('âš ï¸ Error loading weather data for prediction:', error.message);
        }

        if (allWeatherData.length === 0) {
            showToast('âš ï¸ No weather data available for prediction', 'warning');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate Prediction';
            }
            hideLoading();
            return;
        }

        // Analyze trends
        const sortedData = allWeatherData
            .filter(w => w.recordDate || w.createdAt)
            .sort((a, b) => new Date(a.recordDate || a.createdAt) - new Date(b.recordDate || b.createdAt));

        const recent7Days = sortedData.slice(-7);
        const previous7Days = sortedData.slice(-14, -7);

        // Calculate rainfall trend
        const recentRainfall = recent7Days
            .map(w => parseFloat(w.rainfall || 0))
            .reduce((a, b) => a + b, 0);
        const previousRainfall = previous7Days
            .map(w => parseFloat(w.rainfall || 0))
            .reduce((a, b) => a + b, 0);
        const rainfallTrend = recentRainfall > previousRainfall ? 'INCREASING' : 
                              recentRainfall < previousRainfall ? 'DECREASING' : 'STABLE';

        // Calculate temperature trend
        const recentAvgTemp = recent7Days
            .map(w => parseFloat(w.temperature))
            .filter(t => !isNaN(t))
            .reduce((a, b) => a + b, 0) / recent7Days.length;
        const previousAvgTemp = previous7Days
            .map(w => parseFloat(w.temperature))
            .filter(t => !isNaN(t))
            .reduce((a, b) => a + b, 0) / previous7Days.length;
        const tempTrend = recentAvgTemp > previousAvgTemp ? 'INCREASING' : 
                         recentAvgTemp < previousAvgTemp ? 'DECREASING' : 'STABLE';

        // Generate predictions
        const predictions = {
            rainfallTrend: rainfallTrend,
            temperatureTrend: tempTrend,
            risks: [],
            impacts: []
        };

        // Predict risks
        if (recentRainfall > 50) {
            predictions.risks.push({
                type: 'FLOOD',
                probability: recentRainfall > 100 ? 'HIGH' : 'MEDIUM',
                message: 'High probability of flooding in the next 7 days'
            });
        }

        if (recentRainfall < 5 && recentAvgTemp > 30) {
            predictions.risks.push({
                type: 'DROUGHT',
                probability: recentRainfall < 2 ? 'HIGH' : 'MEDIUM',
                message: 'Drought conditions expected to continue'
            });
        }

        if (recentAvgTemp > 35) {
            predictions.risks.push({
                type: 'HEAT_STRESS',
                probability: recentAvgTemp > 40 ? 'HIGH' : 'MEDIUM',
                message: 'Heat stress risk for crops'
            });
        }

        // Predict impacts
        if (rainfallTrend === 'DECREASING' && recentRainfall < 10) {
            predictions.impacts.push({
                type: 'IRRIGATION_NEED',
                message: 'Increased irrigation needed due to low rainfall'
            });
        }

        if (tempTrend === 'INCREASING' && recentAvgTemp > 30) {
            predictions.impacts.push({
                type: 'CROP_STRESS',
                message: 'High temperatures may cause crop stress'
            });
        }

        if (rainfallTrend === 'INCREASING' && recentRainfall > 30) {
            predictions.impacts.push({
                type: 'PLANTING_DELAY',
                message: 'Heavy rainfall may delay planting activities'
            });
        }

        // Display predictions
        displayWeatherPredictions(predictions);

        showToast('âœ… Weather prediction generated successfully!', 'success');

    } catch (error) {
        console.error('âŒ Error generating prediction:', error);
        showToast('âŒ Error generating prediction', 'error');
    } finally {
        const btn = document.getElementById('generatePredictionBtn');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Generate Prediction';
        }
        hideLoading();
    }
}

/**
 * Display weather predictions
 */
function displayWeatherPredictions(predictions) {
    const container = document.getElementById('weatherPredictionsContainer');
    if (!container) return;

    const rainfallIcon = predictions.rainfallTrend === 'INCREASING' ? 'ðŸ“ˆ' : 
                        predictions.rainfallTrend === 'DECREASING' ? 'ðŸ“‰' : 'âž¡ï¸';
    const tempIcon = predictions.temperatureTrend === 'INCREASING' ? 'ðŸ“ˆ' : 
                     predictions.temperatureTrend === 'DECREASING' ? 'ðŸ“‰' : 'âž¡ï¸';

    container.innerHTML = `
        <div class="weather-predictions-content">
            <!-- Trends -->
            <div class="weather-prediction-section">
                <h4><i class="fas fa-chart-line"></i> Weather Trends (Next 7 Days)</h4>
                <div class="prediction-trends">
                    <div class="prediction-trend-item">
                        <div class="trend-icon">${rainfallIcon}</div>
                        <div class="trend-info">
                            <span class="trend-label">Rainfall Trend</span>
                            <span class="trend-value trend-${predictions.rainfallTrend.toLowerCase()}">${predictions.rainfallTrend}</span>
                        </div>
                    </div>
                    <div class="prediction-trend-item">
                        <div class="trend-icon">${tempIcon}</div>
                        <div class="trend-info">
                            <span class="trend-label">Temperature Trend</span>
                            <span class="trend-value trend-${predictions.temperatureTrend.toLowerCase()}">${predictions.temperatureTrend}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risks -->
            ${predictions.risks.length > 0 ? `
            <div class="weather-prediction-section">
                <h4><i class="fas fa-exclamation-triangle"></i> Risk Alerts</h4>
                <div class="prediction-risks">
                    ${predictions.risks.map(risk => `
                        <div class="prediction-risk-item risk-${risk.probability.toLowerCase()}">
                            <i class="fas fa-${risk.type === 'FLOOD' ? 'water' : risk.type === 'DROUGHT' ? 'sun' : 'thermometer-full'}"></i>
                            <div class="risk-info">
                                <span class="risk-type">${risk.type}</span>
                                <span class="risk-probability">${risk.probability} Probability</span>
                                <p class="risk-message">${risk.message}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            <!-- Impacts -->
            ${predictions.impacts.length > 0 ? `
            <div class="weather-prediction-section">
                <h4><i class="fas fa-seedling"></i> Agricultural Impact</h4>
                <div class="prediction-impacts">
                    ${predictions.impacts.map(impact => `
                        <div class="prediction-impact-item">
                            <i class="fas fa-${impact.type === 'IRRIGATION_NEED' ? 'tint' : impact.type === 'CROP_STRESS' ? 'exclamation-circle' : 'calendar-times'}"></i>
                            <span>${impact.message}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
        </div>
    `;
}

/**
 * Display agricultural impact
 */
function displayAgriculturalImpact(allWeatherData, farms) {
    const container = document.getElementById('agriculturalImpactContainer');
    if (!container) return;

    if (!allWeatherData || allWeatherData.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 2rem;">
                <i class="fas fa-info-circle" style="font-size: 2rem; color: #3b82f6; margin-bottom: 0.5rem;"></i>
                <p style="color: #666;">Agricultural impact analysis will appear here</p>
            </div>
        `;
        return;
    }

    const recentData = allWeatherData.filter(w => {
        const date = new Date(w.recordDate || w.createdAt || 0);
        const daysAgo = (Date.now() - date.getTime()) / (1000 * 60 * 60 * 24);
        return daysAgo <= 7;
    });

    const impacts = [];

    const avgTemp = recentData
        .map(w => parseFloat(w.temperature))
        .filter(t => !isNaN(t))
        .reduce((a, b) => a + b, 0) / recentData.length;

    const totalRainfall = recentData
        .map(w => parseFloat(w.rainfall || 0))
        .filter(r => !isNaN(r))
        .reduce((a, b) => a + b, 0);

    if (totalRainfall < 5) {
        impacts.push({
            icon: 'fa-tint',
            title: 'Irrigation Needed',
            message: 'Low rainfall detected. Consider increasing irrigation frequency.',
            color: '#3b82f6'
        });
    }

    if (avgTemp > 35) {
        impacts.push({
            icon: 'fa-thermometer-full',
            title: 'Heat Stress',
            message: 'High temperatures may stress crops. Ensure adequate water supply.',
            color: '#ef4444'
        });
    }

    if (totalRainfall > 50) {
        impacts.push({
            icon: 'fa-calendar-times',
            title: 'Planting Delay',
            message: 'Heavy rainfall may delay planting activities. Monitor soil conditions.',
            color: '#f59e0b'
        });
    }

    if (impacts.length === 0) {
        impacts.push({
            icon: 'fa-check-circle',
            title: 'Optimal Conditions',
            message: 'Weather conditions are favorable for agricultural activities.',
            color: '#22c55e'
        });
    }

    container.innerHTML = impacts.map(impact => `
        <div class="agricultural-impact-item" style="border-left: 4px solid ${impact.color};">
            <div class="impact-icon" style="color: ${impact.color};">
                <i class="fas ${impact.icon}"></i>
            </div>
            <div class="impact-content">
                <h4>${impact.title}</h4>
                <p>${impact.message}</p>
            </div>
        </div>
    `).join('');
}

/**
 * Get weather icon based on condition and temperature
 */
function getWeatherIcon(condition, temperature) {
    const temp = parseFloat(temperature) || 20;
    const cond = (condition || '').toLowerCase();

    if (cond.includes('rain') || cond.includes('drizzle')) {
        return '<i class="fas fa-cloud-rain" style="font-size: 3rem; color: #3b82f6;"></i>';
    } else if (cond.includes('storm') || cond.includes('thunder')) {
        return '<i class="fas fa-bolt" style="font-size: 3rem; color: #f59e0b;"></i>';
    } else if (cond.includes('cloud') || cond.includes('overcast')) {
        return '<i class="fas fa-cloud" style="font-size: 3rem; color: #94a3b8;"></i>';
    } else if (cond.includes('sun') || cond.includes('clear')) {
        return '<i class="fas fa-sun" style="font-size: 3rem; color: #f59e0b;"></i>';
    } else if (temp > 30) {
        return '<i class="fas fa-sun" style="font-size: 3rem; color: #ef4444;"></i>';
    } else if (temp < 15) {
        return '<i class="fas fa-snowflake" style="font-size: 3rem; color: #06b6d4;"></i>';
    } else {
        return '<i class="fas fa-cloud-sun" style="font-size: 3rem; color: #3b82f6;"></i>';
    }
}

/**
 * Display empty weather state
 */
function displayEmptyWeatherState(message = null) {
    const container = document.getElementById('weatherFarmsGrid');
    if (container) {
        const defaultMessage = 'Weather data will appear here once available for your farm locations.';
        container.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; padding: 3rem 2rem;">
                <i class="fas fa-cloud-sun" style="font-size: 4rem; color: #ddd; margin-bottom: 1rem; opacity: 0.5;"></i>
                <h3 style="color: #666; margin-bottom: 0.5rem;">No Weather Data Available</h3>
                <p style="color: #999; margin-bottom: 1rem;">${message || defaultMessage}</p>
                <button class="btn btn-primary" onclick="loadWeatherData()" style="margin-top: 1rem;">
                    <i class="fas fa-sync-alt"></i>
                    Retry Loading
                </button>
            </div>
        `;
    }

    // Clear statistics
    updateElement('weatherAvgTemp', '--Â°C');
    updateElement('weatherTotalRainfall', '-- mm');
    updateElement('weatherAvgHumidity', '--%');
    updateElement('weatherRiskCount', '0');

    // Clear charts
    const chartCanvas = document.getElementById('weatherHistoryChart');
    if (chartCanvas && window.weatherChart) {
        window.weatherChart.destroy();
        window.weatherChart = null;
    }

    // Clear predictions
    const predictionsContainer = document.getElementById('weatherPredictionsContainer');
    if (predictionsContainer) {
        predictionsContainer.innerHTML = `
            <div class="empty-state" style="padding: 3rem;">
                <i class="fas fa-brain" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;"></i>
                <p style="color: #666;">Click "Generate Prediction" to get AI-powered weather forecasts and agricultural insights</p>
            </div>
        `;
    }

    // Clear risks
    const risksContainer = document.getElementById('weatherRiskAlertsContainer');
    if (risksContainer) {
        risksContainer.innerHTML = `
            <div class="empty-state" style="padding: 2rem;">
                <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--primary-green); margin-bottom: 0.5rem;"></i>
                <p style="color: #666;">No active weather risks detected</p>
            </div>
        `;
    }

    // Clear impact
    const impactContainer = document.getElementById('agriculturalImpactContainer');
    if (impactContainer) {
        impactContainer.innerHTML = `
            <div class="empty-state" style="padding: 2rem;">
                <i class="fas fa-info-circle" style="font-size: 2rem; color: #3b82f6; margin-bottom: 0.5rem;"></i>
                <p style="color: #666;">Agricultural impact analysis will appear here</p>
            </div>
        `;
    }
}

/**
 * View supply chain details
 */
async function viewSupplyChainDetails(stageId) {
    if (!stageId) {
        showToast('âŒ Invalid stage ID', 'error');
        return;
    }

    try {
        showLoading();

        const stage = await apiRequest(`/supply-chain/${stageId}`);

        if (!stage) {
            showToast('âŒ Stage not found', 'error');
            return;
        }

        showSupplyChainDetailsModal(stage);

    } catch (error) {
        console.error('Error loading stage details:', error);
        showToast('âŒ Error loading stage details', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Show supply chain details modal
 */
function showSupplyChainDetailsModal(stage) {
    const modalHTML = `
        <div class="modal-overlay show" id="supplyChainModal" onclick="if(event.target === this) closeSupplyChainModal()">
            <div class="modal-container modal-large">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-info-circle"></i>
                        Supply Chain Stage Details
                    </h3>
                    <button class="modal-close" onclick="closeSupplyChainModal()" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="details-grid">
                        <div class="detail-item">
                            <label>Stage:</label>
                            <value><strong>${stage.stage}</strong></value>
                        </div>
                        <div class="detail-item">
                            <label>Stage Order:</label>
                            <value>${stage.stageOrder}</value>
                        </div>
                        <div class="detail-item">
                            <label>Location:</label>
                            <value>${stage.location || 'N/A'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Facility:</label>
                            <value>${stage.facilityName || 'N/A'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Responsible Party:</label>
                            <value>${stage.responsibleParty || 'N/A'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Quantity In:</label>
                            <value>${stage.quantityIn || 'N/A'} ${stage.unit || 'KG'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Quantity Out:</label>
                            <value>${stage.quantityOut || 'N/A'} ${stage.unit || 'KG'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Quality Status:</label>
                            <value>${stage.qualityStatus || 'N/A'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Tracking Code:</label>
                            <value>${stage.trackingCode || 'N/A'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Start Date:</label>
                            <value>${stage.stageStartDate ? formatDateTime(stage.stageStartDate) : 'N/A'}</value>
                        </div>
                        <div class="detail-item">
                            <label>End Date:</label>
                            <value>${stage.stageEndDate ? formatDateTime(stage.stageEndDate) : 'Not completed'}</value>
                        </div>
                        ${stage.lossQuantity && parseFloat(stage.lossQuantity) > 0 ? `
                        <div class="detail-item full-width alert">
                            <label>Loss Information:</label>
                            <value>
                                ${stage.lossQuantity} ${stage.unit || 'KG'}
                                ${stage.lossPercentage ? `(${stage.lossPercentage}%)` : ''}
                                ${stage.lossReason ? `<br><small>${stage.lossReason}</small>` : ''}
                            </value>
                        </div>
                        ` : ''}
                        ${stage.notes ? `
                        <div class="detail-item full-width">
                            <label>Notes:</label>
                            <value>${stage.notes}</value>
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSupplyChainModal()">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                    ${!stage.stageEndDate ? `
                        <button type="button" class="btn btn-primary" onclick="editSupplyChainStage('${stage.id}')">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                        <button type="button" class="btn btn-success" onclick="completeStage('${stage.id}')">
                            <i class="fas fa-check"></i>
                            Complete Stage
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close supply chain modal
 */
function closeSupplyChainModal() {
    const modal = document.getElementById('supplyChainModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}

/**
 * Edit supply chain stage
 */
function editSupplyChainStage(stageId) {
    showToast('Edit stage functionality coming soon', 'info');
    closeSupplyChainModal();
}

/**
 * Complete stage
 */
async function completeStage(stageId) {
    if (!confirm('Are you sure you want to mark this stage as completed?')) {
        return;
    }

    try {
        showLoading();

        await apiRequest(`/supply-chain/${stageId}/complete`, {
            method: 'PUT',
            body: JSON.stringify({
                stageEndDate: new Date().toISOString()
            })
        });

        showToast('âœ… Stage completed successfully', 'success');
        closeSupplyChainModal();
        await loadSupplyChainData();

    } catch (error) {
        console.error('Error completing stage:', error);
        showToast('âŒ Error completing stage', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Open add supply chain modal
 */
function openAddSupplyChainModal() {
    showToast('Add supply chain stage functionality coming soon', 'info');
}

/**
 * Initialize supply chain search
 */
function initSupplyChainSearch() {
    const searchInput = document.getElementById('supplyChainSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(() => {
            filterSupplyChainData();
        }, 300));
    }
}

/**
 * Filter supply chain data
 */
function filterSupplyChainData() {
    const searchTerm = document.getElementById('supplyChainSearchInput')?.value.toLowerCase() || '';
    const groups = document.querySelectorAll('.supply-chain-group');

    groups.forEach(group => {
        const text = group.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            group.style.display = 'block';
        } else {
            group.style.display = 'none';
        }
    });
}

/**
 * Initialize on load
 */
document.addEventListener('DOMContentLoaded', () => {
    initSupplyChainSearch();
});

console.log('âœ… Supply Chain module loaded');





















/**
 * Helper function to update element
 */
function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    }
}





    /**
     * Display supply chain timeline
     */
    function displaySupplyChainTimeline(supplyChainData) {
      const container = document.getElementById('supplyChainContainer');
      if (!container) return;

      if (supplyChainData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-truck"></i>
            <p>No supply chain tracking data available</p>
          </div>
        `;
        return;
      }

      const stageColors = {
        'HARVEST': '#22c55e',
        'COLLECTION': '#3b82f6',
        'STORAGE': '#f59e0b',
        'PROCESSING': '#8b5cf6',
        'PACKAGING': '#ec4899',
        'TRANSPORT': '#14b8a6',
        'DISTRIBUTION': '#f97316',
        'RETAIL': '#06b6d4'
      };

      container.innerHTML = supplyChainData.map(item => `
        <div class="supply-chain-item">
          <div class="supply-chain-header">
            <div>
              <div class="supply-chain-tracking-code">Tracking: ${item.trackingCode}</div>
              <h3 class="supply-chain-title">${item.productionCode || 'Production'} - ${item.cropName || 'Crop'}</h3>
            </div>
          </div>
          <div class="supply-chain-stages">
            ${(item.stages || []).map(stage => `
              <div class="stage-card" style="border-left-color: ${stageColors[stage.stageName] || '#666'};">
                <div class="stage-name">
                  <i class="fas ${getStageIcon(stage.stageName)}"></i>
                  ${stage.stageName}
                </div>
                <div class="stage-details">
                  <strong>Date:</strong> ${formatDateTime(stage.timestamp)}<br>
                  <strong>Location:</strong> ${stage.location || 'N/A'}<br>
                  ${stage.handler ? `<strong>Handler:</strong> ${stage.handler}<br>` : ''}
                  ${stage.notes ? `<strong>Notes:</strong> ${stage.notes}` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    /**
     * Get stage icon
     */
    function getStageIcon(stageName) {
      const icons = {
        'HARVEST': 'fa-seedling',
        'COLLECTION': 'fa-hand-holding',
        'STORAGE': 'fa-warehouse',
        'PROCESSING': 'fa-cogs',
        'PACKAGING': 'fa-box',
        'TRANSPORT': 'fa-truck',
        'DISTRIBUTION': 'fa-shipping-fast',
        'RETAIL': 'fa-store'
      };
      return icons[stageName] || 'fa-circle';
    }

    // ============================================================================
    // WEATHER DATA MODULE
    // ============================================================================

    /**
     * Load weather data
     */
    // Old weather functions removed - using new comprehensive implementation above

    // ============================================================================
    // ALERTS MODULE
    // ============================================================================

    /**
     * Load alerts data
     */
    /**
     * Load alerts data with AI analysis
     */
    async function loadAlertsData() {
      try {
        showLoading();
        console.log('ðŸš¨ Loading food security alerts...');

        if (!currentUser || !currentUser.id) {
            console.error('âŒ No current user found');
            displayEmptyAlertsState('No user session found. Please login again.');
            hideLoading();
            return;
        }

        // âœ… STEP 1: Get alerts from database
        let databaseAlerts = [];
        try {
            const response = await apiRequest('/food-security-alerts/active?page=0&size=100');
            
            // Handle different response formats
            if (Array.isArray(response)) {
                databaseAlerts = response;
            } else if (response && response.data) {
                if (Array.isArray(response.data)) {
                    databaseAlerts = response.data;
                } else if (response.data.content && Array.isArray(response.data.content)) {
                    databaseAlerts = response.data.content;
                }
            } else if (response && response.content && Array.isArray(response.content)) {
                databaseAlerts = response.content;
            }
            
            console.log(`âœ… Loaded ${databaseAlerts.length} alerts from database`);
        } catch (error) {
            console.warn('âš ï¸ Error loading alerts from database:', error.message);
            databaseAlerts = [];
        }

        // âœ… STEP 2: Generate AI alerts based on real data
        console.log('ðŸ¤– Generating AI alerts based on real farm data...');
        const aiAlerts = await generateAIAlerts();

        // âœ… STEP 3: Combine database alerts and AI alerts
        const allAlerts = [...databaseAlerts, ...aiAlerts];
        
        // Sort by priority (CRITICAL first, then by date)
        allAlerts.sort((a, b) => {
            const levelPriority = { 'CRITICAL': 5, 'HIGH': 4, 'MEDIUM': 3, 'LOW': 2, 'INFO': 1 };
            const aPriority = levelPriority[a.alertLevel] || 0;
            const bPriority = levelPriority[b.alertLevel] || 0;
            if (aPriority !== bPriority) return bPriority - aPriority;
            
            const aDate = new Date(a.alertDate || a.createdAt || 0);
            const bDate = new Date(b.alertDate || b.createdAt || 0);
            return bDate - aDate;
        });

        console.log(`âœ… Total alerts: ${allAlerts.length} (${databaseAlerts.length} from DB, ${aiAlerts.length} AI-generated)`);

        // âœ… STEP 4: Update statistics
        updateAlertsStatistics(allAlerts);

        // âœ… STEP 5: Store alerts globally for filtering
        allAlertsData = allAlerts;

        // âœ… STEP 6: Display alerts
        displayAlertsList(allAlerts);

      } catch (error) {
        console.error('âŒ Error loading alerts:', error);
        showToast('Error loading alerts: ' + error.message, 'error');
        displayEmptyAlertsState('Error loading alerts. Please try again.');
      } finally {
        hideLoading();
      }
    }

    /**
     * Generate AI alerts based on real farm data
     */
    async function generateAIAlerts() {
        const aiAlerts = [];
        
        try {
            if (!currentUser || !currentUser.id) {
                return aiAlerts;
            }

            const farmerId = currentUser.id;

            // âœ… Get all relevant data for analysis
            const [farms, productions, inventory, weatherData, transactions] = await Promise.all([
                apiRequest(`/farms/farmer/${farmerId}/all`).catch(() => []),
                apiRequest(`/v1/crop-productions/farmer/${farmerId}`).catch(() => ({ data: [] })),
                apiRequest(`/inventory/farmer/${farmerId}`).catch(() => []),
                apiRequest(`/weather-data/recent?days=7`).catch(() => []),
                apiRequest(`/transactions/farmer/${farmerId}`).catch(() => [])
            ]);

            const farmsList = Array.isArray(farms) ? farms : [];
            const productionsList = Array.isArray(productions) ? productions : 
                                   (productions.data && Array.isArray(productions.data) ? productions.data : []);
            const inventoryList = Array.isArray(inventory) ? inventory : [];
            const weatherList = Array.isArray(weatherData) ? weatherData : [];
            const transactionsList = Array.isArray(transactions) ? transactions : 
                                    (transactions.content && Array.isArray(transactions.content) ? transactions.content : []);

            console.log(`ðŸ“Š Analyzing: ${farmsList.length} farms, ${productionsList.length} productions, ${inventoryList.length} inventory items, ${weatherList.length} weather records`);

            // âœ… ALERT 1: Low Inventory Alert
            const lowStockItems = inventoryList.filter(item => {
                const available = parseFloat(item.availableQuantity || 0);
                const total = parseFloat(item.totalQuantity || 0);
                return available > 0 && total > 0 && (available / total) < 0.2; // Less than 20% remaining
            });

            if (lowStockItems.length > 0) {
                aiAlerts.push({
                    id: 'AI-LOW-STOCK-' + Date.now(),
                    alertCode: 'AI-LOW-STOCK',
                    alertTitle: 'Low Inventory Stock Alert',
                    alertCategory: 'PRODUCTION',
                    alertLevel: lowStockItems.length > 5 ? 'HIGH' : 'MEDIUM',
                    description: `${lowStockItems.length} crop(s) have low stock levels (less than 20% remaining). Consider restocking soon to avoid production delays.`,
                    severityScore: lowStockItems.length > 5 ? 8 : 5,
                    affectedCrops: JSON.stringify(lowStockItems.map(item => item.cropName || 'Unknown')),
                    alertDate: new Date().toISOString(),
                    source: 'AI Analysis System',
                    isActive: true,
                    recommendedActions: `1. Review inventory levels for: ${lowStockItems.slice(0, 3).map(i => i.cropName || 'Unknown').join(', ')}\n2. Plan restocking for critical crops\n3. Check production schedules`,
                    isAIGenerated: true
                });
            }

            // âœ… ALERT 2: Weather Risk Alert
            if (weatherList.length > 0) {
                const recentWeather = weatherList.slice(0, 7);
                const avgTemp = recentWeather
                    .map(w => parseFloat(w.temperature))
                    .filter(t => !isNaN(t))
                    .reduce((a, b) => a + b, 0) / recentWeather.length;
                
                const totalRainfall = recentWeather
                    .map(w => parseFloat(w.rainfall || 0))
                    .filter(r => !isNaN(r))
                    .reduce((a, b) => a + b, 0);

                if (avgTemp > 35) {
                    aiAlerts.push({
                        id: 'AI-HEAT-STRESS-' + Date.now(),
                        alertCode: 'AI-HEAT-STRESS',
                        alertTitle: 'Heat Stress Warning',
                        alertCategory: 'WEATHER',
                        alertLevel: avgTemp > 40 ? 'HIGH' : 'MEDIUM',
                        description: `High temperatures detected (${avgTemp.toFixed(1)}Â°C average). Your crops may experience heat stress. Ensure adequate irrigation and consider shade protection.`,
                        severityScore: avgTemp > 40 ? 8 : 6,
                        alertDate: new Date().toISOString(),
                        source: 'AI Weather Analysis',
                        isActive: true,
                        recommendedActions: '1. Increase irrigation frequency\n2. Monitor soil moisture levels\n3. Consider applying mulch to retain moisture\n4. Check for signs of wilting or leaf burn',
                        isAIGenerated: true
                    });
                }

                if (totalRainfall < 5 && avgTemp > 30) {
                    aiAlerts.push({
                        id: 'AI-DROUGHT-' + Date.now(),
                        alertCode: 'AI-DROUGHT',
                        alertTitle: 'Drought Conditions Alert',
                        alertCategory: 'WEATHER',
                        alertLevel: 'HIGH',
                        description: `Drought conditions detected: Only ${totalRainfall.toFixed(2)}mm rainfall in the last 7 days with high temperatures. Immediate irrigation action required.`,
                        severityScore: 9,
                        alertDate: new Date().toISOString(),
                        source: 'AI Weather Analysis',
                        isActive: true,
                        recommendedActions: '1. Schedule immediate irrigation\n2. Monitor soil moisture daily\n3. Consider water conservation measures\n4. Check crop water requirements',
                        isAIGenerated: true
                    });
                }

                if (totalRainfall > 50) {
                    aiAlerts.push({
                        id: 'AI-FLOOD-RISK-' + Date.now(),
                        alertCode: 'AI-FLOOD-RISK',
                        alertTitle: 'Flood Risk Warning',
                        alertCategory: 'WEATHER',
                        alertLevel: totalRainfall > 100 ? 'CRITICAL' : 'HIGH',
                        description: `Heavy rainfall detected: ${totalRainfall.toFixed(2)}mm in the last 7 days. Risk of flooding and waterlogging. Protect your crops and storage facilities.`,
                        severityScore: totalRainfall > 100 ? 10 : 8,
                        alertDate: new Date().toISOString(),
                        source: 'AI Weather Analysis',
                        isActive: true,
                        recommendedActions: '1. Check drainage systems\n2. Move stored crops to higher ground\n3. Monitor water levels\n4. Prepare for potential crop damage',
                        isAIGenerated: true
                    });
                }
            }

            // âœ… ALERT 3: Production Issues
            const activeProductions = productionsList.filter(p => 
                p.status === 'ACTIVE' || p.status === 'IN_PROGRESS'
            );

            if (activeProductions.length > 0) {
                const overdueProductions = activeProductions.filter(p => {
                    if (!p.expectedHarvestDate) return false;
                    const expectedDate = new Date(p.expectedHarvestDate);
                    const today = new Date();
                    return today > expectedDate;
                });

                if (overdueProductions.length > 0) {
                    aiAlerts.push({
                        id: 'AI-OVERDUE-HARVEST-' + Date.now(),
                        alertCode: 'AI-OVERDUE-HARVEST',
                        alertTitle: 'Overdue Harvest Alert',
                        alertCategory: 'PRODUCTION',
                        alertLevel: 'MEDIUM',
                        description: `${overdueProductions.length} production(s) have passed their expected harvest date. Review and update harvest schedules.`,
                        severityScore: 6,
                        affectedCrops: JSON.stringify(overdueProductions.map(p => p.cropName || 'Unknown')),
                        alertDate: new Date().toISOString(),
                        source: 'AI Production Analysis',
                        isActive: true,
                        recommendedActions: '1. Review harvest schedules\n2. Check crop maturity\n3. Update production records\n4. Plan harvest activities',
                        isAIGenerated: true
                    });
                }
            }

            // âœ… ALERT 4: Transaction Issues
            const pendingTransactions = transactionsList.filter(t => 
                t.status === 'PENDING' || t.transactionStatus === 'PENDING'
            );

            if (pendingTransactions.length > 5) {
                aiAlerts.push({
                    id: 'AI-PENDING-TRANSACTIONS-' + Date.now(),
                    alertCode: 'AI-PENDING-TRANSACTIONS',
                    alertTitle: 'Multiple Pending Transactions',
                    alertCategory: 'MARKET',
                    alertLevel: 'MEDIUM',
                    description: `You have ${pendingTransactions.length} pending transactions. Consider following up to ensure timely payments.`,
                    severityScore: 5,
                    alertDate: new Date().toISOString(),
                    source: 'AI Market Analysis',
                    isActive: true,
                    recommendedActions: '1. Review pending transactions\n2. Contact buyers for updates\n3. Update transaction statuses\n4. Follow up on payments',
                    isAIGenerated: true
                });
            }

            // âœ… ALERT 5: Farm Health
            if (farmsList.length > 0) {
                const farmsWithoutRecentActivity = farmsList.filter(farm => {
                    // Check if farm has recent production or activity
                    const farmProductions = productionsList.filter(p => p.farmId === farm.id);
                    return farmProductions.length === 0;
                });

                if (farmsWithoutRecentActivity.length > 0 && farmsWithoutRecentActivity.length === farmsList.length) {
                    aiAlerts.push({
                        id: 'AI-NO-ACTIVITY-' + Date.now(),
                        alertCode: 'AI-NO-ACTIVITY',
                        alertTitle: 'No Recent Farm Activity',
                        alertCategory: 'PRODUCTION',
                        alertLevel: 'LOW',
                        description: `No recent production activity detected on your farms. Consider planning new crop productions.`,
                        severityScore: 3,
                        alertDate: new Date().toISOString(),
                        source: 'AI Farm Analysis',
                        isActive: true,
                        recommendedActions: '1. Plan new crop productions\n2. Review seasonal planting schedules\n3. Check farm conditions\n4. Start new production cycles',
                        isAIGenerated: true
                    });
                }
            }

            console.log(`âœ… Generated ${aiAlerts.length} AI alerts`);

        } catch (error) {
            console.error('âŒ Error generating AI alerts:', error);
        }

        return aiAlerts;
    }



/**
 * Display alerts list - IMPROVED VERSION WITH AI SUPPORT
 */
function displayAlertsList(alerts) {
  const container = document.getElementById('alertsList');
  if (!container) {
    console.error('âŒ alertsList container not found');
    return;
  }

  // âœ… CORRECTION: Extraire le tableau depuis data.content
  let alertsList = [];
  if (Array.isArray(alerts)) {
    alertsList = alerts;
  } else if (alerts && alerts.data && Array.isArray(alerts.data.content)) {
    alertsList = alerts.data.content;
  } else if (alerts && alerts.data && Array.isArray(alerts.data)) {
    alertsList = alerts.data;
  } else if (alerts && alerts.content && Array.isArray(alerts.content)) {
    alertsList = alerts.content;
  } else {
    console.warn('âš ï¸ Unexpected alerts format:', alerts);
    alertsList = [];
  }

  if (alertsList.length === 0) {
    displayEmptyAlertsState('No active alerts at the moment. Your farm operations appear to be running smoothly.');
    return;
  }

  console.log(`ðŸ“Š Displaying ${alertsList.length} alerts`);

  container.innerHTML = alertsList.map(alert => {
    if (!alert || !alert.alertTitle) {
      return '';
    }

    const alertLevel = alert.alertLevel || 'INFO';
    const levelLower = alertLevel.toLowerCase();
    const category = alert.alertCategory || alert.category || 'GENERAL';
    const description = alert.description || 'No description available';
    const alertDate = alert.alertDate ? formatDateTime(alert.alertDate) : 'N/A';
    const severityScore = alert.severityScore || 5;
    const isAIGenerated = alert.isAIGenerated || false;
    const recommendedActions = alert.recommendedActions || null;
    const affectedCrops = alert.affectedCrops ? (typeof alert.affectedCrops === 'string' ? JSON.parse(alert.affectedCrops) : alert.affectedCrops) : null;

    // Level colors
    const levelColors = {
      'critical': { bg: 'rgba(239, 68, 68, 0.15)', border: '#ef4444', text: '#ef4444', icon: 'fa-exclamation-circle' },
      'high': { bg: 'rgba(245, 158, 11, 0.15)', border: '#f59e0b', text: '#f59e0b', icon: 'fa-exclamation-triangle' },
      'medium': { bg: 'rgba(59, 130, 246, 0.15)', border: '#3b82f6', text: '#3b82f6', icon: 'fa-info-circle' },
      'low': { bg: 'rgba(139, 92, 246, 0.15)', border: '#8b5cf6', text: '#8b5cf6', icon: 'fa-bell' },
      'info': { bg: 'rgba(34, 197, 94, 0.15)', border: '#22c55e', text: '#22c55e', icon: 'fa-info' }
    };

    const levelStyle = levelColors[levelLower] || levelColors['info'];

    // Category icons
    const categoryIcons = {
      'PRODUCTION': 'fa-seedling',
      'WEATHER': 'fa-cloud-sun',
      'MARKET': 'fa-chart-line',
      'DISEASE': 'fa-virus',
      'POLICY': 'fa-gavel',
      'GENERAL': 'fa-bell'
    };

    const categoryIcon = categoryIcons[category] || 'fa-bell';

    return `
      <div class="alert-item" style="border-left: 4px solid ${levelStyle.border}; background: ${levelStyle.bg};">
        <div class="alert-item-header">
          <div class="alert-item-title-section">
            ${isAIGenerated ? `
            <span class="ai-badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-right: 8px;">
              <i class="fas fa-brain"></i> AI
            </span>
            ` : ''}
            <h4 class="alert-item-title" style="color: var(--text-primary); margin: 0; font-size: 18px; font-weight: 700;">
              ${escapeHtml(alert.alertTitle)}
            </h4>
          </div>
          <div class="alert-item-badges">
            <span class="alert-level" style="background: ${levelStyle.border}; color: white; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
              <i class="fas ${levelStyle.icon}"></i> ${alertLevel}
            </span>
            ${severityScore ? `
            <span class="severity-score" style="background: rgba(0,0,0,0.1); color: var(--text-secondary); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
              Severity: ${severityScore}/10
            </span>
            ` : ''}
          </div>
        </div>

        <div class="alert-item-body">
          <p class="alert-item-message" style="color: var(--text-secondary); line-height: 1.6; margin: 12px 0;">
            ${escapeHtml(description)}
          </p>

          ${affectedCrops && Array.isArray(affectedCrops) && affectedCrops.length > 0 ? `
          <div class="alert-affected-items" style="margin: 12px 0; padding: 8px 12px; background: rgba(0,0,0,0.05); border-radius: 8px;">
            <strong style="color: var(--text-primary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
              <i class="fas fa-seedling"></i> Affected Crops:
            </strong>
            <div style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 6px;">
              ${affectedCrops.map(crop => `
                <span style="background: rgba(34, 197, 94, 0.15); color: var(--primary-green); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                  ${escapeHtml(crop)}
                </span>
              `).join('')}
            </div>
          </div>
          ` : ''}

          ${recommendedActions ? `
          <div class="alert-recommendations" style="margin: 12px 0; padding: 12px; background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); border-left: 3px solid #ffc107; border-radius: 8px;">
            <strong style="color: #856404; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
              <i class="fas fa-lightbulb" style="color: #ffc107;"></i> Recommended Actions:
            </strong>
            <div style="color: #666; font-size: 13px; line-height: 1.8; white-space: pre-line;">
              ${escapeHtml(recommendedActions)}
            </div>
          </div>
          ` : ''}
        </div>

        <div class="alert-item-footer" style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.1); margin-top: 12px;">
          <div class="alert-item-meta" style="display: flex; gap: 16px; flex-wrap: wrap;">
            <span style="color: var(--text-secondary); font-size: 12px; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-calendar-alt" style="color: ${levelStyle.border};"></i>
              ${alertDate}
            </span>
            <span style="color: var(--text-secondary); font-size: 12px; display: flex; align-items: center; gap: 6px;">
              <i class="fas ${categoryIcon}" style="color: ${levelStyle.border};"></i>
              ${category}
            </span>
            ${alert.source ? `
            <span style="color: var(--text-secondary); font-size: 12px; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-source" style="color: ${levelStyle.border};"></i>
              ${escapeHtml(alert.source)}
            </span>
            ` : ''}
          </div>
          <div class="alert-item-actions">
            ${alert.id || alert.alertCode ? `
            <button class="btn-icon" onclick="viewAlertDetails('${alert.id || alert.alertCode}')" title="View Details" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#3b82f6'; this.style.color='white';" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'; this.style.color='#3b82f6';">
              <i class="fas fa-eye"></i>
            </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }).filter(html => html !== '').join('');
}

/**
 * Update alerts statistics
 */
function updateAlertsStatistics(alerts) {
    if (!alerts || alerts.length === 0) {
        updateElement('alertsCriticalCount', '0');
        updateElement('alertsHighCount', '0');
        updateElement('alertsTotalCount', '0');
        updateElement('aiAlertsCount', '0');
        return;
    }

    const critical = alerts.filter(a => a.alertLevel === 'CRITICAL').length;
    const high = alerts.filter(a => a.alertLevel === 'HIGH').length;
    const total = alerts.length;
    const aiGenerated = alerts.filter(a => a.isAIGenerated === true).length;

    updateElement('alertsCriticalCount', critical);
    updateElement('alertsHighCount', high);
    updateElement('alertsTotalCount', total);
    updateElement('aiAlertsCount', aiGenerated);
}

/**
 * Display empty alerts state
 */
function displayEmptyAlertsState(message = null) {
    const container = document.getElementById('alertsList');
    if (container) {
        const defaultMessage = 'No active alerts at the moment. Your farm operations appear to be running smoothly.';
        container.innerHTML = `
            <div class="empty-state" style="padding: 4rem 2rem; text-align: center;">
                <div style="width: 100px; height: 100px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--primary-green);"></i>
                </div>
                <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.5rem;">No Active Alerts</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto;">
                    ${message || defaultMessage}
                </p>
                <button class="btn btn-primary" onclick="generateAIAnalysis()" style="margin-top: 1rem;">
                    <i class="fas fa-brain"></i>
                    Generate AI Analysis
                </button>
            </div>
        `;
    }

    updateAlertsStatistics([]);
}

/**
 * Generate comprehensive AI analysis
 */
async function generateAIAnalysis() {
    try {
        const btn = document.getElementById('generateAIAnalysisBtn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        }

        showLoading();
        showToast('ðŸ¤– Generating AI analysis based on your farm data...', 'info');

        if (!currentUser || !currentUser.id) {
            showToast('âŒ No user session found', 'error');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate AI Analysis';
            }
            hideLoading();
            return;
        }

        const farmerId = currentUser.id;

        // âœ… Collect all real data
        console.log('ðŸ“Š Collecting farm data for AI analysis...');
        
        const [farms, productions, inventory, weatherData, transactions, soilData] = await Promise.all([
            apiRequest(`/farms/farmer/${farmerId}/all`).catch(() => []),
            apiRequest(`/v1/crop-productions/farmer/${farmerId}`).catch(() => ({ data: [] })),
            apiRequest(`/inventory/farmer/${farmerId}`).catch(() => []),
            apiRequest(`/weather-data/recent?days=30`).catch(() => []),
            apiRequest(`/transactions/farmer/${farmerId}`).catch(() => []),
            apiRequest(`/soil-data/farmer/${farmerId}`).catch(() => [])
        ]);

        const farmsList = Array.isArray(farms) ? farms : [];
        const productionsList = Array.isArray(productions) ? productions : 
                               (productions.data && Array.isArray(productions.data) ? productions.data : []);
        const inventoryList = Array.isArray(inventory) ? inventory : [];
        const weatherList = Array.isArray(weatherData) ? weatherData : [];
        const transactionsList = Array.isArray(transactions) ? transactions : 
                                (transactions.content && Array.isArray(transactions.content) ? transactions.content : []);
        const soilList = Array.isArray(soilData) ? soilData : [];

        console.log(`âœ… Collected data: ${farmsList.length} farms, ${productionsList.length} productions, ${inventoryList.length} inventory, ${weatherList.length} weather, ${transactionsList.length} transactions, ${soilList.length} soil records`);

        // âœ… Perform AI Analysis
        const analysis = performAIAnalysis({
            farms: farmsList,
            productions: productionsList,
            inventory: inventoryList,
            weather: weatherList,
            transactions: transactionsList,
            soil: soilList
        });

        // âœ… Display analysis
        displayAIAnalysis(analysis);

        showToast('âœ… AI analysis generated successfully!', 'success');

    } catch (error) {
        console.error('âŒ Error generating AI analysis:', error);
        showToast('âŒ Error generating AI analysis: ' + error.message, 'error');
    } finally {
        const btn = document.getElementById('generateAIAnalysisBtn');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Generate AI Analysis';
        }
        hideLoading();
    }
}

/**
 * Perform comprehensive AI analysis on farm data
 */
function performAIAnalysis(data) {
    const analysis = {
        summary: {
            overallHealth: 'GOOD',
            riskLevel: 'LOW',
            recommendations: []
        },
        weather: {
            status: 'NORMAL',
            risks: [],
            trends: {},
            recommendations: []
        },
        production: {
            status: 'ACTIVE',
            issues: [],
            opportunities: [],
            recommendations: []
        },
        inventory: {
            status: 'ADEQUATE',
            warnings: [],
            recommendations: []
        },
        market: {
            status: 'STABLE',
            insights: [],
            recommendations: []
        },
        soil: {
            status: 'HEALTHY',
            issues: [],
            recommendations: []
        }
    };

    // âœ… WEATHER ANALYSIS
    if (data.weather && data.weather.length > 0) {
        const recentWeather = data.weather.slice(0, 7);
        const avgTemp = recentWeather
            .map(w => parseFloat(w.temperature))
            .filter(t => !isNaN(t))
            .reduce((a, b) => a + b, 0) / recentWeather.length;
        
        const totalRainfall = recentWeather
            .map(w => parseFloat(w.rainfall || 0))
            .filter(r => !isNaN(r))
            .reduce((a, b) => a + b, 0);

        const avgHumidity = recentWeather
            .map(w => parseFloat(w.humidity))
            .filter(h => !isNaN(h))
            .reduce((a, b) => a + b, 0) / recentWeather.length;

        // Temperature trend
        if (avgTemp > 35) {
            analysis.weather.risks.push({
                type: 'HEAT_STRESS',
                severity: avgTemp > 40 ? 'HIGH' : 'MEDIUM',
                message: `High temperatures (${avgTemp.toFixed(1)}Â°C) may stress crops`,
                recommendation: 'Increase irrigation frequency and monitor soil moisture'
            });
            analysis.weather.status = 'WARNING';
        } else if (avgTemp < 15) {
            analysis.weather.risks.push({
                type: 'COLD_STRESS',
                severity: avgTemp < 10 ? 'HIGH' : 'MEDIUM',
                message: `Low temperatures (${avgTemp.toFixed(1)}Â°C) may affect crop growth`,
                recommendation: 'Consider protective measures for sensitive crops'
            });
            analysis.weather.status = 'WARNING';
        }

        // Rainfall analysis
        if (totalRainfall < 5) {
            analysis.weather.risks.push({
                type: 'DROUGHT',
                severity: 'HIGH',
                message: `Low rainfall (${totalRainfall.toFixed(2)}mm) - drought conditions`,
                recommendation: 'Schedule irrigation immediately'
            });
            analysis.weather.status = 'CRITICAL';
        } else if (totalRainfall > 50) {
            analysis.weather.risks.push({
                type: 'FLOOD_RISK',
                severity: totalRainfall > 100 ? 'CRITICAL' : 'HIGH',
                message: `Heavy rainfall (${totalRainfall.toFixed(2)}mm) - flood risk`,
                recommendation: 'Check drainage systems and protect stored crops'
            });
            analysis.weather.status = 'CRITICAL';
        }

        analysis.weather.trends = {
            temperature: avgTemp > 30 ? 'INCREASING' : avgTemp < 20 ? 'DECREASING' : 'STABLE',
            rainfall: totalRainfall > 30 ? 'INCREASING' : totalRainfall < 10 ? 'DECREASING' : 'STABLE',
            humidity: avgHumidity > 70 ? 'HIGH' : avgHumidity < 40 ? 'LOW' : 'NORMAL'
        };
    }

    // âœ… PRODUCTION ANALYSIS
    if (data.productions && data.productions.length > 0) {
        const activeProductions = data.productions.filter(p => 
            p.status === 'ACTIVE' || p.status === 'IN_PROGRESS'
        );

        if (activeProductions.length === 0) {
            analysis.production.issues.push({
                type: 'NO_ACTIVE_PRODUCTION',
                message: 'No active crop productions detected',
                recommendation: 'Plan and start new crop productions for the season'
            });
            analysis.production.status = 'INACTIVE';
        } else {
            const overdue = activeProductions.filter(p => {
                if (!p.expectedHarvestDate) return false;
                return new Date() > new Date(p.expectedHarvestDate);
            });

            if (overdue.length > 0) {
                analysis.production.issues.push({
                    type: 'OVERDUE_HARVEST',
                    message: `${overdue.length} production(s) past harvest date`,
                    recommendation: 'Review and update harvest schedules'
                });
            }

            analysis.production.opportunities.push({
                type: 'EXPAND_PRODUCTION',
                message: `You have ${activeProductions.length} active production(s)`,
                recommendation: 'Consider expanding successful crop varieties'
            });
        }
    }

    // âœ… INVENTORY ANALYSIS
    if (data.inventory && data.inventory.length > 0) {
        const lowStock = data.inventory.filter(item => {
            const available = parseFloat(item.availableQuantity || 0);
            const total = parseFloat(item.totalQuantity || 0);
            return available > 0 && total > 0 && (available / total) < 0.2;
        });

        if (lowStock.length > 0) {
            analysis.inventory.warnings.push({
                type: 'LOW_STOCK',
                message: `${lowStock.length} item(s) with low stock (less than 20%)`,
                recommendation: 'Restock critical inventory items soon'
            });
            analysis.inventory.status = 'LOW';
        }

        const totalValue = data.inventory.reduce((sum, item) => {
            const price = parseFloat(item.unitPrice || 0);
            const qty = parseFloat(item.availableQuantity || 0);
            return sum + (price * qty);
        }, 0);

        analysis.inventory.totalValue = totalValue;
    }

    // âœ… MARKET ANALYSIS
    if (data.transactions && data.transactions.length > 0) {
        const pending = data.transactions.filter(t => 
            t.status === 'PENDING' || t.transactionStatus === 'PENDING'
        );

        const completed = data.transactions.filter(t => 
            t.status === 'PAID' || t.status === 'COMPLETED' || 
            t.transactionStatus === 'PAID' || t.transactionStatus === 'COMPLETED'
        );

        if (pending.length > completed.length) {
            analysis.market.insights.push({
                type: 'PENDING_TRANSACTIONS',
                message: `${pending.length} pending transactions need attention`,
                recommendation: 'Follow up on pending transactions for timely payments'
            });
        }

        const totalRevenue = completed.reduce((sum, t) => {
            return sum + parseFloat(t.totalAmount || 0);
        }, 0);

        analysis.market.totalRevenue = totalRevenue;
    }

    // âœ… SOIL ANALYSIS
    if (data.soil && data.soil.length > 0) {
        const recentSoil = data.soil.slice(0, 5);
        const avgPh = recentSoil
            .map(s => parseFloat(s.phLevel))
            .filter(p => !isNaN(p))
            .reduce((a, b) => a + b, 0) / recentSoil.length;

        if (avgPh < 6.0 || avgPh > 7.5) {
            analysis.soil.issues.push({
                type: 'PH_IMBALANCE',
                message: `Soil pH is ${avgPh.toFixed(2)} (optimal: 6.0-7.5)`,
                recommendation: avgPh < 6.0 ? 'Apply lime to raise pH' : 'Apply sulfur to lower pH'
            });
            analysis.soil.status = 'NEEDS_ATTENTION';
        }
    }

    // âœ… OVERALL HEALTH ASSESSMENT
    const riskCount = analysis.weather.risks.length + 
                     analysis.production.issues.length + 
                     analysis.inventory.warnings.length;

    if (riskCount > 5) {
        analysis.summary.overallHealth = 'NEEDS_ATTENTION';
        analysis.summary.riskLevel = 'HIGH';
    } else if (riskCount > 2) {
        analysis.summary.overallHealth = 'GOOD';
        analysis.summary.riskLevel = 'MEDIUM';
    }

    // Generate overall recommendations
    if (analysis.weather.status === 'CRITICAL') {
        analysis.summary.recommendations.push('âš ï¸ URGENT: Address weather-related risks immediately');
    }
    if (analysis.inventory.status === 'LOW') {
        analysis.summary.recommendations.push('ðŸ“¦ Restock inventory items with low stock levels');
    }
    if (analysis.production.status === 'INACTIVE') {
        analysis.summary.recommendations.push('ðŸŒ¾ Plan new crop productions for the season');
    }

    return analysis;
}

/**
 * Display AI analysis results
 */
function displayAIAnalysis(analysis) {
    const container = document.getElementById('aiAnalysisContainer');
    if (!container) return;

    const healthColors = {
        'GOOD': { color: '#22c55e', icon: 'fa-check-circle' },
        'NEEDS_ATTENTION': { color: '#f59e0b', icon: 'fa-exclamation-triangle' },
        'CRITICAL': { color: '#ef4444', icon: 'fa-times-circle' }
    };

    const healthStyle = healthColors[analysis.summary.overallHealth] || healthColors['GOOD'];

    container.innerHTML = `
        <div class="ai-analysis-content" style="padding: 20px;">
            <!-- Overall Health Summary -->
            <div class="analysis-section" style="margin-bottom: 32px;">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-heartbeat" style="color: ${healthStyle.color};"></i>
                    Overall Farm Health
                </h4>
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px; padding: 16px; background: ${healthStyle.color}15; border-left: 4px solid ${healthStyle.color}; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas ${healthStyle.icon}" style="font-size: 2rem; color: ${healthStyle.color};"></i>
                            <div>
                                <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Status</div>
                                <div style="font-size: 20px; font-weight: 700; color: ${healthStyle.color};">${analysis.summary.overallHealth}</div>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 200px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-shield-alt" style="font-size: 2rem; color: #3b82f6;"></i>
                            <div>
                                <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Risk Level</div>
                                <div style="font-size: 20px; font-weight: 700; color: #3b82f6;">${analysis.summary.riskLevel}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weather Analysis -->
            ${analysis.weather.risks.length > 0 || Object.keys(analysis.weather.trends).length > 0 ? `
            <div class="analysis-section" style="margin-bottom: 32px;">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-cloud-sun" style="color: #3b82f6;"></i>
                    Weather Analysis
                </h4>
                ${analysis.weather.risks.map(risk => `
                    <div style="padding: 12px 16px; background: ${risk.severity === 'HIGH' || risk.severity === 'CRITICAL' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; border-left: 4px solid ${risk.severity === 'HIGH' || risk.severity === 'CRITICAL' ? '#ef4444' : '#f59e0b'}; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${risk.type.replace('_', ' ')}</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${risk.message}</div>
                        <div style="color: var(--text-primary); font-size: 13px; font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: #ffc107;"></i> ${risk.recommendation}
                        </div>
                    </div>
                `).join('')}
                ${Object.keys(analysis.weather.trends).length > 0 ? `
                    <div style="padding: 12px 16px; background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--primary-green); border-radius: 8px; margin-top: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">Weather Trends</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            ${Object.entries(analysis.weather.trends).map(([key, value]) => `
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">${key}</div>
                                    <div style="font-weight: 700; color: var(--text-primary);">${value}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
            ` : ''}

            <!-- Production Analysis -->
            ${analysis.production.issues.length > 0 || analysis.production.opportunities.length > 0 ? `
            <div class="analysis-section" style="margin-bottom: 32px;">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-seedling" style="color: var(--primary-green);"></i>
                    Production Analysis
                </h4>
                ${analysis.production.issues.map(issue => `
                    <div style="padding: 12px 16px; background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${issue.type.replace('_', ' ')}</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${issue.message}</div>
                        <div style="color: var(--text-primary); font-size: 13px; font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: #ffc107;"></i> ${issue.recommendation}
                        </div>
                    </div>
                `).join('')}
                ${analysis.production.opportunities.map(opp => `
                    <div style="padding: 12px 16px; background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--primary-green); border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${opp.type.replace('_', ' ')}</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${opp.message}</div>
                        <div style="color: var(--text-primary); font-size: 13px; font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: var(--primary-green);"></i> ${opp.recommendation}
                        </div>
                    </div>
                `).join('')}
            </div>
            ` : ''}

            <!-- Inventory Analysis -->
            ${analysis.inventory.warnings.length > 0 || analysis.inventory.totalValue ? `
            <div class="analysis-section" style="margin-bottom: 32px;">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-boxes" style="color: #8b5cf6;"></i>
                    Inventory Analysis
                </h4>
                ${analysis.inventory.totalValue ? `
                    <div style="padding: 12px 16px; background: rgba(139, 92, 246, 0.1); border-left: 4px solid #8b5cf6; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary);">Total Inventory Value</div>
                        <div style="font-size: 24px; font-weight: 700; color: #8b5cf6; margin-top: 4px;">${formatCurrency(analysis.inventory.totalValue)}</div>
                    </div>
                ` : ''}
                ${analysis.inventory.warnings.map(warning => `
                    <div style="padding: 12px 16px; background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${warning.type.replace('_', ' ')}</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${warning.message}</div>
                        <div style="color: var(--text-primary); font-size: 13px; font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: #ffc107;"></i> ${warning.recommendation}
                        </div>
                    </div>
                `).join('')}
            </div>
            ` : ''}

            <!-- Market Analysis -->
            ${analysis.market.insights.length > 0 || analysis.market.totalRevenue ? `
            <div class="analysis-section" style="margin-bottom: 32px;">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chart-line" style="color: #3b82f6;"></i>
                    Market Analysis
                </h4>
                ${analysis.market.totalRevenue ? `
                    <div style="padding: 12px 16px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary);">Total Revenue (Completed Transactions)</div>
                        <div style="font-size: 24px; font-weight: 700; color: #3b82f6; margin-top: 4px;">${formatCurrency(analysis.market.totalRevenue)}</div>
                    </div>
                ` : ''}
                ${analysis.market.insights.map(insight => `
                    <div style="padding: 12px 16px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${insight.type.replace('_', ' ')}</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${insight.message}</div>
                        <div style="color: var(--text-primary); font-size: 13px; font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: #3b82f6;"></i> ${insight.recommendation}
                        </div>
                    </div>
                `).join('')}
            </div>
            ` : ''}

            <!-- Soil Analysis -->
            ${analysis.soil.issues.length > 0 ? `
            <div class="analysis-section" style="margin-bottom: 32px;">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-mountain" style="color: #8b5cf6;"></i>
                    Soil Health Analysis
                </h4>
                ${analysis.soil.issues.map(issue => `
                    <div style="padding: 12px 16px; background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${issue.type.replace('_', ' ')}</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${issue.message}</div>
                        <div style="color: var(--text-primary); font-size: 13px; font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: #ffc107;"></i> ${issue.recommendation}
                        </div>
                    </div>
                `).join('')}
            </div>
            ` : ''}

            <!-- Overall Recommendations -->
            ${analysis.summary.recommendations.length > 0 ? `
            <div class="analysis-section">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-list-check" style="color: var(--primary-green);"></i>
                    Key Recommendations
                </h4>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${analysis.summary.recommendations.map((rec, index) => `
                        <div style="padding: 12px 16px; background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--primary-green); border-radius: 8px;">
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <span style="background: var(--primary-green); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0;">${index + 1}</span>
                                <div style="color: var(--text-primary); font-weight: 600; flex: 1;">${rec}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
        </div>
    `;
}

/**
 * View alert details
 */
async function viewAlertDetails(alertId) {
    try {
        showLoading();
        
        let alert = null;
        
        // âœ… Check if it's an AI-generated alert (starts with "AI-")
        if (alertId && alertId.startsWith('AI-')) {
            // Find the alert in our local data
            if (allAlertsData && allAlertsData.length > 0) {
                alert = allAlertsData.find(a => a.id === alertId);
            }
            
            if (!alert) {
                showToast('AI alert not found in local data', 'error');
                hideLoading();
                return;
            }
            
            console.log('âœ… Using AI-generated alert from local data:', alert);
        } else {
            // âœ… It's a database alert, fetch from API
            try {
                const response = await apiRequest(`/food-security-alerts/${alertId}`);
                
                // Handle different response formats
                if (response && response.data) {
                    alert = response.data;
                } else if (Array.isArray(response) && response.length > 0) {
                    alert = response[0];
                } else if (response && response.id) {
                    alert = response;
                } else {
                    alert = response;
                }
                
                if (!alert || !alert.id) {
                    showToast('Alert not found in database', 'error');
                    hideLoading();
                    return;
                }
                
                console.log('âœ… Loaded alert from database:', alert);
            } catch (apiError) {
                // If API fails, try to find in local data as fallback
                console.warn('âš ï¸ API call failed, trying local data:', apiError.message);
                if (allAlertsData && allAlertsData.length > 0) {
                    alert = allAlertsData.find(a => a.id === alertId);
                }
                
                if (!alert) {
                    showToast('Alert not found. It may have been removed.', 'error');
                    hideLoading();
                    return;
                }
            }
        }
        
        if (!alert) {
            showToast('Alert not found', 'error');
            hideLoading();
            return;
        }

        // Prepare alert data
        const alertLevel = alert.alertLevel || 'INFO';
        const levelLower = alertLevel.toLowerCase();
        const category = alert.alertCategory || alert.category || 'GENERAL';
        const description = alert.description || 'No description available';
        const alertDate = alert.alertDate ? formatDateTime(alert.alertDate) : 
                         (alert.createdAt ? formatDateTime(alert.createdAt) : 'N/A');
        const source = alert.source || 'System';
        const isAIGenerated = alert.isAIGenerated || alertId.startsWith('AI-');
        const recommendedActions = alert.recommendedActions || null;
        const affectedCrops = alert.affectedCrops ? 
            (typeof alert.affectedCrops === 'string' ? JSON.parse(alert.affectedCrops) : alert.affectedCrops) : 
            null;
        const severityScore = alert.severityScore || null;
        const affectedRegion = alert.affectedRegion || null;
        const affectedPopulation = alert.affectedPopulation || null;
        const economicImpact = alert.economicImpact || null;
        const mitigationMeasures = alert.mitigationMeasures || null;

        // Level colors
        const levelColors = {
            'critical': { color: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
            'high': { color: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
            'medium': { color: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
            'low': { color: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
            'info': { color: '#22c55e', bg: 'rgba(34, 197, 94, 0.1)' }
        };

        const levelStyle = levelColors[levelLower] || levelColors['info'];

        // Show alert details in modal
        const modalHTML = `
            <div class="modal-overlay show" id="alertDetailsModal" onclick="if(event.target === this) closeAlertModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${escapeHtml(alert.alertTitle || 'Alert Details')}
                            ${isAIGenerated ? `
                            <span class="ai-badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-left: 12px; display: inline-flex; align-items: center; gap: 4px;">
                                <i class="fas fa-brain"></i> AI Generated
                            </span>
                            ` : ''}
                        </h3>
                        <button class="modal-close" onclick="closeAlertModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <div class="details-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="detail-item" style="padding: 12px; background: ${levelStyle.bg}; border-radius: 8px;">
                                <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Alert Level</label>
                                <value>
                                    <span class="alert-level" style="background: ${levelStyle.color}; color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; display: inline-block;">
                                        ${alertLevel}
                                    </span>
                                </value>
                            </div>
                            <div class="detail-item" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Category</label>
                                <value style="font-weight: 600; color: var(--text-primary);">${category}</value>
                            </div>
                            <div class="detail-item" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Alert Date</label>
                                <value style="font-weight: 600; color: var(--text-primary);">${alertDate}</value>
                            </div>
                            <div class="detail-item" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Source</label>
                                <value style="font-weight: 600; color: var(--text-primary);">${escapeHtml(source)}</value>
                            </div>
                            ${severityScore ? `
                            <div class="detail-item" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Severity Score</label>
                                <value style="font-weight: 700; color: ${levelStyle.color}; font-size: 18px;">${severityScore}/10</value>
                            </div>
                            ` : ''}
                        </div>

                        ${affectedRegion ? `
                        <div class="detail-section" style="margin-bottom: 20px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px;">
                            <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Affected Region</label>
                            <value style="font-weight: 600; color: var(--text-primary);">${escapeHtml(affectedRegion)}</value>
                        </div>
                        ` : ''}

                        ${affectedPopulation ? `
                        <div class="detail-section" style="margin-bottom: 20px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; border-radius: 8px;">
                            <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Affected Population</label>
                            <value style="font-weight: 700; color: var(--text-primary); font-size: 18px;">${affectedPopulation.toLocaleString()}</value>
                        </div>
                        ` : ''}

                        <div class="detail-section" style="margin-bottom: 20px;">
                            <h4 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                Description
                            </h4>
                            <p style="color: var(--text-secondary); line-height: 1.8; padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin: 0;">
                                ${escapeHtml(description)}
                            </p>
                        </div>

                        ${affectedCrops && Array.isArray(affectedCrops) && affectedCrops.length > 0 ? `
                        <div class="detail-section" style="margin-bottom: 20px;">
                            <h4 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-seedling" style="color: var(--primary-green);"></i>
                                Affected Crops
                            </h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                                ${affectedCrops.map(crop => `
                                    <span style="background: rgba(34, 197, 94, 0.15); color: var(--primary-green); padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                                        ${escapeHtml(crop)}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${recommendedActions ? `
                        <div class="detail-section" style="margin-bottom: 20px;">
                            <h4 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-lightbulb" style="color: #ffc107;"></i>
                                Recommended Actions
                            </h4>
                            <div style="white-space: pre-line; padding: 16px; background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); border-left: 4px solid #ffc107; border-radius: 8px; color: #666; line-height: 1.8;">
                                ${escapeHtml(recommendedActions)}
                            </div>
                        </div>
                        ` : ''}

                        ${mitigationMeasures ? `
                        <div class="detail-section" style="margin-bottom: 20px;">
                            <h4 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-shield-alt" style="color: #3b82f6;"></i>
                                Mitigation Measures
                            </h4>
                            <div style="white-space: pre-line; padding: 16px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px; color: #666; line-height: 1.8;">
                                ${escapeHtml(mitigationMeasures)}
                            </div>
                        </div>
                        ` : ''}

                        ${economicImpact ? `
                        <div class="detail-section" style="margin-bottom: 20px; padding: 16px; background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; border-radius: 8px;">
                            <h4 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-dollar-sign" style="color: #ef4444;"></i>
                                Economic Impact
                            </h4>
                            <value style="font-weight: 700; color: #ef4444; font-size: 20px;">${formatCurrency(economicImpact)}</value>
                        </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeAlertModal()">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

    } catch (error) {
        console.error('âŒ Error loading alert details:', error);
        showToast('Error loading alert details: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Close alert modal
 */
function closeAlertModal() {
    const modal = document.getElementById('alertDetailsModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}






/**
 * Load policies data - VERSION ULTRA-ROBUSTE
 */
// Store policies globally for filtering
let allPoliciesData = [];

/**
 * Load policies data - IMPROVED VERSION
 */
async function loadPoliciesData() {
  try {
    showLoading();
    console.log('ðŸ”„ Loading policies data...');

    // âœ… STEP 1: Try to get active policies first (most relevant for farmers)
    let policies = [];
    try {
      console.log('ðŸ”„ Fetching active policies...');
      const activeResponse = await apiRequest('/policies/active');
      
      // Handle different response formats
      if (activeResponse) {
        if (Array.isArray(activeResponse)) {
          policies = activeResponse;
        } else if (activeResponse.data && Array.isArray(activeResponse.data)) {
          policies = activeResponse.data;
        } else if (activeResponse.content && Array.isArray(activeResponse.content)) {
          policies = activeResponse.content;
        }
      }
      
      console.log(`âœ… Loaded ${policies.length} active policies`);
    } catch (error) {
      console.warn('âš ï¸ Error loading active policies, trying all policies:', error.message);
      
      // âœ… STEP 2: Fallback to all policies if active fails
      try {
        const response = await apiRequest('/policies?page=0&size=100');
        
        if (response) {
          if (Array.isArray(response)) {
            policies = response;
          } else if (response.data) {
            if (Array.isArray(response.data)) {
              policies = response.data;
            } else if (response.data.content && Array.isArray(response.data.content)) {
              policies = response.data.content;
            }
          } else if (response.content && Array.isArray(response.content)) {
            policies = response.content;
          }
        }
        
        console.log(`âœ… Loaded ${policies.length} policies (fallback)`);
      } catch (fallbackError) {
        console.error('âŒ Error loading policies (fallback):', fallbackError);
        policies = [];
      }
    }

    // âœ… STEP 3: Filter to show only ACTIVE policies by default
    const activePolicies = policies.filter(p => 
      p.status === 'ACTIVE' || 
      (p.effectiveDate && new Date(p.effectiveDate) <= new Date() && 
       (!p.expiryDate || new Date(p.expiryDate) >= new Date()))
    );

    // Store all policies for filtering
    allPoliciesData = policies;

    console.log(`âœ… Total policies: ${policies.length}, Active: ${activePolicies.length}`);

    // âœ… STEP 4: Update statistics
    updatePoliciesStatistics(policies);

    // âœ… STEP 5: Display policies (show active by default)
    displayPoliciesGrid(activePolicies.length > 0 ? activePolicies : policies);

    if (policies.length > 0) {
      showToast(`âœ… Loaded ${policies.length} policies`, 'success');
    }

  } catch (error) {
    console.error('âŒ Error in loadPoliciesData:', error);
    showToast('Unable to load policies: ' + error.message, 'error');
    displayEmptyPoliciesState('Error loading policies. Please try again.');
  } finally {
    hideLoading();
  }
}

/**
 * Update policies statistics
 */
function updatePoliciesStatistics(policies) {
  if (!policies || policies.length === 0) {
    return;
  }

  const active = policies.filter(p => p.status === 'ACTIVE').length;
  const expired = policies.filter(p => p.status === 'EXPIRED').length;
  const draft = policies.filter(p => p.status === 'DRAFT').length;
  
  // Calculate total budget
  const totalBudget = policies
    .filter(p => p.status === 'ACTIVE' && p.totalBudget)
    .reduce((sum, p) => sum + parseFloat(p.totalBudget || 0), 0);

  console.log(`ðŸ“Š Policies Stats: ${active} active, ${expired} expired, ${draft} draft, Budget: ${formatCurrency(totalBudget)}`);
}

/**
 * Display policies grid - IMPROVED VERSION WITH BETTER DESIGN
 */
function displayPoliciesGrid(policies) {
  const container = document.getElementById('policiesGrid');
  if (!container) {
    console.warn('âš ï¸ policiesGrid container not found');
    return;
  }

  if (!policies || policies.length === 0) {
    displayEmptyPoliciesState('No policies available at the moment.');
    return;
  }

  console.log(`ðŸ“Š Displaying ${policies.length} policies`);

  container.innerHTML = policies.map(policy => {
    // âœ… Validation stricte de chaque policy
    if (!policy || !policy.policyName) {
      console.warn('âš ï¸ Invalid policy data:', policy);
      return '';
    }

    const policyName = policy.policyName || 'Unnamed Policy';
    const policyCode = policy.policyCode || '';
    const policyType = policy.policyType || 'N/A';
    const policyCategory = policy.policyCategory || 'GENERAL';
    const description = policy.description || 'No description available';
    const eligibility = policy.eligibilityCriteria || policy.targetBeneficiaries || null;
    const benefits = policy.benefits || null;
    const deadline = policy.applicationDeadline ? formatDate(policy.applicationDeadline) : null;
    const effectiveDate = policy.effectiveDate ? formatDate(policy.effectiveDate) : null;
    const expiryDate = policy.expiryDate ? formatDate(policy.expiryDate) : null;
    const status = policy.status || 'UNKNOWN';
    const statusLower = status.toLowerCase();
    const policyId = policy.id || '';
    const totalBudget = policy.totalBudget ? formatCurrency(policy.totalBudget) : null;
    const implementingAgency = policy.implementingAgency || null;
    const geographicScope = policy.geographicScope || null;

    // Status colors
    const statusColors = {
      'active': { bg: 'rgba(34, 197, 94, 0.15)', border: '#22c55e', text: '#22c55e' },
      'expired': { bg: 'rgba(107, 114, 128, 0.15)', border: '#6b7280', text: '#6b7280' },
      'draft': { bg: 'rgba(245, 158, 11, 0.15)', border: '#f59e0b', text: '#f59e0b' },
      'unknown': { bg: 'rgba(59, 130, 246, 0.15)', border: '#3b82f6', text: '#3b82f6' }
    };

    const statusStyle = statusColors[statusLower] || statusColors['unknown'];

    // Type icons
    const typeIcons = {
      'SUBSIDY': 'fa-hand-holding-usd',
      'CREDIT_PROGRAM': 'fa-credit-card',
      'INSURANCE': 'fa-shield-alt',
      'REGULATION': 'fa-gavel',
      'SUPPORT_PROGRAM': 'fa-hands-helping'
    };

    const typeIcon = typeIcons[policyType] || 'fa-file-alt';

    // Check if expiring soon (within 30 days)
    const isExpiringSoon = expiryDate && new Date(expiryDate) > new Date() && 
                          new Date(expiryDate) <= new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);

    return `
      <div class="policy-card" style="background: var(--card-bg); border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border: 2px solid transparent; overflow: hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative;">
        ${isExpiringSoon ? `
        <div style="position: absolute; top: 0; right: 0; background: linear-gradient(135deg, #f59e0b, #f97316); color: white; padding: 4px 12px; border-radius: 0 0 0 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; z-index: 10;">
          <i class="fas fa-clock"></i> Expiring Soon
        </div>
        ` : ''}
        
        <div class="policy-header" style="padding: 24px 24px 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%); border-bottom: 2px solid rgba(34, 197, 94, 0.1);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
            <div style="flex: 1;">
              <span class="policy-type-badge" style="display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">
                <i class="fas ${typeIcon}"></i> ${policyType.replace('_', ' ')}
              </span>
              <h3 class="policy-title" style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin: 0; line-height: 1.3;">
                ${escapeHtml(policyName)}
              </h3>
              ${policyCode ? `
              <p style="font-size: 12px; color: var(--text-secondary); margin: 4px 0 0 0;">
                <i class="fas fa-hashtag"></i> ${escapeHtml(policyCode)}
              </p>
              ` : ''}
            </div>
            <span class="status-badge" style="background: ${statusStyle.bg}; color: ${statusStyle.text}; border: 2px solid ${statusStyle.border}; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; white-space: nowrap;">
              ${status}
            </span>
          </div>
        </div>

        <div class="policy-body" style="padding: 20px 24px;">
          <p class="policy-description" style="color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
            ${escapeHtml(description.substring(0, 200))}${description.length > 200 ? '...' : ''}
          </p>

          <div class="policy-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
            ${effectiveDate ? `
            <div class="policy-detail-item" style="padding: 12px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; border-radius: 8px;">
              <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">
                <i class="fas fa-calendar-check" style="color: #3b82f6;"></i> Effective Date
              </label>
              <value style="font-weight: 700; color: var(--text-primary); font-size: 14px;">${effectiveDate}</value>
            </div>
            ` : ''}
            
            ${expiryDate ? `
            <div class="policy-detail-item" style="padding: 12px; background: ${isExpiringSoon ? 'rgba(245, 158, 11, 0.1)' : 'rgba(107, 114, 128, 0.1)'}; border-left: 3px solid ${isExpiringSoon ? '#f59e0b' : '#6b7280'}; border-radius: 8px;">
              <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">
                <i class="fas fa-calendar-times" style="color: ${isExpiringSoon ? '#f59e0b' : '#6b7280'};"></i> Expiry Date
              </label>
              <value style="font-weight: 700; color: var(--text-primary); font-size: 14px;">${expiryDate}</value>
            </div>
            ` : ''}
            
            ${totalBudget ? `
            <div class="policy-detail-item" style="padding: 12px; background: rgba(34, 197, 94, 0.1); border-left: 3px solid var(--primary-green); border-radius: 8px;">
              <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">
                <i class="fas fa-dollar-sign" style="color: var(--primary-green);"></i> Total Budget
              </label>
              <value style="font-weight: 700; color: var(--text-primary); font-size: 14px;">${totalBudget}</value>
            </div>
            ` : ''}
            
            ${implementingAgency ? `
            <div class="policy-detail-item" style="padding: 12px; background: rgba(139, 92, 246, 0.1); border-left: 3px solid #8b5cf6; border-radius: 8px;">
              <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">
                <i class="fas fa-building" style="color: #8b5cf6;"></i> Agency
              </label>
              <value style="font-weight: 600; color: var(--text-primary); font-size: 13px;">${escapeHtml(implementingAgency.substring(0, 30))}${implementingAgency.length > 30 ? '...' : ''}</value>
            </div>
            ` : ''}
          </div>

          ${eligibility ? `
          <div style="padding: 12px; background: rgba(59, 130, 246, 0.05); border-left: 3px solid #3b82f6; border-radius: 8px; margin-bottom: 16px;">
            <strong style="font-size: 12px; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
              <i class="fas fa-users" style="color: #3b82f6;"></i> Eligibility
            </strong>
            <p style="color: var(--text-secondary); font-size: 13px; margin: 0; line-height: 1.6;">
              ${escapeHtml(typeof eligibility === 'string' ? eligibility.substring(0, 150) : JSON.stringify(eligibility).substring(0, 150))}${(typeof eligibility === 'string' ? eligibility.length : JSON.stringify(eligibility).length) > 150 ? '...' : ''}
            </p>
          </div>
          ` : ''}

          ${benefits ? `
          <div style="padding: 12px; background: rgba(34, 197, 94, 0.05); border-left: 3px solid var(--primary-green); border-radius: 8px; margin-bottom: 16px;">
            <strong style="font-size: 12px; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
              <i class="fas fa-gift" style="color: var(--primary-green);"></i> Benefits
            </strong>
            <p style="color: var(--text-secondary); font-size: 13px; margin: 0; line-height: 1.6;">
              ${escapeHtml(benefits.substring(0, 150))}${benefits.length > 150 ? '...' : ''}
            </p>
          </div>
          ` : ''}
        </div>

        <div class="policy-footer" style="padding: 16px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
          ${deadline ? `
          <div style="font-size: 12px; color: var(--text-secondary);">
            <i class="fas fa-clock" style="color: #f59e0b;"></i>
            <strong>Deadline:</strong> ${deadline}
          </div>
          ` : `
          <div style="font-size: 12px; color: var(--text-secondary);">
            <i class="fas fa-info-circle"></i>
            ${geographicScope || 'General Policy'}
          </div>
          `}
          <button class="btn btn-primary" onclick="viewPolicyDetails('${policyId}')" style="padding: 8px 20px; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            <i class="fas fa-eye"></i>
            View Details
          </button>
        </div>
      </div>
    `;
  }).filter(html => html !== '').join('');

  // Si aucune policy valide
  if (container.innerHTML.trim() === '') {
    displayEmptyPoliciesState('No valid policy data to display');
  }
}

/**
 * Display empty policies state
 */
function displayEmptyPoliciesState(message = null) {
  const container = document.getElementById('policiesGrid');
  if (container) {
    const defaultMessage = 'No policies available at the moment. Check back later for new agricultural policies and subsidies.';
    container.innerHTML = `
      <div class="empty-state" style="padding: 4rem 2rem; text-align: center;">
        <div style="width: 100px; height: 100px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-gavel" style="font-size: 3rem; color: var(--primary-green);"></i>
        </div>
        <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.5rem;">No Policies Available</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto;">
          ${message || defaultMessage}
        </p>
        <button class="btn btn-primary" onclick="loadPoliciesData()" style="margin-top: 1rem;">
          <i class="fas fa-sync-alt"></i>
          Refresh
        </button>
      </div>
    `;
  }
}




/**
 * View policy details - IMPROVED VERSION
 */
async function viewPolicyDetails(policyId) {
  if (!policyId) {
    showToast('âŒ Invalid policy ID', 'error');
    return;
  }

  try {
    showLoading();

    // âœ… Try to find in local data first (faster)
    let policy = null;
    if (allPoliciesData && allPoliciesData.length > 0) {
      policy = allPoliciesData.find(p => p.id === policyId || p.policyCode === policyId);
    }

    // âœ… If not found locally, fetch from API
    if (!policy) {
      try {
        const response = await apiRequest(`/policies/${policyId}`);
        
        // Handle different response formats
        if (response) {
          if (response.data) {
            policy = response.data;
          } else if (response.id || response.policyCode) {
            policy = response;
          } else if (Array.isArray(response) && response.length > 0) {
            policy = response[0];
          }
        }

        if (!policy) {
          // Try by policy code
          try {
            const codeResponse = await apiRequest(`/policies/code/${policyId}`);
            if (codeResponse && codeResponse.data) {
              policy = codeResponse.data;
            } else if (codeResponse && codeResponse.id) {
              policy = codeResponse;
            }
          } catch (codeError) {
            console.warn('âš ï¸ Policy not found by code:', codeError.message);
          }
        }
      } catch (apiError) {
        console.error('âŒ Error loading policy from API:', apiError);
        // If API fails, try local data again
        if (allPoliciesData && allPoliciesData.length > 0) {
          policy = allPoliciesData.find(p => p.id === policyId || p.policyCode === policyId);
        }
      }
    }

    if (!policy) {
      showToast('âŒ Policy not found', 'error');
      hideLoading();
      return;
    }

    console.log('âœ… Policy loaded:', policy);
    showPolicyDetailsModal(policy);

  } catch (error) {
    console.error('âŒ Error in viewPolicyDetails:', error);
    showToast('âŒ Error loading policy details: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}




/**
 * Show policy details modal - VERSION CORRIGÃ‰E
 */
function showPolicyDetailsModal(policy) {
  if (!policy) {
    showToast('âŒ Invalid policy data', 'error');
    return;
  }

  // âœ… Mapping des champs corrects selon le modÃ¨le backend
  const policyName = policy.policyName || 'Unnamed Policy';
  const policyCode = policy.policyCode || 'N/A';
  const policyType = policy.policyType || 'N/A';
  const policyCategory = policy.policyCategory || 'N/A';
  const status = policy.status || 'UNKNOWN';
  const statusLower = status.toLowerCase();

  const description = policy.description || 'No description available';
  const objectives = policy.objectives || null;
  const targetBeneficiaries = policy.targetBeneficiaries || null;
  const eligibilityCriteria = policy.eligibilityCriteria || null;
  const benefits = policy.benefits || null;
  const applicationProcedure = policy.applicationProcedure || null;
  const requiredDocuments = policy.requiredDocuments || null;
  const implementingAgency = policy.implementingAgency || null;
  const contactInformation = policy.contactInformation || null;
  const geographicScope = policy.geographicScope || null;

  const effectiveDate = policy.effectiveDate ? formatDate(policy.effectiveDate) : 'N/A';
  const expiryDate = policy.expiryDate ? formatDate(policy.expiryDate) : 'N/A';
  const lastReviewDate = policy.lastReviewDate ? formatDate(policy.lastReviewDate) : null;
  const nextReviewDate = policy.nextReviewDate ? formatDate(policy.nextReviewDate) : null;

  const totalBudgetAllocated = policy.totalBudgetAllocated
    ? formatCurrency(policy.totalBudgetAllocated)
    : null;
  const budgetUtilized = policy.budgetUtilized
    ? formatCurrency(policy.budgetUtilized)
    : null;
  const totalBeneficiaries = policy.totalBeneficiaries || null;
  const utilizationRate = policy.utilizationRate || null;

  const isClimateSmartCompliant = policy.isClimateSmartCompliant || false;
  const isYouthFocused = policy.isYouthFocused || false;

  const modalHTML = `
    <div class="modal-overlay show" id="policyModal" onclick="if(event.target === this) closePolicyModal()">
      <div class="modal-container modal-large">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-gavel"></i>
            ${policyName}
          </h3>
          <button class="modal-close" onclick="closePolicyModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="policy-full-details">

            <!-- Basic Information -->
            <div class="detail-section">
              <h4><i class="fas fa-info-circle"></i> Policy Information</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <label>Policy Code:</label>
                  <value>${policyCode}</value>
                </div>
                <div class="detail-item">
                  <label>Type:</label>
                  <value>${policyType}</value>
                </div>
                <div class="detail-item">
                  <label>Category:</label>
                  <value>${policyCategory}</value>
                </div>
                <div class="detail-item">
                  <label>Status:</label>
                  <value><span class="status-badge status-${statusLower}">${status}</span></value>
                </div>
                <div class="detail-item">
                  <label>Effective Date:</label>
                  <value>${effectiveDate}</value>
                </div>
                <div class="detail-item">
                  <label>Expiry Date:</label>
                  <value>${expiryDate}</value>
                </div>
                ${geographicScope ? `
                <div class="detail-item">
                  <label>Geographic Scope:</label>
                  <value>${geographicScope}</value>
                </div>
                ` : ''}
                ${implementingAgency ? `
                <div class="detail-item">
                  <label>Implementing Agency:</label>
                  <value>${implementingAgency}</value>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Description -->
            <div class="detail-section">
              <h4><i class="fas fa-file-alt"></i> Description</h4>
              <p>${description}</p>
            </div>

            <!-- Objectives -->
            ${objectives ? `
            <div class="detail-section">
              <h4><i class="fas fa-bullseye"></i> Objectives</h4>
              <p>${objectives}</p>
            </div>
            ` : ''}

            <!-- Target Beneficiaries -->
            ${targetBeneficiaries ? `
            <div class="detail-section">
              <h4><i class="fas fa-users"></i> Target Beneficiaries</h4>
              <p>${targetBeneficiaries}</p>
            </div>
            ` : ''}

            <!-- Eligibility Criteria -->
            ${eligibilityCriteria ? `
            <div class="detail-section">
              <h4><i class="fas fa-check-circle"></i> Eligibility Criteria</h4>
              <p>${eligibilityCriteria}</p>
            </div>
            ` : ''}

            <!-- Benefits -->
            ${benefits ? `
            <div class="detail-section">
              <h4><i class="fas fa-gift"></i> Benefits</h4>
              <p>${benefits}</p>
            </div>
            ` : ''}

            <!-- Application Procedure -->
            ${applicationProcedure ? `
            <div class="detail-section">
              <h4><i class="fas fa-clipboard-list"></i> Application Procedure</h4>
              <p>${applicationProcedure}</p>
            </div>
            ` : ''}

            <!-- Required Documents -->
            ${requiredDocuments ? `
            <div class="detail-section">
              <h4><i class="fas fa-file-pdf"></i> Required Documents</h4>
              <p>${requiredDocuments}</p>
            </div>
            ` : ''}

            <!-- Budget Information -->
            ${totalBudgetAllocated || budgetUtilized ? `
            <div class="detail-section">
              <h4><i class="fas fa-money-bill-wave"></i> Budget Information</h4>
              <div class="details-grid">
                ${totalBudgetAllocated ? `
                <div class="detail-item">
                  <label>Total Budget Allocated:</label>
                  <value>${totalBudgetAllocated}</value>
                </div>
                ` : ''}
                ${budgetUtilized ? `
                <div class="detail-item">
                  <label>Budget Utilized:</label>
                  <value>${budgetUtilized}</value>
                </div>
                ` : ''}
                ${utilizationRate ? `
                <div class="detail-item">
                  <label>Utilization Rate:</label>
                  <value>${utilizationRate}%</value>
                </div>
                ` : ''}
              </div>
            </div>
            ` : ''}

            <!-- Performance Metrics -->
            ${totalBeneficiaries ? `
            <div class="detail-section">
              <h4><i class="fas fa-chart-line"></i> Performance Metrics</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <label>Total Beneficiaries:</label>
                  <value>${totalBeneficiaries.toLocaleString()}</value>
                </div>
              </div>
            </div>
            ` : ''}

            <!-- Review Dates -->
            ${lastReviewDate || nextReviewDate ? `
            <div class="detail-section">
              <h4><i class="fas fa-calendar-check"></i> Review Schedule</h4>
              <div class="details-grid">
                ${lastReviewDate ? `
                <div class="detail-item">
                  <label>Last Review Date:</label>
                  <value>${lastReviewDate}</value>
                </div>
                ` : ''}
                ${nextReviewDate ? `
                <div class="detail-item">
                  <label>Next Review Date:</label>
                  <value>${nextReviewDate}</value>
                </div>
                ` : ''}
              </div>
            </div>
            ` : ''}

            <!-- Special Attributes -->
            ${isClimateSmartCompliant || isYouthFocused ? `
            <div class="detail-section">
              <h4><i class="fas fa-star"></i> Special Attributes</h4>
              <div class="badges-list">
                ${isClimateSmartCompliant ? `
                  <span class="badge badge-success">
                    <i class="fas fa-leaf"></i>
                    Climate Smart Compliant
                  </span>
                ` : ''}
                ${isYouthFocused ? `
                  <span class="badge badge-info">
                    <i class="fas fa-user-graduate"></i>
                    Youth Focused
                  </span>
                ` : ''}
              </div>
            </div>
            ` : ''}

            <!-- Contact Information -->
            ${contactInformation ? `
            <div class="detail-section">
              <h4><i class="fas fa-phone"></i> Contact Information</h4>
              <p>${contactInformation}</p>
            </div>
            ` : ''}

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closePolicyModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
          ${status === 'ACTIVE' && applicationProcedure ? `
            <button type="button" class="btn btn-primary" onclick="showApplicationInfo('${policy.id}')">
              <i class="fas fa-paper-plane"></i>
              How to Apply
            </button>
          ` : ''}
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Show application information
 */
function showApplicationInfo(policyId) {
  showToast('â„¹ï¸ Please contact the implementing agency for application details', 'info');
}

    /**
     * Close policy modal
     */
    function closePolicyModal() {
      document.getElementById('modalContainer').innerHTML = '';
    }

    /**
     * Apply for policy
     */
    function applyForPolicy(policyId) {
      showToast('Policy application feature - To be implemented', 'info');
    }

    // ============================================================================
    // AI RECOMMENDATIONS MODULE - COMPLETE IMPLEMENTATION
    // ============================================================================

    // Store recommendations globally for filtering
    let allRecommendationsData = [];
    let aiChatHistory = [];

    /**
     * Load recommendations data - IMPROVED VERSION
     */
    async function loadRecommendationsData() {
      try {
        showLoading();
        console.log('ðŸ¤– Loading AI recommendations...');

        if (!currentUser || !currentUser.id) {
          console.error('âŒ No current user found');
          displayEmptyRecommendationsState('No user session found. Please login again.');
          hideLoading();
          return;
        }

        const farmerId = currentUser.id;

        // âœ… STEP 1: Get recommendations from database
        let databaseRecommendations = [];
        try {
          const response = await apiRequest(`/ai-recommendations/farmer/${farmerId}`);
          
          if (Array.isArray(response)) {
            databaseRecommendations = response;
          } else if (response && response.data && Array.isArray(response.data)) {
            databaseRecommendations = response.data;
          } else if (response && response.content && Array.isArray(response.content)) {
            databaseRecommendations = response.content;
          }
          
          console.log(`âœ… Loaded ${databaseRecommendations.length} recommendations from database`);
        } catch (error) {
          console.warn('âš ï¸ Error loading recommendations from database:', error.message);
          databaseRecommendations = [];
        }

        // âœ… STEP 2: Generate AI recommendations based on real data
        console.log('ðŸ¤– Generating AI recommendations based on real farm data...');
        const aiRecommendations = await generateAIRecommendationsFromData();

        // âœ… STEP 3: Combine database and AI recommendations
        const allRecommendations = [...databaseRecommendations, ...aiRecommendations];
        
        // Sort by priority and confidence
        allRecommendations.sort((a, b) => {
          const priorityOrder = { 'URGENT': 4, 'HIGH': 3, 'MEDIUM': 2, 'LOW': 1 };
          const aPriority = priorityOrder[a.priority] || 0;
          const bPriority = priorityOrder[b.priority] || 0;
          if (aPriority !== bPriority) return bPriority - aPriority;
          
          const aConfidence = a.confidenceScore || 0;
          const bConfidence = b.confidenceScore || 0;
          return bConfidence - aConfidence;
        });

        console.log(`âœ… Total recommendations: ${allRecommendations.length} (${databaseRecommendations.length} from DB, ${aiRecommendations.length} AI-generated)`);

        // âœ… STEP 4: Store globally for filtering
        allRecommendationsData = allRecommendations;

        // âœ… STEP 5: Update statistics
        updateRecommendationsStatistics(allRecommendations);

        // âœ… STEP 6: Display recommendations
        displayRecommendationsGrid(allRecommendations);

        // âœ… STEP 7: Render comparison charts
        renderComparisonCharts();

        if (allRecommendations.length > 0) {
          showToast(`âœ… Loaded ${allRecommendations.length} recommendations`, 'success');
        }

      } catch (error) {
        console.error('âŒ Error loading recommendations:', error);
        showToast('Error loading recommendations: ' + error.message, 'error');
        displayEmptyRecommendationsState('Error loading recommendations. Please try again.');
      } finally {
        hideLoading();
      }
    }

    /**
     * Generate AI recommendations based on real farm data
     */
    async function generateAIRecommendationsFromData() {
      const recommendations = [];
      
      try {
        if (!currentUser || !currentUser.id) {
          return recommendations;
        }

        const farmerId = currentUser.id;

        // âœ… Collect all real data
        const [farms, productions, inventory, weatherData, transactions, soilData, fertilizerUsage, irrigationData] = await Promise.all([
          apiRequest(`/farms/farmer/${farmerId}/all`).catch(() => []),
          apiRequest(`/v1/crop-productions/farmer/${farmerId}`).catch(() => ({ data: [] })),
          apiRequest(`/inventory/farmer/${farmerId}`).catch(() => []),
          apiRequest(`/weather-data/recent?days=30`).catch(() => []),
          apiRequest(`/transactions/farmer/${farmerId}`).catch(() => []),
          apiRequest(`/soil-data/farmer/${farmerId}`).catch(() => []),
          apiRequest(`/fertilizer-usage/farmer/${farmerId}`).catch(() => []),
          apiRequest(`/irrigation-data/farmer/${farmerId}`).catch(() => [])
        ]);

        const farmsList = Array.isArray(farms) ? farms : [];
        const productionsList = Array.isArray(productions) ? productions : 
                               (productions.data && Array.isArray(productions.data) ? productions.data : []);
        const inventoryList = Array.isArray(inventory) ? inventory : [];
        const weatherList = Array.isArray(weatherData) ? weatherData : [];
        const transactionsList = Array.isArray(transactions) ? transactions : 
                                (transactions.content && Array.isArray(transactions.content) ? transactions.content : []);
        const soilList = Array.isArray(soilData) ? soilData : [];
        const fertilizerList = Array.isArray(fertilizerUsage) ? fertilizerUsage : [];
        const irrigationList = Array.isArray(irrigationData) ? irrigationData : [];

        console.log(`ðŸ“Š Analyzing: ${farmsList.length} farms, ${productionsList.length} productions, ${inventoryList.length} inventory, ${weatherList.length} weather, ${soilList.length} soil records`);

        // âœ… RECOMMENDATION 1: Fertilizer Optimization
        if (fertilizerList.length > 0) {
          const recentFertilizer = fertilizerList.slice(-5);
          const avgEffectiveness = recentFertilizer
            .map(f => parseFloat(f.effectivenessRating || 0))
            .filter(r => !isNaN(r))
            .reduce((a, b) => a + b, 0) / recentFertilizer.length;

          if (avgEffectiveness < 3) {
            recommendations.push({
              id: 'AI-FERTILIZER-' + Date.now(),
              farmerId: farmerId,
              recommendationType: 'FERTILIZER',
              title: 'Optimize Fertilizer Application',
              description: `Your recent fertilizer applications show an average effectiveness rating of ${avgEffectiveness.toFixed(1)}/5. Consider adjusting fertilizer types, quantities, or application timing based on soil analysis.`,
              actionItems: `1. Review soil test results\n2. Adjust fertilizer NPK ratios\n3. Consider organic alternatives\n4. Time applications with crop growth stages\n5. Monitor crop response`,
              priority: avgEffectiveness < 2 ? 'URGENT' : 'HIGH',
              confidenceScore: 0.85,
              generatedBy: 'AI Analysis System',
              isRead: false,
              isImplemented: false,
              isActive: true,
              validFrom: new Date().toISOString(),
              createdAt: new Date().toISOString()
            });
          }
        }

        // âœ… RECOMMENDATION 2: Irrigation Optimization
        if (irrigationList.length > 0) {
          const recentIrrigation = irrigationList.slice(-7);
          const avgEfficiency = recentIrrigation
            .map(i => parseFloat(i.waterEfficiency || 0))
            .filter(e => !isNaN(e))
            .reduce((a, b) => a + b, 0) / recentIrrigation.length;

          if (avgEfficiency < 70) {
            recommendations.push({
              id: 'AI-IRRIGATION-' + Date.now(),
              farmerId: farmerId,
              recommendationType: 'IRRIGATION',
              title: 'Improve Water Efficiency',
              description: `Your irrigation water efficiency is ${avgEfficiency.toFixed(1)}%. Consider implementing drip irrigation, scheduling based on weather forecasts, and monitoring soil moisture levels.`,
              actionItems: `1. Install soil moisture sensors\n2. Schedule irrigation during cooler hours\n3. Use mulching to retain moisture\n4. Consider drip irrigation systems\n5. Monitor weather forecasts`,
              priority: avgEfficiency < 50 ? 'URGENT' : 'HIGH',
              confidenceScore: 0.80,
              generatedBy: 'AI Analysis System',
              isRead: false,
              isImplemented: false,
              isActive: true,
              validFrom: new Date().toISOString(),
              createdAt: new Date().toISOString()
            });
          }
        }

        // âœ… RECOMMENDATION 3: Soil Health
        if (soilList.length > 0) {
          const recentSoil = soilList.slice(-3);
          const avgPh = recentSoil
            .map(s => parseFloat(s.phLevel))
            .filter(p => !isNaN(p))
            .reduce((a, b) => a + b, 0) / recentSoil.length;

          if (avgPh < 6.0 || avgPh > 7.5) {
            recommendations.push({
              id: 'AI-SOIL-' + Date.now(),
              farmerId: farmerId,
              recommendationType: 'SOIL_MANAGEMENT',
              title: 'Soil pH Adjustment Needed',
              description: `Your soil pH is ${avgPh.toFixed(2)} (optimal range: 6.0-7.5). ${avgPh < 6.0 ? 'Apply lime to raise pH.' : 'Apply sulfur to lower pH.'} This will improve nutrient availability and crop yields.`,
              actionItems: `1. Test soil pH regularly\n2. ${avgPh < 6.0 ? 'Apply agricultural lime' : 'Apply elemental sulfur'}\n3. Monitor pH changes over time\n4. Adjust fertilizer applications accordingly\n5. Consider organic matter amendments`,
              priority: 'HIGH',
              confidenceScore: 0.90,
              generatedBy: 'AI Analysis System',
              isRead: false,
              isImplemented: false,
              isActive: true,
              validFrom: new Date().toISOString(),
              createdAt: new Date().toISOString()
            });
          }
        }

        // âœ… RECOMMENDATION 4: Production Timing
        if (productionsList.length > 0) {
          const activeProductions = productionsList.filter(p => 
            p.status === 'ACTIVE' || p.status === 'IN_PROGRESS'
          );

          activeProductions.forEach(production => {
            if (production.expectedHarvestDate) {
              const harvestDate = new Date(production.expectedHarvestDate);
              const today = new Date();
              const daysUntilHarvest = Math.ceil((harvestDate - today) / (1000 * 60 * 60 * 24));

              if (daysUntilHarvest <= 30 && daysUntilHarvest > 0) {
                recommendations.push({
                  id: 'AI-HARVEST-' + Date.now() + '-' + production.id,
                  farmerId: farmerId,
                  cropProductionId: production.id,
                  recommendationType: 'HARVEST',
                  title: `Prepare for Harvest: ${production.cropName || 'Crop'}`,
                  description: `Your ${production.cropName || 'crop'} is expected to be ready for harvest in ${daysUntilHarvest} days. Start preparing harvesting equipment, storage facilities, and market connections.`,
                  actionItems: `1. Inspect crop maturity\n2. Prepare harvesting equipment\n3. Arrange storage facilities\n4. Contact buyers/markets\n5. Plan post-harvest handling\n6. Check weather forecasts`,
                  priority: daysUntilHarvest <= 7 ? 'URGENT' : 'HIGH',
                  confidenceScore: 0.75,
                  generatedBy: 'AI Analysis System',
                  isRead: false,
                  isImplemented: false,
                  isActive: true,
                  validFrom: new Date().toISOString(),
                  createdAt: new Date().toISOString()
                });
              }
            }
          });
        }

        // âœ… RECOMMENDATION 5: Weather Adaptation
        if (weatherList.length > 0) {
          const recentWeather = weatherList.slice(0, 7);
          const avgTemp = recentWeather
            .map(w => parseFloat(w.temperature))
            .filter(t => !isNaN(t))
            .reduce((a, b) => a + b, 0) / recentWeather.length;
          
          const totalRainfall = recentWeather
            .map(w => parseFloat(w.rainfall || 0))
            .filter(r => !isNaN(r))
            .reduce((a, b) => a + b, 0);

          if (avgTemp > 35 || totalRainfall < 5) {
            recommendations.push({
              id: 'AI-WEATHER-' + Date.now(),
              farmerId: farmerId,
              recommendationType: 'WEATHER_ADAPTATION',
              title: 'Weather Adaptation Required',
              description: `${avgTemp > 35 ? `High temperatures (${avgTemp.toFixed(1)}Â°C) detected.` : ''} ${totalRainfall < 5 ? `Low rainfall (${totalRainfall.toFixed(2)}mm) in the last 7 days.` : ''} Adjust your farming practices to adapt to current weather conditions.`,
              actionItems: `${avgTemp > 35 ? '1. Increase irrigation frequency\n2. Provide shade for sensitive crops\n3. Apply mulch to retain moisture\n' : ''}${totalRainfall < 5 ? '4. Schedule additional irrigation\n5. Monitor soil moisture daily\n6. Consider drought-resistant varieties\n' : ''}7. Check weather forecasts regularly`,
              priority: avgTemp > 40 || totalRainfall < 2 ? 'URGENT' : 'HIGH',
              confidenceScore: 0.85,
              generatedBy: 'AI Analysis System',
              isRead: false,
              isImplemented: false,
              isActive: true,
              validFrom: new Date().toISOString(),
              createdAt: new Date().toISOString()
            });
          }
        }

        // âœ… RECOMMENDATION 6: Inventory Management
        if (inventoryList.length > 0) {
          const lowStockItems = inventoryList.filter(item => {
            const available = parseFloat(item.availableQuantity || 0);
            const total = parseFloat(item.totalQuantity || 0);
            return available > 0 && total > 0 && (available / total) < 0.2;
          });

          if (lowStockItems.length > 0) {
            recommendations.push({
              id: 'AI-INVENTORY-' + Date.now(),
              farmerId: farmerId,
              recommendationType: 'GENERAL',
              title: 'Restock Inventory Items',
              description: `${lowStockItems.length} inventory item(s) have low stock levels (less than 20% remaining). Restock soon to avoid production delays.`,
              actionItems: `1. Review inventory levels\n2. Identify critical items\n3. Contact suppliers\n4. Plan restocking schedule\n5. Consider bulk purchasing for discounts`,
              priority: lowStockItems.length > 5 ? 'URGENT' : 'MEDIUM',
              confidenceScore: 0.70,
              generatedBy: 'AI Analysis System',
              isRead: false,
              isImplemented: false,
              isActive: true,
              validFrom: new Date().toISOString(),
              createdAt: new Date().toISOString()
            });
          }
        }

        // âœ… RECOMMENDATION 7: Market Timing
        if (transactionsList.length > 0) {
          const recentTransactions = transactionsList
            .filter(t => t.status === 'PAID' || t.status === 'COMPLETED')
            .slice(-10);
          
          if (recentTransactions.length > 0) {
            const avgPrice = recentTransactions
              .map(t => parseFloat(t.pricePerUnit || 0))
              .filter(p => !isNaN(p) && p > 0)
              .reduce((a, b) => a + b, 0) / recentTransactions.length;

            // Check if there are active productions that could be sold
            const activeProductions = productionsList.filter(p => 
              (p.status === 'ACTIVE' || p.status === 'IN_PROGRESS') && 
              p.expectedHarvestDate &&
              new Date(p.expectedHarvestDate) <= new Date(Date.now() + 60 * 24 * 60 * 60 * 1000)
            );

            if (activeProductions.length > 0 && avgPrice > 0) {
              recommendations.push({
                id: 'AI-MARKET-' + Date.now(),
                farmerId: farmerId,
                recommendationType: 'MARKET_TIMING',
                title: 'Market Timing Opportunity',
                description: `You have ${activeProductions.length} production(s) nearing harvest. Recent market prices average ${formatCurrency(avgPrice)} per unit. Consider pre-selling or timing your harvest to maximize profits.`,
                actionItems: `1. Monitor current market prices\n2. Contact potential buyers\n3. Consider pre-selling contracts\n4. Time harvest for optimal prices\n5. Compare prices across markets`,
                priority: 'MEDIUM',
                confidenceScore: 0.65,
                generatedBy: 'AI Analysis System',
                isRead: false,
                isImplemented: false,
                isActive: true,
                validFrom: new Date().toISOString(),
                createdAt: new Date().toISOString()
              });
            }
          }
        }

        console.log(`âœ… Generated ${recommendations.length} AI recommendations`);

      } catch (error) {
        console.error('âŒ Error generating AI recommendations:', error);
      }

      return recommendations;
    }

    /**
     * Generate comprehensive AI recommendations (called by button)
     */
    async function generateAIRecommendations() {
      try {
        const btn = document.getElementById('generateAIRecommendationsBtn');
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        }

        showLoading();
        showToast('ðŸ¤– Generating comprehensive AI recommendations...', 'info');

        // Generate and reload
        await loadRecommendationsData();

        showToast('âœ… AI recommendations generated successfully!', 'success');

      } catch (error) {
        console.error('âŒ Error generating recommendations:', error);
        showToast('âŒ Error generating recommendations: ' + error.message, 'error');
      } finally {
        const btn = document.getElementById('generateAIRecommendationsBtn');
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-brain"></i> Generate AI Analysis';
        }
        hideLoading();
      }
    }

    /**
     * Display recommendations grid
     */
    /**
     * Display recommendations grid - IMPROVED VERSION
     */
    function displayRecommendationsGrid(recommendations) {
      const container = document.getElementById('recommendationsGrid');
      if (!container) {
        console.warn('âš ï¸ recommendationsGrid container not found');
        return;
      }

      if (!recommendations || recommendations.length === 0) {
        displayEmptyRecommendationsState('No recommendations available. Click "Generate AI Analysis" to get personalized recommendations.');
        return;
      }

      console.log(`ðŸ“Š Displaying ${recommendations.length} recommendations`);

      container.innerHTML = recommendations.map(rec => {
        if (!rec || !rec.title) {
          return '';
        }

        const recType = rec.recommendationType || 'GENERAL';
        const priority = rec.priority || 'MEDIUM';
        const priorityLower = priority.toLowerCase();
        const confidence = rec.confidenceScore || 0.5;
        const isAIGenerated = rec.generatedBy === 'AI Analysis System' || rec.id.startsWith('AI-');
        const actionItems = rec.actionItems || '';

        // Priority colors
        const priorityColors = {
          'urgent': { bg: 'rgba(239, 68, 68, 0.15)', border: '#ef4444', text: '#ef4444' },
          'high': { bg: 'rgba(245, 158, 11, 0.15)', border: '#f59e0b', text: '#f59e0b' },
          'medium': { bg: 'rgba(59, 130, 246, 0.15)', border: '#3b82f6', text: '#3b82f6' },
          'low': { bg: 'rgba(139, 92, 246, 0.15)', border: '#8b5cf6', text: '#8b5cf6' }
        };

        const priorityStyle = priorityColors[priorityLower] || priorityColors['medium'];

        // Type icons
        const typeIcons = {
          'FERTILIZER': 'fa-seedling',
          'WATER': 'fa-tint',
          'IRRIGATION': 'fa-water',
          'SEEDS': 'fa-seedling',
          'PESTICIDE': 'fa-spray-can',
          'SOIL_MANAGEMENT': 'fa-mountain',
          'HARVEST': 'fa-hand-holding',
          'PLANTING': 'fa-seedling',
          'WEATHER_ADAPTATION': 'fa-cloud-sun',
          'MARKET_TIMING': 'fa-chart-line',
          'GENERAL': 'fa-lightbulb'
        };

        const typeIcon = typeIcons[recType] || 'fa-lightbulb';

        return `
          <div class="recommendation-card" style="background: var(--card-bg); border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border: 2px solid ${priorityStyle.border}; overflow: hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative;">
            ${isAIGenerated ? `
            <div style="position: absolute; top: 12px; right: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; z-index: 10;">
              <i class="fas fa-brain"></i> AI
            </div>
            ` : ''}
            
            <div class="recommendation-header" style="padding: 24px 24px 16px; background: linear-gradient(135deg, ${priorityStyle.bg}, rgba(255,255,255,0.1)); border-bottom: 2px solid ${priorityStyle.border};">
              <div style="display: flex; align-items: flex-start; gap: 16px;">
                <div style="width: 60px; height: 60px; background: ${priorityStyle.bg}; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                  <i class="fas ${typeIcon}" style="font-size: 28px; color: ${priorityStyle.border};"></i>
                </div>
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                    <div>
                      <span style="display: inline-block; background: ${priorityStyle.border}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px;">
                        ${recType.replace('_', ' ')}
                      </span>
                      <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin: 0; line-height: 1.3;">
                        ${escapeHtml(rec.title)}
                      </h3>
                    </div>
                    <span style="background: ${priorityStyle.bg}; color: ${priorityStyle.text}; border: 2px solid ${priorityStyle.border}; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; white-space: nowrap;">
                      ${priority}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="recommendation-body" style="padding: 20px 24px;">
              <p style="color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px;">
                ${escapeHtml(rec.description)}
              </p>

              ${actionItems ? `
              <div style="padding: 16px; background: rgba(34, 197, 94, 0.05); border-left: 4px solid var(--primary-green); border-radius: 8px; margin-bottom: 16px;">
                <strong style="font-size: 13px; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; margin-bottom: 12px;">
                  <i class="fas fa-tasks" style="color: var(--primary-green);"></i> Recommended Actions
                </strong>
                <div style="color: var(--text-secondary); font-size: 14px; line-height: 1.8; white-space: pre-line;">
                  ${escapeHtml(actionItems)}
                </div>
              </div>
              ` : ''}

              <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                <div style="flex: 1;">
                  <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px;">AI Confidence</div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="flex: 1; height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden;">
                      <div style="height: 100%; width: ${(confidence * 100)}%; background: linear-gradient(90deg, ${priorityStyle.border}, ${priorityStyle.text}); transition: width 0.3s;"></div>
                    </div>
                    <span style="font-weight: 700; color: ${priorityStyle.text}; font-size: 14px;">${(confidence * 100).toFixed(0)}%</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="recommendation-footer" style="padding: 16px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
              <div style="font-size: 12px; color: var(--text-secondary);">
                <i class="fas fa-calendar-alt" style="color: ${priorityStyle.border};"></i>
                ${rec.createdAt ? formatDateTime(rec.createdAt) : 'Just now'}
              </div>
              <div style="display: flex; gap: 8px;">
                ${!rec.isRead ? `
                <button class="btn btn-secondary btn-sm" onclick="markRecommendationAsRead('${rec.id}')" style="padding: 6px 14px; font-size: 12px;">
                  <i class="fas fa-check"></i> Mark Read
                </button>
                ` : ''}
                <button class="btn btn-primary btn-sm" onclick="viewRecommendationDetails('${rec.id}')" style="padding: 6px 14px; font-size: 12px;">
                  <i class="fas fa-eye"></i> Details
                </button>
              </div>
            </div>
          </div>
        `;
      }).filter(html => html !== '').join('');
    }

    /**
     * Update recommendations statistics
     */
    function updateRecommendationsStatistics(recommendations) {
      if (!recommendations || recommendations.length === 0) {
        updateElement('recommendationsTotalCount', '0');
        updateElement('recommendationsUrgentCount', '0');
        updateElement('recommendationsImplementedCount', '0');
        updateElement('aiConfidenceScore', '--');
        return;
      }

      const total = recommendations.length;
      const urgent = recommendations.filter(r => r.priority === 'URGENT').length;
      const implemented = recommendations.filter(r => r.isImplemented === true).length;
      const avgConfidence = recommendations
        .map(r => r.confidenceScore || 0)
        .reduce((a, b) => a + b, 0) / recommendations.length;

      updateElement('recommendationsTotalCount', total);
      updateElement('recommendationsUrgentCount', urgent);
      updateElement('recommendationsImplementedCount', implemented);
      updateElement('aiConfidenceScore', `${(avgConfidence * 100).toFixed(0)}%`);
    }

    /**
     * Display empty recommendations state
     */
    function displayEmptyRecommendationsState(message = null) {
      const container = document.getElementById('recommendationsGrid');
      if (container) {
        const defaultMessage = 'No recommendations available. Click "Generate AI Analysis" to get personalized recommendations based on your farm data.';
        container.innerHTML = `
          <div class="empty-state" style="padding: 4rem 2rem; text-align: center;">
            <div style="width: 100px; height: 100px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-brain" style="font-size: 3rem; color: #8b5cf6;"></i>
            </div>
            <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.5rem;">No Recommendations Available</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto;">
              ${message || defaultMessage}
            </p>
            <button class="btn btn-primary" onclick="generateAIRecommendations()" style="margin-top: 1rem;">
              <i class="fas fa-brain"></i>
              Generate AI Recommendations
            </button>
          </div>
        `;
      }
    }

    /**
     * Get recommendation icon
     */
    function getRecommendationIcon(type) {
      const icons = {
        'FERTILIZER': 'fa-seedling',
        'WATER': 'fa-tint',
        'IRRIGATION': 'fa-water',
        'SEEDS': 'fa-seedling',
        'PESTICIDE': 'fa-spray-can',
        'SOIL_MANAGEMENT': 'fa-mountain',
        'HARVEST': 'fa-hand-holding',
        'PLANTING': 'fa-seedling',
        'WEATHER_ADAPTATION': 'fa-cloud-sun',
        'MARKET_TIMING': 'fa-chart-line',
        'GENERAL': 'fa-lightbulb'
      };
      return icons[type] || 'fa-lightbulb';
    }

    /**
     * Mark recommendation as read
     */
    async function markRecommendationAsRead(recommendationId) {
      try {
        // Only mark DB recommendations, not AI-generated ones
        if (!recommendationId.startsWith('AI-')) {
          await apiRequest(`/ai-recommendations/${recommendationId}/read`, {
            method: 'PUT'
          });
        }

        // Update local data
        const rec = allRecommendationsData.find(r => r.id === recommendationId);
        if (rec) {
          rec.isRead = true;
          rec.readAt = new Date().toISOString();
        }

        // Re-display
        displayRecommendationsGrid(allRecommendationsData);
        updateRecommendationsStatistics(allRecommendationsData);

        showToast('âœ… Recommendation marked as read', 'success');
      } catch (error) {
        console.error('Error marking recommendation as read:', error);
        showToast('Error marking recommendation as read', 'error');
      }
    }

    /**
     * View recommendation details
     */
    function viewRecommendationDetails(recommendationId) {
      const rec = allRecommendationsData.find(r => r.id === recommendationId);
      if (!rec) {
        showToast('Recommendation not found', 'error');
        return;
      }

      // Show details in modal
      const modalHTML = `
        <div class="modal-overlay show" id="recommendationModal" onclick="if(event.target === this) closeRecommendationModal()">
          <div class="modal-container modal-large">
            <div class="modal-header">
              <h3 class="modal-title">
                <i class="fas fa-lightbulb"></i>
                ${escapeHtml(rec.title)}
              </h3>
              <button class="modal-close" onclick="closeRecommendationModal()" type="button">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 20px;">
                <span style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase;">
                  ${rec.recommendationType || 'GENERAL'}
                </span>
                <span style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; margin-left: 8px;">
                  ${rec.priority || 'MEDIUM'}
                </span>
              </div>
              <div style="margin-bottom: 20px;">
                <h4>Description</h4>
                <p style="color: var(--text-secondary); line-height: 1.8;">${escapeHtml(rec.description)}</p>
              </div>
              ${rec.actionItems ? `
              <div style="margin-bottom: 20px;">
                <h4>Recommended Actions</h4>
                <div style="padding: 16px; background: rgba(34, 197, 94, 0.05); border-left: 4px solid var(--primary-green); border-radius: 8px;">
                  <div style="white-space: pre-line; color: var(--text-secondary); line-height: 1.8;">${escapeHtml(rec.actionItems)}</div>
                </div>
              </div>
              ` : ''}
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Confidence Score</div>
                  <div style="font-size: 24px; font-weight: 700; color: var(--primary-green);">${((rec.confidenceScore || 0) * 100).toFixed(0)}%</div>
                </div>
                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Generated By</div>
                  <div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(rec.generatedBy || 'System')}</div>
                </div>
                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Created</div>
                  <div style="font-weight: 600; color: var(--text-primary);">${rec.createdAt ? formatDateTime(rec.createdAt) : 'N/A'}</div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeRecommendationModal()">
                <i class="fas fa-times"></i>
                Close
              </button>
              ${!rec.isRead ? `
              <button type="button" class="btn btn-primary" onclick="markRecommendationAsRead('${rec.id}'); closeRecommendationModal();">
                <i class="fas fa-check"></i>
                Mark as Read
              </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;

      document.getElementById('modalContainer').innerHTML = modalHTML;
    }

    /**
     * Close recommendation modal
     */
    function closeRecommendationModal() {
      const modal = document.getElementById('recommendationModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
          document.getElementById('modalContainer').innerHTML = '';
        }, 300);
      }
    }

    /**
     * Render comparison charts based on real data
     */
    async function renderComparisonCharts() {
      try {
        if (!currentUser || !currentUser.id) return;

        const farmerId = currentUser.id;

        // Collect data for charts
        const [productions, fertilizerUsage, irrigationData, transactions] = await Promise.all([
          apiRequest(`/v1/crop-productions/farmer/${farmerId}`).catch(() => ({ data: [] })),
          apiRequest(`/fertilizer-usage/farmer/${farmerId}`).catch(() => []),
          apiRequest(`/irrigation-data/farmer/${farmerId}`).catch(() => []),
          apiRequest(`/transactions/farmer/${farmerId}`).catch(() => [])
        ]);

        const productionsList = Array.isArray(productions) ? productions : 
                               (productions.data && Array.isArray(productions.data) ? productions.data : []);
        const fertilizerList = Array.isArray(fertilizerUsage) ? fertilizerUsage : [];
        const irrigationList = Array.isArray(irrigationData) ? irrigationData : [];
        const transactionsList = Array.isArray(transactions) ? transactions : 
                                (transactions.content && Array.isArray(transactions.content) ? transactions.content : []);

        // âœ… Chart 1: Production Trends
        renderProductionTrendsChart(productionsList);

        // âœ… Chart 2: Cost Analysis
        renderCostAnalysisChart(fertilizerList, irrigationList);

        // âœ… Chart 3: Yield Predictions
        renderYieldPredictionsChart(productionsList);

        // âœ… Chart 4: Resource Usage
        renderResourceUsageChart(fertilizerList, irrigationList);

      } catch (error) {
        console.error('âŒ Error rendering comparison charts:', error);
      }
    }

    /**
     * Render production trends chart
     */
    function renderProductionTrendsChart(productions) {
      const canvas = document.getElementById('productionTrendsChart');
      if (!canvas || !productions || productions.length === 0) return;

      // Group by month
      const monthlyData = {};
      productions.forEach(p => {
        if (p.plantingDate) {
          const date = new Date(p.plantingDate);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = { count: 0, totalYield: 0 };
          }
          monthlyData[monthKey].count++;
          monthlyData[monthKey].totalYield += parseFloat(p.expectedYield || 0);
        }
      });

      const labels = Object.keys(monthlyData).sort();
      const counts = labels.map(key => monthlyData[key].count);
      const yields = labels.map(key => monthlyData[key].totalYield);

      if (window.productionTrendsChart) {
        window.productionTrendsChart.destroy();
      }

      const ctx = canvas.getContext('2d');
      window.productionTrendsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Number of Productions',
            data: counts,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4
          }, {
            label: 'Total Expected Yield (KG)',
            data: yields,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.4,
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { position: 'left', title: { display: true, text: 'Number of Productions' } },
            y1: { position: 'right', title: { display: true, text: 'Yield (KG)' }, grid: { drawOnChartArea: false } }
          }
        }
      });
    }

    /**
     * Render cost analysis chart
     */
    function renderCostAnalysisChart(fertilizerList, irrigationList) {
      const canvas = document.getElementById('costAnalysisChart');
      if (!canvas) return;

      const fertilizerCost = fertilizerList.reduce((sum, f) => sum + parseFloat(f.totalCost || 0), 0);
      const irrigationCost = irrigationList.reduce((sum, i) => sum + parseFloat(i.totalCost || 0), 0);
      const totalCost = fertilizerCost + irrigationCost;

      if (window.costAnalysisChart) {
        window.costAnalysisChart.destroy();
      }

      const ctx = canvas.getContext('2d');
      window.costAnalysisChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Fertilizer', 'Irrigation'],
          datasets: [{
            data: [fertilizerCost, irrigationCost],
            backgroundColor: ['#3b82f6', '#22c55e'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const percentage = totalCost > 0 ? ((value / totalCost) * 100).toFixed(1) : 0;
                  return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    /**
     * Render yield predictions chart
     */
    function renderYieldPredictionsChart(productions) {
      const canvas = document.getElementById('yieldPredictionsChart');
      if (!canvas || !productions || productions.length === 0) return;

      const activeProductions = productions.filter(p => 
        p.status === 'ACTIVE' || p.status === 'IN_PROGRESS'
      );

      const labels = activeProductions.map(p => p.cropName || 'Unknown').slice(0, 10);
      const expectedYields = activeProductions.map(p => parseFloat(p.expectedYield || 0)).slice(0, 10);
      
      // Predict actual yield (with some variance)
      const predictedYields = expectedYields.map(yield => {
        // Predict based on historical data (simplified - in real scenario, use ML model)
        return yield * (0.85 + Math.random() * 0.3); // 85-115% of expected
      });

      if (window.yieldPredictionsChart) {
        window.yieldPredictionsChart.destroy();
      }

      const ctx = canvas.getContext('2d');
      window.yieldPredictionsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Expected Yield (KG)',
            data: expectedYields,
            backgroundColor: 'rgba(59, 130, 246, 0.6)'
          }, {
            label: 'AI Predicted Yield (KG)',
            data: predictedYields,
            backgroundColor: 'rgba(34, 197, 94, 0.6)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Yield (KG)' } }
          }
        }
      });
    }

    /**
     * Render resource usage chart
     */
    function renderResourceUsageChart(fertilizerList, irrigationList) {
      const canvas = document.getElementById('resourceUsageChart');
      if (!canvas) return;

      // Group by month
      const monthlyUsage = {};
      
      fertilizerList.forEach(f => {
        if (f.applicationDate) {
          const date = new Date(f.applicationDate);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyUsage[monthKey]) {
            monthlyUsage[monthKey] = { fertilizer: 0, water: 0 };
          }
          monthlyUsage[monthKey].fertilizer += parseFloat(f.quantity || 0);
        }
      });

      irrigationList.forEach(i => {
        if (i.irrigationDate) {
          const date = new Date(i.irrigationDate);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyUsage[monthKey]) {
            monthlyUsage[monthKey] = { fertilizer: 0, water: 0 };
          }
          monthlyUsage[monthKey].water += parseFloat(i.waterUsed || 0);
        }
      });

      const labels = Object.keys(monthlyUsage).sort().slice(-6);
      const fertilizerData = labels.map(key => monthlyUsage[key]?.fertilizer || 0);
      const waterData = labels.map(key => monthlyUsage[key]?.water || 0);

      if (window.resourceUsageChart) {
        window.resourceUsageChart.destroy();
      }

      const ctx = canvas.getContext('2d');
      window.resourceUsageChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Fertilizer (KG)',
            data: fertilizerData,
            backgroundColor: '#8b5cf6',
            yAxisID: 'y'
          }, {
            label: 'Water (Liters)',
            data: waterData,
            backgroundColor: '#3b82f6',
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { position: 'left', title: { display: true, text: 'Fertilizer (KG)' } },
            y1: { position: 'right', title: { display: true, text: 'Water (Liters)' }, grid: { drawOnChartArea: false } }
          }
        }
      });
    }

    /**
     * Send AI chat message
     */
    async function sendAIChatMessage() {
      const input = document.getElementById('aiChatInput');
      if (!input || !input.value.trim()) return;

      const question = input.value.trim();
      input.value = '';

      // Add user message to chat
      addChatMessage('user', question);

      // Show loading
      const sendBtn = document.getElementById('sendChatBtn');
      if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      }

      try {
        // Generate AI response based on real data
        const response = await generateAIResponse(question);
        addChatMessage('assistant', response);

      } catch (error) {
        console.error('Error generating AI response:', error);
        addChatMessage('assistant', 'I apologize, but I encountered an error. Please try again or rephrase your question.');
      } finally {
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
        }
      }
    }

    /**
     * Generate AI response based on question and real data
     */
    async function generateAIResponse(question) {
      const questionLower = question.toLowerCase();

      if (!currentUser || !currentUser.id) {
        return 'Please login to get personalized recommendations based on your farm data.';
      }

      const farmerId = currentUser.id;

      // Collect relevant data
      const [farms, productions, inventory, weatherData, soilData] = await Promise.all([
        apiRequest(`/farms/farmer/${farmerId}/all`).catch(() => []),
        apiRequest(`/v1/crop-productions/farmer/${farmerId}`).catch(() => ({ data: [] })),
        apiRequest(`/inventory/farmer/${farmerId}`).catch(() => []),
        apiRequest(`/weather-data/recent?days=7`).catch(() => []),
        apiRequest(`/soil-data/farmer/${farmerId}`).catch(() => [])
      ]);

      const farmsList = Array.isArray(farms) ? farms : [];
      const productionsList = Array.isArray(productions) ? productions : 
                             (productions.data && Array.isArray(productions.data) ? productions.data : []);
      const inventoryList = Array.isArray(inventory) ? inventory : [];
      const weatherList = Array.isArray(weatherData) ? weatherData : [];
      const soilList = Array.isArray(soilData) ? soilData : [];

      // Analyze question and generate response
      let response = '';

      // Weather-related questions
      if (questionLower.includes('weather') || questionLower.includes('rain') || questionLower.includes('temperature')) {
        if (weatherList.length > 0) {
          const recent = weatherList[0];
          const avgTemp = weatherList.slice(0, 7)
            .map(w => parseFloat(w.temperature))
            .filter(t => !isNaN(t))
            .reduce((a, b) => a + b, 0) / Math.min(7, weatherList.length);
          const totalRain = weatherList.slice(0, 7)
            .map(w => parseFloat(w.rainfall || 0))
            .filter(r => !isNaN(r))
            .reduce((a, b) => a + b, 0);

          response = `Based on recent weather data from your farms:\n\n`;
          response += `ðŸŒ¡ï¸ **Temperature**: Average ${avgTemp.toFixed(1)}Â°C\n`;
          response += `ðŸŒ§ï¸ **Rainfall**: ${totalRain.toFixed(2)}mm in the last 7 days\n`;
          response += `ðŸ’§ **Humidity**: ${recent.humidity || 'N/A'}%\n\n`;
          
          if (avgTemp > 35) {
            response += `âš ï¸ **Recommendation**: High temperatures detected. Increase irrigation frequency and monitor soil moisture.`;
          } else if (totalRain < 5) {
            response += `âš ï¸ **Recommendation**: Low rainfall. Schedule additional irrigation to prevent drought stress.`;
          } else {
            response += `âœ… Weather conditions are favorable for most crops.`;
          }
        } else {
          response = 'I don\'t have recent weather data for your farms. Please ensure weather monitoring is set up.';
        }
      }
      // Production-related questions
      else if (questionLower.includes('production') || questionLower.includes('crop') || questionLower.includes('yield')) {
        if (productionsList.length > 0) {
          const active = productionsList.filter(p => p.status === 'ACTIVE' || p.status === 'IN_PROGRESS');
          response = `You have ${active.length} active crop production(s) out of ${productionsList.length} total.\n\n`;
          
          if (active.length > 0) {
            response += `**Active Productions:**\n`;
            active.slice(0, 5).forEach(p => {
              response += `â€¢ ${p.cropName || 'Unknown'}: Expected yield ${p.expectedYield || 0} KG\n`;
            });
            
            const totalExpectedYield = active.reduce((sum, p) => sum + parseFloat(p.expectedYield || 0), 0);
            response += `\n**Total Expected Yield**: ${totalExpectedYield.toFixed(2)} KG\n\n`;
            response += `ðŸ’¡ **Tip**: Monitor crop growth stages and adjust inputs accordingly.`;
          }
        } else {
          response = 'You don\'t have any active crop productions. Consider starting new productions for the season.';
        }
      }
      // Soil-related questions
      else if (questionLower.includes('soil') || questionLower.includes('ph')) {
        if (soilList.length > 0) {
          const recent = soilList[0];
          response = `**Recent Soil Analysis:**\n\n`;
          response += `ðŸ“Š **pH Level**: ${recent.phLevel || 'N/A'}\n`;
          response += `ðŸŒ± **Organic Matter**: ${recent.organicMatter || 'N/A'}%\n`;
          response += `ðŸ’§ **Moisture**: ${recent.moistureContent || 'N/A'}%\n\n`;
          
          const ph = parseFloat(recent.phLevel);
          if (ph < 6.0) {
            response += `âš ï¸ **Recommendation**: Soil pH is too low. Apply lime to raise pH to optimal range (6.0-7.5).`;
          } else if (ph > 7.5) {
            response += `âš ï¸ **Recommendation**: Soil pH is too high. Apply sulfur to lower pH.`;
          } else {
            response += `âœ… Soil pH is in optimal range for most crops.`;
          }
        } else {
          response = 'No recent soil analysis data available. Consider conducting soil tests for better recommendations.';
        }
      }
      // Inventory-related questions
      else if (questionLower.includes('inventory') || questionLower.includes('stock')) {
        if (inventoryList.length > 0) {
          const lowStock = inventoryList.filter(item => {
            const available = parseFloat(item.availableQuantity || 0);
            const total = parseFloat(item.totalQuantity || 0);
            return available > 0 && total > 0 && (available / total) < 0.2;
          });

          response = `**Inventory Status:**\n\n`;
          response += `ðŸ“¦ **Total Items**: ${inventoryList.length}\n`;
          response += `âš ï¸ **Low Stock Items**: ${lowStock.length}\n\n`;

          if (lowStock.length > 0) {
            response += `**Items Needing Restock:**\n`;
            lowStock.slice(0, 5).forEach(item => {
              response += `â€¢ ${item.cropName || 'Unknown'}: ${item.availableQuantity || 0} / ${item.totalQuantity || 0}\n`;
            });
            response += `\nðŸ’¡ **Recommendation**: Restock these items soon to avoid production delays.`;
          } else {
            response += `âœ… All inventory items have adequate stock levels.`;
          }
        } else {
          response = 'No inventory data available. Start tracking your inventory for better management.';
        }
      }
      // General farming advice
      else if (questionLower.includes('recommend') || questionLower.includes('advice') || questionLower.includes('help')) {
        response = `Based on your farm data:\n\n`;
        response += `ðŸ¡ **Farms**: ${farmsList.length}\n`;
        response += `ðŸŒ¾ **Productions**: ${productionsList.length}\n`;
        response += `ðŸ“¦ **Inventory Items**: ${inventoryList.length}\n\n`;
        response += `**Key Recommendations:**\n`;
        response += `1. Monitor weather forecasts regularly\n`;
        response += `2. Maintain optimal soil pH (6.0-7.5)\n`;
        response += `3. Schedule irrigation based on weather\n`;
        response += `4. Keep inventory levels above 20%\n`;
        response += `5. Plan harvest timing for optimal market prices\n\n`;
        response += `Ask me specific questions about weather, production, soil, or inventory for detailed insights!`;
      }
      // Default response
      else {
        response = `I can help you with:\n\n`;
        response += `ðŸŒ¤ï¸ **Weather**: Ask about current conditions, forecasts, or weather-related recommendations\n`;
        response += `ðŸŒ¾ **Production**: Get insights about your crop productions and yields\n`;
        response += `ðŸŒ± **Soil**: Learn about soil health and management\n`;
        response += `ðŸ“¦ **Inventory**: Check stock levels and restocking needs\n`;
        response += `ðŸ’¡ **General**: Ask for farming advice and best practices\n\n`;
        response += `Try asking: "What's the weather like?", "How are my crops doing?", or "Check my inventory"`;
      }

      return response;
    }

    /**
     * Add message to chat
     */
    function addChatMessage(role, message) {
      const container = document.getElementById('aiChatMessages');
      if (!container) return;

      const messageDiv = document.createElement('div');
      messageDiv.className = `ai-message ai-${role}`;
      
      if (role === 'user') {
        messageDiv.style.cssText = 'padding: 16px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px; margin-left: auto; max-width: 80%;';
        messageDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <i class="fas fa-user" style="color: #3b82f6;"></i>
            <strong style="color: var(--text-primary);">You</strong>
          </div>
          <p style="color: var(--text-secondary); margin: 0; line-height: 1.6; white-space: pre-line;">${escapeHtml(message)}</p>
        `;
      } else {
        messageDiv.style.cssText = 'padding: 16px; background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--primary-green); border-radius: 8px; max-width: 80%;';
        messageDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <i class="fas fa-robot" style="color: var(--primary-green);"></i>
            <strong style="color: var(--text-primary);">AI Assistant</strong>
          </div>
          <p style="color: var(--text-secondary); margin: 0; line-height: 1.6; white-space: pre-line;">${escapeHtml(message)}</p>
        `;
      }

      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    /**
     * Filter recommendations
     */
    function filterRecommendations() {
      const typeFilter = document.getElementById('recommendationsTypeFilter');
      const priorityFilter = document.getElementById('recommendationsPriorityFilter');

      if (!typeFilter || !priorityFilter) return;

      const typeValue = typeFilter.value;
      const priorityValue = priorityFilter.value;

      const filtered = allRecommendationsData.filter(rec => {
        if (typeValue && rec.recommendationType !== typeValue) return false;
        if (priorityValue && rec.priority !== priorityValue) return false;
        return true;
      });

      displayRecommendationsGrid(filtered);
      updateRecommendationsStatistics(filtered);
    }

    /**
     * Clear recommendations filters
     */
    function clearRecommendationsFilters() {
      const typeFilter = document.getElementById('recommendationsTypeFilter');
      const priorityFilter = document.getElementById('recommendationsPriorityFilter');

      if (typeFilter) typeFilter.value = '';
      if (priorityFilter) priorityFilter.value = '';

      displayRecommendationsGrid(allRecommendationsData);
      updateRecommendationsStatistics(allRecommendationsData);
    }

    /**
     * Mark recommendation as read
     */
    async function markRecommendationAsRead(recommendationId) {
      try {
        await apiRequest(`/ai-recommendations/${recommendationId}/read`, {
          method: 'PUT'
        });

        showToast('Recommendation marked as read', 'success');
        await loadRecommendationsData();

      } catch (error) {
        console.error('Error marking recommendation as read:', error);
        showToast('Error updating recommendation', 'error');
      }
    }

    // ============================================================================
    // PRODUCTION PREDICTIONS MODULE
    // ============================================================================

    /**
     * Load predictions data
     */
    async function loadPredictionsData() {
      try {
        showLoading();

       const response = await apiRequest(`/predictions/farmer/${currentUser.id}`);
        const predictions = response || [];

        displayPredictionsGrid(predictions);

      } catch (error) {
        console.error('Error loading predictions:', error);
        showToast('Error loading predictions', 'error');
      } finally {
        hideLoading();
      }
    }

    /**
     * Display predictions grid
     */
function displayPredictionsGrid(predictions) {
  const container = document.getElementById('predictionsGrid');
  if (!container) return;

  // âœ… CORRECTION : Extraire les donnÃ©es correctement
  let predictionsList = [];
  if (Array.isArray(predictions)) {
    predictionsList = predictions;
  } else if (predictions && predictions.data) {
    if (Array.isArray(predictions.data.content)) {
      predictionsList = predictions.data.content;
    } else if (Array.isArray(predictions.data)) {
      predictionsList = predictions.data;
    }
  } else if (predictions && predictions.content) {
    predictionsList = Array.isArray(predictions.content)
      ? predictions.content
      : [];
  }

  if (predictionsList.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-chart-area"></i>
        <p>No predictions available</p>
        <p class="empty-state-hint">AI predictions will be generated based on your historical data</p>
      </div>
    `;
    return;
  }

      container.innerHTML = predictions.map(pred => `
        <div class="prediction-card">
          <div class="prediction-header">
            <div class="prediction-crop">${pred.cropName || 'Crop'}</div>
            <div class="prediction-season">${pred.season} ${pred.year}</div>
          </div>
          <div class="prediction-body">
            <div class="prediction-yield">
              <div class="prediction-yield-label">Predicted Yield</div>
              <div class="prediction-yield-value">
                ${pred.predictedYield ? pred.predictedYield.toFixed(2) : '--'}
                <span class="prediction-yield-unit">T/ha</span>
              </div>
            </div>
            <div class="prediction-metrics">
              <div class="prediction-metric">
                <div class="prediction-metric-label">Min Expected</div>
                <div class="prediction-metric-value">${pred.minYield ? pred.minYield.toFixed(2) : '--'} T/ha</div>
              </div>
              <div class="prediction-metric">
                <div class="prediction-metric-label">Max Expected</div>
                <div class="prediction-metric-value">${pred.maxYield ? pred.maxYield.toFixed(2) : '--'} T/ha</div>
              </div>
              <div class="prediction-metric">
                <div class="prediction-metric-label">Confidence</div>
                <div class="prediction-metric-value">${pred.confidenceLevel ? (pred.confidenceLevel * 100).toFixed(0) : '--'}%</div>
              </div>
              <div class="prediction-metric">
                <div class="prediction-metric-label">Model Accuracy</div>
                <div class="prediction-metric-value">${pred.modelAccuracy ? (pred.modelAccuracy * 100).toFixed(0) : '--'}%</div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // ============================================================================
    // REPORTS MODULE
    // ============================================================================

    /**
     * Initialize reports listeners
     */
    function initReportsListeners() {
      const previewBtn = document.querySelector('[data-action="preview-report"]');
      if (previewBtn) {
        previewBtn.addEventListener('click', previewReport);
      }

      const pdfBtn = document.querySelector('[data-action="generate-pdf-report"]');
      if (pdfBtn) {
        pdfBtn.addEventListener('click', generatePDFReport);
      }

      const excelBtn = document.querySelector('[data-action="generate-excel-report"]');
      if (excelBtn) {
        excelBtn.addEventListener('click', generateExcelReport);
      }

      const closePreviewBtn = document.querySelector('[data-action="close-preview"]');
      if (closePreviewBtn) {
        closePreviewBtn.addEventListener('click', () => {
          document.getElementById('reportPreview').style.display = 'none';
        });
      }
    }

    /**
     * Preview report
     */
    async function previewReport() {
      try {
        showLoading();

        const reportType = document.getElementById('reportType').value;
        const reportPeriod = document.getElementById('reportPeriod').value;
        const dateFrom = document.getElementById('reportDateFrom').value;
        const dateTo = document.getElementById('reportDateTo').value;

        // Generate report data
        const reportData = await generateReportData(reportType, reportPeriod, dateFrom, dateTo);

        // Display preview
        const previewContainer = document.getElementById('reportPreview');
        const previewContent = document.getElementById('reportPreviewContent');

        previewContent.innerHTML = generateReportHTML(reportType, reportData);
        previewContainer.style.display = 'block';

        showToast('Report preview generated', 'success');

      } catch (error) {
        console.error('Error generating report preview:', error);
        showToast('Error generating report preview', 'error');
      } finally {
        hideLoading();
      }
    }



    /**
     * Generate report data
     */
    async function generateReportData(reportType, period, dateFrom, dateTo) {
      const data = {
        reportType: reportType,
        period: period,
        dateFrom: dateFrom,
        dateTo: dateTo,
        generatedAt: new Date().toISOString(),
        farmerName: currentUser ? currentUser.fullName : 'Unknown',
        farmerEmail: currentUser ? currentUser.email : 'Unknown'
      };

      try {
        switch (reportType) {
          case 'farm-overview':
            data.content = await generateFarmOverviewReport(dateFrom, dateTo);
            break;
          case 'production-summary':
            data.content = await generateProductionSummaryReport(dateFrom, dateTo);
            break;
          case 'financial-report':
            data.content = await generateFinancialReport(dateFrom, dateTo);
            break;
          case 'resource-usage':
            data.content = await generateResourceUsageReport(dateFrom, dateTo);
            break;
          case 'inventory-report':
            data.content = await generateInventoryReport(dateFrom, dateTo);
            break;
          default:
            throw new Error('Invalid report type');
        }

        return data;
      } catch (error) {
        console.error('Error generating report data:', error);
        throw error;
      }
    }

    /**
     * Generate farm overview report
     */
    async function generateFarmOverviewReport(dateFrom, dateTo) {
      const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
      const farms = farmsResponse || [];

      const totalFarms = farms.length;
      const totalArea = farms.reduce((sum, farm) => sum + (parseFloat(farm.sizeHectares) || 0), 0);
      const irrigatedFarms = farms.filter(f => f.irrigationSystem !== 'RAIN_FED').length;
      const activeFarms = farms.filter(f => f.isActive !== false).length;

      // Soil type distribution
      const soilTypeDistribution = {};
      farms.forEach(farm => {
        const soilType = farm.soilType || 'Unknown';
        soilTypeDistribution[soilType] = (soilTypeDistribution[soilType] || 0) + 1;
      });

      // Irrigation system distribution
      const irrigationDistribution = {};
      farms.forEach(farm => {
        const irrigation = farm.irrigationSystem || 'Unknown';
        irrigationDistribution[irrigation] = (irrigationDistribution[irrigation] || 0) + 1;
      });

      return {
        summary: {
          totalFarms,
          totalArea: totalArea.toFixed(2),
          irrigatedFarms,
          activeFarms,
          inactiveFarms: totalFarms - activeFarms
        },
        farms: farms.map(farm => ({
          name: farm.farmName,
          code: farm.farmCode,
          location: farm.location,
          size: farm.sizeHectares,
          soilType: farm.soilType,
          irrigationSystem: formatIrrigationSystem(farm.irrigationSystem),
          status: farm.isActive ? 'Active' : 'Inactive'
        })),
        soilTypeDistribution,
        irrigationDistribution
      };
    }

    /**
     * Generate production summary report
     */



    async function generateProductionSummaryReport(dateFrom, dateTo) {
      const productionsResponse = await apiRequest(`/crop-productions/farm/${currentUser.id}/all`);
      let productions = productionsResponse || [];

      // Filter by date range if provided
      if (dateFrom && dateTo) {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);
        productions = productions.filter(p => {
          const plantingDate = new Date(p.plantingDate);
          return plantingDate >= from && plantingDate <= to;
        });
      }

      const totalProductions = productions.length;
      const activeProductions = productions.filter(p =>
        ['PLANTED', 'GROWING'].includes(p.productionStatus)
      ).length;
      const completedProductions = productions.filter(p =>
        p.productionStatus === 'HARVESTED'
      ).length;

      const totalArea = productions.reduce((sum, p) =>
        sum + (parseFloat(p.areaPlanted) || 0), 0
      );

      const totalYield = productions.reduce((sum, p) =>
        sum + (parseFloat(p.actualYield) || 0), 0
      );

      const totalExpectedYield = productions.reduce((sum, p) =>
        sum + (parseFloat(p.expectedYield) || 0), 0
      );

      // Crop type distribution
      const cropDistribution = {};
      productions.forEach(p => {
        const crop = p.cropName || 'Unknown';
        if (!cropDistribution[crop]) {
          cropDistribution[crop] = {
            count: 0,
            area: 0,
            yield: 0
          };
        }
        cropDistribution[crop].count++;
        cropDistribution[crop].area += parseFloat(p.areaPlanted) || 0;
        cropDistribution[crop].yield += parseFloat(p.actualYield) || 0;
      });

      // Season distribution
      const seasonDistribution = {};
      productions.forEach(p => {
        const season = `${p.season} ${p.year}`;
        seasonDistribution[season] = (seasonDistribution[season] || 0) + 1;
      });

      // Status distribution
      const statusDistribution = {};
      productions.forEach(p => {
        const status = p.productionStatus || 'Unknown';
        statusDistribution[status] = (statusDistribution[status] || 0) + 1;
      });

      return {
        summary: {
          totalProductions,
          activeProductions,
          completedProductions,
          totalArea: totalArea.toFixed(2),
          totalYield: totalYield.toFixed(2),
          totalExpectedYield: totalExpectedYield.toFixed(2),
          averageYield: totalProductions > 0 ? (totalYield / totalProductions).toFixed(2) : 0
        },
        productions: productions.map(p => ({
          code: p.productionCode,
          crop: p.cropName,
          season: `${p.season} ${p.year}`,
          area: p.areaPlanted,
          expectedYield: p.expectedYield,
          actualYield: p.actualYield,
          plantingDate: formatDate(p.plantingDate),
          expectedHarvestDate: formatDate(p.expectedHarvestDate),
          actualHarvestDate: p.actualHarvestDate ? formatDate(p.actualHarvestDate) : 'N/A',
          status: p.productionStatus
        })),
        cropDistribution,
        seasonDistribution,
        statusDistribution
      };
    }

    /**
     * Generate financial report
     */
    async function generateFinancialReport(dateFrom, dateTo) {
      // Fetch all financial data
      const [
        fertilizerResponse,
        irrigationResponse,
        inventoryResponse,
        transactionsResponse
      ] = await Promise.all([
        apiRequest('/fertilizer-usages'),
        apiRequest(`/irrigation/farm/${currentUser.id}`),
        apiRequest(`/inventory/farmer/${currentUser.id}`),
        apiRequest(`/transactions/farmer/${currentUser.id}`)
      ]);

      let fertilizers = fertilizerResponse.content || fertilizerResponse || [];
      let irrigations = irrigationResponse.content || irrigationResponse || [];
      let inventory = inventoryResponse.content || inventoryResponse || [];
      let transactions = transactionsResponse.content || transactionsResponse || [];

      // Filter by date range if provided
      if (dateFrom && dateTo) {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);

        fertilizers = fertilizers.filter(f => {
          const date = new Date(f.applicationDate);
          return date >= from && date <= to;
        });

        irrigations = irrigations.filter(i => {
          const date = new Date(i.irrigationDate);
          return date >= from && date <= to;
        });

        transactions = transactions.filter(t => {
          const date = new Date(t.transactionDate);
          return date >= from && date <= to;
        });
      }

      // Calculate costs
      const fertilizerCost = fertilizers.reduce((sum, f) =>
        sum + (parseFloat(f.totalCost) || 0), 0
      );

      const irrigationCost = irrigations.reduce((sum, i) =>
        sum + (parseFloat(i.totalCost) || 0), 0
      );

      const totalCosts = fertilizerCost + irrigationCost;

      // Calculate revenues
      const totalRevenue = transactions
        .filter(t => t.transactionStatus === 'PAID')
        .reduce((sum, t) => sum + (parseFloat(t.totalAmount) || 0), 0);

      const netRevenue = transactions
        .filter(t => t.transactionStatus === 'PAID')
        .reduce((sum, t) => sum + (parseFloat(t.netAmount) || 0), 0);

      const transactionFees = totalRevenue - netRevenue;

      // Calculate inventory value
      const inventoryValue = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.totalMarketValue) || 0), 0
      );

      // Profit/Loss
      const profitLoss = netRevenue - totalCosts;

      // Monthly breakdown
      const monthlyData = {};

      transactions.forEach(t => {
        if (t.transactionStatus === 'PAID') {
          const date = new Date(t.transactionDate);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

          if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = {
              revenue: 0,
              costs: 0,
              profit: 0
            };
          }
          monthlyData[monthKey].revenue += parseFloat(t.netAmount) || 0;
        }
      });

      fertilizers.forEach(f => {
        const date = new Date(f.applicationDate);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (monthlyData[monthKey]) {
          monthlyData[monthKey].costs += parseFloat(f.totalCost) || 0;
        }
      });

      irrigations.forEach(i => {
        const date = new Date(i.irrigationDate);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (monthlyData[monthKey]) {
          monthlyData[monthKey].costs += parseFloat(i.totalCost) || 0;
        }
      });

      // Calculate profit for each month
      Object.keys(monthlyData).forEach(month => {
        monthlyData[month].profit = monthlyData[month].revenue - monthlyData[month].costs;
      });

      return {
        summary: {
          totalRevenue: formatCurrency(totalRevenue),
          netRevenue: formatCurrency(netRevenue),
          transactionFees: formatCurrency(transactionFees),
          totalCosts: formatCurrency(totalCosts),
          fertilizerCost: formatCurrency(fertilizerCost),
          irrigationCost: formatCurrency(irrigationCost),
          inventoryValue: formatCurrency(inventoryValue),
          profitLoss: formatCurrency(profitLoss),
          profitMargin: totalRevenue > 0 ? ((profitLoss / totalRevenue) * 100).toFixed(2) + '%' : '0%'
        },
        costs: {
          fertilizer: fertilizerCost,
          irrigation: irrigationCost,
          total: totalCosts
        },
        revenue: {
          total: totalRevenue,
          net: netRevenue,
          fees: transactionFees
        },
        transactions: transactions.map(t => ({
          code: t.transactionCode,
          date: formatDate(t.transactionDate),
          buyer: t.buyerName,
          crop: t.cropName,
          quantity: `${t.quantity} ${t.unit || 'KG'}`,
          totalAmount: formatCurrency(t.totalAmount),
          netAmount: formatCurrency(t.netAmount),
          status: t.transactionStatus
        })),
        monthlyData
      };
    }

    /**
     * Generate resource usage report
     */
    async function generateResourceUsageReport(dateFrom, dateTo) {
      const [
        fertilizerResponse,
        irrigationResponse
      ] = await Promise.all([
        apiRequest('/fertilizer-usages'),
        apiRequest(`/irrigation/farm/${currentUser.id}`)
      ]);

      let fertilizers = fertilizerResponse.content || fertilizerResponse || [];
      let irrigations = irrigationResponse.content || irrigationResponse || [];

      // Filter by date range if provided
      if (dateFrom && dateTo) {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);

        fertilizers = fertilizers.filter(f => {
          const date = new Date(f.applicationDate);
          return date >= from && date <= to;
        });

        irrigations = irrigations.filter(i => {
          const date = new Date(i.irrigationDate);
          return date >= from && date <= to;
        });
      }

      // Fertilizer statistics
      const totalFertilizerApplications = fertilizers.length;
      const totalFertilizerQuantity = fertilizers.reduce((sum, f) =>
        sum + (parseFloat(f.quantity) || 0), 0
      );
      const totalFertilizerCost = fertilizers.reduce((sum, f) =>
        sum + (parseFloat(f.totalCost) || 0), 0
      );

      // Fertilizer type distribution
      const fertilizerTypeDistribution = {};
      fertilizers.forEach(f => {
        const type = f.fertilizerType || 'Unknown';
        if (!fertilizerTypeDistribution[type]) {
          fertilizerTypeDistribution[type] = {
            applications: 0,
            quantity: 0,
            cost: 0
          };
        }
        fertilizerTypeDistribution[type].applications++;
        fertilizerTypeDistribution[type].quantity += parseFloat(f.quantity) || 0;
        fertilizerTypeDistribution[type].cost += parseFloat(f.totalCost) || 0;
      });

      // Irrigation statistics
      const totalIrrigationSessions = irrigations.length;
      const totalWaterUsed = irrigations.reduce((sum, i) =>
        sum + (parseFloat(i.waterAmountLiters) || 0), 0
      );
      const totalIrrigationCost = irrigations.reduce((sum, i) =>
        sum + (parseFloat(i.totalCost) || 0), 0
      );
      const avgWaterEfficiency = irrigations.length > 0
        ? irrigations.reduce((sum, i) => sum + (parseFloat(i.waterUseEfficiency) || 0), 0) / irrigations.length
        : 0;

      // Irrigation method distribution
      const irrigationMethodDistribution = {};
      irrigations.forEach(i => {
        const method = i.irrigationMethod || 'Unknown';
        if (!irrigationMethodDistribution[method]) {
          irrigationMethodDistribution[method] = {
            sessions: 0,
            waterUsed: 0,
            cost: 0
          };
        }
        irrigationMethodDistribution[method].sessions++;
        irrigationMethodDistribution[method].waterUsed += parseFloat(i.waterAmountLiters) || 0;
        irrigationMethodDistribution[method].cost += parseFloat(i.totalCost) || 0;
      });

      // Water source distribution
      const waterSourceDistribution = {};
      irrigations.forEach(i => {
        const source = i.waterSource || 'Unknown';
        waterSourceDistribution[source] = (waterSourceDistribution[source] || 0) + 1;
      });

      return {
        summary: {
          fertilizerApplications: totalFertilizerApplications,
          totalFertilizerQuantity: totalFertilizerQuantity.toFixed(2) + ' KG',
          totalFertilizerCost: formatCurrency(totalFertilizerCost),
          irrigationSessions: totalIrrigationSessions,
          totalWaterUsed: totalWaterUsed.toFixed(2) + ' L',
          totalIrrigationCost: formatCurrency(totalIrrigationCost),
          avgWaterEfficiency: (avgWaterEfficiency * 100).toFixed(1) + '%',
          totalResourceCost: formatCurrency(totalFertilizerCost + totalIrrigationCost)
        },
        fertilizer: {
          applications: fertilizers.map(f => ({
            date: formatDate(f.applicationDate),
            type: f.fertilizerType,
            name: f.fertilizerName,
            quantity: `${f.quantity} ${f.unit}`,
            method: f.applicationMethod,
            cost: formatCurrency(f.totalCost),
            effectiveness: f.effectivenessRating ? `${f.effectivenessRating}/5` : 'N/A'
          })),
          typeDistribution: fertilizerTypeDistribution
        },
        irrigation: {
          sessions: irrigations.map(i => ({
            date: formatDate(i.irrigationDate),
            waterAmount: `${i.waterAmountLiters} L`,
            duration: `${i.durationMinutes} min`,
            method: i.irrigationMethod,
            source: i.waterSource,
            efficiency: i.waterUseEfficiency ? (i.waterUseEfficiency * 100).toFixed(1) + '%' : 'N/A',
            cost: formatCurrency(i.totalCost)
          })),
          methodDistribution: irrigationMethodDistribution,
          sourceDistribution: waterSourceDistribution
        }
      };
    }

    /**
     * Generate inventory report
     */
    async function generateInventoryReport(dateFrom, dateTo) {
     const inventoryResponse = await ApiService.get(`/v1/inventories/farmer/${currentUser.id}`)
      let inventory = inventoryResponse.content || inventoryResponse || [];

      // Filter by date range if provided (based on storage date)
      if (dateFrom && dateTo) {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);
        inventory = inventory.filter(item => {
          if (!item.storageDate) return true;
          const date = new Date(item.storageDate);
          return date >= from && date <= to;
        });
      }

      const totalItems = inventory.length;
      const totalQuantity = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.currentQuantity) || 0), 0
      );
      const totalValue = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.totalMarketValue) || 0), 0
      );
      const availableQuantity = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.availableQuantity) || 0), 0
      );

      // Status distribution
      const statusDistribution = {};
      inventory.forEach(item => {
        const status = item.status || 'Unknown';
        statusDistribution[status] = (statusDistribution[status] || 0) + 1;
      });

      // Quality distribution
      const qualityDistribution = {};
      inventory.forEach(item => {
        const quality = item.qualityGrade || 'Unknown';
        qualityDistribution[quality] = (qualityDistribution[quality] || 0) + 1;
      });

      // Crop distribution
      const cropDistribution = {};
      inventory.forEach(item => {
        const crop = item.cropName || 'Unknown';
        if (!cropDistribution[crop]) {
          cropDistribution[crop] = {
            quantity: 0,
            value: 0
          };
        }
        cropDistribution[crop].quantity += parseFloat(item.currentQuantity) || 0;
        cropDistribution[crop].value += parseFloat(item.totalMarketValue) || 0;
      });

      // Expiring items (within 30 days)
      const today = new Date();
      const expiringItems = inventory.filter(item => {
        if (!item.expiryDate) return false;
        const expiry = new Date(item.expiryDate);
        const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
        return daysUntil > 0 && daysUntil <= 30;
      });

      // Expired items
      const expiredItems = inventory.filter(item => {
        if (!item.expiryDate) return false;
        const expiry = new Date(item.expiryDate);
        return expiry < today;
      });

      // Low stock items (available < 20% of current)
      const lowStockItems = inventory.filter(item => {
        const available = parseFloat(item.availableQuantity) || 0;
        const current = parseFloat(item.currentQuantity) || 0;
        return current > 0 && available < current * 0.2;
      });

      return {
        summary: {
          totalItems,
          totalQuantity: totalQuantity.toFixed(2) + ' KG',
          availableQuantity: availableQuantity.toFixed(2) + ' KG',
          totalValue: formatCurrency(totalValue),
          averageValuePerItem: totalItems > 0 ? formatCurrency(totalValue / totalItems) : formatCurrency(0),
          expiringItemsCount: expiringItems.length,
          expiredItemsCount: expiredItems.length,
          lowStockItemsCount: lowStockItems.length
        },
        items: inventory.map(item => ({
          code: item.inventoryCode,
          crop: item.cropName,
          quantity: `${item.currentQuantity} ${item.unit}`,
          available: `${item.availableQuantity} ${item.unit}`,
          quality: item.qualityGrade,
          status: item.status,
          value: formatCurrency(item.totalMarketValue),
          storageDate: item.storageDate ? formatDate(item.storageDate) : 'N/A',
          expiryDate: item.expiryDate ? formatDate(item.expiryDate) : 'N/A'
        })),
        statusDistribution,
        qualityDistribution,
        cropDistribution,
        alerts: {
          expiring: expiringItems.map(item => ({
            code: item.inventoryCode,
            crop: item.cropName,
            quantity: `${item.currentQuantity} ${item.unit}`,
            expiryDate: formatDate(item.expiryDate),
            daysUntilExpiry: Math.ceil((new Date(item.expiryDate) - today) / (1000 * 60 * 60 * 24))
          })),
          expired: expiredItems.map(item => ({
            code: item.inventoryCode,
            crop: item.cropName,
            quantity: `${item.currentQuantity} ${item.unit}`,
            expiryDate: formatDate(item.expiryDate)
          })),
          lowStock: lowStockItems.map(item => ({
            code: item.inventoryCode,
            crop: item.cropName,
            available: `${item.availableQuantity} ${item.unit}`,
            total: `${item.currentQuantity} ${item.unit}`
          }))
        }
      };
    }

    /**
     * Generate report HTML
     */
    function generateReportHTML(reportType, reportData) {
      const reportTitles = {
        'farm-overview': 'Farm Overview Report',
        'production-summary': 'Production Summary Report',
        'financial-report': 'Financial Report',
        'resource-usage': 'Resource Usage Report',
        'inventory-report': 'Inventory Report'
      };

      let html = `
        <div class="report-document">
          <div class="report-header">
            <h1>${reportTitles[reportType]}</h1>
            <div class="report-meta">
              <p><strong>Generated:</strong> ${formatDateTime(reportData.generatedAt)}</p>
              <p><strong>Farmer:</strong> ${reportData.farmerName}</p>
              <p><strong>Email:</strong> ${reportData.farmerEmail}</p>
              ${reportData.dateFrom && reportData.dateTo ? `
                <p><strong>Period:</strong> ${formatDate(reportData.dateFrom)} to ${formatDate(reportData.dateTo)}</p>
              ` : ''}
            </div>
          </div>
      `;

      switch (reportType) {
        case 'farm-overview':
          html += generateFarmOverviewHTML(reportData.content);
          break;
        case 'production-summary':
          html += generateProductionSummaryHTML(reportData.content);
          break;
        case 'financial-report':
          html += generateFinancialReportHTML(reportData.content);
          break;
        case 'resource-usage':
          html += generateResourceUsageHTML(reportData.content);
          break;
        case 'inventory-report':
          html += generateInventoryReportHTML(reportData.content);
          break;
      }

      html += `</div>`;
      return html;
    }

    /**
     * Generate farm overview HTML
     */
    function generateFarmOverviewHTML(content) {
      return `
        <div class="report-section">
          <h2>Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Total Farms:</label>
              <value>${content.summary.totalFarms}</value>
            </div>
            <div class="summary-item">
              <label>Total Area:</label>
              <value>${content.summary.totalArea} ha</value>
            </div>
            <div class="summary-item">
              <label>Irrigated Farms:</label>
              <value>${content.summary.irrigatedFarms}</value>
            </div>
            <div class="summary-item">
              <label>Active Farms:</label>
              <value>${content.summary.activeFarms}</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>Farm Details</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Farm Name</th>
                <th>Code</th>
                <th>Location</th>
                <th>Size (ha)</th>
                <th>Soil Type</th>
                <th>Irrigation</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${content.farms.map(farm => `
                <tr>
                  <td>${farm.name}</td>
                  <td>${farm.code}</td>
                  <td>${farm.location}</td>
                  <td>${farm.size}</td>
                  <td>${farm.soilType}</td>
                  <td>${farm.irrigationSystem}</td>
                  <td>${farm.status}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Soil Type Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.soilTypeDistribution).map(([type, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${type}:</span>
                <span class="distribution-value">${count} farms</span>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="report-section">
          <h2>Irrigation System Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.irrigationDistribution).map(([system, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${system}:</span>
                <span class="distribution-value">${count} farms</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }






    /**
     * Generate production summary HTML
     */
    function generateProductionSummaryHTML(content) {
      return `
        <div class="report-section">
          <h2>Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Total Productions:</label>
              <value>${content.summary.totalProductions}</value>
            </div>
            <div class="summary-item">
              <label>Active Productions:</label>
              <value>${content.summary.activeProductions}</value>
            </div>
            <div class="summary-item">
              <label>Completed:</label>
              <value>${content.summary.completedProductions}</value>
            </div>
            <div class="summary-item">
              <label>Total Area:</label>
              <value>${content.summary.totalArea} ha</value>
            </div>
            <div class="summary-item">
              <label>Total Yield:</label>
              <value>${content.summary.totalYield} T</value>
            </div>
            <div class="summary-item">
              <label>Average Yield:</label>
              <value>${content.summary.averageYield} T/ha</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>Production Details</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Crop</th>
                <th>Season</th>
                <th>Area (ha)</th>
                <th>Expected Yield</th>
                <th>Actual Yield</th>
                <th>Planting Date</th>
                <th>Harvest Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${content.productions.map(prod => `
                <tr>
                  <td>${prod.code}</td>
                  <td>${prod.crop}</td>
                  <td>${prod.season}</td>
                  <td>${prod.area}</td>
                  <td>${prod.expectedYield || 'N/A'}</td>
                  <td>${prod.actualYield || 'N/A'}</td>
                  <td>${prod.plantingDate}</td>
                  <td>${prod.actualHarvestDate}</td>
                  <td>${prod.status}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Crop Distribution</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Crop</th>
                <th>Count</th>
                <th>Total Area (ha)</th>
                <th>Total Yield (T)</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(content.cropDistribution).map(([crop, data]) => `
                <tr>
                  <td>${crop}</td>
                  <td>${data.count}</td>
                  <td>${data.area.toFixed(2)}</td>
                  <td>${data.yield.toFixed(2)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Season Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.seasonDistribution).map(([season, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${season}:</span>
                <span class="distribution-value">${count} productions</span>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="report-section">
          <h2>Status Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.statusDistribution).map(([status, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${status}:</span>
                <span class="distribution-value">${count} productions</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    /**
     * Generate financial report HTML
     */
    function generateFinancialReportHTML(content) {
      return `
        <div class="report-section">
          <h2>Financial Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Total Revenue:</label>
              <value>${content.summary.totalRevenue}</value>
            </div>
            <div class="summary-item">
              <label>Net Revenue:</label>
              <value>${content.summary.netRevenue}</value>
            </div>
            <div class="summary-item">
              <label>Transaction Fees:</label>
              <value>${content.summary.transactionFees}</value>
            </div>
            <div class="summary-item">
              <label>Total Costs:</label>
              <value>${content.summary.totalCosts}</value>
            </div>
            <div class="summary-item">
              <label>Profit/Loss:</label>
              <value class="${parseFloat(content.summary.profitLoss.replace(/[^\d.-]/g, '')) >= 0 ? 'text-success' : 'text-error'}">
                <strong>${content.summary.profitLoss}</strong>
              </value>
            </div>
            <div class="summary-item">
              <label>Profit Margin:</label>
              <value>${content.summary.profitMargin}</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>Cost Breakdown</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Fertilizer Costs:</label>
              <value>${content.summary.fertilizerCost}</value>
            </div>
            <div class="summary-item">
              <label>Irrigation Costs:</label>
              <value>${content.summary.irrigationCost}</value>
            </div>
            <div class="summary-item">
              <label>Inventory Value:</label>
              <value>${content.summary.inventoryValue}</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>Monthly Financial Performance</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Month</th>
                <th>Revenue</th>
                <th>Costs</th>
                <th>Profit/Loss</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(content.monthlyData).sort().map(([month, data]) => {
                const monthDate = new Date(month + '-01');
                const monthLabel = monthDate.toLocaleString('default', { month: 'short', year: 'numeric' });
                return `
                  <tr>
                    <td>${monthLabel}</td>
                    <td>${formatCurrency(data.revenue)}</td>
                    <td>${formatCurrency(data.costs)}</td>
                    <td class="${data.profit >= 0 ? 'text-success' : 'text-error'}">
                      <strong>${formatCurrency(data.profit)}</strong>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Transaction History</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Date</th>
                <th>Buyer</th>
                <th>Crop</th>
                <th>Quantity</th>
                <th>Total Amount</th>
                <th>Net Amount</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${content.transactions.map(tx => `
                <tr>
                  <td>${tx.code}</td>
                  <td>${tx.date}</td>
                  <td>${tx.buyer}</td>
                  <td>${tx.crop}</td>
                  <td>${tx.quantity}</td>
                  <td>${tx.totalAmount}</td>
                  <td>${tx.netAmount}</td>
                  <td>${tx.status}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    /**
     * Generate resource usage HTML
     */
    function generateResourceUsageHTML(content) {
      return `
        <div class="report-section">
          <h2>Resource Usage Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Fertilizer Applications:</label>
              <value>${content.summary.fertilizerApplications}</value>
            </div>
            <div class="summary-item">
              <label>Total Fertilizer:</label>
              <value>${content.summary.totalFertilizerQuantity}</value>
            </div>
            <div class="summary-item">
              <label>Fertilizer Cost:</label>
              <value>${content.summary.totalFertilizerCost}</value>
            </div>
            <div class="summary-item">
              <label>Irrigation Sessions:</label>
              <value>${content.summary.irrigationSessions}</value>
            </div>
            <div class="summary-item">
              <label>Total Water Used:</label>
              <value>${content.summary.totalWaterUsed}</value>
            </div>
            <div class="summary-item">
              <label>Irrigation Cost:</label>
              <value>${content.summary.totalIrrigationCost}</value>
            </div>
            <div class="summary-item">
              <label>Water Efficiency:</label>
              <value>${content.summary.avgWaterEfficiency}</value>
            </div>
            <div class="summary-item">
              <label>Total Resource Cost:</label>
              <value><strong>${content.summary.totalResourceCost}</strong></value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>Fertilizer Usage Details</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Name</th>
                <th>Quantity</th>
                <th>Method</th>
                <th>Cost</th>
                <th>Effectiveness</th>
              </tr>
            </thead>
            <tbody>
              ${content.fertilizer.applications.map(f => `
                <tr>
                  <td>${f.date}</td>
                  <td>${f.type}</td>
                  <td>${f.name}</td>
                  <td>${f.quantity}</td>
                  <td>${f.method}</td>
                  <td>${f.cost}</td>
                  <td>${f.effectiveness}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Fertilizer Type Distribution</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Applications</th>
                <th>Total Quantity (KG)</th>
                <th>Total Cost</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(content.fertilizer.typeDistribution).map(([type, data]) => `
                <tr>
                  <td>${type}</td>
                  <td>${data.applications}</td>
                  <td>${data.quantity.toFixed(2)}</td>
                  <td>${formatCurrency(data.cost)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Irrigation Details</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Water Amount</th>
                <th>Duration</th>
                <th>Method</th>
                <th>Source</th>
                <th>Efficiency</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody>
              ${content.irrigation.sessions.map(i => `
                <tr>
                  <td>${i.date}</td>
                  <td>${i.waterAmount}</td>
                  <td>${i.duration}</td>
                  <td>${i.method}</td>
                  <td>${i.source}</td>
                  <td>${i.efficiency}</td>
                  <td>${i.cost}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Irrigation Method Distribution</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Method</th>
                <th>Sessions</th>
                <th>Water Used (L)</th>
                <th>Total Cost</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(content.irrigation.methodDistribution).map(([method, data]) => `
                <tr>
                  <td>${method}</td>
                  <td>${data.sessions}</td>
                  <td>${data.waterUsed.toFixed(2)}</td>
                  <td>${formatCurrency(data.cost)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Water Source Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.irrigation.sourceDistribution).map(([source, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${source}:</span>
                <span class="distribution-value">${count} sessions</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    /**
     * Generate inventory report HTML
     */
    function generateInventoryReportHTML(content) {
      return `
        <div class="report-section">
          <h2>Inventory Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Total Items:</label>
              <value>${content.summary.totalItems}</value>
            </div>
            <div class="summary-item">
              <label>Total Quantity:</label>
              <value>${content.summary.totalQuantity}</value>
            </div>
            <div class="summary-item">
              <label>Available Quantity:</label>
              <value>${content.summary.availableQuantity}</value>
            </div>
            <div class="summary-item">
              <label>Total Value:</label>
              <value>${content.summary.totalValue}</value>
            </div>
            <div class="summary-item">
              <label>Average Value/Item:</label>
              <value>${content.summary.averageValuePerItem}</value>
            </div>
            <div class="summary-item">
              <label>Expiring Items:</label>
              <value class="text-warning">${content.summary.expiringItemsCount}</value>
            </div>
            <div class="summary-item">
              <label>Expired Items:</label>
              <value class="text-error">${content.summary.expiredItemsCount}</value>
            </div>
            <div class="summary-item">
              <label>Low Stock Items:</label>
              <value class="text-warning">${content.summary.lowStockItemsCount}</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>Inventory Items</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Crop</th>
                <th>Quantity</th>
                <th>Available</th>
                <th>Quality</th>
                <th>Status</th>
                <th>Value</th>
                <th>Storage Date</th>
                <th>Expiry Date</th>
              </tr>
            </thead>
            <tbody>
              ${content.items.map(item => `
                <tr>
                  <td>${item.code}</td>
                  <td>${item.crop}</td>
                  <td>${item.quantity}</td>
                  <td>${item.available}</td>
                  <td>${item.quality}</td>
                  <td>${item.status}</td>
                  <td>${item.value}</td>
                  <td>${item.storageDate}</td>
                  <td>${item.expiryDate}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Status Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.statusDistribution).map(([status, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${status}:</span>
                <span class="distribution-value">${count} items</span>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="report-section">
          <h2>Quality Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.qualityDistribution).map(([quality, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${quality}:</span>
                <span class="distribution-value">${count} items</span>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="report-section">
          <h2>Crop Distribution</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Crop</th>
                <th>Quantity (KG)</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(content.cropDistribution).map(([crop, data]) => `
                <tr>
                  <td>${crop}</td>
                  <td>${data.quantity.toFixed(2)}</td>
                  <td>${formatCurrency(data.value)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        ${content.alerts.expiring.length > 0 ? `
          <div class="report-section">
            <h2 class="text-warning">âš ï¸ Expiring Items Alert</h2>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Crop</th>
                  <th>Quantity</th>
                  <th>Expiry Date</th>
                  <th>Days Until Expiry</th>
                </tr>
              </thead>
              <tbody>
                ${content.alerts.expiring.map(item => `
                  <tr class="alert-row">
                    <td>${item.code}</td>
                    <td>${item.crop}</td>
                    <td>${item.quantity}</td>
                    <td>${item.expiryDate}</td>
                    <td class="text-warning"><strong>${item.daysUntilExpiry} days</strong></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}

        ${content.alerts.expired.length > 0 ? `
          <div class="report-section">
            <h2 class="text-error">ðŸš« Expired Items Alert</h2>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Crop</th>
                  <th>Quantity</th>
                  <th>Expiry Date</th>
                </tr>
              </thead>
              <tbody>
                ${content.alerts.expired.map(item => `
                  <tr class="alert-row expired">
                    <td>${item.code}</td>
                    <td>${item.crop}</td>
                    <td>${item.quantity}</td>
                    <td>${item.expiryDate}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}

        ${content.alerts.lowStock.length > 0 ? `
          <div class="report-section">
            <h2 class="text-warning">ðŸ“¦ Low Stock Alert</h2>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Crop</th>
                  <th>Available</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                ${content.alerts.lowStock.map(item => `
                  <tr class="alert-row">
                    <td>${item.code}</td>
                    <td>${item.crop}</td>
                    <td class="text-warning"><strong>${item.available}</strong></td>
                    <td>${item.total}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}
      `;
    }













    /**
     * Generate PDF report
     */
    async function generatePDFReport() {
      try {
        showLoading();

        const reportType = document.getElementById('reportType').value;
        const reportPeriod = document.getElementById('reportPeriod').value;
        const dateFrom = document.getElementById('reportDateFrom').value;
        const dateTo = document.getElementById('reportDateTo').value;

        // Generate report data
        const reportData = await generateReportData(reportType, reportPeriod, dateFrom, dateTo);

        // Create a temporary container for the report
        const tempContainer = document.createElement('div');
        tempContainer.innerHTML = generateReportHTML(reportType, reportData);
        tempContainer.style.padding = '20px';
        tempContainer.style.backgroundColor = 'white';
        tempContainer.style.position = 'absolute';
        tempContainer.style.left = '-9999px';
        document.body.appendChild(tempContainer);

        // Use html2canvas and jsPDF
        const canvas = await html2canvas(tempContainer);
        const imgData = canvas.toDataURL('image/png');

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const pageHeight = 295;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        // Remove temporary container
        document.body.removeChild(tempContainer);

        // Save PDF
        const fileName = `${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);

        showToast('PDF report generated successfully', 'success');

      } catch (error) {
        console.error('Error generating PDF report:', error);
        showToast('Error generating PDF report', 'error');
      } finally {
        hideLoading();
      }
    }

    /**
     * Generate Excel report
     */
    async function generateExcelReport() {
      try {
        showLoading();

        const reportType = document.getElementById('reportType').value;
        const reportPeriod = document.getElementById('reportPeriod').value;
        const dateFrom = document.getElementById('reportDateFrom').value;
        const dateTo = document.getElementById('reportDateTo').value;

        // Generate report data
        const reportData = await generateReportData(reportType, reportPeriod, dateFrom, dateTo);

        // Create workbook
        const wb = XLSX.utils.book_new();

        // Add summary sheet
        const summaryData = [];
        summaryData.push(['Smart Agriculture Management System']);
        summaryData.push(['Report Type', reportType.replace('-', ' ').toUpperCase()]);
        summaryData.push(['Generated', formatDateTime(reportData.generatedAt)]);
        summaryData.push(['Farmer', reportData.farmerName]);
        summaryData.push(['Email', reportData.farmerEmail]);
        if (reportData.dateFrom && reportData.dateTo) {
          summaryData.push(['Period', `${formatDate(reportData.dateFrom)} to ${formatDate(reportData.dateTo)}`]);
        }
        summaryData.push([]);

        // Add content based on report type
        switch (reportType) {
          case 'farm-overview':
            addFarmOverviewToExcel(wb, reportData.content, summaryData);
            break;
          case 'production-summary':
            addProductionSummaryToExcel(wb, reportData.content, summaryData);
            break;
          case 'financial-report':
            addFinancialReportToExcel(wb, reportData.content, summaryData);
            break;
          case 'resource-usage':
            addResourceUsageToExcel(wb, reportData.content, summaryData);
            break;
          case 'inventory-report':
            addInventoryReportToExcel(wb, reportData.content, summaryData);
            break;
        }

        // Save Excel file
        const fileName = `${reportType}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);

        showToast('Excel report generated successfully', 'success');

      } catch (error) {
        console.error('Error generating Excel report:', error);
        showToast('Error generating Excel report', 'error');
      } finally {
        hideLoading();
      }
    }

    /**
     * Add farm overview to Excel
     */
    function addFarmOverviewToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['SUMMARY']);
      summaryData.push(['Total Farms', content.summary.totalFarms]);
      summaryData.push(['Total Area (ha)', content.summary.totalArea]);
      summaryData.push(['Irrigated Farms', content.summary.irrigatedFarms]);
      summaryData.push(['Active Farms', content.summary.activeFarms]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Farms details
      const farmsData = [['Farm Name', 'Code', 'Location', 'Size (ha)', 'Soil Type', 'Irrigation', 'Status']];
      content.farms.forEach(farm => {
        farmsData.push([
          farm.name,
          farm.code,
          farm.location,
          farm.size,
          farm.soilType,
          farm.irrigationSystem,
          farm.status
        ]);
      });

      const wsF = XLSX.utils.aoa_to_sheet(farmsData);
      XLSX.utils.book_append_sheet(wb, wsF, 'Farms');
    }

    /**
     * Add production summary to Excel
     */
    function addProductionSummaryToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['SUMMARY']);
      summaryData.push(['Total Productions', content.summary.totalProductions]);
      summaryData.push(['Active Productions', content.summary.activeProductions]);
      summaryData.push(['Completed', content.summary.completedProductions]);
      summaryData.push(['Total Area (ha)', content.summary.totalArea]);
      summaryData.push(['Total Yield (T)', content.summary.totalYield]);
      summaryData.push(['Average Yield (T/ha)', content.summary.averageYield]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Productions details
      const prodData = [['Code', 'Crop', 'Season', 'Area (ha)', 'Expected Yield', 'Actual Yield', 'Planting Date', 'Harvest Date', 'Status']];
      content.productions.forEach(prod => {
        prodData.push([
          prod.code,
          prod.crop,
          prod.season,
          prod.area,
          prod.expectedYield || 'N/A',
          prod.actualYield || 'N/A',
          prod.plantingDate,
          prod.actualHarvestDate,
          prod.status
        ]);
      });

      const wsP = XLSX.utils.aoa_to_sheet(prodData);
      XLSX.utils.book_append_sheet(wb, wsP, 'Productions');
    }

    /**
     * Add financial report to Excel
     */
    function addFinancialReportToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['FINANCIAL SUMMARY']);
      summaryData.push(['Total Revenue', content.summary.totalRevenue]);
      summaryData.push(['Net Revenue', content.summary.netRevenue]);
      summaryData.push(['Transaction Fees', content.summary.transactionFees]);
      summaryData.push(['Total Costs', content.summary.totalCosts]);
      summaryData.push(['Profit/Loss', content.summary.profitLoss]);
      summaryData.push(['Profit Margin', content.summary.profitMargin]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Transactions
      const txData = [['Code', 'Date', 'Buyer', 'Crop', 'Quantity', 'Total Amount', 'Net Amount', 'Status']];
      content.transactions.forEach(tx => {
        txData.push([
          tx.code,
          tx.date,
          tx.buyer,
          tx.crop,
          tx.quantity,
          tx.totalAmount,
          tx.netAmount,
          tx.status
        ]);
      });

      const wsTx = XLSX.utils.aoa_to_sheet(txData);
      XLSX.utils.book_append_sheet(wb, wsTx, 'Transactions');
    }




    /**
     * Add resource usage to Excel
     */
    function addResourceUsageToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['RESOURCE USAGE SUMMARY']);
      summaryData.push(['Fertilizer Applications', content.summary.fertilizerApplications]);
      summaryData.push(['Total Fertilizer', content.summary.totalFertilizerQuantity]);
      summaryData.push(['Fertilizer Cost', content.summary.totalFertilizerCost]);
      summaryData.push(['Irrigation Sessions', content.summary.irrigationSessions]);
      summaryData.push(['Total Water Used', content.summary.totalWaterUsed]);
      summaryData.push(['Irrigation Cost', content.summary.totalIrrigationCost]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Fertilizer details
      const fertData = [['Date', 'Type', 'Name', 'Quantity', 'Method', 'Cost', 'Effectiveness']];
      content.fertilizer.applications.forEach(f => {
        fertData.push([
          f.date,
          f.type,
          f.name,
          f.quantity,
          f.method,
          f.cost,
          f.effectiveness
        ]);
      });

      const wsF = XLSX.utils.aoa_to_sheet(fertData);
      XLSX.utils.book_append_sheet(wb, wsF, 'Fertilizer Usage');

      // Irrigation details
      const irrigData = [['Date', 'Water Amount', 'Duration', 'Method', 'Source', 'Efficiency', 'Cost']];
      content.irrigation.sessions.forEach(i => {
        irrigData.push([
          i.date,
          i.waterAmount,
          i.duration,
          i.method,
          i.source,
          i.efficiency,
          i.cost
        ]);
      });

      const wsI = XLSX.utils.aoa_to_sheet(irrigData);
      XLSX.utils.book_append_sheet(wb, wsI, 'Irrigation Sessions');
    }

    /**
     * Add inventory report to Excel
     */
    function addInventoryReportToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['INVENTORY SUMMARY']);
      summaryData.push(['Total Items', content.summary.totalItems]);
      summaryData.push(['Total Quantity', content.summary.totalQuantity]);
      summaryData.push(['Available Quantity', content.summary.availableQuantity]);
      summaryData.push(['Total Value', content.summary.totalValue]);
      summaryData.push(['Expiring Items', content.summary.expiringItemsCount]);
      summaryData.push(['Expired Items', content.summary.expiredItemsCount]);
      summaryData.push(['Low Stock Items', content.summary.lowStockItemsCount]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Inventory items
      const invData = [['Code', 'Crop', 'Quantity', 'Available', 'Quality', 'Status', 'Value', 'Storage Date', 'Expiry Date']];
      content.items.forEach(item => {
        invData.push([
          item.code,
          item.crop,
          item.quantity,
          item.available,
          item.quality,
          item.status,
          item.value,
          item.storageDate,
          item.expiryDate
        ]);
      });

      const wsInv = XLSX.utils.aoa_to_sheet(invData);
      XLSX.utils.book_append_sheet(wb, wsInv, 'Inventory Items');

      // Expiring items alert
      if (content.alerts.expiring.length > 0) {
        const expiringData = [['Code', 'Crop', 'Quantity', 'Expiry Date', 'Days Until Expiry']];
        content.alerts.expiring.forEach(item => {
          expiringData.push([
            item.code,
            item.crop,
            item.quantity,
            item.expiryDate,
            item.daysUntilExpiry
          ]);
        });

        const wsExp = XLSX.utils.aoa_to_sheet(expiringData);
        XLSX.utils.book_append_sheet(wb, wsExp, 'Expiring Items');
      }

      // Expired items alert
      if (content.alerts.expired.length > 0) {
        const expiredData = [['Code', 'Crop', 'Quantity', 'Expiry Date']];
        content.alerts.expired.forEach(item => {
          expiredData.push([
            item.code,
            item.crop,
            item.quantity,
            item.expiryDate
          ]);
        });

        const wsExpired = XLSX.utils.aoa_to_sheet(expiredData);
        XLSX.utils.book_append_sheet(wb, wsExpired, 'Expired Items');
      }

      // Low stock alert
      if (content.alerts.lowStock.length > 0) {
        const lowStockData = [['Code', 'Crop', 'Available', 'Total']];
        content.alerts.lowStock.forEach(item => {
          lowStockData.push([
            item.code,
            item.crop,
            item.available,
            item.total
          ]);
        });

        const wsLow = XLSX.utils.aoa_to_sheet(lowStockData);
        XLSX.utils.book_append_sheet(wb, wsLow, 'Low Stock Items');
      }
    }

    /**
     * Helper function to update element text content
     */
    function updateElement(elementId, value) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = value;
      }
    }


    /**
     * Initialize all action buttons
     */
    // ============================================================================
    // NOTIFICATIONS SYSTEM
    // ============================================================================
    
    let notifications = [];
    let notificationInterval = null;

    // Load notifications from API
    async function loadNotifications() {
        try {
            if (!currentUser || !currentUser.email) {
                console.warn('âš ï¸ No current user found for notifications');
                return;
            }

            const token = authToken || localStorage.getItem('authToken');
            if (!token) {
                console.warn('âš ï¸ No auth token found');
                return;
            }

            // Fetch notifications from chat API
            const response = await fetch(`${API_CONFIG.BASE_URL}/chat/notifications`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            notifications = Array.isArray(data) ? data : [];

            // Also fetch farmer-specific notifications (new farms, productions, etc.)
            await loadFarmerSpecificNotifications();

            displayNotifications();
            updateNotificationBadge();

        } catch (error) {
            console.error('âŒ Error loading notifications:', error);
            // Fallback: create sample notifications for demo
            notifications = [];
            displayNotifications();
        }
    }

    // Load farmer-specific notifications
    async function loadFarmerSpecificNotifications() {
        try {
            if (!currentUser || !currentUser.id) return;

            const farmerId = currentUser.id;

            // Check for new farms
            try {
                const farmsResponse = await apiRequest(`/farms/farmer/${farmerId}/all`);
                const farms = Array.isArray(farmsResponse) ? farmsResponse : [];
                
                // Get recently created farms (last 24 hours)
                const recentFarms = farms.filter(farm => {
                    if (!farm.createdAt) return false;
                    const created = new Date(farm.createdAt);
                    const now = new Date();
                    const diffHours = (now - created) / (1000 * 60 * 60);
                    return diffHours <= 24;
                });

                recentFarms.forEach(farm => {
                    const exists = notifications.some(n => 
                        n.content && n.content.includes(`Farm "${farm.farmName}"`) && 
                        n.type === 'SYSTEM_ALERT'
                    );
                    if (!exists) {
                        notifications.unshift({
                            id: `farm-${farm.id}`,
                            senderId: 'SYSTEM',
                            recipientId: currentUser.email,
                            content: `New farm "${farm.farmName}" has been registered successfully!`,
                            type: 'SYSTEM_ALERT',
                            read: false,
                            timestamp: farm.createdAt || new Date().toISOString()
                        });
                    }
                });
            } catch (error) {
                console.warn('Error loading farm notifications:', error);
            }

            // Check for new productions
            try {
                const productionsResponse = await apiRequest(`/v1/crop-productions/farmer/${farmerId}`);
                const productions = Array.isArray(productionsResponse) ? productionsResponse : 
                                  (productionsResponse.data ? productionsResponse.data : []);

                const recentProductions = productions.filter(prod => {
                    if (!prod.createdAt) return false;
                    const created = new Date(prod.createdAt);
                    const now = new Date();
                    const diffHours = (now - created) / (1000 * 60 * 60);
                    return diffHours <= 24;
                });

                recentProductions.forEach(prod => {
                    const exists = notifications.some(n => 
                        n.content && n.content.includes(`Production`) && 
                        n.type === 'SYSTEM_ALERT'
                    );
                    if (!exists) {
                        notifications.unshift({
                            id: `prod-${prod.id}`,
                            senderId: 'SYSTEM',
                            recipientId: currentUser.email,
                            content: `New crop production has been created! Check your productions section.`,
                            type: 'SYSTEM_ALERT',
                            read: false,
                            timestamp: prod.createdAt || new Date().toISOString()
                        });
                    }
                });
            } catch (error) {
                console.warn('Error loading production notifications:', error);
            }

        } catch (error) {
            console.error('Error loading farmer-specific notifications:', error);
        }
    }

    // Display notifications in dropdown
    function displayNotifications() {
        const notificationsList = document.getElementById('notificationsList');
        const notificationBadge = document.getElementById('notificationCount');

        if (!notificationsList) return;

        const unreadCount = notifications.filter(n => !n.read).length;

        if (notificationBadge) {
            notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
        }

        if (notifications.length === 0) {
            notificationsList.innerHTML = `
                <div class="notification-empty">
                    <i class="fas fa-bell-slash"></i>
                    <p>No notifications</p>
                    <small>You're all caught up!</small>
                </div>
            `;
            return;
        }

        // Sort by timestamp (newest first)
        const sortedNotifications = [...notifications].sort((a, b) => {
            const dateA = new Date(a.timestamp || 0);
            const dateB = new Date(b.timestamp || 0);
            return dateB - dateA;
        });

        notificationsList.innerHTML = sortedNotifications.map(notification => {
            const isUnread = !notification.read;
            const timeAgo = formatTimeAgo(notification.timestamp);
            const icon = getNotificationIcon(notification.type);

            return `
                <div class="notification-item ${isUnread ? 'unread' : ''}" onclick="markNotificationAsRead(${notification.id})" data-notification-id="${notification.id}">
                    <div class="notification-item-title">
                        <i class="${icon}" style="margin-right: 0.5rem; color: var(--primary-green);"></i>
                        ${getNotificationTitle(notification.type)}
                    </div>
                    <div class="notification-item-message">
                        ${escapeHtml(notification.content || notification.message || 'New notification')}
                    </div>
                    <div class="notification-item-time">
                        <i class="fas fa-clock"></i>
                        ${timeAgo}
                    </div>
                </div>
            `;
        }).join('');
    }

    // Update notification badge count
    function updateNotificationBadge() {
        const notificationBadge = document.getElementById('notificationCount');
        if (notificationBadge) {
            const unreadCount = notifications.filter(n => !n.read).length;
            notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
        }
    }

    // Mark notification as read
    async function markNotificationAsRead(notificationId) {
        try {
            const notification = notifications.find(n => n.id === notificationId);
            if (!notification) return;

            // Update locally
            notification.read = true;
            displayNotifications();
            updateNotificationBadge();

            // Mark as read on server if it's a chat notification
            if (notificationId && typeof notificationId === 'number') {
                const token = authToken || localStorage.getItem('authToken');
                if (token) {
                    await fetch(`${API_CONFIG.BASE_URL}/chat/notifications/${notificationId}/read`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                }
            }
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    }

    // Mark all notifications as read
    async function markAllNotificationsAsRead() {
        try {
            notifications.forEach(n => n.read = true);
            displayNotifications();
            updateNotificationBadge();

            const token = authToken || localStorage.getItem('authToken');
            if (token) {
                // Mark all as read on server
                notifications.forEach(async (notification) => {
                    if (notification.id && typeof notification.id === 'number' && !notification.read) {
                        try {
                            await fetch(`${API_CONFIG.BASE_URL}/chat/notifications/${notification.id}/read`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                }
                            });
                        } catch (error) {
                            console.warn('Error marking notification as read:', error);
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error marking all notifications as read:', error);
        }
    }

    // Toggle notifications dropdown
    function toggleNotifications() {
        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown) {
            const isVisible = dropdown.style.display === 'block' || dropdown.classList.contains('show');
            if (isVisible) {
                dropdown.style.display = 'none';
                dropdown.classList.remove('show');
            } else {
                dropdown.style.display = 'block';
                dropdown.classList.add('show');
                loadNotifications(); // Refresh when opening
            }
        }
    }

    // Helper functions
    function formatTimeAgo(timestamp) {
        if (!timestamp) return 'Just now';
        const now = new Date();
        const time = new Date(timestamp);
        const diffMs = now - time;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        return formatDate(timestamp);
    }

    function getNotificationIcon(type) {
        const icons = {
            'MESSAGE': 'fas fa-comment',
            'SYSTEM_ALERT': 'fas fa-info-circle',
            'FARM': 'fas fa-tractor',
            'PRODUCTION': 'fas fa-seedling',
            'TRANSACTION': 'fas fa-dollar-sign'
        };
        return icons[type] || 'fas fa-bell';
    }

    function getNotificationTitle(type) {
        const titles = {
            'MESSAGE': 'New Message',
            'SYSTEM_ALERT': 'System Alert',
            'FARM': 'Farm Update',
            'PRODUCTION': 'Production Update',
            'TRANSACTION': 'Transaction Update'
        };
        return titles[type] || 'Notification';
    }

    // Close notifications dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('notificationDropdown');
        const btn = document.getElementById('notificationBtn');
        if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
            dropdown.style.display = 'none';
            dropdown.classList.remove('show');
        }
    });

    // Initialize notifications on page load
    function initNotifications() {
        const notificationBtn = document.getElementById('notificationBtn');
        if (notificationBtn) {
            notificationBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleNotifications();
            });
        }

        // Load notifications every 30 seconds
        loadNotifications();
        if (notificationInterval) {
            clearInterval(notificationInterval);
        }
        notificationInterval = setInterval(loadNotifications, 30000);
    }

    // ============================================================================
    // END NOTIFICATIONS SYSTEM
    // ============================================================================

    function initActionButtons() {
      // Add Farm buttons
      document.querySelectorAll('[data-action="add-farm"]').forEach(btn => {
        btn.addEventListener('click', openAddFarmModal);
      });

      // Add Production buttons
      document.querySelectorAll('[data-action="add-production"]').forEach(btn => {
        btn.addEventListener('click', openAddProductionModal);
      });

      // Add Inventory buttons
      document.querySelectorAll('[data-action="add-inventory"]').forEach(btn => {
        btn.addEventListener('click', openAddInventoryModal);
      });

      // Refresh buttons
      document.querySelectorAll('[data-action="refresh-farms"]').forEach(btn => {
        btn.addEventListener('click', () => loadFarmsData());
      });

      document.querySelectorAll('[data-action="refresh-crops"]').forEach(btn => {
        btn.addEventListener('click', () => loadCropsData());
      });

      document.querySelectorAll('[data-action="refresh-productions"]').forEach(btn => {
        btn.addEventListener('click', () => loadProductionData());
      });

      document.querySelectorAll('[data-action="refresh-inventory"]').forEach(btn => {
        btn.addEventListener('click', () => loadInventoryData());
      });

      document.querySelectorAll('[data-action="refresh-fertilizer"]').forEach(btn => {
        btn.addEventListener('click', () => loadFertilizerData());
      });

      document.querySelectorAll('[data-action="refresh-irrigation"]').forEach(btn => {
        btn.addEventListener('click', () => loadIrrigationData());
      });

      document.querySelectorAll('[data-action="refresh-soil"]').forEach(btn => {
        btn.addEventListener('click', () => loadSoilData());
      });

      document.querySelectorAll('[data-action="refresh-market-prices"]').forEach(btn => {
        btn.addEventListener('click', () => loadMarketPricesData());
      });

      document.querySelectorAll('[data-action="refresh-transactions"]').forEach(btn => {
        btn.addEventListener('click', () => loadTransactionsData());
      });

      document.querySelectorAll('[data-action="refresh-supply-chain"]').forEach(btn => {
        btn.addEventListener('click', () => loadSupplyChainData());
      });

      document.querySelectorAll('[data-action="refresh-weather"]').forEach(btn => {
        btn.addEventListener('click', () => loadWeatherData());
      });

      document.querySelectorAll('[data-action="refresh-alerts"]').forEach(btn => {
        btn.addEventListener('click', () => loadAlertsData());
      });

      document.querySelectorAll('[data-action="refresh-policies"]').forEach(btn => {
        btn.addEventListener('click', () => loadPoliciesData());
      });

      document.querySelectorAll('[data-action="refresh-recommendations"]').forEach(btn => {
        btn.addEventListener('click', () => loadRecommendationsData());
      });

      document.querySelectorAll('[data-action="refresh-predictions"]').forEach(btn => {
        btn.addEventListener('click', () => loadPredictionsData());
      });

      // Export buttons
      document.querySelectorAll('[data-action="export-farms"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export farms feature - To be implemented', 'info'));
      });

      document.querySelectorAll('[data-action="export-productions"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export productions feature - To be implemented', 'info'));
      });

      document.querySelectorAll('[data-action="export-inventory"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export inventory feature - To be implemented', 'info'));
      });

      document.querySelectorAll('[data-action="export-fertilizer"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export fertilizer feature - To be implemented', 'info'));
      });

      document.querySelectorAll('[data-action="export-irrigation"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export irrigation feature - To be implemented', 'info'));
      });

      document.querySelectorAll('[data-action="export-transactions"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export transactions feature - To be implemented', 'info'));
      });

      // Tasks and Activities refresh
      document.querySelectorAll('[data-action="refresh-tasks"]').forEach(btn => {
        btn.addEventListener('click', () => loadUpcomingTasks());
      });

      document.querySelectorAll('[data-action="refresh-activities"]').forEach(btn => {
        btn.addEventListener('click', () => loadRecentActivities());
      });

      // Clear filter buttons
      document.querySelectorAll('[data-action="clear-filters"]').forEach(btn => {
        btn.addEventListener('click', clearFilters);
      });

      document.querySelectorAll('[data-action="clear-crop-filters"]').forEach(btn => {
        btn.addEventListener('click', clearCropFilters);
      });

      document.querySelectorAll('[data-action="clear-production-filters"]').forEach(btn => {
        btn.addEventListener('click', clearProductionFilters);
      });

      document.querySelectorAll('[data-action="clear-inventory-filters"]').forEach(btn => {
        btn.addEventListener('click', clearInventoryFilters);
      });

      document.querySelectorAll('[data-action="clear-fertilizer-filters"]').forEach(btn => {
        btn.addEventListener('click', clearFertilizerFilters);
      });

      document.querySelectorAll('[data-action="clear-irrigation-filters"]').forEach(btn => {
        btn.addEventListener('click', clearIrrigationFilters);
      });

      document.querySelectorAll('[data-action="clear-market-prices-filters"]').forEach(btn => {
        btn.addEventListener('click', clearMarketPricesFilters);
      });

      document.querySelectorAll('[data-action="clear-transactions-filters"]').forEach(btn => {
        btn.addEventListener('click', clearTransactionsFilters);
      });

      document.querySelectorAll('[data-action="clear-alerts-filters"]').forEach(btn => {
        btn.addEventListener('click', clearAlertsFilters);
      });

      // Alerts filter listeners
      const alertsSearchInput = document.getElementById('alertsSearchInput');
      const alertsLevelFilter = document.getElementById('alertsLevelFilter');
      const alertsCategoryFilter = document.getElementById('alertsCategoryFilter');

      if (alertsSearchInput) {
        alertsSearchInput.addEventListener('input', filterAlerts);
        alertsSearchInput.addEventListener('keyup', filterAlerts);
      }

      if (alertsLevelFilter) {
        alertsLevelFilter.addEventListener('change', filterAlerts);
      }

      if (alertsCategoryFilter) {
        alertsCategoryFilter.addEventListener('change', filterAlerts);
      }

      document.querySelectorAll('[data-action="clear-policies-filters"]').forEach(btn => {
        btn.addEventListener('click', clearPoliciesFilters);
      });

      // Policies filter listeners
      const policiesSearchInput = document.getElementById('policiesSearchInput');
      const policiesTypeFilter = document.getElementById('policiesTypeFilter');
      const policiesStatusFilter = document.getElementById('policiesStatusFilter');

      if (policiesSearchInput) {
        policiesSearchInput.addEventListener('input', filterPolicies);
        policiesSearchInput.addEventListener('keyup', filterPolicies);
      }

      if (policiesTypeFilter) {
        policiesTypeFilter.addEventListener('change', filterPolicies);
      }

      if (policiesStatusFilter) {
        policiesStatusFilter.addEventListener('change', filterPolicies);
      }

      document.querySelectorAll('[data-action="clear-recommendations-filters"]').forEach(btn => {
        btn.addEventListener('click', clearRecommendationsFilters);
      });

      // Recommendations filter listeners
      const recommendationsTypeFilter = document.getElementById('recommendationsTypeFilter');
      const recommendationsPriorityFilter = document.getElementById('recommendationsPriorityFilter');

      if (recommendationsTypeFilter) {
        recommendationsTypeFilter.addEventListener('change', filterRecommendations);
      }

      if (recommendationsPriorityFilter) {
        recommendationsPriorityFilter.addEventListener('change', filterRecommendations);
      }
    }

    /**
     * Clear filter functions
     */
    function clearFilters() {
      const searchInput = document.getElementById('farmsSearchInput');
      const soilTypeFilter = document.getElementById('farmsSoilTypeFilter');
      const irrigationFilter = document.getElementById('farmsIrrigationFilter');

      if (searchInput) searchInput.value = '';
      if (soilTypeFilter) soilTypeFilter.value = '';
      if (irrigationFilter) irrigationFilter.value = '';

      loadFarmsData();
    }

    function clearCropFilters() {
      const searchInput = document.getElementById('cropsSearchInput');
      const typeFilter = document.getElementById('cropsTypeFilter');
      const seasonFilter = document.getElementById('cropsSeasonFilter');
      const demandFilter = document.getElementById('cropsDemandFilter');

      if (searchInput) searchInput.value = '';
      if (typeFilter) typeFilter.value = '';
      if (seasonFilter) seasonFilter.value = '';
      if (demandFilter) demandFilter.value = '';

      loadCropsData();
    }

    function clearProductionFilters() {
      const searchInput = document.getElementById('productionSearchInput');
      const statusFilter = document.getElementById('productionStatusFilter');
      const seasonFilter = document.getElementById('productionSeasonFilter');
      const yearFilter = document.getElementById('productionYearFilter');

      if (searchInput) searchInput.value = '';
      if (statusFilter) statusFilter.value = '';
      if (seasonFilter) seasonFilter.value = '';
      if (yearFilter) yearFilter.value = '';

      loadProductionData();
    }

    function clearInventoryFilters() {
      const searchInput = document.getElementById('inventorySearchInput');
      const statusFilter = document.getElementById('inventoryStatusFilter');
      const qualityFilter = document.getElementById('inventoryQualityFilter');

      if (searchInput) searchInput.value = '';
      if (statusFilter) statusFilter.value = '';
      if (qualityFilter) qualityFilter.value = '';

      loadInventoryData();
    }

    function clearFertilizerFilters() {
      const searchInput = document.getElementById('fertilizerSearchInput');
      const typeFilter = document.getElementById('fertilizerTypeFilter');
      const dateFrom = document.getElementById('fertilizerDateFrom');
      const dateTo = document.getElementById('fertilizerDateTo');

      if (searchInput) searchInput.value = '';
      if (typeFilter) typeFilter.value = '';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';

      loadFertilizerData();
    }

    function clearIrrigationFilters() {
      const searchInput = document.getElementById('irrigationSearchInput');
      const methodFilter = document.getElementById('irrigationMethodFilter');
      const sourceFilter = document.getElementById('irrigationSourceFilter');
      const dateFrom = document.getElementById('irrigationDateFrom');
      const dateTo = document.getElementById('irrigationDateTo');

      if (searchInput) searchInput.value = '';
      if (methodFilter) methodFilter.value = '';
      if (sourceFilter) sourceFilter.value = '';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';

      loadIrrigationData();
    }

    function clearMarketPricesFilters() {
      const searchInput = document.getElementById('marketPricesSearchInput');
      const typeFilter = document.getElementById('marketPricesTypeFilter');
      const trendFilter = document.getElementById('marketPricesTrendFilter');

      if (searchInput) searchInput.value = '';
      if (typeFilter) typeFilter.value = '';
      if (trendFilter) trendFilter.value = '';

      loadMarketPricesData();
    }

    function clearTransactionsFilters() {
      const searchInput = document.getElementById('transactionsSearchInput');
      const statusFilter = document.getElementById('transactionsStatusFilter');
      const dateFrom = document.getElementById('transactionsDateFrom');
      const dateTo = document.getElementById('transactionsDateTo');

      if (searchInput) searchInput.value = '';
      if (statusFilter) statusFilter.value = '';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';

      loadTransactionsData();
    }

    // Store alerts globally for filtering
    let allAlertsData = [];

    function clearAlertsFilters() {
      const searchInput = document.getElementById('alertsSearchInput');
      const levelFilter = document.getElementById('alertsLevelFilter');
      const categoryFilter = document.getElementById('alertsCategoryFilter');

      if (searchInput) searchInput.value = '';
      if (levelFilter) levelFilter.value = '';
      if (categoryFilter) categoryFilter.value = '';

      // Re-display all alerts
      if (allAlertsData.length > 0) {
        displayAlertsList(allAlertsData);
        updateAlertsStatistics(allAlertsData);
      } else {
        loadAlertsData();
      }
    }

    /**
     * Filter alerts based on search and filters
     */
    function filterAlerts() {
      const searchInput = document.getElementById('alertsSearchInput');
      const levelFilter = document.getElementById('alertsLevelFilter');
      const categoryFilter = document.getElementById('alertsCategoryFilter');

      if (!searchInput || !levelFilter || !categoryFilter) return;

      const searchTerm = (searchInput.value || '').toLowerCase();
      const levelValue = levelFilter.value;
      const categoryValue = categoryFilter.value;

      const filtered = allAlertsData.filter(alert => {
        // Search filter
        if (searchTerm) {
          const titleMatch = (alert.alertTitle || '').toLowerCase().includes(searchTerm);
          const descMatch = (alert.description || '').toLowerCase().includes(searchTerm);
          if (!titleMatch && !descMatch) return false;
        }

        // Level filter
        if (levelValue && alert.alertLevel !== levelValue) {
          return false;
        }

        // Category filter
        if (categoryValue) {
          const alertCategory = alert.alertCategory || alert.category || '';
          if (alertCategory !== categoryValue) {
            return false;
          }
        }

        return true;
      });

      displayAlertsList(filtered);
      updateAlertsStatistics(filtered);
    }

    /**
     * Filter policies based on search and filters
     */
    function filterPolicies() {
      const searchInput = document.getElementById('policiesSearchInput');
      const typeFilter = document.getElementById('policiesTypeFilter');
      const statusFilter = document.getElementById('policiesStatusFilter');

      if (!searchInput || !typeFilter || !statusFilter) return;

      const searchTerm = (searchInput.value || '').toLowerCase();
      const typeValue = typeFilter.value;
      const statusValue = statusFilter.value;

      const filtered = allPoliciesData.filter(policy => {
        // Search filter
        if (searchTerm) {
          const nameMatch = (policy.policyName || '').toLowerCase().includes(searchTerm);
          const descMatch = (policy.description || '').toLowerCase().includes(searchTerm);
          const codeMatch = (policy.policyCode || '').toLowerCase().includes(searchTerm);
          if (!nameMatch && !descMatch && !codeMatch) return false;
        }

        // Type filter
        if (typeValue && policy.policyType !== typeValue) {
          return false;
        }

        // Status filter
        if (statusValue) {
          if (statusValue === 'ACTIVE') {
            // Check if policy is actually active
            const isActive = policy.status === 'ACTIVE' || 
              (policy.effectiveDate && new Date(policy.effectiveDate) <= new Date() && 
               (!policy.expiryDate || new Date(policy.expiryDate) >= new Date()));
            if (!isActive) return false;
          } else if (policy.status !== statusValue) {
            return false;
          }
        }

        return true;
      });

      displayPoliciesGrid(filtered);
    }

    function clearPoliciesFilters() {
      const searchInput = document.getElementById('policiesSearchInput');
      const typeFilter = document.getElementById('policiesTypeFilter');
      const statusFilter = document.getElementById('policiesStatusFilter');

      if (searchInput) searchInput.value = '';
      if (typeFilter) typeFilter.value = '';
      if (statusFilter) statusFilter.value = '';

      // Re-display all policies
      if (allPoliciesData.length > 0) {
        displayPoliciesGrid(allPoliciesData);
      } else {
        loadPoliciesData();
      }
    }

    // clearRecommendationsFilters function is defined above in the AI Recommendations module







  // ============================================================================
  // PAGE INITIALIZATION
  // ============================================================================

  /**
   * Initialize the dashboard on page load
   */
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      if (DEBUG_MODE) {
        console.log('=== DASHBOARD INITIALIZATION ===');
        console.log('Starting dashboard initialization...');
      }

      // Show loading overlay
      showLoading();

      // CORRECTION: Utiliser UserSessionHandler au lieu de loadUserSession()
      const sessionHandler = UserSessionHandler.getInstance();

      // VÃ©rifier si l'utilisateur est authentifiÃ©
      if (!sessionHandler.isAuthenticated()) {
        console.error('No valid user session found');
        window.location.href = '/login.html';
        return;
      }

      // Charger l'utilisateur depuis la session
      const user = sessionHandler.getCurrentUser();
      if (!user) {
        console.error('Could not retrieve user data');
        window.location.href = '/login.html';
        return;
      }

      // Assigner Ã  currentUser pour le reste du code
      currentUser = user;
      authToken = user.token || sessionHandler.getAuthToken();

      if (DEBUG_MODE) {
        console.log('User session loaded:', {
          id: user.id || user.userId,
          email: user.email,
          role: user.role,
          fullName: user.fullName
        });
      }

      // Update UI with user info
      updateProfileDisplay();
      updateCurrentDate();

      // Initialize navigation
      initNavigation();

      // Initialize action buttons
      initActionButtons();

      // Initialize notifications system
      initNotifications();

      // Initialize reports listeners
      initReportsListeners();

      // Load initial dashboard data
      await loadDashboardData();

      if (DEBUG_MODE) {
        console.log('Dashboard initialized successfully');
        console.log('=================================');
      }

      // Show success message
      showToast(`Welcome back, ${user.fullName}!`, 'success');

    } catch (error) {
      console.error('Error initializing dashboard:', error);
      showToast('Error loading dashboard. Please refresh the page.', 'error');
    } finally {
      hideLoading();
    }
  });




    /**
     * Handle page visibility change - refresh data when page becomes visible
     */
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && currentUser) {
        // Refresh current section data when page becomes visible
        const activeSection = document.querySelector('.content-section.active');
        if (activeSection) {
          const sectionId = activeSection.id.replace('Section', '');
          loadSectionData(sectionId);
        }
      }
    });

    /**
     * Handle window resize - adjust charts
     */
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        // Resize all charts
        Object.values(charts).forEach(chart => {
          if (chart) {
            chart.resize();
          }
        });
      }, 250);
    });

    /**
     * Cleanup before page unload
     */
    window.addEventListener('beforeunload', () => {
      // Destroy all charts
      Object.values(charts).forEach(chart => {
        if (chart) {
          chart.destroy();
        }
      });
    });

    // ============================================================================
    // ERROR HANDLERS
    // ============================================================================

    /**
     * Global error handler
     */
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      if (DEBUG_MODE) {
        showToast('An unexpected error occurred', 'error');
      }
    });

    /**
     * Global unhandled rejection handler
     */
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      if (DEBUG_MODE) {
        showToast('An unexpected error occurred', 'error');
      }
    });

    // ============================================================================
    // CONSOLE MESSAGE
    // ============================================================================

    if (DEBUG_MODE) {
      console.log('%cðŸŒ¾ AgriGuard AI - Farmer Dashboard', 'color: #22c55e; font-size: 20px; font-weight: bold;');
      console.log('%cDashboard Version: 1.0.0', 'color: #666; font-size: 12px;');
      console.log('%cAPI Base URL: ' + API_CONFIG.BASE_URL, 'color: #666; font-size: 12px;');
      console.log('%cDebug Mode: ON', 'color: #f59e0b; font-size: 12px; font-weight: bold;');
    }

</script>
</body>
</html>