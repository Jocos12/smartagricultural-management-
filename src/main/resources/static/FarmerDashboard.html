<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriGuard AI - Farmer Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>







        :root {
        --primary-green: #22c55e;
        --primary-dark: #16a34a;
        --secondary-green: #10b981;
        --accent-green: #34d399;
        --light-green: #dcfce7;
        --dark-green: #166534;
        --forest-green: #065f46;
        --success-color: #22c55e;
        --warning-color: #f59e0b;
        --error-color: #ef4444;
        --info-color: #3b82f6;
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --bg-sidebar: #e8f5e8;
        --text-primary: #333333;
        --text-secondary: #666666;
        --border-color: #e0e0e0;
        --hover-bg: rgba(34, 197, 94, 0.1);
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 8px 25px rgba(34, 197, 94, 0.15);
        --gradient-primary: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
        --gradient-bg: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
        --card-bg: #ffffff;
        --modal-bg: rgba(0, 0, 0, 0.5);
    }

    .dark-mode {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-sidebar: #1f2937;
        --text-primary: #ffffff;
        --text-secondary: #cccccc;
        --border-color: #404040;
        --hover-bg: rgba(34, 197, 94, 0.2);
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        --card-bg: #374151;
        --gradient-bg: linear-gradient(135deg, #1f2937 0%, #374151 50%, #4b5563 100%);
    }

    /* Reset & Base Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: var(--gradient-bg);
        color: var(--text-primary);
        transition: all 0.3s ease;
        overflow-x: hidden;
    }

    /* Dashboard Container */
    .dashboard-container {
        display: flex;
        height: 100vh;
    }

    /* Sidebar Styles */
    .sidebar {
        width: 280px;
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: fixed;
        height: 100vh;
        z-index: 1000;
        box-shadow: var(--shadow);
        overflow-y: auto;
    }

    .sidebar.collapsed {
        width: 70px;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
    }

    .logo {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--gradient-primary);
        color: white;
        font-size: 24px;
        box-shadow: var(--shadow);
        animation: pulse 2s infinite;
        flex-shrink: 0;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .company-info {
        flex: 1;
        transition: opacity 0.3s ease;
        overflow: hidden;
    }

    .company-name {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 2px;
        white-space: nowrap;
    }

    .company-tagline {
        font-size: 11px;
        color: var(--primary-green);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .sidebar.collapsed .company-info {
        opacity: 0;
        width: 0;
    }

    /* Sidebar Navigation */
    .sidebar-nav {
        flex: 1;
        padding: 20px 0;
        overflow-y: auto;
    }

    .nav-section {
        margin-bottom: 30px;
    }

    .nav-section-title {
        padding: 0 20px 10px;
        font-size: 11px;
        font-weight: 700;
        color: var(--primary-green);
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: opacity 0.3s ease;
    }

    .sidebar.collapsed .nav-section-title {
        opacity: 0;
        height: 0;
        margin: 0;
        padding: 0;
    }

    .nav-menu {
        list-style: none;
    }

    .nav-item {
        margin-bottom: 4px;
    }

    .nav-link {
        display: flex;
        align-items: center;
        padding: 14px 20px;
        color: var(--text-primary);
        text-decoration: none;
        border-radius: 0 25px 25px 0;
        margin-right: 20px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .nav-link::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.1), transparent);
        transition: left 0.5s ease;
    }

    .nav-link:hover::before {
        left: 100%;
    }

    .nav-link i {
        width: 22px;
        margin-right: 14px;
        font-size: 18px;
        flex-shrink: 0;
    }

    .nav-link span {
        transition: opacity 0.3s ease;
        white-space: nowrap;
        font-weight: 500;
    }

    .sidebar.collapsed .nav-link span {
        opacity: 0;
    }

    .sidebar.collapsed .nav-link {
        margin-right: 0;
        border-radius: 0;
        justify-content: center;
    }

    .nav-link:hover {
        background: var(--hover-bg);
        color: var(--primary-green);
        transform: translateX(5px);
    }

    .nav-item.active .nav-link {
        background: var(--gradient-primary);
        color: white;
        box-shadow: var(--shadow);
    }

    .nav-item.active .nav-link:hover {
        background: var(--gradient-primary);
        color: white;
    }

    /* Main Content Area */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-left: 280px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        width: calc(100% - 280px);
    }

    .main-content.sidebar-collapsed {
        margin-left: 70px;
        width: calc(100% - 70px);
    }

    /* Header */
    .header {
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 0 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 80px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        flex-shrink: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        width: 100%;
        z-index: 9999; /* Ajouté */
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 24px;
    }

    .sidebar-toggle {
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: 20px;
        cursor: pointer;
        padding: 12px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .sidebar-toggle:hover {
        background: var(--hover-bg);
        color: var(--primary-green);
        transform: scale(1.1);
    }

    .greeting-section {
        display: flex;
        flex-direction: column;
    }

    .greeting-text {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 2px;
    }

    .current-date {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Search Container */
    .search-container {
        position: relative;
        width: 400px;
    }

    .search-input {
        width: 100%;
        padding: 12px 50px 12px 20px;
        border: 2px solid var(--border-color);
        border-radius: 25px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 15px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
    }

    .search-icon {
        position: absolute;
        right: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 18px;
    }

    /* Header Right */
    .header-right {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .theme-toggle {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        color: var(--text-primary);
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .theme-toggle:hover {
        background: var(--hover-bg);
        border-color: var(--primary-green);
        transform: translateY(-2px);
    }

    .notification-btn {
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: 20px;
        cursor: pointer;
        position: relative;
        padding: 12px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .notification-btn:hover {
        background: var(--hover-bg);
        color: var(--primary-green);
    }

    .notification-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: var(--error-color);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        animation: bounce 1s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-5px); }
        60% { transform: translateY(-3px); }
    }

    .notification-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.5rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        width: 380px;
        max-height: 500px;
        overflow-y: auto;
        z-index: 1000;
        border: 1px solid #e9ecef;
        animation: slideDown 0.3s ease;
    }

    .notification-dropdown.show {
        display: block !important;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .notification-item {
        padding: 1rem;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .notification-item:hover {
        background: #f8f9fa;
    }

    .notification-item.unread {
        background: #f0f7ff;
        border-left: 4px solid var(--primary-green);
    }

    .notification-item.unread::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        background: var(--primary-green);
        border-radius: 50%;
    }

    .notification-item-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.25rem;
        font-size: 0.95rem;
    }

    .notification-item-message {
        color: #666;
        font-size: 0.85rem;
        line-height: 1.4;
        margin-bottom: 0.5rem;
    }

    .notification-item-time {
        color: #999;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .notification-empty {
        padding: 3rem 2rem;
        text-align: center;
        color: #999;
    }

    .notification-empty i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    .profile-section {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .profile-section:hover {
        background: var(--hover-bg);
    }

    .profile-avatar {
        width: 45px;
        height: 45px;
        background: var(--gradient-primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 16px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
    }

    .profile-info {
        display: flex;
        flex-direction: column;
    }

    .profile-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .profile-role {
        font-size: 12px;
        color: var(--primary-green);
        font-weight: 500;
        text-transform: capitalize;
    }

    .logout-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s ease;
        margin-left: 12px;
    }

    .logout-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
        transform: scale(1.1);
    }

    /* Content Area */
    .content {
        flex: 1;
        padding: 32px;
        background: var(--bg-secondary);
        overflow-y: auto;
        min-height: calc(100vh - 80px);
    }

    /* Content Sections */
    .content-section {
        display: none;
    }

    .content-section.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Section Header */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .section-header-left {
        flex: 1;
    }

    .section-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .section-subtitle {
        font-size: 16px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .section-header-right {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    /* Welcome Banner */
    .welcome-banner {
        background: var(--gradient-primary);
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow-lg);
        color: white;
        flex-wrap: wrap;
        gap: 24px;
    }

    .welcome-content {
        flex: 1;
    }

    .welcome-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .welcome-subtitle {
        font-size: 18px;
        opacity: 0.9;
    }

    .welcome-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    /* Stat Cards */
    .stat-card {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        margin-bottom: 16px;
    }

    .stat-icon.farms { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .stat-icon.productions { background: linear-gradient(135deg, #10b981, #047857); }
    .stat-icon.inventory { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .stat-icon.alerts { background: linear-gradient(135deg, #f59e0b, #d97706); }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .stat-sublabel {
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Mini Stat Cards */
    .stats-mini-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-mini-card {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.3s ease;
    }

    .stat-mini-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }

    .stat-mini-card.alert {
        border-left: 4px solid var(--error-color);
    }

    .stat-mini-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        background: var(--hover-bg);
        color: var(--primary-green);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .stat-mini-content {
        flex: 1;
    }

    .stat-mini-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .stat-mini-label {
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Charts Section */
    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    .chart-card {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .chart-filter {
        padding: 8px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chart-filter:focus {
        outline: none;
        border-color: var(--primary-green);
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    /* Dashboard Info Grid */
    .dashboard-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    .info-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .info-card-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .info-card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .info-card-content {
        padding: 24px;
        max-height: 400px;
        overflow-y: auto;
    }

    /* Task List */
    .task-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .task-item {
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        border-left: 4px solid var(--primary-green);
        transition: all 0.3s ease;
    }

    .task-item:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow);
    }

    .task-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .task-details {
        display: flex;
        gap: 16px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    /* Activity List */
    .activity-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .activity-item {
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        display: flex;
        gap: 16px;
        transition: all 0.3s ease;
    }

    .activity-item:hover {
        box-shadow: var(--shadow);
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--hover-bg);
        color: var(--primary-green);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .activity-content {
        flex: 1;
    }

    .activity-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .activity-time {
        font-size: 12px;
        color: var(--text-secondary);
    }

    /* Alerts Section */
    .alerts-section {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 32px;
    }

    .alerts-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .alerts-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alerts-view-all {
        color: var(--primary-green);
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .alerts-view-all:hover {
        text-decoration: underline;
    }

    .alerts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;
    }

    .alert-card {
        padding: 16px;
        border-radius: 10px;
        border-left: 4px solid;
        background: var(--bg-secondary);
        transition: all 0.3s ease;
    }

    .alert-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
    }

    .alert-card.critical { border-left-color: var(--error-color); }
    .alert-card.high { border-left-color: var(--warning-color); }
    .alert-card.medium { border-left-color: var(--info-color); }
    .alert-card.low { border-left-color: var(--primary-green); }

    .alert-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .alert-level {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .alert-level.critical {
        background: var(--error-color);
        color: white;
    }

    .alert-level.high {
        background: var(--warning-color);
        color: white;
    }

    .alert-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .alert-description {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
    }

    /* Weather Widget */
    .weather-widget {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 32px;
    }

    .weather-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .weather-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .weather-location {
        font-size: 14px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .weather-content {
        display: flex;
        gap: 32px;
        align-items: center;
    }

    .weather-current {
        flex: 1;
    }

    .weather-temp {
        font-size: 48px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .weather-condition {
        font-size: 18px;
        color: var(--text-secondary);
    }

    .weather-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        flex: 2;
    }

    .weather-detail {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .weather-detail i {
        font-size: 24px;
        color: var(--primary-green);
    }

    .weather-detail span {
        font-size: 13px;
        color: var(--text-secondary);
        display: block;
    }

    .weather-detail strong {
        font-size: 18px;
        color: var(--text-primary);
        font-weight: 600;
        display: block;
    }

    /* Weather Current Card (for weather section) */
    .weather-current-card {
        background: var(--gradient-primary);
        color: white;
        padding: 40px;
        border-radius: 16px;
        margin-bottom: 32px;
        box-shadow: var(--shadow-lg);
    }

    .weather-main {
        margin-bottom: 32px;
    }

    .weather-temp-large {
        font-size: 72px;
        font-weight: 700;
        margin-bottom: 12px;
    }

    .weather-condition-large {
        font-size: 24px;
        opacity: 0.9;
        margin-bottom: 16px;
    }

    .weather-location-large {
        font-size: 16px;
        opacity: 0.8;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .weather-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .weather-detail-card {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .weather-detail-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .weather-detail-content {
        flex: 1;
    }

    .weather-detail-label {
        font-size: 13px;
        opacity: 0.8;
        margin-bottom: 4px;
    }

    .weather-detail-value {
        font-size: 20px;
        font-weight: 700;
    }

    /* Weather Farms Grid */
    .weather-farms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    .weather-farm-card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
    }

    .weather-farm-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .weather-farm-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border-color);
    }

    .weather-farm-info h3 {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .weather-farm-location {
        font-size: 12px;
        color: var(--text-secondary);
        margin: 0;
    }

    .weather-farm-icon {
        font-size: 3rem;
    }

    .weather-farm-main {
        margin-bottom: 20px;
    }

    .weather-temp-display {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .weather-temp-value {
        font-size: 48px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .weather-condition {
        font-size: 16px;
        color: var(--text-secondary);
        text-transform: capitalize;
    }

    .weather-update-time {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .weather-farm-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 16px;
    }

    .weather-detail-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 10px;
    }

    .weather-detail-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .weather-detail-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .weather-detail-label {
        font-size: 11px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .weather-detail-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* Weather Predictions */
    .weather-predictions-content {
        padding: 20px;
    }

    .weather-prediction-section {
        margin-bottom: 32px;
    }

    .weather-prediction-section:last-child {
        margin-bottom: 0;
    }

    .weather-prediction-section h4 {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .prediction-trends {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .prediction-trend-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
    }

    .trend-icon {
        font-size: 32px;
    }

    .trend-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .trend-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
    }

    .trend-value {
        font-size: 18px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .trend-increasing {
        color: #ef4444;
    }

    .trend-decreasing {
        color: #3b82f6;
    }

    .trend-stable {
        color: var(--primary-green);
    }

    .prediction-risks {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .prediction-risk-item {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border-left: 4px solid;
    }

    .prediction-risk-item.risk-high {
        border-left-color: #ef4444;
        background: rgba(239, 68, 68, 0.05);
    }

    .prediction-risk-item.risk-medium {
        border-left-color: #f59e0b;
        background: rgba(245, 158, 11, 0.05);
    }

    .prediction-risk-item i {
        font-size: 24px;
        margin-top: 4px;
    }

    .risk-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .risk-type {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .risk-probability {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
    }

    .risk-message {
        font-size: 14px;
        color: var(--text-secondary);
        margin: 8px 0 0 0;
    }

    .prediction-impacts {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .prediction-impact-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
    }

    .prediction-impact-item i {
        font-size: 20px;
        color: var(--primary-green);
    }

    /* Weather Risk Alerts */
    .weather-risk-alert {
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        margin-bottom: 12px;
    }

    .weather-risk-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }

    .weather-risk-icon {
        font-size: 24px;
    }

    .weather-risk-info {
        flex: 1;
    }

    .weather-risk-info h4 {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 4px 0;
    }

    .weather-risk-severity {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .severity-high {
        background: rgba(239, 68, 68, 0.15);
        color: #ef4444;
    }

    .severity-medium {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }

    .weather-risk-message {
        font-size: 14px;
        color: var(--text-secondary);
        margin: 8px 0 0 0;
        line-height: 1.6;
    }

    /* Agricultural Impact */
    .agricultural-impact-item {
        display: flex;
        align-items: flex-start;
        gap: 16px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        margin-bottom: 12px;
    }

    .impact-icon {
        font-size: 24px;
    }

    .impact-content h4 {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 4px 0;
    }

    .impact-content p {
        font-size: 14px;
        color: var(--text-secondary);
        margin: 0;
        line-height: 1.6;
    }

    /* Filter Section */
    .filter-section {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
    }

    .search-box {
        position: relative;
        margin-bottom: 16px;
    }

    .search-box i {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 16px;
    }

    .search-box input {
        width: 100%;
        padding: 12px 20px 12px 50px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 15px;
        transition: all 0.3s ease;
    }

    .search-box input:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
    }

    .filter-controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .filter-select {
        padding: 10px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 150px;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary-green);
    }

    /* Buttons */
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

    .btn i {
        font-size: 16px;
    }

    .btn-primary {
        background: var(--gradient-primary);
        color: white;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--hover-bg);
        border-color: var(--primary-green);
        color: var(--primary-green);
    }

    .btn-info {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 13px;
    }

    /* Farms Grid */
    .farms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .farm-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .farm-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .farm-card-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .farm-card-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .farm-card-location {
        font-size: 14px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .farm-card-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .farm-card-badge.active {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .farm-card-body {
        padding: 20px;
    }

    .farm-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 16px;
    }

    .farm-info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .farm-info-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .farm-info-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .farm-card-footer {
        padding: 16px 20px;
        background: var(--bg-secondary);
        display: flex;
        gap: 8px;
    }

    .farm-action-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .farm-action-btn.view {
        background: rgba(34, 197, 94, 0.1);
        color: var(--primary-green);
    }

    .farm-action-btn.view:hover {
        background: var(--primary-green);
        color: white;
    }

    .farm-action-btn.edit {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .farm-action-btn.edit:hover {
        background: #3b82f6;
        color: white;
    }

    .farm-action-btn.delete {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .farm-action-btn.delete:hover {
        background: #ef4444;
        color: white;
    }










/* Crops Grid - IMPROVED DESIGN */
.crops-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 28px;
    margin-bottom: 32px;
}

.crop-card {
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 2px solid transparent;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.crop-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, #22c55e, #10b981, #059669);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.crop-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.3);
}

.crop-card:hover::before {
    opacity: 1;
}

.crop-card-header {
    padding: 32px 24px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
    text-align: center;
    position: relative;
}

.crop-icon {
    font-size: 64px;
    margin-bottom: 16px;
    filter: drop-shadow(0 4px 12px rgba(34, 197, 94, 0.2));
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
}

.crop-name {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 12px;
    line-height: 1.3;
}

.crop-category {
    padding: 8px 16px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border-radius: 24px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-block;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.crop-card-body {
    padding: 24px;
    display: flex;
    flex-direction: column;
    justify-content: center; /* Centers content vertically */
    min-height: 300px; /* Ensures enough space */
}

.crop-info-list {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.crop-info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    background: var(--bg-secondary);
    border-radius: 12px;
    border-left: 3px solid #22c55e;
    transition: all 0.3s ease;
}

.crop-info-item:hover {
    background: rgba(34, 197, 94, 0.08);
    transform: translateX(4px);
}

.crop-info-label {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.crop-info-label::before {
    content: '•';
    color: #22c55e;
    font-weight: bold;
    font-size: 18px;
}

.crop-info-value {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    background: rgba(34, 197, 94, 0.1);
    padding: 4px 12px;
    border-radius: 8px;
}

/* Crop Card Footer - View Details Button */
.crop-card-body .btn {
    width: 100%;
    margin-top: 20px;
    padding: 14px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.crop-card-body .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    background: linear-gradient(135deg, #16a34a, #15803d);
}

.crop-card-body .btn i {
    font-size: 16px;
}






    /* Production Timeline */
    .production-timeline {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .production-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .production-card:hover {
        box-shadow: var(--shadow-lg);
    }

    .production-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .production-title-section {
        flex: 1;
    }

    .production-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .production-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .production-status {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .production-status.planned {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .production-status.planted {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .production-status.growing {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .production-status.harvested {
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
    }

    .production-status.sold {
        background: rgba(6, 182, 212, 0.1);
        color: #06b6d4;
    }

    .production-body {
        padding: 20px;
    }

    .production-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .production-info-item {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .production-info-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: var(--hover-bg);
        color: var(--primary-green);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .production-info-content {
        flex: 1;
    }

    .production-info-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
    }

    .production-info-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .production-footer {
        padding: 16px 20px;
        background: var(--bg-secondary);
        display: flex;
        gap: 8px;
    }





    /* Inventory Grid */
    .inventory-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px;
    }

    .inventory-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .inventory-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .inventory-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
    }

    .inventory-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .inventory-badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .inventory-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .inventory-badge.available {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .inventory-badge.reserved {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .inventory-badge.sold {
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
    }

    .inventory-badge.expired {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
    }

    .inventory-body {
        padding: 20px;
    }

    .inventory-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .inventory-alerts {
        margin-bottom: 24px;
    }

    .inventory-alert {
        padding: 16px;
        border-radius: 10px;
        border-left: 4px solid;
        margin-bottom: 12px;
        background: var(--bg-secondary);
    }

    .inventory-alert.warning {
        border-left-color: var(--warning-color);
    }

    .inventory-alert.danger {
        border-left-color: var(--error-color);
    }

    .inventory-alert-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .inventory-alert-message {
        font-size: 13px;
        color: var(--text-secondary);
    }

    /* Table Section */
    .table-section {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        margin-bottom: 32px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .data-table th {
        background: var(--bg-secondary);
        font-weight: 600;
        color: var(--text-primary);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .data-table td {
        color: var(--text-primary);
        font-size: 14px;
    }

    .data-table tr:hover {
        background: var(--hover-bg);
    }

    .data-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Action Buttons in Tables */
    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .action-btn-view {
        background: rgba(34, 197, 94, 0.1);
        color: var(--primary-green);
    }

    .action-btn-view:hover {
        background: var(--primary-green);
        color: white;
    }

    .action-btn-edit {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .action-btn-edit:hover {
        background: #3b82f6;
        color: white;
    }

    .action-btn-delete {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .action-btn-delete:hover {
        background: #ef4444;
        color: white;
    }

    /* Soil Data Grid */
    .soil-data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 2rem;
        padding: 1rem 0;
    }

    @media (max-width: 768px) {
        .soil-data-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }

    /* Soil Data Card - Same style as Crop Card */
    .soil-data-card {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .soil-data-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, #22c55e, #10b981, #059669);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .soil-data-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
        border-color: rgba(34, 197, 94, 0.3);
    }

    .soil-data-card:hover::before {
        opacity: 1;
    }

    .soil-card-header {
        padding: 32px 24px;
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
        text-align: center;
        position: relative;
    }

    .soil-icon {
        font-size: 64px;
        margin-bottom: 16px;
        filter: drop-shadow(0 4px 12px rgba(34, 197, 94, 0.2));
        animation: float 3s ease-in-out infinite;
    }

    .soil-name {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1.3;
    }

    .soil-sample-badge {
        padding: 8px 16px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        border-radius: 24px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        margin-top: 8px;
    }

    .soil-card-body {
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 300px;
    }

    .soil-info-list {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .soil-info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border-left: 3px solid #22c55e;
        transition: all 0.3s ease;
    }

    .soil-info-item:hover {
        background: rgba(34, 197, 94, 0.08);
        transform: translateX(4px);
    }

    .soil-info-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .soil-info-label::before {
        content: '•';
        color: #22c55e;
        font-weight: bold;
        font-size: 18px;
    }

    .soil-info-value {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-primary);
        background: rgba(34, 197, 94, 0.1);
        padding: 4px 12px;
        border-radius: 8px;
    }

    /* Farm Card - Same style as Crop Card */
    .farm-card {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 2px solid transparent;
        overflow: hidden;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .farm-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, #22c55e, #10b981, #059669);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .farm-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
        border-color: rgba(34, 197, 94, 0.3);
    }

    .farm-card:hover::before {
        opacity: 1;
    }

    .farm-card-header {
        padding: 32px 24px;
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
        text-align: center;
        position: relative;
    }

    .farm-icon {
        font-size: 64px;
        margin-bottom: 16px;
        filter: drop-shadow(0 4px 12px rgba(34, 197, 94, 0.2));
        animation: float 3s ease-in-out infinite;
    }

    .farm-name {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1.3;
    }

    .farm-code-badge {
        padding: 8px 16px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        border-radius: 24px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        margin-top: 8px;
    }

    .farm-card-body {
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 300px;
    }

    .farm-info-list {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .farm-info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
        background: var(--bg-secondary);
        border-radius: 12px;
        border-left: 3px solid #22c55e;
        transition: all 0.3s ease;
    }

    .farm-info-item:hover {
        background: rgba(34, 197, 94, 0.08);
        transform: translateX(4px);
    }

    .farm-info-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .farm-info-label::before {
        content: '•';
        color: #22c55e;
        font-weight: bold;
        font-size: 18px;
    }

    .farm-info-value {
        font-size: 15px;
        font-weight: 700;
        color: var(--text-primary);
        background: rgba(34, 197, 94, 0.1);
        padding: 4px 12px;
        border-radius: 8px;
    }

    .soil-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: 24px;
        transition: all 0.3s ease;
    }

    .soil-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .soil-card-header {
        margin-bottom: 20px;
    }

    .soil-card-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .soil-card-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .soil-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .soil-metric {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 10px;
    }

    .soil-metric-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .soil-metric-value {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* Market Prices Grid */
    .market-prices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 24px;
    }

    .market-price-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: 24px;
        transition: all 0.3s ease;
    }

    .market-price-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .market-price-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .market-price-crop {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .market-price-trend {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .market-price-trend.increasing {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .market-price-trend.decreasing {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
    }

    .market-price-trend.stable {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .market-price-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--primary-green);
        margin-bottom: 8px;
    }

    .market-price-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    /* Supply Chain */
    .supply-chain-legend {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 24px;
        padding: 16px;
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .supply-chain-container {
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .supply-chain-item {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: 24px;
    }

    .supply-chain-header {
        margin-bottom: 24px;
    }

    .supply-chain-tracking-code {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .supply-chain-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .supply-chain-stages {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 16px;
    }

    .stage-card {
        min-width: 200px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        border-left: 4px solid;
        transition: all 0.3s ease;
    }

    .stage-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
    }

    .stage-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .stage-details {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.6;
    }

    /* Alerts List */
    .alerts-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .alert-item {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        border-left: 4px solid;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .alert-item:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow-lg);
    }

    .alert-item.critical {
        border-left-color: var(--error-color);
    }

    .alert-item.high {
        border-left-color: var(--warning-color);
    }

    .alert-item.medium {
        border-left-color: var(--info-color);
    }

    .alert-item.low {
        border-left-color: var(--primary-green);
    }

    .alert-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .alert-item-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .alert-item-message {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 12px;
    }

    .alert-item-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .alert-item-body {
        margin: 12px 0;
    }

    .alert-item-title-section {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
    }

    .alert-item-badges {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .ai-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .alert-affected-items {
        margin: 12px 0;
        padding: 8px 12px;
        background: rgba(0,0,0,0.05);
        border-radius: 8px;
    }

    .alert-recommendations {
        margin: 12px 0;
        padding: 12px;
        background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%);
        border-left: 3px solid #ffc107;
        border-radius: 8px;
    }

    /* AI Analysis Styles */
    .ai-analysis-content {
        padding: 20px;
    }

    .analysis-section {
        margin-bottom: 32px;
    }

    .analysis-section:last-child {
        margin-bottom: 0;
    }

    /* Policies Grid */
    .policies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .policy-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .policy-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .policy-header {
        padding: 20px;
        background: var(--hover-bg);
        border-bottom: 1px solid var(--border-color);
    }

    .policy-type {
        padding: 6px 12px;
        background: var(--primary-green);
        color: white;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
        margin-bottom: 12px;
    }

    .policy-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .policy-body {
        padding: 20px;
    }

    .policy-description {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 16px;
    }

    .policy-details {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .policy-detail-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        background: var(--bg-secondary);
        border-radius: 8px;
        font-size: 13px;
    }

    .policy-detail-label {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .policy-detail-value {
        color: var(--text-primary);
        font-weight: 600;
    }

    /* Recommendations Grid */
    .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .recommendation-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: 24px;
        transition: all 0.3s ease;
    }

    .recommendation-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .recommendation-header {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
    }

    .recommendation-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        background: var(--gradient-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
    }

    .recommendation-title-section {
        flex: 1;
    }

    .recommendation-type {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .recommendation-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .recommendation-priority {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .recommendation-priority.urgent {
        background: var(--error-color);
        color: white;
    }

    .recommendation-priority.high {
        background: var(--warning-color);
        color: white;
    }

    .recommendation-priority.medium {
        background: var(--info-color);
        color: white;
    }

    .recommendation-priority.low {
        background: var(--primary-green);
        color: white;
    }

    .recommendation-description {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 16px;
    }

    .recommendation-details {
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        font-size: 13px;
        color: var(--text-primary);
    }

    .recommendation-footer {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .recommendation-confidence {
        font-size: 12px;
        color: var(--text-secondary);
    }

    .recommendation-confidence strong {
        color: var(--primary-green);
        font-weight: 700;
    }

    /* Predictions Grid */
    .predictions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .prediction-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .prediction-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .prediction-header {
        padding: 20px;
        background: var(--gradient-primary);
        color: white;
    }

    .prediction-crop {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .prediction-season {
        font-size: 14px;
        opacity: 0.9;
    }

    .prediction-body {
        padding: 24px;
    }

    .prediction-yield {
        text-align: center;
        margin-bottom: 24px;
    }

    .prediction-yield-label {
        font-size: 13px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .prediction-yield-value {
        font-size: 48px;
        font-weight: 700;
        color: var(--primary-green);
    }

    .prediction-yield-unit {
        font-size: 16px;
        color: var(--text-secondary);
    }

    .prediction-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .prediction-metric {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 10px;
        text-align: center;
    }

    .prediction-metric-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }

    .prediction-metric-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* Report Configuration */
    .report-config-card {
        background: var(--card-bg);
        padding: 32px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 32px;
    }

    .report-config-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 24px;
    }

    .report-config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .form-input,
    .form-select {
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
    }

    .report-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    /* Report Preview */
    .report-preview-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .report-preview-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-secondary);
    }

    .report-preview-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .report-preview-content {
        padding: 32px;
        max-height: 600px;
        overflow-y: auto;
    }

    /* Status Badges */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
    }

    .status-active {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .status-inactive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
    }

    .status-pending {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .status-completed {
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: var(--modal-bg);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 32px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: var(--hover-bg);
        color: var(--primary-green);
    }

    .modal-body {
        margin-bottom: 24px;
    }

    .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    /* Loading Overlay */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }

    .loading-overlay.show {
        display: flex;
    }

    .loader {
        border: 8px solid rgba(255, 255, 255, 0.2);
        border-top: 8px solid var(--primary-green);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .toast {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: var(--shadow-lg);
        border-left: 4px solid;
        animation: slideInRight 0.3s ease;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toast.success { border-left-color: var(--success-color); }
    .toast.error { border-left-color: var(--error-color); }
    .toast.warning { border-left-color: var(--warning-color); }
    .toast.info { border-left-color: var(--info-color); }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .toast-icon {
        font-size: 20px;
    }

    .toast.success .toast-icon { color: var(--success-color); }
    .toast.error .toast-icon { color: var(--error-color); }
    .toast.warning .toast-icon { color: var(--warning-color); }
    .toast.info .toast-icon { color: var(--info-color); }

    .toast-message {
        color: var(--text-primary);
        font-weight: 500;
        font-size: 14px;
        flex: 1;
    }

    .toast-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 4px;
        font-size: 18px;
        transition: all 0.3s ease;
    }

    .toast-close:hover {
        color: var(--text-primary);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-state p {
        font-size: 18px;
        margin-top: 12px;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary-green);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }

    /* Responsive Design */
    @media (max-width: 1400px) {
        .charts-section {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 1200px) {
        .dashboard-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .farms-grid,
        .crops-grid,
        .inventory-grid,
        .market-prices-grid,
        .policies-grid,
        .recommendations-grid,
        .predictions-grid {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
    }

    @media (max-width: 992px) {
        .header {
            padding: 0 20px;
        }

        .search-container {
            width: 250px;
        }

        .greeting-text {
            font-size: 20px;
        }

        .content {
            padding: 24px 20px;
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .section-header-right {
            width: 100%;
        }

        .welcome-banner {
            padding: 32px 24px;
        }

        .welcome-title {
            font-size: 28px;
        }

        .dashboard-info-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
            width: 280px;
        }

        .sidebar.mobile-open {
            transform: translateX(0);
        }

        .main-content {
            margin-left: 0;
        }

        .header {
            height: auto;
            padding: 16px;
            flex-direction: column;
            gap: 16px;
        }

        .header-left {
            width: 100%;
            justify-content: space-between;
        }

        .search-container {
            width: 100%;
            order: 3;
        }

        .header-right {
            width: 100%;
            justify-content: space-between;
        }

        .greeting-section {
            flex: 1;
        }

        .greeting-text {
            font-size: 18px;
        }

        .current-date {
            font-size: 12px;
        }

        .profile-info {
            display: none;
        }

        .content {
            padding: 20px 16px;
        }

        .section-title {
            font-size: 24px;
        }

        .welcome-banner {
            padding: 24px 20px;
            flex-direction: column;
        }

        .welcome-title {
            font-size: 24px;
        }

        .welcome-subtitle {
            font-size: 16px;
        }

        .welcome-actions {
            width: 100%;
            flex-direction: column;
        }

        .welcome-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .dashboard-grid,
        .stats-mini-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .charts-section {
            grid-template-columns: 1fr;
        }

        .chart-container {
            height: 250px;
        }

        .farms-grid,
        .crops-grid,
        .inventory-grid,
        .market-prices-grid,
        .soil-data-grid,
        .policies-grid,
        .recommendations-grid,
        .predictions-grid {
            grid-template-columns: 1fr;
        }

        .filter-section {
            padding: 16px;
        }

        .filter-controls {
            flex-direction: column;
        }

        .filter-select {
            width: 100%;
        }

        .section-header-right {
            flex-direction: column;
        }

        .section-header-right .btn {
            width: 100%;
            justify-content: center;
        }

        .weather-content {
            flex-direction: column;
        }

        .weather-details {
            grid-template-columns: repeat(2, 1fr);
        }

        .weather-current-card {
            padding: 24px 20px;
        }

        .weather-temp-large {
            font-size: 56px;
        }

        .weather-details-grid {
            grid-template-columns: 1fr;
        }

        .production-info-grid {
            grid-template-columns: 1fr;
        }

        .modal-content {
            width: 95%;
            padding: 24px 20px;
            max-height: 95vh;
        }

        .modal-title {
            font-size: 20px;
        }

        .report-config-grid {
            grid-template-columns: 1fr;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            min-width: 600px;
        }
    }

    @media (max-width: 480px) {
        .stat-value {
            font-size: 28px;
        }

        .stat-mini-value {
            font-size: 20px;
        }

        .chart-title {
            font-size: 16px;
        }

        .farm-info-grid,
        .soil-metrics,
        .prediction-metrics {
            grid-template-columns: 1fr;
        }

        .weather-details {
            grid-template-columns: 1fr;
        }

        .supply-chain-stages {
            flex-direction: column;
        }

        .stage-card {
            min-width: 100%;
        }

        .toast {
            max-width: calc(100vw - 40px);
        }

        .toast-container {
            left: 20px;
            right: 20px;
        }
    }

    /* Print Styles */
    @media print {
        .sidebar,
        .header,
        .filter-section,
        .section-header-right,
        .btn,
        .action-buttons,
        .farm-card-footer,
        .production-footer,
        .modal,
        .toast-container,
        .loading-overlay {
            display: none !important;
        }

        .main-content {
            margin-left: 0;
        }

        .content {
            padding: 0;
        }

        .card,
        .stat-card,
        .chart-card,
        .farm-card,
        .crop-card,
        .inventory-card {
            box-shadow: none;
            border: 1px solid #ddd;
            page-break-inside: avoid;
        }
    }

    /* Dark Mode Adjustments */
    .dark-mode .nav-link:hover {
        background: rgba(34, 197, 94, 0.15);
    }

    .dark-mode .data-table tr:hover {
        background: rgba(34, 197, 94, 0.1);
    }

    .dark-mode .search-input,
    .dark-mode .filter-select,
    .dark-mode .form-input,
    .dark-mode .form-select {
        background: var(--bg-primary);
    }

    .dark-mode .loader {
        border-color: rgba(255, 255, 255, 0.1);
        border-top-color: var(--primary-green);
    }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-in {
        animation: fadeInUp 0.5s ease;
    }

    /* Utility Classes */
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }

    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mt-3 { margin-top: 24px; }
    .mt-4 { margin-top: 32px; }

    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 24px; }
    .mb-4 { margin-bottom: 32px; }

    .p-1 { padding: 8px; }
    .p-2 { padding: 16px; }
    .p-3 { padding: 24px; }
    .p-4 { padding: 32px; }

    .flex { display: flex; }
    .flex-column { flex-direction: column; }
    .flex-wrap { flex-wrap: wrap; }
    .justify-between { justify-content: space-between; }
    .justify-center { justify-content: center; }
    .items-center { align-items: center; }
    .gap-1 { gap: 8px; }
    .gap-2 { gap: 16px; }
    .gap-3 { gap: 24px; }

    .w-full { width: 100%; }
    .h-full { height: 100%; }

    .rounded { border-radius: 8px; }
    .rounded-lg { border-radius: 12px; }
    .rounded-xl { border-radius: 16px; }

    .shadow { box-shadow: var(--shadow); }
    .shadow-lg { box-shadow: var(--shadow-lg); }

    .cursor-pointer { cursor: pointer; }

    .overflow-hidden { overflow: hidden; }
    .overflow-auto { overflow: auto; }

    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-success { color: var(--success-color); }
    .text-warning { color: var(--warning-color); }
    .text-error { color: var(--error-color); }

    .bg-primary { background: var(--bg-primary); }
    .bg-secondary { background: var(--bg-secondary); }

    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .font-medium { font-weight: 500; }

    .text-xs { font-size: 12px; }
    .text-sm { font-size: 13px; }
    .text-base { font-size: 14px; }
    .text-lg { font-size: 16px; }
    .text-xl { font-size: 18px; }
    .text-2xl { font-size: 20px; }
    .text-3xl { font-size: 24px; }





        /* ============================================================================
   MODAL IMPROVEMENTS - RESPONSIVE & CENTERED
   ============================================================================ */

/* Modal Overlay - Amélioration */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(5px);
  z-index: 9999;
  overflow-y: auto;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

.modal-overlay.show {
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Modal Container - Centré et Responsive */
.modal-container {
  background: var(--card-bg);
  border-radius: 20px;
  width: 100%;
  max-width: 700px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  margin: auto;
  position: relative;
}

.modal-container.modal-large {
  max-width: 1000px;
}

.modal-container.modal-small {
  max-width: 500px;
}

/* Modal Header - Amélioré */
.modal-header {
  padding: 24px 32px;
  border-bottom: 2px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
  border-radius: 20px 20px 0 0;
  position: sticky;
  top: 0;
  z-index: 10;
}

.modal-title {
  font-size: 22px;
  font-weight: 700;
  color: white;
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 0;
}

.modal-title i {
  font-size: 24px;
}

.modal-close {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  color: white;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

/* Modal Body - Amélioré */
.modal-body {
  padding: 32px;
  max-height: calc(90vh - 180px);
  overflow-y: auto;
}

/* Scrollbar personnalisé pour modal */
.modal-body::-webkit-scrollbar {
  width: 8px;
}

.modal-body::-webkit-scrollbar-track {
  background: var(--bg-secondary);
  border-radius: 10px;
}

.modal-body::-webkit-scrollbar-thumb {
  background: var(--primary-green);
  border-radius: 10px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
  background: var(--primary-dark);
}

/* Modal Footer - Amélioré */
.modal-footer {
  padding: 20px 32px;
  border-top: 2px solid var(--border-color);
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  background: var(--bg-secondary);
  border-radius: 0 0 20px 20px;
  position: sticky;
  bottom: 0;
  z-index: 10;
}

/* Form Grid - Responsive */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 24px;
  margin-bottom: 24px;
}

/* Form Group - Amélioré */
.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group.form-group-full {
  grid-column: 1 / -1;
}

/* Form Label - Avec icônes */
.form-label {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.form-label i {
  color: var(--primary-green);
  font-size: 16px;
}

.form-label::after {
  content: '';
  display: none;
}

/* Form Input & Select - Design moderne */
.form-input,
.form-select {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-size: 15px;
  font-weight: 500;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
}

.form-input:focus,
.form-select:focus {
  outline: none;
  border-color: var(--primary-green);
  box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
  background: var(--bg-primary);
}

.form-input::placeholder {
  color: var(--text-secondary);
  opacity: 0.7;
}

.form-input:invalid:not(:placeholder-shown) {
  border-color: var(--error-color);
}

.form-input:valid:not(:placeholder-shown) {
  border-color: var(--success-color);
}

/* Form Select - Amélioration */
.form-select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2322c55e' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 16px center;
  padding-right: 40px;
}

/* Form Checkbox - Style personnalisé */
.form-checkbox {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  user-select: none;
}

.form-checkbox input[type="checkbox"] {
  width: 20px;
  height: 20px;
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  appearance: none;
  position: relative;
}

.form-checkbox input[type="checkbox"]:checked {
  background: var(--primary-green);
  border-color: var(--primary-green);
}

.form-checkbox input[type="checkbox"]:checked::after {
  content: '\f00c';
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 12px;
}

.form-checkbox span {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
}

/* Buttons dans modal - Amélioré */
.modal-footer .btn {
  padding: 14px 28px;
  font-size: 15px;
  font-weight: 600;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
}

.modal-footer .btn i {
  font-size: 16px;
}

.modal-footer .btn-primary {
  background: var(--gradient-primary);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.modal-footer .btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
}

.modal-footer .btn-secondary {
  background: transparent;
  color: var(--text-primary);
  border: 2px solid var(--border-color);
}

.modal-footer .btn-secondary:hover {
  background: var(--hover-bg);
  border-color: var(--primary-green);
  color: var(--primary-green);
}

/* Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* Responsive Design pour Modaux */
@media (max-width: 768px) {
  .modal-overlay {
    padding: 10px;
  }

  .modal-container {
    max-width: 100%;
    max-height: 95vh;
    border-radius: 16px;
  }

  .modal-header {
    padding: 20px 24px;
    border-radius: 16px 16px 0 0;
  }

  .modal-title {
    font-size: 18px;
  }

  .modal-body {
    padding: 24px 20px;
    max-height: calc(95vh - 160px);
  }

  .modal-footer {
    padding: 16px 20px;
    flex-direction: column-reverse;
    border-radius: 0 0 16px 16px;
  }

  .modal-footer .btn {
    width: 100%;
    justify-content: center;
  }

  .form-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }

  .modal-close {
    width: 36px;
    height: 36px;
    font-size: 18px;
  }
}

@media (max-width: 480px) {
  .modal-container {
    border-radius: 12px;
  }

  .modal-header {
    padding: 16px 20px;
    border-radius: 12px 12px 0 0;
  }

  .modal-title {
    font-size: 16px;
  }

  .modal-title i {
    font-size: 20px;
  }

  .modal-body {
    padding: 20px 16px;
  }

  .modal-footer {
    padding: 12px 16px;
    border-radius: 0 0 12px 12px;
  }

  .form-input,
  .form-select {
    padding: 12px 14px;
    font-size: 14px;
  }

  .form-label {
    font-size: 13px;
  }

  .modal-footer .btn {
    padding: 12px 20px;
    font-size: 14px;
  }
}

/* Dark Mode pour Modaux */
.dark-mode .modal-overlay {
  background: rgba(0, 0, 0, 0.8);
}

.dark-mode .modal-container {
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
}

.dark-mode .form-input:focus,
.dark-mode .form-select:focus {
  background: var(--bg-primary);
}


        /* Supply Chain Styles */
.supply-chain-group {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.supply-chain-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #f0f0f0;
}

.supply-chain-timeline {
    position: relative;
    padding-left: 40px;
}

.timeline-item {
    position: relative;
    padding-bottom: 32px;
}

.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: -28px;
    top: 40px;
    width: 2px;
    height: calc(100% - 40px);
    background: #e0e0e0;
}

.timeline-item.completed:not(:last-child)::after {
    background: #22c55e;
}

.timeline-marker {
    position: absolute;
    left: -40px;
    top: 0;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: white;
    border: 3px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
}

.timeline-item.completed .timeline-marker {
    border-color: #22c55e;
    background: #22c55e;
    color: white;
}

.timeline-item.active .timeline-marker {
    border-color: #3b82f6;
    background: #3b82f6;
    color: white;
}

.timeline-content {
    background: #f9fafb;
    border-radius: 8px;
    padding: 20px;
    border-left: 4px solid #e0e0e0;
}

.timeline-item.completed .timeline-content {
    border-left-color: #22c55e;
}

.timeline-item.active .timeline-content {
    border-left-color: #3b82f6;
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.timeline-header h4 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
}

.timeline-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.detail-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #6b7280;
}

.detail-row i {
    width: 20px;
    color: #9ca3af;
}

.detail-row.alert-warning {
    color: #d97706;
    background: #fef3c7;
    padding: 8px;
    border-radius: 4px;
}

.timeline-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.stat-icon.primary { background: #dbeafe; color: #3b82f6; }
.stat-icon.success { background: #dcfce7; color: #22c55e; }
.stat-icon.warning { background: #fef3c7; color: #f59e0b; }
.stat-icon.danger { background: #fee2e2; color: #ef4444; }

.stat-content {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #1f2937;
}

.stat-content small {
    font-size: 12px;
    color: #9ca3af;
}



        .policy-full-details {
  max-height: 70vh;
  overflow-y: auto;
  padding: 10px;
}

.detail-section {
  margin-bottom: 25px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #3498db;
}

.detail-section h4 {
  margin: 0 0 15px 0;
  color: #2c3e50;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
}

.detail-section h4 i {
  color: #3498db;
}

.detail-section p {
  line-height: 1.8;
  color: #495057;
  margin: 0;
}

.details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 10px;
}

.detail-item {
  padding: 12px;
  background: white;
  border-radius: 6px;
  border: 1px solid #dee2e6;
}

.detail-item label {
  display: block;
  font-size: 0.875rem;
  color: #6c757d;
  margin-bottom: 5px;
  font-weight: 500;
}


.market-prices-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    padding: 20px 0;
}

.trend-increasing { background: #dcfce7; color: #166534; }
.trend-decreasing { background: #fee2e2; color: #991b1b; }
.trend-stable { background: #fef3c7; color: #92400e; }
.trend-volatile { background: #dbeafe; color: #1e40af; }

.demand-high { background: #dcfce7; color: #166534; }
.demand-medium { background: #fef3c7; color: #92400e; }
.demand-low { background: #fee2e2; color: #991b1b; }
.demand-unknown { background: #f1f5f9; color: #475569; }

.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
}

.detail-item value {
  display: block;
  font-size: 1rem;
  font-weight: 600;
  color: #2c3e50;
}

.badges-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 500;
}

.badge-success {
  background: #d4edda;
  color: #155724;
}

.badge-info {
  background: #d1ecf1;
  color: #0c5460;
}

.badge i {
  font-size: 0.9rem;
}

@media (max-width: 768px) {
  .details-grid {
    grid-template-columns: 1fr;
  }

  .policy-full-details {
    max-height: 60vh;
  }
}




        /* ===== MODAL STYLES - CORRECTION AFFICHAGE ===== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: none; /* Caché par défaut */
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.modal-overlay.show {
  display: flex !important; /* Force l'affichage */
  opacity: 1;
}

.modal-container {
  background: white;
  border-radius: 12px;
  max-width: 800px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.show .modal-container {
  transform: scale(1);
}



/* CORRECTION CRITIQUE : Styles pour modal de production */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: none; /* Caché par défaut */
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.modal-overlay.show {
  display: flex !important; /* Force l'affichage */
  opacity: 1 !important;
}

.modal-container {
  background: white;
  border-radius: 12px;
  max-width: 800px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.show .modal-container {
  transform: scale(1);
}



        /* ===================================
   PRODUCTION CARDS ENHANCED STYLES
   =================================== */

.production-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    border-left: 4px solid #22c55e;
    margin-bottom: 20px;
}

.production-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.production-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
}

.production-info {
    flex: 1;
}

.production-title {
    margin: 0 0 8px 0;
    font-size: 1.25rem;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 10px;
}

.production-title i {
    color: #22c55e;
}

.production-code {
    font-size: 0.875rem;
    color: #7f8c8d;
    font-weight: 500;
}

.production-badges {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: flex-end;
}

.production-countdown {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: #fff8e1;
    color: #f57c00;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
}

.production-countdown i {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.production-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.production-detail-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.production-detail-item label {
    font-size: 0.875rem;
    color: #7f8c8d;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
}

.production-detail-item label i {
    color: #3498db;
    width: 16px;
}

.production-detail-item span {
    font-size: 1rem;
    color: #2c3e50;
    font-weight: 600;
}

.production-dates {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.date-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
    color: #495057;
}

.date-item i {
    color: #3498db;
    width: 16px;
}


/* FORCER L'AFFICHAGE DE LA SECTION MARKET PRICES */
#marketPricesSection.active {
    display: block !important;
    opacity: 1 !important;
    visibility: visible !important;
}
.date-item.success i {
    color: #22c55e;
}

.production-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    padding-top: 15px;
    border-top: 1px solid #ecf0f1;
}

/* Status badges colors */
.status-planned {
    background: #e3f2fd;
    color: #1976d2;
}

.status-planted {
    background: #f3e5f5;
    color: #7b1fa2;
}

.status-growing {
    background: #e8f5e9;
    color: #388e3c;
}

.status-harvested {
    background: #fff8e1;
    color: #f57c00;
}

.status-failed {
    background: #ffebee;
    color: #c62828;
}

/* Responsive */
@media (max-width: 768px) {
    .production-header {
        flex-direction: column;
        gap: 15px;
    }

    .production-badges {
        align-items: flex-start;
    }

    .production-details {
        grid-template-columns: 1fr;
    }
}




        /* Styles pour le tableau des fertilisants */
.fertilizer-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.fertilizer-table th {
    background: #f8f9fa;
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #e9ecef;
}

.fertilizer-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #e9ecef;
}

.fertilizer-table tr:hover {
    background-color: #f8f9fa;
}

.table-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-start;
}

.btn-icon {
    background: none;
    border: none;
    padding: 6px;
    border-radius: 4px;
    cursor: pointer;
    color: #666;
    transition: all 0.2s ease;
}

.btn-icon:hover {
    background: #f1f3f4;
    color: #333;
}

.btn-danger {
    color: #dc3545;
}

.btn-danger:hover {
    background: #f8d7da;
    color: #721c24;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.empty-icon {
    font-size: 48px;
    color: #ddd;
    margin-bottom: 16px;
}

.empty-state h3 {
    margin: 0 0 8px 0;
    color: #333;
}

.empty-state p {
    margin: 0 0 20px 0;
    font-size: 14px;
}





        /* Supply Level Badges */
.supply-badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.supply-high {
    background: #f0fdf4;
    color: #166534;
}

.supply-medium {
    background: #fefce8;
    color: #854d0e;
}

.supply-low {
    background: #fef2f2;
    color: #dc2626;
}

/* Trend Badges */
.trend-badge {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
}

.trend-volatile {
    background: #fef3c7;
    color: #92400e;
}

.trend-fluctuating {
    background: #e0e7ff;
    color: #3730a3;
}

/* Reliability Stars */
.reliability-stars {
    color: #fbbf24;
    font-size: 1rem;
}

.score-text {
    color: #6b7280;
    font-size: 0.75rem;
    margin-left: 8px;
}

/* Text Colors for Price Changes */
.text-success {
    color: #059669;
}

.text-error {
    color: #dc2626;
}

.text-warning {
    color: #d97706;
}








        /* ============================================================================
   SUPPLY CHAIN STYLES - VERSION COMPLÈTE
   ============================================================================ */

/* Supply Chain Legend */
.supply-chain-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    padding: 20px;
    background: white;
    border-radius: 12px;
    margin-bottom: 25px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.875rem;
    color: #475569;
}

.legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
}

/* Supply Chain Container */
.supply-chain-container {
    display: flex;
    flex-direction: column;
    gap: 30px;
}

/* Supply Chain Group */
.supply-chain-group {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.supply-chain-group:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.supply-chain-group-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f1f5f9;
}

.supply-chain-group-info h3 {
    margin: 0 0 8px 0;
    color: #1e293b;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.supply-chain-production-id {
    margin: 0;
    color: #64748b;
    font-size: 0.875rem;
}

.supply-chain-group-progress {
    min-width: 250px;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 0.875rem;
    color: #475569;
}

.progress-percent {
    font-weight: 600;
    color: #10b981;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    transition: width 0.5s ease;
}

/* Supply Chain Timeline */
.supply-chain-timeline {
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: relative;
}

/* Timeline Stage */
.timeline-stage {
    display: flex;
    gap: 20px;
    position: relative;
    padding: 20px;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.timeline-stage.completed {
    background: rgba(16, 185, 129, 0.05);
    border: 2px solid rgba(16, 185, 129, 0.2);
}

.timeline-stage.active {
    background: rgba(251, 146, 60, 0.05);
    border: 2px solid rgba(251, 146, 60, 0.3);
    box-shadow: 0 4px 12px rgba(251, 146, 60, 0.15);
}

.timeline-stage.pending {
    background: rgba(148, 163, 184, 0.05);
    border: 2px solid rgba(148, 163, 184, 0.2);
    opacity: 0.7;
}

.timeline-stage:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Timeline Connector */
.timeline-connector {
    position: absolute;
    left: 39px;
    top: 80px;
    bottom: -20px;
    width: 2px;
    background: linear-gradient(180deg, #e2e8f0 0%, #cbd5e1 100%);
}

.timeline-connector.last {
    display: none;
}

.timeline-stage.completed .timeline-connector {
    background: linear-gradient(180deg, #10b981 0%, #059669 100%);
}

.timeline-stage.active .timeline-connector {
    background: linear-gradient(180deg, #fb923c 0%, #f97316 100%);
}

/* Timeline Marker */
.timeline-marker {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
    position: relative;
    z-index: 1;
    transition: all 0.3s ease;
}

.timeline-stage.completed .timeline-marker {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.timeline-stage.active .timeline-marker {
    background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
    animation: pulse 2s infinite;
}

.timeline-stage.pending .timeline-marker {
    background: #f1f5f9;
    color: #94a3b8;
    border: 2px solid #cbd5e1;
}

.stage-check {
    position: absolute;
    top: -5px;
    right: -5px;
    background: white;
    border-radius: 50%;
    padding: 3px;
    font-size: 0.875rem;
    color: #10b981;
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 4px 12px rgba(251, 146, 60, 0.3);
    }
    50% {
        box-shadow: 0 4px 20px rgba(251, 146, 60, 0.6);
    }
}

/* Timeline Content */
.timeline-content {
    flex: 1;
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.stage-name {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: #1e293b;
}

.stage-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-success {
    background: #d1fae5;
    color: #065f46;
}

.badge-warning {
    background: #fed7aa;
    color: #92400e;
}

.badge-secondary {
    background: #e2e8f0;
    color: #475569;
}

/* Timeline Details */
.timeline-details {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}

.detail-row {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 8px 12px;
    background: #f8fafc;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #475569;
}

.detail-row i {
    color: #64748b;
    margin-top: 2px;
    flex-shrink: 0;
}

.detail-row.success {
    background: #d1fae5;
    color: #065f46;
}

.detail-row.success i {
    color: #10b981;
}

.detail-row.alert {
    background: #fee2e2;
    color: #991b1b;
}

.detail-row.alert i {
    color: #ef4444;
}

/* Timeline Actions */
.timeline-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e2e8f0;
}

.timeline-actions .btn-icon {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    background: white;
    color: #475569;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.875rem;
}

.timeline-actions .btn-icon:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
    transform: translateY(-2px);
}

.timeline-actions .btn-icon.btn-primary {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.timeline-actions .btn-icon.btn-primary:hover {
    background: #2563eb;
    border-color: #2563eb;
}

.timeline-actions .btn-icon.btn-success {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

.timeline-actions .btn-icon.btn-success:hover {
    background: #059669;
    border-color: #059669;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 12px;
    color: #64748b;
}

.empty-icon {
    font-size: 4rem;
    color: #cbd5e1;
    margin-bottom: 20px;
}

.empty-state h3 {
    margin: 0 0 10px 0;
    color: #475569;
    font-size: 1.5rem;
}

.empty-state p {
    margin: 10px 0;
    font-size: 1rem;
    line-height: 1.6;
}

.empty-state-hint {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: #e0f2fe;
    border-radius: 8px;
    color: #0369a1;
    font-size: 0.875rem;
    margin: 20px 0;
}

.empty-state .btn {
    margin-top: 25px;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    flex-shrink: 0;
}

.stat-icon.primary {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

.stat-icon.success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.stat-icon.warning {
    background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
}

.stat-icon.secondary {
    background: linear-gradient(135deg, #64748b 0%, #475569 100%);
}

.stat-icon.danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.stat-content {
    flex: 1;
}

.stat-label {
    display: block;
    font-size: 0.875rem;
    color: #64748b;
    margin-bottom: 4px;
}

.stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
}

.stat-content small {
    display: block;
    font-size: 0.75rem;
    color: #94a3b8;
    margin-top: 4px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .supply-chain-group-header {
        flex-direction: column;
        gap: 20px;
    }

    .supply-chain-group-progress {
        width: 100%;
    }

    .timeline-stage {
        flex-direction: column;
        gap: 15px;
    }

    .timeline-connector {
        display: none;
    }

    .timeline-actions {
        flex-wrap: wrap;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .supply-chain-legend {
        gap: 10px;
        font-size: 0.75rem;
    }
}

/* Print Styles */
@media print {
    .timeline-actions,
    .supply-chain-group-header button,
    .btn {
        display: none !important;
    }

    .timeline-stage {
        break-inside: avoid;
    }

    .supply-chain-group {
        box-shadow: none;
        border: 1px solid #e2e8f0;
    }
}









/* ============================================================================
   IMPROVED INVENTORY CARD DESIGN - PROFESSIONAL & MODERN
   ============================================================================ */

.inventory-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 28px;
    margin-bottom: 32px;
}

.inventory-card {
    background: var(--card-bg, #ffffff);
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 2px solid transparent;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    display: flex;
    flex-direction: column;
}

.inventory-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, #22c55e, #10b981, #059669);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.inventory-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.3);
}

.inventory-card:hover::before {
    opacity: 1;
}

/* Header Section */
.inventory-header {
    padding: 24px 24px 16px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
    border-bottom: 2px solid rgba(34, 197, 94, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.inventory-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-primary, #1f2937);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.inventory-title::before {
    content: '📦';
    font-size: 28px;
    filter: drop-shadow(0 2px 4px rgba(34, 197, 94, 0.2));
}

/* Status Badge */
.inventory-status {
    padding: 8px 16px;
    border-radius: 24px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.inventory-status.status-available {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.inventory-status.status-reserved {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.inventory-status.status-sold {
    background: linear-gradient(135deg, #8b5cf6, #6d28d9);
    color: white;
}

.inventory-status.status-expired {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

/* Details Section */
.inventory-details {
    padding: 24px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    flex-grow: 1;
}

.inventory-detail-item {
    padding: 14px 16px;
    background: var(--bg-secondary, #f9fafb);
    border-radius: 12px;
    border-left: 3px solid #22c55e;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.inventory-detail-item:hover {
    background: rgba(34, 197, 94, 0.08);
    transform: translateX(4px);
}

.inventory-detail-item label {
    font-size: 12px;
    color: var(--text-secondary, #6b7280);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 0;
}

.inventory-detail-item label::before {
    content: '•';
    color: #22c55e;
    font-weight: bold;
    font-size: 16px;
}

.inventory-detail-item span {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary, #1f2937);
}

/* Quality Badge */
.quality-badge {
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
}

.quality-badge.quality-premium,
.quality-badge.quality-a {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.quality-badge.quality-standard,
.quality-badge.quality-b {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.quality-badge.quality-basic,
.quality-badge.quality-c {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.quality-badge.quality-n\/a {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
}

/* Actions Section */
.inventory-actions {
    padding: 16px 24px 24px;
    display: flex;
    gap: 10px;
    justify-content: space-between;
    border-top: 1px solid rgba(34, 197, 94, 0.1);
}

.inventory-actions .btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 16px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.inventory-actions .btn i {
    font-size: 14px;
}

.inventory-actions .btn-secondary {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
}

.inventory-actions .btn-secondary:hover {
    background: linear-gradient(135deg, #4b5563, #374151);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
}

.inventory-actions .btn-primary {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.inventory-actions .btn-primary:hover {
    background: linear-gradient(135deg, #1d4ed8, #1e40af);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.inventory-actions .btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.inventory-actions .btn-danger:hover {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
}

.inventory-actions .btn-sm {
    padding: 10px 14px;
    font-size: 13px;
}

/* Empty State */
.empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 80px 40px;
    background: var(--card-bg, #ffffff);
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.empty-state i {
    font-size: 80px;
    color: #d1d5db;
    margin-bottom: 24px;
    display: block;
}

.empty-state p {
    font-size: 18px;
    color: var(--text-secondary, #6b7280);
    margin-bottom: 32px;
    font-weight: 500;
}

.empty-state .btn {
    padding: 14px 32px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 10px;
}

.empty-state .btn-primary {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.empty-state .btn-primary:hover {
    background: linear-gradient(135deg, #16a34a, #15803d);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
}

/* Responsive Design */
@media (max-width: 768px) {
    .inventory-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .inventory-details {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .inventory-actions {
        flex-direction: column;
    }

    .inventory-actions .btn {
        width: 100%;
    }
}







/* Quality Badges */
.quality-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.quality-premium {
    background: #ffd700;
    color: #856404;
}

.quality-grade_a {
    background: #d4edda;
    color: #155724;
}

.quality-grade_b {
    background: #d1ecf1;
    color: #0c5460;
}

.quality-standard {
    background: #e9ecef;
    color: #495057;
}

/* Inventory Actions */
.inventory-actions {
    display: flex;
    gap: 10px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.inventory-actions .btn {
    flex: 1;
}

/* Alerts Banner */
.alerts-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.alerts-banner h4 {
    margin: 0 0 15px 0;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.1rem;
}

.alerts-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.alert-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.alert-item i {
    font-size: 1.2rem;
}

.alert-critical {
    background: rgba(220, 53, 69, 0.2);
    border-left: 4px solid #dc3545;
}

.alert-high {
    background: rgba(255, 193, 7, 0.2);
    border-left: 4px solid #ffc107;
}

.alert-medium {
    background: rgba(23, 162, 184, 0.2);
    border-left: 4px solid #17a2b8;
}

/* Filter Buttons */
.filter-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    gap: 10px;
    align-items: center;
}

.filter-group label {
    font-weight: 600;
    color: #495057;
}

.filter-btn {
    padding: 8px 16px;
    border: 2px solid #e9ecef;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.filter-btn:hover {
    background: #f8f9fa;
    border-color: #dee2e6;
}

.filter-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 4rem;
    color: #dee2e6;
    margin-bottom: 20px;
}

.empty-state h3 {
    margin: 0 0 10px 0;
    color: #495057;
}

.empty-state p {
    margin: 10px 0;
    font-size: 1rem;
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .inventory-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .inventory-actions {
        flex-direction: column;
    }

    .filter-controls {
        flex-direction: column;
        align-items: stretch;
    }

    .filter-group {
        flex-direction: column;
        align-items: flex-start;
    }
}




        /* ============================================
   MODAL FIXES - Ajouter à votre CSS
   ============================================ */

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.modal-overlay.show {
  display: flex !important;
  opacity: 1;
}

.modal-container {
  background: white;
  border-radius: 8px;
  max-width: 800px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.show .modal-container {
  transform: scale(1);
}



        /* IMPROVED IRRIGATION MODAL STYLES */
.modal-irrigation {
    max-width: 900px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header-gradient {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.modal-header-content {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.modal-icon-wrapper {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
}

.modal-subtitle {
    margin: 0.25rem 0 0 0;
    opacity: 0.9;
    font-size: 0.875rem;
}

.modal-close-elegant {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.modal-close-elegant:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.modal-body-tabs {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

.tabs-nav {
    display: flex;
    background: #f3f4f6;
    border-bottom: 2px solid #e5e7eb;
    position: sticky;
    top: 0;
    z-index: 10;
}

.tab-btn {
    flex: 1;
    padding: 1rem;
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 500;
    color: #6b7280;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.tab-btn:hover {
    background: #e5e7eb;
    color: #374151;
}

.tab-btn.active {
    background: white;
    color: #10b981;
    border-bottom: 3px solid #10b981;
}

.tab-content {
    display: none;
    padding: 2rem;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.form-section {
    margin-bottom: 2rem;
}

.form-section-title {
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.form-row-triple {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-label.required::after {
    content: '*';
    color: #ef4444;
    margin-left: 0.25rem;
}

.form-input, .form-textarea {
    padding: 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.9375rem;
    transition: all 0.3s ease;
}

.form-input:focus, .form-textarea:focus {
    outline: none;
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.input-with-unit {
    position: relative;
}

.input-unit {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 500;
    pointer-events: none;
}

.checkbox-card {
    background: #f3f4f6;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.checkbox-card:hover {
    background: #e5e7eb;
}

.checkbox-card input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.checkbox-card-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    font-weight: 500;
    color: #374151;
    flex: 1;
}

.modal-footer-elegant {
    padding: 1.5rem 2rem;
    background: #f9fafb;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.btn-elegant {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-cancel {
    background: #e5e7eb;
    color: #374151;
}

.btn-cancel:hover {
    background: #d1d5db;
}

.btn-submit {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

@media (max-width: 768px) {
    .form-row, .form-row-triple {
        grid-template-columns: 1fr;
    }

    .tabs-nav {
        overflow-x: auto;
    }

    .tab-btn {
        font-size: 0.875rem;
        padding: 0.75rem 0.5rem;
    }
}





        /* Fertilizer Table Professional Design */
#fertilizerTableBody tr {
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    margin-bottom: 8px;
    border-radius: 8px;
    overflow: hidden;
}

#fertilizerTableBody tr:hover {
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
    transform: translateY(-2px);
}

#fertilizerTableBody td {
    vertical-align: middle;
    font-size: 0.95rem;
}

.badge {
    display: inline-block;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-icon {
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-icon i {
    font-size: 14px;
}





/* Green Theme for Production Details Modal */
.modal-header {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
}

.production-status {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-planned {
    background: #dbeafe;
    color: #1e40af;
}

.status-planted {
    background: #f3e8ff;
    color: #7e22ce;
}

.status-growing {
    background: #dcfce7;
    color: #15803d;
    border: 2px solid #10b981;
}

.status-harvested {
    background: #fef3c7;
    color: #b45309;
}

.status-sold {
    background: #d1fae5;
    color: #047857;
    border: 2px solid #059669;
}

/* Details Grid */
.details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.detail-item {
    padding: 10px;
}

.detail-item label {
    display: block;
    font-weight: 600;
    color: #059669;
    margin-bottom: 5px;
    font-size: 0.9rem;
}

.detail-item value {
    display: block;
    font-size: 1.1rem;
    color: #333;
}

/* Modal Large */
.modal-large {
    max-width: 900px !important;
}

/* Green Button Styles */
.btn-primary {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    color: white;
}

.btn-success:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}




        /* Harvest Modal Styles */
#harvestModal .form-group-full {
    grid-column: 1 / -1;
}

#harvestModal .form-input,
#harvestModal .form-select,
#harvestModal textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

#harvestModal .form-input:focus,
#harvestModal .form-select:focus,
#harvestModal textarea:focus {
    outline: none;
    border-color: #10b981;
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

#harvestModal .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
}

#harvestModal .form-label.required::after {
    content: " *";
    color: #ef4444;
}

#harvestModal small {
    font-size: 0.875rem;
    color: #6b7280;
}

#harvestModal .form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
}

/* Success button hover effect */
.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-success:active {
    transform: translateY(0);
}
    </style>
</head>
<body>





<div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
</div>

<div class="toast-container" id="toastContainer"></div>

<div class="dashboard-container">
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo" style="width: 45px; height: 45px; background: none; animation: none; box-shadow: none;">
                <img src="images/logo.jpeg" alt="AgriGuard AI Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
            </div>
            <div class="company-info">
                <div class="company-name">AgriGuard AI</div>
                <div class="company-tagline">Smart Farming</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">Main</h3>
                <ul class="nav-menu">
                    <li class="nav-item active">
                        <a class="nav-link" data-section="dashboard">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="farms">
                            <i class="fas fa-map-marked-alt"></i>
                            <span>My Farms</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="crops">
                            <i class="fas fa-seedling"></i>
                            <span>Crop Catalog</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="production">
                            <i class="fas fa-tractor"></i>
                            <span>Productions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="inventory">
                            <i class="fas fa-warehouse"></i>
                            <span>Inventory</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Resources</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="fertilizer">
                            <i class="fas fa-flask"></i>
                            <span>Fertilizer Usage</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="irrigation">
                            <i class="fas fa-tint"></i>
                            <span>Irrigation Data</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="soil">
                            <i class="fas fa-mountain"></i>
                            <span>Soil Data</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Market</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="market-prices">
                            <i class="fas fa-chart-line"></i>
                            <span>Market Prices</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="transactions">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Transactions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="supply-chain">
                            <i class="fas fa-truck"></i>
                            <span>Supply Chain</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Information</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="weather">
                            <i class="fas fa-cloud-sun"></i>
                            <span>Weather Data</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="alerts">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Security Alerts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="policies">
                            <i class="fas fa-gavel"></i>
                            <span>Policies & Subsidies</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="recommendations">
                            <i class="fas fa-lightbulb"></i>
                            <span>AI Recommendations</span>
                        </a>
                    </li>



                    <!-- Dans la sidebar, section "Information" -->
                    <li class="nav-item">
                        <a class="nav-link" href="http://localhost:1010/WhatsAppFarmerBuyer.html" target="_blank" id="whatsappChatLink">
                            <i class="fas fa-comments"></i>
                            <span>Chat</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Analytics</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="predictions">
                            <i class="fas fa-chart-area"></i>
                            <span>Production Predictions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="reports">
                            <i class="fas fa-file-alt"></i>
                            <span>Reports</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="greeting-section">
                    <div class="greeting-text" id="greetingText">Good Morning, Farmer!</div>
                    <div class="current-date" id="currentDate"></div>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search..." id="globalSearch">
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="header-right">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                    <span>Dark Mode</span>
                </button>
                <div style="position: relative;">
                    <button class="notification-btn" id="notificationBtn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationCount">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: white; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); width: 380px; max-height: 500px; overflow-y: auto; z-index: 1000; border: 1px solid #e9ecef;">
                        <div style="padding: 1rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, var(--primary-green), var(--secondary-green)); border-radius: 12px 12px 0 0;">
                            <h3 style="margin: 0; color: white; font-size: 1.1rem; font-weight: 700;">
                                <i class="fas fa-bell"></i> Notifications
                            </h3>
                            <button onclick="markAllNotificationsAsRead()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;" onmouseover="this.style.background='rgba(255,255,255,0.3)';" onmouseout="this.style.background='rgba(255,255,255,0.2)';">
                                Mark all read
                            </button>
                        </div>
                        <div id="notificationsList" style="max-height: 400px; overflow-y: auto;">
                            <div style="padding: 2rem; text-align: center; color: #999;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                <p>Loading notifications...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="profile-section" id="profileSection">
                    <div class="profile-avatar" id="profileAvatar">F</div>
                    <div class="profile-info">
                        <div class="profile-name" id="profileName">Farmer Name</div>
                        <div class="profile-role">Farmer</div>
                    </div>
                    <button class="logout-btn" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Sections -->
        <main class="content">
            <!-- Dashboard Home Section -->
            <div id="dashboardSection" class="content-section active">
                <div class="welcome-banner">
                    <div class="welcome-content">
                        <h1 class="welcome-title">Welcome to Your Dashboard</h1>
                        <p class="welcome-subtitle">Manage your farms, track production, and grow smarter</p>
                    </div>
                    <div class="welcome-actions">
                        <button class="btn btn-primary" data-action="add-farm">
                            <i class="fas fa-plus"></i>
                            Add New Farm
                        </button>
                        <button class="btn btn-primary" data-action="add-production">
                            <i class="fas fa-plus"></i>
                            Start Production
                        </button>
                    </div>
                </div>

                <!-- Quick Statistics -->
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon farms">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div class="stat-value" id="dashTotalFarms">0</div>
                        <div class="stat-label">Total Farms</div>
                        <div class="stat-sublabel" id="dashTotalArea">0 hectares</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon productions">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-value" id="dashActiveProductions">0</div>
                        <div class="stat-label">Active Productions</div>
                        <div class="stat-sublabel" id="dashTotalProductions">0 total</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon inventory">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <div class="stat-value" id="dashInventoryValue">RWF 0</div>
                        <div class="stat-label">Inventory Value</div>
                        <div class="stat-sublabel" id="dashInventoryItems">0 items</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon alerts">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-value" id="dashCriticalAlerts">0</div>
                        <div class="stat-label">Critical Alerts</div>
                        <div class="stat-sublabel" id="dashTotalAlerts">0 total alerts</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Production Trends (Last 6 Months)</h3>
                            <select class="chart-filter" id="productionTrendFilter">
                                <option value="all">All Crops</option>
                                <option value="cereals">Cereals</option>
                                <option value="vegetables">Vegetables</option>
                                <option value="fruits">Fruits</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="productionTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Cost Breakdown</h3>
                            <select class="chart-filter" id="costBreakdownFilter">
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="costBreakdownChart"></canvas>
                        </div>
                    </div>
                </div>





                <!-- Upcoming Tasks and Recent Activities -->
                <div class="dashboard-info-grid">
                    <div class="info-card">
                        <div class="info-card-header">
                            <h3 class="info-card-title">
                                <i class="fas fa-tasks"></i>
                                Upcoming Tasks
                            </h3>
                            <button class="btn btn-secondary btn-sm" data-action="refresh-tasks">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="info-card-content">
                            <div class="task-list" id="upcomingTasksList">
                                <div class="empty-state">
                                    <i class="fas fa-tasks"></i>
                                    <p>Loading upcoming tasks...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-card-header">
                            <h3 class="info-card-title">
                                <i class="fas fa-history"></i>
                                Recent Activities
                            </h3>
                            <button class="btn btn-secondary btn-sm" data-action="refresh-activities">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="info-card-content">
                            <div class="activity-list" id="recentActivitiesList">
                                <div class="empty-state">
                                    <i class="fas fa-history"></i>
                                    <p>Loading recent activities...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Critical Alerts Section -->
                <div class="alerts-section">
                    <div class="alerts-header">
                        <h3 class="alerts-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Critical Alerts
                        </h3>
                        <a href="#" class="alerts-view-all" data-section="alerts">View All Alerts</a>
                    </div>
                    <div class="alerts-grid" id="criticalAlertsGrid">
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <p>No critical alerts at the moment</p>
                        </div>
                    </div>
                </div>

                <!-- Weather Widget -->
                <div class="weather-widget">
                    <div class="weather-header">
                        <h3 class="weather-title">
                            <i class="fas fa-cloud-sun"></i>
                            Current Weather
                        </h3>
                        <div class="weather-location" id="weatherLocation">
                            <i class="fas fa-map-marker-alt"></i>
                            Loading...
                        </div>
                    </div>
                    <div class="weather-content" id="weatherContent">
                        <div class="weather-current">
                            <div class="weather-temp" id="weatherTemp">--°C</div>
                            <div class="weather-condition" id="weatherCondition">Loading...</div>
                        </div>
                        <div class="weather-details">
                            <div class="weather-detail">
                                <i class="fas fa-tint"></i>
                                <span>Humidity</span>
                                <strong id="weatherHumidity">--%</strong>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-wind"></i>
                                <span>Wind Speed</span>
                                <strong id="weatherWind">-- km/h</strong>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-cloud-rain"></i>
                                <span>Rainfall</span>
                                <strong id="weatherRainfall">-- mm</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Farms Section -->
            <div id="farmsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">My Farms</h2>
                        <p class="section-subtitle">Manage your agricultural lands</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-farm">
                            <i class="fas fa-plus"></i>
                            Add New Farm
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-farms">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-farms">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Farms Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-map"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="farmsTotalCount">0</div>
                            <div class="stat-mini-label">Total Farms</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-ruler-combined"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="farmsTotalArea">0 ha</div>
                            <div class="stat-mini-label">Total Area</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="farmsIrrigated">0</div>
                            <div class="stat-mini-label">Irrigated Farms</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="farmsActive">0</div>
                            <div class="stat-mini-label">Active Farms</div>
                        </div>
                    </div>
                </div>

                <!-- Farms Filter and Search -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search farms by name or location..." id="farmsSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="farmsSoilTypeFilter">
                            <option value="">All Soil Types</option>
                            <option value="clay">Clay</option>
                            <option value="loam">Loam</option>
                            <option value="sand">Sand</option>
                            <option value="silt">Silt</option>
                        </select>
                        <select class="filter-select" id="farmsIrrigationFilter">
                            <option value="">All Irrigation Systems</option>
                            <option value="RAIN_FED">Rain Fed</option>
                            <option value="SPRINKLER">Sprinkler</option>
                            <option value="DRIP">Drip Irrigation</option>
                            <option value="FLOOD">Flood Irrigation</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Farms Grid -->
                <div class="farms-grid" id="farmsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading your farms...</p>
                    </div>
                </div>
            </div>

            <!-- Crops Catalog Section -->
            <div id="cropsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Crop Catalog</h2>
                        <p class="section-subtitle">Browse available crops and their requirements</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-crops">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Crops Filter and Search -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search crops by name..." id="cropsSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="cropsTypeFilter">
                            <option value="">All Crop Types</option>
                            <option value="CEREALS">Cereals</option>
                            <option value="VEGETABLES">Vegetables</option>
                            <option value="FRUITS">Fruits</option>
                            <option value="LEGUMES">Legumes</option>
                            <option value="TUBERS">Tubers</option>
                            <option value="CASH_CROPS">Cash Crops</option>
                        </select>
                        <select class="filter-select" id="cropsSeasonFilter">
                            <option value="">All Seasons</option>
                            <option value="SEASON_A">Season A</option>
                            <option value="SEASON_B">Season B</option>
                            <option value="SEASON_C">Season C</option>
                        </select>
                        <select class="filter-select" id="cropsDemandFilter">
                            <option value="">All Demand Levels</option>
                            <option value="HIGH">High Demand</option>
                            <option value="MEDIUM">Medium Demand</option>
                            <option value="LOW">Low Demand</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-crop-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Crops Grid -->
                <div class="crops-grid" id="cropsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading crop catalog...</p>
                    </div>
                </div>
            </div>





            <!-- Production Section -->
            <div id="productionSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Crop Productions</h2>
                        <p class="section-subtitle">Track your planting and harvest activities</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-production">
                            <i class="fas fa-plus"></i>
                            Start Production
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-productions">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-productions">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Production Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="prodTotalCount">0</div>
                            <div class="stat-mini-label">Total Productions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="prodActive">0</div>
                            <div class="stat-mini-label">Active Productions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="prodHarvested">0</div>
                            <div class="stat-mini-label">Harvested</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="prodTotalYield">0 T</div>
                            <div class="stat-mini-label">Total Yield</div>
                        </div>
                    </div>
                </div>

                <!-- Production Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search productions..." id="productionSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="productionStatusFilter">
                            <option value="">All Status</option>
                            <option value="PLANNED">Planned</option>
                            <option value="PLANTED">Planted</option>
                            <option value="GROWING">Growing</option>
                            <option value="HARVESTED">Harvested</option>
                            <option value="SOLD">Sold</option>
                        </select>
                        <select class="filter-select" id="productionSeasonFilter">
                            <option value="">All Seasons</option>
                            <option value="SEASON_A">Season A</option>
                            <option value="SEASON_B">Season B</option>
                            <option value="SEASON_C">Season C</option>
                        </select>
                        <select class="filter-select" id="productionYearFilter">
                            <option value="">All Years</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-production-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Production Timeline View -->
                <div class="production-timeline" id="productionTimeline">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading productions...</p>
                    </div>
                </div>
            </div>






            <!-- Inventory Section -->
            <div id="inventorySection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Inventory Management</h2>
                        <p class="section-subtitle">Track your stored products</p>
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-primary" data-action="add-inventory">
                            <i class="fas fa-plus"></i>
                            Add Stock
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-inventory">
                            <i class="fas fa-redo"></i>
                            Refresh
                        </button>
                        <button class="btn btn-secondary" data-action="export-inventory">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Inventory Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="invTotalItems">0</div>
                            <div class="stat-mini-label">Total Items</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-weight"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="invTotalQuantity">0 KG</div>
                            <div class="stat-mini-label">Total Quantity</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="invTotalValue">RWF 0</div>
                            <div class="stat-mini-label">Total Value</div>
                        </div>
                    </div>
                    <div class="stat-mini-card alert">
                        <div class="stat-mini-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="invAlerts">0</div>
                            <div class="stat-mini-label">Active Alerts</div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Alerts -->
                <div class="inventory-alerts" id="inventoryAlerts">
                    <!-- Alerts will be dynamically inserted here -->
                </div>

                <!-- Inventory Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search inventory..." id="inventorySearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="inventoryStatusFilter">
                            <option value="">All Status</option>
                            <option value="AVAILABLE">Available</option>
                            <option value="RESERVED">Reserved</option>
                            <option value="SOLD">Sold</option>
                            <option value="EXPIRED">Expired</option>
                        </select>
                        <select class="filter-select" id="inventoryQualityFilter">
                            <option value="">All Quality</option>
                            <option value="EXCELLENT">Excellent</option>
                            <option value="GOOD">Good</option>
                            <option value="FAIR">Fair</option>
                            <option value="POOR">Poor</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-inventory-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Inventory Grid -->
                <div class="inventory-grid" id="inventoryGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading inventory...</p>
                    </div>
                </div>
            </div>




            <!-- Fertilizer Usage Section -->
            <div id="fertilizerSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Fertilizer Usage</h2>
                        <p class="section-subtitle">Track fertilizer applications and costs</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-fertilizer">
                            <i class="fas fa-plus"></i>
                            Record Usage
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-fertilizer">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-fertilizer">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Fertilizer Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-flask"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="fertTotalApplications">0</div>
                            <div class="stat-mini-label">Total Applications</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-weight-hanging"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="fertTotalQuantity">0 KG</div>
                            <div class="stat-mini-label">Total Quantity</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="fertTotalCost">RWF 0</div>
                            <div class="stat-mini-label">Total Cost</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="fertAvgEffectiveness">0</div>
                            <div class="stat-mini-label">Avg Effectiveness</div>
                        </div>
                    </div>
                </div>

                <!-- Fertilizer Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Cost by Fertilizer Type</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="fertilizerCostChart"></canvas>
                    </div>
                </div>

                <!-- Fertilizer Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search fertilizer records..." id="fertilizerSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="fertilizerTypeFilter">
                            <option value="">All Types</option>
                            <option value="ORGANIC">Organic</option>
                            <option value="NPK">NPK</option>
                            <option value="NITROGEN">Nitrogen</option>
                            <option value="PHOSPHATE">Phosphate</option>
                            <option value="POTASH">Potash</option>
                        </select>
                        <input type="date" class="filter-select" id="fertilizerDateFrom" placeholder="From Date">
                        <input type="date" class="filter-select" id="fertilizerDateTo" placeholder="To Date">
                        <button class="btn btn-secondary" data-action="clear-fertilizer-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Fertilizer Table -->
                <div class="table-section">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>Date</th>
                                <th>Crop Production</th>
                                <th>Fertilizer Type</th>
                                <th>Name</th>
                                <th>Quantity</th>
                                <th>Method</th>
                                <th>Cost</th>
                                <th>Effectiveness</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="fertilizerTableBody">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading fertilizer records...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Irrigation Data Section -->
            <div id="irrigationSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Irrigation Data</h2>
                        <p class="section-subtitle">Monitor water usage and efficiency</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-irrigation">
                            <i class="fas fa-plus"></i>
                            Record Irrigation
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-irrigation">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-irrigation">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Irrigation Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="irrigTotalSessions">0</div>
                            <div class="stat-mini-label">Total Sessions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-water"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="irrigTotalWater">0 L</div>
                            <div class="stat-mini-label">Total Water Used</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="irrigTotalCost">RWF 0</div>
                            <div class="stat-mini-label">Total Cost</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="irrigAvgEfficiency">0%</div>
                            <div class="stat-mini-label">Avg Efficiency</div>
                        </div>
                    </div>
                </div>

                <!-- Irrigation Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Water Usage Trends</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="irrigationTrendChart"></canvas>
                    </div>
                </div>

                <!-- Irrigation Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search irrigation records..." id="irrigationSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="irrigationMethodFilter">
                            <option value="">All Methods</option>
                            <option value="SPRINKLER">Sprinkler</option>
                            <option value="DRIP">Drip</option>
                            <option value="FLOOD">Flood</option>
                            <option value="FURROW">Furrow</option>
                            <option value="MANUAL">Manual</option>
                        </select>
                        <select class="filter-select" id="irrigationSourceFilter">
                            <option value="">All Sources</option>
                            <option value="WELL">Well</option>
                            <option value="RIVER">River</option>
                            <option value="LAKE">Lake</option>
                            <option value="RAINWATER">Rainwater</option>
                        </select>
                        <input type="date" class="filter-select" id="irrigationDateFrom" placeholder="From Date">
                        <input type="date" class="filter-select" id="irrigationDateTo" placeholder="To Date">
                        <button class="btn btn-secondary" data-action="clear-irrigation-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Irrigation Table -->
                <div class="table-section">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>Date</th>
                                <th>Farm</th>
                                <th>Water Amount</th>
                                <th>Duration</th>
                                <th>Method</th>
                                <th>Source</th>
                                <th>Moisture Before</th>
                                <th>Moisture After</th>
                                <th>Cost</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="irrigationTableBody">
                            <tr>
                                <td colspan="10" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading irrigation records...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Soil Data Section -->
            <div id="soilSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Soil Data</h2>
                        <p class="section-subtitle">Monitor soil health and quality</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-soil">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Soil Data Grid -->
                <div class="soil-data-grid" id="soilDataGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading soil data...</p>
                    </div>
                </div>
            </div>











                <!-- Market Prices Section -->
                <div id="marketPricesSection" class="content-section">
                    <div class="section-header">
                        <div class="section-header-left">
                            <h2 class="section-title">Market Prices</h2>
                            <p class="section-subtitle">Track real-time crop prices</p>
                        </div>
                        <div class="section-header-right">
                            <button class="btn btn-secondary" data-action="refresh-market-prices">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Market Prices Filter -->
                    <div class="filter-section">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Search crops or markets..." id="marketPricesSearchInput">
                        </div>
                        <div class="filter-controls">
                            <select class="filter-select" id="marketPricesTypeFilter">
                                <option value="">All Market Types</option>
                                <option value="WHOLESALE">Wholesale</option>
                                <option value="RETAIL">Retail</option>
                                <option value="FARM_GATE">Farm Gate</option>
                                <option value="EXPORT">Export</option>
                            </select>
                            <select class="filter-select" id="marketPricesTrendFilter">
                                <option value="">All Trends</option>
                                <option value="INCREASING">Increasing</option>
                                <option value="STABLE">Stable</option>
                                <option value="DECREASING">Decreasing</option>
                            </select>
                            <button class="btn btn-secondary" data-action="clear-market-prices-filters">
                                <i class="fas fa-times"></i>
                                Clear Filters
                            </button>
                        </div>
                    </div>

                    <!-- Market Prices Grid -->
                    <div class="market-prices-grid" id="marketPricesGrid">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading market prices...</p>
                        </div>
                    </div>
                </div>

            <!-- Transactions Section -->
            <div id="transactionsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">My Transactions</h2>
                        <p class="section-subtitle">Track your sales and purchases</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-transactions">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-transactions">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Transactions Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="txTotalCount">0</div>
                            <div class="stat-mini-label">Total Transactions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="txCompleted">0</div>
                            <div class="stat-mini-label">Completed</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="txTotalAmount">RWF 0</div>
                            <div class="stat-mini-label">Total Amount</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="txNetAmount">RWF 0</div>
                            <div class="stat-mini-label">Net Amount</div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search transactions..." id="transactionsSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="transactionsStatusFilter">
                            <option value="">All Status</option>
                            <option value="PENDING">Pending</option>
                            <option value="CONFIRMED">Confirmed</option>
                            <option value="DELIVERED">Delivered</option>
                            <option value="PAID">Paid</option>
                            <option value="CANCELLED">Cancelled</option>
                        </select>
                        <input type="date" class="filter-select" id="transactionsDateFrom" placeholder="From Date">
                        <input type="date" class="filter-select" id="transactionsDateTo" placeholder="To Date">
                        <button class="btn btn-secondary" data-action="clear-transactions-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="table-section">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>Transaction Code</th>
                                <th>Date</th>
                                <th>Buyer</th>
                                <th>Crop</th>
                                <th>Quantity</th>
                                <th>Total Amount</th>
                                <th>Net Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading transactions...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>



            <!-- Supply Chain Section -->
            <div id="supplyChainSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Supply Chain Tracking</h2>
                        <p class="section-subtitle">Track your products through the supply chain</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-supply-chain">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Supply Chain Search -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search by tracking code or production..." id="supplyChainSearchInput">
                    </div>
                </div>

                <!-- Supply Chain Stages Legend -->
                <div class="supply-chain-legend">
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #22c55e;"></span>
                        <span>Harvest</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #3b82f6;"></span>
                        <span>Collection</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #f59e0b;"></span>
                        <span>Storage</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #8b5cf6;"></span>
                        <span>Processing</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #ec4899;"></span>
                        <span>Packaging</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #14b8a6;"></span>
                        <span>Transport</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #f97316;"></span>
                        <span>Distribution</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #06b6d4;"></span>
                        <span>Retail</span>
                    </div>
                </div>

                <!-- Supply Chain Timeline -->
                <div class="supply-chain-container" id="supplyChainContainer">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading supply chain data...</p>
                    </div>
                </div>
            </div>

            <!-- Weather Data Section -->
            <div id="weatherSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Weather Data</h2>
                        <p class="section-subtitle">Monitor weather conditions</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-weather">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Weather Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            <i class="fas fa-thermometer-half"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="weatherAvgTemp">--°C</div>
                            <div class="stat-mini-label">Avg Temperature</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green);">
                            <i class="fas fa-cloud-rain"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="weatherTotalRainfall">-- mm</div>
                            <div class="stat-mini-label">Total Rainfall (7d)</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="weatherAvgHumidity">--%</div>
                            <div class="stat-mini-label">Avg Humidity</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="weatherRiskCount">0</div>
                            <div class="stat-mini-label">Active Risks</div>
                        </div>
                    </div>
                </div>

                <!-- Current Weather Cards -->
                <div class="weather-farms-grid" id="weatherFarmsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading weather data...</p>
                    </div>
                </div>

                <!-- Weather History Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Temperature & Rainfall Trends (Last 7 Days)</h3>
                        <div class="chart-actions">
                            <select class="filter-select" id="weatherChartDays" style="width: auto;">
                                <option value="7">Last 7 Days</option>
                                <option value="14">Last 14 Days</option>
                                <option value="30">Last 30 Days</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="weatherHistoryChart"></canvas>
                    </div>
                </div>

                <!-- AI Weather Predictions -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-brain"></i>
                            AI Weather Predictions & Analysis
                        </h3>
                        <button class="btn btn-primary" onclick="generateWeatherPrediction()" id="generatePredictionBtn">
                            <i class="fas fa-magic"></i>
                            Generate Prediction
                        </button>
                    </div>
                    <div id="weatherPredictionsContainer">
                        <div class="empty-state" style="padding: 3rem;">
                            <i class="fas fa-brain" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;"></i>
                            <p style="color: #666;">Click "Generate Prediction" to get AI-powered weather forecasts and agricultural insights</p>
                        </div>
                    </div>
                </div>

                <!-- Weather Risk Alerts -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Weather Risk Alerts
                        </h3>
                    </div>
                    <div id="weatherRiskAlertsContainer">
                        <div class="empty-state" style="padding: 2rem;">
                            <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--primary-green); margin-bottom: 0.5rem;"></i>
                            <p style="color: #666;">No active weather risks detected</p>
                        </div>
                    </div>
                </div>

                <!-- Agricultural Impact Analysis -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-seedling"></i>
                            Agricultural Impact Analysis
                        </h3>
                    </div>
                    <div id="agriculturalImpactContainer">
                        <div class="empty-state" style="padding: 2rem;">
                            <i class="fas fa-info-circle" style="font-size: 2rem; color: #3b82f6; margin-bottom: 0.5rem;"></i>
                            <p style="color: #666;">Agricultural impact analysis will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Food Security Alerts Section -->
            <div id="alertsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Food Security Alerts</h2>
                        <p class="section-subtitle">Stay informed about agricultural alerts</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-alerts">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Alerts Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search alerts..." id="alertsSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="alertsLevelFilter">
                            <option value="">All Levels</option>
                            <option value="CRITICAL">Critical</option>
                            <option value="HIGH">High</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="LOW">Low</option>
                            <option value="INFO">Info</option>
                        </select>
                        <select class="filter-select" id="alertsCategoryFilter">
                            <option value="">All Categories</option>
                            <option value="PRODUCTION">Production</option>
                            <option value="WEATHER">Weather</option>
                            <option value="MARKET">Market</option>
                            <option value="DISEASE">Disease</option>
                            <option value="POLICY">Policy</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-alerts-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Alerts Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="alertsCriticalCount">0</div>
                            <div class="stat-mini-label">Critical Alerts</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="alertsHighCount">0</div>
                            <div class="stat-mini-label">High Priority</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="alertsTotalCount">0</div>
                            <div class="stat-mini-label">Total Alerts</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green);">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="aiAlertsCount">0</div>
                            <div class="stat-mini-label">AI-Generated</div>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Section -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-brain"></i>
                            AI-Powered Alert Analysis
                        </h3>
                        <button class="btn btn-primary" onclick="generateAIAnalysis()" id="generateAIAnalysisBtn">
                            <i class="fas fa-magic"></i>
                            Generate AI Analysis
                        </button>
                    </div>
                    <div id="aiAnalysisContainer">
                        <div class="empty-state" style="padding: 3rem;">
                            <i class="fas fa-brain" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;"></i>
                            <p style="color: #666;">Click "Generate AI Analysis" to get intelligent insights based on your real farm data</p>
                        </div>
                    </div>
                </div>

                <!-- Alerts Grid -->
                <div class="alerts-list" id="alertsList">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading alerts...</p>
                    </div>
                </div>
            </div>

            <!-- Policies Section -->
            <div id="policiesSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Agricultural Policies & Subsidies</h2>
                        <p class="section-subtitle">Explore available government support</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-policies">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Policies Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search policies..." id="policiesSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="policiesTypeFilter">
                            <option value="">All Types</option>
                            <option value="SUBSIDY">Subsidy</option>
                            <option value="CREDIT_PROGRAM">Credit Program</option>
                            <option value="INSURANCE">Insurance</option>
                            <option value="REGULATION">Regulation</option>
                            <option value="SUPPORT_PROGRAM">Support Program</option>
                        </select>
                        <select class="filter-select" id="policiesStatusFilter">
                            <option value="">All Status</option>
                            <option value="ACTIVE">Active</option>
                            <option value="DRAFT">Draft</option>
                            <option value="EXPIRED">Expired</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-policies-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Policies Grid -->
                <div class="policies-grid" id="policiesGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading policies...</p>
                    </div>
                </div>
            </div>

            <!-- AI Recommendations Section -->
            <div id="recommendationsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">AI Recommendations & Predictions</h2>
                        <p class="section-subtitle">Get intelligent insights and predictions for your farm</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" onclick="generateAIRecommendations()" id="generateAIRecommendationsBtn">
                            <i class="fas fa-brain"></i>
                            Generate AI Analysis
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-recommendations">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- AI Chat Assistant -->
                <div class="chart-card" style="margin-bottom: 32px;">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-robot"></i>
                            AI Agricultural Assistant
                        </h3>
                        <span style="font-size: 12px; color: var(--text-secondary);">
                            Ask me anything about agriculture, your farm, or get recommendations
                        </span>
                    </div>
                    <div id="aiChatContainer" style="max-height: 500px; overflow-y: auto; padding: 20px; background: var(--bg-secondary); border-radius: 12px;">
                        <div id="aiChatMessages" style="display: flex; flex-direction: column; gap: 16px; min-height: 200px;">
                            <div class="ai-message ai-assistant" style="padding: 16px; background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--primary-green); border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i class="fas fa-robot" style="color: var(--primary-green);"></i>
                                    <strong style="color: var(--text-primary);">AI Assistant</strong>
                                </div>
                                <p style="color: var(--text-secondary); margin: 0; line-height: 1.6;">
                                    Hello! I'm your AI agricultural assistant. I can help you with:
                                </p>
                                <ul style="margin: 8px 0 0 20px; color: var(--text-secondary); line-height: 1.8;">
                                    <li>Farm management recommendations</li>
                                    <li>Crop production predictions</li>
                                    <li>Weather impact analysis</li>
                                    <li>Market insights</li>
                                    <li>Best practices for your specific crops</li>
                                </ul>
                                <p style="color: var(--text-secondary); margin: 8px 0 0 0; line-height: 1.6;">
                                    Ask me anything about your farm or agriculture in general!
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <input type="text" id="aiChatInput" placeholder="Ask a question about agriculture, your farm, or get recommendations..." 
                                   style="flex: 1; padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px;"
                                   onkeypress="if(event.key === 'Enter') sendAIChatMessage()">
                            <button class="btn btn-primary" onclick="sendAIChatMessage()" id="sendChatBtn">
                                <i class="fas fa-paper-plane"></i>
                                Send
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green);">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="recommendationsTotalCount">0</div>
                            <div class="stat-mini-label">Total Recommendations</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="recommendationsUrgentCount">0</div>
                            <div class="stat-mini-label">Urgent Actions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="recommendationsImplementedCount">0</div>
                            <div class="stat-mini-label">Implemented</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="aiConfidenceScore">--</div>
                            <div class="stat-mini-label">AI Confidence</div>
                        </div>
                    </div>
                </div>

                <!-- Comparison Charts Section -->
                <div class="chart-card" style="margin-bottom: 32px;">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-bar"></i>
                            Data Comparison & Trends
                        </h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
                        <div>
                            <h4 style="margin-bottom: 12px; color: var(--text-primary);">Production Trends</h4>
                            <canvas id="productionTrendsChart" style="max-height: 300px;"></canvas>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 12px; color: var(--text-primary);">Cost Analysis</h4>
                            <canvas id="costAnalysisChart" style="max-height: 300px;"></canvas>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 12px; color: var(--text-primary);">Yield Predictions</h4>
                            <canvas id="yieldPredictionsChart" style="max-height: 300px;"></canvas>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 12px; color: var(--text-primary);">Resource Usage</h4>
                            <canvas id="resourceUsageChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recommendations Filter -->
                <div class="filter-section">
                    <div class="filter-controls">
                        <select class="filter-select" id="recommendationsTypeFilter">
                            <option value="">All Types</option>
                            <option value="FERTILIZER">Fertilizer</option>
                            <option value="WATER">Water</option>
                            <option value="IRRIGATION">Irrigation</option>
                            <option value="SEEDS">Seeds</option>
                            <option value="PESTICIDE">Pesticide</option>
                            <option value="SOIL_MANAGEMENT">Soil Management</option>
                            <option value="HARVEST">Harvest</option>
                            <option value="PLANTING">Planting</option>
                            <option value="WEATHER_ADAPTATION">Weather Adaptation</option>
                            <option value="MARKET_TIMING">Market Timing</option>
                        </select>
                        <select class="filter-select" id="recommendationsPriorityFilter">
                            <option value="">All Priorities</option>
                            <option value="URGENT">Urgent</option>
                            <option value="HIGH">High</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="LOW">Low</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-recommendations-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Recommendations Grid -->
                <div class="recommendations-grid" id="recommendationsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading AI recommendations...</p>
                    </div>
                </div>
            </div>

            <!-- Production Predictions Section -->
            <div id="predictionsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Production Predictions</h2>
                        <p class="section-subtitle">AI-powered production forecasts based on your real farm data</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" onclick="refreshProductionPredictions()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Predictions Summary Cards -->
                <div class="stats-grid" id="predictionsSummaryCards" style="margin-bottom: 24px;">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Predictions Grid -->
                <div class="predictions-grid" id="predictionsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading predictions...</p>
                    </div>
                </div>

                <!-- Comparison Charts Section -->
                <div class="charts-section" id="predictionsChartsSection" style="margin-top: 32px;">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Historical vs Predicted Yields</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="yieldComparisonChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Production Trend Analysis</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="productionTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Crop Performance Prediction</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="cropPerformanceChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Seasonal Yield Forecast</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="seasonalForecastChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Reports & Analytics</h2>
                        <p class="section-subtitle">Generate comprehensive professional farm reports with detailed analytics</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" onclick="refreshReportsSection()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Report Configuration Card - Improved Design -->
                <div class="report-config-card" style="background: var(--card-bg); border-radius: 16px; padding: 32px; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); margin-bottom: 32px;">
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid var(--border-color);">
                        <div style="width: 50px; height: 50px; background: var(--gradient-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div>
                            <h3 style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin: 0 0 4px 0;">Report Configuration</h3>
                            <p style="font-size: 14px; color: var(--text-secondary); margin: 0;">Configure your report parameters below</p>
                        </div>
                    </div>
                    
                    <div class="report-config-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px;">
                        <div class="form-group" style="display: flex; flex-direction: column;">
                            <label class="form-label" style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                                <i class="fas fa-chart-bar" style="margin-right: 8px; color: var(--primary-green);"></i>
                                Report Type
                            </label>
                            <select class="form-select" id="reportType" style="padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-secondary); color: var(--text-primary); transition: all 0.3s ease;">
                                <option value="farm-overview">🏡 Farm Overview</option>
                                <option value="production-summary">🌾 Production Summary</option>
                                <option value="financial-report">💰 Financial Report</option>
                                <option value="resource-usage">💧 Resource Usage</option>
                                <option value="inventory-report">📦 Inventory Report</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; flex-direction: column;">
                            <label class="form-label" style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                                <i class="fas fa-calendar-alt" style="margin-right: 8px; color: var(--primary-green);"></i>
                                Time Period
                            </label>
                            <select class="form-select" id="reportPeriod" style="padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-secondary); color: var(--text-primary); transition: all 0.3s ease;">
                                <option value="this-month">This Month</option>
                                <option value="last-month">Last Month</option>
                                <option value="this-quarter">This Quarter</option>
                                <option value="this-year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; flex-direction: column;">
                            <label class="form-label" style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                                <i class="fas fa-calendar-day" style="margin-right: 8px; color: var(--primary-green);"></i>
                                From Date
                            </label>
                            <input type="date" class="form-input" id="reportDateFrom" style="padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                        <div class="form-group" style="display: flex; flex-direction: column;">
                            <label class="form-label" style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                                <i class="fas fa-calendar-check" style="margin-right: 8px; color: var(--primary-green);"></i>
                                To Date
                            </label>
                            <input type="date" class="form-input" id="reportDateTo" style="padding: 12px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                    </div>
                    
                    <div class="report-actions" style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <button class="btn btn-primary" data-action="generate-pdf-report" style="flex: 1; min-width: 200px; padding: 14px 24px; font-size: 16px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); transition: all 0.3s ease;">
                            <i class="fas fa-file-pdf"></i>
                            Generate PDF Report
                        </button>
                        <button class="btn btn-info" data-action="generate-excel-report" style="flex: 1; min-width: 200px; padding: 14px 24px; font-size: 16px; font-weight: 600; border-radius: 10px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.3s ease;">
                            <i class="fas fa-file-excel"></i>
                            Generate Excel Report
                        </button>
                        <button class="btn btn-secondary" data-action="preview-report" style="flex: 1; min-width: 200px; padding: 14px 24px; font-size: 16px; font-weight: 600; border-radius: 10px; transition: all 0.3s ease;">
                            <i class="fas fa-eye"></i>
                            Preview Report
                        </button>
                    </div>
                </div>

                <!-- Report Preview - Improved Design -->
                <div class="report-preview-card" id="reportPreview" style="display: none; background: var(--card-bg); border-radius: 16px; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); overflow: hidden;">
                    <div class="report-preview-header" style="background: var(--gradient-primary); padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; color: white;">
                        <h3 style="font-size: 20px; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-file-alt"></i>
                            Report Preview
                        </h3>
                        <button class="btn btn-secondary btn-sm" data-action="close-preview" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="report-preview-content" id="reportPreviewContent" style="padding: 32px; max-height: 70vh; overflow-y: auto; background: white;">
                        <!-- Report content will be inserted here -->
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>




<!-- Modals will be added via JavaScript -->
<div id="modalContainer"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="js/SessionTracker.js"></script>
<script src="js/user_session_handler.js"></script>
<script >




    // ============================================================================
    // GLOBAL CONFIGURATION
    // ============================================================================
    const DEBUG_MODE = false; // <-- AJOUTER CETTE LIGNE ICI (ligne ~20)
    const API_CONFIG = {
      BASE_URL: 'http://localhost:1010/api',
      TIMEOUT: 30000,
      RETRY_ATTEMPTS: 3
    };
      // Authentication state
      let currentUser = null;
      let authToken = null;

      // Charts instances
      let charts = {
      productionTrend: null,
      costBreakdown: null,
      fertilizerCost: null,
      irrigationTrend: null,
      weatherHistory: null
      };

      // ============================================================================
      // UTILITY FUNCTIONS
      // ============================================================================

      /**
      * Show loading overlay
      */
      function showLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'flex';
      }

      /**
      * Hide loading overlay
      */
      function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'none';
      }

      /**
      * Show toast notification
      */
      function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;

      const icon = {
      success: 'fa-check-circle',
      error: 'fa-exclamation-circle',
      warning: 'fa-exclamation-triangle',
      info: 'fa-info-circle'
      }[type] || 'fa-info-circle';

      toast.innerHTML = `
      <i class="fas ${icon}"></i>
      <span>${message}</span>
      <button class="toast-close" onclick="this.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
      `;

      container.appendChild(toast);

      setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease forwards';
      setTimeout(() => toast.remove(), 300);
      }, 5000);
      }




/**
 * Format currency amélioré
 */
function formatCurrency(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) {
        return 'RWF --';
    }

    // Formater avec séparateurs de milliers
    const formatted = new Intl.NumberFormat('en-RW', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);

    return `RWF ${formatted}`;
}





      /**
      * Format date
      */
      function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
      }).format(date);
      }

      /**
      * Format datetime
      */
      function formatDateTime(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
      }).format(date);
      }

      /**
      * Get auth headers
      */
      function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      return {
      'Content-Type': 'application/json',
      'Authorization': token ? `Bearer ${token}` : ''
      };
      }





// FarmerDashboard.html - Corrections JavaScript






async function apiRequest(endpoint, options = {}) {
    const url = `${API_CONFIG.BASE_URL}${endpoint}`;

    const config = {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': localStorage.getItem('authToken') ? `Bearer ${localStorage.getItem('authToken')}` : ''
        },
        ...options
    };

    try {
        console.log(`🔄 API Call: ${config.method} ${url}`);

        const response = await fetch(url, config);

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`❌ HTTP Error ${response.status}:`, errorText);

            if (response.status === 401) {
                handleUnauthorized();
                throw new Error('Authentication required');
            }

            if (response.status === 500) {
                // ✅ CORRECTION: Pour les endpoints de liste, retourner structure vide appropriée
                if (endpoint.includes('/v1/inventories/farmer/') ||
                    endpoint.includes('/farms/farmer/') ||
                    endpoint.includes('/v1/crop-productions/farm/') ||
                    endpoint.includes('/fertilizer-usages/farmer/') ||
                    endpoint.includes('/irrigation/farmer/') ||
                    endpoint.includes('/v1/soil-data/farmer/')) {
                    console.warn('Server error for list endpoint, returning empty structure');
                    // Return appropriate empty structure based on endpoint
                    if (endpoint.includes('/fertilizer-usages/')) {
                        return { content: [], totalElements: 0 };
                    }
                    if (endpoint.includes('/irrigation/') || endpoint.includes('/v1/soil-data/')) {
                        return { data: [], success: true };
                    }
                    return [];
                }
                throw new Error('Server error: ' + (errorText || 'Internal server error'));
            }

            throw new Error(`HTTP ${response.status}: ${errorText || 'Request failed'}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.warn('⚠️ Non-JSON response received');
            return null;
        }

        const data = await response.json();
        console.log(`✅ API Success: ${endpoint}`, data);
        return data;

    } catch (error) {
        console.error('💥 API Request Failed:', error);

        // ✅ CORRECTION: Pour les endpoints de liste en cas d'erreur réseau
        if (endpoint.includes('/v1/inventories/farmer/') ||
            endpoint.includes('/farms/farmer/') ||
            endpoint.includes('/v1/crop-productions/farm/') ||
            endpoint.includes('/fertilizer-usages/farmer/') ||
            endpoint.includes('/irrigation/farmer/') ||
            endpoint.includes('/soil-data/farmer/')) {
            console.warn('Network error for list endpoint, returning empty structure');
            // Return appropriate empty structure based on endpoint
            if (endpoint.includes('/fertilizer-usages/')) {
                return { content: [], totalElements: 0 };
            }
            if (endpoint.includes('/irrigation/') || endpoint.includes('/v1/soil-data/')) {
                return { data: [], success: true };
            }
            return [];
        }

        throw error;
    }
}













      /**
      * Handle unauthorized access
      */
      function handleUnauthorized() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = '/login.html';
      }

/**
   * Load user session - VERSION CORRIGÉE
   */
  function loadUserSession() {
    const sessionHandler = UserSessionHandler.getInstance();

    // Vérifier l'authentification
    if (!sessionHandler.isAuthenticated()) {
      handleUnauthorized();
      return null;
    }

    // Récupérer l'utilisateur
    const user = sessionHandler.getCurrentUser();
    if (!user) {
      handleUnauthorized();
      return null;
    }

    try {
      // ✅ FIX: S'assurer que currentUser a un ID valide
      currentUser = {
        ...user,
        id: user.id || user.userId || user.farmerId,
        fullName: user.fullName || user.username || 'Farmer',
        email: user.email || '',
        role: user.role || 'FARMER'
      };

      authToken = user.token || sessionHandler.getAuthToken();

      console.log('✅ User session loaded:', currentUser);
      return currentUser;
    } catch (error) {
      console.error('❌ Error loading user session:', error);
      handleUnauthorized();
      return null;
    }
  }



  /**
   * Update profile display
   */
  function updateProfileDisplay() {
    if (!currentUser) {
      const sessionHandler = UserSessionHandler.getInstance();
      currentUser = sessionHandler.getCurrentUser();
    }

    if (!currentUser) return;

    const profileName = document.getElementById('profileName');
    const profileAvatar = document.getElementById('profileAvatar');
    const greetingText = document.getElementById('greetingText');

    if (profileName) profileName.textContent = currentUser.fullName || 'Farmer';

    if (greetingText) {
      const hour = new Date().getHours();
      const greeting = hour < 12 ? 'Good Morning' : hour < 18 ? 'Good Afternoon' : 'Good Evening';
      greetingText.textContent = `${greeting}, ${currentUser.fullName || 'Farmer'}!`;
    }

    if (profileAvatar) {
      const photoData = currentUser.photo || currentUser.photoBase64 || currentUser.profileImageUrl;
      if (photoData) {
        const imgSrc = photoData.startsWith('data:image/') || photoData.startsWith('http')
          ? photoData
          : `data:image/jpeg;base64,${photoData}`;
        profileAvatar.innerHTML = `<img src="${imgSrc}" alt="Profile" onerror="this.parentElement.textContent='${(currentUser.fullName || 'F').charAt(0).toUpperCase()}'">`;
      } else {
        profileAvatar.textContent = (currentUser.fullName || 'F').charAt(0).toUpperCase();
      }
    }
  }

      /**
      * Update current date display
      */
      function updateCurrentDate() {
      const dateElement = document.getElementById('currentDate');
      if (dateElement) {
      const today = new Date();
      dateElement.textContent = new Intl.DateTimeFormat('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
      }).format(today);
      }


      }





      // ============================================================================
      // NAVIGATION AND UI MANAGEMENT
      // ============================================================================

      /**
      * Initialize navigation
      */
      function initNavigation() {
      const navLinks = document.querySelectorAll('.nav-link');

      navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
      e.preventDefault();
      const section = link.getAttribute('data-section');
      if (section) {
      navigateToSection(section);
      }
      });
      });

      // Sidebar toggle with smooth animation
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');

      if (sidebarToggle && sidebar && mainContent) {
        sidebarToggle.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          mainContent.classList.toggle('sidebar-collapsed');
          
          // Trigger a reflow to ensure smooth animation
          void mainContent.offsetWidth;
        });
      }

      // Theme toggle
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
      themeToggle.addEventListener('click', toggleTheme);
      loadThemePreference();
      }

      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
      logoutBtn.addEventListener('click', handleLogout);
      }
      }






      /**
 * Navigate to a specific section
 */
function navigateToSection(sectionName) {
    console.log('🔄 Navigating to section:', sectionName);

    // Hide all sections
    const sections = document.querySelectorAll('.content-section');
    sections.forEach(section => {
        section.classList.remove('active');
        section.style.display = 'none'; // ✅ Force hide
    });

    // ⭐ CORRECTION: Trouver la section correcte
    let targetSection;

    // Mapping des noms de section vers les IDs (basé sur les IDs réels dans le HTML)
    const sectionMapping = {
        'dashboard': 'dashboardSection',
        'farms': 'farmsSection',
        'crops': 'cropsSection',
        'production': 'productionSection', // ✅ data-section="production" maps to productionSection (ID réel)
        'productions': 'productionSection', // ✅ Also handle 'productions' for consistency
        'inventory': 'inventorySection',
        'fertilizer': 'fertilizerSection', // ✅ data-section="fertilizer" maps to fertilizerSection (ID réel)
        'fertilizers': 'fertilizerSection', // ✅ Also handle 'fertilizers' for consistency
        'irrigation': 'irrigationSection',
        'soil': 'soilSection',
        'supply-chain': 'supplyChainSection',
        'weather': 'weatherSection',
        'market-prices': 'marketPricesSection',
        'transactions': 'transactionsSection',
        'alerts': 'alertsSection',
        'policies': 'policiesSection',
        'recommendations': 'recommendationsSection',
        'predictions': 'predictionsSection',
        'reports': 'reportsSection',
        'settings': 'settingsSection'
    };

    const sectionId = sectionMapping[sectionName] || `${sectionName}Section`;
    targetSection = document.getElementById(sectionId);

    if (targetSection) {
        // ✅ Force l'affichage de la section
        targetSection.classList.add('active');
        targetSection.style.display = 'block';
        targetSection.style.opacity = '1';
        targetSection.style.visibility = 'visible';

        console.log('✅ Section found and activated:', sectionName);

        // Scroll to top
        window.scrollTo(0, 0);
    } else {
        console.error('❌ Section not found:', sectionName, 'with ID:', sectionId);

        // Debug: List all available sections
        console.log('📋 Available sections:',
            Array.from(document.querySelectorAll('.content-section'))
                .map(s => s.id)
        );
    }

    // Update nav active state
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        const parentLi = link.closest('li');
        if (parentLi) {
            parentLi.classList.remove('active');
        }
        if (link.getAttribute('data-section') === sectionName) {
            const parentLi = link.closest('li');
            if (parentLi) {
                parentLi.classList.add('active');
            }
        }
    });

    // Load section data
    console.log('📊 Loading data for section:', sectionName);
    loadSectionData(sectionName);
}

/**
 * Load data for specific section - VERSION CORRIGÉE
 */
async function loadSectionData(sectionName) {
    console.log('📊 loadSectionData called for:', sectionName);

    try {
        switch (sectionName) {
            case 'dashboard':
                await loadDashboardData();
                break;
            case 'farms':
                await loadFarmData();
                break;
            case 'crops':
                await loadCropsData();
                break;
            case 'production': // ✅ Handle both 'production' and 'productions'
            case 'productions':
                await loadProductionData();
                break;
            case 'inventory':
                await loadInventoryData();
                break;
            case 'fertilizer': // ✅ Handle both 'fertilizer' and 'fertilizers'
            case 'fertilizers':
                await loadFertilizerData();
                break;
            case 'supply-chain':
                await loadSupplyChainData();
                break;
            case 'weather':
                await loadWeatherData();
                break;
            case 'market-prices':
                await loadMarketPricesData();
                break;
            case 'transactions':
                await loadTransactionsData();
                break;
            case 'soil':
                await loadSoilData();
                break;
            case 'irrigation':
                await loadIrrigationData();
                break;
            case 'recommendations':
                await loadRecommendationsData();
                break;
            case 'predictions':
                await loadPredictionsData();
                break;
            case 'alerts':
                await loadAlertsData();
                break;
            case 'policies':
                await loadPoliciesData();
                break;
            case 'reports':
                // Load reports if needed
                break;
            case 'settings':
                // Load settings if needed
                break;
            default:
                console.warn('⚠️ No data loader for section:', sectionName);
        }
    } catch (error) {
        console.error(`❌ Error loading data for ${sectionName}:`, error);
    }
}




/**
 * Toggle theme - VERSION CORRIGÉE
 */
function toggleTheme() {
  const body = document.body;
  const themeToggle = document.getElementById('themeToggle');

  // Toggle dark mode class
  const isDark = body.classList.toggle('dark-mode');

  // Save preference
  localStorage.setItem('theme', isDark ? 'dark' : 'light');

  // Update button
  if (themeToggle) {
    const icon = themeToggle.querySelector('i');
    const text = themeToggle.querySelector('span');

    if (isDark) {
      if (icon) icon.className = 'fas fa-sun';
      if (text) text.textContent = 'Light Mode';
    } else {
      if (icon) icon.className = 'fas fa-moon';
      if (text) text.textContent = 'Dark Mode';
    }
  }

  console.log('✅ Theme toggled to:', isDark ? 'dark' : 'light');
}

/**
 * Load theme preference - VERSION CORRIGÉE
 */
function loadThemePreference() {
  const theme = localStorage.getItem('theme');
  const body = document.body;
  const themeToggle = document.getElementById('themeToggle');

  if (theme === 'dark') {
    body.classList.add('dark-mode');

    if (themeToggle) {
      const icon = themeToggle.querySelector('i');
      const text = themeToggle.querySelector('span');

      if (icon) icon.className = 'fas fa-sun';
      if (text) text.textContent = 'Light Mode';
    }

    console.log('✅ Dark mode loaded from preferences');
  }
}
      /**
      * Handle logout
      */
      function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = '/login.html';
      }
      }

      // ============================================================================
      // DASHBOARD HOME MODULE
      // ============================================================================

      /**
      * Load dashboard data
      */
      async function loadDashboardData() {
      try {
      showLoading();

      // Load all dashboard components in parallel
      await Promise.all([
      loadDashboardStats(),
      loadDashboardCharts(),
      loadUpcomingTasks(),
      loadRecentActivities(),
      loadCriticalAlerts(),
      loadWeatherWidget()
      ]);

      } catch (error) {
      console.error('Error loading dashboard:', error);
      showToast('Error loading dashboard data', 'error');
      } finally {
      hideLoading();
      }
      }




/**
 * Load dashboard stats - VERSION AMÉLIORÉE
 */
async function loadDashboardStats() {
    try {
        // ✅ VALIDATION UTILISATEUR ROBUSTE
        if (!currentUser || !currentUser.id) {
            console.warn('⚠️ No current user found in dashboard stats');
            displayDefaultStats();
            return;
        }

        console.log('🔄 Loading dashboard stats for user:', currentUser.id);

        // RÉCUPÉRATION FERMES avec gestion d'erreur
        let farms = [];
        try {
            const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
            farms = Array.isArray(farmsResponse) ? farmsResponse : [];
            console.log(`✅ Loaded ${farms.length} farms for stats`);
        } catch (error) {
            console.warn('⚠️ Farms load warning:', error.message);
            farms = [];
        }





        const totalFarms = farms.length;
        const totalArea = farms.reduce((sum, farm) =>
            sum + (parseFloat(farm.farmSize || farm.sizeHectares) || 0), 0);

        // ✅ CORRECTION : RÉCUPÉRATION PRODUCTIONS POUR CHAQUE FERME
        let allProductions = [];
        if (farms.length > 0) {
            try {
                const productionPromises = farms.map(farm =>
                    apiRequest(`/v1/crop-productions/farm/${farm.id}`)
                        .then(response => {
                            // Gestion des différents formats de réponse
                            if (Array.isArray(response)) {
                                return response;
                            } else if (response && response.data && Array.isArray(response.data)) {
                                return response.data;
                            } else if (response && response.content && Array.isArray(response.content)) {
                                return response.content;
                            }
                            return [];
                        })
                        .catch(err => {
                            console.warn(`⚠️ Production load failed for farm ${farm.id}`);
                            return [];
                        })
                );

                const productionArrays = await Promise.all(productionPromises);
                allProductions = productionArrays.flat().filter(p => p && p.productionStatus);

                console.log(`✅ Total productions loaded: ${allProductions.length}`);

            } catch (error) {
                console.warn('⚠️ Productions load warning:', error.message);
            }
        }
const activeProductions = allProductions.filter(p => {
    if (!p.productionStatus) return false;
    const status = p.productionStatus.toUpperCase();
    return ['PLANTED', 'GROWING', 'PLANNED', 'IN_PROGRESS', 'ACTIVE'].includes(status);
}).length;
        const totalProductions = allProductions.length;

        // RÉCUPÉRATION INVENTAIRE
        let inventory = [];
        let inventoryValue = 0;
        let inventoryItems = 0;

        try {
            const inventoryResponse = await apiRequest(`/v1/inventories/farmer/${currentUser.id}`);

            if (inventoryResponse) {
                if (Array.isArray(inventoryResponse)) {
                    inventory = inventoryResponse;
                } else if (inventoryResponse.data && Array.isArray(inventoryResponse.data)) {
                    inventory = inventoryResponse.data;
                } else if (inventoryResponse.content && Array.isArray(inventoryResponse.content)) {
                    inventory = inventoryResponse.content;
                }
            }

            inventoryValue = inventory.reduce((sum, item) => {
                const value = parseFloat(item.totalMarketValue || 0);
                return sum + (isNaN(value) ? 0 : value);
            }, 0);

            inventoryItems = inventory.length;

        } catch (error) {
            console.warn('⚠️ Inventory load warning:', error.message);
        }

        // RÉCUPÉRATION ALERTES
        let alerts = [];
        let criticalAlerts = 0;
        try {
            const alertsResponse = await apiRequest('/food-security-alerts/active');

            if (alertsResponse) {
                if (Array.isArray(alertsResponse)) {
                    alerts = alertsResponse;
                } else if (alertsResponse.data && Array.isArray(alertsResponse.data)) {
                    alerts = alertsResponse.data;
                } else if (alertsResponse.content && Array.isArray(alertsResponse.content)) {
                    alerts = alertsResponse.content;
                }
            }

            criticalAlerts = alerts.filter(a =>
                a && a.alertLevel && ['CRITICAL', 'HIGH'].includes(a.alertLevel)
            ).length;

        } catch (error) {
            console.warn('⚠️ Alerts load warning:', error.message);
        }

        // ✅ MISE À JOUR UI
        updateElement('dashTotalFarms', totalFarms);
        updateElement('dashTotalArea', `${totalArea.toFixed(2)} ha`);
        updateElement('dashActiveProductions', activeProductions);
        updateElement('dashTotalProductions', `${totalProductions} total`);
        updateElement('dashInventoryValue', formatCurrency(inventoryValue));
        updateElement('dashInventoryItems', `${inventoryItems} items`);
        updateElement('dashCriticalAlerts', criticalAlerts);
        updateElement('dashTotalAlerts', `${alerts.length} total alerts`);

        if (DEBUG_MODE) {
            console.log('✅ Dashboard stats updated:', {
                farms: totalFarms,
                activeProductions,
                totalProductions,
                inventoryItems,
                alerts: alerts.length
            });
        }

    } catch (error) {
        console.error('💥 Error loading dashboard stats:', error);
        displayDefaultStats();
    }
}






/**
 * Reload user session safely
 */
function reloadUserSession() {
    try {
        const sessionHandler = UserSessionHandler.getInstance();

        if (!sessionHandler.isAuthenticated()) {
            console.error('❌ User not authenticated');
            return null;
        }

        const user = sessionHandler.getCurrentUser();
        if (!user) {
            console.error('❌ Cannot retrieve user from session');
            return null;
        }

        // Mettre à jour currentUser avec une structure cohérente
        currentUser = {
            ...user,
            id: user.id || user.userId || user.farmerId,
            fullName: user.fullName || user.username || 'Farmer',
            email: user.email || '',
            role: user.role || 'FARMER'
        };

        authToken = user.token || sessionHandler.getAuthToken();

        console.log('✅ User session reloaded:', currentUser.id);
        return currentUser;

    } catch (error) {
        console.error('❌ Error reloading user session:', error);
        return null;
    }
}



/**
 * Afficher des statistiques par défaut en cas d'erreur
 */
function displayDefaultStats() {
    updateElement('dashTotalFarms', 0);
    updateElement('dashTotalArea', '0 ha');
    updateElement('dashActiveProductions', 0);
    updateElement('dashTotalProductions', '0 total');
    updateElement('dashInventoryValue', formatCurrency(0));
    updateElement('dashInventoryItems', '0 items');
    updateElement('dashCriticalAlerts', 0);
    updateElement('dashTotalAlerts', '0 total alerts');
}







/**
 * Load dashboard charts - VERSION CORRIGÉE
 */
async function loadDashboardCharts() {
    try {
        console.log('🔄 Loading dashboard charts...');

        // ✅ VALIDATION ROBUSTE DE L'UTILISATEUR
        if (!currentUser || !currentUser.id) {
            console.warn('⚠️ No user found for charts, trying to reload session...');

            // Tentative de rechargement de la session
            const sessionHandler = UserSessionHandler.getInstance();
            const user = sessionHandler.getCurrentUser();

            if (user && user.id) {
                currentUser = {
                    ...user,
                    id: user.id || user.userId || user.farmerId,
                    fullName: user.fullName || user.username || 'Farmer'
                };
                console.log('✅ User session reloaded for charts:', currentUser.id);
            } else {
                console.error('❌ Cannot load charts: No user ID available');
                createEmptyCharts(); // Créer des graphiques vides
                return;
            }
        }

        console.log('👤 Loading charts for user ID:', currentUser.id);

        // Récupérer les fermes
        let farms = [];
        try {
            const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
            farms = Array.isArray(farmsResponse) ? farmsResponse : [];
            console.log(`✅ Loaded ${farms.length} farms for charts`);
        } catch (error) {
            console.warn('⚠️ Error loading farms for charts:', error.message);
            farms = [];
        }

        // Données par défaut pour les graphiques
        let chartData = {
            productionTrend: Array(6).fill(0).map((_, i) => ({
                month: new Date(new Date().getFullYear(), new Date().getMonth() - (5 - i), 1)
                    .toLocaleString('default', { month: 'short' }),
                year: new Date().getFullYear(),
                value: 0
            })),
            costBreakdown: {
                fertilizer: 0,
                irrigation: 0,
                storage: 0
            }
        };

        // Si des fermes existent, essayer de récupérer les données réelles
        if (farms.length > 0) {
            try {
                // Récupérer les productions pour toutes les fermes
                let productions = [];
                const productionPromises = farms.map(farm =>
                    apiRequest(`/v1/crop-productions/farm/${farm.id}`).catch(() => [])
                );
                const productionArrays = await Promise.all(productionPromises);
                productions = productionArrays.flat().filter(p => p);

                // Calculer les données de production pour les 6 derniers mois
                const last6Months = [];
                const today = new Date();
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    last6Months.push({
                        month: date.toLocaleString('default', { month: 'short' }),
                        year: date.getFullYear(),
                        value: 0
                    });
                }

                productions.forEach(prod => {
                    if (prod.actualYield && prod.actualHarvestDate) {
                        const harvestDate = new Date(prod.actualHarvestDate);
                        const monthKey = harvestDate.toLocaleString('default', { month: 'short' });
                        const monthData = last6Months.find(m =>
                            m.month === monthKey && m.year === harvestDate.getFullYear()
                        );
                        if (monthData) {
                            monthData.value += parseFloat(prod.actualYield) || 0;
                        }
                    }
                });

                chartData.productionTrend = last6Months;

                // Données de coûts
                let fertilizers = [];
                try {
                    const fertilizerResponse = await apiRequest(`/fertilizer-usages/farmer/${currentUser.id}`);
                    fertilizers = Array.isArray(fertilizerResponse) ? fertilizerResponse : [];
                } catch (error) {
                    console.warn('Error loading fertilizer data for charts:', error);
                    fertilizers = [];
                }

                let irrigations = [];
                try {
                    const irrigationResponse = await apiRequest(`/irrigation/farmer/${currentUser.id}`);
                    irrigations = Array.isArray(irrigationResponse) ? irrigationResponse :
                                (irrigationResponse && Array.isArray(irrigationResponse.content)) ? irrigationResponse.content : [];
                } catch (error) {
                    console.warn('Error loading irrigation data for charts:', error);
                    irrigations = [];
                }

                chartData.costBreakdown = {
                    fertilizer: fertilizers.reduce((sum, f) => sum + (parseFloat(f.totalCost) || 0), 0),
                    irrigation: irrigations.reduce((sum, i) => sum + (parseFloat(i.totalCost) || 0), 0),
                    storage: 50000 // Valeur par défaut
                };

            } catch (error) {
                console.warn('⚠️ Error loading detailed chart data, using defaults:', error.message);
            }
        }

        // Créer les graphiques avec les données disponibles
        createProductionTrendChart(chartData.productionTrend);
        createCostBreakdownChart(chartData.costBreakdown);

        console.log('✅ Dashboard charts loaded successfully');

    } catch (error) {
        console.error('❌ Error loading dashboard charts:', error);
        createEmptyCharts(); // Créer des graphiques vides en cas d'erreur
    }
}

/**
 * Create empty charts as fallback
 */
function createEmptyCharts() {
    console.log('📊 Creating empty charts as fallback...');

    // Graphique de tendance de production vide
    const emptyProductionData = Array(6).fill(0).map((_, i) => ({
        month: new Date(new Date().getFullYear(), new Date().getMonth() - (5 - i), 1)
            .toLocaleString('default', { month: 'short' }),
        value: 0
    }));

    createProductionTrendChart(emptyProductionData);

    // Graphique de répartition des coûts vide
    createCostBreakdownChart({
        fertilizer: 0,
        irrigation: 0,
        storage: 0
    });
}




function createProductionTrendChart(data) {
    const ctx = document.getElementById('productionTrendChart');
    if (!ctx) {
        console.warn('⚠️ Production trend chart canvas not found');
        return;
    }

    // ✅ VALIDATION DES DONNÉES
    if (!Array.isArray(data) || data.length === 0) {
        console.warn('⚠️ No data for production trend chart');
        return;
    }

    try {
        // ✅ DÉTRUIRE L'ANCIEN GRAPHIQUE
        if (charts.productionTrend) {
            charts.productionTrend.destroy();
            charts.productionTrend = null;
        }

        // ✅ PRÉPARER LES DONNÉES
        const labels = data.map(d => d.month || 'N/A');
        const values = data.map(d => {
            const val = parseFloat(d.value);
            return isNaN(val) ? 0 : val;
        });

        console.log('📊 Chart Labels:', labels);
        console.log('📊 Chart Values:', values);

        // ✅ CRÉER LE NOUVEAU GRAPHIQUE
        charts.productionTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Production (Tonnes)',
                    data: values,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#22c55e',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y || 0;
                                return `Production: ${value.toFixed(2)} T`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(1) + ' T';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        console.log('✅ Production trend chart created successfully');

    } catch (error) {
        console.error('❌ Error creating production trend chart:', error);
    }
}




      /**
      * Create cost breakdown chart
      */
      function createCostBreakdownChart(costs) {
      const ctx = document.getElementById('costBreakdownChart');
      if (!ctx) return;

      if (charts.costBreakdown) {
      charts.costBreakdown.destroy();
      }

      charts.costBreakdown = new Chart(ctx, {
      type: 'doughnut',
      data: {
      labels: ['Fertilizer', 'Irrigation', 'Storage'],
      datasets: [{
      data: [costs.fertilizer, costs.irrigation, costs.storage],
      backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b'],
      borderWidth: 0
      }]
      },
      options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
      legend: {
      position: 'bottom'
      }
      }
      }
      });
      }



/**
 * Load upcoming tasks - VERSION CORRIGÉE
 */
async function loadUpcomingTasks() {
    try {
        const container = document.getElementById('upcomingTasksList');
        if (!container) return;

        // ✅ VALIDATION UTILISATEUR AVEC FALLBACK
        if (!currentUser || !currentUser.id) {
            console.warn('⚠️ No user for tasks, displaying empty state');
            displayEmptyTasks(container);
            return;
        }

        let farms = [];
        try {
            const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
            farms = farmsResponse || [];
        } catch (error) {
            console.warn('⚠️ Error loading farms for tasks:', error.message);
            farms = [];
        }

        let productions = [];
        if (farms.length > 0) {
            try {
                const productionPromises = farms.map(farm =>
                    apiRequest(`/v1/crop-productions/farm/${farm.id}`).catch(() => [])
                );
                const productionArrays = await Promise.all(productionPromises);
                productions = productionArrays.flat();
            } catch (error) {
                console.warn('⚠️ Error loading productions for tasks:', error.message);
                productions = [];
            }
        }

        const today = new Date();
        const upcoming = productions
            .filter(p => p && p.expectedHarvestDate && new Date(p.expectedHarvestDate) > today)
            .sort((a, b) => new Date(a.expectedHarvestDate) - new Date(b.expectedHarvestDate))
            .slice(0, 5);

        if (upcoming.length === 0) {
            displayEmptyTasks(container);
            return;
        }

        container.innerHTML = upcoming.map(prod => {
            const daysUntil = Math.ceil((new Date(prod.expectedHarvestDate) - today) / (1000 * 60 * 60 * 24));
            return `
                <div class="task-item">
                    <div class="task-icon">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <div class="task-content">
                        <div class="task-title">Harvest ${prod.cropName || 'Crop'}</div>
                        <div class="task-date">Expected in ${daysUntil} days</div>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('❌ Error loading upcoming tasks:', error);
        const container = document.getElementById('upcomingTasksList');
        if (container) displayEmptyTasks(container);
    }
}

/**
 * Display empty tasks state
 */
function displayEmptyTasks(container) {
    container.innerHTML = `
        <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <p>No upcoming tasks</p>
        </div>
    `;
}

/**
 * ⭐ FONCTION MISE À JOUR: Load recent activities with crop names
 */
async function loadRecentActivities() {
    try {
        const container = document.getElementById('recentActivitiesList');
        if (!container) return;

        // ✅ VALIDATION UTILISATEUR AVEC FALLBACK
        if (!currentUser || !currentUser.id) {
            console.warn('⚠️ No user for activities, displaying empty state');
            displayEmptyActivities(container);
            return;
        }

        console.log('🔄 Loading recent activities for user:', currentUser.id);

        const activities = [];

        // ⭐ ÉTAPE 1: Charger tous les crops UNE SEULE FOIS
        let cropsMap = {};
        try {
            const cropsResponse = await apiRequest('/v1/crops/all');
            let crops = [];

            if (Array.isArray(cropsResponse)) {
                crops = cropsResponse;
            } else if (cropsResponse && cropsResponse.data) {
                crops = Array.isArray(cropsResponse.data) ? cropsResponse.data : [];
            }

            // Créer une map cropId -> cropName pour lookup rapide
            crops.forEach(crop => {
                if (crop && crop.id && crop.cropName) {
                    cropsMap[crop.id] = crop.cropName;
                }
            });

            console.log(`✅ Loaded ${Object.keys(cropsMap).length} crops for activities`);

        } catch (error) {
            console.warn('⚠️ Error loading crops:', error.message);
        }

        // ⭐ ÉTAPE 2: Charger les productions directement par farmer ID
        let productions = [];
        try {
            const productionsResponse = await apiRequest(`/v1/crop-productions/by-farmer/${currentUser.id}`);

            if (Array.isArray(productionsResponse)) {
                productions = productionsResponse;
            } else if (productionsResponse && productionsResponse.data) {
                if (Array.isArray(productionsResponse.data)) {
                    productions = productionsResponse.data;
                } else if (productionsResponse.data.content && Array.isArray(productionsResponse.data.content)) {
                    productions = productionsResponse.data.content;
                }
            } else if (productionsResponse && productionsResponse.content && Array.isArray(productionsResponse.content)) {
                productions = productionsResponse.content;
            }

            console.log(`✅ Loaded ${productions.length} productions for activities`);

        } catch (error) {
            console.warn('⚠️ Error loading productions:', error.message);
            productions = [];
        }

        // ⭐ ÉTAPE 3: Enrichir et créer les activités
        const recentProductions = productions
            .filter(prod => prod && prod.productionStatus) // Filtrer les productions valides
            .slice(0, 10); // Limiter à 10 plus récentes

        recentProductions.forEach(prod => {
            // Récupérer le nom de la culture depuis la map
            const cropName = cropsMap[prod.cropId] || 'Unknown Crop';

            // Formatter le statut
            const status = prod.productionStatus || 'Unknown';

            // Créer l'activité
            activities.push({
                icon: 'fa-seedling',
                title: `${status} - ${cropName}`,
                date: prod.plantingDate || prod.createdAt || new Date().toISOString(),
                type: 'production',
                details: {
                    season: prod.season,
                    year: prod.year,
                    area: prod.areaPlanted
                }
            });

            console.log(`✅ Activity created: ${status} - ${cropName}`);
        });

        // ⭐ ÉTAPE 4: Trier par date (plus récent en premier)
        activities.sort((a, b) => new Date(b.date) - new Date(a.date));
        const recent = activities.slice(0, 10);

        // ⭐ ÉTAPE 5: Afficher les activités
        if (recent.length === 0) {
            displayEmptyActivities(container);
            return;
        }

        container.innerHTML = recent.map(activity => `
            <div class="activity-item">
                <div class="activity-icon">
                    <i class="fas ${activity.icon}"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-title">${activity.title}</div>
                    <div class="activity-date">${formatDateTime(activity.date)}</div>
                    ${activity.details ? `
                        <div class="activity-details">
                            <small>
                                ${activity.details.season ? `${activity.details.season} ${activity.details.year || ''}` : ''}
                                ${activity.details.area ? ` • ${activity.details.area} ha` : ''}
                            </small>
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('');

        console.log(`✅ Displayed ${recent.length} recent activities`);

    } catch (error) {
        console.error('❌ Error loading recent activities:', error);
        const container = document.getElementById('recentActivitiesList');
        if (container) displayEmptyActivities(container);
    }
}

/**
 * Display empty activities state
 */
function displayEmptyActivities(container) {
    container.innerHTML = `
        <div class="empty-state">
            <i class="fas fa-history"></i>
            <p>No recent activities</p>
        </div>
    `;
}

/**
 * Format date time pour les activités
 */
function formatDateTime(dateString) {
    if (!dateString) return 'N/A';

    try {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        // Si moins de 7 jours, afficher "il y a X jours"
        if (diffDays === 0) {
            return 'Today';
        } else if (diffDays === 1) {
            return 'Yesterday';
        } else if (diffDays < 7) {
            return `${diffDays} days ago`;
        } else if (diffDays < 30) {
            const weeks = Math.floor(diffDays / 7);
            return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
        } else {
            // Sinon, afficher la date formatée
            const options = {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            };
            return date.toLocaleDateString('en-US', options);
        }
    } catch (error) {
        console.error('Error formatting date:', error);
        return 'N/A';
    }
}






/**
 * Load critical alerts
 */
async function loadCriticalAlerts() {
    try {
        const container = document.getElementById('criticalAlertsGrid');
        if (!container) return;

        const alertsResponse = await apiRequest('/food-security-alerts/active');
        // CORRECTION: S'assurer que c'est toujours un tableau
        const allAlerts = Array.isArray(alertsResponse) ? alertsResponse : [];
        const criticalAlerts = allAlerts.filter(a =>
            ['CRITICAL', 'HIGH'].includes(a.alertLevel)
        ).slice(0, 3);

        if (criticalAlerts.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>No critical alerts at the moment</p>
                </div>
            `;
            return;
        }

        container.innerHTML = criticalAlerts.map(alert => `
            <div class="alert-card alert-${alert.alertLevel.toLowerCase()}">
                <div class="alert-header">
                    <span class="alert-badge">${alert.alertLevel}</span>
                    <span class="alert-date">${formatDate(alert.alertDate)}</span>
                </div>
                <h4 class="alert-title">${alert.alertTitle}</h4>
                <p class="alert-description">${alert.description ? alert.description.substring(0, 100) + '...' : 'No description'}</p>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading critical alerts:', error);
        const container = document.getElementById('criticalAlertsGrid');
        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading alerts</p>
                </div>
            `;
        }
    }
}
      /**
      * Load weather widget
      */
      async function loadWeatherWidget() {
      try {
      const weatherResponse = await apiRequest('/weather-data/recent?days=1');
      const weatherData = weatherResponse && weatherResponse.length > 0 ? weatherResponse[0] : null;

      if (weatherData) {
      updateElement('weatherTemp', `${weatherData.temperature || '--'}°C`);
      updateElement('weatherCondition', weatherData.weatherCondition || 'Loading...');
      updateElement('weatherHumidity', `${weatherData.humidity || '--'}%`);
      updateElement('weatherWind', `${weatherData.windSpeed || '--'} km/h`);
      updateElement('weatherRainfall', `${weatherData.rainfall || '--'} mm`);
      updateElement('weatherLocation', `
      <i class="fas fa-map-marker-alt"></i>
      ${weatherData.location || 'Location'}
      `);
      }

      } catch (error) {
      console.error('Error loading weather widget:', error);
      }
      }

      // ============================================================================
      // FARMS MODULE
      // ============================================================================



      /**
      * Display farms grid
      */
      function displayFarmsGrid(farms) {
      const container = document.getElementById('farmsGrid');
      if (!container) return;

      if (farms.length === 0) {
      container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-map-marked-alt"></i>
        <p>No farms registered yet</p>
        <button class="btn btn-primary" onclick="openAddFarmModal()">
          <i class="fas fa-plus"></i>
          Add Your First Farm
        </button>
      </div>
      `;
      return;
      }

      container.innerHTML = farms.map(farm => `
      <div class="farm-card">
        <div class="farm-header">
          <h3 class="farm-name">${farm.farmName}</h3>
          <div class="farm-actions">
            <button class="btn-icon" onclick="editFarm('${farm.id}')" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon" onclick="viewFarmDetails('${farm.id}')" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
        <div class="farm-info">
          <div class="farm-info-item">
            <i class="fas fa-map-marker-alt"></i>
            <span>${farm.location || 'N/A'}</span>
          </div>
          <div class="farm-info-item">
            <i class="fas fa-ruler-combined"></i>
            <span>${farm.sizeHectares} hectares</span>
          </div>
          <div class="farm-info-item">
            <i class="fas fa-mountain"></i>
            <span>${farm.soilType || 'N/A'}</span>
          </div>
          <div class="farm-info-item">
            <i class="fas fa-tint"></i>
            <span>${formatIrrigationSystem(farm.irrigationSystem)}</span>
          </div>
          ${farm.electricityAvailable ?
          '<div class="farm-badge"><i class="fas fa-bolt"></i> Electricity</div>' : ''
          }
        </div>
        <div class="farm-coordinates">
          <small>
            <i class="fas fa-map-pin"></i>
            ${farm.latitude}, ${farm.longitude}
          </small>
        </div>
      </div>
      `).join('');
      }

      /**
      * Format irrigation system
      */
      function formatIrrigationSystem(system) {
      const systems = {
      'RAIN_FED': 'Rain Fed',
      'SPRINKLER': 'Sprinkler',
      'DRIP': 'Drip Irrigation',
      'FLOOD': 'Flood Irrigation',
      'FURROW': 'Furrow Irrigation'
      };
      return systems[system] || system;
      }







/**
 * ============================================
 * FARM MANAGEMENT - FIXED VERSION
 * ============================================
 * Corrections apportées:
 * 1. Mapping correct des champs: sizeHectares -> farmSize
 * 2. Validation améliorée
 * 3. Gestion des erreurs optimisée
 * 4. Support complet de tous les champs du modèle backend
 */

/**
 * Open add farm modal - VERSION COMPLÈTE CORRIGÉE
 */
function openAddFarmModal() {
  const modalHTML = `
    <div class="modal-overlay show" id="farmModal" onclick="if(event.target === this) closeFarmModal()">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-map-marked-alt"></i>
            Add New Farm
          </h3>
          <button class="modal-close" onclick="closeFarmModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="addFarmForm">
            <div class="form-grid">

              <!-- Farm Name -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-tag"></i>
                  Farm Name *
                </label>
                <input
                  type="text"
                  class="form-input"
                  name="farmName"
                  placeholder="e.g., Green Valley Farm"
                  required
                  minlength="3"
                  maxlength="100"
                >
                <small class="form-hint">Between 3-100 characters</small>
              </div>

              <!-- Farm Code -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-barcode"></i>
                  Farm Code
                </label>
                <input
                  type="text"
                  class="form-input"
                  name="farmCode"
                  placeholder="Auto-generated if empty"
                  maxlength="20"
                >
                <small class="form-hint">Leave empty to auto-generate</small>
              </div>

              <!-- Size (Hectares) -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-ruler-combined"></i>
                  Size (Hectares) *
                </label>
                <input
                  type="number"
                  class="form-input"
                  name="farmSize"
                  step="0.01"
                  min="0.01"
                  max="999999.99"
                  placeholder="e.g., 5.50"
                  required
                >
                <small class="form-hint">Must be greater than 0</small>
              </div>

              <!-- Location -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-map-marker-alt"></i>
                  Location
                </label>
                <input
                  type="text"
                  class="form-input"
                  name="location"
                  placeholder="e.g., Kigali, Gasabo District"
                  maxlength="200"
                >
                <small class="form-hint">Optional: City, District, Province</small>
              </div>

              <!-- Latitude -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-globe"></i>
                  Latitude *
                </label>
                <input
                  type="number"
                  class="form-input"
                  name="latitude"
                  step="0.000001"
                  min="-90"
                  max="90"
                  placeholder="e.g., -1.9536"
                  required
                >
                <small class="form-hint">Between -90 and 90</small>
              </div>

              <!-- Longitude -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-globe-americas"></i>
                  Longitude *
                </label>
                <input
                  type="number"
                  class="form-input"
                  name="longitude"
                  step="0.000001"
                  min="-180"
                  max="180"
                  placeholder="e.g., 30.0606"
                  required
                >
                <small class="form-hint">Between -180 and 180</small>
              </div>

              <!-- Altitude (Optional) -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-mountain"></i>
                  Altitude (meters)
                </label>
                <input
                  type="number"
                  class="form-input"
                  name="altitude"
                  step="0.01"
                  min="0"
                  placeholder="e.g., 1500"
                >
                <small class="form-hint">Optional: Elevation in meters</small>
              </div>

              <!-- Soil Type -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-layer-group"></i>
                  Soil Type *
                </label>
                <select class="form-select" name="soilType" required>
                  <option value="">Select Soil Type</option>
                  <option value="Clay">🟤 Clay</option>
                  <option value="Loam">🟫 Loam</option>
                  <option value="Sand">🟡 Sand</option>
                  <option value="Silt">⚪ Silt</option>
                  <option value="Sandy Loam">🟨 Sandy Loam</option>
                  <option value="Clay Loam">🟫 Clay Loam</option>
                  <option value="Silty Clay">🟤 Silty Clay</option>
                  <option value="Sandy Clay">🟧 Sandy Clay</option>
                </select>
              </div>

              <!-- Irrigation System -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-tint"></i>
                  Irrigation System
                </label>
                <select class="form-select" name="irrigationSystem">
                  <option value="RAIN_FED">🌧️ Rain Fed (Default)</option>
                  <option value="SPRINKLER">💦 Sprinkler System</option>
                  <option value="DRIP">💧 Drip Irrigation</option>
                  <option value="FLOOD">🌊 Flood Irrigation</option>
                  <option value="MANUAL">✋ Manual Irrigation</option>
                </select>
              </div>

              <!-- Topography -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-chart-area"></i>
                  Topography
                </label>
                <select class="form-select" name="topography">
                  <option value="">Select Topography (Optional)</option>
                  <option value="Flat">⬜ Flat Terrain</option>
                  <option value="Gentle Slope">📐 Gentle Slope (0-5°)</option>
                  <option value="Moderate Slope">⛰️ Moderate Slope (5-15°)</option>
                  <option value="Steep Slope">🏔️ Steep Slope (15-30°)</option>
                  <option value="Hilly">🗻 Hilly Terrain</option>
                  <option value="Valley">⛰️ Valley</option>
                  <option value="Terraced">🏞️ Terraced Land</option>
                </select>
              </div>

              <!-- Water Source -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-water"></i>
                  Water Source
                </label>
                <input
                  type="text"
                  class="form-input"
                  name="waterSource"
                  placeholder="e.g., River, Well, Borehole"
                  maxlength="100"
                >
                <small class="form-hint">Optional: Main water source</small>
              </div>

              <!-- Road Access Quality -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-road"></i>
                  Road Access Quality
                </label>
                <select class="form-select" name="roadAccessQuality">
                  <option value="MODERATE">🚗 Moderate (Default)</option>
                  <option value="GOOD">✅ Good Access</option>
                  <option value="POOR">⚠️ Poor Access</option>
                </select>
              </div>

              <!-- Electricity Available -->
              <div class="form-group form-group-full">
                <div class="form-checkbox-container">
                  <label class="form-checkbox">
                    <input type="checkbox" name="electricityAvailable">
                    <span>
                      <i class="fas fa-bolt"></i>
                      Electricity Available on this Farm
                    </span>
                  </label>
                  <small class="form-hint">Check if the farm has electrical power access</small>
                </div>
              </div>

            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeFarmModal()">
                <i class="fas fa-times"></i>
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Save Farm
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;

  // Ajouter l'écouteur d'événement pour le formulaire
  const form = document.getElementById('addFarmForm');
  if (form) {
    form.addEventListener('submit', handleAddFarm);
  }

  // Ajouter validation en temps réel
  addFormValidation();
}

/**
 * Ajouter validation en temps réel aux champs du formulaire
 */
function addFormValidation() {
  const form = document.getElementById('addFarmForm');
  if (!form) return;

  // Validation pour la latitude
  const latitudeInput = form.querySelector('input[name="latitude"]');
  if (latitudeInput) {
    latitudeInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (isNaN(value)) {
        this.setCustomValidity('Please enter a valid number');
      } else if (value < -90 || value > 90) {
        this.setCustomValidity('Latitude must be between -90 and 90');
      } else {
        this.setCustomValidity('');
      }
    });
  }

  // Validation pour la longitude
  const longitudeInput = form.querySelector('input[name="longitude"]');
  if (longitudeInput) {
    longitudeInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (isNaN(value)) {
        this.setCustomValidity('Please enter a valid number');
      } else if (value < -180 || value > 180) {
        this.setCustomValidity('Longitude must be between -180 and 180');
      } else {
        this.setCustomValidity('');
      }
    });
  }

  // Validation pour la taille (farmSize)
  const sizeInput = form.querySelector('input[name="farmSize"]');
  if (sizeInput) {
    sizeInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (isNaN(value)) {
        this.setCustomValidity('Please enter a valid number');
      } else if (value <= 0) {
        this.setCustomValidity('Farm size must be greater than 0');
      } else if (value > 999999.99) {
        this.setCustomValidity('Farm size is too large');
      } else {
        this.setCustomValidity('');
      }
    });
  }

  // Validation pour l'altitude
  const altitudeInput = form.querySelector('input[name="altitude"]');
  if (altitudeInput) {
    altitudeInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (this.value && (isNaN(value) || value < 0)) {
        this.setCustomValidity('Altitude must be a positive number');
      } else {
        this.setCustomValidity('');
      }
    });
  }

  // Auto-génération du Farm Code
  const farmNameInput = form.querySelector('input[name="farmName"]');
  const farmCodeInput = form.querySelector('input[name="farmCode"]');

  if (farmNameInput && farmCodeInput) {
    farmNameInput.addEventListener('blur', function() {
      if (!farmCodeInput.value) {
        const name = this.value.trim();
        if (name) {
          const year = new Date().getFullYear();
          const prefix = name.substring(0, 3).toUpperCase().replace(/[^A-Z]/g, 'X');
          const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
          const code = `FARM-${year}-${prefix}${random}`;
          farmCodeInput.value = code;
        }
      }
    });
  }
}

/**
 * Handle add farm - VERSION CORRIGÉE
 * FIX: Mapping correct des champs selon le modèle backend
 */
async function handleAddFarm(e) {
  e.preventDefault();

  const formData = new FormData(e.target);

  // CORRECTION PRINCIPALE: Utiliser les bons noms de champs
  const farmData = {
    farmerId: currentUser.id,
    farmName: formData.get('farmName').trim(),
    farmCode: formData.get('farmCode')?.trim() || null,
    farmSize: parseFloat(formData.get('farmSize')), // CORRIGÉ: était "sizeHectares"
    soilType: formData.get('soilType'),
    latitude: parseFloat(formData.get('latitude')),
    longitude: parseFloat(formData.get('longitude')),
    altitude: formData.get('altitude') ? parseFloat(formData.get('altitude')) : null,
    irrigationSystem: formData.get('irrigationSystem') || 'RAIN_FED',
    topography: formData.get('topography') || null,
    waterSource: formData.get('waterSource')?.trim() || null,
    electricityAvailable: formData.get('electricityAvailable') === 'on',
    roadAccessQuality: formData.get('roadAccessQuality') || 'MODERATE'
  };

  // Validation côté client
  const validationErrors = validateFarmData(farmData);
  if (validationErrors.length > 0) {
    showToast('❌ Validation errors: ' + validationErrors.join(', '), 'error');
    return;
  }

  try {
    showLoading();

    console.log('📤 Sending farm data:', farmData);

    const response = await apiRequest('/farms', {
      method: 'POST',
      body: JSON.stringify(farmData)
    });

    console.log('✅ Farm created:', response);
    showToast('✅ Farm added successfully!', 'success');
    closeFarmModal();

    // Recharger les données
    await loadFarmsData();

  } catch (error) {
    console.error('❌ Error adding farm:', error);

    // Gestion d'erreur améliorée
    let errorMessage = 'Error adding farm';

    if (error.message.includes('Farm size is required')) {
      errorMessage = 'Farm size is required and must be greater than 0';
    } else if (error.message.includes('validation')) {
      errorMessage = 'Validation error: Please check all required fields';
    } else if (error.message.includes('duplicate')) {
      errorMessage = 'Farm code already exists. Please use a different code';
    } else {
      errorMessage = error.message;
    }

    showToast('❌ ' + errorMessage, 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Valider les données du formulaire
 */
function validateFarmData(data) {
  const errors = [];

  // Validations obligatoires
  if (!data.farmName || data.farmName.length < 3) {
    errors.push('Farm name must be at least 3 characters');
  }
  if (!data.farmSize || data.farmSize <= 0) {
    errors.push('Farm size must be greater than 0');
  }
  if (!data.soilType) {
    errors.push('Soil type is required');
  }
  if (!data.latitude || data.latitude < -90 || data.latitude > 90) {
    errors.push('Valid latitude is required (-90 to 90)');
  }
  if (!data.longitude || data.longitude < -180 || data.longitude > 180) {
    errors.push('Valid longitude is required (-180 to 180)');
  }

  // Validations optionnelles
  if (data.altitude !== null && data.altitude < 0) {
    errors.push('Altitude must be positive');
  }
  if (data.farmCode && data.farmCode.length > 20) {
    errors.push('Farm code must not exceed 20 characters');
  }

  return errors;
}





/**
 * ============================================
 * FIX COMPLET: openEditFarmModal
 * ============================================
 */
async function openEditFarmModal(farmId) {
  try {
    showLoading();
    console.log('📝 Opening edit modal for farm ID:', farmId);

    // ✅ RÉCUPÉRATION DES DONNÉES DE LA FARM
    const farm = await apiRequest(`/farms/${farmId}`, {
      method: 'GET'
    });

    console.log('✅ Farm data loaded:', farm);

    // ✅ Helper function pour valeurs sûres
    const safeValue = (value, defaultValue = '') => {
      return (value !== null && value !== undefined) ? value : defaultValue;
    };

    // ✅ CRÉATION DU HTML DU MODAL
    const modalHTML = `
      <div class="modal-overlay show" id="farmModal" style="display: flex !important;">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fas fa-edit"></i>
              Edit Farm: ${escapeHtml(farm.farmName)}
            </h3>
            <button class="modal-close" onclick="closeFarmModal()" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <form id="editFarmForm" data-farm-id="${farm.id}">
              <div class="form-grid">

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-tag"></i>
                    Farm Name *
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="farmName"
                    value="${escapeHtml(safeValue(farm.farmName))}"
                    required
                    minlength="3"
                    maxlength="100"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-barcode"></i>
                    Farm Code
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="farmCode"
                    value="${escapeHtml(safeValue(farm.farmCode))}"
                    maxlength="20"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-ruler-combined"></i>
                    Size (Hectares) *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="farmSize"
                    value="${safeValue(farm.farmSize || farm.sizeHectares, 0)}"
                    step="0.01"
                    min="0.01"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-map-marker-alt"></i>
                    Location
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="location"
                    value="${escapeHtml(safeValue(farm.location))}"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-globe"></i>
                    Latitude *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="latitude"
                    value="${safeValue(farm.latitude, 0)}"
                    step="0.000001"
                    min="-90"
                    max="90"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-globe-americas"></i>
                    Longitude *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="longitude"
                    value="${safeValue(farm.longitude, 0)}"
                    step="0.000001"
                    min="-180"
                    max="180"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-mountain"></i>
                    Altitude (meters)
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="altitude"
                    value="${safeValue(farm.altitude, '')}"
                    step="0.01"
                    min="0"
                    placeholder="Optional"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-layer-group"></i>
                    Soil Type *
                  </label>
                  <select class="form-select" name="soilType" required>
                    <option value="">Select Soil Type</option>
                    <option value="Clay" ${farm.soilType === 'Clay' ? 'selected' : ''}>🟤 Clay</option>
                    <option value="Loam" ${farm.soilType === 'Loam' ? 'selected' : ''}>🟫 Loam</option>
                    <option value="Sand" ${farm.soilType === 'Sand' ? 'selected' : ''}>🟡 Sand</option>
                    <option value="Silt" ${farm.soilType === 'Silt' ? 'selected' : ''}>⚪ Silt</option>
                    <option value="Sandy Loam" ${farm.soilType === 'Sandy Loam' ? 'selected' : ''}>🟨 Sandy Loam</option>
                    <option value="Clay Loam" ${farm.soilType === 'Clay Loam' ? 'selected' : ''}>🟫 Clay Loam</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-tint"></i>
                    Irrigation System
                  </label>
                  <select class="form-select" name="irrigationSystem">
                    <option value="RAIN_FED" ${farm.irrigationSystem === 'RAIN_FED' ? 'selected' : ''}>🌧️ Rain Fed</option>
                    <option value="SPRINKLER" ${farm.irrigationSystem === 'SPRINKLER' ? 'selected' : ''}>💦 Sprinkler</option>
                    <option value="DRIP" ${farm.irrigationSystem === 'DRIP' ? 'selected' : ''}>💧 Drip</option>
                    <option value="FLOOD" ${farm.irrigationSystem === 'FLOOD' ? 'selected' : ''}>🌊 Flood</option>
                    <option value="MANUAL" ${farm.irrigationSystem === 'MANUAL' ? 'selected' : ''}>✋ Manual</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-chart-area"></i>
                    Topography
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="topography"
                    value="${escapeHtml(safeValue(farm.topography))}"
                    maxlength="50"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-water"></i>
                    Water Source
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="waterSource"
                    value="${escapeHtml(safeValue(farm.waterSource))}"
                    maxlength="100"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-road"></i>
                    Road Access Quality
                  </label>
                  <select class="form-select" name="roadAccessQuality">
                    <option value="GOOD" ${farm.roadAccessQuality === 'GOOD' ? 'selected' : ''}>✅ Good</option>
                    <option value="MODERATE" ${(!farm.roadAccessQuality || farm.roadAccessQuality === 'MODERATE') ? 'selected' : ''}>🚗 Moderate</option>
                    <option value="POOR" ${farm.roadAccessQuality === 'POOR' ? 'selected' : ''}>⚠️ Poor</option>
                  </select>
                </div>

                <div class="form-group form-group-full">
                  <div class="form-checkbox-container">
                    <label class="form-checkbox">
                      <input type="checkbox" name="electricityAvailable" ${farm.electricityAvailable ? 'checked' : ''}>
                      <span>
                        <i class="fas fa-bolt"></i>
                        Electricity Available
                      </span>
                    </label>
                  </div>
                </div>

              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeFarmModal()">
                  <i class="fas fa-times"></i>
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  Update Farm
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `;

    // ✅ INJECTION DANS LE DOM
    const modalContainer = document.getElementById('modalContainer');
    if (!modalContainer) {
      console.error('❌ modalContainer not found in DOM!');
      showToast('❌ Modal container not found', 'error');
      return;
    }

    modalContainer.innerHTML = modalHTML;

    // ✅ FORCER L'AFFICHAGE
    setTimeout(() => {
      const modal = document.getElementById('farmModal');
      if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('show');
        console.log('✅ Modal displayed');
      } else {
        console.error('❌ Modal element not found after injection');
      }
    }, 50);

    // ✅ ATTACHER L'EVENT LISTENER
    const form = document.getElementById('editFarmForm');
    if (form) {
      form.removeEventListener('submit', handleEditFarmSubmit);
      form.addEventListener('submit', handleEditFarmSubmit);
      console.log('✅ Form listener attached');
    } else {
      console.error('❌ Form not found!');
    }

    console.log('✅ Edit modal setup complete');

  } catch (error) {
    console.error('❌ Error in openEditFarmModal:', error);
    showToast('❌ Error loading farm: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}








/**
 * Delete farm with confirmation
 */
async function deleteFarm(farmId, farmName) {
  if (!confirm(`Are you sure you want to delete "${farmName}"?\n\nThis action cannot be undone.`)) {
    return;
  }

  try {
    showLoading();

    await apiRequest(`/farms/${farmId}`, {
      method: 'DELETE'
    });

    showToast('✅ Farm deleted successfully!', 'success');
    await loadFarmsData();

  } catch (error) {
    console.error('Error deleting farm:', error);
    showToast('❌ Error deleting farm: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Close farm modal
 */
function closeFarmModal() {
  const modal = document.getElementById('farmModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}





/**
 * ============================================
 * FARMS DISPLAY - COMPLETE FIXED VERSION
 * ============================================
 * Corrections:
 * 1. Added missing displayEmptyFarmsState function
 * 2. Fixed loadFarmsData to properly handle responses
 * 3. Added proper error handling
 * 4. Fixed navigation integration
 */





/**
 * ============================================
 * FARMS DISPLAY - COMPLETE FIXED VERSION
 * ============================================
 * Corrections:
 * 1. Added missing displayEmptyFarmsState function
 * 2. Fixed loadFarmsData to properly handle responses
 * 3. Added proper error handling
 * 4. Fixed navigation integration
 */








/**
 * ============================================
 * FARMS DISPLAY - COMPLETE FIXED VERSION
 * ============================================
 * Corrections:
 * 1. Added missing displayEmptyFarmsState function
 * 2. Fixed loadFarmsData to properly handle responses
 * 3. Added proper error handling
 * 4. Fixed navigation integration
 */

/**
 * Load farms data - FIXED VERSION
 */
async function loadFarmsData() {
  try {
    showLoading();

    // ✅ VALIDATION USER
    if (!currentUser || !currentUser.id) {
      console.error('❌ No current user found');
      displayEmptyFarmsState();
      return;
    }

    console.log('🔄 Loading farms for farmer:', currentUser.id);

    // ✅ RÉCUPÉRATION DES FARMS
    let farms = [];
    try {
      const response = await apiRequest(`/farms/farmer/${currentUser.id}/all`, {
        method: 'GET'
      });

      // Gestion multi-format de la réponse
      if (Array.isArray(response)) {
        farms = response;
      } else if (response && response.data && Array.isArray(response.data)) {
        farms = response.data;
      } else if (response && response.content && Array.isArray(response.content)) {
        farms = response.content;
      } else {
        console.warn('⚠️ Unexpected farms response format:', response);
        farms = [];
      }

      console.log(`✅ Farms loaded successfully: ${farms.length} farms`);

    } catch (error) {
      console.error('❌ Error loading farms:', error);
      farms = [];
    }

    // ✅ AFFICHAGE
    if (farms.length === 0) {
      displayEmptyFarmsState();
    } else {
      displayFarms(farms);
      updateFarmStatistics(farms);
    }

  } catch (error) {
    console.error('💥 Critical error in loadFarmsData:', error);
    showToast('❌ Unable to load farms', 'error');
    displayEmptyFarmsState();
  } finally {
    hideLoading();
  }
}

/**
 * Display empty state when no farms exist - NEW FUNCTION
 */
function displayEmptyFarmsState() {
  const container = document.getElementById('farmsGrid');
  const statsContainer = document.querySelector('.stats-mini-grid');

  if (container) {
    container.innerHTML = `
      <div class="empty-state" style="text-align: center; padding: 60px 20px;">
        <div class="empty-icon" style="font-size: 80px; color: #4CAF50; margin-bottom: 20px;">
          <i class="fas fa-tractor"></i>
        </div>
        <h3 style="font-size: 24px; font-weight: 600; color: #333; margin-bottom: 10px;">
          No Farms Yet
        </h3>
        <p style="font-size: 16px; color: #666; margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto;">
          Start by adding your first farm to begin managing your agricultural operations.
        </p>
        <button class="btn btn-primary" onclick="openAddFarmModal()" style="padding: 12px 30px; font-size: 16px;">
          <i class="fas fa-plus"></i>
          Add Your First Farm
        </button>
      </div>
    `;
  }

  if (statsContainer) {
    // Update stats using existing IDs
    updateElement('farmsTotalCount', '0');
    updateElement('farmsTotalArea', '0 ha');
    updateElement('farmsIrrigated', '0');
    updateElement('farmsActive', '0');
  }
}





/**
 * ============================================
 * DEBUG & FIX: Edit Farm Button Click
 * ============================================
 */

/**
 * Version corrigée de displayFarms avec debugging
 */
function displayFarms(farms) {
  const container = document.getElementById('farmsGrid');
  if (!container) {
    console.error('❌ farmsGrid element not found');
    return;
  }

  if (!farms || farms.length === 0) {
    displayEmptyFarmsState();
    return;
  }

  const farmsHTML = farms.map(farm => `
    <div class="farm-card" data-farm-id="${farm.id}">
      <div class="farm-card-header">
        <div class="farm-icon">🚜</div>
        <h3 class="farm-name">${escapeHtml(farm.farmName)}</h3>
        ${farm.farmCode ? `<span class="farm-code-badge">${escapeHtml(farm.farmCode)}</span>` : ''}
      </div>
      <div class="farm-card-body">
        <div class="farm-info-list">
          <div class="farm-info-item">
            <span class="farm-info-label">Size</span>
            <span class="farm-info-value">${farm.farmSize} ha</span>
          </div>
          <div class="farm-info-item">
            <span class="farm-info-label">Soil Type</span>
            <span class="farm-info-value">${escapeHtml(farm.soilType || 'N/A')}</span>
          </div>
          <div class="farm-info-item">
            <span class="farm-info-label">Irrigation</span>
            <span class="farm-info-value">${formatIrrigationSystem(farm.irrigationSystem)}</span>
          </div>
          <div class="farm-info-item">
            <span class="farm-info-label">Coordinates</span>
            <span class="farm-info-value">${farm.latitude ? farm.latitude.toFixed(4) : 'N/A'}, ${farm.longitude ? farm.longitude.toFixed(4) : 'N/A'}</span>
          </div>
          <div class="farm-info-item">
            <span class="farm-info-label">Electricity</span>
            <span class="farm-info-value">${farm.electricityAvailable ? 'Available' : 'Not Available'}</span>
          </div>
          <div class="farm-info-item">
            <span class="farm-info-label">Farm Size</span>
            <span class="farm-info-value">${getSizeCategory(farm.farmSize)}</span>
          </div>
          <div class="farm-info-item">
            <span class="farm-info-label">Created</span>
            <span class="farm-info-value">${formatDate(farm.createdAt)}</span>
          </div>
        </div>
        <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
          <button class="btn" onclick="editFarm('${farm.id}')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)';">
            <i class="fas fa-edit"></i>
            Edit
          </button>
          <button class="btn" onclick="deleteFarm('${farm.id}', '${farm.farmName.replace(/'/g, "\\'")}')" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(239, 68, 68, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)';">
            <i class="fas fa-trash"></i>
            Delete
          </button>
        </div>
      </div>
    </div>
  `).join('');

  container.innerHTML = farmsHTML;

  console.log('✅ Farms displayed:', farms.length);
}








/**
 * Update farm statistics - ENHANCED VERSION
 */
function updateFarmStatistics(farms) {
  const totalFarms = farms.length;
  const totalArea = farms.reduce((sum, farm) => sum + parseFloat(farm.farmSize), 0);

  // Count irrigated farms (not RAIN_FED)
  const irrigatedFarms = farms.filter(f =>
    f.irrigationSystem && f.irrigationSystem !== 'RAIN_FED'
  ).length;

  // All farms are considered active by default
  const activeFarms = totalFarms;

  // Update the mini stats cards
  updateElement('farmsTotalCount', totalFarms);
  updateElement('farmsTotalArea', `${totalArea.toFixed(2)} ha`);
  updateElement('farmsIrrigated', irrigatedFarms);
  updateElement('farmsActive', activeFarms);

  console.log('📊 Farm Stats Updated:', {
    total: totalFarms,
    area: totalArea.toFixed(2),
    irrigated: irrigatedFarms,
    active: activeFarms
  });
}

/**
 * Initialize navigation for farms section
 */
function initializeFarmsNavigation() {
  // Initialize action buttons for farms only
  document.querySelectorAll('[data-action="add-farm"]').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      openAddFarmModal();
    });
  });

  document.querySelectorAll('[data-action="refresh-farms"]').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      loadFarmsData();
    });
  });

  document.querySelectorAll('[data-action="export-farms"]').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      // Get current farms from the grid
      const farmCards = document.querySelectorAll('.farm-card');
      if (farmCards.length > 0) {
        showToast('✅ Export functionality coming soon', 'info');
      } else {
        showToast('⚠️ No farms to export', 'warning');
      }
    });
  });
}

/**
 * Initialize main navigation for all sections
 */
function initializeMainNavigation() {
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();

      const section = this.getAttribute('data-section');

      // Hide all sections
      document.querySelectorAll('.content-section').forEach(contentSection => {
        contentSection.classList.remove('active');
        contentSection.style.display = 'none';
      });

      // Update active nav item
      document.querySelectorAll('.nav-link').forEach(navLink => {
        navLink.parentElement.classList.remove('active');
      });
      this.parentElement.classList.add('active');

      // Show selected section
      const targetSection = document.getElementById(`${section}Section`);
      if (targetSection) {
        targetSection.classList.add('active');
        targetSection.style.display = 'block';

        // Load data only for the specific section
        switch(section) {
          case 'farms':
            loadFarmsData();
            break;
          case 'dashboard':
            loadDashboardData();
            break;
          case 'crops':
            loadCropsData();
            break;
          case 'production':
            loadProductionData();
            break;
          case 'inventory':
            loadInventoryData();
            break;
          case 'fertilizer':
            loadFertilizerData();
            break;
          case 'irrigation':
            loadIrrigationData();
            break;
          case 'soil':
            loadSoilData();
            break;
          case 'market-prices':
            loadMarketPricesData();
            break;
          case 'transactions':
            loadTransactionsData();
            break;
          case 'supply-chain':
            loadSupplyChainData();
            break;
          case 'weather':
            loadWeatherData();
            break;
          case 'alerts':
            loadAlertsData();
            break;
          case 'policies':
            loadPoliciesData();
            break;
          case 'recommendations':
            loadRecommendationsData();
            break;
          case 'predictions':
            loadPredictionsData();
            break;
          case 'reports':
            // Reports section doesn't need auto-load
            break;
        }
      }
    });
  });
}

/**
 * Helper function to update element content safely
 */
function updateElement(elementId, content) {
  const element = document.getElementById(elementId);
  if (element) {
    element.textContent = content;
  } else {
    console.warn(`⚠️ Element ${elementId} not found`);
  }
}



// ============ INITIALISATION AU CHARGEMENT ============
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Page loaded - Initializing Market Prices...');

    // Vérifier que la section existe
    const section = document.getElementById('marketPricesSection');
    if (section) {
        console.log('✅ Market Prices section found');
        // S'assurer qu'elle est visible
        section.style.display = 'block';
    } else {
        console.error('❌ Market Prices section NOT found');
    }

    // Initialiser Market Prices
    if (typeof initMarketPrices === 'function') {
        initMarketPrices();
    } else {
        console.error('❌ initMarketPrices function not found');
    }
});


/**
 * Initialize when DOM is ready
 */
document.addEventListener('DOMContentLoaded', function() {
  console.log('✅ Initializing Farms Module');

  // Initialize main navigation for all sections
  initializeMainNavigation();

  // Initialize farms-specific action buttons
  initializeFarmsNavigation();

  // Initialize WhatsApp Chat link
  if (typeof initWhatsAppChat === 'function') {
    initWhatsAppChat();
  }

  // Only load dashboard on initial page load
  const dashboardSection = document.getElementById('dashboardSection');
  if (dashboardSection && dashboardSection.classList.contains('active')) {
    loadDashboardData();
  }
});





/**
 * Helper: Format irrigation system
 */
function formatIrrigationSystem(system) {
  const systems = {
    'RAIN_FED': '🌧️ Rain Fed',
    'SPRINKLER': '💦 Sprinkler',
    'DRIP': '💧 Drip',
    'FLOOD': '🌊 Flood',
    'MANUAL': '✋ Manual'
  };
  return systems[system] || system;
}

/**
 * Helper: Format irrigation system for reports (NO EMOJI - clean text only)
 */
function formatIrrigationForReport(irrigation) {
  if (!irrigation) return '';
  const irrigationMap = {
    'RAIN_FED': 'Rain Fed',
    'SPRINKLER': 'Sprinkler',
    'SPRINKLE': 'Sprinkler',
    'DRIP': 'Drip',
    'FLOOD': 'Flood',
    'FURROW': 'Furrow',
    'CENTER_PIVOT': 'Center Pivot',
    'MANUAL': 'Manual'
  };
  return irrigationMap[irrigation] || irrigation;
}

/**
 * Helper: Format road access
 */
function formatRoadAccess(quality) {
  const qualities = {
    'GOOD': '✅ Good',
    'MODERATE': '🚗 Moderate',
    'POOR': '⚠️ Poor'
  };
  return qualities[quality] || quality;
}

/**
 * Helper: Get size category
 */
function getSizeCategory(size) {
  const sizeNum = parseFloat(size);
  if (sizeNum <= 2) return 'Small Farm';
  if (sizeNum <= 10) return 'Medium Farm';
  return 'Large Farm';
}

/**
 * Helper: Format date
 */
function formatDate(dateString) {
  if (!dateString) return 'N/A';

  const date = new Date(dateString);
  const options = {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };

  return date.toLocaleDateString('en-US', options);
}

/**
 * View farm details
 */
async function viewFarmDetails(farmId) {
  try {
    showLoading();

    const farm = await apiRequest(`/farms/${farmId}`, { method: 'GET' });

    const modalHTML = `
      <div class="modal-overlay show" id="farmDetailsModal" onclick="if(event.target === this) closeDetailsModal()">
        <div class="modal-container modal-large">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fas fa-info-circle"></i>
              Farm Details: ${farm.farmName}
            </h3>
            <button class="modal-close" onclick="closeDetailsModal()" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="details-grid">
              <div class="details-section">
                <h4><i class="fas fa-info"></i> Basic Information</h4>
                <dl class="details-list">
                  <dt>Farm Name:</dt>
                  <dd>${farm.farmName}</dd>

                  <dt>Farm Code:</dt>
                  <dd>${farm.farmCode || 'N/A'}</dd>

                  <dt>Size:</dt>
                  <dd>${farm.farmSize} hectares (${getSizeCategory(farm.farmSize)})</dd>

                  <dt>Soil Type:</dt>
                  <dd>${farm.soilType}</dd>
                </dl>
              </div>

              <div class="details-section">
                <h4><i class="fas fa-map-marker-alt"></i> Location</h4>
                <dl class="details-list">
                  <dt>Latitude:</dt>
                  <dd>${farm.latitude}°</dd>

                  <dt>Longitude:</dt>
                  <dd>${farm.longitude}°</dd>

                  ${farm.altitude ? `
                  <dt>Altitude:</dt>
                  <dd>${farm.altitude} meters</dd>
                  ` : ''}

                  ${farm.topography ? `
                  <dt>Topography:</dt>
                  <dd>${farm.topography}</dd>
                  ` : ''}
                </dl>
              </div>

              <div class="details-section">
                <h4><i class="fas fa-tools"></i> Infrastructure</h4>
                <dl class="details-list">
                  <dt>Irrigation System:</dt>
                  <dd>${formatIrrigationSystem(farm.irrigationSystem)}</dd>

                  ${farm.waterSource ? `
                  <dt>Water Source:</dt>
                  <dd>${farm.waterSource}</dd>
                  ` : ''}

                  <dt>Electricity:</dt>
                  <dd>
                    <span class="badge ${farm.electricityAvailable ? 'badge-success' : 'badge-secondary'}">
                      ${farm.electricityAvailable ? '✅ Available' : '❌ Not Available'}
                    </span>
                  </dd>

                  <dt>Road Access:</dt>
                  <dd>${formatRoadAccess(farm.roadAccessQuality)}</dd>
                </dl>
              </div>

              <div class="details-section">
                <h4><i class="fas fa-clock"></i> Timestamps</h4>
                <dl class="details-list">
                  <dt>Created:</dt>
                  <dd>${formatDate(farm.createdAt)}</dd>

                  <dt>Last Updated:</dt>
                  <dd>${formatDate(farm.updatedAt)}</dd>
                </dl>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDetailsModal()">
              <i class="fas fa-times"></i>
              Close
            </button>
            <button type="button" class="btn btn-primary" onclick="closeDetailsModal(); openEditFarmModal('${farm.id}')">
              <i class="fas fa-edit"></i>
              Edit Farm
            </button>
          </div>
        </div>
      </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;

  } catch (error) {
    console.error('Error loading farm details:', error);
    showToast('❌ Error loading farm details', 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Close details modal
 */
function closeDetailsModal() {
  const modal = document.getElementById('farmDetailsModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}

/**
 * Export farms to CSV
 */
function exportFarmsToCSV(farms) {
  if (!farms || farms.length === 0) {
    showToast('⚠️ No farms to export', 'warning');
    return;
  }

  const headers = [
    'Farm Name', 'Farm Code', 'Size (ha)', 'Soil Type',
    'Latitude', 'Longitude', 'Altitude (m)', 'Irrigation System',
    'Topography', 'Water Source', 'Electricity', 'Road Access',
    'Created At', 'Updated At'
  ];

  const rows = farms.map(farm => [
    farm.farmName,
    farm.farmCode || '',
    farm.farmSize,
    farm.soilType,
    farm.latitude,
    farm.longitude,
    farm.altitude || '',
    farm.irrigationSystem,
    farm.topography || '',
    farm.waterSource || '',
    farm.electricityAvailable ? 'Yes' : 'No',
    farm.roadAccessQuality,
    farm.createdAt,
    farm.updatedAt
  ]);

  let csvContent = headers.join(',') + '\n';
  rows.forEach(row => {
    csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
  });

  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `farms_export_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);

  showToast('✅ Farms exported successfully!', 'success');
}

/**
 * Initialize farms module on page load
 */
document.addEventListener('DOMContentLoaded', function() {
  if (window.location.pathname.includes('farmer') || window.location.pathname.includes('farms')) {
    loadFarmsData();
  }
});






/**
 * Helper pour obtenir les noms depuis les relations
 */
async function enrichTransactionsWithNames(transactions) {
  for (let tx of transactions) {
    try {
      // Récupérer le nom du buyer
      if (tx.buyerId && !tx.buyerName) {
        try {
          const buyer = await apiRequest(`/users/${tx.buyerId}`);
          tx.buyerName = buyer.fullName || buyer.username || 'Unknown Buyer';
        } catch (err) {
          tx.buyerName = 'Unknown Buyer';
        }
      }

      // Récupérer le nom du crop
      if (tx.cropId && !tx.cropName) {
        try {
          const crop = await apiRequest(`/v1/crops/${tx.cropId}`);
          tx.cropName = crop.cropName || 'Unknown Crop';
        } catch (err) {
          tx.cropName = 'Unknown Crop';
        }
      }
    } catch (error) {
      console.warn(`Error enriching transaction ${tx.id}:`, error);
    }
  }
  return transactions;
}


/**
 * ✅ CORRECTION COMPLÈTE: Fonction editFarm avec debugging
 */
async function editFarm(farmId) {
    console.log('╔════════════════════════════════════════╗');
    console.log('║  🔄 EDIT FARM CALLED                   ║');
    console.log('╚════════════════════════════════════════╝');
    console.log('📋 Farm ID:', farmId);
    console.log('📋 Farm ID Type:', typeof farmId);

    if (!farmId) {
        console.error('❌ No farm ID provided!');
        showToast('❌ Farm ID is missing', 'error');
        return;
    }

    try {
        showLoading();
        console.log('⏳ Loading started...');

        // ✅ RÉCUPÉRATION DES DONNÉES
        console.log('📡 Fetching farm data from API...');
        console.log('🔗 URL:', `/farms/${farmId}`);

        const farm = await apiRequest(`/farms/${farmId}`, {
            method: 'GET'
        });

        console.log('✅ Farm data received:', farm);

        if (!farm) {
            throw new Error('Farm data is null or undefined');
        }

        // ✅ Helper function
        const safeValue = (value, defaultValue = '') => {
            const result = (value !== null && value !== undefined) ? value : defaultValue;
            console.log(`🔒 SafeValue: ${value} → ${result}`);
            return result;
        };

        console.log('🎨 Creating modal HTML...');

        // ✅ CRÉATION DU HTML
        const modalHTML = `
            <div class="modal-overlay" id="farmModal" style="display: flex !important; opacity: 1 !important; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 9999;">
                <div class="modal-container" style="background: white; border-radius: 8px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                        <h3 class="modal-title" style="margin: 0; font-size: 20px; font-weight: 600;">
                            <i class="fas fa-edit"></i>
                            Edit Farm: ${escapeHtml(farm.farmName)}
                        </h3>
                        <button class="modal-close" onclick="closeFarmModal()" type="button" style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <form id="editFarmForm" data-farm-id="${farm.id}">
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-tag"></i> Farm Name *
                                    </label>
                                    <input type="text" class="form-input" name="farmName"
                                           value="${escapeHtml(safeValue(farm.farmName))}"
                                           required minlength="3" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-barcode"></i> Farm Code
                                    </label>
                                    <input type="text" class="form-input" name="farmCode"
                                           value="${escapeHtml(safeValue(farm.farmCode))}"
                                           maxlength="20"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-ruler-combined"></i> Size (Hectares) *
                                    </label>
                                    <input type="number" class="form-input" name="farmSize"
                                           value="${safeValue(farm.farmSize || farm.sizeHectares, 0)}"
                                           step="0.01" min="0.01" required
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-map-marker-alt"></i> Location
                                    </label>
                                    <input type="text" class="form-input" name="location"
                                           value="${escapeHtml(safeValue(farm.location))}"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-globe"></i> Latitude *
                                    </label>
                                    <input type="number" class="form-input" name="latitude"
                                           value="${safeValue(farm.latitude, 0)}"
                                           step="0.000001" min="-90" max="90" required
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-globe-americas"></i> Longitude *
                                    </label>
                                    <input type="number" class="form-input" name="longitude"
                                           value="${safeValue(farm.longitude, 0)}"
                                           step="0.000001" min="-180" max="180" required
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-mountain"></i> Altitude (m)
                                    </label>
                                    <input type="number" class="form-input" name="altitude"
                                           value="${safeValue(farm.altitude, '')}"
                                           step="0.01" min="0" placeholder="Optional"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-layer-group"></i> Soil Type *
                                    </label>
                                    <select class="form-select" name="soilType" required
                                            style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <option value="">Select Soil Type</option>
                                        <option value="Clay" ${farm.soilType === 'Clay' ? 'selected' : ''}>Clay</option>
                                        <option value="Loam" ${farm.soilType === 'Loam' ? 'selected' : ''}>Loam</option>
                                        <option value="Sand" ${farm.soilType === 'Sand' ? 'selected' : ''}>Sand</option>
                                        <option value="Silt" ${farm.soilType === 'Silt' ? 'selected' : ''}>Silt</option>
                                        <option value="Sandy Loam" ${farm.soilType === 'Sandy Loam' ? 'selected' : ''}>Sandy Loam</option>
                                        <option value="Clay Loam" ${farm.soilType === 'Clay Loam' ? 'selected' : ''}>Clay Loam</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-tint"></i> Irrigation System
                                    </label>
                                    <select class="form-select" name="irrigationSystem"
                                            style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <option value="RAIN_FED" ${farm.irrigationSystem === 'RAIN_FED' ? 'selected' : ''}>Rain Fed</option>
                                        <option value="SPRINKLER" ${farm.irrigationSystem === 'SPRINKLER' ? 'selected' : ''}>Sprinkler</option>
                                        <option value="DRIP" ${farm.irrigationSystem === 'DRIP' ? 'selected' : ''}>Drip</option>
                                        <option value="FLOOD" ${farm.irrigationSystem === 'FLOOD' ? 'selected' : ''}>Flood</option>
                                        <option value="MANUAL" ${farm.irrigationSystem === 'MANUAL' ? 'selected' : ''}>Manual</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-chart-area"></i> Topography
                                    </label>
                                    <input type="text" class="form-input" name="topography"
                                           value="${escapeHtml(safeValue(farm.topography))}"
                                           maxlength="50"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-water"></i> Water Source
                                    </label>
                                    <input type="text" class="form-input" name="waterSource"
                                           value="${escapeHtml(safeValue(farm.waterSource))}"
                                           maxlength="100"
                                           style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                        <i class="fas fa-road"></i> Road Access Quality
                                    </label>
                                    <select class="form-select" name="roadAccessQuality"
                                            style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px;">
                                        <option value="GOOD" ${farm.roadAccessQuality === 'GOOD' ? 'selected' : ''}>Good</option>
                                        <option value="MODERATE" ${(!farm.roadAccessQuality || farm.roadAccessQuality === 'MODERATE') ? 'selected' : ''}>Moderate</option>
                                        <option value="POOR" ${farm.roadAccessQuality === 'POOR' ? 'selected' : ''}>Poor</option>
                                    </select>
                                </div>

                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-checkbox" style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" name="electricityAvailable" ${farm.electricityAvailable ? 'checked' : ''}>
                                        <span><i class="fas fa-bolt"></i> Electricity Available</span>
                                    </label>
                                </div>

                            </div>

                            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                <button type="button" class="btn btn-secondary" onclick="closeFarmModal()"
                                        style="padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="submit" class="btn btn-primary"
                                        style="padding: 10px 20px; border: none; border-radius: 6px; background: #10b981; color: white; cursor: pointer;">
                                    <i class="fas fa-save"></i> Update Farm
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        // ✅ INJECTION
        const modalContainer = document.getElementById('modalContainer');
        if (!modalContainer) {
            throw new Error('Modal container not found in DOM!');
        }

        console.log('💉 Injecting modal HTML...');
        modalContainer.innerHTML = modalHTML;

        // ✅ VÉRIFICATION
        const modal = document.getElementById('farmModal');
        if (!modal) {
            throw new Error('Modal element not found after injection!');
        }

        console.log('✅ Modal element found:', modal);
        console.log('📏 Modal dimensions:', {
            width: modal.offsetWidth,
            height: modal.offsetHeight,
            display: window.getComputedStyle(modal).display,
            opacity: window.getComputedStyle(modal).opacity,
            zIndex: window.getComputedStyle(modal).zIndex
        });

        // ✅ EVENT LISTENER
        const form = document.getElementById('editFarmForm');
        if (!form) {
            throw new Error('Form not found after injection!');
        }

        console.log('✅ Form found:', form);
        console.log('📋 Form dataset:', form.dataset);

        form.removeEventListener('submit', handleEditFarmSubmit);
        form.addEventListener('submit', handleEditFarmSubmit);
        console.log('✅ Submit handler attached');

        console.log('╔════════════════════════════════════════╗');
        console.log('║  ✅ EDIT FARM MODAL READY              ║');
        console.log('╚════════════════════════════════════════╝');

    } catch (error) {
        console.error('╔════════════════════════════════════════╗');
        console.error('║  ❌ EDIT FARM ERROR                    ║');
        console.error('╚════════════════════════════════════════╝');
        console.error('Error details:', error);
        console.error('Stack trace:', error.stack);
        showToast('❌ Error: ' + error.message, 'error');
    } finally {
        hideLoading();
        console.log('⏳ Loading finished');
    }
}

// ✅ S'assurer que la fonction est globale
if (typeof window !== 'undefined') {
    window.editFarm = editFarm;
    console.log('✅ editFarm function exported to window');
}






function openEditFarmModal(farm) {
  // Helper function pour gérer les valeurs undefined/null
  const safeValue = (value, defaultValue = '') => {
    return (value !== null && value !== undefined) ? value : defaultValue;
  };

  const modalHTML = `
  <div class="modal-overlay" id="farmModal">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Edit Farm</h3>
        <button class="modal-close" onclick="closeFarmModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="editFarmForm" data-farm-id="${farm.id}">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Farm Name *</label>
              <input type="text" class="form-input" name="farmName" value="${escapeHtml(safeValue(farm.farmName))}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Farm Code *</label>
              <input type="text" class="form-input" name="farmCode" value="${escapeHtml(safeValue(farm.farmCode))}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Size (Hectares) *</label>
              <input type="number" class="form-input" name="farmSize" value="${safeValue(farm.sizeHectares || farm.farmSize, 0)}" step="0.01" min="0" required>
            </div>
            <div class="form-group">
              <label class="form-label">Location *</label>
              <input type="text" class="form-input" name="location" value="${escapeHtml(safeValue(farm.location))}" required>
            </div>
            <div class="form-group">
              <label class="form-label">Latitude *</label>
              <input type="number" class="form-input" name="latitude" value="${safeValue(farm.latitude, 0)}" step="0.000001" min="-90" max="90" required>
            </div>
            <div class="form-group">
              <label class="form-label">Longitude *</label>
              <input type="number" class="form-input" name="longitude" value="${safeValue(farm.longitude, 0)}" step="0.000001" min="-180" max="180" required>
            </div>
            <div class="form-group">
              <label class="form-label">Soil Type *</label>
              <select class="form-select" name="soilType" required>
                <option value="">Select Soil Type</option>
                <option value="Clay" ${farm.soilType === 'Clay' ? 'selected' : ''}>Clay</option>
                <option value="Loam" ${farm.soilType === 'Loam' ? 'selected' : ''}>Loam</option>
                <option value="Sand" ${farm.soilType === 'Sand' ? 'selected' : ''}>Sand</option>
                <option value="Silt" ${farm.soilType === 'Silt' ? 'selected' : ''}>Silt</option>
                <option value="Sandy Loam" ${farm.soilType === 'Sandy Loam' ? 'selected' : ''}>Sandy Loam</option>
                <option value="Clay Loam" ${farm.soilType === 'Clay Loam' ? 'selected' : ''}>Clay Loam</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Irrigation System *</label>
              <select class="form-select" name="irrigationSystem" required>
                <option value="">Select Irrigation System</option>
                <option value="RAIN_FED" ${farm.irrigationSystem === 'RAIN_FED' ? 'selected' : ''}>Rain Fed</option>
                <option value="SPRINKLER" ${farm.irrigationSystem === 'SPRINKLER' ? 'selected' : ''}>Sprinkler</option>
                <option value="DRIP" ${farm.irrigationSystem === 'DRIP' ? 'selected' : ''}>Drip Irrigation</option>
                <option value="FLOOD" ${farm.irrigationSystem === 'FLOOD' ? 'selected' : ''}>Flood Irrigation</option>
                <option value="FURROW" ${farm.irrigationSystem === 'FURROW' ? 'selected' : ''}>Furrow Irrigation</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Topography</label>
              <input type="text" class="form-input" name="topography" value="${escapeHtml(safeValue(farm.topography))}">
            </div>
            <div class="form-group">
              <label class="form-label">Water Source</label>
              <input type="text" class="form-input" name="waterSource" value="${escapeHtml(safeValue(farm.waterSource))}">
            </div>
            <div class="form-group">
              <label class="form-label">Altitude (m)</label>
              <input type="number" class="form-input" name="altitude" value="${safeValue(farm.altitude, '')}" step="0.01" placeholder="Optional">
            </div>
            <div class="form-group">
              <label class="form-label">Road Access Quality</label>
              <select class="form-select" name="roadAccessQuality">
                <option value="POOR" ${farm.roadAccessQuality === 'POOR' ? 'selected' : ''}>Poor</option>
                <option value="MODERATE" ${(!farm.roadAccessQuality || farm.roadAccessQuality === 'MODERATE') ? 'selected' : ''}>Moderate</option>
                <option value="GOOD" ${farm.roadAccessQuality === 'GOOD' ? 'selected' : ''}>Good</option>
              </select>
            </div>
            <div class="form-group form-group-full">
              <label class="form-checkbox">
                <input type="checkbox" name="electricityAvailable" ${farm.electricityAvailable ? 'checked' : ''}>
                <span>Electricity Available</span>
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeFarmModal()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              Update Farm
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;

  document.getElementById('editFarmForm').addEventListener('submit', handleEditFarmSubmit);
}






// ============================================
// FIX 2: Ajouter la fonction de validation manquante
// ============================================
function validateFarmData(farmData) {
  const errors = [];

  if (!farmData.farmName || farmData.farmName.trim() === '') {
    errors.push('Farm name is required');
  }

  if (!farmData.farmSize || farmData.farmSize <= 0) {
    errors.push('Valid farm size is required');
  }

  if (!farmData.soilType) {
    errors.push('Soil type is required');
  }

  if (!farmData.latitude || isNaN(farmData.latitude)) {
    errors.push('Valid latitude is required');
  }

  if (!farmData.longitude || isNaN(farmData.longitude)) {
    errors.push('Valid longitude is required');
  }

  return errors;
}

// ============================================
// FIX 3: Créer l'alias loadFarmData → loadFarmsData
// ============================================
async function loadFarmData() {
  return await loadFarmsData();
}




// ============================================
// FIX: Améliorer handleEditFarmSubmit
// ============================================
async function handleEditFarmSubmit(e) {
  e.preventDefault();
  console.log('📤 Form submitted');

  const form = e.target;
  const farmId = form.dataset.farmId;
  const formData = new FormData(form);

  if (!farmId) {
    showToast('❌ Farm ID not found', 'error');
    return;
  }

  console.log('📤 Updating farm ID:', farmId);

  // Helper pour parser les nombres en toute sécurité
  const safeParseFloat = (value) => {
    const parsed = parseFloat(value);
    return isNaN(parsed) ? null : parsed;
  };

  // ✅ Collect form data avec validation
  const farmData = {
    farmerId: currentUser.id,
    farmName: formData.get('farmName')?.trim() || null,
    farmCode: formData.get('farmCode')?.trim() || null,
    farmSize: safeParseFloat(formData.get('farmSize')),
    soilType: formData.get('soilType') || null,
    latitude: safeParseFloat(formData.get('latitude')),
    longitude: safeParseFloat(formData.get('longitude')),
    altitude: safeParseFloat(formData.get('altitude')),
    irrigationSystem: formData.get('irrigationSystem') || 'RAIN_FED',
    topography: formData.get('topography')?.trim() || null,
    waterSource: formData.get('waterSource')?.trim() || null,
    electricityAvailable: formData.get('electricityAvailable') === 'on',
    roadAccessQuality: formData.get('roadAccessQuality') || 'MODERATE'
  };

  // Supprimer les valeurs null non requises
  Object.keys(farmData).forEach(key => {
    if (farmData[key] === null && ['altitude', 'topography', 'waterSource'].includes(key)) {
      delete farmData[key];
    }
  });

  console.log('📋 Farm data to update:', farmData);

  // ✅ Validate data
  const validationErrors = validateFarmData(farmData);
  if (validationErrors.length > 0) {
    console.error('❌ Validation errors:', validationErrors);
    showToast('❌ ' + validationErrors.join(', '), 'error');
    return;
  }

  try {
    showLoading();

    // ✅ Send PUT request
    const response = await apiRequest(`/farms/${farmId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(farmData)
    });

    console.log('✅ Farm updated successfully:', response);
    showToast('✅ Farm updated successfully!', 'success');

    closeFarmModal();
    await loadFarmsData();

  } catch (error) {
    console.error('❌ Error updating farm:', error);

    let errorMessage = 'Error updating farm';
    if (error.message) {
      if (error.message.includes('500')) {
        errorMessage = 'Server error. Please try again.';
      } else if (error.message.includes('400')) {
        errorMessage = 'Invalid data. Please check all fields.';
      } else if (error.message.includes('404')) {
        errorMessage = 'Farm not found.';
      } else {
        errorMessage = error.message;
      }
    }

    showToast('❌ ' + errorMessage, 'error');
  } finally {
    hideLoading();
  }
}








// ============================================
// HELPER: escapeHtml (if not already defined)
// ============================================
/**
 * Escape HTML to prevent XSS attacks
 */
function escapeHtml(text) {
  if (!text) return '';
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}


// ============================================
// VERIFICATION SCRIPT
// ============================================
/**
 * Run this to verify all functions are defined
 */
function verifyFarmEditFunctions() {
  const requiredFunctions = [
    'openEditFarmModal',
    'handleEditFarmSubmit',
    'validateFarmData',
    'closeFarmModal',
    'loadFarmsData',
    'escapeHtml',
    'showToast',
    'showLoading',
    'hideLoading',
    'apiRequest'
  ];

  console.log('🔍 Verifying required functions...');

  const missing = [];
  requiredFunctions.forEach(funcName => {
    if (typeof window[funcName] !== 'function') {
      missing.push(funcName);
      console.error(`❌ Missing: ${funcName}`);
    } else {
      console.log(`✅ Found: ${funcName}`);
    }
  });

  if (missing.length === 0) {
    console.log('✅ All required functions are defined!');
    return true;
  } else {
    console.error(`❌ Missing ${missing.length} functions:`, missing);
    return false;
  }
}

// Run verification on page load
if (typeof window !== 'undefined') {
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(verifyFarmEditFunctions, 1000);
  });
}



      /**
      * View farm details
      */
      async function viewFarmDetails(farmId) {
      try {
      showLoading();

      const farm = await apiRequest(`/farms/${farmId}`);

      // Show farm details modal
      showFarmDetailsModal(farm);

      } catch (error) {
      console.error('Error loading farm details:', error);
      showToast('Error loading farm details', 'error');
      } finally {
      hideLoading();
      }
      }

      /**
      * Show farm details modal
      */
      function showFarmDetailsModal(farm) {
      const modalHTML = `
      <div class="modal-overlay" id="farmModal">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">${farm.farmName}</h3>
            <button class="modal-close" onclick="closeFarmModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="details-grid">
              <div class="detail-item">
                <label>Farm Code</label>
                <value>${farm.farmCode}</value>
              </div>
              <div class="detail-item">
                <label>Size</label>
                <value>${farm.sizeHectares} hectares</value>
              </div>
              <div class="detail-item">
                <label>Location</label>
                <value>${farm.location}</value>
              </div>
              <div class="detail-item">
                <label>Coordinates</label>
                <value>${farm.latitude}, ${farm.longitude}</value>
              </div>
              <div class="detail-item">
                <label>Soil Type</label>
                <value>${farm.soilType}</value>
              </div>
              <div class="detail-item">
                <label>Irrigation System</label>
                <value>${formatIrrigationSystem(farm.irrigationSystem)}</value>
              </div>
              <div class="detail-item">
                <label>Topography</label>
                <value>${farm.topography || 'N/A'}</value>
              </div>
              <div class="detail-item">
                <label>Electricity</label>
                <value>${farm.electricityAvailable ? 'Available' : 'Not Available'}</value>
              </div>
              <div class="detail-item">
                <label>Created At</label>
                <value>${formatDateTime(farm.createdAt)}</value>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeFarmModal()">
              Close
            </button>
            <button class="btn btn-primary" onclick="editFarm('${farm.id}')">
              <i class="fas fa-edit"></i>
              Edit Farm
            </button>
          </div>
        </div>
      </div>
      `;

      document.getElementById('modalContainer').innerHTML = modalHTML;
      }




























      // ============================================================================
      // CROPS CATALOG MODULE
      // ============================================================================

     /**
 * Load crops data - CORRECTION
 */
async function loadCropsData() {
  try {
    showLoading();

    const response = await apiRequest('/v1/crops/all');

    // CORRECTION: Gérer les différents formats de réponse
    let crops = [];
    if (Array.isArray(response)) {
      crops = response;
    } else if (response && response.data && Array.isArray(response.data)) {
      crops = response.data;
    } else if (response && response.content && Array.isArray(response.content)) {
      crops = response.content;
    } else {
      console.warn('⚠️ Unexpected crops response format:', response);
      crops = [];
    }

    displayCropsGrid(crops);

  } catch (error) {
    console.error('Error loading crops:', error);
    showToast('Error loading crops catalog', 'error');

    // Afficher un état vide en cas d'erreur
    const container = document.getElementById('cropsGrid');
    if (container) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Unable to load crops catalog</p>
          <button class="btn btn-primary mt-4" onclick="loadCropsData()">
            <i class="fas fa-redo"></i>
            Try Again
          </button>
        </div>
      `;
    }
  } finally {
    hideLoading();
  }
}


/**
 * Display crops grid
 */
function displayCropsGrid(crops) {
  const container = document.getElementById('cropsGrid');
  if (!container) return;

  if (crops.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-seedling"></i>
        <p>No crops available</p>
      </div>
    `;
    return;
  }

  container.innerHTML = crops.map(crop => `
    <div class="crop-card">
      <div class="crop-card-header">
        <div class="crop-icon">🌾</div>
        <h3 class="crop-name">${crop.cropName}</h3>
        <span class="crop-category">${crop.cropType}</span>
      </div>
      <div class="crop-card-body">
        <div class="crop-info-list">
          <div class="crop-info-item">
            <span class="crop-info-label">Scientific Name</span>
            <span class="crop-info-value">${crop.scientificName || 'N/A'}</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Variety</span>
            <span class="crop-info-value">${crop.variety || 'N/A'}</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Growing Period</span>
            <span class="crop-info-value">${crop.growingPeriodDays} days</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Planting Season</span>
            <span class="crop-info-value">${crop.plantingSeason}</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Harvest Season</span>
            <span class="crop-info-value">${crop.harvestSeason}</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Market Demand</span>
            <span class="crop-info-value">${crop.marketDemandLevel}</span>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="viewCropDetails('${crop.id}')">
          <i class="fas fa-eye"></i>
          View Details
        </button>
      </div>
    </div>
  `).join('');
}






/**
      * View crop details
      */
      let isLoadingCropDetails = false;

      async function viewCropDetails(cropId) {
      if (isLoadingCropDetails) {
        console.log('⏳ Already loading crop details, ignoring...');
        return;
      }

      try {
      isLoadingCropDetails = true;
      console.log('🔍 Loading crop details for ID:', cropId);
      showLoading();

      const response = await apiRequest(`/v1/crops/${cropId}`);

      console.log('📦 Crop response:', response);

      // CORRECTION: Extraire la donnée du bon format de réponse
      let crop = null;
      if (response && response.data) {
        crop = response.data;
      } else if (response && !response.success && !response.data) {
        crop = response;
      }

      if (!crop) {
        throw new Error('Crop data not found');
      }

      console.log('✅ Crop data extracted:', crop);

      // CRITIQUE: Attendre un peu avant de cacher le loading
      hideLoading();

      console.log('🎬 About to call showCropDetailsModal...');
      showCropDetailsModal(crop);
      console.log('🎬 showCropDetailsModal called!');

      } catch (error) {
      console.error('❌ Error loading crop details:', error);
      showToast('Error loading crop details', 'error');
      hideLoading();
      } finally {
      isLoadingCropDetails = false;
      }
      }





/**
      * Close crop details modal
      */
      function closeCropModal() {
        console.log('🚪 Closing crop modal...');
        const modal = document.getElementById('cropModal');
        if (modal) {
          modal.style.opacity = '0';
          modal.classList.remove('show');
          setTimeout(() => {
            modal.remove();
            console.log('✅ Modal closed and removed');
          }, 300);
        } else {
          console.warn('⚠️ Modal not found when trying to close');
        }
      }

      // ✅ Gestionnaire global pour fermer le modal en cliquant en dehors
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
          console.log('🖱️ Click detected on modal overlay, closing...');
          const modalId = e.target.id;
          if (modalId === 'cropModal') {
            closeCropModal();
          } else if (modalId === 'productionModal') {
            closeProductionModal();
          }
        }
      });

function showCropDetailsModal(crop) {
  console.log('🎯 showCropDetailsModal called with crop:', crop);

  const modalContainer = document.getElementById('modalContainer');
  if (!modalContainer) {
    console.error('❌ Modal container not found!');
    showToast('Error: Modal container not found', 'error');
    return;
  }

  const val = (v, fallback = 'N/A') => (v !== null && v !== undefined) ? v : fallback;

  // ⭐ Utiliser les VRAIS noms de champs retournés par l'API
  const tempDisplay = (crop.temperatureMin != null && crop.temperatureMax != null)
    ? `${crop.temperatureMin}°C - ${crop.temperatureMax}°C`
    : (crop.temperatureRange || 'N/A');

  const phDisplay = (crop.soilPhMin != null && crop.soilPhMax != null)
    ? `${crop.soilPhMin} - ${crop.soilPhMax}`
    : (crop.phRange || 'N/A');

  const rainfallDisplay = crop.rainfallRequirement != null
    ? `${crop.rainfallRequirement} mm`
    : (crop.rainfallRequirementDisplay || 'N/A');

  const waterDisplay = crop.waterRequirement != null
    ? `${crop.waterRequirement} mm`
    : (crop.waterRequirementDisplay || 'N/A');

  const modalHTML = `
  <div class="modal-overlay" id="cropModal">
    <div class="modal-container modal-large">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-leaf"></i>
          ${val(crop.cropName, 'Unknown Crop')}
        </h3>
        <button class="modal-close" onclick="closeCropModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="crop-details">
          <div class="details-section">
            <h4><i class="fas fa-info-circle"></i> Basic Information</h4>
            <div class="details-grid">
              <div class="detail-item">
                <label>Scientific Name</label>
                <value>${val(crop.scientificName)}</value>
              </div>
              <div class="detail-item">
                <label>Crop Type</label>
                <value>${val(crop.cropType)}</value>
              </div>
              <div class="detail-item">
                <label>Variety</label>
                <value>${val(crop.variety)}</value>
              </div>
              <div class="detail-item">
                <label>Market Demand</label>
                <value><span class="demand-${(crop.marketDemandLevel || 'medium').toLowerCase()}">${val(crop.marketDemandLevel)}</span></value>
              </div>
            </div>
          </div>

          <div class="details-section">
            <h4><i class="fas fa-seedling"></i> Growing Requirements</h4>
            <div class="details-grid">
              <div class="detail-item">
                <label>Growing Period</label>
                <value>${crop.growingPeriodDays != null ? crop.growingPeriodDays + ' days' : 'N/A'}</value>
              </div>
              <div class="detail-item">
                <label>Planting Season</label>
                <value>${val(crop.plantingSeason)}</value>
              </div>
              <div class="detail-item">
                <label>Harvest Season</label>
                <value>${val(crop.harvestSeason)}</value>
              </div>
              <div class="detail-item">
                <label>Temperature Range</label>
                <value>${tempDisplay}</value>
              </div>
              <div class="detail-item">
                <label>Rainfall</label>
                <value>${rainfallDisplay}</value>
              </div>
              <div class="detail-item">
                <label>Water Requirement</label>
                <value>${waterDisplay}</value>
              </div>
            </div>
          </div>

          <div class="details-section">
            <h4><i class="fas fa-mountain"></i> Soil Requirements</h4>
            <div class="details-grid">
              <div class="detail-item">
                <label>pH Range</label>
                <value>${phDisplay}</value>
              </div>
              <div class="detail-item">
                <label>Climatic Requirement</label>
                <value>${val(crop.climaticRequirement)}</value>
              </div>
              <div class="detail-item">
                <label>Storage Life</label>
                <value>${crop.storageLifeDays != null ? crop.storageLifeDays + ' days' : 'N/A'}</value>
              </div>
            </div>
          </div>

          ${crop.description ? `
          <div class="details-section">
            <h4><i class="fas fa-file-alt"></i> Description</h4>
            <p>${crop.description}</p>
          </div>
          ` : ''}

          ${crop.nutritionalValue ? `
          <div class="details-section">
            <h4><i class="fas fa-apple-alt"></i> Nutritional Value</h4>
            <p>${crop.nutritionalValue}</p>
          </div>
          ` : ''}
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCropModal()">
          <i class="fas fa-times"></i>
          Close
        </button>
      </div>
    </div>
  </div>
  `;

  modalContainer.innerHTML = modalHTML;

  setTimeout(() => {
    const modal = document.getElementById('cropModal');
    if (modal) {
      modal.classList.add('show');
      modal.style.display = 'flex';
      modal.style.opacity = '1';
    }
  }, 10);
}




/**
 * Recharger les productions pour le formulaire de fertilisant
 */
async function loadProductionsForFertilizer() {
    try {
        showLoading();
        console.log('🔄 Manually reloading productions for fertilizer...');

        // Réouvrir le modal après rechargement
        setTimeout(() => {
            openAddFertilizerModal();
        }, 500);

    } catch (error) {
        console.error('Error reloading productions:', error);
        showToast('Error reloading productions', 'error');
    } finally {
        hideLoading();
    }
}




/**
 * Load production data with crop names enrichment
 */
async function loadProductionData() {
    try {
        showLoading();

        // ✅ VALIDATION UTILISATEUR
        if (!currentUser || !currentUser.id) {
            console.error('❌ No current user found');
            displayEmptyProductionState();
            return;
        }

        console.log('🔄 Loading production data for farmer user ID:', currentUser.id);

        // ✅ RÉCUPÉRATION DES PRODUCTIONS
        let allProductions = [];
        try {
            const productionsResponse = await apiRequest(`/v1/crop-productions/by-farmer/${currentUser.id}`);

            // ✅ GESTION MULTI-FORMAT DE LA RÉPONSE
            if (productionsResponse) {
                if (Array.isArray(productionsResponse)) {
                    allProductions = productionsResponse;
                } else if (productionsResponse.data) {
                    if (Array.isArray(productionsResponse.data)) {
                        allProductions = productionsResponse.data;
                    } else if (productionsResponse.data.content && Array.isArray(productionsResponse.data.content)) {
                        allProductions = productionsResponse.data.content;
                    }
                } else if (productionsResponse.content && Array.isArray(productionsResponse.content)) {
                    allProductions = productionsResponse.content;
                }
            }

            // ✅ FILTRAGE DES PRODUCTIONS VALIDES
            allProductions = allProductions.filter(p => {
                return p && typeof p === 'object' && p.productionStatus;
            });

            console.log(`✅ Total productions loaded: ${allProductions.length}`);

        } catch (error) {
            console.warn('⚠️ Productions load error:', error.message);
            allProductions = [];
        }

        // ⭐ NOUVEAU: ENRICHIR AVEC LES NOMS DE CULTURES
        if (allProductions.length > 0) {
            allProductions = await enrichProductionsWithCropNames(allProductions);
        }

        // ✅ CALCUL DES STATISTIQUES
        const totalCount = allProductions.length;

        // ✅ CALCUL DES PRODUCTIONS ACTIVES
        const active = allProductions.filter(p => {
            if (!p.productionStatus) return false;
            const status = String(p.productionStatus).toUpperCase();
            return ['PLANTED', 'GROWING', 'PLANNED', 'IN_PROGRESS', 'ACTIVE'].includes(status);
        }).length;

        // ✅ CALCUL DES PRODUCTIONS RÉCOLTÉES
        const harvested = allProductions.filter(p => {
            if (!p.productionStatus) return false;
            return String(p.productionStatus).toUpperCase() === 'HARVESTED';
        }).length;

        // ✅ CALCUL DU RENDEMENT TOTAL
        const totalYield = allProductions.reduce((sum, p) => {
            const yield = parseFloat(p.actualYield);
            return sum + (isNaN(yield) ? 0 : yield);
        }, 0);

        // ✅ MISE À JOUR DES ÉLÉMENTS UI
        updateElement('prodTotalCount', totalCount);
        updateElement('prodActive', active);
        updateElement('prodHarvested', harvested);
        updateElement('prodTotalYield', `${totalYield.toFixed(2)} T`);

        console.log('📊 Production Stats:', {
            total: totalCount,
            active: active,
            harvested: harvested,
            yield: totalYield.toFixed(2)
        });

        // ✅ AFFICHER LA TIMELINE
        displayProductionTimeline(allProductions);

        // ✅ AFFICHER ÉTAT VIDE SI NÉCESSAIRE
        if (totalCount === 0) {
            displayEmptyProductionState();
        }

    } catch (error) {
        console.error('❌ Error loading productions:', error);
        showToast('Unable to load production data', 'warning');
        displayEmptyProductionState();
    } finally {
        hideLoading();
    }
}


/**
 * ⭐ NOUVELLE FONCTION: Enrichir les productions avec les noms de cultures
 */
async function enrichProductionsWithCropNames(productions) {
    console.log('🔄 Enriching productions with crop names...');

    // Récupérer tous les crops une seule fois (pour optimisation)
    let cropsMap = {};
    try {
        const cropsResponse = await apiRequest('/v1/crops/all');
        let crops = [];

        if (Array.isArray(cropsResponse)) {
            crops = cropsResponse;
        } else if (cropsResponse && cropsResponse.data) {
            crops = Array.isArray(cropsResponse.data) ? cropsResponse.data : [];
        }

        // Créer une map cropId -> cropName
        crops.forEach(crop => {
            if (crop && crop.id && crop.cropName) {
                cropsMap[crop.id] = crop.cropName;
            }
        });

        console.log(`✅ Loaded ${Object.keys(cropsMap).length} crops`);

    } catch (error) {
        console.warn('⚠️ Error loading crops:', error.message);
    }

    // Enrichir chaque production avec le nom de la culture
    productions.forEach(prod => {
        if (prod.cropId && cropsMap[prod.cropId]) {
            prod.cropName = cropsMap[prod.cropId];
        } else {
            prod.cropName = 'Unknown Crop';
            console.warn(`⚠️ Crop not found for production ${prod.id}, cropId: ${prod.cropId}`);
        }
    });

    return productions;
}











function displayEmptyProductionState() {
    // ✅ MISE À JOUR DES STATS
    updateElement('prodTotalCount', 0);
    updateElement('prodActive', 0);
    updateElement('prodHarvested', 0);
    updateElement('prodTotalYield', '0 T');

    // ✅ AFFICHAGE ÉTAT VIDE
    const container = document.getElementById('productionTimeline');
    if (container) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-seedling"></i>
                <p>No crop productions registered yet</p>
                <button class="btn btn-primary" onclick="openAddProductionModal()">
                    <i class="fas fa-plus"></i>
                    Start First Production
                </button>
            </div>
        `;
    }
}






/**
 * Utility function to safely handle API responses
 */
function safeApiResponse(data, defaultValue = []) {
    if (Array.isArray(data)) {
        return data;
    }
    if (data && Array.isArray(data.content)) {
        return data.content;
    }
    if (data && typeof data === 'object') {
        // Si c'est un objet unique, le mettre dans un tableau
        return [data];
    }
    return defaultValue;
}




function displayProductionTimeline(productions) {
    const container = document.getElementById('productionTimeline');
    if (!container) return;

    if (!productions || productions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-seedling"></i>
                <p>No crop productions registered yet</p>
                <button class="btn btn-primary" onclick="openAddProductionModal()">
                    <i class="fas fa-plus"></i>
                    Start First Production
                </button>
            </div>
        `;
        return;
    }

    // ✅ TRI PAR DATE DE PLANTATION (PLUS RÉCENT EN PREMIER)
    const sortedProductions = [...productions].sort((a, b) => {
        const dateA = new Date(a.plantingDate || a.createdAt);
        const dateB = new Date(b.plantingDate || b.createdAt);
        return dateB - dateA;
    });

    container.innerHTML = sortedProductions.map(prod => {
        if (!prod || !prod.productionStatus) {
            return '';
        }

        const statusLower = prod.productionStatus.toLowerCase();
        const cropName = prod.cropName || 'Unknown Crop'; // ⭐ Maintenant disponible!
        const productionCode = prod.productionCode || 'N/A';
        const season = prod.season || 'N/A';
        const year = prod.year || '';
        const areaPlanted = prod.areaPlanted || 0;
        const expectedYield = prod.expectedYield || 'N/A';
        const actualYield = prod.actualYield || null;
        const plantingDate = prod.plantingDate ? formatDate(prod.plantingDate) : 'N/A';
        const expectedHarvestDate = prod.expectedHarvestDate ? formatDate(prod.expectedHarvestDate) : 'N/A';
        const actualHarvestDate = prod.actualHarvestDate ? formatDate(prod.actualHarvestDate) : null;

        // ✅ CALCUL DES JOURS JUSQU'À LA RÉCOLTE
        let daysUntilHarvest = null;
        if (prod.expectedHarvestDate && ['PLANTED', 'GROWING'].includes(prod.productionStatus)) {
            const today = new Date();
            const harvestDate = new Date(prod.expectedHarvestDate);
            daysUntilHarvest = Math.ceil((harvestDate - today) / (1000 * 60 * 60 * 24));
        }

        return `
            <div class="production-card">
                <div class="production-header">
                    <div class="production-info">
                        <h3 class="production-title">
                            <i class="fas fa-seedling"></i>
                            ${cropName}
                        </h3>
                        <span class="production-code">${productionCode}</span>
                    </div>
                    <div class="production-badges">
                        <span class="production-status status-${statusLower}">${prod.productionStatus}</span>
                        ${daysUntilHarvest !== null && daysUntilHarvest >= 0 ? `
                            <span class="production-countdown">
                                <i class="fas fa-clock"></i>
                                ${daysUntilHarvest} days to harvest
                            </span>
                        ` : ''}
                    </div>
                </div>

                <div class="production-details">
                    <div class="production-detail-item">
                        <label><i class="fas fa-calendar"></i> Season:</label>
                        <span>${season} ${year}</span>
                    </div>
                    <div class="production-detail-item">
                        <label><i class="fas fa-ruler-combined"></i> Area:</label>
                        <span>${areaPlanted} ha</span>
                    </div>
                    <div class="production-detail-item">
                        <label><i class="fas fa-chart-line"></i> Expected Yield:</label>
                        <span>${expectedYield} T/ha</span>
                    </div>
                    ${actualYield ? `
                        <div class="production-detail-item">
                            <label><i class="fas fa-warehouse"></i> Actual Yield:</label>
                            <span><strong>${actualYield} T/ha</strong></span>
                        </div>
                    ` : ''}
                </div>

                <div class="production-dates">
                    <div class="date-item">
                        <i class="fas fa-calendar-plus"></i>
                        <span><strong>Planted:</strong> ${plantingDate}</span>
                    </div>
                    <div class="date-item">
                        <i class="fas fa-calendar-check"></i>
                        <span><strong>Expected Harvest:</strong> ${expectedHarvestDate}</span>
                    </div>
                    ${actualHarvestDate ? `
                        <div class="date-item success">
                            <i class="fas fa-check-circle"></i>
                            <span><strong>Harvested:</strong> ${actualHarvestDate}</span>
                        </div>
                    ` : ''}
                </div>

                <div class="production-actions">
                    <button class="btn btn-secondary btn-sm" onclick="viewProductionDetails('${prod.id}')">
                        <i class="fas fa-eye"></i>
                        View Details
                    </button>
                    ${['PLANNED', 'PLANTED', 'GROWING'].includes(prod.productionStatus) ? `
                        <button class="btn btn-primary btn-sm" onclick="editProduction('${prod.id}')">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                    ` : ''}
                    ${prod.productionStatus === 'GROWING' ? `
                        <button class="btn btn-success btn-sm" onclick="markAsHarvested('${prod.id}')">
                            <i class="fas fa-warehouse"></i>
                            Mark Harvested
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }).filter(html => html !== '').join('');

    if (container.innerHTML.trim() === '') {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-seedling"></i>
                <p>No valid production data to display</p>
                <button class="btn btn-primary" onclick="loadProductionData()">
                    <i class="fas fa-redo"></i>
                    Reload
                </button>
            </div>
        `;
    }
}

/**
 * ✅ FIX CRITIQUE: Initialize all event listeners for farms
 */
function initializeFarmsEventListeners() {
  console.log('🔄 Initializing farms event listeners...');

  // Écouteur pour le bouton "Add Farm"
  const addFarmBtn = document.getElementById('addFarmBtn');
  if (addFarmBtn) {
    addFarmBtn.addEventListener('click', openAddFarmModal);
    console.log('✅ Add Farm button listener attached');
  } else {
    console.warn('⚠️ Add Farm button not found');
  }

  // Écouteurs pour les boutons Edit dans le tableau des farms
  document.addEventListener('click', function(e) {
    // Gérer les boutons Edit Farm
    if (e.target.closest('.btn-edit-farm')) {
      e.preventDefault();
      const farmId = e.target.closest('.btn-edit-farm').dataset.farmId;
      console.log('✏️ Edit farm clicked:', farmId);
      if (farmId) {
        editFarm(farmId);
      }
    }

    // Gérer les boutons View Details
    if (e.target.closest('.btn-view-farm')) {
      e.preventDefault();
      const farmId = e.target.closest('.btn-view-farm').dataset.farmId;
      console.log('👁️ View farm clicked:', farmId);
      if (farmId) {
        viewFarmDetails(farmId);
      }
    }

    // Gérer les boutons Delete
    if (e.target.closest('.btn-delete-farm')) {
      e.preventDefault();
      const farmId = e.target.closest('.btn-delete-farm').dataset.farmId;
      console.log('🗑️ Delete farm clicked:', farmId);
      if (farmId) {
        deleteFarm(farmId);
      }
    }
  });

  console.log('✅ All farms event listeners initialized');
}





async function openAddProductionModal() {
  try {
    showLoading();

    if (!currentUser || !currentUser.id) {
      showToast('❌ User session not found. Please login again.', 'error');
      hideLoading();
      return;
    }

    console.log('👤 Current user (Farmer ID):', currentUser.id);

    // Fetch crops
    const cropsResponse = await apiRequest('/v1/crops/all');
    let crops = [];
    if (cropsResponse && cropsResponse.data) {
      crops = Array.isArray(cropsResponse.data) ? cropsResponse.data : [];
    }

    if (crops.length === 0) {
      showToast('⚠️ No crops available. Please contact administrator.', 'warning');
      hideLoading();
      return;
    }

    const modalHTML = `
      <div class="modal-overlay" id="productionModal">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fas fa-seedling"></i>
              Start New Production
            </h3>
            <button class="modal-close" onclick="closeProductionModal()" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <form id="addProductionForm">
              <div class="form-grid">

                <!-- Info Farmer -->
                <div class="form-group form-group-full">
                  <div class="alert alert-info">
                    <i class="fas fa-user-tie"></i>
                    <strong>Farmer:</strong> ${currentUser.fullName || currentUser.username}
                    <br><small>Your production will be tracked under your farmer account</small>
                  </div>
                </div>

                <!-- Crop Selection -->
                <div class="form-group">
                  <label class="form-label required">
                    <i class="fas fa-leaf"></i>
                    Select Crop *
                  </label>
                  <select class="form-select" name="cropId" required>
                    <option value="">Choose a crop...</option>
                    ${crops.map(crop => `
                      <option value="${crop.id}" data-growing-days="${crop.growingPeriodDays || 90}">
                        ${crop.cropName} (${crop.growingPeriodDays || 90} days)
                      </option>
                    `).join('')}
                  </select>
                </div>

                <!-- Production Code - READ ONLY -->
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-barcode"></i>
                    Production Code
                    <span style="color: #999; font-size: 0.85em;">(Auto-generated)</span>
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="productionCode"
                    value="Will be generated automatically"
                    readonly
                    style="background-color: #f5f5f5; cursor: not-allowed; color: #999;"
                  >
                  <small style="display: block; margin-top: 5px; color: #666; font-size: 0.85em;">
                    <i class="fas fa-info-circle"></i>
                    A unique code will be created when you submit
                  </small>
                </div>

                <!-- Season -->
                <div class="form-group">
                  <label class="form-label required">
                    <i class="fas fa-calendar"></i>
                    Season *
                  </label>
                  <select class="form-select" name="season" required>
                    <option value="">Select Season...</option>
                    <option value="SEASON_A">🌱 Season A (Sep-Jan)</option>
                    <option value="SEASON_B">🌾 Season B (Feb-Jun)</option>
                    <option value="SEASON_C">🌿 Season C (Jul-Aug)</option>
                  </select>
                </div>

                <!-- Year -->
                <div class="form-group">
                  <label class="form-label required">
                    <i class="fas fa-calendar-alt"></i>
                    Year *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="year"
                    value="${new Date().getFullYear()}"
                    min="2020"
                    max="2030"
                    required
                  >
                </div>

                <!-- Area Planted -->
                <div class="form-group">
                  <label class="form-label required">
                    <i class="fas fa-ruler-combined"></i>
                    Area Planted (hectares) *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="areaPlanted"
                    step="0.01"
                    min="0.01"
                    placeholder="e.g., 2.5"
                    required
                  >
                </div>

                <!-- Expected Yield -->
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-chart-line"></i>
                    Expected Yield (T/ha)
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="expectedYield"
                    step="0.01"
                    min="0"
                    placeholder="e.g., 3.5"
                  >
                </div>

                <!-- Planting Date -->
                <div class="form-group">
                  <label class="form-label required">
                    <i class="fas fa-calendar-plus"></i>
                    Planting Date *
                  </label>
                  <input
                    type="date"
                    class="form-input"
                    name="plantingDate"
                    max="${new Date().toISOString().split('T')[0]}"
                    value="${new Date().toISOString().split('T')[0]}"
                    required
                  >
                </div>

                <!-- Expected Harvest Date -->
                <div class="form-group">
                  <label class="form-label required">
                    <i class="fas fa-calendar-check"></i>
                    Expected Harvest Date *
                  </label>
                  <input
                    type="date"
                    class="form-input"
                    name="expectedHarvestDate"
                    required
                  >
                </div>

                <!-- Seed Variety -->
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-seedling"></i>
                    Seed Variety
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="seedVariety"
                    placeholder="e.g., Hybrid A123"
                    maxlength="100"
                  >
                </div>

                <!-- Production Method -->
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-cogs"></i>
                    Production Method
                  </label>
                  <select class="form-select" name="productionMethod">
                    <option value="CONVENTIONAL">🚜 Conventional</option>
                    <option value="ORGANIC">🌱 Organic</option>
                    <option value="INTEGRATED">🔄 Integrated</option>
                  </select>
                </div>

              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProductionModal()">
                  <i class="fas fa-times"></i>
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  Start Production
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;

    setTimeout(() => {
      const modal = document.getElementById('productionModal');
      if (modal) {
        modal.classList.add('show');
        modal.style.display = 'flex';
      }
    }, 10);

    const form = document.getElementById('addProductionForm');
    if (form) {
      form.addEventListener('submit', handleAddProduction);
    }

    // Auto-calculate harvest date
    const plantingDateInput = form.querySelector('input[name="plantingDate"]');
    const cropSelect = form.querySelector('select[name="cropId"]');
    const harvestDateInput = form.querySelector('input[name="expectedHarvestDate"]');

    function updateExpectedHarvestDate() {
      if (plantingDateInput.value && cropSelect.value) {
        const selectedOption = cropSelect.options[cropSelect.selectedIndex];
        const growingDays = parseInt(selectedOption.dataset.growingDays) || 90;

        const plantingDate = new Date(plantingDateInput.value);
        const harvestDate = new Date(plantingDate);
        harvestDate.setDate(harvestDate.getDate() + growingDays);

        harvestDateInput.value = harvestDate.toISOString().split('T')[0];
      }
    }

    plantingDateInput.addEventListener('change', updateExpectedHarvestDate);
    cropSelect.addEventListener('change', updateExpectedHarvestDate);
    updateExpectedHarvestDate();

    console.log('✅ Production modal opened');

  } catch (error) {
    console.error('❌ Error opening modal:', error);
    showToast('Error loading form data: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}



async function handleAddProduction(event) {
    event.preventDefault();
    console.log('🌾 Starting add production process...');

    try {
        const form = event.target;

        // ⭐ Récupérer les données via form.elements
        const formData = {
            cropId: form.elements['cropId'].value,
            season: form.elements['season'].value,
            year: parseInt(form.elements['year'].value),
            plantingDate: form.elements['plantingDate'].value,
            expectedHarvestDate: form.elements['expectedHarvestDate'].value,
            areaPlanted: parseFloat(form.elements['areaPlanted'].value),
            expectedYield: form.elements['expectedYield'].value ? parseFloat(form.elements['expectedYield'].value) : null,
            seedVariety: form.elements['seedVariety'].value || null,
            productionMethod: form.elements['productionMethod'].value || 'CONVENTIONAL'
        };

        // Validation des champs requis
        if (!formData.cropId || !formData.season || !formData.year || !formData.plantingDate || !formData.expectedHarvestDate || !formData.areaPlanted) {
            showToast('❌ Please fill all required fields', 'error');
            return;
        }

        // ⭐ GÉNÉRER UN PRODUCTION CODE UNIQUE
        const timestamp = Date.now();
        const randomPart = Math.random().toString(36).substring(2, 8).toUpperCase();
        const productionCode = `PROD-${formData.year}-${randomPart}-${timestamp.toString().slice(-4)}`;

        console.log('🔢 Generated unique production code:', productionCode);

        // ⭐ Récupérer le farmId depuis currentUser
        if (!currentUser || !currentUser.id) {
            showToast('❌ User session not found. Please login again.', 'error');
            return;
        }

        const farmId = currentUser.id;
        console.log('✅ Using Farmer ID as Farm ID:', farmId);

        // ⭐ Construire l'objet final selon le format attendu par le backend
        const productionData = {
            farmId: farmId,
            cropId: formData.cropId,
            productionCode: productionCode,
            season: formData.season, // SEASON_A, SEASON_B, SEASON_C
            year: formData.year,
            plantingDate: formData.plantingDate,
            expectedHarvestDate: formData.expectedHarvestDate,
            areaPlanted: formData.areaPlanted,
            expectedYield: formData.expectedYield,
            seedVariety: formData.seedVariety,
            productionMethod: formData.productionMethod, // CONVENTIONAL, ORGANIC, INTEGRATED
            productionStatus: 'PLANNED' // PLANNED, PLANTED, GROWING, HARVESTED, SOLD
        };

        console.log('📋 Final production data:', productionData);
        console.log('📤 Sending production data to API...');

        // ⭐ Envoyer au bon endpoint (avec /api/v1/)
        const response = await apiRequest('/v1/crop-productions', {
            method: 'POST',
            body: JSON.stringify(productionData)
        });

        console.log('✅ Production created successfully:', response);

        showToast('✅ Production created successfully!', 'success');
        closeProductionModal();

        // Recharger les données
        await loadFarmerProductions();

    } catch (error) {
        console.error('❌ Error adding production:', error);

        // Messages d'erreur plus détaillés
        let errorMessage = 'Failed to create production';

        if (error.message) {
            if (error.message.includes('duplicate') || error.message.includes('exists') || error.message.includes('already')) {
                errorMessage = 'Production code already exists. Please try again.';
            } else if (error.message.includes('farm') || error.message.includes('Farmer')) {
                errorMessage = 'Invalid farm. Please ensure you have a farm registered.';
            } else if (error.message.includes('crop') || error.message.includes('Crop')) {
                errorMessage = 'Invalid crop selected';
            } else if (error.message.includes('500')) {
                errorMessage = 'Server error. Please check backend logs for details.';
            }
        }

        showToast(`❌ ${errorMessage}`, 'error');
    }
}





/**
 * Close production modal
 */
function closeProductionModal() {
  const modal = document.getElementById('productionModal');
  if (modal) {
    modal.style.opacity = '0';
    setTimeout(() => {
      modal.remove();
    }, 300);
  }
}









/**
 * View production details with enriched data
 */
async function viewProductionDetails(productionId) {
    try {
        showLoading();
        console.log('🔍 Loading production details for:', productionId);

        // ⭐ FIX: Utiliser le bon endpoint avec /v1/ et parenthèses (pas backticks!)
        const response = await apiRequest(`/v1/crop-productions/${productionId}`);

        console.log('✅ API Response:', response);

        // ⭐ Extraire les données selon le format de réponse
        let production = null;
        if (response && response.data) {
            production = response.data;
        } else if (response) {
            production = response;
        }

        console.log('✅ Production data:', production);

        if (!production) {
            throw new Error('No production data received');
        }

        // ⭐ Debug: Afficher toutes les propriétés
        console.log('📋 Production properties:', {
            id: production.id,
            cropName: production.cropName,
            cropImageUrl: production.cropImageUrl,
            productionCode: production.productionCode,
            season: production.season,
            year: production.year,
            areaPlanted: production.areaPlanted,
            expectedYield: production.expectedYield,
            actualYield: production.actualYield,
            productionStatus: production.productionStatus,
            plantingDate: production.plantingDate,
            expectedHarvestDate: production.expectedHarvestDate,
            farmerName: production.farmerName
        });

        showProductionDetailsModal(production);

    } catch (error) {
        console.error('❌ Error loading production details:', error);
        console.error('❌ Error stack:', error.stack);
        showToast(`Error loading production details: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}


/**
 * Show production details modal with professional GREEN design
 */
function showProductionDetailsModal(production) {
    console.log('🎨 Rendering modal with production:', production);

    const modalHTML = `
        <div class="modal-overlay" id="productionModal">
            <div class="modal-container modal-large" style="max-width: 900px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                    <div>
                        <h3 class="modal-title" style="margin: 0; font-size: 1.5rem;">
                            <i class="fas fa-leaf"></i> ${production.cropName || 'Production Details'}
                        </h3>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">
                            ${production.productionCode || 'N/A'}
                        </p>
                    </div>
                    <button class="modal-close" onclick="closeProductionModal()" style="color: white; background: rgba(255,255,255,0.2);">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="modal-body" style="padding: 30px; max-height: 70vh; overflow-y: auto;">

                    <!-- Status Badge -->
                    <div style="text-align: center; margin-bottom: 25px;">
                        <span class="production-status status-${(production.productionStatus || '').toLowerCase()}"
                              style="font-size: 1.1rem; padding: 10px 25px; border-radius: 25px; display: inline-block;">
                            ${production.productionStatus || 'N/A'}
                        </span>
                    </div>

                    <!-- Crop Information -->
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                        <h4 style="margin: 0 0 15px 0; color: #059669; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-seedling"></i> Crop Information
                        </h4>
                        <div class="details-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            ${production.cropImageUrl ? `
                                <div class="detail-item" style="grid-column: 1 / -1;">
                                    <img src="${production.cropImageUrl}"
                                         alt="${production.cropName}"
                                         style="width: 100%; max-width: 300px; height: 200px; object-fit: cover; border-radius: 10px; display: block; margin: 0 auto; border: 3px solid #10b981;">
                                </div>
                            ` : ''}
                            <div class="detail-item">
                                <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                    <i class="fas fa-leaf" style="color: #10b981;"></i> Crop Name
                                </label>
                                <value style="font-size: 1.1rem; color: #333;">${production.cropName || 'N/A'}</value>
                            </div>
                            ${production.cropType ? `
                                <div class="detail-item">
                                    <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                        <i class="fas fa-tag"></i> Crop Type
                                    </label>
                                    <value style="font-size: 1.1rem; color: #333;">${production.cropType}</value>
                                </div>
                            ` : ''}
                            ${production.cropVariety ? `
                                <div class="detail-item">
                                    <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                        <i class="fas fa-dna"></i> Variety
                                    </label>
                                    <value style="font-size: 1.1rem; color: #333;">${production.cropVariety}</value>
                                </div>
                            ` : ''}
                            ${production.seedVariety ? `
                                <div class="detail-item">
                                    <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                        <i class="fas fa-seedling"></i> Seed Variety
                                    </label>
                                    <value style="font-size: 1.1rem; color: #333;">${production.seedVariety}</value>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Production Details -->
                    <div style="background: #fff; padding: 20px; border: 2px solid #10b981; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #059669; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-line"></i> Production Details
                        </h4>
                        <div class="details-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="detail-item">
                                <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                    <i class="fas fa-calendar"></i> Season
                                </label>
                                <value style="font-size: 1.1rem; color: #333;">${production.season || 'N/A'} ${production.year || ''}</value>
                            </div>
                            <div class="detail-item">
                                <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                    <i class="fas fa-ruler-combined"></i> Area Planted
                                </label>
                                <value style="font-size: 1.1rem; color: #333; font-weight: bold;">${production.areaPlanted || 0} ha</value>
                            </div>
                            <div class="detail-item">
                                <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                    <i class="fas fa-chart-line"></i> Expected Yield
                                </label>
                                <value style="font-size: 1.1rem; color: #10b981; font-weight: bold;">${production.expectedYield || 'N/A'} T/ha</value>
                            </div>
                            ${production.actualYield ? `
                                <div class="detail-item">
                                    <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                        <i class="fas fa-warehouse"></i> Actual Yield
                                    </label>
                                    <value style="font-size: 1.1rem; color: #10b981; font-weight: bold;">${production.actualYield} T/ha</value>
                                </div>
                            ` : ''}
                            ${production.totalProduction ? `
                                <div class="detail-item">
                                    <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                        <i class="fas fa-boxes"></i> Total Production
                                    </label>
                                    <value style="font-size: 1.1rem; color: #10b981; font-weight: bold;">${production.totalProduction} T</value>
                                </div>
                            ` : ''}
                            ${production.productionMethod ? `
                                <div class="detail-item">
                                    <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                        <i class="fas fa-cogs"></i> Method
                                    </label>
                                    <value style="font-size: 1.1rem; color: #333;">${production.productionMethod}</value>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                        <h4 style="margin: 0 0 15px 0; color: #059669; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-clock"></i> Timeline
                        </h4>
                        <div class="details-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div class="detail-item">
                                <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                    <i class="fas fa-calendar-plus" style="color: #10b981;"></i> Planting Date
                                </label>
                                <value style="font-size: 1.1rem; color: #333;">${formatDate(production.plantingDate)}</value>
                            </div>
                            <div class="detail-item">
                                <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                    <i class="fas fa-calendar-check" style="color: #10b981;"></i> Expected Harvest
                                </label>
                                <value style="font-size: 1.1rem; color: #333;">${formatDate(production.expectedHarvestDate)}</value>
                            </div>
                            ${production.actualHarvestDate ? `
                                <div class="detail-item">
                                    <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                        <i class="fas fa-check-circle" style="color: #10b981;"></i> Actual Harvest
                                    </label>
                                    <value style="font-size: 1.1rem; color: #10b981; font-weight: bold;">${formatDate(production.actualHarvestDate)}</value>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    ${production.farmerName ? `
                        <!-- Farmer Information -->
                        <div style="background: #fff; padding: 20px; border: 2px solid #10b981; border-radius: 10px;">
                            <h4 style="margin: 0 0 15px 0; color: #059669; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-user-tie"></i> Farmer Information
                            </h4>
                            <div class="details-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div class="detail-item">
                                    <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                        <i class="fas fa-user"></i> Name
                                    </label>
                                    <value style="font-size: 1.1rem; color: #333;">${production.farmerName}</value>
                                </div>
                                ${production.farmerEmail ? `
                                    <div class="detail-item">
                                        <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                            <i class="fas fa-envelope"></i> Email
                                        </label>
                                        <value style="font-size: 1.1rem; color: #333;">${production.farmerEmail}</value>
                                    </div>
                                ` : ''}
                                ${production.farmerPhone ? `
                                    <div class="detail-item">
                                        <label style="font-weight: 600; color: #059669; display: block; margin-bottom: 5px;">
                                            <i class="fas fa-phone"></i> Phone
                                        </label>
                                        <value style="font-size: 1.1rem; color: #333;">${production.farmerPhone}</value>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                </div>

                <div class="modal-footer" style="padding: 20px; border-top: 2px solid #10b981; display: flex; gap: 10px; justify-content: flex-end; background: #f9fafb;">
                    <button class="btn btn-secondary" onclick="closeProductionModal()" style="padding: 10px 20px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                    ${['PLANNED', 'PLANTED', 'GROWING'].includes(production.productionStatus) ? `
                        <button class="btn btn-primary" onclick="closeProductionModal(); editProduction('${production.id}');"
                                style="padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none;">
                            <i class="fas fa-edit"></i> Edit Production
                        </button>
                    ` : ''}
                    ${production.productionStatus === 'GROWING' ? `
                        <button class="btn btn-success" onclick="closeProductionModal(); markAsHarvested('${production.id}');"
                                style="padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none;">
                            <i class="fas fa-warehouse"></i> Mark as Harvested
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;

    console.log('✅ Modal HTML generated, inserting into DOM...');
    document.getElementById('modalContainer').innerHTML = modalHTML;

    setTimeout(() => {
        const modal = document.getElementById('productionModal');
        if (modal) {
            modal.classList.add('show');
            modal.style.display = 'flex';
            console.log('✅ Modal displayed successfully');
        } else {
            console.error('❌ Modal element not found in DOM');
        }
    }, 10);
}



async function editProduction(productionId) {
    try {
        showLoading();
        console.log('✏️ Opening edit modal for production:', productionId);

        // ⭐ VALIDATION CRITIQUE
        if (!productionId) {
            console.error('❌ Production ID is missing!');
            showToast('❌ Production ID is missing', 'error');
            hideLoading();
            return;
        }

        // Charger les données de production
        const productionResponse = await apiRequest(`/v1/crop-productions/${productionId}`);

        console.log('📦 Production response:', productionResponse);

        // ⭐ Extraire les données selon le format de réponse
        let production = null;
        if (productionResponse && productionResponse.data) {
            production = productionResponse.data;
        } else if (productionResponse) {
            production = productionResponse;
        }

        if (!production) {
            throw new Error('No production data received');
        }

        console.log('✅ Production loaded:', production);

        // Charger la liste des cultures
        const cropsResponse = await apiRequest('/v1/crops/all');
        let crops = [];
        if (cropsResponse && cropsResponse.data) {
            crops = Array.isArray(cropsResponse.data) ? cropsResponse.data : [];
        }

        const modalHTML = `
            <div class="modal-overlay" id="productionModal">
                <div class="modal-container">
                    <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <h3 class="modal-title">
                            <i class="fas fa-edit"></i>
                            Edit Production
                        </h3>
                        <button class="modal-close" onclick="closeProductionModal()" type="button" style="color: white; background: rgba(255,255,255,0.2);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editProductionForm">
                            <!-- ⭐ IMPORTANT: Production ID caché -->
                            <input type="hidden" name="productionId" value="${production.id}">

                            <div class="form-grid">

                                <!-- Production Code - READ ONLY -->
                                <div class="form-group form-group-full">
                                    <label class="form-label">
                                        <i class="fas fa-barcode"></i>
                                        Production Code
                                    </label>
                                    <input
                                        type="text"
                                        class="form-input"
                                        value="${production.productionCode || 'N/A'}"
                                        readonly
                                        style="background-color: #f5f5f5; cursor: not-allowed;"
                                    >
                                </div>

                                <!-- Crop Selection -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-leaf"></i>
                                        Crop *
                                    </label>
                                    <select class="form-select" name="cropId" required>
                                        ${crops.map(crop => `
                                            <option value="${crop.id}"
                                                    data-growing-days="${crop.growingPeriodDays || 90}"
                                                    ${crop.id === production.cropId ? 'selected' : ''}>
                                                ${crop.cropName} (${crop.growingPeriodDays || 90} days)
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>

                                <!-- Season -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-calendar"></i>
                                        Season *
                                    </label>
                                    <select class="form-select" name="season" required>
                                        <option value="SEASON_A" ${production.season === 'SEASON_A' ? 'selected' : ''}>🌱 Season A (Sep-Jan)</option>
                                        <option value="SEASON_B" ${production.season === 'SEASON_B' ? 'selected' : ''}>🌾 Season B (Feb-Jun)</option>
                                        <option value="SEASON_C" ${production.season === 'SEASON_C' ? 'selected' : ''}>🌿 Season C (Jul-Aug)</option>
                                    </select>
                                </div>

                                <!-- Year -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-calendar-alt"></i>
                                        Year *
                                    </label>
                                    <input
                                        type="number"
                                        class="form-input"
                                        name="year"
                                        value="${production.year}"
                                        min="2020"
                                        max="2030"
                                        required
                                    >
                                </div>

                                <!-- Area Planted -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-ruler-combined"></i>
                                        Area Planted (hectares) *
                                    </label>
                                    <input
                                        type="number"
                                        class="form-input"
                                        name="areaPlanted"
                                        value="${production.areaPlanted}"
                                        step="0.01"
                                        min="0.01"
                                        required
                                    >
                                </div>

                                <!-- Expected Yield -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-chart-line"></i>
                                        Expected Yield (T/ha)
                                    </label>
                                    <input
                                        type="number"
                                        class="form-input"
                                        name="expectedYield"
                                        value="${production.expectedYield || ''}"
                                        step="0.01"
                                        min="0"
                                    >
                                </div>

                                <!-- Planting Date -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-calendar-plus"></i>
                                        Planting Date *
                                    </label>
                                    <input
                                        type="date"
                                        class="form-input"
                                        name="plantingDate"
                                        value="${production.plantingDate ? production.plantingDate.split('T')[0] : ''}"
                                        required
                                    >
                                </div>

                                <!-- Expected Harvest Date -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-calendar-check"></i>
                                        Expected Harvest Date *
                                    </label>
                                    <input
                                        type="date"
                                        class="form-input"
                                        name="expectedHarvestDate"
                                        value="${production.expectedHarvestDate ? production.expectedHarvestDate.split('T')[0] : ''}"
                                        required
                                    >
                                </div>

                                <!-- Seed Variety -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-seedling"></i>
                                        Seed Variety
                                    </label>
                                    <input
                                        type="text"
                                        class="form-input"
                                        name="seedVariety"
                                        value="${production.seedVariety || ''}"
                                        maxlength="100"
                                    >
                                </div>

                                <!-- Production Method -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-cogs"></i>
                                        Production Method
                                    </label>
                                    <select class="form-select" name="productionMethod">
                                        <option value="CONVENTIONAL" ${production.productionMethod === 'CONVENTIONAL' ? 'selected' : ''}>🚜 Conventional</option>
                                        <option value="ORGANIC" ${production.productionMethod === 'ORGANIC' ? 'selected' : ''}>🌱 Organic</option>
                                        <option value="INTEGRATED" ${production.productionMethod === 'INTEGRATED' ? 'selected' : ''}>🔄 Integrated</option>
                                    </select>
                                </div>

                                <!-- Production Status -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-info-circle"></i>
                                        Status *
                                    </label>
                                    <select class="form-select" name="productionStatus" required>
                                        <option value="PLANNED" ${production.productionStatus === 'PLANNED' ? 'selected' : ''}>📋 Planned</option>
                                        <option value="PLANTED" ${production.productionStatus === 'PLANTED' ? 'selected' : ''}>🌱 Planted</option>
                                        <option value="GROWING" ${production.productionStatus === 'GROWING' ? 'selected' : ''}>🌿 Growing</option>
                                        <option value="HARVESTED" ${production.productionStatus === 'HARVESTED' ? 'selected' : ''}>✅ Harvested</option>
                                    </select>
                                </div>

                                ${production.productionStatus === 'HARVESTED' || production.actualYield ? `
                                    <!-- Actual Yield (si récolté) -->
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-warehouse"></i>
                                            Actual Yield (T/ha)
                                        </label>
                                        <input
                                            type="number"
                                            class="form-input"
                                            name="actualYield"
                                            value="${production.actualYield || ''}"
                                            step="0.01"
                                            min="0"
                                        >
                                    </div>

                                    <!-- Actual Harvest Date -->
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="fas fa-calendar-check"></i>
                                            Actual Harvest Date
                                        </label>
                                        <input
                                            type="date"
                                            class="form-input"
                                            name="actualHarvestDate"
                                            value="${production.actualHarvestDate ? production.actualHarvestDate.split('T')[0] : ''}"
                                        >
                                    </div>
                                ` : ''}

                            </div>

                            <div class="modal-footer" style="border-top: 2px solid #10b981; padding: 20px; background: #f9fafb;">
                                <button type="button" class="btn btn-secondary" onclick="closeProductionModal()">
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none;">
                                    <i class="fas fa-save"></i>
                                    Update Production
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

        setTimeout(() => {
            const modal = document.getElementById('productionModal');
            if (modal) {
                modal.classList.add('show');
                modal.style.display = 'flex';
            }
        }, 10);

        const form = document.getElementById('editProductionForm');
        if (form) {
            form.addEventListener('submit', handleEditProduction);

            // ⭐ Vérifier que le productionId est bien dans le formulaire
            console.log('✅ Form created with productionId:', form.elements['productionId'].value);
        }

        // Auto-calculate harvest date when planting date or crop changes
        const plantingDateInput = form.querySelector('input[name="plantingDate"]');
        const cropSelect = form.querySelector('select[name="cropId"]');
        const harvestDateInput = form.querySelector('input[name="expectedHarvestDate"]');

        function updateExpectedHarvestDate() {
            if (plantingDateInput.value && cropSelect.value) {
                const selectedOption = cropSelect.options[cropSelect.selectedIndex];
                const growingDays = parseInt(selectedOption.dataset.growingDays) || 90;

                const plantingDate = new Date(plantingDateInput.value);
                const harvestDate = new Date(plantingDate);
                harvestDate.setDate(harvestDate.getDate() + growingDays);

                harvestDateInput.value = harvestDate.toISOString().split('T')[0];
            }
        }

        plantingDateInput.addEventListener('change', updateExpectedHarvestDate);
        cropSelect.addEventListener('change', updateExpectedHarvestDate);

        console.log('✅ Edit modal opened successfully');

    } catch (error) {
        console.error('❌ Error opening edit modal:', error);
        showToast('Error loading production data: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}









/**
 * Handle edit production form submission
 */
async function handleEditProduction(event) {
    event.preventDefault();
    console.log('📝 Updating production...');

    try {
        const form = event.target;
        const productionId = form.elements['productionId'].value;

        // ⭐ VALIDATION CRITIQUE
        if (!productionId) {
            console.error('❌ Production ID is missing!');
            showToast('❌ Production ID is missing', 'error');
            return;
        }

        console.log('🆔 Production ID:', productionId);

        // ⭐ Récupérer d'abord la production actuelle pour avoir productionCode et farmId
        const currentProduction = await apiRequest(`/v1/crop-productions/${productionId}`);

        console.log('📦 Current production:', currentProduction);

        // ⭐ Extraire les données depuis la réponse
        let production = null;
        if (currentProduction && currentProduction.data) {
            production = currentProduction.data;
        } else if (currentProduction) {
            production = currentProduction;
        }

        if (!production) {
            throw new Error('Could not load current production data');
        }

        // ⭐ Construire les données de mise à jour
        const formData = {
            // ⭐ IMPORTANT: Garder les champs obligatoires existants
            productionCode: production.productionCode,
            farmId: production.farmId,

            // ⭐ Champs modifiables depuis le formulaire
            cropId: form.elements['cropId'].value,
            season: form.elements['season'].value,
            year: parseInt(form.elements['year'].value),
            plantingDate: form.elements['plantingDate'].value,
            expectedHarvestDate: form.elements['expectedHarvestDate'].value,
            areaPlanted: parseFloat(form.elements['areaPlanted'].value),
            expectedYield: form.elements['expectedYield'].value ? parseFloat(form.elements['expectedYield'].value) : null,
            seedVariety: form.elements['seedVariety'].value || null,
            productionMethod: form.elements['productionMethod'].value || 'CONVENTIONAL',
            productionStatus: form.elements['productionStatus'].value
        };

        // ⭐ Ajouter actualYield et actualHarvestDate si présents dans le formulaire
        if (form.elements['actualYield']) {
            formData.actualYield = form.elements['actualYield'].value ? parseFloat(form.elements['actualYield'].value) : null;
        }
        if (form.elements['actualHarvestDate']) {
            formData.actualHarvestDate = form.elements['actualHarvestDate'].value || null;
        }

        // ⭐ Validation des champs requis
        if (!formData.cropId || !formData.season || !formData.year || !formData.plantingDate || !formData.expectedHarvestDate || !formData.areaPlanted) {
            showToast('❌ Please fill all required fields', 'error');
            return;
        }

        console.log('📤 Sending update data:', formData);

        // ⭐ Envoyer la mise à jour
        const response = await apiRequest(`/v1/crop-productions/${productionId}`, {
            method: 'PUT',
            body: JSON.stringify(formData)
        });

        console.log('✅ Production updated successfully:', response);

        showToast('✅ Production updated successfully!', 'success');
        closeProductionModal();

        // Recharger les données
        await loadProductionData();

    } catch (error) {
        console.error('❌ Error updating production:', error);
        console.error('❌ Error details:', {
            message: error.message,
            stack: error.stack
        });
        showToast(`❌ Failed to update production: ${error.message}`, 'error');
    }
}


/**
 * Mark production as harvested
 */
async function markAsHarvested(productionId) {
    try {
        console.log('🌾 Opening harvest modal for production:', productionId);

        if (!productionId) {
            showToast('❌ Production ID is missing', 'error');
            return;
        }

        // Charger les données de la production
        const productionResponse = await apiRequest(`/v1/crop-productions/${productionId}`);

        let production = null;
        if (productionResponse && productionResponse.data) {
            production = productionResponse.data;
        } else if (productionResponse) {
            production = productionResponse;
        }

        if (!production) {
            throw new Error('Could not load production data');
        }

        console.log('✅ Production loaded for harvest:', production);

        // Créer le modal de récolte
        const modalHTML = `
            <div class="modal-overlay" id="harvestModal">
                <div class="modal-container" style="max-width: 600px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <h3 class="modal-title">
                            <i class="fas fa-warehouse"></i>
                            Mark as Harvested
                        </h3>
                        <button class="modal-close" onclick="closeHarvestModal()" type="button" style="color: white; background: rgba(255,255,255,0.2);">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="modal-body" style="padding: 30px;">

                        <!-- Production Info -->
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #10b981;">
                            <h4 style="margin: 0 0 10px 0; color: #059669;">
                                <i class="fas fa-leaf"></i> ${production.cropName || 'Production'}
                            </h4>
                            <p style="margin: 5px 0; color: #666;">
                                <i class="fas fa-barcode"></i> ${production.productionCode}
                            </p>
                            <p style="margin: 5px 0; color: #666;">
                                <i class="fas fa-ruler-combined"></i> Area: ${production.areaPlanted} ha
                            </p>
                            <p style="margin: 5px 0; color: #666;">
                                <i class="fas fa-chart-line"></i> Expected Yield: ${production.expectedYield || 'N/A'} T/ha
                            </p>
                        </div>

                        <form id="harvestForm">
                            <input type="hidden" name="productionId" value="${production.id}">

                            <div class="form-grid">

                                <!-- Actual Harvest Date -->
                                <div class="form-group form-group-full">
                                    <label class="form-label required">
                                        <i class="fas fa-calendar-check"></i>
                                        Actual Harvest Date *
                                    </label>
                                    <input
                                        type="date"
                                        class="form-input"
                                        name="actualHarvestDate"
                                        value="${new Date().toISOString().split('T')[0]}"
                                        max="${new Date().toISOString().split('T')[0]}"
                                        required
                                    >
                                </div>

                                <!-- Actual Yield -->
                                <div class="form-group form-group-full">
                                    <label class="form-label required">
                                        <i class="fas fa-warehouse"></i>
                                        Actual Yield (T/ha) *
                                    </label>
                                    <input
                                        type="number"
                                        class="form-input"
                                        name="actualYield"
                                        step="0.01"
                                        min="0"
                                        placeholder="e.g., 4.5"
                                        required
                                    >
                                    <small style="display: block; margin-top: 5px; color: #666;">
                                        <i class="fas fa-info-circle"></i>
                                        Expected yield was ${production.expectedYield || 'N/A'} T/ha
                                    </small>
                                </div>

                                <!-- Total Production (calculated) -->
                                <div class="form-group form-group-full">
                                    <label class="form-label">
                                        <i class="fas fa-boxes"></i>
                                        Total Production (Tonnes)
                                    </label>
                                    <input
                                        type="text"
                                        class="form-input"
                                        id="totalProductionDisplay"
                                        value="Will be calculated"
                                        readonly
                                        style="background-color: #f5f5f5; font-weight: bold; color: #10b981;"
                                    >
                                    <small style="display: block; margin-top: 5px; color: #666;">
                                        <i class="fas fa-calculator"></i>
                                        Calculated as: Actual Yield × Area Planted
                                    </small>
                                </div>

                                <!-- Quality Assessment -->
                                <div class="form-group form-group-full">
                                    <label class="form-label">
                                        <i class="fas fa-star"></i>
                                        Quality Assessment
                                    </label>
                                    <select class="form-select" name="quality">
                                        <option value="">Select quality...</option>
                                        <option value="EXCELLENT">⭐⭐⭐⭐⭐ Excellent</option>
                                        <option value="GOOD" selected>⭐⭐⭐⭐ Good</option>
                                        <option value="AVERAGE">⭐⭐⭐ Average</option>
                                        <option value="POOR">⭐⭐ Poor</option>
                                    </select>
                                </div>

                                <!-- Notes -->
                                <div class="form-group form-group-full">
                                    <label class="form-label">
                                        <i class="fas fa-comment-alt"></i>
                                        Harvest Notes
                                    </label>
                                    <textarea
                                        class="form-input"
                                        name="notes"
                                        rows="3"
                                        placeholder="Add any observations about the harvest..."
                                        style="resize: vertical;"
                                    ></textarea>
                                </div>

                            </div>

                        </form>
                    </div>

                    <div class="modal-footer" style="padding: 20px; border-top: 2px solid #10b981; background: #f9fafb;">
                        <button type="button" class="btn btn-secondary" onclick="closeHarvestModal()">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                        <button type="button" class="btn btn-success" onclick="submitHarvest()"
                                style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none;">
                            <i class="fas fa-check"></i>
                            Mark as Harvested
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

        setTimeout(() => {
            const modal = document.getElementById('harvestModal');
            if (modal) {
                modal.classList.add('show');
                modal.style.display = 'flex';
            }
        }, 10);

        // Auto-calculate total production when actual yield changes
        const actualYieldInput = document.querySelector('input[name="actualYield"]');
        const totalProductionDisplay = document.getElementById('totalProductionDisplay');

        actualYieldInput.addEventListener('input', function() {
            const actualYield = parseFloat(this.value);
            if (!isNaN(actualYield) && actualYield > 0) {
                const totalProduction = (actualYield * production.areaPlanted).toFixed(2);
                totalProductionDisplay.value = `${totalProduction} T`;
                totalProductionDisplay.style.color = '#10b981';
            } else {
                totalProductionDisplay.value = 'Enter yield first';
                totalProductionDisplay.style.color = '#999';
            }
        });

        console.log('✅ Harvest modal opened');

    } catch (error) {
        console.error('❌ Error opening harvest modal:', error);
        showToast('Error loading harvest form: ' + error.message, 'error');
    }
}



/**
 * Close harvest modal
 */
function closeHarvestModal() {
    const modal = document.getElementById('harvestModal');
    if (modal) {
        modal.style.opacity = '0';
        modal.classList.remove('show');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

/**
 * Submit harvest data
 */
async function submitHarvest() {
    try {
        const form = document.getElementById('harvestForm');
        const productionId = form.elements['productionId'].value;
        if (!productionId) {
            showToast('❌ Production ID is missing', 'error');
            return;
        }

        const actualHarvestDate = form.elements['actualHarvestDate'].value;
        const actualYield = parseFloat(form.elements['actualYield'].value);
        const quality = form.elements['quality'].value;
        const notes = form.elements['notes'].value;

        if (!actualHarvestDate) {
            showToast('❌ Please enter harvest date', 'error');
            return;
        }
        if (!actualYield || actualYield <= 0) {
            showToast('❌ Please enter a valid actual yield', 'error');
            return;
        }

        console.log('📤 Submitting harvest data:', {
            productionId,
            actualHarvestDate,
            actualYield,
            quality,
            notes
        });

        showLoading();

        // ⭐ FIX: parenthèses () pas backticks ``
        const currentProduction = await apiRequest(`/v1/crop-productions/${productionId}`);

        let production = null;
        if (currentProduction && currentProduction.data) {
            production = currentProduction.data;
        } else if (currentProduction) {
            production = currentProduction;
        }

        if (!production) {
            throw new Error('Could not load current production data');
        }

        const updateData = {
            productionCode: production.productionCode,
            farmId: production.farmId,
            cropId: production.cropId,
            season: production.season,
            year: production.year,
            plantingDate: production.plantingDate,
            expectedHarvestDate: production.expectedHarvestDate,
            areaPlanted: production.areaPlanted,
            expectedYield: production.expectedYield,
            seedVariety: production.seedVariety,
            productionMethod: production.productionMethod,

            productionStatus: 'HARVESTED',
            actualHarvestDate: actualHarvestDate,
            actualYield: actualYield,

            notes: notes ? (production.notes ? production.notes + '\n\n[HARVEST] ' + notes : '[HARVEST] ' + notes) : production.notes
        };

        console.log('📤 Sending update:', updateData);

        // ⭐ FIX: parenthèses () pas backticks ``
        const response = await apiRequest(`/v1/crop-productions/${productionId}`, {
            method: 'PUT',
            body: JSON.stringify(updateData)
        });

        console.log('✅ Harvest recorded successfully:', response);
        showToast('✅ Production marked as harvested successfully!', 'success');

        // ⭐ FIX: closeHarvestModal existe maintenant
        closeHarvestModal();

        await loadProductionData();

    } catch (error) {
        console.error('❌ Error recording harvest:', error);
        // ⭐ FIX: parenthèses () pas backticks ``
        showToast('❌ Failed to record harvest: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}








/**
 * Export inventory to Excel
 */
async function exportInventoryToExcel() {
    try {
        showLoading();
        showToast('Preparing export...', 'info');

        // Récupérer l'inventaire
        const response = await apiRequest(`/v1/inventories/farmer/${currentUser.id}`);
        let inventory = [];

        if (Array.isArray(response)) inventory = response;
        else if (response?.data && Array.isArray(response.data)) inventory = response.data;
        else if (response?.content && Array.isArray(response.content)) inventory = response.content;

        inventory = inventory.filter(item => item && item.id);

        if (inventory.length === 0) {
            showToast('No inventory to export', 'warning');
            hideLoading();
            return;
        }

        // Enricher avec crop names
        let cropsMap = {};
        try {
            const cropsResponse = await apiRequest('/v1/crops/all');
            let crops = Array.isArray(cropsResponse) ? cropsResponse :
                       (cropsResponse?.data && Array.isArray(cropsResponse.data)) ? cropsResponse.data : [];
            crops.forEach(c => { if (c?.id && c.cropName) cropsMap[c.id] = c.cropName; });
        } catch (e) { console.warn('⚠️ Crops load:', e.message); }

        inventory.forEach(item => {
            item.cropName = (item.cropId && cropsMap[item.cropId]) ? cropsMap[item.cropId] : 'Unknown Crop';
        });

        // Headers
        const headers = [
            'Inventory Code', 'Crop Name', 'Status', 'Facility Type', 'Storage Location',
            'Current Qty (KG)', 'Available Qty (KG)', 'Quality Grade',
            'Market Value/KG (RWF)', 'Total Value (RWF)',
            'Storage Date', 'Expiry Date', 'Organic', 'Fair Trade'
        ];

        // Rows
        const rows = inventory.map(item => [
            item.inventoryCode || '',
            item.cropName || '',
            item.status || '',
            item.facilityType || '',
            item.storageLocation || '',
            parseFloat(item.currentQuantity) || 0,
            parseFloat(item.availableQuantity) || 0,
            item.qualityGrade || '',
            parseFloat(item.marketValuePerUnit) || '',
            parseFloat(item.totalMarketValue) || 0,
            item.storageDate ? item.storageDate.split('T')[0] : '',
            item.expiryDate ? item.expiryDate.split('T')[0] : '',
            item.organicCertified ? 'Yes' : 'No',
            item.fairTradeCertified ? 'Yes' : 'No'
        ]);

        // Shared strings
        const strings = [];
        const strMap = {};
        function addString(val) {
            const s = String(val);
            if (!(s in strMap)) { strMap[s] = strings.length; strings.push(s); }
            return strMap[s];
        }
        headers.forEach(h => addString(h));
        rows.forEach(row => row.forEach(cell => { if (typeof cell === 'string') addString(cell); }));

        function escapeXml(s) {
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
        }

        function cellRef(col, row) {
            let c = '', n = col;
            while (n >= 0) { c = String.fromCharCode(65 + (n % 26)) + c; n = Math.floor(n / 26) - 1; }
            return c + (row + 1);
        }

        const numCols = [5, 6, 8, 9]; // currentQty, availableQty, marketValue/KG, totalValue

        // sheet1.xml
        let sheetRows = '';
        let headerCells = headers.map((h, ci) => `<c r="${cellRef(ci,0)}" t="s" s="1"><v>${addString(h)}</v></c>`).join('');
        sheetRows += `<row r="1">${headerCells}</row>`;

        rows.forEach((row, ri) => {
            let cells = row.map((cell, ci) => {
                const ref = cellRef(ci, ri + 1);
                if (numCols.includes(ci) && cell !== '' && !isNaN(cell)) {
                    return `<c r="${ref}" s="2"><v>${cell}</v></c>`;
                }
                return `<c r="${ref}" t="s" s="2"><v>${addString(String(cell))}</v></c>`;
            }).join('');
            sheetRows += `<row r="${ri + 2}">${cells}</row>`;
        });

        const sheet1 = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<sheetViews><sheetView tabSelected="1" workbookViewId="0"/></sheetViews>
<sheetFormatPr defaultRowHeight="20"/>
<cols>${headers.map((_,i) => `<col min="${i+1}" max="${i+1}" width="24" customWidth="1"/>`).join('')}</cols>
<sheetData>${sheetRows}</sheetData>
</worksheet>`;

        const styles = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<fonts count="3">
  <font><sz val="11"/><name val="Calibri"/></font>
  <font><b/><sz val="11"/><color rgb="FFFFFFFF"/><name val="Calibri"/></font>
  <font><sz val="11"/><name val="Calibri"/></font>
</fonts>
<fills count="3">
  <fill><patternFill patternType="none"/></fill>
  <fill><patternFill patternType="solid"><fgColor rgb="FF10B981"/></patternFill></fill>
  <fill><patternFill patternType="solid"><fgColor rgb="FFF0FDF4"/></patternFill></fill>
</fills>
<borders count="2">
  <border><left/><right/><top/><bottom/><diagonal/></border>
  <border><left style="thin"><color rgb="FF10B981"/></left><right style="thin"><color rgb="FF10B981"/></right><top style="thin"><color rgb="FF10B981"/></top><bottom style="thin"><color rgb="FF10B981"/></bottom><diagonal/></border>
</borders>
<cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>
<cellXfs count="3">
  <xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/>
  <xf numFmtId="0" fontId="1" fillId="1" borderId="1" xfId="0" applyFont="1" applyFill="1" applyBorder="1" applyAlignment="1"><alignment horizontal="center" vertical="center"/></xf>
  <xf numFmtId="0" fontId="2" fillId="2" borderId="1" xfId="0" applyFill="1" applyBorder="1"/>
</cellXfs>
</styleSheet>`;

        const sharedStrings = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="${strings.length}" uniqueCount="${strings.length}">
${strings.map(s => `<si><t>${escapeXml(s)}</t></si>`).join('')}
</sst>`;

        const workbook = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
<sheets><sheet name="Inventory" sheetId="1" r:id="rId1"/></sheets>
</workbook>`;

        const rels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
<Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings" Target="sharedStrings.xml"/>
</Relationships>`;

        const topRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
</Relationships>`;

        const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
<Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
<Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>
<Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/>
</Types>`;

        const files = {
            '[Content_Types].xml': contentTypes,
            '_rels/.rels': topRels,
            'xl/workbook.xml': workbook,
            'xl/_rels/workbook.xml.rels': rels,
            'xl/worksheets/sheet1.xml': sheet1,
            'xl/styles.xml': styles,
            'xl/sharedStrings.xml': sharedStrings
        };

        const blob = await buildZipBlob(files);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Inventory_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('✅ Export successful!', 'success');

    } catch (error) {
        console.error('❌ Export error:', error);
        showToast('Failed to export: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// ✅ Remplacer l'ancien listener Export inventory
document.querySelectorAll('[data-action="export-inventory"]').forEach(btn => {
    btn.addEventListener('click', exportInventoryToExcel);
});







/**
 * Load inventory data - VERSION CORRIGÉE avec enrichissement des crops
 */
async function loadInventoryData() {
    const container = document.getElementById('inventoryGrid');
    if (!container) {
        console.error('❌ Inventory grid container not found');
        return;
    }

    try {
        showLoading();
        console.log('🔄 Loading inventory data for farmer:', currentUser.id);

        // Afficher loader dans le container
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading inventory...</p>
            </div>
        `;

        // ⭐ ÉTAPE 1: Charger tous les crops UNE SEULE FOIS
        let cropsMap = {};
        try {
            const cropsResponse = await apiRequest('/v1/crops/all');
            let crops = [];

            if (Array.isArray(cropsResponse)) {
                crops = cropsResponse;
            } else if (cropsResponse && cropsResponse.data && Array.isArray(cropsResponse.data)) {
                crops = cropsResponse.data;
            }

            // Créer une map cropId -> cropName
            crops.forEach(crop => {
                if (crop && crop.id && crop.cropName) {
                    cropsMap[crop.id] = crop.cropName;
                }
            });

            console.log(`✅ Loaded ${Object.keys(cropsMap).length} crops for inventory`);

        } catch (error) {
            console.warn('⚠️ Error loading crops:', error.message);
        }

        // ⭐ ÉTAPE 2: Charger l'inventaire
        let inventory = [];

        try {
            const response = await apiRequest(`/v1/inventories/farmer/${currentUser.id}`);
            console.log('📦 Raw API Response:', response);

            // ✅ GESTION MULTI-FORMAT DE LA RÉPONSE
            if (Array.isArray(response)) {
                inventory = response;
            } else if (response && response.data && Array.isArray(response.data)) {
                inventory = response.data;
            } else if (response && response.content && Array.isArray(response.content)) {
                inventory = response.content;
            } else if (response && Array.isArray(response.inventories)) {
                inventory = response.inventories;
            } else if (response && typeof response === 'object') {
                inventory = [response];
            } else {
                console.warn('⚠️ Unexpected inventory response format:', response);
                inventory = [];
            }

            // Filtrer les items nulls ou invalides
            inventory = inventory.filter(item => item && item.id);

            console.log(`✅ Loaded ${inventory.length} inventory items`);

        } catch (error) {
            console.warn('⚠️ Inventory load warning:', error.message);
            inventory = [];
        }

        // ⭐ ÉTAPE 3: Enrichir chaque item avec le nom de la culture
        inventory.forEach(item => {
            if (item.cropId && cropsMap[item.cropId]) {
                item.cropName = cropsMap[item.cropId];
            } else {
                item.cropName = 'Unknown Crop';
                console.warn(`⚠️ Crop not found for inventory ${item.id}, cropId: ${item.cropId}`);
            }
        });

        // Mise à jour des statistiques
        updateInventoryStats(inventory);

        // Affichage des données
        displayInventoryGrid(inventory);
        displayInventoryAlerts(inventory);

    } catch (error) {
        console.error('❌ Inventory load error:', error);
        showToast('Unable to load inventory data', 'warning');

        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Unable to load inventory</p>
                <button class="btn btn-primary mt-4" onclick="loadInventoryData()">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;
    } finally {
        hideLoading();
    }
}

/**
 * Update inventory statistics - VERSION SÉCURISÉE
 */
function updateInventoryStats(inventory) {
    if (!Array.isArray(inventory)) {
        console.warn('⚠️ Invalid inventory array');
        inventory = [];
    }

    const totalItems = inventory.length;

    const totalQuantity = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.currentQuantity) || 0), 0
    );

    const totalValue = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.totalMarketValue) || 0), 0
    );

    const alertsCount = calculateAlertsCount(inventory);

    // Mise à jour des éléments UI avec vérification
    updateElement('invTotalItems', totalItems);
    updateElement('invTotalQuantity', `${totalQuantity.toFixed(2)} KG`);
    updateElement('invTotalValue', formatCurrency(totalValue));
    updateElement('invAlerts', alertsCount);

    console.log('📊 Inventory Stats:', {
        items: totalItems,
        quantity: totalQuantity.toFixed(2),
        value: totalValue.toFixed(2),
        alerts: alertsCount
    });
}

/**
 * Calculate alerts count - VERSION SÉCURISÉE
 */
function calculateAlertsCount(inventory) {
    if (!Array.isArray(inventory) || inventory.length === 0) {
        return 0;
    }

    const today = new Date();
    let alertsCount = 0;

    inventory.forEach(item => {
        try {
            // Alerte pour les articles expirés ou expirant bientôt
            if (item.expiryDate) {
                const expiry = new Date(item.expiryDate);
                if (!isNaN(expiry.getTime())) {
                    const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil <= 30) {
                        alertsCount++;
                    }
                }
            }

            // Alerte pour stock faible
            const available = parseFloat(item.availableQuantity) || 0;
            const current = parseFloat(item.currentQuantity) || 0;
            if (current > 0 && available < current * 0.2) {
                alertsCount++;
            }

        } catch (error) {
            console.error('Error calculating alert for item:', item.id, error);
        }
    });

    return alertsCount;
}





/**
 * Display inventory grid - VERSION AMÉLIORÉE
 */
function displayInventoryGrid(inventory) {
    const container = document.getElementById('inventoryGrid');
    if (!container) return;

    if (!inventory || inventory.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-box"></i>
                <p>No inventory items yet</p>
                <button class="btn btn-primary" onclick="openAddInventoryModal()">
                    <i class="fas fa-plus"></i>
                    Add First Item
                </button>
            </div>
        `;
        return;
    }

    const inventoryHTML = inventory.map(item => {
        const cropName = item.cropName || 'Unknown Crop';
        const currentQty = parseFloat(item.currentQuantity) || 0;
        const availableQty = parseFloat(item.availableQuantity) || 0;
        const unit = item.unit || 'KG';
        const qualityGrade = item.qualityGrade || 'N/A';
        const status = item.status || 'AVAILABLE';
        const totalValue = parseFloat(item.totalMarketValue) || 0;
        const expiryDate = item.expiryDate ? formatDate(item.expiryDate) : 'N/A';

        return `
            <div class="inventory-card">
                <div class="inventory-header">
                    <h3 class="inventory-title">${cropName}</h3>
                    <span class="inventory-status status-${status.toLowerCase()}">${status}</span>
                </div>
                <div class="inventory-details">
                    <div class="inventory-detail-item">
                        <label>Code:</label>
                        <span>${item.inventoryCode || 'N/A'}</span>
                    </div>
                    <div class="inventory-detail-item">
                        <label>Quantity:</label>
                        <span>${currentQty.toFixed(2)} ${unit}</span>
                    </div>
                    <div class="inventory-detail-item">
                        <label>Available:</label>
                        <span>${availableQty.toFixed(2)} ${unit}</span>
                    </div>
                    <div class="inventory-detail-item">
                        <label>Quality:</label>
                        <span class="quality-badge quality-${qualityGrade.toLowerCase()}">${qualityGrade}</span>
                    </div>
                    <div class="inventory-detail-item">
                        <label>Value:</label>
                        <span>${formatCurrency(totalValue)}</span>
                    </div>
                    ${expiryDate !== 'N/A' ? `
                    <div class="inventory-detail-item">
                        <label>Expires:</label>
                        <span>${expiryDate}</span>
                    </div>
                    ` : ''}
                </div>
                <div class="inventory-actions">
                    <button class="btn btn-secondary btn-sm" onclick="viewInventoryDetails('${item.id}')">
                        <i class="fas fa-eye"></i>
                        View
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="editInventory('${item.id}')">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteInventory('${item.id}', '${cropName}')">
                        <i class="fas fa-trash"></i>
                        Delete
                    </button>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = inventoryHTML;
}






/**
 * Display inventory alerts - VERSION CORRIGÉE
 */
function displayInventoryAlerts(inventory) {
    const container = document.getElementById('inventoryAlerts');
    if (!container) return;

    const today = new Date();
    const alerts = [];

    inventory.forEach(item => {
        if (!item || !item.expiryDate) return;

        try {
            const expiry = new Date(item.expiryDate);
            if (isNaN(expiry.getTime())) {
                console.warn('Invalid expiry date for item:', item.id);
                return;
            }

            const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));

            if (daysUntil <= 0) {
                alerts.push({
                    level: 'critical',
                    icon: 'fa-exclamation-triangle',
                    message: `${item.cropName || 'Unknown item'} has expired`,
                    item: item
                });
            } else if (daysUntil <= 7) {
                alerts.push({
                    level: 'high',
                    icon: 'fa-exclamation-circle',
                    message: `${item.cropName || 'Unknown item'} expires in ${daysUntil} days`,
                    item: item
                });
            } else if (daysUntil <= 30) {
                alerts.push({
                    level: 'medium',
                    icon: 'fa-clock',
                    message: `${item.cropName || 'Unknown item'} expires in ${daysUntil} days`,
                    item: item
                });
            }
        } catch (error) {
            console.error('Error processing expiry date for item:', item.id, error);
        }

        // Low stock alerts
        try {
            const available = parseFloat(item.availableQuantity) || 0;
            const current = parseFloat(item.currentQuantity) || 0;

            if (current > 0 && available < current * 0.2) {
                alerts.push({
                    level: 'medium',
                    icon: 'fa-box',
                    message: `Low stock: ${item.cropName || 'Unknown item'} (${available} ${item.unit || 'units'} remaining)`,
                    item: item
                });
            }
        } catch (error) {
            console.error('Error processing stock levels for item:', item.id, error);
        }
    });

    if (alerts.length === 0) {
        container.innerHTML = '';
        return;
    }

    container.innerHTML = `
        <div class="alerts-banner">
            <h4><i class="fas fa-bell"></i> Inventory Alerts</h4>
            <div class="alerts-list">
                ${alerts.map(alert => `
                    <div class="alert-item alert-${alert.level}">
                        <i class="fas ${alert.icon}"></i>
                        <span>${alert.message}</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}



/**
 * ============================================
 * INVENTORY MODAL FUNCTIONS
 * ============================================
 */

/**
 * Open Add Inventory Modal
 */
async function openAddInventoryModal() {
    try {
        showLoading();

        // Fetch crops for dropdown
        const cropsResponse = await apiRequest('/v1/crops/all');
        const crops = Array.isArray(cropsResponse) ? cropsResponse :
                     (cropsResponse && Array.isArray(cropsResponse.data)) ? cropsResponse.data : [];

        if (crops.length === 0) {
            showToast('⚠️ No crops available. Please add crops first.', 'warning');
            hideLoading();
            return;
        }

        const modalHTML = `
            <div class="modal-overlay show" id="inventoryModal" onclick="if(event.target === this) closeInventoryModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-plus-circle"></i>
                            Add New Inventory Item
                        </h3>
                        <button class="modal-close" onclick="closeInventoryModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addInventoryForm">
                            <div class="form-grid">

                                <!-- Crop Selection -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-leaf"></i>
                                        Select Crop *
                                    </label>
                                    <select class="form-select" name="cropId" required>
                                        <option value="">Choose a crop...</option>
                                        ${crops.map(crop => `
                                            <option value="${crop.id}">${crop.cropName}</option>
                                        `).join('')}
                                    </select>
                                </div>

                                <!-- Facility Type -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-warehouse"></i>
                                        Facility Type *
                                    </label>
                                    <select class="form-select" name="facilityType" required>
                                        <option value="">Select facility...</option>
                                        <option value="FARM_STORAGE">Farm Storage</option>
                                        <option value="WAREHOUSE">Warehouse</option>
                                        <option value="SILO">Silo</option>
                                        <option value="COLD_STORAGE">Cold Storage</option>
                                    </select>
                                </div>

                                <!-- Storage Location -->
                                <div class="form-group form-group-full">
                                    <label class="form-label required">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Storage Location *
                                    </label>
                                    <input type="text" class="form-input" name="storageLocation"
                                           placeholder="e.g., Warehouse A, Section 3" required>
                                </div>

                                <!-- Current Quantity -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-balance-scale"></i>
                                        Current Quantity (KG) *
                                    </label>
                                    <input type="number" class="form-input" name="currentQuantity"
                                           step="0.01" min="0.01" placeholder="e.g., 1000" required>
                                </div>

                                <!-- Quality Grade -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-star"></i>
                                        Quality Grade *
                                    </label>
                                    <select class="form-select" name="qualityGrade" required>
                                        <option value="">Select quality...</option>
                                        <option value="PREMIUM">Premium</option>
                                        <option value="GRADE_A">Grade A</option>
                                        <option value="GRADE_B">Grade B</option>
                                        <option value="STANDARD">Standard</option>
                                    </select>
                                </div>

                                <!-- Market Value Per Unit -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-money-bill-wave"></i>
                                        Market Value per KG (RWF)
                                    </label>
                                    <input type="number" class="form-input" name="marketValuePerUnit"
                                           step="0.01" min="0" placeholder="e.g., 500">
                                </div>

                                <!-- Storage Date -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-calendar"></i>
                                        Storage Date *
                                    </label>
                                    <input type="date" class="form-input" name="storageDate"
                                           value="${new Date().toISOString().split('T')[0]}" required>
                                </div>

                                <!-- Expected Shelf Life -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-clock"></i>
                                        Expected Shelf Life (days)
                                    </label>
                                    <input type="number" class="form-input" name="expectedShelfLifeDays"
                                           min="1" placeholder="e.g., 90">
                                </div>

                                <!-- Certifications -->
                                <div class="form-group form-group-full">
                                    <label class="form-checkbox">
                                        <input type="checkbox" name="organicCertified">
                                        <span>Organic Certified</span>
                                    </label>
                                    <label class="form-checkbox">
                                        <input type="checkbox" name="fairTradeCertified">
                                        <span>Fair Trade Certified</span>
                                    </label>
                                </div>

                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeInventoryModal()">
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Save Inventory
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

        // Add form submit handler
        const form = document.getElementById('addInventoryForm');
        if (form) {
            form.addEventListener('submit', handleAddInventory);
        }

    } catch (error) {
        console.error('❌ Error opening add inventory modal:', error);
        showToast('Error opening form', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Handle Add Inventory Form Submit
 */
async function handleAddInventory(e) {
    e.preventDefault();

    const formData = new FormData(e.target);

    const inventoryData = {
        cropId: formData.get('cropId'),
        farmerId: currentUser.id,
        facilityType: formData.get('facilityType'),
        storageLocation: formData.get('storageLocation').trim(),
        currentQuantity: parseFloat(formData.get('currentQuantity')),
        qualityGrade: formData.get('qualityGrade'),
        marketValuePerUnit: formData.get('marketValuePerUnit') ? parseFloat(formData.get('marketValuePerUnit')) : null,
        storageDate: formData.get('storageDate'),
        expectedShelfLifeDays: formData.get('expectedShelfLifeDays') ? parseInt(formData.get('expectedShelfLifeDays')) : null,
        organicCertified: formData.get('organicCertified') === 'on',
        fairTradeCertified: formData.get('fairTradeCertified') === 'on'
    };

    // Validation
    if (!inventoryData.cropId) {
        showToast('❌ Please select a crop', 'error');
        return;
    }
    if (!inventoryData.facilityType) {
        showToast('❌ Please select facility type', 'error');
        return;
    }
    if (!inventoryData.currentQuantity || inventoryData.currentQuantity <= 0) {
        showToast('❌ Quantity must be greater than 0', 'error');
        return;
    }

    try {
        showLoading();

        console.log('📤 Submitting inventory data:', inventoryData);

        const response = await apiRequest('/v1/inventories', {
            method: 'POST',
            body: JSON.stringify(inventoryData)
        });

        console.log('✅ Inventory created:', response);
        showToast('✅ Inventory item added successfully!', 'success');

        closeInventoryModal();

        // Reload data
        setTimeout(async () => {
            await loadInventoryData();
        }, 500);

    } catch (error) {
        console.error('❌ Error adding inventory:', error);
        showToast(`❌ Error: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}









/**
 * View Inventory Details - VERSION FINALE
 */
async function viewInventoryDetails(inventoryId) {
    try {
        showLoading();

        // Charger les crops
        let cropsMap = {};
        try {
            const cropsResponse = await apiRequest('/v1/crops/all');
            let crops = [];
            if (Array.isArray(cropsResponse)) {
                crops = cropsResponse;
            } else if (cropsResponse && cropsResponse.data && Array.isArray(cropsResponse.data)) {
                crops = cropsResponse.data;
            }
            crops.forEach(crop => {
                if (crop && crop.id && crop.cropName) {
                    cropsMap[crop.id] = crop.cropName;
                }
            });
        } catch (err) {
            console.warn('Error loading crops:', err);
        }

        // Charger l'inventory
        const response = await apiRequest(`/v1/inventories/${inventoryId}`);

        let inventory = null;
        if (response && response.data && typeof response.data === 'object' && !Array.isArray(response.data)) {
            inventory = response.data;
        } else if (response && typeof response === 'object' && response.id) {
            inventory = response;
        } else {
            showToast('Unexpected data format', 'warning');
            hideLoading();
            return;
        }

        // Enrichir avec cropName
        if (inventory.cropId && cropsMap[inventory.cropId]) {
            inventory.cropName = cropsMap[inventory.cropId];
        } else if (!inventory.cropName) {
            inventory.cropName = 'Unknown Crop';
        }

        // Formater les dates
        const formatDateSafe = (dateValue) => {
            if (!dateValue) return 'N/A';
            try {
                if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}/.test(dateValue)) {
                    return new Date(dateValue).toLocaleDateString('en-GB');
                }
                if (Array.isArray(dateValue) && dateValue.length >= 3) {
                    const [year, month, day] = dateValue;
                    return new Date(year, month - 1, day).toLocaleDateString('en-GB');
                }
                return new Date(dateValue).toLocaleDateString('en-GB');
            } catch (error) {
                return 'N/A';
            }
        };

        // Formater les booléens
        const formatBooleanSafe = (boolValue) => {
            if (boolValue === true || boolValue === 'true') return '✅ Yes';
            return '❌ No';
        };

        // Préparer les valeurs d'affichage
        const displayValues = {
            inventoryCode: inventory.inventoryCode || 'N/A',
            cropName: inventory.cropName,
            facilityType: inventory.facilityType || 'N/A',
            storageLocation: inventory.storageLocation || 'N/A',
            currentQuantity: inventory.currentQuantity ? `${parseFloat(inventory.currentQuantity).toFixed(2)} ${inventory.unit || 'KG'}` : 'N/A',
            availableQuantity: inventory.availableQuantity ? `${parseFloat(inventory.availableQuantity).toFixed(2)} ${inventory.unit || 'KG'}` : 'N/A',
            qualityGrade: inventory.qualityGrade || 'N/A',
            status: inventory.status || 'AVAILABLE',
            totalMarketValue: formatCurrency(parseFloat(inventory.totalMarketValue) || 0),
            storageDate: formatDateSafe(inventory.storageDate),
            expiryDate: inventory.expiryDate ? formatDateSafe(inventory.expiryDate) : null,
            organicCertified: formatBooleanSafe(inventory.organicCertified),
            fairTradeCertified: formatBooleanSafe(inventory.fairTradeCertified)
        };

        // Créer le modal HTML (SANS debug panel)
        const modalHTML = `
            <div class="modal-overlay show" id="inventoryDetailsModal" onclick="if(event.target === this) closeInventoryDetailsModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-info-circle"></i>
                            Inventory Details
                        </h3>
                        <button class="modal-close" onclick="closeInventoryDetailsModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Inventory Code</label>
                                <value>${displayValues.inventoryCode}</value>
                            </div>

                            <div class="detail-item">
                                <label>Crop</label>
                                <value>${displayValues.cropName}</value>
                            </div>

                            <div class="detail-item">
                                <label>Facility Type</label>
                                <value>${displayValues.facilityType}</value>
                            </div>

                            <div class="detail-item">
                                <label>Storage Location</label>
                                <value>${displayValues.storageLocation}</value>
                            </div>

                            <div class="detail-item">
                                <label>Current Quantity</label>
                                <value>${displayValues.currentQuantity}</value>
                            </div>

                            <div class="detail-item">
                                <label>Available Quantity</label>
                                <value>${displayValues.availableQuantity}</value>
                            </div>

                            <div class="detail-item">
                                <label>Quality Grade</label>
                                <value>${displayValues.qualityGrade}</value>
                            </div>

                            <div class="detail-item">
                                <label>Status</label>
                                <value><span class="status-badge status-${displayValues.status.toLowerCase()}">${displayValues.status}</span></value>
                            </div>

                            <div class="detail-item">
                                <label>Total Market Value</label>
                                <value>${displayValues.totalMarketValue}</value>
                            </div>

                            <div class="detail-item">
                                <label>Storage Date</label>
                                <value>${displayValues.storageDate}</value>
                            </div>

                            ${displayValues.expiryDate ? `
                            <div class="detail-item">
                                <label>Expiry Date</label>
                                <value>${displayValues.expiryDate}</value>
                            </div>
                            ` : ''}

                            <div class="detail-item">
                                <label>Organic Certified</label>
                                <value>${displayValues.organicCertified}</value>
                            </div>

                            <div class="detail-item">
                                <label>Fair Trade Certified</label>
                                <value>${displayValues.fairTradeCertified}</value>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeInventoryDetailsModal()">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                        <button type="button" class="btn btn-primary" onclick="closeInventoryDetailsModal(); setTimeout(() => editInventory('${inventory.id}'), 350)">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

    } catch (error) {
        console.error('Error loading details:', error);
        showToast('Error loading details', 'error');
    } finally {
        hideLoading();
    }
}


/**
 * Close Inventory Details Modal
 */
function closeInventoryDetailsModal() {
    console.log('🔒 [MODAL] Closing inventory details modal');
    const modal = document.getElementById('inventoryDetailsModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
            console.log('✅ [MODAL] Closed and cleared');
        }, 300);
    }
}


/**
 * ============================================
 * TESTS UNITAIRES / DEBUG
 * ============================================
 */

/**
 * Test Date Formatting
 */
function testDateFormatting() {
    console.log('🧪 [TEST] Testing date formatting...');

    const testCases = [
        { input: '2024-01-15', expected: '15/01/2024' },
        { input: [2024, 1, 15], expected: '15/01/2024' },
        { input: new Date(2024, 0, 15), expected: '15/01/2024' },
        { input: null, expected: 'N/A' },
        { input: undefined, expected: 'N/A' },
        { input: '', expected: 'N/A' }
    ];

    testCases.forEach((test, index) => {
        const result = formatDateSafe(test.input);
        const passed = result === test.expected;
        console.log(`  Test ${index + 1}: ${passed ? '✅' : '❌'} Input: ${JSON.stringify(test.input)} → Output: ${result} (Expected: ${test.expected})`);
    });
}

/**
 * Test Boolean Formatting
 */
function testBooleanFormatting() {
    console.log('🧪 [TEST] Testing boolean formatting...');

    const testCases = [
        { input: true, expected: '✅ Yes' },
        { input: false, expected: '❌ No' },
        { input: 'true', expected: '✅ Yes' },
        { input: 'false', expected: '❌ No' },
        { input: null, expected: '❌ No' },
        { input: undefined, expected: '❌ No' }
    ];

    testCases.forEach((test, index) => {
        const result = formatBooleanSafe(test.input);
        const passed = result === test.expected;
        console.log(`  Test ${index + 1}: ${passed ? '✅' : '❌'} Input: ${JSON.stringify(test.input)} → Output: ${result} (Expected: ${test.expected})`);
    });
}




/**
 * Edit Inventory - VERSION CORRIGÉE
 * Extraction du wrapper + fermeture du modal Details avant d'ouvrir Edit
 */
async function editInventory(inventoryId) {
    try {
        // ⭐ Fermer tous les modals ouverts AVANT de faire quoi que ce soit
        document.getElementById('modalContainer').innerHTML = '';

        showLoading();

        const response = await apiRequest(`/v1/inventories/${inventoryId}`);
        console.log('📦 Raw edit response:', response);

        // ⭐ Extraire l'objet inventory depuis le wrapper de réponse
        let inventory = null;
        if (response && response.data && typeof response.data === 'object' && !Array.isArray(response.data)) {
            inventory = response.data;
        } else if (response && typeof response === 'object' && response.id) {
            inventory = response;
        } else {
            console.warn('⚠️ Format inattendu dans editInventory:', response);
            showToast('Unexpected data format', 'warning');
            hideLoading();
            return;
        }

        console.log('✅ Inventory loaded for edit:', inventory);

        const modalHTML = `
            <div class="modal-overlay show" id="inventoryModal" onclick="if(event.target === this) closeInventoryModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-edit"></i>
                            Edit Inventory
                        </h3>
                        <button class="modal-close" onclick="closeInventoryModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editInventoryForm" data-inventory-id="${inventory.id}">
                            <div class="form-grid">

                                <div class="form-group">
                                    <label class="form-label">Current Quantity (KG)</label>
                                    <input type="number" class="form-input" name="currentQuantity"
                                           value="${inventory.currentQuantity || ''}" step="0.01" min="0.01" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Quality Grade</label>
                                    <select class="form-select" name="qualityGrade" required>
                                        <option value="PREMIUM" ${inventory.qualityGrade === 'PREMIUM' ? 'selected' : ''}>Premium</option>
                                        <option value="GRADE_A" ${inventory.qualityGrade === 'GRADE_A' ? 'selected' : ''}>Grade A</option>
                                        <option value="GRADE_B" ${inventory.qualityGrade === 'GRADE_B' ? 'selected' : ''}>Grade B</option>
                                        <option value="STANDARD" ${inventory.qualityGrade === 'STANDARD' ? 'selected' : ''}>Standard</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Market Value per KG (RWF)</label>
                                    <input type="number" class="form-input" name="marketValuePerUnit"
                                           value="${inventory.marketValuePerUnit || ''}" step="0.01" min="0">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Storage Location</label>
                                    <input type="text" class="form-input" name="storageLocation"
                                           value="${inventory.storageLocation || ''}" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" name="status" required>
                                        <option value="AVAILABLE" ${inventory.status === 'AVAILABLE' ? 'selected' : ''}>Available</option>
                                        <option value="RESERVED" ${inventory.status === 'RESERVED' ? 'selected' : ''}>Reserved</option>
                                        <option value="SOLD" ${inventory.status === 'SOLD' ? 'selected' : ''}>Sold</option>
                                        <option value="EXPIRED" ${inventory.status === 'EXPIRED' ? 'selected' : ''}>Expired</option>
                                    </select>
                                </div>

                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeInventoryModal()">
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Update Inventory
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        // ⭐ Petit delay pour s'assurer que le DOM est propre avant d'insérer
        await new Promise(resolve => setTimeout(resolve, 50));

        document.getElementById('modalContainer').innerHTML = modalHTML;

        const form = document.getElementById('editInventoryForm');
        if (form) {
            form.addEventListener('submit', handleEditInventory);
            console.log('✅ Edit form listener attached');
        } else {
            console.error('❌ editInventoryForm not found after injection');
        }

    } catch (error) {
        console.error('❌ Error loading inventory for editing:', error);
        showToast('Error loading inventory', 'error');
    } finally {
        hideLoading();
    }
}



/**
 * Handle Edit Inventory Submit - VERSION CORRIGÉE
 * Utilise PATCH au lieu de PUT + ne envoie que les champs modifiés
 */
async function handleEditInventory(e) {
    e.preventDefault();

    const inventoryId = e.target.dataset.inventoryId;
    const formData = new FormData(e.target);

    // ⭐ Récupérer les valeurs actuelles depuis les attributs data- du formulaire
    const originalStatus = e.target.dataset.originalStatus;
    const originalQualityGrade = e.target.dataset.originalQualityGrade;

    const newStatus = formData.get('status');
    const newQualityGrade = formData.get('qualityGrade');

    // ⭐ Construire le payload avec UNIQUEMENT les champs qui ont changé
    const updateData = {};

    const currentQuantity = formData.get('currentQuantity');
    if (currentQuantity) {
        updateData.currentQuantity = parseFloat(currentQuantity);
    }

    if (newQualityGrade && newQualityGrade !== originalQualityGrade) {
        updateData.qualityGrade = newQualityGrade;
    }

    const marketValuePerUnit = formData.get('marketValuePerUnit');
    if (marketValuePerUnit) {
        updateData.marketValuePerUnit = parseFloat(marketValuePerUnit);
    }

    const storageLocation = formData.get('storageLocation');
    if (storageLocation) {
        updateData.storageLocation = storageLocation.trim();
    }

    // ⭐ Status : n'envoyer QUE si ça a vraiment changé
    if (newStatus && newStatus !== originalStatus) {
        updateData.status = newStatus;
    }

    // ⭐ Vérifier qu'il y a au moins un champ à mettre à jour
    if (Object.keys(updateData).length === 0) {
        showToast('Nothing to update', 'info');
        closeInventoryModal();
        return;
    }

    try {
        showLoading();

        console.log('📤 Updating inventory (PATCH):', updateData);

        // ⭐ PATCH au lieu de PUT — envoie uniquement les champs modifiés
        const response = await apiRequest(`/v1/inventories/${inventoryId}`, {
            method: 'PATCH',
            body: JSON.stringify(updateData)
        });

        console.log('✅ Inventory updated:', response);
        showToast('✅ Inventory updated successfully!', 'success');

        closeInventoryModal();

        setTimeout(async () => {
            await loadInventoryData();
        }, 500);

    } catch (error) {
        console.error('❌ Error updating inventory:', error);
        showToast(`❌ Error: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}





/**
 * Delete Inventory
 */
async function deleteInventory(inventoryId, cropName) {
    if (!confirm(`Are you sure you want to delete "${cropName}" inventory?\n\nThis action cannot be undone.`)) {
        return;
    }

    try {
        showLoading();

        await apiRequest(`/v1/inventories/${inventoryId}`, {
            method: 'DELETE'
        });

        showToast('✅ Inventory deleted successfully!', 'success');

        // Reload data
        await loadInventoryData();

    } catch (error) {
        console.error('❌ Error deleting inventory:', error);
        showToast(`❌ Error: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Close Inventory Modal
 */
function closeInventoryModal() {
    const modal = document.getElementById('inventoryModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}

/**
 * Close Inventory Details Modal
 */
function closeInventoryDetailsModal() {
    const modal = document.getElementById('inventoryDetailsModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}








/**
 * ============================================
 * INVENTORY EVENT LISTENERS
 * ============================================
 */

/**
 * Initialize Inventory Event Listeners
 */
function initializeInventoryEventListeners() {
    console.log('🚀 Initializing Inventory Event Listeners...');

    // Add Stock Button
    const addStockBtn = document.querySelector('[data-action="add-inventory"]');
    if (addStockBtn) {
        addStockBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('🖱️ Add inventory button clicked');
            openAddInventoryModal();
        });
    }

    // Refresh Button
    const refreshBtn = document.querySelector('[data-action="refresh-inventory"]');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('🔄 Refresh inventory button clicked');
            loadInventoryData();
        });
    }

    // Export Button
    const exportBtn = document.querySelector('[data-action="export-inventory"]');
    if (exportBtn) {
        exportBtn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('📥 Export inventory button clicked');
            exportInventoryToCSV();
        });
    }

    // Filter Buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const filterType = this.dataset.filter;
            const filterValue = this.dataset.value;
            filterInventory(filterType, filterValue);
        });
    });

    // Clear Filters Button
    const clearFiltersBtn = document.querySelector('[data-action="clear-inventory-filters"]');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', (e) => {
            e.preventDefault();
            clearInventoryFilters();
        });
    }

    console.log('✅ Inventory event listeners initialized');
}

/**
 * Filter Inventory Items
 */
function filterInventory(filterType, filterValue) {
    console.log(`🔍 Filtering inventory by ${filterType}: ${filterValue}`);

    const cards = document.querySelectorAll('.inventory-card');

    cards.forEach(card => {
        const status = card.querySelector('.inventory-status')?.textContent.trim().toUpperCase();
        const quality = card.querySelector('.quality-badge')?.textContent.trim().toUpperCase();

        let shouldShow = true;

        if (filterType === 'status' && filterValue !== 'all') {
            shouldShow = status === filterValue.toUpperCase();
        }

        if (filterType === 'quality' && filterValue !== 'all') {
            shouldShow = quality === filterValue.toUpperCase();
        }

        if (shouldShow) {
            card.style.display = '';
            card.style.animation = 'fadeIn 0.3s ease';
        } else {
            card.style.display = 'none';
        }
    });

    // Update active filter button
    document.querySelectorAll(`.filter-btn[data-filter="${filterType}"]`).forEach(btn => {
        btn.classList.toggle('active', btn.dataset.value === filterValue);
    });
}

/**
 * Clear Inventory Filters
 */
function clearInventoryFilters() {
    console.log('🧹 Clearing inventory filters...');

    // Show all cards
    document.querySelectorAll('.inventory-card').forEach(card => {
        card.style.display = '';
    });

    // Remove active class from filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Set "All" buttons as active
    document.querySelectorAll('.filter-btn[data-value="all"]').forEach(btn => {
        btn.classList.add('active');
    });

    showToast('Filters cleared', 'info');
}




async function exportFarmsToExcel() {
    try {
        showLoading();

        // ⭐ ÉTAPE 1: Vérifier que SheetJS est chargé
        if (typeof XLSX === 'undefined') {
            console.error('❌ SheetJS not loaded');
            showToast('❌ Excel library not loaded. Please refresh the page.', 'error');
            hideLoading();
            return;
        }

        // ⭐ ÉTAPE 2: Récupérer les farms depuis l'API
        if (!currentUser || !currentUser.id) {
            showToast('⚠️ No user session found', 'warning');
            hideLoading();
            return;
        }

        const response = await apiRequest(`/farms/farmer/${currentUser.id}/all`);

        let farms = [];
        if (Array.isArray(response)) {
            farms = response;
        } else if (response && response.data && Array.isArray(response.data)) {
            farms = response.data;
        } else if (response && response.content && Array.isArray(response.content)) {
            farms = response.content;
        }

        if (farms.length === 0) {
            showToast('⚠️ No farms to export', 'warning');
            hideLoading();
            return;
        }

        console.log(`📤 Exporting ${farms.length} farms to Excel...`);

        // ⭐ ÉTAPE 3: Transformer les données en format tableau
        const headers = [
            'Farm Name',
            'Farm Code',
            'Size (Hectares)',
            'Location',
            'Latitude',
            'Longitude',
            'Altitude (m)',
            'Soil Type',
            'Irrigation System',
            'Topography',
            'Water Source',
            'Road Access Quality',
            'Electricity Available',
            'Created Date'
        ];

        const rows = farms.map(farm => [
            farm.farmName || '',
            farm.farmCode || '',
            parseFloat(farm.farmSize) || 0,
            farm.location || '',
            parseFloat(farm.latitude) || 0,
            parseFloat(farm.longitude) || 0,
            farm.altitude !== null && farm.altitude !== undefined ? parseFloat(farm.altitude) : '',
            farm.soilType || '',
            formatIrrigationLabel(farm.irrigationSystem),
            farm.topography || '',
            farm.waterSource || '',
            farm.roadAccessQuality || '',
            farm.electricityAvailable ? 'Yes' : 'No',
            farm.createdAt ? new Date(farm.createdAt).toLocaleDateString('en-GB') : ''
        ]);

        // ⭐ ÉTAPE 4: Créer le workbook avec SheetJS
        const wb = XLSX.utils.book_new();

        // --- Sheet 1: Farms Data ---
        const sheetData = [headers, ...rows];
        const ws = XLSX.utils.aoa_to_sheet(sheetData);

        // Ajuster les largeurs de colonnes automatiquement
        const colWidths = headers.map((header, i) => {
            const headerLen = header.length;
            const maxDataLen = rows.reduce((max, row) => {
                const cellVal = row[i] !== null && row[i] !== undefined ? String(row[i]) : '';
                return Math.max(max, cellVal.length);
            }, 0);
            return { wch: Math.max(headerLen, maxDataLen) + 4 }; // +4 padding
        });
        ws['!cols'] = colWidths;

        // Styler le header (row 1) - fond vert, texte blanc, gras
        const headerStyle = {
            font: { bold: true, color: { rgb: 'FFFFFF' }, name: 'Arial', sz: 11 },
            fill: { fgColor: { rgb: '2E7D32' } },
            alignment: { horizontal: 'center', vertical: 'center', wrapText: true },
            border: {
                top: { style: 'thin', color: { rgb: 'FFFFFF' } },
                bottom: { style: 'thin', color: { rgb: 'FFFFFF' } },
                left: { style: 'thin', color: { rgb: 'FFFFFF' } },
                right: { style: 'thin', color: { rgb: 'FFFFFF' } }
            }
        };

        // Styler les données (alternating rows)
        const dataStyleEven = {
            font: { name: 'Arial', sz: 10, color: { rgb: '212121' } },
            fill: { fgColor: { rgb: 'FFFFFF' } },
            border: {
                top: { style: 'thin', color: { rgb: 'E0E0E0' } },
                bottom: { style: 'thin', color: { rgb: 'E0E0E0' } },
                left: { style: 'thin', color: { rgb: 'E0E0E0' } },
                right: { style: 'thin', color: { rgb: 'E0E0E0' } }
            }
        };

        const dataStyleOdd = {
            font: { name: 'Arial', sz: 10, color: { rgb: '212121' } },
            fill: { fgColor: { rgb: 'F5F5F5' } },
            border: {
                top: { style: 'thin', color: { rgb: 'E0E0E0' } },
                bottom: { style: 'thin', color: { rgb: 'E0E0E0' } },
                left: { style: 'thin', color: { rgb: 'E0E0E0' } },
                right: { style: 'thin', color: { rgb: 'E0E0E0' } }
            }
        };

        const numericStyle = (baseStyle) => ({
            ...baseStyle,
            alignment: { ...baseStyle.alignment, horizontal: 'right' }
        });

        // Appliquer les styles cellule par cellule
        const totalCols = headers.length;
        const totalRows = sheetData.length;

        for (let row = 0; row < totalRows; row++) {
            for (let col = 0; col < totalCols; col++) {
                const cellRef = XLSX.utils.encode_cell({ c: col, r: row });
                if (!ws[cellRef]) continue;

                if (row === 0) {
                    // Header row
                    ws[cellRef].s = headerStyle;
                } else {
                    // Data rows - alternating colors
                    let style = row % 2 === 0 ? dataStyleOdd : dataStyleEven;

                    // Colonnes numériques: Size, Lat, Lng, Altitude → aligner à droite
                    if (col === 2 || col === 4 || col === 5 || col === 6) {
                        style = { ...style, alignment: { horizontal: 'right' } };
                    }

                    ws[cellRef].s = style;
                }
            }
        }

        // Freeze le header (première ligne figée)
        ws['!freeze'] = { x: 0, y: 1 };

        XLSX.utils.book_append_sheet(wb, ws, 'Farms');

        // --- Sheet 2: Summary ---
        const totalArea = farms.reduce((sum, f) => sum + (parseFloat(f.farmSize) || 0), 0);
        const irrigatedCount = farms.filter(f => f.irrigationSystem && f.irrigationSystem !== 'RAIN_FED').length;
        const electricityCount = farms.filter(f => f.electricityAvailable).length;

        const soilCounts = {};
        farms.forEach(f => {
            const soil = f.soilType || 'Unknown';
            soilCounts[soil] = (soilCounts[soil] || 0) + 1;
        });

        const irrigationCounts = {};
        farms.forEach(f => {
            const irr = formatIrrigationLabel(f.irrigationSystem);
            irrigationCounts[irr] = (irrigationCounts[irr] || 0) + 1;
        });

        const summaryData = [
            ['FARM SUMMARY REPORT'],
            ['Generated on:', new Date().toLocaleString('en-GB')],
            [''],
            ['--- General Statistics ---'],
            ['Total Farms', farms.length],
            ['Total Area (ha)', totalArea],
            ['Average Farm Size (ha)', totalArea / farms.length],
            ['Irrigated Farms', irrigatedCount],
            ['Farms with Electricity', electricityCount],
            [''],
            ['--- Soil Type Distribution ---'],
            ['Soil Type', 'Count'],
            ...Object.entries(soilCounts).map(([soil, count]) => [soil, count]),
            [''],
            ['--- Irrigation System Distribution ---'],
            ['Irrigation Type', 'Count'],
            ...Object.entries(irrigationCounts).map(([irr, count]) => [irr, count])
        ];

        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        wsSummary['!cols'] = [{ wch: 32 }, { wch: 22 }];

        // Styler le titre
        if (wsSummary['A1']) {
            wsSummary['A1'].s = {
                font: { bold: true, sz: 14, color: { rgb: '2E7D32' }, name: 'Arial' },
                alignment: { horizontal: 'left' }
            };
        }

        // Styler les section headers (les lignes qui commencent par ---)
        summaryData.forEach((row, idx) => {
            const cellRef = XLSX.utils.encode_cell({ c: 0, r: idx });
            if (ws[cellRef] && String(row[0]).startsWith('---')) {
                if (wsSummary[cellRef]) {
                    wsSummary[cellRef].s = {
                        font: { bold: true, sz: 11, color: { rgb: '1565C0' }, name: 'Arial' }
                    };
                }
            }
        });

        XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');

        // ⭐ ÉTAPE 5: Télécharger le fichier
        const fileName = `Farms_Export_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);

        console.log(`✅ Exported ${farms.length} farms to ${fileName}`);
        showToast(`✅ Exported ${farms.length} farms to Excel successfully!`, 'success');

    } catch (error) {
        console.error('❌ Error exporting farms to Excel:', error);
        showToast('❌ Error exporting farms: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Helper: formate le label de l'irrigation system
 */
function formatIrrigationLabel(system) {
    const labels = {
        'RAIN_FED': 'Rain Fed',
        'SPRINKLER': 'Sprinkler',
        'DRIP': 'Drip Irrigation',
        'FLOOD': 'Flood Irrigation',
        'MANUAL': 'Manual'
    };
    return labels[system] || system || 'N/A';
}

/**
 * Export Inventory to CSV
 */
async function exportInventoryToCSV() {
    try {
        showLoading();

        const response = await apiRequest(`/v1/inventories/farmer/${currentUser.id}`);
        let inventory = [];

        if (Array.isArray(response)) {
            inventory = response;
        } else if (response && response.data && Array.isArray(response.data)) {
            inventory = response.data;
        } else if (response && response.content && Array.isArray(response.content)) {
            inventory = response.content;
        }

        if (inventory.length === 0) {
            showToast('⚠️ No inventory data to export', 'warning');
            hideLoading();
            return;
        }

        // CSV Headers
        const headers = [
            'Inventory Code', 'Crop', 'Facility Type', 'Storage Location',
            'Current Quantity', 'Available Quantity', 'Unit', 'Quality Grade',
            'Status', 'Market Value', 'Storage Date', 'Expiry Date',
            'Organic', 'Fair Trade', 'Created Date'
        ];

        // CSV Rows
        const rows = inventory.map(item => [
            item.inventoryCode || '',
            item.cropName || 'Unknown',
            item.facilityType || '',
            item.storageLocation || '',
            item.currentQuantity || 0,
            item.availableQuantity || 0,
            item.unit || 'KG',
            item.qualityGrade || '',
            item.status || '',
            item.totalMarketValue || 0,
            item.storageDate || '',
            item.expiryDate || '',
            item.organicCertified ? 'Yes' : 'No',
            item.fairTradeCertified ? 'Yes' : 'No',
            item.createdDate || ''
        ]);

        // Create CSV content
        let csvContent = headers.join(',') + '\n';
        rows.forEach(row => {
            csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
        });

        // Create download link
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `inventory_export_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        window.URL.revokeObjectURL(url);

        showToast('✅ Inventory exported successfully!', 'success');

    } catch (error) {
        console.error('❌ Error exporting inventory:', error);
        showToast('❌ Error exporting inventory', 'error');
    } finally {
        hideLoading();
    }
}













async function loadFertilizerData() {
    try {
        showLoading();

        if (!currentUser || !currentUser.id) {
            console.warn('⚠️ No current user found');
            displayEmptyFertilizerData();
            return;
        }

        const farmerId = currentUser.id;
        console.log('🔄 Loading fertilizer data for farmer:', farmerId);

        // TEST: Appeler l'endpoint de test d'abord
        const testResponse = await apiRequest(`/fertilizer-usages/test/farmer/${farmerId}`);
        console.log('🧪 TEST RESPONSE:', testResponse);

        // Utiliser la vraie réponse
        let fertilizers = testResponse.allFertilizers || [];

        console.log(`📊 Total fertilizers found: ${fertilizers.length}`);

        if (fertilizers.length === 0) {
            displayEmptyFertilizerData();
            return;
        }

        // Enrichir les données avec les informations de crop production
        const enrichedFertilizers = await Promise.all(fertilizers.map(async (fert) => {
            try {
                if (fert.cropProductionId && !fert.cropProductionName) {
                    try {
                        const cropProdResponse = await apiRequest(`/v1/crop-productions/${fert.cropProductionId}`);
                        const cropProd = cropProdResponse.data || cropProdResponse;
                        
                        // Récupérer le nom du crop
                        if (cropProd.cropId) {
                            try {
                                const cropResponse = await apiRequest(`/v1/crops/${cropProd.cropId}`);
                                const crop = cropResponse.data || cropResponse;
                                fert.cropProductionName = crop.cropName || crop.name || cropProd.productionCode || 'Unknown Crop';
                            } catch (error) {
                                console.warn(`Error fetching crop ${cropProd.cropId}:`, error);
                                fert.cropProductionName = cropProd.productionCode || 'Unknown Production';
                            }
                        } else {
                            fert.cropProductionName = cropProd.productionCode || 'Unknown Production';
                        }
                    } catch (error) {
                        console.warn(`Error fetching crop production ${fert.cropProductionId}:`, error);
                        fert.cropProductionName = 'Unknown Production';
                    }
                }
            } catch (error) {
                console.warn('Error enriching fertilizer:', error);
            }
            return fert;
        }));

        const stats = calculateFertilizerStatistics(enrichedFertilizers);
        updateFertilizerStatistics(stats);
        displayFertilizerTable(enrichedFertilizers);
        createFertilizerCharts(enrichedFertilizers);

    } catch (error) {
        console.error('❌ Error:', error);
        displayEmptyFertilizerData();
    } finally {
        hideLoading();
    }
}

// ============================================================
// STATISTICS CALCULATION
// ============================================================

function calculateFertilizerStatistics(fertilizers) {
    console.log('🔢 Calculating statistics for', fertilizers.length, 'fertilizers');

    const totalApplications = fertilizers.length;

    const totalQuantity = fertilizers.reduce((sum, f) => {
        const qty = parseFloat(f.quantity) || 0;
        return sum + qty;
    }, 0);

    const totalCost = fertilizers.reduce((sum, f) => {
        const cost = parseFloat(f.totalCost) || 0;
        return sum + cost;
    }, 0);

    const ratedFertilizers = fertilizers.filter(f =>
        f.effectivenessRating && f.effectivenessRating > 0);

    const avgEffectiveness = ratedFertilizers.length > 0
        ? ratedFertilizers.reduce((sum, f) =>
            sum + (parseFloat(f.effectivenessRating) || 0), 0) / ratedFertilizers.length
        : 0;

    // Groupement par type
    const byType = {};
    fertilizers.forEach(f => {
        const type = f.fertilizerType || 'UNKNOWN';
        if (!byType[type]) {
            byType[type] = { count: 0, quantity: 0, cost: 0 };
        }
        byType[type].count++;
        byType[type].quantity += parseFloat(f.quantity) || 0;
        byType[type].cost += parseFloat(f.totalCost) || 0;
    });

    // Fertilizers expirant bientôt
    const now = new Date();
    const threeMonthsLater = new Date();
    threeMonthsLater.setMonth(now.getMonth() + 3);

    const expiringSoon = fertilizers.filter(f => {
        if (!f.expiryDate) return false;
        const expiryDate = new Date(f.expiryDate);
        return expiryDate > now && expiryDate <= threeMonthsLater;
    }).length;

    const expired = fertilizers.filter(f => {
        if (!f.expiryDate) return false;
        return new Date(f.expiryDate) < now;
    }).length;

    return {
        totalApplications,
        totalQuantity,
        totalCost,
        avgEffectiveness,
        byType,
        expiringSoon,
        expired,
        ratedCount: ratedFertilizers.length
    };
}

// ============================================================
// UI UPDATE FUNCTIONS
// ============================================================

function updateFertilizerStatistics(stats) {
    console.log('📊 Updating UI with stats:', stats);

    updateElement('fertTotalApplications', stats.totalApplications);
    updateElement('fertTotalQuantity', `${stats.totalQuantity.toFixed(2)} KG`);
    updateElement('fertTotalCost', formatCurrency(stats.totalCost));
    updateElement('fertAvgEffectiveness',
        stats.avgEffectiveness > 0 ? `${stats.avgEffectiveness.toFixed(1)}/5` : 'N/A');

    // Statistiques additionnelles si éléments disponibles
    if (document.getElementById('fertExpiringSoon')) {
        updateElement('fertExpiringSoon', stats.expiringSoon);
    }
    if (document.getElementById('fertExpired')) {
        updateElement('fertExpired', stats.expired);
    }
    if (document.getElementById('fertRatedCount')) {
        updateElement('fertRatedCount', stats.ratedCount);
    }
}







// ============================================================
// STATISTICS CALCULATION
// ============================================================

function calculateFertilizerStatistics(fertilizers) {
    console.log('🔢 Calculating statistics for', fertilizers.length, 'fertilizers');

    const totalApplications = fertilizers.length;

    const totalQuantity = fertilizers.reduce((sum, f) => {
        const qty = parseFloat(f.quantity) || 0;
        return sum + qty;
    }, 0);

    const totalCost = fertilizers.reduce((sum, f) => {
        const cost = parseFloat(f.totalCost) || 0;
        return sum + cost;
    }, 0);

    const ratedFertilizers = fertilizers.filter(f =>
        f.effectivenessRating && f.effectivenessRating > 0);

    const avgEffectiveness = ratedFertilizers.length > 0
        ? ratedFertilizers.reduce((sum, f) =>
            sum + (parseFloat(f.effectivenessRating) || 0), 0) / ratedFertilizers.length
        : 0;

    // Groupement par type
    const byType = {};
    fertilizers.forEach(f => {
        const type = f.fertilizerType || 'UNKNOWN';
        if (!byType[type]) {
            byType[type] = { count: 0, quantity: 0, cost: 0 };
        }
        byType[type].count++;
        byType[type].quantity += parseFloat(f.quantity) || 0;
        byType[type].cost += parseFloat(f.totalCost) || 0;
    });

    // Fertilizers expirant bientôt
    const now = new Date();
    const threeMonthsLater = new Date();
    threeMonthsLater.setMonth(now.getMonth() + 3);

    const expiringSoon = fertilizers.filter(f => {
        if (!f.expiryDate) return false;
        const expiryDate = new Date(f.expiryDate);
        return expiryDate > now && expiryDate <= threeMonthsLater;
    }).length;

    const expired = fertilizers.filter(f => {
        if (!f.expiryDate) return false;
        return new Date(f.expiryDate) < now;
    }).length;

    return {
        totalApplications,
        totalQuantity,
        totalCost,
        avgEffectiveness,
        byType,
        expiringSoon,
        expired,
        ratedCount: ratedFertilizers.length
    };
}

// ============================================================
// UI UPDATE FUNCTIONS
// ============================================================

function updateFertilizerStatistics(stats) {
    console.log('📊 Updating UI with stats:', stats);

    updateElement('fertTotalApplications', stats.totalApplications);
    updateElement('fertTotalQuantity', `${stats.totalQuantity.toFixed(2)} KG`);
    updateElement('fertTotalCost', formatCurrency(stats.totalCost));
    updateElement('fertAvgEffectiveness',
        stats.avgEffectiveness > 0 ? `${stats.avgEffectiveness.toFixed(1)}/5` : 'N/A');

    // Statistiques additionnelles si éléments disponibles
    if (document.getElementById('fertExpiringSoon')) {
        updateElement('fertExpiringSoon', stats.expiringSoon);
    }
    if (document.getElementById('fertExpired')) {
        updateElement('fertExpired', stats.expired);
    }
    if (document.getElementById('fertRatedCount')) {
        updateElement('fertRatedCount', stats.ratedCount);
    }
}

function displayFertilizerTable(fertilizers) {
    console.log('📊 Displaying fertilizers in table:', fertilizers.length);

    const tableBody = document.getElementById('fertilizerTableBody');
    if (!tableBody) {
        console.error('❌ Fertilizer table body element not found');
        return;
    }

    if (fertilizers.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4" style="padding: 3rem 2rem;">
                    <div class="text-muted">
                        <i class="fas fa-seedling" style="font-size: 4rem; color: #ddd; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p style="font-size: 1.1rem; color: #666; margin-bottom: 0.5rem;">No fertilizer applications recorded yet</p>
                        <p style="font-size: 0.9rem; color: #999; margin-bottom: 1.5rem;">Start tracking your fertilizer usage to optimize your crop production</p>
                        <button class="btn btn-primary btn-sm" onclick="showAddFertilizerModal()" style="padding: 0.75rem 1.5rem; border-radius: 8px;">
                            <i class="fas fa-plus"></i> Add First Application
                        </button>
                    </div>
                </td>
            </tr>
        `;
        return;
    }





    // Afficher tous les fertilizers avec toutes les colonnes correctement alignées
    const rows = fertilizers.map((fert, index) => {
        console.log(`Row ${index}:`, fert);

        // Format crop production name
        const cropProductionName = fert.cropProductionName ||
                                   fert.cropProduction?.cropName ||
                                   fert.cropProduction?.productionCode ||
                                   fert.cropProductionId ||
                                   'N/A';

        // Format date
        const applicationDate = formatDate(fert.applicationDate);
        const expiryDate = fert.expiryDate ? formatDate(fert.expiryDate) : null;

        // Format quantity with unit
        const quantity = formatQuantity(fert.quantity, fert.unit);

        // Format cost
        const totalCost = formatCurrency(fert.totalCost || 0);
        const costPerUnit = fert.costPerUnit ? formatCurrency(fert.costPerUnit) : null;
        const unit = fert.unit || 'KG';

        // Format effectiveness
        const effectiveness = formatEffectiveness(fert.effectivenessRating);

        return `
        <tr data-id="${fert.id || index}" style="transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#f8f9fa';" onmouseout="this.style.backgroundColor='transparent';">
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 600; color: #333; margin-bottom: 0.25rem;">
                    <i class="fas fa-calendar-alt" style="color: var(--primary-green); margin-right: 0.5rem;"></i>
                    ${applicationDate}
                </div>
                ${expiryDate ? `<small style="color: #999; font-size: 0.85rem;">Exp: ${expiryDate}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 600; color: #333;">
                    <i class="fas fa-seedling" style="color: var(--primary-green); margin-right: 0.5rem;"></i>
                    ${escapeHtml(cropProductionName)}
                </div>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <span class="badge" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">
                    ${getFertilizerTypeLabel(fert.fertilizerType)}
                </span>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 600; color: #333; margin-bottom: 0.25rem;">
                    ${escapeHtml(fert.fertilizerName || 'N/A')}
                </div>
                ${fert.brand ? `<small style="color: #666; font-size: 0.85rem;">Brand: ${escapeHtml(fert.brand)}</small>` : ''}
                ${fert.composition ? `<br><small style="color: #3b82f6; font-size: 0.85rem;">${escapeHtml(fert.composition)}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 700; color: #333; font-size: 1rem;">
                    ${quantity}
                </div>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <span class="badge" style="background: linear-gradient(135deg, #64748b, #475569); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">
                    ${getApplicationMethodLabel(fert.applicationMethod)}
                </span>
                ${fert.applicationStage ? `<br><small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">${escapeHtml(fert.applicationStage)}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 700; color: var(--primary-green); font-size: 1rem; margin-bottom: 0.25rem;">
                    ${totalCost}
                </div>
                ${costPerUnit ? `<small style="color: #666; font-size: 0.85rem;">${costPerUnit}/${unit}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                ${effectiveness}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="btn-icon" onclick="viewFertilizerDetails('${fert.id}')" title="View Details" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#3b82f6'; this.style.color='white';" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'; this.style.color='#3b82f6';">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-icon" onclick="editFertilizer('${fert.id}')" title="Edit" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f59e0b'; this.style.color='white';" onmouseout="this.style.background='rgba(245, 158, 11, 0.1)'; this.style.color='#f59e0b';">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon" onclick="deleteFertilizer('${fert.id}')" title="Delete" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ef4444'; this.style.color='white';" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.color='#ef4444';">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
    }).join('');

    tableBody.innerHTML = rows;
    console.log('✅ Table populated with', fertilizers.length, 'rows');
}

function displayEmptyFertilizerData() {
    console.log('📊 Displaying empty fertilizer state');

    // Réinitialiser les statistiques
    updateElement('fertTotalApplications', 0);
    updateElement('fertTotalQuantity', '0.00 KG');
    updateElement('fertTotalCost', formatCurrency(0));
    updateElement('fertAvgEffectiveness', 'N/A');

    // Afficher message vide dans le tableau
    const tableBody = document.getElementById('fertilizerTableBody');
    if (tableBody) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-5">
                    <div class="text-muted">
                        <i class="fas fa-seedling fa-4x mb-3 opacity-50"></i>
                        <h5>No Fertilizer Data Available</h5>
                        <p>Start tracking your fertilizer applications to optimize your crop production</p>
                        <button class="btn btn-primary mt-3" onclick="showAddFertilizerModal()">
                            <i class="fas fa-plus"></i> Add Fertilizer Application
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }

    // Réinitialiser les graphiques de manière sûre
    safeDestroyChart('fertilizerCostChart');
    safeDestroyChart('fertilizerTypeChart');
    safeDestroyChart('fertilizerEffectivenessChart');
}

// ============================================================
// CHART CREATION
// ============================================================

function createFertilizerCharts(fertilizers) {
    console.log('📈 Creating fertilizer charts');
    try {
        createFertilizerCostChart(fertilizers);
        createFertilizerTypeChart(fertilizers);
        createFertilizerEffectivenessChart(fertilizers);
    } catch (error) {
        console.error('❌ Error creating charts:', error);
    }
}

function createFertilizerCostChart(fertilizers) {
    const ctx = document.getElementById('fertilizerCostChart');
    if (!ctx) {
        console.warn('⚠️ fertilizerCostChart canvas not found');
        return;
    }

    safeDestroyChart('fertilizerCostChart');

    // Grouper par mois
    const monthlyData = {};
    fertilizers.forEach(f => {
        if (!f.applicationDate) return;

        try {
            const date = new Date(f.applicationDate);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

            if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = { cost: 0, count: 0, quantity: 0 };
            }
            monthlyData[monthKey].cost += parseFloat(f.totalCost) || 0;
            monthlyData[monthKey].count++;
            monthlyData[monthKey].quantity += parseFloat(f.quantity) || 0;
        } catch (e) {
            console.warn('Invalid date:', f.applicationDate);
        }
    });

    const sortedMonths = Object.keys(monthlyData).sort();
    const labels = sortedMonths.map(m => {
        const [year, month] = m.split('-');
        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    });
    const costs = sortedMonths.map(m => monthlyData[m].cost);

    window.fertilizerCostChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Monthly Fertilizer Cost',
                data: costs,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                borderWidth: 2,
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true },
                tooltip: {
                    callbacks: {
                        label: (context) => `Cost: ${formatCurrency(context.parsed.y)}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: (value) => formatCurrency(value)
                    }
                }
            }
        }
    });

    console.log('✅ Cost chart created');
}

function createFertilizerTypeChart(fertilizers) {
    const ctx = document.getElementById('fertilizerTypeChart');
    if (!ctx) {
        console.warn('⚠️ fertilizerTypeChart canvas not found');
        return;
    }

    safeDestroyChart('fertilizerTypeChart');

    // Grouper par type
    const typeData = {};
    fertilizers.forEach(f => {
        const type = f.fertilizerType || 'UNKNOWN';
        if (!typeData[type]) {
            typeData[type] = { count: 0, cost: 0 };
        }
        typeData[type].count++;
        typeData[type].cost += parseFloat(f.totalCost) || 0;
    });

    const labels = Object.keys(typeData).map(getFertilizerTypeLabel);
    const data = Object.keys(typeData).map(k => typeData[k].count);

    window.fertilizerTypeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#28a745', '#17a2b8', '#ffc107',
                    '#dc3545', '#6f42c1', '#fd7e14'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: (context) => {
                            const type = Object.keys(typeData)[context.dataIndex];
                            return `${context.label}: ${context.parsed} applications (${formatCurrency(typeData[type].cost)})`;
                        }
                    }
                }
            }
        }
    });

    console.log('✅ Type chart created');
}

function createFertilizerEffectivenessChart(fertilizers) {
    const ctx = document.getElementById('fertilizerEffectivenessChart');
    if (!ctx) {
        console.warn('⚠️ fertilizerEffectivenessChart canvas not found');
        return;
    }

    safeDestroyChart('fertilizerEffectivenessChart');

    // Grouper par note d'efficacité
    const ratingData = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    fertilizers.forEach(f => {
        if (f.effectivenessRating && f.effectivenessRating >= 1 && f.effectivenessRating <= 5) {
            ratingData[f.effectivenessRating]++;
        }
    });

    window.fertilizerEffectivenessChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
            datasets: [{
                label: 'Number of Applications',
                data: Object.values(ratingData),
                backgroundColor: [
                    '#dc3545', '#fd7e14', '#ffc107', '#28a745', '#20c997'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });

    console.log('✅ Effectiveness chart created');
}

// ============================================================
// HELPER FUNCTIONS
// ============================================================

function getFertilizerTypeLabel(type) {
    const labels = {
        'ORGANIC': 'Organic',
        'NPK': 'NPK',
        'NITROGEN': 'Nitrogen',
        'PHOSPHATE': 'Phosphate',
        'POTASH': 'Potash',
        'MICRONUTRIENTS': 'Micronutrients'
    };
    return labels[type] || type || 'Unknown';
}

function getApplicationMethodLabel(method) {
    const labels = {
        'BROADCAST': 'Broadcast',
        'BAND': 'Band',
        'FOLIAR': 'Foliar',
        'FERTIGATION': 'Fertigation',
        'SPOT': 'Spot'
    };
    return labels[method] || method || 'N/A';
}

function formatQuantity(quantity, unit) {
    if (!quantity) return 'N/A';
    const unitLabels = {
        'KG': 'kg',
        'TONNES': 't',
        'LITERS': 'L',
        'BAGS': 'bags'
    };
    return `${parseFloat(quantity).toFixed(2)} ${unitLabels[unit] || unit || ''}`;
}

function formatEffectiveness(rating) {
    if (!rating) return '<span class="text-muted">Not rated</span>';

    const stars = '★'.repeat(rating) + '☆'.repeat(5 - rating);
    const colors = ['', 'text-danger', 'text-warning', 'text-info', 'text-success', 'text-success'];

    return `<span class="${colors[rating]}" title="Rating: ${rating}/5">${stars}</span>`;
}

// ============================================================
// SAFE CHART DESTRUCTION
// ============================================================

function safeDestroyChart(chartName) {
    try {
        if (window[chartName] && typeof window[chartName].destroy === 'function') {
            window[chartName].destroy();
            window[chartName] = null;
            console.log(`✅ Chart destroyed: ${chartName}`);
        }
    } catch (error) {
        console.warn(`⚠️ Error destroying chart ${chartName}:`, error);
        window[chartName] = null;
    }
}

function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    } else {
        console.warn(`⚠️ Element not found: ${id}`);
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================
// MODAL FUNCTIONS
// ============================================================

function showAddFertilizerModal() {
    console.log('Opening add fertilizer modal...');
    // Si vous avez un modal Bootstrap
    const modal = document.getElementById('addFertilizerModal');
    if (modal) {
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    } else {
        showToast('Add fertilizer modal not implemented yet', 'info');
    }
}

function viewFertilizerDetails(id) {
    console.log('Viewing fertilizer details:', id);
    // Implémenter selon votre structure
    showToast('View details feature - To be implemented', 'info');
}

function editFertilizer(id) {
    console.log('Editing fertilizer:', id);
    showToast('Edit feature - To be implemented', 'info');
}

async function deleteFertilizer(id) {
    if (!confirm('Are you sure you want to delete this fertilizer application?')) {
        return;
    }

    try {
        showLoading();
        await apiRequest(`/fertilizer-usages/${id}`, 'DELETE');
        showToast('Fertilizer application deleted successfully', 'success');
        await loadFertilizerData(); // Recharger les données
    } catch (error) {
        console.error('Error deleting fertilizer:', error);
        showToast('Failed to delete fertilizer application', 'error');
    } finally {
        hideLoading();
    }
}

// ============================================================
// UTILITY FUNCTIONS
// ============================================================

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    } catch (e) {
        return dateString;
    }
}

function formatCurrency(amount) {
    if (amount === null || amount === undefined) return 'RWF 0.00';
    try {
        return new Intl.NumberFormat('en-RW', {
            style: 'currency',
            currency: 'RWF',
            minimumFractionDigits: 0
        }).format(amount);
    } catch (e) {
        return `RWF ${parseFloat(amount).toFixed(2)}`;
    }
}

function showToast(message, type = 'info') {
    console.log(`Toast [${type}]:`, message);
    // Implémenter selon votre système de notifications
    if (typeof displayToast === 'function') {
        displayToast(message, type);
    }
}

function showLoading() {
    const loader = document.getElementById('pageLoader');
    if (loader) loader.style.display = 'flex';
}

function hideLoading() {
    const loader = document.getElementById('pageLoader');
    if (loader) loader.style.display = 'none';
}

// ============================================================
// INITIALIZATION
// ============================================================

console.log('✅ Fertilizer management script loaded');

// Auto-load si sur la page fertilizer
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('fertilizerTableBody')) {
            console.log('🚀 Auto-loading fertilizer data...');
            setTimeout(() => loadFertilizerData(), 500);
        }
    });
} else {
    if (document.getElementById('fertilizerTableBody')) {
        console.log('🚀 Loading fertilizer data immediately...');
        setTimeout(() => loadFertilizerData(), 500);
    }
}


/**
 * Debug function to test fertilizer data loading
 */
async function debugFertilizerData() {
    console.log('=== DEBUG FERTILIZER DATA ===');
    console.log('Current User:', currentUser);

    if (!currentUser) {
        console.error('❌ No current user');
        return;
    }

    // Test direct API call
    try {
        const response = await fetch(`http://localhost:1010/api/fertilizer-usages/farmer/${currentUser.id}`);
        const data = await response.json();
        console.log('📡 Direct API Response:', data);

        // Test all fertilizer records
        const allFertilizers = await apiRequest('/fertilizer-usages');
        console.log('📦 All Fertilizers:', allFertilizers);

    } catch (error) {
        console.error('❌ Debug API Error:', error);
    }
}

// Appelez cette fonction dans la console du navigateur pour déboguer
window.debugFertilizerData = debugFertilizerData;





function displayFertilizerTable(fertilizers) {
    console.log('📊 Displaying fertilizers in table:', fertilizers.length);

    const tableBody = document.getElementById('fertilizerTableBody');
    if (!tableBody) {
        console.error('❌ Fertilizer table body element not found');
        return;
    }

    if (fertilizers.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4" style="padding: 3rem 2rem;">
                    <div class="text-muted">
                        <i class="fas fa-seedling" style="font-size: 4rem; color: #ddd; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p style="font-size: 1.1rem; color: #666; margin-bottom: 0.5rem;">No fertilizer applications recorded yet</p>
                        <p style="font-size: 0.9rem; color: #999; margin-bottom: 1.5rem;">Start tracking your fertilizer usage to optimize your crop production</p>
                        <button class="btn btn-primary btn-sm" onclick="showAddFertilizerModal()" style="padding: 0.75rem 1.5rem; border-radius: 8px;">
                            <i class="fas fa-plus"></i> Add First Application
                        </button>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    // Afficher tous les fertilizers avec toutes les colonnes correctement alignées
    const rows = fertilizers.map((fert, index) => {
        console.log(`Row ${index}:`, fert);

        // Format crop production name
        const cropProductionName = fert.cropProductionName ||
                                   fert.cropProduction?.cropName ||
                                   fert.cropProduction?.productionCode ||
                                   fert.cropProductionId ||
                                   'N/A';

        // Format date
        const applicationDate = formatDate(fert.applicationDate);
        const expiryDate = fert.expiryDate ? formatDate(fert.expiryDate) : null;

        // Format quantity with unit
        const quantity = formatQuantity(fert.quantity, fert.unit);

        // Format cost
        const totalCost = formatCurrency(fert.totalCost || 0);
        const costPerUnit = fert.costPerUnit ? formatCurrency(fert.costPerUnit) : null;
        const unit = fert.unit || 'KG';

        // Format effectiveness
        const effectiveness = formatEffectiveness(fert.effectivenessRating);

        return `
        <tr data-id="${fert.id || index}" style="transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#f8f9fa';" onmouseout="this.style.backgroundColor='transparent';">
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 600; color: #333; margin-bottom: 0.25rem;">
                    <i class="fas fa-calendar-alt" style="color: var(--primary-green); margin-right: 0.5rem;"></i>
                    ${applicationDate}
                </div>
                ${expiryDate ? `<small style="color: #999; font-size: 0.85rem;">Exp: ${expiryDate}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 600; color: #333;">
                    <i class="fas fa-seedling" style="color: var(--primary-green); margin-right: 0.5rem;"></i>
                    ${escapeHtml(cropProductionName)}
                </div>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <span class="badge" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">
                    ${getFertilizerTypeLabel(fert.fertilizerType)}
                </span>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 600; color: #333; margin-bottom: 0.25rem;">
                    ${escapeHtml(fert.fertilizerName || 'N/A')}
                </div>
                ${fert.brand ? `<small style="color: #666; font-size: 0.85rem;">Brand: ${escapeHtml(fert.brand)}</small>` : ''}
                ${fert.composition ? `<br><small style="color: #3b82f6; font-size: 0.85rem;">${escapeHtml(fert.composition)}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 700; color: #333; font-size: 1rem;">
                    ${quantity}
                </div>
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <span class="badge" style="background: linear-gradient(135deg, #64748b, #475569); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem;">
                    ${getApplicationMethodLabel(fert.applicationMethod)}
                </span>
                ${fert.applicationStage ? `<br><small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">${escapeHtml(fert.applicationStage)}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="font-weight: 700; color: var(--primary-green); font-size: 1rem; margin-bottom: 0.25rem;">
                    ${totalCost}
                </div>
                ${costPerUnit ? `<small style="color: #666; font-size: 0.85rem;">${costPerUnit}/${unit}</small>` : ''}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                ${effectiveness}
            </td>
            <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button class="btn-icon" onclick="viewFertilizerDetails('${fert.id}')" title="View Details" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#3b82f6'; this.style.color='white';" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'; this.style.color='#3b82f6';">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-icon" onclick="editFertilizer('${fert.id}')" title="Edit" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#f59e0b'; this.style.color='white';" onmouseout="this.style.background='rgba(245, 158, 11, 0.1)'; this.style.color='#f59e0b';">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon" onclick="deleteFertilizer('${fert.id}')" title="Delete" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#ef4444'; this.style.color='white';" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.color='#ef4444';">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `;
    }).join('');

    tableBody.innerHTML = rows;
    console.log('✅ Table populated with', fertilizers.length, 'rows');
}













/**
 * Open Add Fertilizer Modal - FIXED VERSION WITH CORRECT PRODUCTION LOADING
 */
async function openAddFertilizerModal() {
    try {
        showLoading();

        console.log('🔓 Opening fertilizer modal...');

        // ✅ Vérifier l'utilisateur
        if (!currentUser || !currentUser.id) {
            showToast('❌ No user logged in', 'error');
            hideLoading();
            return;
        }

        console.log('👤 Current user (Farmer ID):', currentUser.id);



// ✅ CORRECTION PRINCIPALE: Récupérer TOUTES les productions du farmer
let allProductions = [];

try {
    console.log('🔄 Fetching productions for farmer:', currentUser.id);

    // Essayer plusieurs endpoints possibles
    let prodResponse;

    // Essayer d'abord l'endpoint principal
    try {
        prodResponse = await apiRequest(`/v1/crop-productions/farmer/${currentUser.id}`);
        console.log('📦 Main productions endpoint response:', prodResponse);
    } catch (error1) {
        console.log('⚠️ Main endpoint failed, trying alternative...');
        // Essayer l'endpoint alternatif
        try {
            prodResponse = await apiRequest(`/v1/crop-productions/by-farmer/${currentUser.id}`);
            console.log('📦 Alternative productions endpoint response:', prodResponse);
        } catch (error2) {
            console.log('⚠️ Alternative endpoint failed, trying farm-based approach...');
            // Dernière tentative: récupérer via les fermes
            const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
            const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

            if (farms.length > 0) {
                const productionPromises = farms.map(farm =>
                    apiRequest(`/v1/crop-productions/farm/${farm.id}`).catch(() => [])
                );
                const productionArrays = await Promise.all(productionPromises);
                prodResponse = productionArrays.flat();
                console.log('📦 Farm-based productions response:', prodResponse);
            } else {
                prodResponse = [];
            }
        }
    }

    console.log('🌾 Raw Productions Response:', prodResponse);

    // Extraire les productions selon le format de réponse
    if (prodResponse) {
        if (Array.isArray(prodResponse)) {
            allProductions = prodResponse;
        } else if (prodResponse.data && Array.isArray(prodResponse.data)) {
            allProductions = prodResponse.data;
        } else if (prodResponse.content && Array.isArray(prodResponse.content)) {
            allProductions = prodResponse.content;
        } else if (prodResponse.success && Array.isArray(prodResponse.data)) {
            allProductions = prodResponse.data;
        } else {
            console.warn('⚠️ Unexpected production response format:', prodResponse);
            allProductions = [];
        }
    }

    console.log('🌾 Productions extracted:', allProductions.length);

    // Filtrer pour ne garder que les productions valides
    allProductions = allProductions.filter(p => {
        const isValid = p && p.id && (p.cropName || p.cropId);
        if (!isValid) {
            console.warn('⚠️ Invalid production filtered out:', p);
        }
        return isValid;
    });

    console.log('✅ Valid productions after filter:', allProductions.length);

    // Afficher les détails des productions pour debug
    allProductions.forEach((prod, index) => {
        console.log(`📝 Production ${index + 1}:`, {
            id: prod.id,
            cropName: prod.cropName,
            productionCode: prod.productionCode,
            status: prod.productionStatus
        });
    });

} catch (err) {
    console.error('❌ Error loading productions:', err);
    allProductions = [];

    // Afficher l'erreur spécifique
    showToast('⚠️ Could not load crop productions. Please check your connection.', 'warning');
}

console.log('🌾 Total valid productions loaded:', allProductions.length);



        // ✅ Créer le modal HTML
        const modalHTML = `
            <div class="modal-overlay show" id="fertilizerModal">
                <div class="modal-container modal-large" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <h3 class="modal-title">
                            <i class="fas fa-flask"></i>
                            Record Fertilizer Usage
                        </h3>
                        <button class="modal-close" onclick="closeFertilizerModal()" type="button"
                                style="color: white; opacity: 0.9;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="modal-body" style="padding: 25px;">
                        <form id="addFertilizerForm">
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">

                                <!-- Crop Production -->
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-seedling" style="color: #10b981;"></i>
                                        Crop Production *
                                    </label>
                                    ${allProductions.length === 0 ? `
                                        <div style="padding: 15px; background-color: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; margin-bottom: 10px;">
                                            <p style="margin: 0; color: #92400e; font-weight: 500;">
                                                ⚠️ No crop productions available. Please add a crop production first.
                                            </p>
                                            <button type="button" onclick="window.location.href='#productions'"
                                                    style="margin-top: 10px; padding: 8px 15px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                                <i class="fas fa-plus"></i> Add Crop Production
                                            </button>
                                        </div>
                                    ` : ''}
                                    <select class="form-select" name="cropProductionId" ${allProductions.length === 0 ? 'disabled' : 'required'}
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                        <option value="">Select Production...</option>
${allProductions.map(prod => {
    // Récupérer le vrai nom du crop
    const displayName = prod.cropName || prod.cropProductionName || `Production ${prod.productionCode || prod.id}`;
    const season = prod.season ? prod.season.replace('SEASON_', '') : '';
    const status = prod.productionStatus || prod.status || '';

    return `
        <option value="${prod.id}">
            ${displayName} - ${season} ${prod.year || ''} (${status})
        </option>
    `;
}).join('')}
                                    </select>
                                </div>

                                <!-- Fertilizer Type -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-tags" style="color: #10b981;"></i>
                                        Fertilizer Type *
                                    </label>
                                    <select class="form-select" name="fertilizerType" required
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Select Type...</option>
                                        <option value="ORGANIC">🌱 Organic</option>
                                        <option value="NPK">🔬 NPK</option>
                                        <option value="NITROGEN">💨 Nitrogen</option>
                                        <option value="PHOSPHATE">🧪 Phosphate</option>
                                        <option value="POTASH">💎 Potash</option>
                                        <option value="MICRONUTRIENTS">⚗️ Micronutrients</option>
                                    </select>
                                </div>

                                <!-- Fertilizer Name -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-signature" style="color: #10b981;"></i>
                                        Fertilizer Name *
                                    </label>
                                    <input type="text" class="form-input" name="fertilizerName"
                                           placeholder="e.g., Urea, DAP, Compost" required maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Brand -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-trademark" style="color: #10b981;"></i>
                                        Brand
                                    </label>
                                    <input type="text" class="form-input" name="brand"
                                           placeholder="e.g., Yara, Omex" maxlength="50"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Composition -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-microscope" style="color: #10b981;"></i>
                                        Composition (NPK)
                                    </label>
                                    <input type="text" class="form-input" name="composition"
                                           placeholder="e.g., 10-20-10" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Quantity -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-balance-scale" style="color: #10b981;"></i>
                                        Quantity *
                                    </label>
                                    <input type="number" class="form-input" name="quantity" id="fertQuantity"
                                           step="0.01" min="0.01" placeholder="e.g., 50.00" required
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Unit -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-ruler" style="color: #10b981;"></i>
                                        Unit *
                                    </label>
                                    <select class="form-select" name="unit" required
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Select Unit...</option>
                                        <option value="KG" selected>KG (Kilograms)</option>
                                        <option value="TONNES">Tonnes</option>
                                        <option value="LITERS">Liters</option>
                                        <option value="BAGS">Bags</option>
                                    </select>
                                </div>

                                <!-- Application Date -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-calendar" style="color: #10b981;"></i>
                                        Application Date *
                                    </label>
                                    <input type="date" class="form-input" name="applicationDate"
                                           value="${new Date().toISOString().split('T')[0]}"
                                           max="${new Date().toISOString().split('T')[0]}" required
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Application Method -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-spray-can" style="color: #10b981;"></i>
                                        Application Method *
                                    </label>
                                    <select class="form-select" name="applicationMethod" required
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Select Method...</option>
                                        <option value="BROADCAST">📡 Broadcast</option>
                                        <option value="BAND">🎯 Band</option>
                                        <option value="FOLIAR">🌿 Foliar</option>
                                        <option value="FERTIGATION">💧 Fertigation</option>
                                        <option value="SPOT">📍 Spot</option>
                                    </select>
                                </div>

                                <!-- Application Stage -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-layer-group" style="color: #10b981;"></i>
                                        Application Stage
                                    </label>
                                    <input type="text" class="form-input" name="applicationStage"
                                           placeholder="e.g., PLANTING, FLOWERING" maxlength="50"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Cost Per Unit -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-money-bill-wave" style="color: #10b981;"></i>
                                        Cost Per Unit (RWF)
                                    </label>
                                    <input type="number" class="form-input" name="costPerUnit" id="fertCostPerUnit"
                                           step="0.01" min="0" placeholder="e.g., 1500.00"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Total Cost (auto-calculated) -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-calculator" style="color: #10b981;"></i>
                                        Total Cost (RWF)
                                    </label>
                                    <input type="number" class="form-input" name="totalCost" id="fertTotalCost"
                                           step="0.01" min="0" placeholder="Auto-calculated" readonly
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; background-color: #f9fafb;">
                                </div>

                                <!-- Supplier -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-building" style="color: #10b981;"></i>
                                        Supplier
                                    </label>
                                    <input type="text" class="form-input" name="supplier"
                                           placeholder="e.g., AgriSupply Ltd" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Batch Number -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-barcode" style="color: #10b981;"></i>
                                        Batch Number
                                    </label>
                                    <input type="text" class="form-input" name="batchNumber"
                                           placeholder="e.g., BAT-2024-001" maxlength="50"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Expiry Date -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-hourglass-end" style="color: #10b981;"></i>
                                        Expiry Date
                                    </label>
                                    <input type="date" class="form-input" name="expiryDate"
                                           min="${new Date().toISOString().split('T')[0]}"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Weather Conditions -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-cloud-sun" style="color: #10b981;"></i>
                                        Weather Conditions
                                    </label>
                                    <input type="text" class="form-input" name="weatherConditions"
                                           placeholder="e.g., Sunny, Cloudy" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Soil Conditions -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-mountain" style="color: #10b981;"></i>
                                        Soil Conditions
                                    </label>
                                    <input type="text" class="form-input" name="soilConditions"
                                           placeholder="e.g., Dry, Moist" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Operator Name -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-user-tie" style="color: #10b981;"></i>
                                        Operator Name
                                    </label>
                                    <input type="text" class="form-input" name="operatorName"
                                           placeholder="Who applied the fertilizer?" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Effectiveness Rating -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-star" style="color: #10b981;"></i>
                                        Effectiveness Rating (1-5)
                                    </label>
                                    <select class="form-select" name="effectivenessRating"
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Not rated yet</option>
                                        <option value="1">⭐ 1 - Very Poor</option>
                                        <option value="2">⭐⭐ 2 - Poor</option>
                                        <option value="3">⭐⭐⭐ 3 - Fair</option>
                                        <option value="4">⭐⭐⭐⭐ 4 - Good</option>
                                        <option value="5">⭐⭐⭐⭐⭐ 5 - Excellent</option>
                                    </select>
                                </div>

                                <!-- Notes -->
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-sticky-note" style="color: #10b981;"></i>
                                        Notes
                                    </label>
                                    <textarea class="form-input" name="notes" rows="3"
                                              placeholder="Additional observations or remarks..." maxlength="3000"
                                              style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
                                </div>

                            </div>

                            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                <button type="button" class="btn btn-secondary" onclick="closeFertilizerModal()"
                                        style="padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-primary" ${allProductions.length === 0 ? 'disabled' : ''}
                                        style="padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; ${allProductions.length === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                    <i class="fas fa-save"></i>
                                    Save Fertilizer Usage
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        // ✅ Injecter le modal dans le DOM
        const modalContainer = document.getElementById('modalContainer');
        if (!modalContainer) {
            console.error('❌ Modal container not found!');
            showToast('❌ Error: Modal container not found', 'error');
            hideLoading();
            return;
        }

        modalContainer.innerHTML = modalHTML;

        console.log('✅ Modal HTML injected');

        // ✅ Ajouter l'event listener pour le formulaire
        const form = document.getElementById('addFertilizerForm');
        if (form) {
            form.addEventListener('submit', handleAddFertilizer);
            console.log('✅ Form submit handler attached');

            // Auto-calculate total cost
            const quantityInput = document.getElementById('fertQuantity');
            const costPerUnitInput = document.getElementById('fertCostPerUnit');
            const totalCostInput = document.getElementById('fertTotalCost');

            const calculateTotal = () => {
                const qty = parseFloat(quantityInput.value) || 0;
                const cost = parseFloat(costPerUnitInput.value) || 0;
                totalCostInput.value = (qty * cost).toFixed(2);
            };

            if (quantityInput && costPerUnitInput) {
                quantityInput.addEventListener('input', calculateTotal);
                costPerUnitInput.addEventListener('input', calculateTotal);
                console.log('✅ Cost calculation handlers attached');
            }
        } else {
            console.error('❌ Form not found after injection!');
        }

        // ✅ Forcer l'affichage du modal
        setTimeout(() => {
            const modal = document.getElementById('fertilizerModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.opacity = '1';
                console.log('✅ Modal displayed');
            }
        }, 100);

    } catch (error) {
        console.error('❌ Error opening fertilizer modal:', error);
        showToast('❌ Error loading form: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Close Fertilizer Modal
 */
function closeFertilizerModal() {
    console.log('🔒 Closing fertilizer modal...');
    const modal = document.getElementById('fertilizerModal');
    if (modal) {
        modal.classList.remove('show');
        modal.style.opacity = '0';
        setTimeout(() => {
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.innerHTML = '';
            }
            console.log('✅ Modal closed and removed');
        }, 300);
    }
}

/**
 * Handle Add Fertilizer - COMPLETE
 */
async function handleAddFertilizer(e) {
    e.preventDefault();

    console.log('📝 Submitting fertilizer form...');

    const formData = new FormData(e.target);

    const fertilizerData = {
        cropProductionId: formData.get('cropProductionId'),
        fertilizerType: formData.get('fertilizerType'),
        fertilizerName: formData.get('fertilizerName').trim(),
        brand: formData.get('brand')?.trim() || null,
        composition: formData.get('composition')?.trim() || null,
        quantity: parseFloat(formData.get('quantity')),
        unit: formData.get('unit'),
        applicationDate: formData.get('applicationDate'),
        applicationMethod: formData.get('applicationMethod'),
        applicationStage: formData.get('applicationStage')?.trim() || null,
        costPerUnit: formData.get('costPerUnit') ? parseFloat(formData.get('costPerUnit')) : null,
        totalCost: formData.get('totalCost') ? parseFloat(formData.get('totalCost')) : null,
        supplier: formData.get('supplier')?.trim() || null,
        batchNumber: formData.get('batchNumber')?.trim() || null,
        expiryDate: formData.get('expiryDate') || null,
        weatherConditions: formData.get('weatherConditions')?.trim() || null,
        soilConditions: formData.get('soilConditions')?.trim() || null,
        operatorName: formData.get('operatorName')?.trim() || null,
        effectivenessRating: formData.get('effectivenessRating') ? parseInt(formData.get('effectivenessRating')) : null,
        notes: formData.get('notes')?.trim() || null
    };

    // Validation
    if (!fertilizerData.cropProductionId) {
        showToast('❌ Please select a crop production', 'error');
        return;
    }
    if (!fertilizerData.fertilizerType) {
        showToast('❌ Please select fertilizer type', 'error');
        return;
    }
    if (!fertilizerData.quantity || fertilizerData.quantity <= 0) {
        showToast('❌ Quantity must be greater than 0', 'error');
        return;
    }

    try {
        showLoading();

        console.log('📤 Sending fertilizer data:', fertilizerData);

        const response = await apiRequest('/fertilizer-usages', {
            method: 'POST',
            body: JSON.stringify(fertilizerData)
        });

        console.log('✅ Fertilizer usage created:', response);
        showToast('✅ Fertilizer usage recorded successfully!', 'success');

        closeFertilizerModal();

        // Recharger les données
        setTimeout(async () => {
            await loadFertilizerData();
        }, 500);

    } catch (error) {
        console.error('❌ Error adding fertilizer:', error);
        showToast('❌ Error: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Initialize Fertilizer Module
 */
function initializeFertilizerModule() {
    console.log('🚀 Initializing Fertilizer Module...');

    // Action buttons
    document.querySelectorAll('[data-action="add-fertilizer"]').forEach(btn => {
        btn.removeEventListener('click', openAddFertilizerModal); // Remove old listeners
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('🖱️ Add fertilizer button clicked');
            openAddFertilizerModal();
        });
    });

    document.querySelectorAll('[data-action="refresh-fertilizer"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            loadFertilizerData();
        });
    });

    console.log('✅ Fertilizer module initialized');
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
    console.log('📄 DOM Content Loaded - Initializing...');
    setTimeout(initializeFertilizerModule, 500);
});

// Export functions
if (typeof window !== 'undefined') {
    window.openAddFertilizerModal = openAddFertilizerModal;
    window.closeFertilizerModal = closeFertilizerModal;
    window.handleAddFertilizer = handleAddFertilizer;
    window.initializeFertilizerModule = initializeFertilizerModule;
    console.log('✅ Functions exported to window');
}







      /**
      * Create fertilizer cost chart
      */
      function createFertilizerCostChart(fertilizers) {
      const ctx = document.getElementById('fertilizerCostChart');
      if (!ctx) return;

      // Group by fertilizer type
      const costByType = {};
      fertilizers.forEach(fert => {
      const type = fert.fertilizerType;
      if (!costByType[type]) {
      costByType[type] = 0;
      }
      costByType[type] += parseFloat(fert.totalCost) || 0;
      });

      if (charts.fertilizerCost) {
      charts.fertilizerCost.destroy();
      }

      charts.fertilizerCost = new Chart(ctx, {
      type: 'bar',
      data: {
      labels: Object.keys(costByType),
      datasets: [{
      label: 'Total Cost (RWF)',
      data: Object.values(costByType),
      backgroundColor: '#3b82f6',
      borderWidth: 0
      }]
      },
      options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
      legend: {
      display: false
      }
      },
      scales: {
      y: {
      beginAtZero: true,
      ticks: {
      callback: function(value) {
      return formatCurrency(value);
      }
      }
      }
      }
      }
      });
      }





/**
 * FIXED EDIT FERTILIZER FROM VIEW MODAL
 * This fixes the issue where clicking Edit opens then immediately closes
 */

/**
 * Open edit modal from view modal - FIXED VERSION
 * @param {string} fertilizerId - ID of the fertilizer to edit
 */
async function openEditFromView(fertilizerId) {
    console.log('🔄 Transitioning from view to edit modal for:', fertilizerId);

    // Step 1: Close the details modal WITHOUT clearing the container yet
    const detailsModal = document.getElementById('fertilizerDetailsModal');
    if (detailsModal) {
        detailsModal.style.opacity = '0';
    }

    // Step 2: Wait for fade out animation, then open edit modal
    setTimeout(async () => {
        // Now we can safely call editFertilizer
        await editFertilizer(fertilizerId);
    }, 350); // Wait slightly longer than the 300ms transition
}

/**
 * Updated Close Details Modal - Only clears after full transition
 */
function closeDetailsModal() {
    console.log('🔒 Closing details modal...');
    const modal = document.getElementById('fertilizerDetailsModal');
    if (modal) {
        modal.style.opacity = '0';
        setTimeout(() => {
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.innerHTML = '';
            }
            console.log('✅ Details modal closed and cleared');
        }, 300);
    }
}

/**
 * COMPLETE FIXED VIEW FERTILIZER DETAILS FUNCTION
 * With proper Edit button handler
 */
async function viewFertilizerDetails(fertilizerId) {
    try {
        showLoading();
        console.log('📋 Loading fertilizer details for:', fertilizerId);

        // Step 1: Fetch fertilizer data
        const fertilizerResponse = await apiRequest(`/fertilizer-usages/${fertilizerId}`);
        const fertilizer = fertilizerResponse.data || fertilizerResponse;

        console.log('✅ Fertilizer data loaded:', fertilizer);

        // Step 2: Fetch crop production name if not present
        let cropDisplayName = 'N/A';

        if (fertilizer.cropProductionId) {
            try {
                console.log('🔄 Fetching crop production for ID:', fertilizer.cropProductionId);

                const cropProdResponse = await apiRequest(`/v1/crop-productions/${fertilizer.cropProductionId}`);
                const cropProd = cropProdResponse.data || cropProdResponse;

                console.log('📦 Crop production data:', cropProd);

                if (cropProd.cropId) {
                    try {
                        console.log('🔄 Fetching crop details for ID:', cropProd.cropId);
                        const cropResponse = await apiRequest(`/v1/crops/${cropProd.cropId}`);
                        const crop = cropResponse.data || cropResponse;

                        console.log('🌾 Crop data:', crop);

                        const cropName = crop.cropName || crop.name || 'Unknown Crop';
                        const season = cropProd.season ? cropProd.season.replace('SEASON_', '') : '';
                        const year = cropProd.year || '';

                        cropDisplayName = `${cropName}${season ? ' - ' + season : ''}${year ? ' ' + year : ''}`;

                    } catch (cropError) {
                        console.warn('⚠️ Error fetching crop details:', cropError);
                        cropDisplayName = cropProd.productionCode || cropProd.id || 'Unknown Production';
                    }
                } else {
                    cropDisplayName = cropProd.productionCode || cropProd.id || 'Unknown Production';
                }

            } catch (prodError) {
                console.warn('⚠️ Error fetching crop production:', prodError);
                cropDisplayName = fertilizer.cropProductionId;
            }
        }

        console.log('✅ Final crop display name:', cropDisplayName);

        // Step 3: Create the modal HTML
        const detailsHTML = `
            <div class="modal-overlay show" id="fertilizerDetailsModal" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(4px);
                transition: opacity 0.3s ease;
            ">
                <div class="modal-container" style="
                    max-width: 750px;
                    max-height: 90vh;
                    overflow-y: auto;
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                    animation: slideInUp 0.3s ease-out;
                ">
                    <!-- HEADER -->
                    <div class="modal-header" style="
                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                        color: white;
                        padding: 20px 25px;
                        border-radius: 12px 12px 0 0;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    ">
                        <h3 style="
                            margin: 0;
                            font-size: 1.5rem;
                            font-weight: 700;
                            display: flex;
                            align-items: center;
                            gap: 12px;
                        ">
                            <i class="fas fa-info-circle"></i>
                            Fertilizer Application Details
                        </h3>
                        <button onclick="closeDetailsModal()" type="button" style="
                            color: white;
                            background: transparent;
                            border: none;
                            font-size: 1.5rem;
                            cursor: pointer;
                            opacity: 0.9;
                            transition: opacity 0.2s;
                            padding: 5px;
                            line-height: 1;
                        " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- BODY -->
                    <div style="padding: 25px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">

                            <!-- Production Info Card -->
                            <div style="
                                grid-column: 1 / -1;
                                padding: 18px;
                                background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                                border-radius: 10px;
                                border-left: 5px solid #3b82f6;
                                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
                            ">
                                <h4 style="
                                    margin: 0 0 12px 0;
                                    color: #1e40af;
                                    font-size: 1.1rem;
                                    font-weight: 700;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    <i class="fas fa-seedling"></i> Production Information
                                </h4>
                                <p style="margin: 8px 0; color: #334155; font-size: 0.95rem;">
                                    <strong style="color: #1e40af;">Crop:</strong>
                                    <span style="color: #10b981; font-weight: 600;">${escapeHtml(cropDisplayName)}</span>
                                </p>
                                <p style="margin: 8px 0; color: #334155; font-size: 0.95rem;">
                                    <strong style="color: #1e40af;">Production ID:</strong>
                                    <span style="font-family: monospace; background: white; padding: 2px 8px; border-radius: 4px;">${escapeHtml(fertilizer.cropProductionId || 'N/A')}</span>
                                </p>
                            </div>

                            <!-- Fertilizer Type -->
                            <div>
                                <label style="
                                    font-weight: 600;
                                    color: #64748b;
                                    font-size: 0.85rem;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    margin-bottom: 6px;
                                    display: block;
                                ">FERTILIZER TYPE</label>
                                <p style="margin: 5px 0;">
                                    <span style="
                                        background: linear-gradient(135deg, #3b82f6, #2563eb);
                                        color: white;
                                        padding: 6px 14px;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        font-size: 0.9rem;
                                        display: inline-block;
                                    ">
                                        ${getFertilizerTypeLabel(fertilizer.fertilizerType)}
                                    </span>
                                </p>
                            </div>

                            <!-- Fertilizer Name -->
                            <div>
                                <label style="
                                    font-weight: 600;
                                    color: #64748b;
                                    font-size: 0.85rem;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    margin-bottom: 6px;
                                    display: block;
                                ">FERTILIZER NAME</label>
                                <p style="margin: 5px 0; font-size: 1.05rem; color: #1e293b; font-weight: 600;">
                                    ${escapeHtml(fertilizer.fertilizerName || 'N/A')}
                                </p>
                            </div>

                            <!-- Brand -->
                            <div>
                                <label style="
                                    font-weight: 600;
                                    color: #64748b;
                                    font-size: 0.85rem;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    margin-bottom: 6px;
                                    display: block;
                                ">BRAND</label>
                                <p style="margin: 5px 0; font-size: 1rem; color: #334155;">
                                    ${fertilizer.brand ? escapeHtml(fertilizer.brand) : '<span style="color: #94a3b8;">Not specified</span>'}
                                </p>
                            </div>

                            <!-- Composition -->
                            <div>
                                <label style="
                                    font-weight: 600;
                                    color: #64748b;
                                    font-size: 0.85rem;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    margin-bottom: 6px;
                                    display: block;
                                ">COMPOSITION (NPK)</label>
                                <p style="margin: 5px 0; font-size: 1rem; color: #334155;">
                                    ${fertilizer.composition ?
                                        `<span style="background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 6px; font-weight: 600;">${escapeHtml(fertilizer.composition)}</span>`
                                        : '<span style="color: #94a3b8;">Not specified</span>'}
                                </p>
                            </div>

                            <!-- Quantity -->
                            <div>
                                <label style="
                                    font-weight: 600;
                                    color: #64748b;
                                    font-size: 0.85rem;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    margin-bottom: 6px;
                                    display: block;
                                ">QUANTITY</label>
                                <p style="margin: 5px 0; font-size: 1.3rem; font-weight: 700; color: #10b981;">
                                    <i class="fas fa-balance-scale" style="margin-right: 8px; color: #059669;"></i>
                                    ${formatQuantity(fertilizer.quantity, fertilizer.unit)}
                                </p>
                            </div>

                            <!-- Total Cost -->
                            <div>
                                <label style="
                                    font-weight: 600;
                                    color: #64748b;
                                    font-size: 0.85rem;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    margin-bottom: 6px;
                                    display: block;
                                ">TOTAL COST</label>
                                <p style="margin: 5px 0; font-size: 1.3rem; font-weight: 700; color: #10b981;">
                                    <i class="fas fa-money-bill-wave" style="margin-right: 8px; color: #059669;"></i>
                                    ${formatCurrency(fertilizer.totalCost || 0)}
                                </p>
                            </div>

                            <!-- Application Date -->
                            <div>
                                <label style="
                                    font-weight: 600;
                                    color: #64748b;
                                    font-size: 0.85rem;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    margin-bottom: 6px;
                                    display: block;
                                ">APPLICATION DATE</label>
                                <p style="margin: 5px 0; font-size: 1rem; color: #334155;">
                                    <i class="fas fa-calendar" style="color: #3b82f6; margin-right: 8px;"></i>
                                    ${formatDate(fertilizer.applicationDate)}
                                </p>
                            </div>

                            <!-- Expiry Date -->
                            <div>
                                <label style="
                                    font-weight: 600;
                                    color: #64748b;
                                    font-size: 0.85rem;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    margin-bottom: 6px;
                                    display: block;
                                ">EXPIRY DATE</label>
                                <p style="margin: 5px 0; font-size: 1rem; color: #334155;">
                                    ${fertilizer.expiryDate ?
                                        `<i class="fas fa-hourglass-end" style="color: #f59e0b; margin-right: 8px;"></i>${formatDate(fertilizer.expiryDate)}`
                                        : '<span style="color: #94a3b8;">No expiry date</span>'}
                                </p>
                            </div>

                            <!-- Application Method -->
                            <div>
                                <label style="
                                    font-weight: 600;
                                    color: #64748b;
                                    font-size: 0.85rem;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    margin-bottom: 6px;
                                    display: block;
                                ">APPLICATION METHOD</label>
                                <p style="margin: 5px 0;">
                                    <span style="
                                        background: linear-gradient(135deg, #64748b, #475569);
                                        color: white;
                                        padding: 6px 14px;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        font-size: 0.9rem;
                                        display: inline-block;
                                    ">
                                        ${getApplicationMethodLabel(fertilizer.applicationMethod)}
                                    </span>
                                </p>
                            </div>

                            <!-- Application Stage -->
                            <div>
                                <label style="
                                    font-weight: 600;
                                    color: #64748b;
                                    font-size: 0.85rem;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    margin-bottom: 6px;
                                    display: block;
                                ">APPLICATION STAGE</label>
                                <p style="margin: 5px 0; font-size: 1rem; color: #334155;">
                                    ${fertilizer.applicationStage ? escapeHtml(fertilizer.applicationStage) : '<span style="color: #94a3b8;">Not specified</span>'}
                                </p>
                            </div>

                            <!-- Effectiveness Rating -->
                            <div>
                                <label style="
                                    font-weight: 600;
                                    color: #64748b;
                                    font-size: 0.85rem;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    margin-bottom: 6px;
                                    display: block;
                                ">EFFECTIVENESS RATING</label>
                                <p style="margin: 5px 0; font-size: 1.2rem;">
                                    ${formatEffectiveness(fertilizer.effectivenessRating)}
                                </p>
                            </div>

                            ${fertilizer.notes ? `
                            <!-- Notes -->
                            <div style="grid-column: 1 / -1;">
                                <label style="
                                    font-weight: 600;
                                    color: #64748b;
                                    font-size: 0.85rem;
                                    text-transform: uppercase;
                                    letter-spacing: 0.5px;
                                    margin-bottom: 6px;
                                    display: block;
                                ">NOTES</label>
                                <div style="
                                    margin: 8px 0;
                                    padding: 15px;
                                    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
                                    border-radius: 8px;
                                    border-left: 4px solid #3b82f6;
                                ">
                                    <p style="margin: 0; font-size: 0.95rem; color: #475569; line-height: 1.6;">
                                        <i class="fas fa-sticky-note" style="color: #3b82f6; margin-right: 8px;"></i>
                                        ${escapeHtml(fertilizer.notes)}
                                    </p>
                                </div>
                            </div>
                            ` : ''}

                        </div>
                    </div>

                    <!-- FOOTER - FIXED EDIT BUTTON -->
                    <div style="
                        display: flex;
                        justify-content: flex-end;
                        gap: 12px;
                        padding: 20px 25px;
                        border-top: 1px solid #e5e7eb;
                        background: #f9fafb;
                        border-radius: 0 0 12px 12px;
                    ">
                        <button type="button" onclick="closeDetailsModal()" style="
                            padding: 10px 20px;
                            border: 2px solid #d1d5db;
                            background: white;
                            color: #6b7280;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#9ca3af';"
                           onmouseout="this.style.background='white'; this.style.borderColor='#d1d5db';">
                            <i class="fas fa-times"></i> Close
                        </button>

                        <!-- ✅ FIXED EDIT BUTTON - Uses openEditFromView() instead -->
                        <button type="button" onclick="openEditFromView('${fertilizerId}')" style="
                            padding: 10px 20px;
                            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                            transition: all 0.2s;
                            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.4)';"
                           onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(245, 158, 11, 0.3)';">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                </div>
            </div>

            <style>
                @keyframes slideInUp {
                    from {
                        opacity: 0;
                        transform: translateY(30px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            </style>
        `;

        // Inject into DOM
        const modalContainer = document.getElementById('modalContainer');
        if (modalContainer) {
            modalContainer.innerHTML = detailsHTML;
            console.log('✅ Details modal displayed');
        }

    } catch (error) {
        console.error('❌ Error loading fertilizer details:', error);
        showToast('❌ Failed to load details: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// Export functions to window
if (typeof window !== 'undefined') {
    window.viewFertilizerDetails = viewFertilizerDetails;
    window.closeDetailsModal = closeDetailsModal;
    window.openEditFromView = openEditFromView;
    console.log('✅ Fixed view/edit functions exported');
}







/**
 * COMPLETE EDIT FERTILIZER MODAL - GREEN THEME
 * Includes all fields from the add form
 */

/**
 * Edit fertilizer - COMPLETE WITH ALL FIELDS
 */
async function editFertilizer(fertilizerId) {
    try {
        showLoading();
        console.log('📝 Loading fertilizer for edit:', fertilizerId);

        // Récupérer les données du fertilizer
        const fertilizer = await apiRequest(`/fertilizer-usages/${fertilizerId}`);
        console.log('✅ Fertilizer loaded:', fertilizer);

        // Récupérer les productions pour le dropdown
        const farmerId = currentUser.id;
        let allProductions = [];

        try {
            console.log('🔄 Fetching productions for farmer:', farmerId);

            let prodResponse;
            try {
                prodResponse = await apiRequest(`/v1/crop-productions/farmer/${farmerId}`);
            } catch (error1) {
                try {
                    prodResponse = await apiRequest(`/v1/crop-productions/by-farmer/${farmerId}`);
                } catch (error2) {
                    const farmsResponse = await apiRequest(`/farms/farmer/${farmerId}/all`);
                    const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

                    if (farms.length > 0) {
                        const productionPromises = farms.map(farm =>
                            apiRequest(`/v1/crop-productions/farm/${farm.id}`).catch(() => [])
                        );
                        const productionArrays = await Promise.all(productionPromises);
                        prodResponse = productionArrays.flat();
                    } else {
                        prodResponse = [];
                    }
                }
            }

            if (prodResponse) {
                if (Array.isArray(prodResponse)) {
                    allProductions = prodResponse;
                } else if (prodResponse.data && Array.isArray(prodResponse.data)) {
                    allProductions = prodResponse.data;
                } else if (prodResponse.content && Array.isArray(prodResponse.content)) {
                    allProductions = prodResponse.content;
                }
            }

            allProductions = allProductions.filter(p => p && p.id && (p.cropName || p.cropId));
            console.log('✅ Valid productions loaded:', allProductions.length);

        } catch (err) {
            console.warn('⚠️ Could not load productions for edit:', err);
            allProductions = [];
        }

        // Format dates for input fields
        const formatDateForInput = (dateString) => {
            if (!dateString) return '';
            try {
                return new Date(dateString).toISOString().split('T')[0];
            } catch (e) {
                return '';
            }
        };

        // Créer le modal d'édition avec TOUS les champs et couleur VERTE
        const modalHTML = `
            <div class="modal-overlay show" id="editFertilizerModal">
                <div class="modal-container modal-large" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <!-- GREEN HEADER -->
                    <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                        <h3 class="modal-title" style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-edit"></i>
                            Edit Fertilizer Usage
                        </h3>
                        <button class="modal-close" onclick="closeEditModal()" type="button"
                                style="color: white; opacity: 0.9; background: transparent; border: none; font-size: 1.5rem; cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="modal-body" style="padding: 25px;">
                        <form id="editFertilizerForm" data-fertilizer-id="${fertilizerId}">
                            <div class="form-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">

                                <!-- Crop Production -->
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-seedling" style="color: #10b981;"></i>
                                        Crop Production *
                                    </label>
                                    <select class="form-select" name="cropProductionId" required
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                        <option value="">Select Production...</option>
                                        ${allProductions.map(prod => {
                                            const displayName = prod.cropName || prod.cropProductionName || `Production ${prod.productionCode || prod.id}`;
                                            const season = prod.season ? prod.season.replace('SEASON_', '') : '';
                                            const status = prod.productionStatus || prod.status || '';
                                            const isSelected = prod.id === fertilizer.cropProductionId;

                                            return `
                                                <option value="${prod.id}" ${isSelected ? 'selected' : ''}>
                                                    ${displayName} - ${season} ${prod.year || ''} (${status})
                                                </option>
                                            `;
                                        }).join('')}
                                    </select>
                                </div>

                                <!-- Fertilizer Type -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-tags" style="color: #10b981;"></i>
                                        Fertilizer Type *
                                    </label>
                                    <select class="form-select" name="fertilizerType" required
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Select Type...</option>
                                        <option value="ORGANIC" ${fertilizer.fertilizerType === 'ORGANIC' ? 'selected' : ''}>🌱 Organic</option>
                                        <option value="NPK" ${fertilizer.fertilizerType === 'NPK' ? 'selected' : ''}>🔬 NPK</option>
                                        <option value="NITROGEN" ${fertilizer.fertilizerType === 'NITROGEN' ? 'selected' : ''}>💨 Nitrogen</option>
                                        <option value="PHOSPHATE" ${fertilizer.fertilizerType === 'PHOSPHATE' ? 'selected' : ''}>🧪 Phosphate</option>
                                        <option value="POTASH" ${fertilizer.fertilizerType === 'POTASH' ? 'selected' : ''}>💎 Potash</option>
                                        <option value="MICRONUTRIENTS" ${fertilizer.fertilizerType === 'MICRONUTRIENTS' ? 'selected' : ''}>⚗️ Micronutrients</option>
                                    </select>
                                </div>

                                <!-- Fertilizer Name -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-signature" style="color: #10b981;"></i>
                                        Fertilizer Name *
                                    </label>
                                    <input type="text" class="form-input" name="fertilizerName"
                                           value="${escapeHtml(fertilizer.fertilizerName || '')}"
                                           placeholder="e.g., Urea, DAP, Compost" required maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Brand -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-trademark" style="color: #10b981;"></i>
                                        Brand
                                    </label>
                                    <input type="text" class="form-input" name="brand"
                                           value="${escapeHtml(fertilizer.brand || '')}"
                                           placeholder="e.g., Yara, Omex" maxlength="50"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Composition -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-microscope" style="color: #10b981;"></i>
                                        Composition (NPK)
                                    </label>
                                    <input type="text" class="form-input" name="composition"
                                           value="${escapeHtml(fertilizer.composition || '')}"
                                           placeholder="e.g., 10-20-10" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Quantity -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-balance-scale" style="color: #10b981;"></i>
                                        Quantity *
                                    </label>
                                    <input type="number" class="form-input" name="quantity" id="editFertQuantity"
                                           value="${fertilizer.quantity || ''}"
                                           step="0.01" min="0.01" placeholder="e.g., 50.00" required
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Unit -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-ruler" style="color: #10b981;"></i>
                                        Unit *
                                    </label>
                                    <select class="form-select" name="unit" required
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Select Unit...</option>
                                        <option value="KG" ${fertilizer.unit === 'KG' ? 'selected' : ''}>KG (Kilograms)</option>
                                        <option value="TONNES" ${fertilizer.unit === 'TONNES' ? 'selected' : ''}>Tonnes</option>
                                        <option value="LITERS" ${fertilizer.unit === 'LITERS' ? 'selected' : ''}>Liters</option>
                                        <option value="BAGS" ${fertilizer.unit === 'BAGS' ? 'selected' : ''}>Bags</option>
                                    </select>
                                </div>

                                <!-- Application Date -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-calendar" style="color: #10b981;"></i>
                                        Application Date *
                                    </label>
                                    <input type="date" class="form-input" name="applicationDate"
                                           value="${formatDateForInput(fertilizer.applicationDate)}"
                                           max="${new Date().toISOString().split('T')[0]}" required
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Application Method -->
                                <div class="form-group">
                                    <label class="form-label required" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-spray-can" style="color: #10b981;"></i>
                                        Application Method *
                                    </label>
                                    <select class="form-select" name="applicationMethod" required
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Select Method...</option>
                                        <option value="BROADCAST" ${fertilizer.applicationMethod === 'BROADCAST' ? 'selected' : ''}>📡 Broadcast</option>
                                        <option value="BAND" ${fertilizer.applicationMethod === 'BAND' ? 'selected' : ''}>🎯 Band</option>
                                        <option value="FOLIAR" ${fertilizer.applicationMethod === 'FOLIAR' ? 'selected' : ''}>🌿 Foliar</option>
                                        <option value="FERTIGATION" ${fertilizer.applicationMethod === 'FERTIGATION' ? 'selected' : ''}>💧 Fertigation</option>
                                        <option value="SPOT" ${fertilizer.applicationMethod === 'SPOT' ? 'selected' : ''}>📍 Spot</option>
                                    </select>
                                </div>

                                <!-- Application Stage -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-layer-group" style="color: #10b981;"></i>
                                        Application Stage
                                    </label>
                                    <input type="text" class="form-input" name="applicationStage"
                                           value="${escapeHtml(fertilizer.applicationStage || '')}"
                                           placeholder="e.g., PLANTING, FLOWERING" maxlength="50"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Cost Per Unit -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-money-bill-wave" style="color: #10b981;"></i>
                                        Cost Per Unit (RWF)
                                    </label>
                                    <input type="number" class="form-input" name="costPerUnit" id="editFertCostPerUnit"
                                           value="${fertilizer.costPerUnit || ''}"
                                           step="0.01" min="0" placeholder="e.g., 1500.00"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Total Cost (auto-calculated) -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-calculator" style="color: #10b981;"></i>
                                        Total Cost (RWF)
                                    </label>
                                    <input type="number" class="form-input" name="totalCost" id="editFertTotalCost"
                                           value="${fertilizer.totalCost || ''}"
                                           step="0.01" min="0" placeholder="Auto-calculated" readonly
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; background-color: #f9fafb;">
                                </div>

                                <!-- Supplier -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-building" style="color: #10b981;"></i>
                                        Supplier
                                    </label>
                                    <input type="text" class="form-input" name="supplier"
                                           value="${escapeHtml(fertilizer.supplier || '')}"
                                           placeholder="e.g., AgriSupply Ltd" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Batch Number -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-barcode" style="color: #10b981;"></i>
                                        Batch Number
                                    </label>
                                    <input type="text" class="form-input" name="batchNumber"
                                           value="${escapeHtml(fertilizer.batchNumber || '')}"
                                           placeholder="e.g., BAT-2024-001" maxlength="50"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Expiry Date -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-hourglass-end" style="color: #10b981;"></i>
                                        Expiry Date
                                    </label>
                                    <input type="date" class="form-input" name="expiryDate"
                                           value="${formatDateForInput(fertilizer.expiryDate)}"
                                           min="${new Date().toISOString().split('T')[0]}"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Weather Conditions -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-cloud-sun" style="color: #10b981;"></i>
                                        Weather Conditions
                                    </label>
                                    <input type="text" class="form-input" name="weatherConditions"
                                           value="${escapeHtml(fertilizer.weatherConditions || '')}"
                                           placeholder="e.g., Sunny, Cloudy" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Soil Conditions -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-mountain" style="color: #10b981;"></i>
                                        Soil Conditions
                                    </label>
                                    <input type="text" class="form-input" name="soilConditions"
                                           value="${escapeHtml(fertilizer.soilConditions || '')}"
                                           placeholder="e.g., Dry, Moist" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Operator Name -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-user-tie" style="color: #10b981;"></i>
                                        Operator Name
                                    </label>
                                    <input type="text" class="form-input" name="operatorName"
                                           value="${escapeHtml(fertilizer.operatorName || '')}"
                                           placeholder="Who applied the fertilizer?" maxlength="100"
                                           style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                </div>

                                <!-- Effectiveness Rating -->
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-star" style="color: #10b981;"></i>
                                        Effectiveness Rating (1-5)
                                    </label>
                                    <select class="form-select" name="effectivenessRating"
                                            style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                                        <option value="">Not rated yet</option>
                                        <option value="1" ${fertilizer.effectivenessRating === 1 ? 'selected' : ''}>⭐ 1 - Very Poor</option>
                                        <option value="2" ${fertilizer.effectivenessRating === 2 ? 'selected' : ''}>⭐⭐ 2 - Poor</option>
                                        <option value="3" ${fertilizer.effectivenessRating === 3 ? 'selected' : ''}>⭐⭐⭐ 3 - Fair</option>
                                        <option value="4" ${fertilizer.effectivenessRating === 4 ? 'selected' : ''}>⭐⭐⭐⭐ 4 - Good</option>
                                        <option value="5" ${fertilizer.effectivenessRating === 5 ? 'selected' : ''}>⭐⭐⭐⭐⭐ 5 - Excellent</option>
                                    </select>
                                </div>

                                <!-- Notes -->
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 8px;">
                                        <i class="fas fa-sticky-note" style="color: #10b981;"></i>
                                        Notes
                                    </label>
                                    <textarea class="form-input" name="notes" rows="3"
                                              placeholder="Additional observations or remarks..." maxlength="3000"
                                              style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;">${escapeHtml(fertilizer.notes || '')}</textarea>
                                </div>

                            </div>

                            <!-- GREEN FOOTER -->
                            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                                <button type="button" class="btn btn-secondary" onclick="closeEditModal()"
                                        style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #6b7280; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-times"></i>
                                    Cancel
                                </button>
                                <button type="submit" class="btn btn-success"
                                        style="padding: 10px 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-save"></i>
                                    Update Fertilizer
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;

        const modalContainer = document.getElementById('modalContainer');
        if (modalContainer) {
            modalContainer.innerHTML = modalHTML;
            console.log('✅ Edit modal HTML injected');

            // Attacher le handler de submit
            const form = document.getElementById('editFertilizerForm');
            if (form) {
                form.addEventListener('submit', handleEditFertilizer);
                console.log('✅ Edit form submit handler attached');

                // Auto-calculate total cost on edit
                const quantityInput = document.getElementById('editFertQuantity');
                const costPerUnitInput = document.getElementById('editFertCostPerUnit');
                const totalCostInput = document.getElementById('editFertTotalCost');

                const calculateTotal = () => {
                    const qty = parseFloat(quantityInput.value) || 0;
                    const cost = parseFloat(costPerUnitInput.value) || 0;
                    totalCostInput.value = (qty * cost).toFixed(2);
                };

                if (quantityInput && costPerUnitInput) {
                    quantityInput.addEventListener('input', calculateTotal);
                    costPerUnitInput.addEventListener('input', calculateTotal);
                    console.log('✅ Edit cost calculation handlers attached');
                }
            }

            // Forcer l'affichage du modal
            setTimeout(() => {
                const modal = document.getElementById('editFertilizerModal');
                if (modal) {
                    modal.style.display = 'flex';
                    modal.style.opacity = '1';
                    console.log('✅ Edit modal displayed');
                }
            }, 100);
        }

    } catch (error) {
        console.error('❌ Error loading edit form:', error);
        showToast('❌ Failed to load edit form: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Close Edit Modal
 */
function closeEditModal() {
    console.log('🔒 Closing edit modal...');
    const modal = document.getElementById('editFertilizerModal');
    if (modal) {
        modal.classList.remove('show');
        modal.style.opacity = '0';
        setTimeout(() => {
            const modalContainer = document.getElementById('modalContainer');
            if (modalContainer) {
                modalContainer.innerHTML = '';
            }
            console.log('✅ Edit modal closed and removed');
        }, 300);
    }
}

/**
 * Handle Edit Fertilizer - COMPLETE
 */
async function handleEditFertilizer(e) {
    e.preventDefault();

    const fertilizerId = e.target.dataset.fertilizerId;
    console.log('📝 Updating fertilizer:', fertilizerId);

    const formData = new FormData(e.target);

    const fertilizerData = {
        cropProductionId: formData.get('cropProductionId'),
        fertilizerType: formData.get('fertilizerType'),
        fertilizerName: formData.get('fertilizerName').trim(),
        brand: formData.get('brand')?.trim() || null,
        composition: formData.get('composition')?.trim() || null,
        quantity: parseFloat(formData.get('quantity')),
        unit: formData.get('unit'),
        applicationDate: formData.get('applicationDate'),
        applicationMethod: formData.get('applicationMethod'),
        applicationStage: formData.get('applicationStage')?.trim() || null,
        costPerUnit: formData.get('costPerUnit') ? parseFloat(formData.get('costPerUnit')) : null,
        totalCost: formData.get('totalCost') ? parseFloat(formData.get('totalCost')) : null,
        supplier: formData.get('supplier')?.trim() || null,
        batchNumber: formData.get('batchNumber')?.trim() || null,
        expiryDate: formData.get('expiryDate') || null,
        weatherConditions: formData.get('weatherConditions')?.trim() || null,
        soilConditions: formData.get('soilConditions')?.trim() || null,
        operatorName: formData.get('operatorName')?.trim() || null,
        effectivenessRating: formData.get('effectivenessRating') ? parseInt(formData.get('effectivenessRating')) : null,
        notes: formData.get('notes')?.trim() || null
    };

    // Validation
    if (!fertilizerData.cropProductionId) {
        showToast('❌ Please select a crop production', 'error');
        return;
    }
    if (!fertilizerData.fertilizerType) {
        showToast('❌ Please select fertilizer type', 'error');
        return;
    }
    if (!fertilizerData.quantity || fertilizerData.quantity <= 0) {
        showToast('❌ Quantity must be greater than 0', 'error');
        return;
    }

    try {
        showLoading();

        console.log('📤 Sending update data:', fertilizerData);

        const response = await apiRequest(`/fertilizer-usages/${fertilizerId}`, {
            method: 'PUT',
            body: JSON.stringify(fertilizerData)
        });

        console.log('✅ Fertilizer updated:', response);
        showToast('✅ Fertilizer updated successfully!', 'success');

        closeEditModal();

        // Recharger les données
        setTimeout(async () => {
            await loadFertilizerData();
        }, 500);

    } catch (error) {
        console.error('❌ Error updating fertilizer:', error);
        showToast('❌ Error: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}






/**
 * Load irrigation data - VERSION CORRIGÉE POUR SPRING BOOT
 */
async function loadIrrigationData() {
    try {
        showLoading();

        if (!currentUser || !currentUser.id) {
            console.warn('⚠️ No current user found');
            displayEmptyIrrigationData();
            return;
        }

        console.log('🔄 Loading irrigation data for farmer:', currentUser.id);

        // Récupérer les fermes d'abord
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

        let irrigations = [];

        if (farms.length > 0) {
            // Récupérer les irrigations pour chaque ferme
            const irrigationPromises = farms.map(farm =>
                apiRequest(`/irrigation/farm/${farm.id}`).catch(() => [])
            );

            const irrigationArrays = await Promise.all(irrigationPromises);

            // ✅ CORRECTION: Gérer le format Page<IrrigationData> de Spring
            irrigationArrays.forEach(response => {
                let farmIrrigations = [];
                if (Array.isArray(response)) {
                    farmIrrigations = response;
                } else if (response && response.content && Array.isArray(response.content)) {
                    farmIrrigations = response.content;
                } else if (response && response.data && Array.isArray(response.data)) {
                    farmIrrigations = response.data;
                } else if (response && Array.isArray(response)) {
                    farmIrrigations = response;
                }
                irrigations = irrigations.concat(farmIrrigations);
            });

            // ✅ CORRECTION: Ajouter le nom de la ferme à chaque irrigation
            irrigations = irrigations.map(irrig => {
                const farm = farms.find(f => f.id === irrig.farmId);
                return {
                    ...irrig,
                    farmName: farm ? farm.farmName : 'Unknown Farm'
                };
            });
        }

        console.log(`✅ Loaded ${irrigations.length} irrigation records`);

        // Calculer les statistiques
        const totalSessions = irrigations.length;
        const totalWater = irrigations.reduce((sum, i) =>
            sum + (parseFloat(i.waterAmount) || 0), 0
        );
        const totalCost = irrigations.reduce((sum, i) =>
            sum + (parseFloat(i.totalCost) || 0), 0
        );

        // ✅ CORRECTION: Calculer l'efficacité moyenne basée sur les données
        let avgEfficiency = 0;
        const irrigationsWithEfficiency = irrigations.filter(i =>
            i.soilMoistureBefore != null && i.soilMoistureAfter != null
        );

        if (irrigationsWithEfficiency.length > 0) {
            const totalEfficiency = irrigationsWithEfficiency.reduce((sum, i) => {
                const moistureIncrease = parseFloat(i.soilMoistureAfter) - parseFloat(i.soilMoistureBefore);
                const waterAmount = parseFloat(i.waterAmount) || 1;
                const efficiency = (moistureIncrease / waterAmount) * 100;
                return sum + efficiency;
            }, 0);
            avgEfficiency = totalEfficiency / irrigationsWithEfficiency.length;
        }

        // Mettre à jour les statistiques
        updateElement('irrigTotalSessions', totalSessions);
        updateElement('irrigTotalWater', `${totalWater.toFixed(2)} L`);
        updateElement('irrigTotalCost', formatCurrency(totalCost));
        updateElement('irrigAvgEfficiency', avgEfficiency > 0 ? `${avgEfficiency.toFixed(1)}%` : 'N/A');

        // Afficher les données
        displayIrrigationTable(irrigations);
        createIrrigationTrendChart(irrigations);

    } catch (error) {
        console.error('❌ Error loading irrigation data:', error);
        showToast('Unable to load irrigation data', 'warning');
        displayEmptyIrrigationData();
    } finally {
        hideLoading();
    }
}

/**
 * Display irrigation table - VERSION CORRIGÉE POUR SPRING BOOT
 */
function displayIrrigationTable(irrigations) {
    const tbody = document.getElementById('irrigationTableBody');
    if (!tbody) return;

    if (irrigations.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="empty-state">
                    <i class="fas fa-tint"></i>
                    <p>No irrigation records yet</p>
                    <button class="btn btn-primary mt-3" onclick="openAddIrrigationModal()">
                        <i class="fas fa-plus"></i>
                        Add First Irrigation Record
                    </button>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = irrigations.map(irrig => {
        // ✅ CORRECTION: Gérer toutes les valeurs avec des valeurs par défaut
        const irrigationDate = irrig.irrigationDate ? formatDate(irrig.irrigationDate) : 'N/A';
        const farmName = irrig.farmName || 'Unknown Farm';
        const waterAmount = irrig.waterAmount ? parseFloat(irrig.waterAmount).toFixed(2) : '0.00';
        const duration = irrig.duration || 0;
        const irrigationMethod = irrig.irrigationMethod || 'N/A';
        const waterSource = irrig.waterSource || 'N/A';
        const moistureBefore = irrig.soilMoistureBefore ? parseFloat(irrig.soilMoistureBefore).toFixed(1) : 'N/A';
        const moistureAfter = irrig.soilMoistureAfter ? parseFloat(irrig.soilMoistureAfter).toFixed(1) : 'N/A';
        const totalCost = irrig.totalCost ? formatCurrency(irrig.totalCost) : formatCurrency(0);
        const irrigId = irrig.id || '';

        return `
            <tr>
                <td>${irrigationDate}</td>
                <td>${farmName}</td>
                <td>${waterAmount} L</td>
                <td>${duration} min</td>
                <td><span class="badge badge-info">${irrigationMethod}</span></td>
                <td><span class="badge badge-secondary">${waterSource}</span></td>
                <td>${moistureBefore}%</td>
                <td>${moistureAfter}%</td>
                <td><strong>${totalCost}</strong></td>
                <td>
                    <button class="btn-icon" onclick="viewIrrigationDetails('${irrigId}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-icon" onclick="editIrrigation('${irrigId}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon btn-danger" onclick="deleteIrrigation('${irrigId}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}






/**
 * Export fertilizer to Excel
 */
async function exportFertilizerToExcel() {
    try {
        showLoading();
        showToast('Preparing export...', 'info');

        // Récupérer les données
        const testResponse = await apiRequest(`/fertilizer-usages/test/farmer/${currentUser.id}`);
        let fertilizers = testResponse.allFertilizers || [];

        if (fertilizers.length === 0) {
            showToast('No fertilizer data to export', 'warning');
            hideLoading();
            return;
        }

        // Enricher avec crop production names
        fertilizers = await Promise.all(fertilizers.map(async (fert) => {
            try {
                if (fert.cropProductionId && !fert.cropProductionName) {
                    const cropProdResponse = await apiRequest(`/v1/crop-productions/${fert.cropProductionId}`);
                    const cropProd = cropProdResponse.data || cropProdResponse;
                    if (cropProd.cropId) {
                        const cropResponse = await apiRequest(`/v1/crops/${cropProd.cropId}`);
                        const crop = cropResponse.data || cropResponse;
                        fert.cropProductionName = crop.cropName || cropProd.productionCode || 'Unknown';
                    } else {
                        fert.cropProductionName = cropProd.productionCode || 'Unknown';
                    }
                }
            } catch (e) { fert.cropProductionName = fert.cropProductionName || 'Unknown'; }
            return fert;
        }));

        // Headers
        const headers = [
            'Application Date', 'Crop Production', 'Fertilizer Type', 'Fertilizer Name',
            'Brand', 'Composition', 'Quantity', 'Unit', 'Method', 'Stage',
            'Cost/Unit (RWF)', 'Total Cost (RWF)', 'Supplier', 'Batch Number',
            'Expiry Date', 'Effectiveness', 'Weather', 'Soil', 'Operator', 'Notes'
        ];

        // Rows
        const rows = fertilizers.map(f => [
            f.applicationDate ? f.applicationDate.split('T')[0] : '',
            f.cropProductionName || '',
            f.fertilizerType || '',
            f.fertilizerName || '',
            f.brand || '',
            f.composition || '',
            parseFloat(f.quantity) || 0,
            f.unit || '',
            f.applicationMethod || '',
            f.applicationStage || '',
            parseFloat(f.costPerUnit) || '',
            parseFloat(f.totalCost) || 0,
            f.supplier || '',
            f.batchNumber || '',
            f.expiryDate ? f.expiryDate.split('T')[0] : '',
            f.effectivenessRating || '',
            f.weatherConditions || '',
            f.soilConditions || '',
            f.operatorName || '',
            f.notes || ''
        ]);

        // Shared strings
        const strings = [];
        const strMap = {};
        function addString(val) {
            const s = String(val);
            if (!(s in strMap)) { strMap[s] = strings.length; strings.push(s); }
            return strMap[s];
        }
        headers.forEach(h => addString(h));
        rows.forEach(row => row.forEach(cell => { if (typeof cell === 'string') addString(cell); }));

        function escapeXml(s) {
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
        }

        function cellRef(col, row) {
            let c = '', n = col;
            while (n >= 0) { c = String.fromCharCode(65 + (n % 26)) + c; n = Math.floor(n / 26) - 1; }
            return c + (row + 1);
        }

        const numCols = [6, 10, 11, 15]; // quantity, cost/unit, totalCost, effectiveness

        // sheet1.xml
        let sheetRows = '';
        let headerCells = headers.map((h, ci) => `<c r="${cellRef(ci,0)}" t="s" s="1"><v>${addString(h)}</v></c>`).join('');
        sheetRows += `<row r="1">${headerCells}</row>`;

        rows.forEach((row, ri) => {
            let cells = row.map((cell, ci) => {
                const ref = cellRef(ci, ri + 1);
                if (numCols.includes(ci) && cell !== '' && !isNaN(cell)) {
                    return `<c r="${ref}" s="2"><v>${cell}</v></c>`;
                }
                return `<c r="${ref}" t="s" s="2"><v>${addString(String(cell))}</v></c>`;
            }).join('');
            sheetRows += `<row r="${ri + 2}">${cells}</row>`;
        });

        const sheet1 = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<sheetViews><sheetView tabSelected="1" workbookViewId="0"/></sheetViews>
<sheetFormatPr defaultRowHeight="20"/>
<cols>${headers.map((_,i) => `<col min="${i+1}" max="${i+1}" width="22" customWidth="1"/>`).join('')}</cols>
<sheetData>${sheetRows}</sheetData>
</worksheet>`;

        const styles = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<fonts count="3">
  <font><sz val="11"/><name val="Calibri"/></font>
  <font><b/><sz val="11"/><color rgb="FFFFFFFF"/><name val="Calibri"/></font>
  <font><sz val="11"/><name val="Calibri"/></font>
</fonts>
<fills count="3">
  <fill><patternFill patternType="none"/></fill>
  <fill><patternFill patternType="solid"><fgColor rgb="FF10B981"/></patternFill></fill>
  <fill><patternFill patternType="solid"><fgColor rgb="FFF0FDF4"/></patternFill></fill>
</fills>
<borders count="2">
  <border><left/><right/><top/><bottom/><diagonal/></border>
  <border><left style="thin"><color rgb="FF10B981"/></left><right style="thin"><color rgb="FF10B981"/></right><top style="thin"><color rgb="FF10B981"/></top><bottom style="thin"><color rgb="FF10B981"/></bottom><diagonal/></border>
</borders>
<cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>
<cellXfs count="3">
  <xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/>
  <xf numFmtId="0" fontId="1" fillId="1" borderId="1" xfId="0" applyFont="1" applyFill="1" applyBorder="1" applyAlignment="1"><alignment horizontal="center" vertical="center"/></xf>
  <xf numFmtId="0" fontId="2" fillId="2" borderId="1" xfId="0" applyFill="1" applyBorder="1"/>
</cellXfs>
</styleSheet>`;

        const sharedStrings = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="${strings.length}" uniqueCount="${strings.length}">
${strings.map(s => `<si><t>${escapeXml(s)}</t></si>`).join('')}
</sst>`;

        const workbook = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
<sheets><sheet name="Fertilizer Usage" sheetId="1" r:id="rId1"/></sheets>
</workbook>`;

        const rels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
<Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings" Target="sharedStrings.xml"/>
</Relationships>`;

        const topRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
</Relationships>`;

        const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
<Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
<Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>
<Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/>
</Types>`;

        const files = {
            '[Content_Types].xml': contentTypes,
            '_rels/.rels': topRels,
            'xl/workbook.xml': workbook,
            'xl/_rels/workbook.xml.rels': rels,
            'xl/worksheets/sheet1.xml': sheet1,
            'xl/styles.xml': styles,
            'xl/sharedStrings.xml': sharedStrings
        };

        const blob = await buildZipBlob(files);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Fertilizer_Usage_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('✅ Export successful!', 'success');

    } catch (error) {
        console.error('❌ Export error:', error);
        showToast('Failed to export: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// ✅ Remplacer l'ancien listener Export fertilizer
document.querySelectorAll('[data-action="export-fertilizer"]').forEach(btn => {
    btn.addEventListener('click', exportFertilizerToExcel);
});





/**
 * Open modal to add new irrigation - IMPROVED DESIGN VERSION
 */
async function openAddIrrigationModal() {
    try {
        showLoading();

        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

        if (farms.length === 0) {
            showToast('❌ You need to create a farm first before recording irrigation', 'error');
            hideLoading();
            return;
        }

        const modalHTML = `
            <div class="modal-overlay show" id="irrigationModal" onclick="if(event.target === this) closeIrrigationModal()">
                <div class="modal-container modal-irrigation">
                    <div class="modal-header-gradient">
                        <div class="modal-header-content">
                            <div class="modal-icon-wrapper">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div>
                                <h3 class="modal-title">Record Irrigation Session</h3>
                                <p class="modal-subtitle">Track your water usage and irrigation efficiency</p>
                            </div>
                        </div>
                        <button class="modal-close-elegant" onclick="closeIrrigationModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <form id="irrigationForm" onsubmit="submitIrrigationForm(event)">
                        <div class="modal-body-tabs">
                            <!-- Tab Navigation -->
                            <div class="tabs-nav">
                                <button type="button" class="tab-btn active" data-tab="basic">
                                    <i class="fas fa-info-circle"></i> Basic Info
                                </button>
                                <button type="button" class="tab-btn" data-tab="details">
                                    <i class="fas fa-sliders-h"></i> Details
                                </button>
                                <button type="button" class="tab-btn" data-tab="notes">
                                    <i class="fas fa-sticky-note"></i> Notes
                                </button>
                            </div>

                            <!-- Tab Content: Basic Info -->
                            <div class="tab-content active" data-tab-content="basic">
                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-map-marker-alt"></i> Location & Timing
                                    </h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label required">
                                                <i class="fas fa-farm"></i> Select Farm
                                            </label>
                                            <select name="farmId" class="form-input" required>
                                                <option value="">Choose a farm...</option>
                                                ${farms.map(farm =>
                                                    `<option value="${farm.id}">${farm.farmName} ${farm.location ? '• ' + farm.location : ''}</option>`
                                                ).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required">
                                                <i class="fas fa-calendar-alt"></i> Date & Time
                                            </label>
                                            <input type="datetime-local" name="irrigationDate" class="form-input"
                                                   value="${new Date().toISOString().slice(0, 16)}" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-water"></i> Water Usage
                                    </h4>
                                    <div class="form-row-triple">
                                        <div class="form-group">
                                            <label class="form-label required">
                                                <i class="fas fa-droplet"></i> Water Amount
                                            </label>
                                            <div class="input-with-unit">
                                                <input type="number" name="waterAmount" class="form-input"
                                                       min="0.01" step="0.01" placeholder="1000" required>
                                                <span class="input-unit">Liters</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required">
                                                <i class="fas fa-clock"></i> Duration
                                            </label>
                                            <div class="input-with-unit">
                                                <input type="number" name="duration" class="form-input"
                                                       min="1" max="1440" placeholder="60" required>
                                                <span class="input-unit">Minutes</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-money-bill-wave"></i> Cost per Liter
                                            </label>
                                            <div class="input-with-unit">
                                                <input type="number" name="waterCost" class="form-input"
                                                       min="0" step="0.01" placeholder="0.5">
                                                <span class="input-unit">RWF</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-cog"></i> Method & Source
                                    </h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label required">
                                                <i class="fas fa-spray-can"></i> Irrigation Method
                                            </label>
                                            <select name="irrigationMethod" class="form-input" required>
                                                <option value="">Choose method...</option>
                                                <option value="SPRINKLER">🌊 Sprinkler System</option>
                                                <option value="DRIP">💧 Drip Irrigation</option>
                                                <option value="FLOOD">🌊 Flood Irrigation</option>
                                                <option value="FURROW">🌾 Furrow Irrigation</option>
                                                <option value="MANUAL">🪣 Manual Watering</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required">
                                                <i class="fas fa-water"></i> Water Source
                                            </label>
                                            <select name="waterSource" class="form-input" required>
                                                <option value="">Choose source...</option>
                                                <option value="WELL">🔷 Well</option>
                                                <option value="RIVER">🌊 River</option>
                                                <option value="LAKE">🏞️ Lake</option>
                                                <option value="RAINWATER">☔ Rainwater</option>
                                                <option value="MUNICIPAL">🏛️ Municipal Supply</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Content: Details -->
                            <div class="tab-content" data-tab-content="details">
                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-thermometer-half"></i> Soil Moisture Levels
                                    </h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-arrow-down"></i> Before Irrigation
                                            </label>
                                            <div class="input-with-unit">
                                                <input type="number" name="soilMoistureBefore" class="form-input"
                                                       min="0" max="100" step="0.1" placeholder="45.5">
                                                <span class="input-unit">%</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-arrow-up"></i> After Irrigation
                                            </label>
                                            <div class="input-with-unit">
                                                <input type="number" name="soilMoistureAfter" class="form-input"
                                                       min="0" max="100" step="0.1" placeholder="65.5">
                                                <span class="input-unit">%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-tools"></i> Equipment & Personnel
                                    </h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-user"></i> Operator Name
                                            </label>
                                            <input type="text" name="operatorName" class="form-input"
                                                   placeholder="John Doe" maxlength="100">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-toolbox"></i> Equipment Used
                                            </label>
                                            <input type="text" name="equipmentUsed" class="form-input"
                                                   placeholder="Sprinkler System X200" maxlength="100">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-cloud-sun"></i> Environmental Conditions
                                    </h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-cloud"></i> Weather Condition
                                            </label>
                                            <input type="text" name="weatherCondition" class="form-input"
                                                   placeholder="Sunny, Cloudy, etc." maxlength="100">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-flask"></i> Water Quality
                                            </label>
                                            <input type="text" name="waterQuality" class="form-input"
                                                   placeholder="Good, Excellent, etc." maxlength="100">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <div class="checkbox-card">
                                        <input type="checkbox" name="fertilizerApplied" value="true" id="fertilizerCheck">
                                        <label for="fertilizerCheck" class="checkbox-card-label">
                                            <i class="fas fa-leaf"></i>
                                            <span>Fertilizer applied during this irrigation session</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Content: Notes -->
                            <div class="tab-content" data-tab-content="notes">
                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-sticky-note"></i> Additional Information
                                    </h4>
                                    <div class="form-group">
                                        <label class="form-label">Notes & Observations</label>
                                        <textarea name="notes" class="form-textarea" rows="8"
                                                  placeholder="Record any additional observations, issues encountered, or special notes about this irrigation session..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer-elegant">
                            <button type="button" class="btn-elegant btn-cancel" onclick="closeIrrigationModal()">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" class="btn-elegant btn-submit">
                                <i class="fas fa-save"></i>
                                Save Irrigation Record
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;
        initializeIrrigationTabs();

    } catch (error) {
        console.error('Error opening irrigation modal:', error);
        showToast('❌ Error opening form', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Initialize tab switching functionality
 */
function initializeIrrigationTabs() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');

            // Remove active class from all buttons and contents
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to clicked button and corresponding content
            button.classList.add('active');
            document.querySelector(`[data-tab-content="${targetTab}"]`).classList.add('active');
        });
    });
}




/**
 * Submit irrigation form - VERSION CORRIGÉE POUR SPRING BOOT
 */
async function submitIrrigationForm(event) {
    event.preventDefault();

    try {
        showLoading();

        const form = event.target;
        const formData = new FormData(form);

        // ✅ CORRECTION: Construire l'objet irrigation selon le modèle Spring
        const irrigationData = {
            farmId: formData.get('farmId'),
            irrigationDate: formData.get('irrigationDate') + ':00', // Ajouter les secondes
            waterAmount: parseFloat(formData.get('waterAmount')),
            duration: parseInt(formData.get('duration')),
            irrigationMethod: formData.get('irrigationMethod'),
            waterSource: formData.get('waterSource'),
            waterCost: formData.get('waterCost') ? parseFloat(formData.get('waterCost')) : null,
            soilMoistureBefore: formData.get('soilMoistureBefore') ? parseFloat(formData.get('soilMoistureBefore')) : null,
            soilMoistureAfter: formData.get('soilMoistureAfter') ? parseFloat(formData.get('soilMoistureAfter')) : null,
            weatherCondition: formData.get('weatherCondition') || null,
            operatorName: formData.get('operatorName') || null,
            equipmentUsed: formData.get('equipmentUsed') || null,
            waterQuality: formData.get('waterQuality') || null,
            fertilizerApplied: formData.get('fertilizerApplied') === 'true',
            notes: formData.get('notes') || null
        };

        console.log('📤 Submitting irrigation data to Spring backend:', irrigationData);

        // Envoyer au serveur Spring
        const response = await apiRequest('/irrigation', {
            method: 'POST',
            body: JSON.stringify(irrigationData)
        });

        console.log('✅ Irrigation created in Spring backend:', response);

        showToast('✅ Irrigation record saved successfully!', 'success');
        closeIrrigationModal();

        // Recharger les données
        await loadIrrigationData();

    } catch (error) {
        console.error('❌ Error saving irrigation:', error);
        showToast(`❌ Error saving irrigation: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Display empty irrigation data
 */
function displayEmptyIrrigationData() {
    updateElement('irrigTotalSessions', 0);
    updateElement('irrigTotalWater', '0 L');
    updateElement('irrigTotalCost', formatCurrency(0));
    updateElement('irrigAvgEfficiency', 'N/A');

    const tbody = document.getElementById('irrigationTableBody');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="empty-state">
                    <i class="fas fa-tint"></i>
                    <p>No irrigation records yet</p>
                    <button class="btn btn-primary mt-3" onclick="openAddIrrigationModal()">
                        <i class="fas fa-plus"></i>
                        Record First Irrigation
                    </button>
                </td>
            </tr>
        `;
    }
}

/**
 * Close irrigation modal
 */
function closeIrrigationModal() {
    const modal = document.getElementById('irrigationModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}




/**
 * View irrigation details - IMPLEMENTED
 */
async function viewIrrigationDetails(irrigationId) {
    try {
        showLoading();
        const irrigation = await apiRequest(`/irrigation/${irrigationId}`);

        let farmName = 'Unknown Farm';
        if (irrigation.farmId) {
            try {
                const farm = await apiRequest(`/farms/${irrigation.farmId}`);
                farmName = farm.farmName || farmName;
            } catch (e) {
                console.warn('Could not fetch farm name:', e);
            }
        }

        const modalHTML = `
            <div class="modal-overlay show" id="irrigationDetailsModal" onclick="if(event.target === this) closeIrrigationDetailsModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-info-circle"></i>
                            Irrigation Details
                        </h3>
                        <button class="modal-close" onclick="closeIrrigationDetailsModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Irrigation ID</label>
                                <value>${irrigation.id}</value>
                            </div>
                            <div class="detail-item">
                                <label>Farm</label>
                                <value>${farmName}</value>
                            </div>
                            <div class="detail-item">
                                <label>Date & Time</label>
                                <value>${formatDateTime(irrigation.irrigationDate)}</value>
                            </div>
                            <div class="detail-item">
                                <label>Water Amount</label>
                                <value>${irrigation.waterAmount} L</value>
                            </div>
                            <div class="detail-item">
                                <label>Duration</label>
                                <value>${irrigation.duration} minutes</value>
                            </div>
                            <div class="detail-item">
                                <label>Method</label>
                                <value><span class="badge badge-info">${irrigation.irrigationMethod}</span></value>
                            </div>
                            <div class="detail-item">
                                <label>Water Source</label>
                                <value><span class="badge badge-secondary">${irrigation.waterSource}</span></value>
                            </div>
                            ${irrigation.waterCost ? `
                            <div class="detail-item">
                                <label>Water Cost</label>
                                <value>${formatCurrency(irrigation.waterCost)} per liter</value>
                            </div>
                            ` : ''}
                            ${irrigation.totalCost ? `
                            <div class="detail-item">
                                <label>Total Cost</label>
                                <value class="text-success"><strong>${formatCurrency(irrigation.totalCost)}</strong></value>
                            </div>
                            ` : ''}
                            ${irrigation.soilMoistureBefore !== null && irrigation.soilMoistureBefore !== undefined ? `
                            <div class="detail-item">
                                <label>Soil Moisture Before</label>
                                <value>${irrigation.soilMoistureBefore}%</value>
                            </div>
                            ` : ''}
                            ${irrigation.soilMoistureAfter !== null && irrigation.soilMoistureAfter !== undefined ? `
                            <div class="detail-item">
                                <label>Soil Moisture After</label>
                                <value>${irrigation.soilMoistureAfter}%</value>
                            </div>
                            ` : ''}
                            ${irrigation.weatherCondition ? `
                            <div class="detail-item">
                                <label>Weather</label>
                                <value>${irrigation.weatherCondition}</value>
                            </div>
                            ` : ''}
                            ${irrigation.operatorName ? `
                            <div class="detail-item">
                                <label>Operator</label>
                                <value>${irrigation.operatorName}</value>
                            </div>
                            ` : ''}
                            ${irrigation.equipmentUsed ? `
                            <div class="detail-item">
                                <label>Equipment</label>
                                <value>${irrigation.equipmentUsed}</value>
                            </div>
                            ` : ''}
                            ${irrigation.waterQuality ? `
                            <div class="detail-item">
                                <label>Water Quality</label>
                                <value>${irrigation.waterQuality}</value>
                            </div>
                            ` : ''}
                            <div class="detail-item">
                                <label>Fertilizer Applied</label>
                                <value>${irrigation.fertilizerApplied ? '✅ Yes' : '❌ No'}</value>
                            </div>
                            ${irrigation.notes ? `
                            <div class="detail-item full-width">
                                <label>Notes</label>
                                <value>${irrigation.notes}</value>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeIrrigationDetailsModal()">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                        <button type="button" class="btn btn-primary" onclick="closeIrrigationDetailsModal(); editIrrigation('${irrigation.id}')">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

    } catch (error) {
        console.error('Error loading irrigation details:', error);
        showToast('❌ Error loading details', 'error');
    } finally {
        hideLoading();
    }
}


/**
 * Generate edit form fields for irrigation
 */
function generateEditFormFields(irrigation) {
    return `
        <!-- Water Cost -->
        <div class="form-group">
            <label>Water Cost per Liter (RWF)</label>
            <input type="number" name="waterCost" class="form-control"
                   min="0" step="0.01" value="${irrigation.waterCost || ''}" placeholder="e.g., 0.5">
        </div>

        <!-- Soil Moisture Before -->
        <div class="form-group">
            <label>Soil Moisture Before (%)</label>
            <input type="number" name="soilMoistureBefore" class="form-control"
                   min="0" max="100" step="0.01" value="${irrigation.soilMoistureBefore || ''}" placeholder="e.g., 45.5">
        </div>

        <!-- Soil Moisture After -->
        <div class="form-group">
            <label>Soil Moisture After (%)</label>
            <input type="number" name="soilMoistureAfter" class="form-control"
                   min="0" max="100" step="0.01" value="${irrigation.soilMoistureAfter || ''}" placeholder="e.g., 65.5">
        </div>

        <!-- Weather Condition -->
        <div class="form-group">
            <label>Weather Condition</label>
            <input type="text" name="weatherCondition" class="form-control"
                   value="${irrigation.weatherCondition || ''}" placeholder="e.g., Sunny, Cloudy" maxlength="100">
        </div>

        <!-- Operator Name -->
        <div class="form-group">
            <label>Operator Name</label>
            <input type="text" name="operatorName" class="form-control"
                   value="${irrigation.operatorName || ''}" placeholder="e.g., John Doe" maxlength="100">
        </div>

        <!-- Equipment Used -->
        <div class="form-group">
            <label>Equipment Used</label>
            <input type="text" name="equipmentUsed" class="form-control"
                   value="${irrigation.equipmentUsed || ''}" placeholder="e.g., Sprinkler System X200" maxlength="100">
        </div>

        <!-- Water Quality -->
        <div class="form-group">
            <label>Water Quality</label>
            <input type="text" name="waterQuality" class="form-control"
                   value="${irrigation.waterQuality || ''}" placeholder="e.g., Good, Excellent" maxlength="100">
        </div>

        <!-- Fertilizer Applied -->
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" name="fertilizerApplied" value="true" ${irrigation.fertilizerApplied ? 'checked' : ''}>
                Fertilizer Applied During Irrigation
            </label>
        </div>

        <!-- Notes -->
        <div class="form-group full-width">
            <label>Additional Notes</label>
            <textarea name="notes" class="form-control" rows="3"
                      placeholder="Any additional observations or notes..." maxlength="3000">${irrigation.notes || ''}</textarea>
        </div>
    `;
}

/**
 * Close irrigation details modal
 */
function closeIrrigationDetailsModal() {
    const modal = document.getElementById('irrigationDetailsModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}

/**
 * Delete irrigation - VERSION CORRIGÉE POUR SPRING BOOT
 */
async function deleteIrrigation(irrigationId) {
    if (!confirm('Are you sure you want to delete this irrigation record?')) {
        return;
    }

    try {
        showLoading();
        await apiRequest(`/irrigation/${irrigationId}`, { method: 'DELETE' });
        showToast('✅ Irrigation record deleted successfully', 'success');
        await loadIrrigationData();
    } catch (error) {
        console.error('Error deleting irrigation:', error);
        showToast('❌ Error deleting irrigation', 'error');
    } finally {
        hideLoading();
    }
}






/**
 * Edit irrigation - IMPROVED DESIGN VERSION
 */
async function editIrrigation(irrigationId) {
    try {
        showLoading();

        const irrigation = await apiRequest(`/irrigation/${irrigationId}`);
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

        const irrigationDate = irrigation.irrigationDate ?
            irrigation.irrigationDate.replace('Z', '').substring(0, 16) :
            new Date().toISOString().slice(0, 16);

        const modalHTML = `
            <div class="modal-overlay show" id="irrigationModal" onclick="if(event.target === this) closeIrrigationModal()">
                <div class="modal-container modal-irrigation">
                    <div class="modal-header-gradient">
                        <div class="modal-header-content">
                            <div class="modal-icon-wrapper">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div>
                                <h3 class="modal-title">Edit Irrigation Session</h3>
                                <p class="modal-subtitle">Update your irrigation record details</p>
                            </div>
                        </div>
                        <button class="modal-close-elegant" onclick="closeIrrigationModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <form id="editIrrigationForm" onsubmit="updateIrrigation(event, '${irrigationId}')">
                        <div class="modal-body-tabs">
                            <!-- Tab Navigation -->
                            <div class="tabs-nav">
                                <button type="button" class="tab-btn active" data-tab="basic">
                                    <i class="fas fa-info-circle"></i> Basic Info
                                </button>
                                <button type="button" class="tab-btn" data-tab="details">
                                    <i class="fas fa-sliders-h"></i> Details
                                </button>
                                <button type="button" class="tab-btn" data-tab="notes">
                                    <i class="fas fa-sticky-note"></i> Notes
                                </button>
                            </div>

                            <!-- Tab Content: Basic Info -->
                            <div class="tab-content active" data-tab-content="basic">
                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-map-marker-alt"></i> Location & Timing
                                    </h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label required">
                                                <i class="fas fa-farm"></i> Select Farm
                                            </label>
                                            <select name="farmId" class="form-input" required>
                                                <option value="">Choose a farm...</option>
                                                ${farms.map(farm =>
                                                    `<option value="${farm.id}" ${farm.id === irrigation.farmId ? 'selected' : ''}>
                                                        ${farm.farmName} ${farm.location ? '• ' + farm.location : ''}
                                                    </option>`
                                                ).join('')}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required">
                                                <i class="fas fa-calendar-alt"></i> Date & Time
                                            </label>
                                            <input type="datetime-local" name="irrigationDate" class="form-input"
                                                   value="${irrigationDate}" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-water"></i> Water Usage
                                    </h4>
                                    <div class="form-row-triple">
                                        <div class="form-group">
                                            <label class="form-label required">
                                                <i class="fas fa-droplet"></i> Water Amount
                                            </label>
                                            <div class="input-with-unit">
                                                <input type="number" name="waterAmount" class="form-input"
                                                       min="0.01" step="0.01" value="${irrigation.waterAmount || ''}" required>
                                                <span class="input-unit">Liters</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required">
                                                <i class="fas fa-clock"></i> Duration
                                            </label>
                                            <div class="input-with-unit">
                                                <input type="number" name="duration" class="form-input"
                                                       min="1" max="1440" value="${irrigation.duration || ''}" required>
                                                <span class="input-unit">Minutes</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-money-bill-wave"></i> Cost per Liter
                                            </label>
                                            <div class="input-with-unit">
                                                <input type="number" name="waterCost" class="form-input"
                                                       min="0" step="0.01" value="${irrigation.waterCost || ''}" placeholder="0.5">
                                                <span class="input-unit">RWF</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-cog"></i> Method & Source
                                    </h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label required">
                                                <i class="fas fa-spray-can"></i> Irrigation Method
                                            </label>
                                            <select name="irrigationMethod" class="form-input" required>
                                                <option value="">Choose method...</option>
                                                <option value="SPRINKLER" ${irrigation.irrigationMethod === 'SPRINKLER' ? 'selected' : ''}>🌊 Sprinkler System</option>
                                                <option value="DRIP" ${irrigation.irrigationMethod === 'DRIP' ? 'selected' : ''}>💧 Drip Irrigation</option>
                                                <option value="FLOOD" ${irrigation.irrigationMethod === 'FLOOD' ? 'selected' : ''}>🌊 Flood Irrigation</option>
                                                <option value="FURROW" ${irrigation.irrigationMethod === 'FURROW' ? 'selected' : ''}>🌾 Furrow Irrigation</option>
                                                <option value="MANUAL" ${irrigation.irrigationMethod === 'MANUAL' ? 'selected' : ''}>🪣 Manual Watering</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required">
                                                <i class="fas fa-water"></i> Water Source
                                            </label>
                                            <select name="waterSource" class="form-input" required>
                                                <option value="">Choose source...</option>
                                                <option value="WELL" ${irrigation.waterSource === 'WELL' ? 'selected' : ''}>🔷 Well</option>
                                                <option value="RIVER" ${irrigation.waterSource === 'RIVER' ? 'selected' : ''}>🌊 River</option>
                                                <option value="LAKE" ${irrigation.waterSource === 'LAKE' ? 'selected' : ''}>🏞️ Lake</option>
                                                <option value="RAINWATER" ${irrigation.waterSource === 'RAINWATER' ? 'selected' : ''}>☔ Rainwater</option>
                                                <option value="MUNICIPAL" ${irrigation.waterSource === 'MUNICIPAL' ? 'selected' : ''}>🏛️ Municipal Supply</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Content: Details -->
                            <div class="tab-content" data-tab-content="details">
                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-thermometer-half"></i> Soil Moisture Levels
                                    </h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-arrow-down"></i> Before Irrigation
                                            </label>
                                            <div class="input-with-unit">
                                                <input type="number" name="soilMoistureBefore" class="form-input"
                                                       min="0" max="100" step="0.1" value="${irrigation.soilMoistureBefore || ''}" placeholder="45.5">
                                                <span class="input-unit">%</span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-arrow-up"></i> After Irrigation
                                            </label>
                                            <div class="input-with-unit">
                                                <input type="number" name="soilMoistureAfter" class="form-input"
                                                       min="0" max="100" step="0.1" value="${irrigation.soilMoistureAfter || ''}" placeholder="65.5">
                                                <span class="input-unit">%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-tools"></i> Equipment & Personnel
                                    </h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-user"></i> Operator Name
                                            </label>
                                            <input type="text" name="operatorName" class="form-input"
                                                   value="${irrigation.operatorName || ''}" placeholder="John Doe" maxlength="100">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-toolbox"></i> Equipment Used
                                            </label>
                                            <input type="text" name="equipmentUsed" class="form-input"
                                                   value="${irrigation.equipmentUsed || ''}" placeholder="Sprinkler System X200" maxlength="100">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-cloud-sun"></i> Environmental Conditions
                                    </h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-cloud"></i> Weather Condition
                                            </label>
                                            <input type="text" name="weatherCondition" class="form-input"
                                                   value="${irrigation.weatherCondition || ''}" placeholder="Sunny, Cloudy, etc." maxlength="100">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">
                                                <i class="fas fa-flask"></i> Water Quality
                                            </label>
                                            <input type="text" name="waterQuality" class="form-input"
                                                   value="${irrigation.waterQuality || ''}" placeholder="Good, Excellent, etc." maxlength="100">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-section">
                                    <div class="checkbox-card">
                                        <input type="checkbox" name="fertilizerApplied" value="true" id="fertilizerCheck" ${irrigation.fertilizerApplied ? 'checked' : ''}>
                                        <label for="fertilizerCheck" class="checkbox-card-label">
                                            <i class="fas fa-leaf"></i>
                                            <span>Fertilizer applied during this irrigation session</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Content: Notes -->
                            <div class="tab-content" data-tab-content="notes">
                                <div class="form-section">
                                    <h4 class="form-section-title">
                                        <i class="fas fa-sticky-note"></i> Additional Information
                                    </h4>
                                    <div class="form-group">
                                        <label class="form-label">Notes & Observations</label>
                                        <textarea name="notes" class="form-textarea" rows="8"
                                                  placeholder="Record any additional observations, issues encountered, or special notes about this irrigation session...">${irrigation.notes || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer-elegant">
                            <button type="button" class="btn-elegant btn-cancel" onclick="closeIrrigationModal()">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" class="btn-elegant btn-submit">
                                <i class="fas fa-save"></i>
                                Update Irrigation
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;
        initializeIrrigationTabs();

    } catch (error) {
        console.error('Error opening edit irrigation modal:', error);
        showToast('❌ Error opening edit form', 'error');
    } finally {
        hideLoading();
    }
}





/**
 * Update irrigation - VERSION CORRIGÉE POUR SPRING BOOT
 */
async function updateIrrigation(event, irrigationId) {
    event.preventDefault();

    try {
        showLoading();

        const form = event.target;
        const formData = new FormData(form);

        // Construire l'objet irrigation pour la mise à jour
        const irrigationData = {
            farmId: formData.get('farmId'),
            irrigationDate: formData.get('irrigationDate') + ':00',
            waterAmount: parseFloat(formData.get('waterAmount')),
            duration: parseInt(formData.get('duration')),
            irrigationMethod: formData.get('irrigationMethod'),
            waterSource: formData.get('waterSource'),
            waterCost: formData.get('waterCost') ? parseFloat(formData.get('waterCost')) : null,
            soilMoistureBefore: formData.get('soilMoistureBefore') ? parseFloat(formData.get('soilMoistureBefore')) : null,
            soilMoistureAfter: formData.get('soilMoistureAfter') ? parseFloat(formData.get('soilMoistureAfter')) : null,
            weatherCondition: formData.get('weatherCondition') || null,
            operatorName: formData.get('operatorName') || null,
            equipmentUsed: formData.get('equipmentUsed') || null,
            waterQuality: formData.get('waterQuality') || null,
            fertilizerApplied: formData.get('fertilizerApplied') === 'true',
            notes: formData.get('notes') || null
        };

        console.log('📤 Updating irrigation data:', irrigationData);

        // Appel PUT vers Spring backend
        const response = await apiRequest(`/irrigation/${irrigationId}`, {
            method: 'PUT',
            body: JSON.stringify(irrigationData)
        });

        console.log('✅ Irrigation updated successfully:', response);

        showToast('✅ Irrigation record updated successfully!', 'success');
        closeIrrigationModal();
        await loadIrrigationData();

    } catch (error) {
        console.error('❌ Error updating irrigation:', error);
        showToast(`❌ Error updating irrigation: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}

// ============================================================================
// SETUP EVENT LISTENERS FOR IRRIGATION SECTION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Écouter le clic sur le bouton "Record Irrigation"
    const addIrrigationBtn = document.querySelector('[data-action="add-irrigation"]');
    if (addIrrigationBtn) {
        addIrrigationBtn.addEventListener('click', openAddIrrigationModal);
    }

    // Écouter le clic sur le bouton "Refresh"
    const refreshIrrigationBtn = document.querySelector('[data-action="refresh-irrigation"]');
    if (refreshIrrigationBtn) {
        refreshIrrigationBtn.addEventListener('click', loadIrrigationData);
    }
});



/**
 * Create irrigation trend chart
 */
function createIrrigationTrendChart(irrigations) {
    const ctx = document.getElementById('irrigationTrendChart');
    if (!ctx) return;

    // Group by month
    const monthlyData = {};
    irrigations.forEach(irrig => {
        const date = new Date(irrig.irrigationDate);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = 0;
        }
        monthlyData[monthKey] += parseFloat(irrig.waterAmount) || 0;
    });

    const sortedKeys = Object.keys(monthlyData).sort();
    const labels = sortedKeys.map(key => {
        const [year, month] = key.split('-');
        return new Date(year, parseInt(month) - 1).toLocaleString('default', { month: 'short', year: 'numeric' });
    });
    const data = sortedKeys.map(key => monthlyData[key]);

    if (window.charts && window.charts.irrigationTrend) {
        window.charts.irrigationTrend.destroy();
    }

    if (!window.charts) window.charts = {};

    window.charts.irrigationTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Water Usage (Liters)',
                data: data,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' L';
                        }
                    }
                }
            }
        }
    });
}

// ============================================================================
// SETUP EVENT LISTENERS FOR IRRIGATION SECTION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Écouter le clic sur le bouton "Record Irrigation"
    const addIrrigationBtn = document.querySelector('[data-action="add-irrigation"]');
    if (addIrrigationBtn) {
        addIrrigationBtn.addEventListener('click', openAddIrrigationModal);
    }

    // Écouter le clic sur le bouton "Refresh"
    const refreshIrrigationBtn = document.querySelector('[data-action="refresh-irrigation"]');
    if (refreshIrrigationBtn) {
        refreshIrrigationBtn.addEventListener('click', loadIrrigationData);
    }
});









/**
 * Export irrigation to Excel
 */
async function exportIrrigationToExcel() {
    try {
        showLoading();
        showToast('Preparing export...', 'info');

        // Récupérer les fermes
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

        // Build farmsMap for name lookup
        const farmsMap = {};
        farms.forEach(f => { if (f?.id) farmsMap[f.id] = f.farmName || 'Unknown Farm'; });

        let irrigations = [];

        if (farms.length > 0) {
            const irrigationPromises = farms.map(farm =>
                apiRequest(`/irrigation/farm/${farm.id}`).catch(() => [])
            );
            const irrigationArrays = await Promise.all(irrigationPromises);

            irrigationArrays.forEach(response => {
                let farmIrrigations = [];
                if (Array.isArray(response)) farmIrrigations = response;
                else if (response?.content && Array.isArray(response.content)) farmIrrigations = response.content;
                else if (response?.data && Array.isArray(response.data)) farmIrrigations = response.data;
                irrigations = irrigations.concat(farmIrrigations);
            });
        }

        if (irrigations.length === 0) {
            showToast('No irrigation data to export', 'warning');
            hideLoading();
            return;
        }

        // Enrich with farm names
        irrigations.forEach(irrig => {
            irrig.farmName = (irrig.farmId && farmsMap[irrig.farmId]) ? farmsMap[irrig.farmId] : 'Unknown Farm';
        });

        // Headers
        const headers = [
            'Date', 'Farm', 'Water Amount (L)', 'Duration (min)', 'Method', 'Water Source',
            'Cost/Liter (RWF)', 'Total Cost (RWF)',
            'Moisture Before (%)', 'Moisture After (%)',
            'Weather', 'Operator', 'Equipment', 'Water Quality',
            'Fertilizer Applied', 'Notes'
        ];

        // Rows
        const rows = irrigations.map(i => [
            i.irrigationDate ? i.irrigationDate.split('T')[0] : '',
            i.farmName || '',
            parseFloat(i.waterAmount) || 0,
            parseInt(i.duration) || 0,
            i.irrigationMethod || '',
            i.waterSource || '',
            parseFloat(i.waterCost) || '',
            parseFloat(i.totalCost) || 0,
            i.soilMoistureBefore != null ? parseFloat(i.soilMoistureBefore) : '',
            i.soilMoistureAfter != null ? parseFloat(i.soilMoistureAfter) : '',
            i.weatherCondition || '',
            i.operatorName || '',
            i.equipmentUsed || '',
            i.waterQuality || '',
            i.fertilizerApplied ? 'Yes' : 'No',
            i.notes || ''
        ]);

        // Shared strings
        const strings = [];
        const strMap = {};
        function addString(val) {
            const s = String(val);
            if (!(s in strMap)) { strMap[s] = strings.length; strings.push(s); }
            return strMap[s];
        }
        headers.forEach(h => addString(h));
        rows.forEach(row => row.forEach(cell => { if (typeof cell === 'string') addString(cell); }));

        function escapeXml(s) {
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
        }

        function cellRef(col, row) {
            let c = '', n = col;
            while (n >= 0) { c = String.fromCharCode(65 + (n % 26)) + c; n = Math.floor(n / 26) - 1; }
            return c + (row + 1);
        }

        // waterAmount, duration, cost/liter, totalCost, moistureBefore, moistureAfter
        const numCols = [2, 3, 6, 7, 8, 9];

        // sheet1.xml
        let sheetRows = '';
        let headerCells = headers.map((h, ci) => `<c r="${cellRef(ci,0)}" t="s" s="1"><v>${addString(h)}</v></c>`).join('');
        sheetRows += `<row r="1">${headerCells}</row>`;

        rows.forEach((row, ri) => {
            let cells = row.map((cell, ci) => {
                const ref = cellRef(ci, ri + 1);
                if (numCols.includes(ci) && cell !== '' && !isNaN(cell)) {
                    return `<c r="${ref}" s="2"><v>${cell}</v></c>`;
                }
                return `<c r="${ref}" t="s" s="2"><v>${addString(String(cell))}</v></c>`;
            }).join('');
            sheetRows += `<row r="${ri + 2}">${cells}</row>`;
        });

        const sheet1 = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<sheetViews><sheetView tabSelected="1" workbookViewId="0"/></sheetViews>
<sheetFormatPr defaultRowHeight="20"/>
<cols>${headers.map((_,i) => `<col min="${i+1}" max="${i+1}" width="22" customWidth="1"/>`).join('')}</cols>
<sheetData>${sheetRows}</sheetData>
</worksheet>`;

        const styles = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<fonts count="3">
  <font><sz val="11"/><name val="Calibri"/></font>
  <font><b/><sz val="11"/><color rgb="FFFFFFFF"/><name val="Calibri"/></font>
  <font><sz val="11"/><name val="Calibri"/></font>
</fonts>
<fills count="3">
  <fill><patternFill patternType="none"/></fill>
  <fill><patternFill patternType="solid"><fgColor rgb="FF10B981"/></patternFill></fill>
  <fill><patternFill patternType="solid"><fgColor rgb="FFF0FDF4"/></patternFill></fill>
</fills>
<borders count="2">
  <border><left/><right/><top/><bottom/><diagonal/></border>
  <border><left style="thin"><color rgb="FF10B981"/></left><right style="thin"><color rgb="FF10B981"/></right><top style="thin"><color rgb="FF10B981"/></top><bottom style="thin"><color rgb="FF10B981"/></bottom><diagonal/></border>
</borders>
<cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>
<cellXfs count="3">
  <xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/>
  <xf numFmtId="0" fontId="1" fillId="1" borderId="1" xfId="0" applyFont="1" applyFill="1" applyBorder="1" applyAlignment="1"><alignment horizontal="center" vertical="center"/></xf>
  <xf numFmtId="0" fontId="2" fillId="2" borderId="1" xfId="0" applyFill="1" applyBorder="1"/>
</cellXfs>
</styleSheet>`;

        const sharedStrings = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="${strings.length}" uniqueCount="${strings.length}">
${strings.map(s => `<si><t>${escapeXml(s)}</t></si>`).join('')}
</sst>`;

        const workbook = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
<sheets><sheet name="Irrigation Records" sheetId="1" r:id="rId1"/></sheets>
</workbook>`;

        const rels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
<Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings" Target="sharedStrings.xml"/>
</Relationships>`;

        const topRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
</Relationships>`;

        const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
<Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
<Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>
<Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/>
</Types>`;

        const files = {
            '[Content_Types].xml': contentTypes,
            '_rels/.rels': topRels,
            'xl/workbook.xml': workbook,
            'xl/_rels/workbook.xml.rels': rels,
            'xl/worksheets/sheet1.xml': sheet1,
            'xl/styles.xml': styles,
            'xl/sharedStrings.xml': sharedStrings
        };

        const blob = await buildZipBlob(files);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Irrigation_Records_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('✅ Export successful!', 'success');

    } catch (error) {
        console.error('❌ Export error:', error);
        showToast('Failed to export: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// ✅ Remplacer l'ancien listener Export irrigation
document.querySelectorAll('[data-action="export-irrigation"]').forEach(btn => {
    btn.addEventListener('click', exportIrrigationToExcel);
});





// ============================================================================
// SOIL DATA MODULE - CORRECTED VERSION
// ============================================================================

/**
 * Load soil data - CORRECTION COMPLÈTE
 * Fix: Utiliser le bon endpoint v1 et gérer les erreurs proprement
 */
async function loadSoilData() {
  try {
    showLoading();

    if (!currentUser || !currentUser.id) {
      console.warn('⚠️ No current user found');
      displayEmptySoilData();
      return;
    }

    console.log('🔄 Loading soil data for farmer:', currentUser.id);

    // CORRECTION 1: Récupérer d'abord les fermes de l'utilisateur
    let farms = [];
    try {
      const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
      farms = Array.isArray(farmsResponse) ? farmsResponse : [];
      console.log(`✅ Loaded ${farms.length} farms`);
    } catch (error) {
      console.warn('⚠️ Error loading farms:', error.message);
      farms = [];
    }

    if (farms.length === 0) {
      console.warn('⚠️ No farms found for user');
      displayEmptySoilData();
      return;
    }

    // CORRECTION 2: Récupérer les données de sol pour chaque ferme avec le bon endpoint
    let allSoilData = [];

    for (const farm of farms) {
      try {
        console.log(`🔄 Fetching soil data for farm ${farm.id}`);

        // CORRECTION 3: Utiliser le bon endpoint /api/v1/soil-data/farm/{farmId}
        const soilResponse = await apiRequest(`/v1/soil-data/farm/${farm.id}/all`);

        // CORRECTION 4: Gérer différents formats de réponse
        let farmSoilData = [];
        if (Array.isArray(soilResponse)) {
          farmSoilData = soilResponse;
        } else if (soilResponse && soilResponse.content && Array.isArray(soilResponse.content)) {
          farmSoilData = soilResponse.content;
        } else if (soilResponse && soilResponse.data && Array.isArray(soilResponse.data)) {
          farmSoilData = soilResponse.data;
        } else if (soilResponse && typeof soilResponse === 'object') {
          // Si c'est un objet unique, le mettre dans un tableau
          farmSoilData = [soilResponse];
        } else {
          console.warn(`⚠️ Unexpected soil data format for farm ${farm.id}:`, soilResponse);
          farmSoilData = [];
        }

        console.log(`✅ Loaded ${farmSoilData.length} soil records for farm ${farm.id}`);
        allSoilData = allSoilData.concat(farmSoilData);

      } catch (error) {
        console.warn(`⚠️ Error loading soil data for farm ${farm.id}:`, error.message);
        // Continue avec les autres fermes même en cas d'erreur
      }
    }

    console.log(`✅ Total soil data records loaded: ${allSoilData.length}`);

    // Afficher les données
    displaySoilDataGrid(allSoilData, farms);
    updateSoilDataStatistics(allSoilData);

  } catch (error) {
    console.error('❌ Error loading soil data:', error);
    showToast('Unable to load soil data', 'warning');
    displayEmptySoilData();
  } finally {
    hideLoading();
  }
}

/**
 * Display soil data grid - VERSION AMÉLIORÉE
 */
function displaySoilDataGrid(soilData, farms) {
  const container = document.getElementById('soilDataGrid');
  if (!container) {
    console.warn('⚠️ Soil data container not found');
    return;
  }

  if (!soilData || soilData.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-mountain"></i>
        </div>
        <h3>No Soil Data Available</h3>
        <p>No soil analysis records found for your farms.</p>
        <p class="empty-state-hint">
          <i class="fas fa-info-circle"></i>
          Contact your agricultural advisor for soil testing services
        </p>
        <button class="btn btn-primary mt-4" onclick="showSoilTestingInfo()">
          <i class="fas fa-flask"></i>
          Learn About Soil Testing
        </button>
      </div>
    `;
    return;
  }

  // Créer une map des fermes pour un accès rapide
  const farmMap = new Map();
  if (farms && Array.isArray(farms)) {
    farms.forEach(farm => farmMap.set(farm.id, farm));
  }

  container.innerHTML = soilData.map(soil => {
    const farm = farmMap.get(soil.farmId);
    const farmName = farm ? farm.farmName : 'Unknown Farm';

    // Gérer les valeurs nulles proprement
    const phLevel = soil.phLevel ? parseFloat(soil.phLevel).toFixed(2) : 'N/A';
    const phStatus = soil.phLevel ? getPhStatus(soil.phLevel) : 'unknown';
    const phLabel = soil.phLevel ? getPhLabel(soil.phLevel) : 'Unknown';

    const nitrogenLevel = soil.nitrogenLevel || 'N/A';
    const phosphorusLevel = soil.phosphorusLevel || 'N/A';
    const potassiumLevel = soil.potassiumLevel || 'N/A';
    const organicMatter = soil.organicMatter ? parseFloat(soil.organicMatter).toFixed(2) : 'N/A';
    const moisture = soil.moisture ? parseFloat(soil.moisture).toFixed(2) : 'N/A';

    const measurementDate = soil.measurementDate ? formatDate(soil.measurementDate) : 'N/A';
    const sampleCode = soil.sampleCode || 'N/A';
    const depthCm = soil.depthCm || 'N/A';

    return `
      <div class="soil-data-card" data-soil-id="${soil.id}">
        <div class="soil-card-header">
          <div class="soil-icon">🌱</div>
          <h3 class="soil-name">${escapeHtml(farmName)}</h3>
          <span class="soil-sample-badge">Sample: ${escapeHtml(sampleCode)}</span>
        </div>
        <div class="soil-card-body">
          <div class="soil-info-list">
            <div class="soil-info-item">
              <span class="soil-info-label">pH Level</span>
              <span class="soil-info-value" style="background: ${phStatus === 'good' ? 'rgba(34, 197, 94, 0.15)' : phStatus === 'moderate' ? 'rgba(255, 193, 7, 0.15)' : 'rgba(239, 68, 68, 0.15)'}; color: ${phStatus === 'good' ? 'var(--primary-green)' : phStatus === 'moderate' ? '#f59e0b' : '#ef4444'}; font-weight: 800; font-size: 16px;">${phLevel} (${phLabel})</span>
            </div>
            <div class="soil-info-item">
              <span class="soil-info-label">Nitrogen (N)</span>
              <span class="soil-info-value">${escapeHtml(nitrogenLevel)}</span>
            </div>
            <div class="soil-info-item">
              <span class="soil-info-label">Phosphorus (P)</span>
              <span class="soil-info-value">${escapeHtml(phosphorusLevel)}</span>
            </div>
            <div class="soil-info-item">
              <span class="soil-info-label">Potassium (K)</span>
              <span class="soil-info-value">${escapeHtml(potassiumLevel)}</span>
            </div>
            <div class="soil-info-item">
              <span class="soil-info-label">Organic Matter</span>
              <span class="soil-info-value">${organicMatter}%</span>
            </div>
            <div class="soil-info-item">
              <span class="soil-info-label">Moisture</span>
              <span class="soil-info-value">${moisture}%</span>
            </div>
            <div class="soil-info-item">
              <span class="soil-info-label">Depth</span>
              <span class="soil-info-value">${depthCm} cm</span>
            </div>
            ${soil.soilTexture ? `
            <div class="soil-info-item">
              <span class="soil-info-label">Texture</span>
              <span class="soil-info-value">${escapeHtml(soil.soilTexture)}</span>
            </div>
            ` : ''}
            <div class="soil-info-item">
              <span class="soil-info-label">Measurement Date</span>
              <span class="soil-info-value">${measurementDate}</span>
            </div>
            ${soil.laboratoryName ? `
            <div class="soil-info-item">
              <span class="soil-info-label">Laboratory</span>
              <span class="soil-info-value">${escapeHtml(soil.laboratoryName)}</span>
            </div>
            ` : ''}
            ${soil.testingMethod ? `
            <div class="soil-info-item">
              <span class="soil-info-label">Testing Method</span>
              <span class="soil-info-value">${escapeHtml(soil.testingMethod)}</span>
            </div>
            ` : ''}
          </div>
          ${soil.recommendations ? `
          <div style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); border-left: 4px solid #ffc107; border-radius: 8px;">
            <h4 style="margin: 0 0 0.5rem 0; color: #856404; font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
              <i class="fas fa-lightbulb" style="color: #ffc107;"></i>
              Recommendations
            </h4>
            <p style="margin: 0; color: #666; line-height: 1.6; font-size: 0.9rem;">${escapeHtml(soil.recommendations)}</p>
          </div>
          ` : ''}
          <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
            <button class="btn" onclick="viewSoilDetails('${soil.id}')" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)';">
              <i class="fas fa-eye"></i>
              View Report
            </button>
            <button class="btn" onclick="downloadSoilReport('${soil.id}')" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(34, 197, 94, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.3)';">
              <i class="fas fa-download"></i>
              Download PDF
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

/**
 * Update soil data statistics
 */
function updateSoilDataStatistics(soilData) {
  const statsContainer = document.getElementById('soilStats');
  if (!statsContainer || !soilData || soilData.length === 0) return;

  try {
    // Calculer les statistiques
    const totalSamples = soilData.length;

    // pH moyen
    const phValues = soilData
      .filter(s => s.phLevel)
      .map(s => parseFloat(s.phLevel));
    const avgPh = phValues.length > 0
      ? (phValues.reduce((a, b) => a + b, 0) / phValues.length).toFixed(2)
      : 0;

    // Organic matter moyen
    const organicValues = soilData
      .filter(s => s.organicMatter)
      .map(s => parseFloat(s.organicMatter));
    const avgOrganic = organicValues.length > 0
      ? (organicValues.reduce((a, b) => a + b, 0) / organicValues.length).toFixed(2)
      : 0;

    // Compter les sols avec problèmes
    let problematicSoils = 0;
    soilData.forEach(soil => {
      if (soil.phLevel) {
        const ph = parseFloat(soil.phLevel);
        if (ph < 5.5 || ph > 8.0) problematicSoils++;
      }
      if (soil.organicMatter && parseFloat(soil.organicMatter) < 2.0) {
        problematicSoils++;
      }
    });

    // Tests nécessaires (simulé - basé sur la date du dernier test)
    const today = new Date();
    let testsDue = 0;
    soilData.forEach(soil => {
      if (soil.nextTestDueDate) {
        const dueDate = new Date(soil.nextTestDueDate);
        if (dueDate <= today) testsDue++;
      }
    });

    // Afficher les statistiques
    const statsHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon primary">
            <i class="fas fa-vial"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Total Samples</span>
            <span class="stat-value">${totalSamples}</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon info">
            <i class="fas fa-tint"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Average pH</span>
            <span class="stat-value">${avgPh}</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon success">
            <i class="fas fa-recycle"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Avg Organic Matter</span>
            <span class="stat-value">${avgOrganic}%</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon ${problematicSoils > 0 ? 'warning' : 'success'}">
            <i class="fas fa-${problematicSoils > 0 ? 'exclamation-triangle' : 'check-circle'}"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Problematic Soils</span>
            <span class="stat-value">${problematicSoils}</span>
          </div>
        </div>

        ${testsDue > 0 ? `
        <div class="stat-card">
          <div class="stat-icon warning">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Tests Due</span>
            <span class="stat-value">${testsDue}</span>
          </div>
        </div>
        ` : ''}
      </div>
    `;

    statsContainer.innerHTML = statsHTML;

  } catch (error) {
    console.error('Error updating soil statistics:', error);
  }
}

/**
 * Display empty soil data state
 */
function displayEmptySoilData() {
  const container = document.getElementById('soilDataGrid');
  if (!container) return;

  container.innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">
        <i class="fas fa-mountain"></i>
      </div>
      <h3>No Soil Data Available</h3>
      <p>Start managing your soil health by conducting soil tests.</p>
      <div class="empty-state-actions">
        <button class="btn btn-primary" onclick="showSoilTestingInfo()">
          <i class="fas fa-flask"></i>
          Learn About Soil Testing
        </button>
      </div>
    </div>
  `;

  // Réinitialiser les stats
  const statsContainer = document.getElementById('soilStats');
  if (statsContainer) {
    statsContainer.innerHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-vial"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Total Samples</span>
            <span class="stat-value">0</span>
          </div>
        </div>
      </div>
    `;
  }
}

/**
 * Get pH status class
 */
function getPhStatus(ph) {
  const phValue = parseFloat(ph);
  if (isNaN(phValue)) return 'unknown';

  if (phValue >= 6.0 && phValue <= 7.5) return 'good';
  if ((phValue >= 5.5 && phValue < 6.0) || (phValue > 7.5 && phValue <= 8.0)) return 'moderate';
  return 'poor';
}

/**
 * Get pH label
 */
function getPhLabel(ph) {
  const phValue = parseFloat(ph);
  if (isNaN(phValue)) return 'Unknown';

  if (phValue >= 6.0 && phValue <= 7.5) return 'Optimal';
  if (phValue < 6.0) return 'Acidic';
  return 'Alkaline';
}

/**
 * View soil details - CORRECTION
 */
async function viewSoilDetails(soilId) {
  try {
    showLoading();

    // CORRECTION: Utiliser le bon endpoint
    const soil = await apiRequest(`/v1/soil-data/${soilId}`);

    showSoilDetailsModal(soil);

  } catch (error) {
    console.error('Error loading soil details:', error);
    showToast('❌ Error loading soil details', 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Show soil details modal
 */
function showSoilDetailsModal(soil) {
  if (!soil) return;

  const modalHTML = `
    <div class="modal-overlay show" id="soilModal" onclick="if(event.target === this) closeSoilModal()">
      <div class="modal-container modal-large">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-flask"></i>
            Soil Analysis Report
          </h3>
          <button class="modal-close" onclick="closeSoilModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="soil-report">

            <!-- Sample Information -->
            <div class="report-section">
              <h4><i class="fas fa-info-circle"></i> Sample Information</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <label>Sample Code:</label>
                  <value>${soil.sampleCode || 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Measurement Date:</label>
                  <value>${soil.measurementDate ? formatDate(soil.measurementDate) : 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Depth:</label>
                  <value>${soil.depthCm || 'N/A'} cm</value>
                </div>
                <div class="detail-item">
                  <label>Soil Texture:</label>
                  <value>${soil.soilTexture || 'N/A'}</value>
                </div>
              </div>
            </div>

            <!-- Chemical Properties -->
            <div class="report-section">
              <h4><i class="fas fa-flask"></i> Chemical Properties</h4>
              <div class="details-grid">
                <div class="detail-item highlight">
                  <label>pH Level:</label>
                  <value class="${getPhStatus(soil.phLevel)}">
                    ${soil.phLevel ? parseFloat(soil.phLevel).toFixed(2) : 'N/A'}
                    <span class="status-badge">${getPhLabel(soil.phLevel)}</span>
                  </value>
                </div>
                <div class="detail-item">
                  <label>Nitrogen (N):</label>
                  <value>${soil.nitrogenLevel || 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Phosphorus (P):</label>
                  <value>${soil.phosphorusLevel || 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Potassium (K):</label>
                  <value>${soil.potassiumLevel || 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Organic Matter:</label>
                  <value>${soil.organicMatter ? parseFloat(soil.organicMatter).toFixed(2) + '%' : 'N/A'}</value>
                </div>
                ${soil.electricalConductivity ? `
                <div class="detail-item">
                  <label>EC (Salinity):</label>
                  <value>${soil.electricalConductivity} dS/m</value>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Physical Properties -->
            <div class="report-section">
              <h4><i class="fas fa-layer-group"></i> Physical Properties</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <label>Moisture:</label>
                  <value>${soil.moisture ? parseFloat(soil.moisture).toFixed(2) + '%' : 'N/A'}</value>
                </div>
                ${soil.bulkDensity ? `
                <div class="detail-item">
                  <label>Bulk Density:</label>
                  <value>${soil.bulkDensity} g/cm³</value>
                </div>
                ` : ''}
                ${soil.porosity ? `
                <div class="detail-item">
                  <label>Porosity:</label>
                  <value>${soil.porosity}%</value>
                </div>
                ` : ''}
                ${soil.drainageClass ? `
                <div class="detail-item">
                  <label>Drainage Class:</label>
                  <value>${soil.drainageClass}</value>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Laboratory Information -->
            ${soil.laboratoryName || soil.testingMethod ? `
            <div class="report-section">
              <h4><i class="fas fa-microscope"></i> Laboratory Information</h4>
              <div class="details-grid">
                ${soil.laboratoryName ? `
                <div class="detail-item">
                  <label>Laboratory:</label>
                  <value>${soil.laboratoryName}</value>
                </div>
                ` : ''}
                ${soil.testingMethod ? `
                <div class="detail-item">
                  <label>Testing Method:</label>
                  <value>${soil.testingMethod}</value>
                </div>
                ` : ''}
                ${soil.testedBy ? `
                <div class="detail-item">
                  <label>Tested By:</label>
                  <value>${soil.testedBy}</value>
                </div>
                ` : ''}
              </div>
            </div>
            ` : ''}

            <!-- Recommendations -->
            ${soil.recommendations ? `
            <div class="report-section recommendations">
              <h4><i class="fas fa-lightbulb"></i> Recommendations</h4>
              <div class="recommendations-content">
                <p>${soil.recommendations}</p>
              </div>
            </div>
            ` : ''}

            <!-- Notes -->
            ${soil.notes ? `
            <div class="report-section">
              <h4><i class="fas fa-sticky-note"></i> Additional Notes</h4>
              <div class="notes-content">
                <p>${soil.notes}</p>
              </div>
            </div>
            ` : ''}

            <!-- Next Test Due -->
            ${soil.nextTestDueDate ? `
            <div class="report-section">
              <h4><i class="fas fa-calendar-check"></i> Next Test Schedule</h4>
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Next soil test recommended by: <strong>${formatDate(soil.nextTestDueDate)}</strong>
              </div>
            </div>
            ` : ''}

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeSoilModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
          <button type="button" class="btn btn-primary" onclick="downloadSoilReport('${soil.id}')">
            <i class="fas fa-download"></i>
            Download PDF
          </button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close soil modal
 */
function closeSoilModal() {
  const modal = document.getElementById('soilModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}

/**
 * Download soil report as PDF
 */
async function downloadSoilReport(soilId) {
  try {
    showLoading();
    showToast('Generating PDF report...', 'info');

    // Récupérer les données complètes
    const soil = await apiRequest(`/v1/soil-data/${soilId}`);

    // Créer le contenu HTML pour le PDF
    const reportHTML = generateSoilReportHTML(soil);

    // Créer un conteneur temporaire
    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = reportHTML;
    tempContainer.style.padding = '20px';
    tempContainer.style.backgroundColor = 'white';
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    document.body.appendChild(tempContainer);

    // Générer le PDF avec html2canvas et jsPDF
    const canvas = await html2canvas(tempContainer);
    const imgData = canvas.toDataURL('image/png');

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgWidth = 210;
    const pageHeight = 295;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    // Nettoyer
    document.body.removeChild(tempContainer);

    // Sauvegarder
    const fileName = `soil_report_${soil.sampleCode || soil.id}_${new Date().toISOString().split('T')[0]}.pdf`;
    pdf.save(fileName);

    showToast('✅ PDF report downloaded successfully', 'success');

  } catch (error) {
    console.error('Error generating PDF:', error);
    showToast('❌ Error generating PDF report', 'error');
  } finally {
    hideLoading();
  }
}
















/**
 * ============================================
 * SOIL REPORT PDF - PROFESSIONAL GREEN DESIGN
 * IMPROVED VERSION - NO SECTION SPLITTING
 * ============================================
 */

function generateSoilReportHTML(soil) {
  const currentDate = new Date().toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });

  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        @page {
          size: A4;
          margin: 0;
        }

        body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          color: #1a1a1a;
          background: white;
          padding: 0;
          margin: 0;
        }

        .page {
          width: 210mm;
          min-height: 297mm;
          background: white;
          position: relative;
          page-break-after: always;
        }

        .page:last-child {
          page-break-after: auto;
        }

        /* Header */
        .report-header {
          background: linear-gradient(135deg, #22c55e 0%, #16a34a 50%, #15803d 100%);
          padding: 35px 30px;
          color: white;
          position: relative;
          overflow: hidden;
        }

        .report-header::before {
          content: '';
          position: absolute;
          top: 0;
          right: 0;
          width: 280px;
          height: 280px;
          background: rgba(255, 255, 255, 0.08);
          border-radius: 50%;
          transform: translate(30%, -30%);
        }

        .report-header::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 0;
          width: 180px;
          height: 180px;
          background: rgba(255, 255, 255, 0.05);
          border-radius: 50%;
          transform: translate(-30%, 30%);
        }

        .header-content {
          position: relative;
          z-index: 1;
          display: flex;
          align-items: center;
          gap: 20px;
        }

        .logo-container {
          width: 75px;
          height: 75px;
          background: white;
          border-radius: 16px;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
          flex-shrink: 0;
        }

        .logo-container img {
          width: 55px;
          height: 55px;
          object-fit: contain;
        }

        .header-text {
          flex: 1;
        }

        .company-name {
          font-size: 14px;
          font-weight: 600;
          margin-bottom: 6px;
          opacity: 0.95;
          letter-spacing: 0.5px;
        }

        .report-title {
          font-size: 30px;
          font-weight: 800;
          margin-bottom: 6px;
          text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .report-subtitle {
          font-size: 13px;
          opacity: 0.9;
          font-weight: 400;
        }

        /* Info Bar */
        .info-bar {
          background: linear-gradient(to right, #f0fdf4, #dcfce7);
          padding: 18px 30px;
          border-bottom: 3px solid #22c55e;
        }

        .info-grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 20px;
        }

        .info-item {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        .info-label {
          font-size: 10px;
          color: #16a34a;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .info-value {
          font-size: 14px;
          color: #1a1a1a;
          font-weight: 600;
        }

        /* Main Content */
        .report-body {
          padding: 25px 30px 30px 30px;
        }

        /* Section Styles */
        .section {
          margin-bottom: 25px;
          page-break-inside: avoid;
          break-inside: avoid;
        }

        .section-header {
          background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
          color: white;
          padding: 11px 18px;
          margin-bottom: 14px;
          border-radius: 8px;
          font-size: 17px;
          font-weight: 700;
          display: flex;
          align-items: center;
          gap: 10px;
          box-shadow: 0 4px 12px rgba(34, 197, 94, 0.25);
        }

        .section-icon {
          font-size: 19px;
        }

        /* Properties Grid */
        .properties-grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 13px;
          margin-top: 14px;
        }

        .property-card {
          background: white;
          border: 2px solid #e5e7eb;
          border-radius: 9px;
          padding: 14px;
          transition: all 0.3s ease;
        }

        .property-card.highlight {
          background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
          color: white;
          border: none;
          box-shadow: 0 6px 16px rgba(34, 197, 94, 0.3);
        }

        .property-label {
          font-size: 10px;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 6px;
          color: #6b7280;
        }

        .property-card.highlight .property-label {
          color: rgba(255, 255, 255, 0.9);
        }

        .property-value {
          font-size: 19px;
          font-weight: 800;
          color: #1a1a1a;
        }

        .property-card.highlight .property-value {
          color: white;
        }

        .property-badge {
          display: inline-block;
          font-size: 9px;
          padding: 4px 9px;
          border-radius: 11px;
          font-weight: 700;
          text-transform: uppercase;
          margin-top: 5px;
          letter-spacing: 0.3px;
        }

        .badge-optimal {
          background: rgba(255, 255, 255, 0.25);
          color: white;
        }

        /* Recommendations Box */
        .recommendations-box {
          background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
          border-left: 5px solid #f59e0b;
          padding: 18px;
          border-radius: 9px;
          margin-top: 14px;
        }

        .recommendations-title {
          font-size: 15px;
          font-weight: 700;
          color: #92400e;
          margin-bottom: 9px;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .recommendations-text {
          font-size: 12px;
          color: #78350f;
          line-height: 1.7;
        }

        /* Laboratory Info */
        .lab-info {
          background: #f9fafb;
          border: 2px dashed #d1d5db;
          padding: 14px 18px;
          border-radius: 8px;
          margin-top: 14px;
        }

        .lab-info-item {
          display: flex;
          justify-content: space-between;
          padding: 7px 0;
          border-bottom: 1px solid #e5e7eb;
        }

        .lab-info-item:last-child {
          border-bottom: none;
        }

        .lab-label {
          font-weight: 600;
          color: #6b7280;
          font-size: 11px;
        }

        .lab-value {
          font-weight: 600;
          color: #1a1a1a;
          font-size: 11px;
        }

        /* Footer */
        .report-footer {
          background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
          padding: 22px 30px;
          border-top: 3px solid #22c55e;
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
        }

        .footer-content {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .footer-logo {
          display: flex;
          align-items: center;
          gap: 11px;
        }

        .footer-logo img {
          width: 45px;
          height: 45px;
          object-fit: contain;
        }

        .footer-text {
          font-size: 10px;
          color: #16a34a;
          font-weight: 600;
        }

        .footer-meta {
          text-align: right;
          font-size: 9px;
          color: #6b7280;
          line-height: 1.6;
        }

        /* Watermark */
        .watermark {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) rotate(-45deg);
          font-size: 110px;
          color: rgba(34, 197, 94, 0.03);
          font-weight: 900;
          z-index: -1;
          pointer-events: none;
        }

        @media print {
          .report-header::before,
          .report-header::after {
            display: none;
          }

          .section {
            page-break-inside: avoid;
            break-inside: avoid;
          }

          .page {
            page-break-after: always;
          }

          .page:last-child {
            page-break-after: auto;
          }
        }
      </style>
    </head>
    <body>
      <div class="watermark">SOIL REPORT</div>

      <!-- PAGE 1 -->
      <div class="page">
        <!-- Header -->
        <div class="report-header">
          <div class="header-content">
            <div class="logo-container">
              <img src="images/logo.jpeg" alt="AgriGuard AI" onerror="this.style.display='none'">
            </div>
            <div class="header-text">
              <div class="company-name">AgriGuard AI - Smart Agriculture Management</div>
              <h1 class="report-title">🌱 Soil Analysis Report</h1>
              <div class="report-subtitle">Professional Soil Health Assessment & Recommendations</div>
            </div>
          </div>
        </div>

        <!-- Info Bar -->
        <div class="info-bar">
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Sample Code</div>
              <div class="info-value">${soil.sampleCode || 'N/A'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Analysis Date</div>
              <div class="info-value">${soil.measurementDate ? formatDate(soil.measurementDate) : 'N/A'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Report Generated</div>
              <div class="info-value">${currentDate}</div>
            </div>
          </div>
        </div>

        <!-- Main Content Page 1 -->
        <div class="report-body">
          <!-- Chemical Properties -->
          <div class="section">
            <div class="section-header">
              <span class="section-icon">⚗️</span>
              <span>Chemical Properties</span>
            </div>
            <div class="properties-grid">
              <div class="property-card highlight">
                <div class="property-label">pH Level</div>
                <div class="property-value">${soil.phLevel ? parseFloat(soil.phLevel).toFixed(2) : 'N/A'}</div>
                <span class="property-badge badge-optimal">${getPhLabel(soil.phLevel)}</span>
              </div>
              <div class="property-card">
                <div class="property-label">Nitrogen (N)</div>
                <div class="property-value">${soil.nitrogenLevel || 'N/A'}</div>
              </div>
              <div class="property-card">
                <div class="property-label">Phosphorus (P)</div>
                <div class="property-value">${soil.phosphorusLevel || 'N/A'}</div>
              </div>
              <div class="property-card">
                <div class="property-label">Potassium (K)</div>
                <div class="property-value">${soil.potassiumLevel || 'N/A'}</div>
              </div>
              <div class="property-card">
                <div class="property-label">Organic Matter</div>
                <div class="property-value">${soil.organicMatter ? parseFloat(soil.organicMatter).toFixed(2) + '%' : 'N/A'}</div>
              </div>
              ${soil.electricalConductivity ? `
              <div class="property-card">
                <div class="property-label">EC (Salinity)</div>
                <div class="property-value">${soil.electricalConductivity} dS/m</div>
              </div>
              ` : ''}
            </div>
          </div>

          <!-- Physical Properties -->
          <div class="section">
            <div class="section-header">
              <span class="section-icon">🏔️</span>
              <span>Physical Properties</span>
            </div>
            <div class="properties-grid">
              <div class="property-card">
                <div class="property-label">Soil Texture</div>
                <div class="property-value">${soil.soilTexture || 'N/A'}</div>
              </div>
              <div class="property-card">
                <div class="property-label">Moisture Content</div>
                <div class="property-value">${soil.moisture ? parseFloat(soil.moisture).toFixed(2) + '%' : 'N/A'}</div>
              </div>
              <div class="property-card">
                <div class="property-label">Sample Depth</div>
                <div class="property-value">${soil.depthCm || 'N/A'} cm</div>
              </div>
              ${soil.bulkDensity ? `
              <div class="property-card">
                <div class="property-label">Bulk Density</div>
                <div class="property-value">${soil.bulkDensity} g/cm³</div>
              </div>
              ` : ''}
              ${soil.porosity ? `
              <div class="property-card">
                <div class="property-label">Porosity</div>
                <div class="property-value">${soil.porosity}%</div>
              </div>
              ` : ''}
              ${soil.drainageClass ? `
              <div class="property-card">
                <div class="property-label">Drainage Class</div>
                <div class="property-value">${soil.drainageClass}</div>
              </div>
              ` : ''}
            </div>
          </div>
        </div>

        <!-- Footer Page 1 -->
        <div class="report-footer">
          <div class="footer-content">
            <div class="footer-logo">
              <img src="images/logo.jpeg" alt="AgriGuard AI" onerror="this.style.display='none'">
              <div>
                <div class="footer-text">AgriGuard AI</div>
                <div class="footer-text" style="font-size: 8px; font-weight: 400;">Smart Agriculture Management System</div>
              </div>
            </div>
            <div class="footer-meta">
              <div><strong>Report ID:</strong> ${soil.sampleCode || soil.id}</div>
              <div><strong>Page:</strong> 1</div>
              <div style="margin-top: 6px; color: #16a34a; font-weight: 600;">www.agriguard-ai.com</div>
            </div>
          </div>
        </div>
      </div>

      <!-- PAGE 2 -->
      <div class="page">
        <!-- Header Page 2 -->
        <div class="report-header">
          <div class="header-content">
            <div class="logo-container">
              <img src="images/logo.jpeg" alt="AgriGuard AI" onerror="this.style.display='none'">
            </div>
            <div class="header-text">
              <div class="company-name">AgriGuard AI - Smart Agriculture Management</div>
              <h1 class="report-title">🌱 Soil Analysis Report</h1>
              <div class="report-subtitle">Professional Soil Health Assessment & Recommendations</div>
            </div>
          </div>
        </div>

        <!-- Info Bar Page 2 -->
        <div class="info-bar">
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Sample Code</div>
              <div class="info-value">${soil.sampleCode || 'N/A'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Analysis Date</div>
              <div class="info-value">${soil.measurementDate ? formatDate(soil.measurementDate) : 'N/A'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Report Generated</div>
              <div class="info-value">${currentDate}</div>
            </div>
          </div>
        </div>

        <!-- Main Content Page 2 -->
        <div class="report-body">
          <!-- Recommendations -->
          ${soil.recommendations ? `
          <div class="section">
            <div class="section-header">
              <span class="section-icon">💡</span>
              <span>Expert Recommendations</span>
            </div>
            <div class="recommendations-box">
              <div class="recommendations-title">
                <span>📋</span>
                <span>Agricultural Advisory</span>
              </div>
              <div class="recommendations-text">
                ${soil.recommendations}
              </div>
            </div>
          </div>
          ` : ''}

          <!-- Laboratory Information -->
          ${soil.laboratoryName || soil.testingMethod ? `
          <div class="section">
            <div class="section-header">
              <span class="section-icon">🔬</span>
              <span>Laboratory Information</span>
            </div>
            <div class="lab-info">
              ${soil.laboratoryName ? `
              <div class="lab-info-item">
                <span class="lab-label">Testing Laboratory:</span>
                <span class="lab-value">${soil.laboratoryName}</span>
              </div>
              ` : ''}
              ${soil.testingMethod ? `
              <div class="lab-info-item">
                <span class="lab-label">Analysis Method:</span>
                <span class="lab-value">${soil.testingMethod}</span>
              </div>
              ` : ''}
              ${soil.testedBy ? `
              <div class="lab-info-item">
                <span class="lab-label">Tested By:</span>
                <span class="lab-value">${soil.testedBy}</span>
              </div>
              ` : ''}
              ${soil.nextTestDueDate ? `
              <div class="lab-info-item">
                <span class="lab-label">Next Test Due:</span>
                <span class="lab-value">${formatDate(soil.nextTestDueDate)}</span>
              </div>
              ` : ''}
            </div>
          </div>
          ` : ''}

          ${soil.notes ? `
          <div class="section">
            <div class="section-header">
              <span class="section-icon">📝</span>
              <span>Additional Notes</span>
            </div>
            <div class="lab-info">
              <p style="font-size: 12px; color: #4b5563; line-height: 1.7;">${soil.notes}</p>
            </div>
          </div>
          ` : ''}
        </div>

        <!-- Footer Page 2 -->
        <div class="report-footer">
          <div class="footer-content">
            <div class="footer-logo">
              <img src="images/logo.jpeg" alt="AgriGuard AI" onerror="this.style.display='none'">
              <div>
                <div class="footer-text">AgriGuard AI</div>
                <div class="footer-text" style="font-size: 8px; font-weight: 400;">Smart Agriculture Management System</div>
              </div>
            </div>
            <div class="footer-meta">
              <div><strong>Report ID:</strong> ${soil.sampleCode || soil.id}</div>
              <div><strong>Generated:</strong> ${currentDate}</div>
              <div><strong>Version:</strong> 1.0</div>
              <div style="margin-top: 6px; color: #16a34a; font-weight: 600;">www.agriguard-ai.com</div>
            </div>
          </div>
        </div>
      </div>

    </body>
    </html>
  `;
}

async function downloadSoilReport(soilId) {
  try {
    showLoading();
    showToast('Generating professional PDF report...', 'info');

    const soil = await apiRequest(`/v1/soil-data/${soilId}`);
    const reportHTML = generateSoilReportHTML(soil);

    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = reportHTML;
    tempContainer.style.width = '210mm';
    tempContainer.style.backgroundColor = 'white';
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    document.body.appendChild(tempContainer);

    await new Promise(resolve => setTimeout(resolve, 800));

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');

    const pages = tempContainer.querySelectorAll('.page');

    for (let i = 0; i < pages.length; i++) {
      if (i > 0) {
        pdf.addPage();
      }

      const canvas = await html2canvas(pages[i], {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        width: pages[i].offsetWidth,
        height: pages[i].offsetHeight
      });

      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 210;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    }

    document.body.removeChild(tempContainer);

    const fileName = `soil_report_${soil.sampleCode || soil.id}_${new Date().toISOString().split('T')[0]}.pdf`;
    pdf.save(fileName);

    showToast('✅ Professional PDF report downloaded successfully!', 'success');

  } catch (error) {
    console.error('Error generating PDF:', error);
    showToast('❌ Error generating PDF report', 'error');
  } finally {
    hideLoading();
  }
}






/**
 * Show soil testing info
 */
function showSoilTestingInfo() {
  const modalHTML = `
    <div class="modal-overlay show" id="infoModal" onclick="if(event.target === this) closeInfoModal()">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-info-circle"></i>
            About Soil Testing
          </h3>
          <button class="modal-close" onclick="closeInfoModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="info-content">
            <h4><i class="fas fa-question-circle"></i> Why Test Your Soil?</h4>
            <p>Regular soil testing is essential for:</p>
            <ul>
              <li>Understanding nutrient levels in your soil</li>
              <li>Optimizing fertilizer application</li>
              <li>Improving crop yields</li>
              <li>Preventing nutrient deficiencies</li>
              <li>Managing soil pH levels</li>
              <li>Making informed farming decisions</li>
            </ul>

            <h4 style="margin-top: 20px;"><i class="fas fa-calendar-check"></i> When to Test?</h4>
            <p>It's recommended to test your soil:</p>
            <ul>
              <li>Before the growing season (every 1-3 years)</li>
              <li>When starting a new farm or field</li>
              <li>If you notice poor crop performance</li>
              <li>After significant changes in management practices</li>
            </ul>

            <h4 style="margin-top: 20px;"><i class="fas fa-flask"></i> What Gets Tested?</h4>
            <p>A comprehensive soil test typically measures:</p>
            <ul>
              <li><strong>pH Level:</strong> Soil acidity/alkalinity</li>
              <li><strong>NPK:</strong> Nitrogen, Phosphorus, Potassium</li>
              <li><strong>Organic Matter:</strong> Soil health indicator</li>
              <li><strong>Micronutrients:</strong> Essential trace elements</li>
              <li><strong>Salinity:</strong> Salt content in soil</li>
            </ul>

            <h4 style="margin-top: 20px;"><i class="fas fa-phone"></i> How to Get Started?</h4>
            <p>Contact your local agricultural extension office or:</p>
            <ul>
              <li>Visit a certified soil testing laboratory</li>
              <li>Consult with an agricultural advisor</li>
              <li>Contact the Ministry of Agriculture</li>
            </ul>

            <div class="alert alert-info" style="margin-top: 20px;">
              <i class="fas fa-lightbulb"></i>
              <strong>Pro Tip:</strong> Keep records of all soil tests to track changes over time and make better management decisions.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="closeInfoModal()">
            <i class="fas fa-check"></i>
            Got It
          </button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close info modal
 */
function closeInfoModal() {
  const modal = document.getElementById('infoModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}

/**
 * Helper function to update element content safely
 */
function updateElement(elementId, content) {
    try {
        const element = document.getElementById(elementId);
        if (!element) {
            console.warn(`⚠️ Element not found: ${elementId}`);
            return;
        }

        if (typeof content === 'object' && content !== null) {
            element.innerHTML = content;
        } else {
            element.textContent = content;
        }
    } catch (error) {
        console.error(`❌ Error updating element ${elementId}:`, error);
    }
}





/**
 * Format date amélioré
 */
function formatDate(dateString) {
    if (!dateString) return 'N/A';

    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';

        return new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }).format(date);
    } catch (error) {
        return 'N/A';
    }
}

/**
 * Format datetime helper
 */
function formatDateTime(dateString) {
  if (!dateString) return 'N/A';

  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'N/A';

    return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }).format(date);
  } catch (error) {
    return 'N/A';
  }
}

// ============================================================================
// STYLES POUR LE MODULE SOIL DATA
// ============================================================================

/**
 * Ajouter ces styles CSS à votre fichier principal
 */
const soilDataStyles = `
<style>
/* Soil Data Card Styles */
.soil-data-card {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border-radius: 20px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  padding: 0;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  border: 1px solid rgba(34, 197, 94, 0.1);
  overflow: hidden;
  position: relative;
}

.soil-data-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  background: linear-gradient(90deg, var(--primary-green), var(--secondary-green), var(--accent-green));
  z-index: 1;
}

.soil-data-card:hover {
  box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
  transform: translateY(-8px) scale(1.02);
  border-color: rgba(34, 197, 94, 0.3);
}

.soil-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0;
  padding: 1.75rem 1.5rem;
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.06), rgba(16, 185, 129, 0.03));
  border-bottom: 2px solid rgba(34, 197, 94, 0.15);
  position: relative;
}

.soil-farm-name {
  margin: 0 0 0.5rem 0;
  font-size: 1.35rem;
  color: #1a1a1a;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  line-height: 1.3;
}

.soil-farm-name i {
  color: var(--primary-green);
  font-size: 1.25rem;
}

.soil-sample-code {
  display: inline-block;
  font-size: 0.8rem;
  color: #555;
  margin-top: 0.5rem;
  padding: 0.35rem 0.85rem;
  background: rgba(34, 197, 94, 0.12);
  border: 1px solid rgba(34, 197, 94, 0.2);
  border-radius: 10px;
  font-weight: 600;
}

.soil-date {
  font-size: 0.875rem;
  color: #555;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0.6rem 1.1rem;
  background: white;
  border: 1px solid rgba(34, 197, 94, 0.15);
  border-radius: 10px;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
}

.soil-date i {
  color: var(--primary-green);
  font-size: 0.9rem;
}

/* Soil Metrics Grid - Table Format */
.soil-metrics {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0;
  margin: 0;
  padding: 0;
  background: white;
  border: 1px solid rgba(34, 197, 94, 0.15);
  border-radius: 12px;
  overflow: hidden;
}

@media (max-width: 600px) {
  .soil-metrics {
    grid-template-columns: 1fr;
  }
}

.soil-metric {
  display: flex;
  align-items: center;
  padding: 1.25rem 1.5rem;
  background: #ffffff;
  border-right: 1px solid rgba(34, 197, 94, 0.1);
  border-bottom: 1px solid rgba(34, 197, 94, 0.1);
  transition: all 0.2s ease;
  position: relative;
}

.soil-metric:nth-child(even) {
  border-right: none;
}

.soil-metric:nth-last-child(-n+2) {
  border-bottom: none;
}

.soil-metric:hover {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.03), rgba(16, 185, 129, 0.02));
  transform: scale(1.02);
}

.soil-metric-primary {
  grid-column: span 2;
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(16, 185, 129, 0.04));
  border: none;
  border-bottom: 2px solid rgba(34, 197, 94, 0.2);
  padding: 2rem 1.5rem;
  border-radius: 0;
}

.soil-metric-primary::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--primary-green), var(--secondary-green));
}
  gap: 12px;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.soil-metric:hover {
  background: #e9ecef;
}

.soil-metric-primary {
  grid-column: 1 / -1;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
}

.metric-icon {
  width: 48px;
  height: 48px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  flex-shrink: 0;
  margin-right: 1.25rem;
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.12), rgba(16, 185, 129, 0.08));
  color: var(--primary-green);
  transition: all 0.2s ease;
}

.soil-metric:hover .metric-icon {
  transform: scale(1.05);
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.15));
}

.soil-metric-primary .metric-icon {
  width: 64px;
  height: 64px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
  color: var(--primary-green);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.metric-icon.good {
  background: linear-gradient(135deg, #d4edda, #c3e6cb);
  color: #155724;
}

.metric-icon.moderate {
  background: linear-gradient(135deg, #fff3cd, #ffeaa7);
  color: #856404;
}

.metric-icon.poor {
  background: linear-gradient(135deg, #f8d7da, #f5c6cb);
  color: #721c24;
}

.metric-content {
  flex: 1;
  min-width: 0;
}

.metric-label {
  display: block;
  font-size: 0.75rem;
  color: #666;
  margin-bottom: 0.5rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.soil-metric-primary .metric-label {
  color: #333;
  font-size: 0.85rem;
  margin-bottom: 0.75rem;
}

.metric-value {
  font-size: 1.3rem;
  font-weight: 700;
  color: #1a1a1a;
  line-height: 1.3;
}

.soil-metric-primary .metric-value {
  color: #1a1a1a;
}

.metric-value-large {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--primary-green);
  line-height: 1;
  margin: 0.5rem 0;
  text-shadow: none;
}

.metric-status {
  display: inline-block;
  padding: 0.35rem 0.9rem;
  border-radius: 16px;
  font-size: 0.7rem;
  font-weight: 700;
  margin-top: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
}

.metric-status.good {
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.1));
  color: var(--primary-green);
  border: 1px solid rgba(34, 197, 94, 0.2);
}

.metric-status.moderate {
  background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 152, 0, 0.1));
  color: #f59e0b;
  border: 1px solid rgba(255, 193, 7, 0.2);
}

.metric-status.poor {
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.2);
}

/* Recommendations Section */
.soil-recommendations,
.soil-notes {
  margin: 0;
  padding: 1.5rem;
  background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%);
  border-left: 5px solid #ffc107;
  border-radius: 0;
  box-shadow: inset 0 2px 10px rgba(255, 193, 7, 0.1);
}

.soil-recommendations h4,
.soil-notes h4 {
  margin: 0 0 0.75rem 0;
  color: #856404;
  font-size: 1rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.soil-recommendations h4 i,
.soil-notes h4 i {
  color: #ffc107;
  font-size: 1.2rem;
}

.soil-recommendations p,
.soil-notes p {
  margin: 0;
  color: #666;
  line-height: 1.6;
  font-size: 0.95rem;
}

.soil-recommendations h4,
.soil-notes h4 {
  margin: 0 0 10px 0;
  color: #f57c00;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 1rem;
}

.soil-recommendations p,
.soil-notes p {
  margin: 0;
  line-height: 1.6;
  color: #5d4037;
}

/* Soil Footer */
.soil-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 0;
  padding: 1.5rem;
  border-top: 2px solid rgba(34, 197, 94, 0.15);
  background: linear-gradient(135deg, rgba(34, 197, 94, 0.03), rgba(16, 185, 129, 0.02));
  gap: 1.25rem;
  flex-wrap: wrap;
}

.soil-meta {
  display: flex;
  gap: 1.25rem;
  flex-wrap: wrap;
  flex: 1;
}

.soil-meta-item {
  font-size: 0.85rem;
  color: #666;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 0.75rem;
  background: white;
  border-radius: 8px;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  transition: all 0.2s ease;
}

.soil-meta-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.soil-meta-item i {
  color: var(--primary-green);
  font-size: 0.9rem;
}

.soil-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

/* Report Modal Styles */
.soil-report {
  max-height: 70vh;
  overflow-y: auto;
  padding: 10px;
}

.report-section {
  margin-bottom: 25px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
}

.report-section h4 {
  margin: 0 0 15px 0;
  color: #2c3e50;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
  border-bottom: 2px solid #3498db;
  padding-bottom: 10px;
}

.report-section.recommendations {
  background: #e8f5e9;
  border-left: 4px solid #4caf50;
}

.recommendations-content,
.notes-content {
  padding: 10px;
  line-height: 1.8;
  color: #2c3e50;
}

.details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.detail-item {
  padding: 12px;
  background: white;
  border-radius: 6px;
  border: 1px solid #dee2e6;
}

.detail-item.highlight {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
}

.detail-item label {
  display: block;
  font-size: 0.875rem;
  color: #6c757d;
  margin-bottom: 5px;
  font-weight: 500;
}

.detail-item.highlight label {
  color: rgba(255, 255, 255, 0.9);
}

.detail-item value {
  display: block;
  font-size: 1.1rem;
  font-weight: 600;
  color: #2c3e50;
}

.detail-item.highlight value {
  color: white;
  font-size: 1.5rem;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #6c757d;
}

.empty-icon {
  font-size: 4rem;
  color: #dee2e6;
  margin-bottom: 20px;
}

.empty-state h3 {
  margin: 0 0 10px 0;
  color: #495057;
}

.empty-state p {
  margin: 10px 0;
  font-size: 1rem;
}

.empty-state-hint {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background: #e3f2fd;
  border-radius: 8px;
  color: #1976d2;
  font-size: 0.875rem;
  margin-top: 15px;
}

.empty-state-actions {
  margin-top: 25px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .soil-metrics {
    grid-template-columns: 1fr;
  }

  .soil-header {
    flex-direction: column;
    gap: 15px;
  }

  .soil-footer {
    flex-direction: column;
    align-items: flex-start;
  }

  .details-grid {
    grid-template-columns: 1fr;
  }
}

/* Info Modal Content Styles */
.info-content h4 {
  color: #2c3e50;
  margin-top: 20px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.info-content ul {
  padding-left: 20px;
  line-height: 1.8;
}

.info-content li {
  margin-bottom: 8px;
  color: #495057;
}

.alert {
  padding: 15px;
  border-radius: 8px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.alert-info {
  background: #e3f2fd;
  border-left: 4px solid #2196f3;
  color: #0d47a1;
}

.alert i {
  font-size: 1.2rem;
  flex-shrink: 0;
  margin-top: 2px;
}
</style>
`;

// Export pour utilisation
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    loadSoilData,
    viewSoilDetails,
    downloadSoilReport,
    showSoilTestingInfo
  };
}













// ============================================================================
// MARKET PRICES - VERSION COMPLÈTE ET CORRIGÉE
// ============================================================================

/**
 * Initialize Market Prices Section
 * Appelez cette fonction au chargement de la page
 */
function initMarketPrices() {
    console.log('🚀 Initializing Market Prices Section...');

    // Ajouter les styles CSS
    addMarketPricesStyles();

    // Initialiser les filtres
    initMarketPricesFilters();

    // Charger les données
    loadMarketPricesData();

    // Ajouter les event listeners pour les boutons
    setupMarketPricesEventListeners();

    console.log('✅ Market Prices Section initialized');
}

/**
 * Setup Event Listeners
 */
function setupMarketPricesEventListeners() {
    // Bouton Refresh
    const refreshBtn = document.querySelector('[data-action="refresh-market-prices"]');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', () => {
            console.log('🔄 Refreshing market prices...');
            loadMarketPricesData();
        });
    }

    // Bouton Clear Filters
    const clearFiltersBtn = document.querySelector('[data-action="clear-market-prices-filters"]');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearMarketPricesFilters);
    }
}



async function loadMarketPricesData() {
    const container = document.getElementById('marketPricesGrid');

    try {
        console.log('🔄 Loading market prices...');

        // Afficher loading
        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading market prices...</p>
                </div>
            `;
        }

        const response = await apiRequest('/market-prices?page=0&size=20&sortBy=priceDate&sortDirection=desc');
        console.log('📦 API Response:', response);

        // Extraction des données
        let prices = [];
        if (Array.isArray(response)) {
            prices = response;
        } else if (response?.content && Array.isArray(response.content)) {
            prices = response.content;
        } else if (response?.data?.content && Array.isArray(response.data.content)) {
            prices = response.data.content;
        } else if (response?.data && Array.isArray(response.data)) {
            prices = response.data;
        }

        console.log(`✅ Extracted ${prices.length} prices`);

        // Afficher les données
        displayMarketPricesGrid(prices);

    } catch (error) {
        console.error('❌ Error loading market prices:', error);

        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                    <h3>Unable to Load Market Prices</h3>
                    <p>${error.message || 'An error occurred'}</p>
                    <button class="btn btn-primary" onclick="loadMarketPricesData()" style="margin-top: 15px;">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                </div>
            `;
        }
    }
}





/**
 * Get trend color for badges
 */
function getTrendColor(trend) {
    const colors = {
        'INCREASING': '#d4edda',
        'DECREASING': '#f8d7da',
        'STABLE': '#fff3cd',
        'VOLATILE': '#d1ecf1'
    };
    return colors[trend] || '#e9ecef';
}

/**
 * Get demand color for badges
 */
function getDemandColor(demand) {
    const colors = {
        'HIGH': '#d4edda; color: #155724',
        'MEDIUM': '#fff3cd; color: #856404',
        'LOW': '#f8d7da; color: #721c24',
        'UNKNOWN': '#e9ecef; color: #6c757d'
    };
    return colors[demand] || '#e9ecef; color: #6c757d';
}

/**
 * Get trend icon
 */
function getTrendIcon(trend) {
    const icons = {
        'INCREASING': 'fa-arrow-up',
        'DECREASING': 'fa-arrow-down',
        'STABLE': 'fa-minus',
        'VOLATILE': 'fa-random'
    };
    return icons[trend] || 'fa-minus';
}


function displayMarketPricesGrid(prices) {
    const container = document.getElementById('marketPricesGrid');

    if (!container) {
        console.error('❌ Container #marketPricesGrid not found!');
        return;
    }

    // Vérification des données
    const pricesList = Array.isArray(prices) ? prices : [];
    console.log(`📊 Displaying ${pricesList.length} prices`);

    if (pricesList.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-chart-line" style="font-size: 4rem; color: #cbd5e1;"></i>
                <h3 style="margin-top: 20px;">No Market Prices Available</h3>
                <p style="color: #64748b;">There are currently no market price records to display.</p>
                <button class="btn btn-primary" onclick="loadMarketPricesData()" style="margin-top: 15px;">
                    <i class="fas fa-redo"></i> Reload
                </button>
            </div>
        `;
        return;
    }

    // Générer les cartes
    const cards = pricesList.map(price => {
        if (!price || !price.id) return '';

        const cropName = price.cropName || `Crop ${price.cropId || 'Unknown'}`;
        const priceValue = price.pricePerKg ? `RWF ${price.pricePerKg.toLocaleString()}` : 'N/A';
        const marketName = price.marketName || 'Unknown Market';
        const location = price.location || 'N/A';
        const marketType = price.marketType || 'N/A';
        const demand = price.demandLevel || 'UNKNOWN';
        const trend = price.priceTrend || 'STABLE';
        const date = price.priceDate ? new Date(price.priceDate).toLocaleDateString() : 'N/A';

        return `
            <div class="market-price-card" style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #f1f5f9;">
                    <div>
                        <h3 class="crop-name" style="margin: 0 0 8px 0; font-size: 1.25rem; color: #1e293b;">${cropName}</h3>
                        <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${priceValue}/kg</div>
                    </div>
                    <div class="trend-badge trend-${trend.toLowerCase()}" style="padding: 6px 12px; border-radius: 20px; height: fit-content; font-size: 0.875rem; font-weight: 600;">
                        <i class="fas ${getTrendIcon(trend)}"></i> ${trend}
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                        <span style="color: #64748b;"><i class="fas fa-store"></i> Market:</span>
                        <span style="font-weight: 500;">${marketName}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                        <span style="color: #64748b;"><i class="fas fa-map-marker-alt"></i> Location:</span>
                        <span style="font-weight: 500;">${location}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                        <span style="color: #64748b;"><i class="fas fa-tag"></i> Type:</span>
                        <span class="market-type-badge" style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">${marketType}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9;">
                        <span style="color: #64748b;"><i class="fas fa-chart-bar"></i> Demand:</span>
                        <span class="demand-badge demand-${demand.toLowerCase()}" style="padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">${demand}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <span style="color: #64748b;"><i class="fas fa-calendar"></i> Date:</span>
                        <span style="font-weight: 500;">${date}</span>
                    </div>
                </div>

                ${price.notes ? `
                <div style="padding: 12px; background: #f8fafc; border-radius: 6px; margin-bottom: 15px;">
                    <div style="font-weight: 600; color: #475569; margin-bottom: 5px; font-size: 0.875rem;">
                        <i class="fas fa-sticky-note"></i> Notes:
                    </div>
                    <p style="margin: 0; color: #64748b; font-size: 0.875rem;">${price.notes}</p>
                </div>
                ` : ''}

                <div style="display: flex; justify-content: flex-end; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                    <button class="btn btn-primary btn-sm" onclick="viewPriceDetails('${price.id}')" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-chart-bar"></i> Analyze
                    </button>
                </div>
            </div>
        `;
    }).filter(card => card !== '').join('');

    container.innerHTML = cards || `
        <div class="empty-state">
            <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #f59e0b;"></i>
            <p style="margin-top: 20px;">No valid data to display</p>
        </div>
    `;

    console.log('✅ Market prices displayed successfully');
}






/**
 * Ajouter les styles CSS pour les market prices - NOUVELLE FONCTION
 */
function addMarketPricesStyles() {
    // Vérifier si les styles sont déjà ajoutés
    if (document.getElementById('market-prices-styles')) {
        return;
    }

    const styles = `
        <style id="market-prices-styles">
        /* Market Prices Grid Layout */
        .market-prices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        /* Market Price Card */
        .market-price-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: all 0.3s ease;
            border: 1px solid #e1e5e9;
        }

        .market-price-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Header */
        .price-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .price-main-info {
            flex: 1;
        }

        .crop-name {
            margin: 0 0 8px 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .price-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #27ae60;
        }

        /* Price Trend */
        .price-trend {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .trend-increasing {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .trend-decreasing {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b0b7;
        }

        .trend-stable {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .trend-volatile {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Price Details */
        .price-details {
            margin-bottom: 15px;
        }

        .price-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .price-detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6c757d;
            font-size: 0.875rem;
        }

        .detail-value {
            font-weight: 500;
            color: #2c3e50;
        }

        /* Badges */
        .market-type-badge {
            padding: 4px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .demand-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .demand-high {
            background: #d4edda;
            color: #155724;
        }

        .demand-medium {
            background: #fff3cd;
            color: #856404;
        }

        .demand-low {
            background: #f8d7da;
            color: #721c24;
        }

        .demand-unknown {
            background: #e9ecef;
            color: #6c757d;
        }

        /* Notes */
        .price-notes {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .notes-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.875rem;
        }

        .notes-content {
            margin: 0;
            color: #6c757d;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        /* Footer */
        .price-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .price-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #6c757d;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-icon {
            font-size: 4rem;
            color: #dee2e6;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.5rem;
        }

        .empty-state p {
            margin: 10px 0;
            font-size: 1rem;
        }

        .empty-state-hint {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #e3f2fd;
            border-radius: 8px;
            color: #1976d2;
            font-size: 0.875rem;
            margin-top: 15px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .market-prices-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 15px 0;
            }

            .price-card-header {
                flex-direction: column;
                gap: 10px;
            }

            .price-card-footer {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .price-actions {
                align-self: stretch;
            }

            .price-actions .btn {
                width: 100%;
            }
        }

        /* Animation pour les nouvelles données */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .market-price-card {
            animation: fadeInUp 0.5s ease;
        }
        </style>
    `;

    document.head.insertAdjacentHTML('beforeend', styles);
}















/**
 * Get trend icon
 */
function getTrendIcon(trend) {
    const icons = {
        'INCREASING': 'fa-arrow-up',
        'DECREASING': 'fa-arrow-down',
        'STABLE': 'fa-minus',
        'VOLATILE': 'fa-random',
        'FLUCTUATING': 'fa-wave-square',
        'UPWARD': 'fa-arrow-up',
        'DOWNWARD': 'fa-arrow-down',
        'SIDEWAYS': 'fa-arrows-left-right'
    };
    return icons[trend] || 'fa-minus';
}




/**
 * View Price Details
 */
async function viewPriceDetails(priceId) {
    if (!priceId) {
        showToast('Invalid price ID', 'error');
        return;
    }

    try {
        showLoading();
        const price = await apiRequest(`/market-prices/${priceId}`);

        if (!price) {
            showToast('Price data not found', 'error');
            return;
        }

        showPriceDetailsModal(price);

    } catch (error) {
        console.error('Error loading price details:', error);
        showToast('Error loading price details', 'error');
    } finally {
        hideLoading();
    }
}






/**
 * Show price history modal
 */
function showPriceHistoryModal(history) {
    // Trier par date (plus récent en premier)
    const sortedHistory = history.sort((a, b) =>
        new Date(b.priceDate) - new Date(a.priceDate)
    );

    const modalHTML = `
        <div class="modal-overlay show" id="priceHistoryModal">
            <div class="modal-container modal-large">
                <div class="modal-header">
                    <h3><i class="fas fa-history"></i> Price History</h3>
                    <button class="modal-close" onclick="closePriceHistoryModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="price-history-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Price (RWF/kg)</th>
                                    <th>Market</th>
                                    <th>Trend</th>
                                    <th>Demand</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedHistory.map(item => `
                                    <tr>
                                        <td>${formatDate(item.priceDate)}</td>
                                        <td><strong>${formatCurrency(item.pricePerKg)}</strong></td>
                                        <td>${item.marketName || 'N/A'}</td>
                                        <td>
                                            <span class="trend-badge trend-${(item.priceTrend || 'STABLE').toLowerCase()}">
                                                ${item.priceTrend || 'STABLE'}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="demand-badge demand-${(item.demandLevel || 'UNKNOWN').toLowerCase()}">
                                                ${item.demandLevel || 'UNKNOWN'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closePriceHistoryModal()">Close</button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close price history modal
 */
function closePriceHistoryModal() {
    const modal = document.getElementById('priceHistoryModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}


/**
 * Show Price Details Modal
 */
function showPriceDetailsModal(price) {
    if (!price) return;

    const cropName = price.cropName || `Crop ${price.cropId || 'Unknown'}`;
    const pricePerKg = price.pricePerKg ? formatCurrency(price.pricePerKg) : 'N/A';
    const marketName = price.marketName || 'Unknown Market';
    const location = price.location || 'N/A';
    const marketType = price.marketType || 'N/A';
    const demandLevel = price.demandLevel || 'UNKNOWN';
    const supplyLevel = price.supplyLevel || 'UNKNOWN';
    const priceTrend = price.priceTrend || 'STABLE';
    const priceDate = price.priceDate ? formatDateTime(price.priceDate) : 'N/A';

    const modalHTML = `
        <div class="modal-overlay show" id="priceModal" onclick="if(event.target === this) closePriceModal()">
            <div class="modal-container modal-large">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-chart-line"></i>
                        Market Price Analysis - ${cropName}
                    </h3>
                    <button class="modal-close" onclick="closePriceModal()" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="price-analysis-details">
                        <div class="detail-section">
                            <h4><i class="fas fa-info-circle"></i> Price Information</h4>
                            <div class="details-grid">
                                <div class="detail-item highlight">
                                    <label>Current Price:</label>
                                    <value class="price-value-large">${pricePerKg}</value>
                                </div>
                                <div class="detail-item">
                                    <label>Market:</label>
                                    <value>${marketName}</value>
                                </div>
                                <div class="detail-item">
                                    <label>Location:</label>
                                    <value>${location}</value>
                                </div>
                                <div class="detail-item">
                                    <label>Market Type:</label>
                                    <value>${marketType}</value>
                                </div>
                                <div class="detail-item">
                                    <label>Date:</label>
                                    <value>${priceDate}</value>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section">
                            <h4><i class="fas fa-chart-bar"></i> Market Conditions</h4>
                            <div class="details-grid">
                                <div class="detail-item">
                                    <label>Price Trend:</label>
                                    <value>
                                        <span class="trend-badge trend-${priceTrend.toLowerCase()}">
                                            <i class="fas ${getTrendIcon(priceTrend)}"></i>
                                            ${priceTrend}
                                        </span>
                                    </value>
                                </div>
                                <div class="detail-item">
                                    <label>Demand Level:</label>
                                    <value>
                                        <span class="demand-badge demand-${demandLevel.toLowerCase()}">
                                            ${demandLevel}
                                        </span>
                                    </value>
                                </div>
                                <div class="detail-item">
                                    <label>Supply Level:</label>
                                    <value>
                                        <span class="supply-badge supply-${supplyLevel.toLowerCase()}">
                                            ${supplyLevel}
                                        </span>
                                    </value>
                                </div>
                            </div>
                        </div>

                        <div class="detail-section recommendations">
                            <h4><i class="fas fa-lightbulb"></i> Trading Recommendations</h4>
                            <div class="recommendations-content">
                                ${generatePriceRecommendations(price)}
                            </div>
                        </div>

                        ${price.notes ? `
                        <div class="detail-section">
                            <h4><i class="fas fa-sticky-note"></i> Additional Information</h4>
                            <div class="notes-content">
                                <p>${price.notes}</p>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closePriceModal()">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close Price Modal
 */
function closePriceModal() {
    const modal = document.getElementById('priceModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}

/**
 * Generate Price Recommendations
 */
function generatePriceRecommendations(price) {
    const recommendations = [];

    if (price.priceTrend === 'INCREASING') {
        recommendations.push('📈 <strong>Good time to sell</strong> - Prices are trending upward');
    } else if (price.priceTrend === 'DECREASING') {
        recommendations.push('📉 <strong>Consider holding</strong> - Prices are trending downward');
    } else if (price.priceTrend === 'STABLE') {
        recommendations.push('⚖️ <strong>Market is stable</strong> - Monitor for changes');
    }

    if (price.demandLevel === 'HIGH') {
        recommendations.push('🔥 <strong>High demand</strong> - Favorable market conditions');
    } else if (price.demandLevel === 'LOW') {
        recommendations.push('💤 <strong>Low demand</strong> - Consider alternative markets');
    }

    if (price.supplyLevel === 'LOW') {
        recommendations.push('📦 <strong>Low supply</strong> - Potential for price increases');
    } else if (price.supplyLevel === 'HIGH') {
        recommendations.push('📊 <strong>High supply</strong> - Prices may decrease');
    }

    if (recommendations.length === 0) {
        recommendations.push('ℹ️ <strong>Monitor market</strong> - No specific recommendations available');
    }

    return recommendations.map(rec => `<p>${rec}</p>`).join('');
}


/**
 * Close price modal
 */
function closePriceModal() {
    const modal = document.getElementById('priceModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}






/**
 * View price history
 */
async function viewPriceHistory(cropId) {
    if (!cropId) {
        showToast('❌ Crop ID not available', 'error');
        return;
    }

    try {
        showLoading();

        // Récupérer l'historique des prix pour ce crop
        const history = await apiRequest(`/market-prices/crop/${cropId}/history`);

        if (history && history.length > 0) {
            showPriceHistoryModal(history);
        } else {
            showToast('ℹ️ No price history available for this crop', 'info');
        }

    } catch (error) {
        console.error('Error loading price history:', error);
        showToast('❌ Error loading price history', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Initialize Market Prices Filters
 */
function initMarketPricesFilters() {
    const searchInput = document.getElementById('marketPricesSearchInput');
    const typeFilter = document.getElementById('marketPricesTypeFilter');
    const trendFilter = document.getElementById('marketPricesTrendFilter');

    if (searchInput) {
        searchInput.addEventListener('input', debounce(() => {
            filterMarketPrices();
        }, 300));
    }

    if (typeFilter) {
        typeFilter.addEventListener('change', filterMarketPrices);
    }

    if (trendFilter) {
        trendFilter.addEventListener('change', filterMarketPrices);
    }
}




/**
 * Filter Market Prices
 */
function filterMarketPrices() {
    const searchTerm = document.getElementById('marketPricesSearchInput')?.value.toLowerCase() || '';
    const typeFilter = document.getElementById('marketPricesTypeFilter')?.value || '';
    const trendFilter = document.getElementById('marketPricesTrendFilter')?.value || '';

    const priceCards = document.querySelectorAll('.market-price-card');

    let visibleCount = 0;

    priceCards.forEach(card => {
        const cropName = card.querySelector('.crop-name')?.textContent.toLowerCase() || '';
        const marketType = card.querySelector('.market-type-badge')?.textContent || '';
        const priceTrend = card.querySelector('.price-trend span')?.textContent.trim() || '';

        const matchesSearch = cropName.includes(searchTerm);
        const matchesType = !typeFilter || marketType === typeFilter;
        const matchesTrend = !trendFilter || priceTrend === trendFilter;

        if (matchesSearch && matchesType && matchesTrend) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });

    console.log(`📊 Showing ${visibleCount} of ${priceCards.length} prices`);
}



/**
 * Clear Market Prices Filters
 */
function clearMarketPricesFilters() {
    document.getElementById('marketPricesSearchInput').value = '';
    document.getElementById('marketPricesTypeFilter').value = '';
    document.getElementById('marketPricesTrendFilter').value = '';

    const priceCards = document.querySelectorAll('.market-price-card');
    priceCards.forEach(card => {
        card.style.display = 'block';
    });

    showToast('Filters cleared', 'info');
}



/**
 * Debounce function for search input
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}







async function loadTransactionsData() {
  try {
    showLoading();

    // ✅ VALIDATION UTILISATEUR
    if (!currentUser || !currentUser.id) {
      console.error('❌ No current user found');
      displayEmptyTransactions();
      return;
    }

    if (DEBUG_MODE) {
      console.log('🔄 Loading transactions for farmer user ID:', currentUser.id);
    }

    // ✅ RÉCUPÉRATION DES TRANSACTIONS
    let transactions = [];
    try {
      const response = await apiRequest(`/transactions/farmer/${currentUser.id}`);

      // ✅ CORRECTION: Gérer les différents formats de réponse
      if (response) {
        if (Array.isArray(response)) {
          transactions = response;
        } else if (response.data && Array.isArray(response.data)) {
          transactions = response.data;
        } else if (response.content && Array.isArray(response.content)) {
          transactions = response.content;
        } else if (response.data && response.data.content && Array.isArray(response.data.content)) {
          transactions = response.data.content;
        }
      }

      console.log(`✅ Total transactions loaded: ${transactions.length}`);
      console.log('📦 Transactions data:', transactions);

    } catch (error) {
      console.warn('⚠️ Transactions load error:', error.message);
      transactions = [];
    }

    // ✅ VALIDATION MINIMALE (au lieu de stricte)
    const validTransactions = transactions.filter(tx => {
      // On vérifie juste que c'est un objet avec un ID
      return tx && typeof tx === 'object' && tx.id;
    });

    console.log(`✅ Valid transactions: ${validTransactions.length}`);

    // ✅ ENRICHIR LES TRANSACTIONS AVEC BUYER ET CROP NAMES
    const enrichedTransactions = await Promise.all(validTransactions.map(async (tx) => {
      try {
        // Enrichir avec buyer name
        if (tx.buyerId && !tx.buyerName) {
          try {
            const buyerResponse = await apiRequest(`/users/${tx.buyerId}`);
            const buyer = buyerResponse.data || buyerResponse;
            tx.buyerName = buyer.fullName || buyer.username || buyer.email || 'Unknown Buyer';
          } catch (error) {
            console.warn(`Error fetching buyer ${tx.buyerId}:`, error);
            tx.buyerName = 'Unknown Buyer';
          }
        }

        // Enrichir avec crop name
        if (tx.cropId && !tx.cropName) {
          try {
            const cropResponse = await apiRequest(`/v1/crops/${tx.cropId}`);
            const crop = cropResponse.data || cropResponse;
            tx.cropName = crop.cropName || crop.name || 'Unknown Crop';
          } catch (error) {
            console.warn(`Error fetching crop ${tx.cropId}:`, error);
            tx.cropName = 'Unknown Crop';
          }
        }
      } catch (error) {
        console.warn('Error enriching transaction:', error);
      }
      return tx;
    }));

    // Update statistics
    const totalCount = enrichedTransactions.length;
    const completed = enrichedTransactions.filter(t =>
      (t.status === 'PAID' || t.status === 'COMPLETED') || 
      (t.transactionStatus === 'PAID' || t.transactionStatus === 'COMPLETED')
    ).length;

    const totalAmount = enrichedTransactions.reduce((sum, t) => {
      const amount = parseFloat(t.totalAmount || 0);
      return sum + (isNaN(amount) ? 0 : amount);
    }, 0);

    const netAmount = enrichedTransactions.reduce((sum, t) => {
      const amount = parseFloat(t.netAmountFarmer || t.netAmount || 0);
      return sum + (isNaN(amount) ? 0 : amount);
    }, 0);

    // ✅ MISE À JOUR UI
    updateElement('txTotalCount', totalCount);
    updateElement('txCompleted', completed);
    updateElement('txTotalAmount', formatCurrency(totalAmount));
    updateElement('txNetAmount', formatCurrency(netAmount));

    // ✅ AFFICHAGE DU TABLEAU
    displayTransactionsTable(enrichedTransactions);

  } catch (error) {
    console.error('❌ Error loading transactions:', error);
    showToast('Unable to load transactions data', 'warning');
    displayEmptyTransactions();
  } finally {
    hideLoading();
  }
}






/**
 * Afficher un état vide pour les transactions
 */
function displayEmptyTransactions() {
  // Réinitialiser les statistiques
  updateElement('txTotalCount', 0);
  updateElement('txCompleted', 0);
  updateElement('txTotalAmount', formatCurrency(0));
  updateElement('txNetAmount', formatCurrency(0));

  // Afficher l'état vide dans le tableau
  const tbody = document.getElementById('transactionsTableBody');
  if (tbody) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="empty-state">
          <div class="empty-icon">
            <i class="fas fa-exchange-alt"></i>
          </div>
          <p>No transactions available</p>
          <p class="empty-state-hint">
            Your transaction history will appear here once you start selling your produce
          </p>
        </td>
      </tr>
    `;
  }
}





function displayTransactionsTable(transactions) {
  const tbody = document.getElementById('transactionsTableBody');
  if (!tbody) {
    console.error('❌ transactionsTableBody not found');
    return;
  }

  if (!transactions || transactions.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="empty-state" style="padding: 3rem 2rem; text-align: center;">
          <div style="font-size: 4rem; color: #ddd; margin-bottom: 1rem; opacity: 0.5;">
            <i class="fas fa-exchange-alt"></i>
          </div>
          <p style="font-size: 1.1rem; color: #666; margin-bottom: 0.5rem;">No transactions yet</p>
          <p style="font-size: 0.9rem; color: #999;">Your transaction history will appear here once you start selling your produce</p>
        </td>
      </tr>
    `;
    return;
  }

  console.log(`📊 Displaying ${transactions.length} transactions`);

  tbody.innerHTML = transactions.map((tx, index) => {
    // ✅ VALIDATION MINIMALE
    if (!tx || !tx.id) {
      console.warn(`⚠️ Invalid transaction at index ${index}:`, tx);
      return '';
    }

    // ✅ VALEURS PAR DÉFAUT SÉCURISÉES
    const transactionCode = tx.transactionCode || tx.id || 'N/A';
    const transactionDate = tx.transactionDate ? formatDate(tx.transactionDate) : (tx.createdAt ? formatDate(tx.createdAt) : 'N/A');
    const buyerName = tx.buyerName || tx.buyer?.fullName || tx.buyer?.username || 'Unknown Buyer';
    const cropName = tx.cropName || tx.crop?.cropName || tx.crop?.name || 'N/A';
    const quantity = tx.quantity || 0;
    const unit = tx.unit || 'KG';
    const totalAmount = tx.totalAmount ? parseFloat(tx.totalAmount) : 0;
    const netAmount = tx.netAmountFarmer || tx.netAmount || 0;
    const status = tx.status || tx.transactionStatus || 'PENDING';
    const statusLower = status.toLowerCase();
    const transactionId = tx.id;

    // Status badge colors
    const statusColors = {
      'pending': 'background: rgba(255, 193, 7, 0.15); color: #f59e0b; border: 1px solid rgba(255, 193, 7, 0.3);',
      'confirmed': 'background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3);',
      'delivered': 'background: rgba(139, 92, 246, 0.15); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.3);',
      'paid': 'background: rgba(34, 197, 94, 0.15); color: var(--primary-green); border: 1px solid rgba(34, 197, 94, 0.3);',
      'completed': 'background: rgba(34, 197, 94, 0.15); color: var(--primary-green); border: 1px solid rgba(34, 197, 94, 0.3);',
      'cancelled': 'background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);',
      'disputed': 'background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);'
    };
    const statusStyle = statusColors[statusLower] || statusColors['pending'];

    return `
      <tr style="transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='#f8f9fa';" onmouseout="this.style.backgroundColor='transparent';">
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
          <strong style="color: #333; font-family: 'Courier New', monospace; font-size: 0.9rem;">${escapeHtml(transactionCode)}</strong>
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef; color: #666;">
          <i class="fas fa-calendar-alt" style="color: var(--primary-green); margin-right: 0.5rem;"></i>
          ${transactionDate}
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-user" style="color: #3b82f6;"></i>
            <span style="font-weight: 600; color: #333;">${escapeHtml(buyerName)}</span>
          </div>
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-seedling" style="color: var(--primary-green);"></i>
            <span style="font-weight: 600; color: #333;">${escapeHtml(cropName)}</span>
          </div>
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef; font-weight: 700; color: #333;">
          ${quantity} ${unit}
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef; font-weight: 700; color: #333;">
          ${formatCurrency(totalAmount)}
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef; font-weight: 700; color: var(--primary-green);">
          ${formatCurrency(netAmount)}
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
          <span style="padding: 0.4rem 0.9rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; ${statusStyle}">
            ${status}
          </span>
        </td>
        <td style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button class="btn-icon" onclick="viewTransactionDetails('${transactionId}')" title="View Details" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#3b82f6'; this.style.color='white';" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'; this.style.color='#3b82f6';">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn-icon" onclick="downloadTransactionPDF('${transactionId}')" title="Download PDF" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green); padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-green)'; this.style.color='white';" onmouseout="this.style.background='rgba(34, 197, 94, 0.1)'; this.style.color='var(--primary-green)';">
              <i class="fas fa-file-pdf"></i>
            </button>
            ${status === 'PENDING' || status === 'CONFIRMED' ? `
            <button class="btn-icon" onclick="updateTransactionStatus('${transactionId}', 'CONFIRMED')" title="Confirm" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green); padding: 0.5rem; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--primary-green)'; this.style.color='white';" onmouseout="this.style.background='rgba(34, 197, 94, 0.1)'; this.style.color='var(--primary-green)';">
              <i class="fas fa-check"></i>
            </button>
            ` : ''}
          </div>
        </td>
      </tr>
    `;
  }).filter(html => html !== '').join('');

  console.log(`✅ Table displayed with ${transactions.length} rows`);
}






/**
 * View transaction details - VERSION AMÉLIORÉE AVEC ENRICHISSEMENT
 */
async function viewTransactionDetails(transactionId) {
  if (!transactionId) {
    showToast('❌ Invalid transaction ID', 'error');
    return;
  }

  try {
    showLoading();

    // Fetch transaction details
    let transaction = await apiRequest(`/transactions/${transactionId}`);

    if (!transaction) {
      showToast('❌ Transaction not found', 'error');
      hideLoading();
      return;
    }

    // ✅ ENRICHIR AVEC LES DONNÉES BUYER ET CROP
    console.log('📦 Original transaction:', transaction);

    // Enrichir avec buyer name
    if (transaction.buyerId && !transaction.buyerName) {
      try {
        console.log('🔍 Fetching buyer:', transaction.buyerId);
        const buyerResponse = await apiRequest(`/users/${transaction.buyerId}`);
        const buyer = buyerResponse.data || buyerResponse;
        transaction.buyerName = buyer.fullName || buyer.username || buyer.email || 'Unknown Buyer';
        console.log('✅ Buyer fetched:', transaction.buyerName);
      } catch (error) {
        console.warn('⚠️ Error fetching buyer:', error);
        transaction.buyerName = 'Unknown Buyer';
      }
    }

    // Enrichir avec crop name
    if (transaction.cropId && !transaction.cropName) {
      try {
        console.log('🔍 Fetching crop:', transaction.cropId);
        const cropResponse = await apiRequest(`/v1/crops/${transaction.cropId}`);
        const crop = cropResponse.data || cropResponse;
        transaction.cropName = crop.cropName || crop.name || 'Unknown Crop';
        console.log('✅ Crop fetched:', transaction.cropName);
      } catch (error) {
        console.warn('⚠️ Error fetching crop:', error);
        transaction.cropName = 'Unknown Crop';
      }
    }

    console.log('✅ Enriched transaction:', transaction);

    // Show modal with enriched data
    showTransactionDetailsModal(transaction);

  } catch (error) {
    console.error('❌ Error loading transaction details:', error);
    showToast('❌ Error loading transaction details', 'error');
  } finally {
    hideLoading();
  }
}





/**
 * Show transaction details modal - VERSION AMÉLIORÉE
 */
function showTransactionDetailsModal(tx) {
  if (!tx) {
    console.error('❌ No transaction data provided');
    return;
  }

  console.log('📋 Showing transaction modal with data:', tx);

  // ✅ Validation et valeurs par défaut AMÉLIORÉES
  const transactionCode = tx.transactionCode || tx.id || 'N/A';
  const transactionDate = tx.transactionDate ? formatDateTime(tx.transactionDate) :
                         (tx.createdAt ? formatDateTime(tx.createdAt) : 'N/A');

  // ✅ MEILLEURE GESTION DU BUYER NAME
  const buyerName = tx.buyerName ||
                    (tx.buyer ? (tx.buyer.fullName || tx.buyer.username || tx.buyer.email) : null) ||
                    'Unknown Buyer';

  // ✅ MEILLEURE GESTION DU CROP NAME
  const cropName = tx.cropName ||
                   (tx.crop ? (tx.crop.cropName || tx.crop.name) : null) ||
                   'N/A';

  const quantity = tx.quantity || 0;
  const unit = tx.unit || 'KG';
  const pricePerUnit = tx.pricePerUnit ? formatCurrency(tx.pricePerUnit) : formatCurrency(0);
  const totalAmount = tx.totalAmount ? formatCurrency(tx.totalAmount) : formatCurrency(0);
  const transactionFee = tx.transactionFee ? formatCurrency(tx.transactionFee) : formatCurrency(0);
  const netAmount = (tx.netAmountFarmer || tx.netAmount) ? formatCurrency(tx.netAmountFarmer || tx.netAmount) : formatCurrency(0);
  const paymentMethod = tx.paymentMethod || 'N/A';
  const transactionStatus = tx.status || tx.transactionStatus || 'PENDING';
  const statusLower = transactionStatus.toLowerCase();
  const deliveryAddress = tx.deliveryAddress || null;
  const notes = tx.notes || null;

  console.log('✅ Modal data prepared:', {
    buyerName,
    cropName,
    transactionCode,
    transactionStatus
  });

  // Status colors
  const statusColors = {
    'pending': 'background: rgba(255, 193, 7, 0.15); color: #f59e0b; border: 2px solid #f59e0b;',
    'confirmed': 'background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 2px solid #3b82f6;',
    'delivered': 'background: rgba(139, 92, 246, 0.15); color: #8b5cf6; border: 2px solid #8b5cf6;',
    'paid': 'background: rgba(34, 197, 94, 0.15); color: var(--primary-green); border: 2px solid var(--primary-green);',
    'completed': 'background: rgba(34, 197, 94, 0.15); color: var(--primary-green); border: 2px solid var(--primary-green);',
    'cancelled': 'background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 2px solid #ef4444;',
    'disputed': 'background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 2px solid #ef4444;',
    'unknown': 'background: rgba(156, 163, 175, 0.15); color: #6b7280; border: 2px solid #6b7280;'
  };
  const statusStyle = statusColors[statusLower] || statusColors['unknown'];

  const modalHTML = `
    <div class="modal-overlay show" id="transactionModal" onclick="if(event.target === this) closeTransactionModal()">
      <div class="modal-container modal-large">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-receipt"></i>
            Transaction Details
          </h3>
          <button class="modal-close" onclick="closeTransactionModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <!-- Transaction Status Badge -->
          <div style="margin-bottom: 24px; text-align: center;">
            <span style="padding: 10px 24px; border-radius: 24px; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; ${statusStyle}">
              ${transactionStatus}
            </span>
          </div>

          <div class="details-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div class="detail-item" style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <label style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 8px;">Transaction Code</label>
              <value style="font-size: 16px; font-weight: 700; color: #333; font-family: 'Courier New', monospace;">${escapeHtml(transactionCode)}</value>
            </div>
            <div class="detail-item" style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <label style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 8px;">Date</label>
              <value style="font-size: 16px; font-weight: 600; color: #333;">${transactionDate}</value>
            </div>
            <div class="detail-item" style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <label style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 8px;">
                <i class="fas fa-user" style="color: #3b82f6;"></i> Buyer
              </label>
              <value style="font-size: 16px; font-weight: 700; color: #3b82f6;">${escapeHtml(buyerName)}</value>
            </div>
            <div class="detail-item" style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <label style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 8px;">
                <i class="fas fa-seedling" style="color: var(--primary-green);"></i> Crop
              </label>
              <value style="font-size: 16px; font-weight: 700; color: var(--primary-green);">${escapeHtml(cropName)}</value>
            </div>
            <div class="detail-item" style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <label style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 8px;">Quantity</label>
              <value style="font-size: 16px; font-weight: 700; color: #333;">${quantity} ${unit}</value>
            </div>
            <div class="detail-item" style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <label style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 8px;">Price per Unit</label>
              <value style="font-size: 16px; font-weight: 700; color: #333;">${pricePerUnit}</value>
            </div>
            <div class="detail-item" style="padding: 16px; background: #fff3cd; border-radius: 8px; border: 2px solid #f59e0b;">
              <label style="font-size: 12px; color: #856404; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 8px;">Total Amount</label>
              <value style="font-size: 18px; font-weight: 700; color: #f59e0b;">${totalAmount}</value>
            </div>
            <div class="detail-item" style="padding: 16px; background: #d1e7dd; border-radius: 8px; border: 2px solid var(--primary-green);">
              <label style="font-size: 12px; color: #0f5132; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 8px;">Net Amount</label>
              <value style="font-size: 18px; font-weight: 700; color: var(--primary-green);">${netAmount}</value>
            </div>
            ${tx.transactionFee ? `
            <div class="detail-item" style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <label style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 8px;">Transaction Fee</label>
              <value style="font-size: 16px; font-weight: 700; color: #ef4444;">${transactionFee}</value>
            </div>
            ` : ''}
            <div class="detail-item" style="padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <label style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 8px;">Payment Method</label>
              <value style="font-size: 16px; font-weight: 700; color: #333;">${escapeHtml(paymentMethod)}</value>
            </div>
            ${deliveryAddress ? `
            <div class="detail-item" style="padding: 16px; background: #f8f9fa; border-radius: 8px; grid-column: 1 / -1;">
              <label style="font-size: 12px; color: #666; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 8px;">
                <i class="fas fa-map-marker-alt" style="color: #ef4444;"></i> Delivery Address
              </label>
              <value style="font-size: 14px; color: #333; line-height: 1.6;">${escapeHtml(deliveryAddress)}</value>
            </div>
            ` : ''}
            ${notes ? `
            <div class="detail-item" style="padding: 16px; background: #e7f3ff; border-radius: 8px; grid-column: 1 / -1; border-left: 4px solid #3b82f6;">
              <label style="font-size: 12px; color: #084298; text-transform: uppercase; font-weight: 600; display: block; margin-bottom: 8px;">
                <i class="fas fa-sticky-note"></i> Notes
              </label>
              <value style="font-size: 14px; color: #333; line-height: 1.6;">${escapeHtml(notes)}</value>
            </div>
            ` : ''}
          </div>
        </div>
        <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
          <button type="button" class="btn btn-secondary" onclick="closeTransactionModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
          <div style="display: flex; gap: 8px;">
            <button type="button" class="btn btn-success" onclick="downloadTransactionPDF('${tx.id}')">
              <i class="fas fa-file-pdf"></i>
              Download PDF
            </button>
            ${transactionStatus === 'PENDING' ? `
            <button type="button" class="btn btn-primary" onclick="updateTransactionStatus('${tx.id}', 'CONFIRMED'); closeTransactionModal();">
              <i class="fas fa-check"></i>
              Confirm Transaction
            </button>
            ` : ''}
          </div>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;
}


/**
 * Close transaction modal
 */
function closeTransactionModal() {
  const modal = document.getElementById('transactionModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}





/**
 * ============================================
 * TRANSACTION PDF - PROFESSIONAL GREEN DESIGN
 * MATCHING SOIL REPORT STYLE
 * ============================================
 */

async function downloadTransactionPDF(transactionId) {
  if (!transactionId) {
    showToast('❌ Invalid transaction ID', 'error');
    return;
  }

  try {
    showLoading();
    showToast('Generating professional PDF report...', 'info');

    const tx = await apiRequest(`/transactions/${transactionId}`);

    if (!tx) {
      showToast('❌ Transaction not found', 'error');
      hideLoading();
      return;
    }

    if (tx.buyerId && !tx.buyerName) {
      try {
        const buyerResponse = await apiRequest(`/users/${tx.buyerId}`);
        const buyer = buyerResponse.data || buyerResponse;
        tx.buyerName = buyer.fullName || buyer.username || buyer.email || 'Unknown Buyer';
      } catch (error) {
        console.warn('Error fetching buyer:', error);
        tx.buyerName = 'Unknown Buyer';
      }
    }

    if (tx.cropId && !tx.cropName) {
      try {
        const cropResponse = await apiRequest(`/v1/crops/${tx.cropId}`);
        const crop = cropResponse.data || cropResponse;
        tx.cropName = crop.cropName || crop.name || 'Unknown Crop';
      } catch (error) {
        console.warn('Error fetching crop:', error);
        tx.cropName = 'Unknown Crop';
      }
    }

    const farmerName = currentUser?.fullName || currentUser?.username || 'Farmer';
    const currentDate = new Date().toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    const pdfHTML = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <style>
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }

          @page {
            size: A4;
            margin: 0;
          }

          body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #1a1a1a;
            background: white;
            padding: 0;
            margin: 0;
          }

          .page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            position: relative;
          }

          /* Header */
          .report-header {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 50%, #15803d 100%);
            padding: 35px 30px;
            color: white;
            position: relative;
            overflow: hidden;
          }

          .report-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 280px;
            height: 280px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            transform: translate(30%, -30%);
          }

          .report-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 180px;
            height: 180px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 50%;
            transform: translate(-30%, 30%);
          }

          .header-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 20px;
          }

          .logo-container {
            width: 75px;
            height: 75px;
            background: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            flex-shrink: 0;
          }

          .logo-container img {
            width: 55px;
            height: 55px;
            object-fit: contain;
          }

          .header-text {
            flex: 1;
          }

          .company-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            opacity: 0.95;
            letter-spacing: 0.5px;
          }

          .report-title {
            font-size: 30px;
            font-weight: 800;
            margin-bottom: 6px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          }

          .report-subtitle {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 400;
          }

          /* Info Bar */
          .info-bar {
            background: linear-gradient(to right, #f0fdf4, #dcfce7);
            padding: 18px 30px;
            border-bottom: 3px solid #22c55e;
          }

          .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
          }

          .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
          }

          .info-label {
            font-size: 10px;
            color: #16a34a;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }

          .info-value {
            font-size: 14px;
            color: #1a1a1a;
            font-weight: 600;
          }

          /* Status Badge */
          .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
          }

          .status-pending { background: #fef3c7; color: #92400e; }
          .status-confirmed { background: #dbeafe; color: #1e40af; }
          .status-delivered { background: #e9d5ff; color: #6b21a8; }
          .status-paid { background: #d1fae5; color: #065f46; }
          .status-completed { background: #d1fae5; color: #065f46; }
          .status-cancelled { background: #fee2e2; color: #991b1b; }

          /* Main Content */
          .report-body {
            padding: 25px 30px 30px 30px;
          }

          /* Section Styles */
          .section {
            margin-bottom: 25px;
          }

          .section-header {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 11px 18px;
            margin-bottom: 14px;
            border-radius: 8px;
            font-size: 17px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.25);
          }

          .section-icon {
            font-size: 19px;
          }

          /* Properties Grid */
          .properties-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 13px;
            margin-top: 14px;
          }

          .property-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 9px;
            padding: 14px;
          }

          .property-card.highlight {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            box-shadow: 0 6px 16px rgba(34, 197, 94, 0.3);
          }

          .property-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            color: #6b7280;
          }

          .property-card.highlight .property-label {
            color: rgba(255, 255, 255, 0.9);
          }

          .property-value {
            font-size: 19px;
            font-weight: 800;
            color: #1a1a1a;
          }

          .property-card.highlight .property-value {
            color: white;
          }

          /* Transaction Details Table */
          .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 14px;
            border-radius: 8px;
            overflow: hidden;
          }

          .transaction-table thead {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
          }

          .transaction-table th {
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }

          .transaction-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 13px;
          }

          .transaction-table tbody tr:last-child td {
            border-bottom: none;
          }

          .total-row {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            font-weight: 700;
          }

          .total-row td {
            padding: 15px;
            font-size: 16px;
            color: #16a34a;
            border-top: 2px solid #22c55e;
          }

          /* Notes Box */
          .notes-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 5px solid #f59e0b;
            padding: 18px;
            border-radius: 9px;
            margin-top: 14px;
          }

          .notes-title {
            font-size: 15px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 9px;
            display: flex;
            align-items: center;
            gap: 8px;
          }

          .notes-text {
            font-size: 12px;
            color: #78350f;
            line-height: 1.7;
          }

          /* Footer */
          .report-footer {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 22px 30px;
            border-top: 3px solid #22c55e;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
          }

          .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
          }

          .footer-logo {
            display: flex;
            align-items: center;
            gap: 11px;
          }

          .footer-logo img {
            width: 45px;
            height: 45px;
            object-fit: contain;
          }

          .footer-text {
            font-size: 10px;
            color: #16a34a;
            font-weight: 600;
          }

          .footer-meta {
            text-align: right;
            font-size: 9px;
            color: #6b7280;
            line-height: 1.6;
          }

          /* Watermark */
          .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 110px;
            color: rgba(34, 197, 94, 0.03);
            font-weight: 900;
            z-index: -1;
            pointer-events: none;
          }
        </style>
      </head>
      <body>
        <div class="watermark">TRANSACTION</div>

        <div class="page">
          <!-- Header -->
          <div class="report-header">
            <div class="header-content">
              <div class="logo-container">
                <img src="images/logo.jpeg" alt="AgriGuard AI" onerror="this.style.display='none'">
              </div>
              <div class="header-text">
                <div class="company-name">AgriGuard AI - Smart Agriculture Management</div>
                <h1 class="report-title">💰 Transaction Receipt</h1>
                <div class="report-subtitle">Official Transaction Documentation & Payment Record</div>
              </div>
            </div>
          </div>

          <!-- Info Bar -->
          <div class="info-bar">
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Transaction Code</div>
                <div class="info-value">${tx.transactionCode || tx.id}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Transaction Date</div>
                <div class="info-value">${tx.transactionDate ? formatDate(tx.transactionDate) : 'N/A'}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Status</div>
                <div class="info-value">
                  <span class="status-badge status-${(tx.status || tx.transactionStatus || 'PENDING').toLowerCase()}">${tx.status || tx.transactionStatus || 'PENDING'}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Content -->
          <div class="report-body">

            <!-- Parties Information -->
            <div class="section">
              <div class="section-header">
                <span class="section-icon">👥</span>
                <span>Transaction Parties</span>
              </div>
              <div class="properties-grid">
                <div class="property-card">
                  <div class="property-label">Farmer (Seller)</div>
                  <div class="property-value">${farmerName}</div>
                </div>
                <div class="property-card">
                  <div class="property-label">Buyer</div>
                  <div class="property-value">${tx.buyerName || 'Unknown Buyer'}</div>
                </div>
                <div class="property-card">
                  <div class="property-label">Crop Name</div>
                  <div class="property-value">${tx.cropName || 'N/A'}</div>
                </div>
                <div class="property-card">
                  <div class="property-label">Payment Method</div>
                  <div class="property-value">${tx.paymentMethod || 'N/A'}</div>
                </div>
              </div>
            </div>

            <!-- Transaction Details -->
            <div class="section">
              <div class="section-header">
                <span class="section-icon">📊</span>
                <span>Transaction Details</span>
              </div>
              <table class="transaction-table">
                <thead>
                  <tr>
                    <th>Description</th>
                    <th style="text-align: center;">Quantity</th>
                    <th style="text-align: right;">Unit Price</th>
                    <th style="text-align: right;">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><strong>${tx.cropName || 'Product'}</strong></td>
                    <td style="text-align: center;">${tx.quantity || 0} ${tx.unit || 'KG'}</td>
                    <td style="text-align: right;">${tx.pricePerUnit ? formatCurrency(tx.pricePerUnit) : formatCurrency(0)}</td>
                    <td style="text-align: right;"><strong>${tx.totalAmount ? formatCurrency(tx.totalAmount) : formatCurrency(0)}</strong></td>
                  </tr>
                  ${tx.transactionFee ? `
                  <tr>
                    <td colspan="3"><strong>Transaction Fee</strong></td>
                    <td style="text-align: right; color: #dc2626;">- ${formatCurrency(tx.transactionFee)}</td>
                  </tr>
                  ` : ''}
                  ${tx.brokerCommission ? `
                  <tr>
                    <td colspan="3"><strong>Broker Commission</strong></td>
                    <td style="text-align: right; color: #dc2626;">- ${formatCurrency(tx.brokerCommission)}</td>
                  </tr>
                  ` : ''}
                  ${tx.governmentTax ? `
                  <tr>
                    <td colspan="3"><strong>Government Tax</strong></td>
                    <td style="text-align: right; color: #dc2626;">- ${formatCurrency(tx.governmentTax)}</td>
                  </tr>
                  ` : ''}
                  <tr class="total-row">
                    <td colspan="3"><strong>NET AMOUNT (Farmer Receives)</strong></td>
                    <td style="text-align: right; font-size: 20px; font-weight: 800;">${formatCurrency(tx.netAmountFarmer || tx.netAmount || 0)}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Payment Summary -->
            <div class="section">
              <div class="section-header">
                <span class="section-icon">💳</span>
                <span>Payment Summary</span>
              </div>
              <div class="properties-grid">
                <div class="property-card highlight">
                  <div class="property-label">Total Amount</div>
                  <div class="property-value">${tx.totalAmount ? formatCurrency(tx.totalAmount) : formatCurrency(0)}</div>
                </div>
                <div class="property-card highlight">
                  <div class="property-label">Net Amount</div>
                  <div class="property-value">${formatCurrency(tx.netAmountFarmer || tx.netAmount || 0)}</div>
                </div>
              </div>
            </div>

            ${tx.notes ? `
            <div class="section">
              <div class="section-header">
                <span class="section-icon">📝</span>
                <span>Additional Notes</span>
              </div>
              <div class="notes-box">
                <div class="notes-title">
                  <span>📋</span>
                  <span>Transaction Notes</span>
                </div>
                <div class="notes-text">
                  ${tx.notes}
                </div>
              </div>
            </div>
            ` : ''}

          </div>

          <!-- Footer -->
          <div class="report-footer">
            <div class="footer-content">
              <div class="footer-logo">
                <img src="images/logo.jpeg" alt="AgriGuard AI" onerror="this.style.display='none'">
                <div>
                  <div class="footer-text">AgriGuard AI</div>
                  <div class="footer-text" style="font-size: 8px; font-weight: 400;">Smart Agriculture Management System</div>
                </div>
              </div>
              <div class="footer-meta">
                <div><strong>Receipt ID:</strong> ${tx.transactionCode || tx.id}</div>
                <div><strong>Generated:</strong> ${currentDate}</div>
                <div><strong>Version:</strong> 1.0</div>
                <div style="margin-top: 6px; color: #16a34a; font-weight: 600;">www.agriguard-ai.com</div>
              </div>
            </div>
          </div>
        </div>

      </body>
      </html>
    `;

    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = pdfHTML;
    tempContainer.style.width = '210mm';
    tempContainer.style.backgroundColor = 'white';
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0';
    document.body.appendChild(tempContainer);

    await new Promise(resolve => setTimeout(resolve, 800));

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');

    const canvas = await html2canvas(tempContainer, {
      scale: 2,
      useCORS: true,
      logging: false,
      backgroundColor: '#ffffff'
    });

    const imgData = canvas.toDataURL('image/png');
    const imgWidth = 210;
    const pageHeight = 297;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    document.body.removeChild(tempContainer);

    const fileName = `Transaction_${tx.transactionCode || tx.id}_${new Date().toISOString().split('T')[0]}.pdf`;
    pdf.save(fileName);

    showToast('✅ Professional PDF report downloaded successfully!', 'success');

  } catch (error) {
    console.error('Error generating PDF:', error);
    showToast('❌ Error generating PDF report', 'error');
  } finally {
    hideLoading();
  }
}



/**
 * Initialize WhatsApp Chat functionality
 */
function initWhatsAppChat() {
    const whatsappLink = document.getElementById('whatsappChatLink');

    if (whatsappLink) {
        whatsappLink.addEventListener('click', async function(e) {
            e.preventDefault(); // Empêcher l'ouverture directe

            try {
                showLoading();
                showToast('Opening WhatsApp Chat...', 'info');

                // Vérifier si l'utilisateur est connecté
                if (!currentUser || !currentUser.email) {
                    showToast('Please log in to use WhatsApp Chat', 'warning');
                    return;
                }

                // Préparer les données utilisateur pour passer à WhatsApp
                const userData = {
                    farmerId: currentUser.id || currentUser.userId,
                    farmerName: currentUser.fullName,
                    farmerEmail: currentUser.email,
                    phone: currentUser.phone || '',
                    timestamp: new Date().toISOString()
                };

                // Option 1: Ouvrir dans un nouvel onglet avec données
                const url = `http://localhost:1010/WhatsAppFarmerBuyer.html?farmerId=${encodeURIComponent(userData.farmerId)}&farmerName=${encodeURIComponent(userData.farmerName)}&farmerEmail=${encodeURIComponent(userData.farmerEmail)}`;

                // Ouvrir dans un nouvel onglet
                window.open(url, '_blank');

                // Option 2: Charger dans un iframe modal (si préféré)
                // openWhatsAppModal(userData);

                showToast('WhatsApp Chat opened successfully', 'success');

            } catch (error) {
                console.error('Error opening WhatsApp Chat:', error);
                showToast('Error opening WhatsApp Chat', 'error');
                // Fallback: ouvrir le lien directement
                window.open(this.href, '_blank');
            } finally {
                hideLoading();
            }
        });
    }
}

/**
 * Optionnel: Ouvrir WhatsApp dans une modal
 */
function openWhatsAppModal(userData) {
    // Créer la modal
    const modal = document.createElement('div');
    modal.className = 'whatsapp-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
    `;

    // Créer l'iframe
    const iframe = document.createElement('iframe');
    iframe.src = `http://localhost:1010/WhatsAppFarmerBuyer.html?farmerId=${encodeURIComponent(userData.farmerId)}&farmerName=${encodeURIComponent(userData.farmerName)}`;
    iframe.style.cssText = `
        width: 90%;
        height: 90%;
        border: none;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    `;

    // Bouton de fermeture
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = '&times;';
    closeBtn.style.cssText = `
        position: absolute;
        top: 20px;
        right: 20px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 24px;
        cursor: pointer;
        z-index: 10000;
    `;
    closeBtn.onclick = () => {
        document.body.removeChild(modal);
    };

    modal.appendChild(iframe);
    modal.appendChild(closeBtn);
    document.body.appendChild(modal);
}


/**
 * Update transaction status - VERSION SÉCURISÉE
 */
async function updateTransactionStatus(transactionId, newStatus) {
  if (!transactionId) {
    showToast('❌ Invalid transaction ID', 'error');
    return;
  }

  if (!confirm(`Are you sure you want to change the status to ${newStatus}?`)) {
    return;
  }

  try {
    showLoading();

    await apiRequest(`/transactions/${transactionId}/status`, {
      method: 'PUT',
      body: JSON.stringify({ status: newStatus })
    });

    showToast('✅ Transaction status updated successfully', 'success');
    closeTransactionModal();
    await loadTransactionsData();

  } catch (error) {
    console.error('Error updating transaction status:', error);
    showToast('❌ Error updating transaction status: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}



/**
 * Export transactions to Excel
 */
async function exportTransactionsToExcel() {
    try {
        showLoading();
        showToast('Preparing export...', 'info');

        // Récupérer les transactions
        const response = await apiRequest(`/transactions/farmer/${currentUser.id}`);
        let transactions = [];

        if (Array.isArray(response)) transactions = response;
        else if (response?.data && Array.isArray(response.data)) transactions = response.data;
        else if (response?.content && Array.isArray(response.content)) transactions = response.content;
        else if (response?.data?.content && Array.isArray(response.data.content)) transactions = response.data.content;

        transactions = transactions.filter(tx => tx && tx.id);

        if (transactions.length === 0) {
            showToast('No transactions to export', 'warning');
            hideLoading();
            return;
        }

        // Enricher avec buyer + crop names
        transactions = await Promise.all(transactions.map(async (tx) => {
            try {
                if (tx.buyerId && !tx.buyerName) {
                    const buyerRes = await apiRequest(`/users/${tx.buyerId}`);
                    const buyer = buyerRes.data || buyerRes;
                    tx.buyerName = buyer.fullName || buyer.username || buyer.email || 'Unknown Buyer';
                }
                if (tx.cropId && !tx.cropName) {
                    const cropRes = await apiRequest(`/v1/crops/${tx.cropId}`);
                    const crop = cropRes.data || cropRes;
                    tx.cropName = crop.cropName || crop.name || 'Unknown Crop';
                }
            } catch (e) { /* silent */ }
            return tx;
        }));

        // Headers
        const headers = [
            'Transaction Code', 'Date', 'Buyer', 'Crop',
            'Quantity', 'Unit', 'Price/Unit (RWF)', 'Total Amount (RWF)',
            'Transaction Fee (RWF)', 'Net Amount (RWF)',
            'Payment Method', 'Status', 'Delivery Address', 'Notes'
        ];

        // Rows
        const rows = transactions.map(tx => [
            tx.transactionCode || tx.id || '',
            tx.transactionDate ? tx.transactionDate.split('T')[0] : (tx.createdAt ? tx.createdAt.split('T')[0] : ''),
            tx.buyerName || tx.buyer?.fullName || tx.buyer?.username || 'Unknown Buyer',
            tx.cropName || tx.crop?.cropName || tx.crop?.name || '',
            parseFloat(tx.quantity) || 0,
            tx.unit || 'KG',
            parseFloat(tx.pricePerUnit) || '',
            parseFloat(tx.totalAmount) || 0,
            parseFloat(tx.transactionFee) || '',
            parseFloat(tx.netAmountFarmer || tx.netAmount) || 0,
            tx.paymentMethod || '',
            tx.status || tx.transactionStatus || 'PENDING',
            tx.deliveryAddress || '',
            tx.notes || ''
        ]);

        // Shared strings
        const strings = [];
        const strMap = {};
        function addString(val) {
            const s = String(val);
            if (!(s in strMap)) { strMap[s] = strings.length; strings.push(s); }
            return strMap[s];
        }
        headers.forEach(h => addString(h));
        rows.forEach(row => row.forEach(cell => { if (typeof cell === 'string') addString(cell); }));

        function escapeXml(s) {
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
        }

        function cellRef(col, row) {
            let c = '', n = col;
            while (n >= 0) { c = String.fromCharCode(65 + (n % 26)) + c; n = Math.floor(n / 26) - 1; }
            return c + (row + 1);
        }

        // quantity, price/unit, totalAmount, transactionFee, netAmount
        const numCols = [4, 6, 7, 8, 9];

        // sheet1.xml
        let sheetRows = '';
        let headerCells = headers.map((h, ci) => `<c r="${cellRef(ci,0)}" t="s" s="1"><v>${addString(h)}</v></c>`).join('');
        sheetRows += `<row r="1">${headerCells}</row>`;

        rows.forEach((row, ri) => {
            let cells = row.map((cell, ci) => {
                const ref = cellRef(ci, ri + 1);
                if (numCols.includes(ci) && cell !== '' && !isNaN(cell)) {
                    return `<c r="${ref}" s="2"><v>${cell}</v></c>`;
                }
                return `<c r="${ref}" t="s" s="2"><v>${addString(String(cell))}</v></c>`;
            }).join('');
            sheetRows += `<row r="${ri + 2}">${cells}</row>`;
        });

        const sheet1 = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<sheetViews><sheetView tabSelected="1" workbookViewId="0"/></sheetViews>
<sheetFormatPr defaultRowHeight="20"/>
<cols>${headers.map((_,i) => `<col min="${i+1}" max="${i+1}" width="24" customWidth="1"/>`).join('')}</cols>
<sheetData>${sheetRows}</sheetData>
</worksheet>`;

        const styles = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<fonts count="3">
  <font><sz val="11"/><name val="Calibri"/></font>
  <font><b/><sz val="11"/><color rgb="FFFFFFFF"/><name val="Calibri"/></font>
  <font><sz val="11"/><name val="Calibri"/></font>
</fonts>
<fills count="3">
  <fill><patternFill patternType="none"/></fill>
  <fill><patternFill patternType="solid"><fgColor rgb="FF10B981"/></patternFill></fill>
  <fill><patternFill patternType="solid"><fgColor rgb="FFF0FDF4"/></patternFill></fill>
</fills>
<borders count="2">
  <border><left/><right/><top/><bottom/><diagonal/></border>
  <border><left style="thin"><color rgb="FF10B981"/></left><right style="thin"><color rgb="FF10B981"/></right><top style="thin"><color rgb="FF10B981"/></top><bottom style="thin"><color rgb="FF10B981"/></bottom><diagonal/></border>
</borders>
<cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>
<cellXfs count="3">
  <xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/>
  <xf numFmtId="0" fontId="1" fillId="1" borderId="1" xfId="0" applyFont="1" applyFill="1" applyBorder="1" applyAlignment="1"><alignment horizontal="center" vertical="center"/></xf>
  <xf numFmtId="0" fontId="2" fillId="2" borderId="1" xfId="0" applyFill="1" applyBorder="1"/>
</cellXfs>
</styleSheet>`;

        const sharedStrings = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="${strings.length}" uniqueCount="${strings.length}">
${strings.map(s => `<si><t>${escapeXml(s)}</t></si>`).join('')}
</sst>`;

        const workbook = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
<sheets><sheet name="Transactions" sheetId="1" r:id="rId1"/></sheets>
</workbook>`;

        const rels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
<Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings" Target="sharedStrings.xml"/>
</Relationships>`;

        const topRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
</Relationships>`;

        const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
<Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
<Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>
<Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/>
</Types>`;

        const files = {
            '[Content_Types].xml': contentTypes,
            '_rels/.rels': topRels,
            'xl/workbook.xml': workbook,
            'xl/_rels/workbook.xml.rels': rels,
            'xl/worksheets/sheet1.xml': sheet1,
            'xl/styles.xml': styles,
            'xl/sharedStrings.xml': sharedStrings
        };

        const blob = await buildZipBlob(files);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Transactions_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('✅ Export successful!', 'success');

    } catch (error) {
        console.error('❌ Export error:', error);
        showToast('Failed to export: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

// ✅ Remplacer l'ancien listener Export transactions
document.querySelectorAll('[data-action="export-transactions"]').forEach(btn => {
    btn.addEventListener('click', exportTransactionsToExcel);
});







/**
 * Load supply chain data - VERSION AVEC DEBUG COMPLET
 */
async function loadSupplyChainData() {
    try {
        showLoading();

        if (!currentUser || !currentUser.id) {
            console.error('❌ No current user found');
            displayEmptySupplyChainState();
            return;
        }

        console.log('🔄 Loading supply chain data for farmer:', currentUser.id);

        // ✅ ÉTAPE 1: Charger TOUTES les fermes du farmer
        const farmsMap = new Map();
        const farmsByFarmerIdMap = new Map();

        try {
            console.log('🔄 Loading farms first...');
            const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);

            let farms = [];
            if (Array.isArray(farmsResponse)) {
                farms = farmsResponse;
            } else if (farmsResponse && farmsResponse.data && Array.isArray(farmsResponse.data)) {
                farms = farmsResponse.data;
            }

            farms.forEach(farm => {
                if (farm && farm.id) {
                    farmsMap.set(farm.id, farm);

                    if (farm.farmerId) {
                        if (!farmsByFarmerIdMap.has(farm.farmerId)) {
                            farmsByFarmerIdMap.set(farm.farmerId, []);
                        }
                        farmsByFarmerIdMap.get(farm.farmerId).push(farm);
                    }

                    console.log(`✅ Farm loaded: ID=${farm.id}, Name="${farm.farmName}", farmerId=${farm.farmerId}`);
                }
            });

            console.log(`✅ Total farms loaded: ${farmsMap.size}`);

        } catch (error) {
            console.error('❌ Error loading farms:', error);
        }

        // ✅ ÉTAPE 2: Charger TOUS les crops AVANT les productions
        const cropsMap = new Map();

        try {
            console.log('🔄 Loading all crops...');
            const cropsResponse = await apiRequest(`/crops`);

            console.log('🐛 DEBUG - Raw crops response:', cropsResponse);

            let crops = [];
            if (Array.isArray(cropsResponse)) {
                crops = cropsResponse;
                console.log('🐛 DEBUG - Crops is direct array');
            } else if (cropsResponse && cropsResponse.data && Array.isArray(cropsResponse.data)) {
                crops = cropsResponse.data;
                console.log('🐛 DEBUG - Crops is in .data property');
            } else if (cropsResponse && cropsResponse.content && Array.isArray(cropsResponse.content)) {
                crops = cropsResponse.content;
                console.log('🐛 DEBUG - Crops is in .content property');
            }

            console.log('🐛 DEBUG - Extracted crops array:', crops);
            console.log('🐛 DEBUG - Total crops to process:', crops.length);

            crops.forEach(crop => {
                if (crop && crop.id) {
                    cropsMap.set(crop.id, crop);
                    console.log(`✅ Crop loaded: ID=${crop.id}, Name="${crop.cropName || crop.name}"`);
                } else {
                    console.warn('🐛 DEBUG - Invalid crop object:', crop);
                }
            });

            console.log(`✅ Total crops loaded in Map: ${cropsMap.size}`);
            console.log('🐛 DEBUG - All crop IDs in map:', Array.from(cropsMap.keys()));

        } catch (error) {
            console.error('❌ Error loading crops:', error);
        }

        // ✅ ÉTAPE 3: Charger les productions
        const productionsMap = new Map();

        try {
            console.log('🔄 Loading crop productions...');
            const productionsResponse = await apiRequest(`/v1/crop-productions/farmer/${currentUser.id}`);

            console.log('🐛 DEBUG - Raw productions response:', productionsResponse);

            let productions = [];
            if (productionsResponse && productionsResponse.data && Array.isArray(productionsResponse.data)) {
                productions = productionsResponse.data;
                console.log('🐛 DEBUG - Productions is in .data property');
            } else if (Array.isArray(productionsResponse)) {
                productions = productionsResponse;
                console.log('🐛 DEBUG - Productions is direct array');
            }

            console.log('🐛 DEBUG - Extracted productions array:', productions);
            console.log('🐛 DEBUG - Total productions to process:', productions.length);

            productions.forEach(prod => {
                if (prod && prod.id) {
                    console.log(`🐛 DEBUG - Processing production ${prod.id}:`);
                    console.log(`   - cropId: ${prod.cropId}`);
                    console.log(`   - cropName (before enrichment): ${prod.cropName}`);
                    console.log(`   - Crop exists in map: ${cropsMap.has(prod.cropId)}`);

                    // ✅ ENRICHIR la production avec le nom du crop
                    if (prod.cropId && cropsMap.has(prod.cropId)) {
                        const crop = cropsMap.get(prod.cropId);
                        console.log(`🐛 DEBUG - Found crop:`, crop);
                        prod.cropName = crop.cropName || crop.name;
                        prod.cropImageUrl = crop.imageUrl;
                        console.log(`✅ Production enriched: ID=${prod.id}, Crop="${prod.cropName}"`);
                    } else {
                        console.warn(`⚠️ No crop found for production ${prod.id}`);
                        console.warn(`   - cropId: ${prod.cropId}`);
                        console.warn(`   - Available crop IDs: ${Array.from(cropsMap.keys()).join(', ')}`);

                        if (!prod.cropName) {
                            prod.cropName = 'Crop Information Not Available';
                        }
                    }

                    console.log(`   - cropName (after enrichment): ${prod.cropName}`);

                    productionsMap.set(prod.id, prod);
                }
            });

            console.log(`✅ Total productions loaded: ${productionsMap.size}`);

        } catch (error) {
            console.error('❌ Error loading productions:', error);
        }

        // ✅ ÉTAPE 4: Charger les supply chains
        let allSupplyChains = [];

        try {
            console.log('🔄 Loading supply chain records...');
            const scResponse = await apiRequest(`/supply-chain/farmer/${currentUser.id}`);

            if (Array.isArray(scResponse)) {
                allSupplyChains = scResponse;
            } else if (scResponse && scResponse.content && Array.isArray(scResponse.content)) {
                allSupplyChains = scResponse.content;
            } else if (scResponse && scResponse.data && Array.isArray(scResponse.data)) {
                allSupplyChains = scResponse.data;
            }

            console.log(`✅ Loaded ${allSupplyChains.length} supply chain records`);

        } catch (error) {
            console.warn('⚠️ Error loading supply chains:', error);
            allSupplyChains = [];
        }

        // ✅ ÉTAPE 5: ENRICHISSEMENT INTELLIGENT
        allSupplyChains = allSupplyChains.map(stage => {
            console.log('📦 Processing stage:', stage.id);
            console.log(`🐛 DEBUG - Stage data:`, stage);
            console.log(`   - cropProductionId: ${stage.cropProductionId}`);
            console.log(`   - cropId: ${stage.cropId}`);

            const enriched = { ...stage };
            let farmFound = false;
            let cropFound = false;

            // 1. Essayer d'enrichir via production
            if (stage.cropProductionId && productionsMap.has(stage.cropProductionId)) {
                const production = productionsMap.get(stage.cropProductionId);
                console.log(`🐛 DEBUG - Found production:`, production);
                console.log(`   - production.cropName: ${production.cropName}`);

                // ✅ CROP NAME - Utiliser le cropName enrichi de la production
                enriched.cropName = production.cropName || 'Crop Information Not Available';
                enriched.productionName = production.cropName || 'Crop Information Not Available';
                enriched.cropImageUrl = production.cropImageUrl;
                cropFound = true;

                console.log(`📌 Production found: "${enriched.cropName}"`);

                // ✅ FARM - Méthode 1
                if (production.farmId && farmsMap.has(production.farmId)) {
                    const farm = farmsMap.get(production.farmId);
                    enriched.farmId = farm.id;
                    enriched.farmName = farm.farmName || 'Unnamed Farm';
                    farmFound = true;
                    console.log(`✅ Method 1 SUCCESS: Found farm by farmId="${production.farmId}" → "${enriched.farmName}"`);
                }

                // ✅ FARM - Méthode 2
                if (!farmFound && production.farmId && farmsByFarmerIdMap.has(production.farmId)) {
                    const farmerFarms = farmsByFarmerIdMap.get(production.farmId);
                    if (farmerFarms && farmerFarms.length > 0) {
                        const farm = farmerFarms[0];
                        enriched.farmId = farm.id;
                        enriched.farmName = farm.farmName || 'Unnamed Farm';
                        farmFound = true;
                        console.log(`✅ Method 2 SUCCESS: Found farm by farmerId="${production.farmId}" → "${enriched.farmName}"`);
                    }
                }

                // ✅ FARM - Méthode 3
                if (!farmFound && production.farmerId && farmsByFarmerIdMap.has(production.farmerId)) {
                    const farmerFarms = farmsByFarmerIdMap.get(production.farmerId);
                    if (farmerFarms && farmerFarms.length > 0) {
                        const farm = farmerFarms[0];
                        enriched.farmId = farm.id;
                        enriched.farmName = farm.farmName || 'Unnamed Farm';
                        farmFound = true;
                        console.log(`✅ Method 3 SUCCESS: Found farm by production.farmerId="${production.farmerId}" → "${enriched.farmName}"`);
                    }
                }
            } else {
                console.warn(`⚠️ Production not found for cropProductionId: ${stage.cropProductionId}`);
                console.warn(`   Available production IDs: ${Array.from(productionsMap.keys()).join(', ')}`);
            }

            // ✅ SI PAS DE CROP VIA PRODUCTION, chercher directement
            if (!cropFound && stage.cropId) {
                console.log(`🐛 DEBUG - Trying to find crop directly by cropId: ${stage.cropId}`);
                console.log(`   - Crop exists in map: ${cropsMap.has(stage.cropId)}`);

                if (cropsMap.has(stage.cropId)) {
                    const crop = cropsMap.get(stage.cropId);
                    console.log(`🐛 DEBUG - Found crop directly:`, crop);
                    enriched.cropName = crop.cropName || crop.name || 'Crop Information Not Available';
                    enriched.productionName = enriched.cropName;
                    enriched.cropImageUrl = crop.imageUrl;
                    cropFound = true;
                    console.log(`✅ Crop found directly: "${enriched.cropName}"`);
                }
            }

            // ✅ FARM - Méthode 4: Utiliser farmId du stage directement
            if (!farmFound && stage.farmId) {
                if (farmsMap.has(stage.farmId)) {
                    const farm = farmsMap.get(stage.farmId);
                    enriched.farmId = farm.id;
                    enriched.farmName = farm.farmName || 'Unnamed Farm';
                    farmFound = true;
                    console.log(`✅ Method 4 SUCCESS: Found farm by stage.farmId="${stage.farmId}" → "${enriched.farmName}"`);
                } else if (farmsByFarmerIdMap.has(stage.farmId)) {
                    const farmerFarms = farmsByFarmerIdMap.get(stage.farmId);
                    if (farmerFarms && farmerFarms.length > 0) {
                        const farm = farmerFarms[0];
                        enriched.farmId = farm.id;
                        enriched.farmName = farm.farmName || 'Unnamed Farm';
                        farmFound = true;
                        console.log(`✅ Method 4b SUCCESS: Found farm by stage.farmId as farmerId="${stage.farmId}" → "${enriched.farmName}"`);
                    }
                }
            }

            // ✅ FARM - Méthode 5: Prendre la première farm du farmer (dernier recours)
            if (!farmFound && farmsByFarmerIdMap.has(currentUser.id)) {
                const farmerFarms = farmsByFarmerIdMap.get(currentUser.id);
                if (farmerFarms && farmerFarms.length > 0) {
                    const farm = farmerFarms[0];
                    enriched.farmId = farm.id;
                    enriched.farmName = farm.farmName || 'Unnamed Farm';
                    farmFound = true;
                    console.log(`✅ Method 5 (FALLBACK): Using first farm of farmer → "${enriched.farmName}"`);
                }
            }

            // ✅ FINAL CHECKS
            if (!cropFound) {
                console.error(`❌ NO CROP FOUND for stage ${stage.id}`);
                console.error(`   - stage.cropProductionId: ${stage.cropProductionId}`);
                console.error(`   - stage.cropId: ${stage.cropId}`);
                enriched.cropName = 'Crop Information Not Available';
                enriched.productionName = 'Crop Information Not Available';
            }

            if (!farmFound) {
                console.error(`❌ NO FARM FOUND for stage ${stage.id}`);
                enriched.farmName = 'Farm Information Not Available';
            }

            console.log(`🐛 DEBUG - Final enriched stage:`, enriched);
            console.log(`   - cropName: ${enriched.cropName}`);
            console.log(`   - farmName: ${enriched.farmName}`);

            return enriched;
        });

        console.log('📊 Final enriched supply chains:', allSupplyChains);

        // ✅ ÉTAPE 6: Affichage
        if (allSupplyChains.length === 0) {
            displayEmptySupplyChainState();
        } else {
            displaySupplyChainData(allSupplyChains, Array.from(farmsMap.values()));
        }

        updateSupplyChainStatistics(allSupplyChains);

    } catch (error) {
        console.error('❌ Critical error in loadSupplyChainData:', error);
        showToast('Unable to load supply chain data', 'error');
        displayEmptySupplyChainState();
    } finally {
        hideLoading();
    }
}


/**
 * Display supply chain data - VERSION CORRIGÉE AVEC FARM NAME GARANTI
 */
function displaySupplyChainData(supplyChains, farms) {
    const container = document.getElementById('supplyChainContainer');
    if (!container) {
        console.error('❌ supplyChainContainer not found');
        return;
    }

    if (!supplyChains || supplyChains.length === 0) {
        displayEmptySupplyChainState();
        return;
    }

    console.log(`📊 Displaying ${supplyChains.length} supply chain records`);

    // ✅ GROUPER PAR CROP PRODUCTION ID
    const groupedByProduction = {};

    supplyChains.forEach(stage => {
        const key = stage.cropProductionId || 'unknown';

        if (!groupedByProduction[key]) {
            groupedByProduction[key] = {
                productionId: key,
                productionName: stage.productionName || stage.cropName || 'Unknown Production',
                farmName: stage.farmName || 'Farm Name Not Available',
                farmId: stage.farmId || null,
                stages: []
            };
        }

        groupedByProduction[key].stages.push(stage);
    });

    console.log('📦 Grouped productions:', groupedByProduction);

    // ✅ TRIER LES STAGES PAR ORDRE
    Object.values(groupedByProduction).forEach(production => {
        production.stages.sort((a, b) =>
            (a.stageOrder || 0) - (b.stageOrder || 0)
        );
    });

    // ✅ GÉNÉRER LE HTML
    let html = '';

    Object.values(groupedByProduction).forEach(production => {
        const completedStages = production.stages.filter(s => s.stageEndDate).length;
        const totalStages = production.stages.length;
        const progressPercent = totalStages > 0 ? (completedStages / totalStages) * 100 : 0;

        // ✅ GARANTIR QU'ON A UN NOM DE FARM
        const displayFarmName = production.farmName || 'Farm Name Not Available';
        const displayProductionName = production.productionName || 'Production';

        console.log(`🌾 Rendering: Farm="${displayFarmName}", Production="${displayProductionName}"`);

        html += `
            <div class="supply-chain-group" style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px; overflow: hidden;">
                <div class="supply-chain-group-header" style="padding: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                    <div class="supply-chain-group-info">
                        <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-tractor" style="font-size: 24px;"></i>
                            ${escapeHtml(displayFarmName)}
                        </h3>
                        <p class="supply-chain-production-id" style="margin: 0; opacity: 0.9; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-seedling"></i>
                            <strong>Production:</strong> ${escapeHtml(displayProductionName)}
                            ${production.productionId !== 'unknown' ? `<span style="opacity: 0.7;">(ID: ${production.productionId})</span>` : ''}
                        </p>
                    </div>
                    <div class="supply-chain-group-progress" style="margin-top: 16px;">
                        <div class="progress-info" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 14px;">${completedStages}/${totalStages} stages completed</span>
                            <span class="progress-percent" style="font-size: 18px; font-weight: 700;">${progressPercent.toFixed(0)}%</span>
                        </div>
                        <div class="progress-bar" style="width: 100%; height: 8px; background: rgba(255,255,255,0.3); border-radius: 10px; overflow: hidden;">
                            <div class="progress-fill" style="width: ${progressPercent}%; height: 100%; background: white; border-radius: 10px; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>

                <div class="supply-chain-timeline" style="padding: 20px;">
                    ${production.stages.map((stage, index) => {
                        const isCompleted = stage.stageEndDate ? true : false;
                        const isActive = !isCompleted && index === completedStages;
                        const stageName = stage.stage || 'UNKNOWN';
                        const stageIcon = getStageIcon(stageName);

                        return `
                        <div class="timeline-stage ${isCompleted ? 'completed' : isActive ? 'active' : 'pending'}" style="position: relative; padding-left: 60px; margin-bottom: 30px;">
                            ${index < production.stages.length - 1 ? `
                            <div class="timeline-connector" style="position: absolute; left: 24px; top: 50px; width: 2px; height: calc(100% + 30px); background: ${isCompleted ? '#10b981' : '#e5e7eb'};"></div>
                            ` : ''}

                            <div class="timeline-marker" style="position: absolute; left: 0; top: 0; width: 48px; height: 48px; border-radius: 50%; background: ${isCompleted ? '#10b981' : isActive ? '#f59e0b' : '#e5e7eb'}; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 2;">
                                <i class="fas ${stageIcon}"></i>
                                ${isCompleted ? '<i class="fas fa-check" style="position: absolute; bottom: -4px; right: -4px; background: white; color: #10b981; font-size: 14px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center;"></i>' : ''}
                            </div>

                            <div class="timeline-content" style="background: #f9fafb; border-radius: 8px; padding: 16px; border-left: 3px solid ${isCompleted ? '#10b981' : isActive ? '#f59e0b' : '#e5e7eb'};">
                                <div class="timeline-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h4 class="stage-name" style="margin: 0; font-size: 16px; font-weight: 700; color: #1f2937;">
                                        ${escapeHtml(stageName.replace('_', ' '))}
                                    </h4>
                                    <span class="stage-badge ${isCompleted ? 'badge-success' : isActive ? 'badge-warning' : 'badge-secondary'}" style="padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; background: ${isCompleted ? '#d1fae5' : isActive ? '#fef3c7' : '#f3f4f6'}; color: ${isCompleted ? '#065f46' : isActive ? '#92400e' : '#6b7280'};">
                                        ${isCompleted ? '✓ Completed' : isActive ? '⏳ In Progress' : '⏸ Pending'}
                                    </span>
                                </div>

                                <div class="timeline-details" style="display: grid; gap: 8px;">
                                    ${stage.location ? `
                                        <div class="detail-row" style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #4b5563;">
                                            <i class="fas fa-map-marker-alt" style="color: #ef4444; width: 16px;"></i>
                                            <span><strong>Location:</strong> ${escapeHtml(stage.location)}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.facilityName ? `
                                        <div class="detail-row" style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #4b5563;">
                                            <i class="fas fa-building" style="color: #3b82f6; width: 16px;"></i>
                                            <span><strong>Facility:</strong> ${escapeHtml(stage.facilityName)}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.responsibleParty ? `
                                        <div class="detail-row" style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #4b5563;">
                                            <i class="fas fa-user" style="color: #8b5cf6; width: 16px;"></i>
                                            <span><strong>Handler:</strong> ${escapeHtml(stage.responsibleParty)}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.quantityIn ? `
                                        <div class="detail-row" style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #4b5563;">
                                            <i class="fas fa-box" style="color: #10b981; width: 16px;"></i>
                                            <span><strong>Quantity In:</strong> ${stage.quantityIn} ${stage.unit || 'KG'}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.quantityOut ? `
                                        <div class="detail-row" style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #4b5563;">
                                            <i class="fas fa-shipping-fast" style="color: #f59e0b; width: 16px;"></i>
                                            <span><strong>Quantity Out:</strong> ${stage.quantityOut} ${stage.unit || 'KG'}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.qualityStatus ? `
                                        <div class="detail-row" style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #4b5563;">
                                            <i class="fas fa-star" style="color: #fbbf24; width: 16px;"></i>
                                            <span><strong>Quality:</strong> ${escapeHtml(stage.qualityStatus)}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.stageStartDate ? `
                                        <div class="detail-row" style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #4b5563;">
                                            <i class="fas fa-calendar-plus" style="color: #3b82f6; width: 16px;"></i>
                                            <span><strong>Started:</strong> ${formatDateTime(stage.stageStartDate)}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.stageEndDate ? `
                                        <div class="detail-row success" style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #059669; font-weight: 600;">
                                            <i class="fas fa-calendar-check" style="width: 16px;"></i>
                                            <span><strong>Completed:</strong> ${formatDateTime(stage.stageEndDate)}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.lossQuantity && parseFloat(stage.lossQuantity) > 0 ? `
                                        <div class="detail-row alert" style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #dc2626; background: #fee2e2; padding: 8px; border-radius: 4px; margin-top: 8px;">
                                            <i class="fas fa-exclamation-triangle" style="width: 16px;"></i>
                                            <span><strong>Loss:</strong> ${stage.lossQuantity} ${stage.unit || 'KG'}
                                                ${stage.lossPercentage ? `(${stage.lossPercentage}%)` : ''}
                                            </span>
                                        </div>
                                        ${stage.lossReason ? `
                                            <div class="detail-row" style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #4b5563; padding-left: 24px;">
                                                <i class="fas fa-info-circle" style="color: #ef4444; width: 16px;"></i>
                                                <span><strong>Reason:</strong> ${escapeHtml(stage.lossReason)}</span>
                                            </div>
                                        ` : ''}
                                    ` : ''}

                                    ${stage.trackingCode ? `
                                        <div class="detail-row" style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #4b5563;">
                                            <i class="fas fa-barcode" style="color: #6b7280; width: 16px;"></i>
                                            <span><strong>Tracking:</strong> ${escapeHtml(stage.trackingCode)}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.notes ? `
                                        <div class="detail-row" style="display: flex; align-items: flex-start; gap: 8px; font-size: 13px; color: #4b5563; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                            <i class="fas fa-sticky-note" style="color: #fbbf24; width: 16px; margin-top: 2px;"></i>
                                            <span><strong>Notes:</strong> ${escapeHtml(stage.notes)}</span>
                                        </div>
                                    ` : ''}
                                </div>

                                <div class="timeline-actions" style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <button class="btn-icon" onclick="viewSupplyChainDetails('${stage.id}')" title="View Details" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #d1d5db; background: white; color: #6b7280; cursor: pointer; transition: all 0.2s;">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${isActive ? `
                                        <button class="btn-icon btn-primary" onclick="editSupplyChainStage('${stage.id}')" title="Edit" style="padding: 8px 12px; border-radius: 6px; border: none; background: #3b82f6; color: white; cursor: pointer; transition: all 0.2s;">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-icon btn-success" onclick="completeStage('${stage.id}')" title="Complete" style="padding: 8px 12px; border-radius: 6px; border: none; background: #10b981; color: white; cursor: pointer; transition: all 0.2s;">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('')}
                </div>
            </div>
        `;
    });

    container.innerHTML = html || `
        <div class="empty-state" style="text-align: center; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f59e0b; margin-bottom: 16px;"></i>
            <p style="color: #6b7280;">Unable to display supply chain data</p>
        </div>
    `;

    console.log('✅ Supply chain data displayed successfully');
}










/**
 * Display empty supply chain state - VERSION CORRIGÉE
 */
function displayEmptySupplyChainState() {
    const container = document.getElementById('supplyChainContainer');
    if (!container) return;

    container.innerHTML = `
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-link"></i>
            </div>
            <h3>No Supply Chain Data Available</h3>
            <p>Start tracking your product journey from harvest to market.</p>
            <div class="empty-state-hint">
                <i class="fas fa-info-circle"></i>
                Create your first supply chain stage to begin tracking
            </div>
            <div class="empty-state-actions" style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="openAddSupplyChainModal()">
                    <i class="fas fa-plus"></i>
                    Start Tracking Supply Chain
                </button>
                <button class="btn btn-secondary" onclick="showSupplyChainTutorial()">
                    <i class="fas fa-play-circle"></i>
                    Watch Tutorial
                </button>
            </div>
        </div>
    `;

    // Réinitialiser les statistiques
    updateSupplyChainStatistics([]);
}


/**
 * Open modal to add new supply chain stage - FONCTION COMPLÈTE
 */
async function openAddSupplyChainModal() {
    try {
        showLoading();

        // Récupérer les fermes de l'utilisateur
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

        if (farms.length === 0) {
            showToast('❌ You need to create a farm first before tracking supply chain', 'error');
            hideLoading();
            return;
        }

        // Récupérer les productions disponibles
        let productions = [];
        try {
            const productionsResponse = await apiRequest(`/v1/crop-productions/farmer/${currentUser.id}`);

            // Gestion multi-format de la réponse
            if (Array.isArray(productionsResponse)) {
                productions = productionsResponse;
            } else if (productionsResponse && productionsResponse.data) {
                productions = Array.isArray(productionsResponse.data) ? productionsResponse.data : [];
            } else if (productionsResponse && productionsResponse.content) {
                productions = Array.isArray(productionsResponse.content) ? productionsResponse.content : [];
            }

            // Filtrer les productions valides
            productions = productions.filter(p => p && p.id && p.cropName);

        } catch (error) {
            console.warn('⚠️ Error loading productions:', error.message);
            productions = [];
        }

        const modalHTML = `
            <div class="modal-overlay show" id="supplyChainModal" onclick="if(event.target === this) closeSupplyChainModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-plus-circle"></i>
                            Start Supply Chain Tracking
                        </h3>
                        <button class="modal-close" onclick="closeSupplyChainModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form id="addSupplyChainForm" onsubmit="handleAddSupplyChain(event)">
                        <div class="modal-body">
                            <div class="form-grid">
                                <!-- Farm Selection -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-tractor"></i>
                                        Select Farm *
                                    </label>
                                    <select name="farmId" class="form-select" required>
                                        <option value="">-- Select Farm --</option>
                                        ${farms.map(farm =>
                                            `<option value="${farm.id}">${farm.farmName}</option>`
                                        ).join('')}
                                    </select>
                                </div>

                                <!-- Crop Production Selection -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-seedling"></i>
                                        Select Crop Production *
                                    </label>
                                    ${productions.length === 0 ? `
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            No crop productions available. Please create a crop production first.
                                        </div>
                                    ` : ''}
                                    <select name="cropProductionId" class="form-select" ${productions.length === 0 ? 'disabled' : 'required'}>
                                        <option value="">-- Select Production --</option>
                                        ${productions.map(prod =>
                                            `<option value="${prod.id}">
                                                ${prod.cropName} - ${prod.season || ''} ${prod.year || ''}
                                            </option>`
                                        ).join('')}
                                    </select>
                                </div>

                                <!-- Stage Information -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-layer-group"></i>
                                        Supply Chain Stage *
                                    </label>
                                    <select name="stage" class="form-select" required>
                                        <option value="">-- Select Stage --</option>
                                        <option value="HARVEST">🌾 Harvest</option>
                                        <option value="COLLECTION">📦 Collection</option>
                                        <option value="STORAGE">🏪 Storage</option>
                                        <option value="PROCESSING">🏭 Processing</option>
                                        <option value="PACKAGING">📦 Packaging</option>
                                        <option value="TRANSPORT">🚚 Transport</option>
                                        <option value="DISTRIBUTION">🚛 Distribution</option>
                                        <option value="RETAIL">🏪 Retail</option>
                                        <option value="QUALITY_CHECK">✅ Quality Check</option>
                                    </select>
                                </div>

                                <!-- Stage Order -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-sort-numeric-down"></i>
                                        Stage Order *
                                    </label>
                                    <input type="number" name="stageOrder" class="form-input"
                                           min="1" max="10" value="1" required>
                                    <small class="form-hint">The sequence order of this stage (1 = first stage)</small>
                                </div>

                                <!-- Location -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Location *
                                    </label>
                                    <input type="text" name="location" class="form-input"
                                           placeholder="e.g., Farm Warehouse, Processing Facility" required>
                                </div>

                                <!-- Facility Name -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-building"></i>
                                        Facility Name
                                    </label>
                                    <input type="text" name="facilityName" class="form-input"
                                           placeholder="e.g., Main Storage Facility">
                                </div>

                                <!-- Responsible Party -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-user-tie"></i>
                                        Responsible Party *
                                    </label>
                                    <input type="text" name="responsibleParty" class="form-input"
                                           placeholder="e.g., John Doe, Logistics Team" required>
                                </div>

                                <!-- Quantity Information -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-balance-scale"></i>
                                        Quantity In (KG) *
                                    </label>
                                    <input type="number" name="quantityIn" class="form-input"
                                           step="0.01" min="0.01" placeholder="e.g., 1000.50" required>
                                </div>

                                <!-- Unit -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-ruler"></i>
                                        Unit *
                                    </label>
                                    <select name="unit" class="form-select" required>
                                        <option value="KG">Kilograms (KG)</option>
                                        <option value="TONNES">Tonnes</option>
                                        <option value="BAGS">Bags</option>
                                        <option value="CRATES">Crates</option>
                                    </select>
                                </div>

<!-- Production Code - READ ONLY (Auto-generated) -->
<div class="form-group">
  <label class="form-label">
    <i class="fas fa-barcode"></i>
    Production Code
    <span class="text-muted">(Auto-generated)</span>
  </label>
  <input
    type="text"
    class="form-input"
    name="productionCode"
    value="Auto-generated after submission"
    readonly
    style="background-color: #f0f0f0; cursor: not-allowed;"
  >
  <small class="form-help-text">
    <i class="fas fa-info-circle"></i>
    This code will be automatically generated when you submit the form
  </small>
</div>





                                <!-- Stage Start Date -->
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="fas fa-calendar-plus"></i>
                                        Stage Start Date *
                                    </label>
                                    <input type="datetime-local" name="stageStartDate" class="form-input"
                                           value="${new Date().toISOString().slice(0, 16)}" required>
                                </div>

                                <!-- Expected Duration -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-clock"></i>
                                        Expected Duration (days)
                                    </label>
                                    <input type="number" name="expectedDurationDays" class="form-input"
                                           min="1" max="365" placeholder="e.g., 7">
                                </div>

                                <!-- Quality Status -->
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-star"></i>
                                        Initial Quality Status
                                    </label>
                                    <select name="qualityStatus" class="form-select">
                                        <option value="EXCELLENT">⭐ Excellent</option>
                                        <option value="GOOD">👍 Good</option>
                                        <option value="FAIR">👌 Fair</option>
                                        <option value="POOR">👎 Poor</option>
                                        <option value="REJECTED">❌ Rejected</option>
                                    </select>
                                </div>

                                <!-- Notes -->
                                <div class="form-group full-width">
                                    <label class="form-label">
                                        <i class="fas fa-sticky-note"></i>
                                        Additional Notes
                                    </label>
                                    <textarea name="notes" class="form-input" rows="3"
                                              placeholder="Any additional information about this stage..."></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeSupplyChainModal()">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-primary" ${productions.length === 0 ? 'disabled' : ''}>
                                <i class="fas fa-save"></i>
                                Start Tracking
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

    } catch (error) {
        console.error('Error opening supply chain modal:', error);
        showToast('❌ Error loading form: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Handle add supply chain form submission
 */
async function handleAddSupplyChain(event) {
    event.preventDefault();

    try {
        showLoading();

        const formData = new FormData(event.target);

        // Préparer les données
        const supplyChainData = {
            farmId: formData.get('farmId'),
            cropProductionId: formData.get('cropProductionId'),
            stage: formData.get('stage'),
            stageOrder: parseInt(formData.get('stageOrder')),
            location: formData.get('location'),
            facilityName: formData.get('facilityName') || null,
            responsibleParty: formData.get('responsibleParty'),
            quantityIn: parseFloat(formData.get('quantityIn')),
            unit: formData.get('unit'),
            trackingCode: formData.get('trackingCode')?.trim() || null,
            stageStartDate: formData.get('stageStartDate') + ':00', // Ajouter les secondes
            expectedDurationDays: formData.get('expectedDurationDays') ?
                parseInt(formData.get('expectedDurationDays')) : null,
            qualityStatus: formData.get('qualityStatus') || 'GOOD',
            notes: formData.get('notes')?.trim() || null
        };

        console.log('📤 Creating supply chain stage:', supplyChainData);

        // Validation supplémentaire
        if (!supplyChainData.cropProductionId) {
            showToast('❌ Please select a crop production', 'error');
            return;
        }

        if (supplyChainData.quantityIn <= 0) {
            showToast('❌ Quantity must be greater than 0', 'error');
            return;
        }

        // Appel API pour créer la supply chain
        const response = await apiRequest('/supply-chain', {
            method: 'POST',
            body: JSON.stringify(supplyChainData)
        });

        console.log('✅ Supply chain created:', response);

        showToast('✅ Supply chain tracking started successfully!', 'success');
        closeSupplyChainModal();

        // Recharger les données
        setTimeout(async () => {
            await loadSupplyChainData();
        }, 500);

    } catch (error) {
        console.error('❌ Error creating supply chain:', error);

        let errorMessage = 'Error creating supply chain stage';
        if (error.message.includes('400')) {
            errorMessage = 'Invalid data. Please check all required fields.';
        } else if (error.message.includes('500')) {
            errorMessage = 'Server error. Please try again.';
        } else {
            errorMessage = error.message || errorMessage;
        }

        showToast(`❌ ${errorMessage}`, 'error');
    } finally {
        hideLoading();
    }
}


/**
 * Show supply chain tutorial
 */
function showSupplyChainTutorial() {
    const modalHTML = `
        <div class="modal-overlay show" id="tutorialModal" onclick="if(event.target === this) closeTutorialModal()">
            <div class="modal-container">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-graduation-cap"></i>
                        Supply Chain Tracking Tutorial
                    </h3>
                    <button class="modal-close" onclick="closeTutorialModal()" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="tutorial-content">
                        <h4>📋 How to Track Your Supply Chain</h4>

                        <div class="tutorial-step">
                            <h5>Step 1: Create Crop Production</h5>
                            <p>First, you need to create a crop production record in the "Production" section.</p>
                        </div>

                        <div class="tutorial-step">
                            <h5>Step 2: Start Supply Chain Tracking</h5>
                            <p>Click "Start Tracking Supply Chain" and select your farm and crop production.</p>
                        </div>

                        <div class="tutorial-step">
                            <h5>Step 3: Choose the Stage</h5>
                            <p>Select the current stage of your product (Harvest, Storage, Transport, etc.)</p>
                        </div>

                        <div class="tutorial-step">
                            <h5>Step 4: Enter Details</h5>
                            <p>Provide location, quantity, responsible party, and other important information.</p>
                        </div>

                        <div class="tutorial-step">
                            <h5>Step 5: Track Progress</h5>
                            <p>As your product moves through the supply chain, update each stage with completion details.</p>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-lightbulb"></i>
                            <strong>Tip:</strong> You can track multiple stages for the same production to see the complete journey from farm to market.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="closeTutorialModal(); openAddSupplyChainModal()">
                        <i class="fas fa-play"></i>
                        Start Tracking Now
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeTutorialModal()">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close tutorial modal
 */
function closeTutorialModal() {
    const modal = document.getElementById('tutorialModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}




/**
 * Update supply chain statistics
 */
function updateSupplyChainStatistics(supplyChains) {
    const statsContainer = document.getElementById('supplyChainStats');
    if (!statsContainer) return;

    const totalStages = supplyChains.length;
    const completedStages = supplyChains.filter(s => s.stageEndDate).length;
    const activeStages = supplyChains.filter(s =>
        !s.stageEndDate && s.stageStartDate
    ).length;
    const pendingStages = totalStages - completedStages - activeStages;

    const totalLoss = supplyChains.reduce((sum, s) =>
        sum + (parseFloat(s.lossQuantity) || 0), 0
    );

    const avgLossPercentage = supplyChains.length > 0
        ? (supplyChains.reduce((sum, s) =>
            sum + (parseFloat(s.lossPercentage) || 0), 0) / supplyChains.length).toFixed(2)
        : 0;

    const statsHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="fas fa-link"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Total Stages</span>
                    <span class="stat-value">${totalStages}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Completed</span>
                    <span class="stat-value">${completedStages}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon warning">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Active</span>
                    <span class="stat-value">${activeStages}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon secondary">
                    <i class="fas fa-hourglass-half"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Pending</span>
                    <span class="stat-value">${pendingStages}</span>
                </div>
            </div>

            ${totalLoss > 0 ? `
            <div class="stat-card">
                <div class="stat-icon danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Total Loss</span>
                    <span class="stat-value">${totalLoss.toFixed(2)} KG</span>
                    <small>${avgLossPercentage}% avg</small>
                </div>
            </div>
            ` : ''}
        </div>
    `;

    statsContainer.innerHTML = statsHTML;
}

/**
 * Get stage icon
 */
function getStageIcon(stage) {
    const icons = {
        'HARVEST': 'fa-seedling',
        'COLLECTION': 'fa-hand-holding',
        'STORAGE': 'fa-warehouse',
        'PROCESSING': 'fa-industry',
        'PACKAGING': 'fa-box',
        'TRANSPORT': 'fa-truck',
        'DISTRIBUTION': 'fa-shipping-fast',
        'RETAIL': 'fa-store',
        'QUALITY_CHECK': 'fa-clipboard-check',
        'LOADING': 'fa-dolly',
        'UNLOADING': 'fa-box-open'
    };
    return icons[stage] || 'fa-circle';
}

// ============================================================================
// WEATHER DATA MODULE - COMPLETE IMPLEMENTATION
// ============================================================================

/**
 * Load weather data for all farmer's farms
 */
async function loadWeatherData() {
    try {
        showLoading();
        console.log('🌤️ Starting weather data load...');

        if (!currentUser || !currentUser.id) {
            console.error('❌ No current user found');
            displayEmptyWeatherState('No user session found. Please login again.');
            hideLoading();
            return;
        }

        console.log('🌤️ Loading weather data for farmer:', currentUser.id);

        // ✅ STEP 1: Try to get recent weather data first (most reliable)
        let allWeatherData = [];
        try {
            console.log('🔄 Fetching recent weather data...');
            const recentResponse = await apiRequest(`/weather-data/recent?days=30`);
            
            if (Array.isArray(recentResponse)) {
                allWeatherData = recentResponse;
                console.log(`✅ Loaded ${allWeatherData.length} recent weather records`);
            } else if (recentResponse && recentResponse.data && Array.isArray(recentResponse.data)) {
                allWeatherData = recentResponse.data;
                console.log(`✅ Loaded ${allWeatherData.length} recent weather records (from data field)`);
            } else if (recentResponse && recentResponse.content && Array.isArray(recentResponse.content)) {
                allWeatherData = recentResponse.content;
                console.log(`✅ Loaded ${allWeatherData.length} recent weather records (from content field)`);
            } else {
                console.warn('⚠️ Unexpected response format:', recentResponse);
            }
        } catch (error) {
            console.error('❌ Error loading recent weather data:', error);
            console.error('Error details:', error.message, error.stack);
        }

        // ✅ STEP 2: Get all farms for the farmer
        let farms = [];
        try {
            console.log('🔄 Fetching farms...');
            const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
            farms = Array.isArray(farmsResponse) ? farmsResponse : [];
            console.log(`✅ Loaded ${farms.length} farms`);
        } catch (error) {
            console.warn('⚠️ Error loading farms:', error.message);
            farms = [];
        }

        // ✅ STEP 3: If we have farms with coordinates, try to get location-specific data
        const weatherDataByFarm = [];
        
        if (farms.length > 0 && allWeatherData.length === 0) {
            console.log('🔄 Trying to get location-specific weather data...');
            
            for (const farm of farms) {
                if (!farm.latitude || !farm.longitude) {
                    console.warn(`⚠️ Farm ${farm.id} missing coordinates`);
                    continue;
                }

                try {
                    // Try location/radius endpoint
                    const weatherResponse = await apiRequest(
                        `/weather-data/location/radius?latitude=${farm.latitude}&longitude=${farm.longitude}&radius=1.0`
                    );

                    let locationWeather = [];
                    if (Array.isArray(weatherResponse)) {
                        locationWeather = weatherResponse;
                    } else if (weatherResponse && weatherResponse.data && Array.isArray(weatherResponse.data)) {
                        locationWeather = weatherResponse.data;
                    }

                    if (locationWeather.length > 0) {
                        const latestWeather = locationWeather.sort((a, b) => 
                            new Date(b.recordDate || b.createdAt || 0) - new Date(a.recordDate || a.createdAt || 0)
                        )[0];

                        weatherDataByFarm.push({
                            farm: farm,
                            latestWeather: latestWeather,
                            allWeather: locationWeather
                        });

                        allWeatherData.push(...locationWeather);
                        console.log(`✅ Found ${locationWeather.length} weather records for farm ${farm.farmName || farm.id}`);
                    }
                } catch (error) {
                    console.warn(`⚠️ Error loading weather for farm ${farm.id}:`, error.message);
                }
            }
        }

        // ✅ STEP 4: If we have general weather data but no farm-specific data, assign to farms
        if (allWeatherData.length > 0 && weatherDataByFarm.length === 0 && farms.length > 0) {
            console.log('🔄 Assigning general weather data to farms...');
            
            // Sort weather data by date (most recent first)
            const sortedWeather = allWeatherData.sort((a, b) => 
                new Date(b.recordDate || b.createdAt || 0) - new Date(a.recordDate || a.createdAt || 0)
            );

            // Assign the most recent weather to each farm
            farms.forEach(farm => {
                if (sortedWeather.length > 0) {
                    weatherDataByFarm.push({
                        farm: farm,
                        latestWeather: sortedWeather[0],
                        allWeather: sortedWeather.slice(0, 7) // Last 7 records
                    });
                }
            });
        }

        console.log(`✅ Total weather records: ${allWeatherData.length}`);
        console.log(`✅ Weather data for farms: ${weatherDataByFarm.length}`);

        // ✅ STEP 5: Display weather data
        if (weatherDataByFarm.length === 0 && allWeatherData.length === 0) {
            console.warn('⚠️ No weather data available');
            displayEmptyWeatherState('No weather data found in the database. Weather data will appear here once available.');
        } else if (weatherDataByFarm.length === 0 && allWeatherData.length > 0) {
            // We have data but no farms, show general weather
            displayGeneralWeatherData(allWeatherData);
        } else {
            displayWeatherData(weatherDataByFarm, allWeatherData);
        }

        // ✅ STEP 6: Update statistics
        updateWeatherStatistics(allWeatherData);

        // ✅ STEP 7: Load and display charts
        if (allWeatherData.length > 0) {
            displayWeatherCharts(allWeatherData);
        }

        // ✅ STEP 8: Analyze and display risks
        analyzeWeatherRisks(allWeatherData, farms);

        // ✅ STEP 9: Display agricultural impact
        displayAgriculturalImpact(allWeatherData, farms);

        if (allWeatherData.length > 0) {
            showToast(`✅ Loaded ${allWeatherData.length} weather records`, 'success');
        }

    } catch (error) {
        console.error('❌ Error loading weather data:', error);
        console.error('Error stack:', error.stack);
        showToast('Unable to load weather data: ' + error.message, 'error');
        displayEmptyWeatherState('Error loading weather data. Please check your connection and try again.');
    } finally {
        hideLoading();
    }
}

/**
 * Display general weather data when no farms are available
 */
function displayGeneralWeatherData(allWeatherData) {
    const container = document.getElementById('weatherFarmsGrid');
    if (!container) {
        console.error('❌ weatherFarmsGrid not found');
        return;
    }

    if (!allWeatherData || allWeatherData.length === 0) {
        displayEmptyWeatherState();
        return;
    }

    // Get the most recent weather data
    const latestWeather = allWeatherData.sort((a, b) => 
        new Date(b.recordDate || b.createdAt || 0) - new Date(a.recordDate || a.createdAt || 0)
    )[0];

    const temp = latestWeather.temperature ? parseFloat(latestWeather.temperature).toFixed(1) : '--';
    const humidity = latestWeather.humidity ? parseFloat(latestWeather.humidity).toFixed(1) : '--';
    const rainfall = latestWeather.rainfall ? parseFloat(latestWeather.rainfall).toFixed(2) : '--';
    const windSpeed = latestWeather.windSpeed ? parseFloat(latestWeather.windSpeed).toFixed(1) : '--';
    const pressure = latestWeather.atmosphericPressure ? parseFloat(latestWeather.atmosphericPressure).toFixed(0) : '--';
    const uvIndex = latestWeather.uvIndex || '--';
    const condition = latestWeather.weatherCondition || 'Unknown';
    const recordDate = latestWeather.recordDate ? formatDateTime(latestWeather.recordDate) : 'N/A';
    const location = latestWeather.latitude && latestWeather.longitude 
        ? `${latestWeather.latitude}°N, ${latestWeather.longitude}°E`
        : 'General Location';

    const weatherIcon = getWeatherIcon(condition, temp);

    container.innerHTML = `
        <div class="weather-farm-card" style="grid-column: 1 / -1;">
            <div class="weather-farm-header">
                <div class="weather-farm-info">
                    <h3>
                        <i class="fas fa-map-marker-alt"></i>
                        General Weather Data
                    </h3>
                    <p class="weather-farm-location">
                        ${location}
                    </p>
                </div>
                <div class="weather-farm-icon">
                    ${weatherIcon}
                </div>
            </div>

            <div class="weather-farm-main">
                <div class="weather-temp-display">
                    <span class="weather-temp-value">${temp}°C</span>
                    <span class="weather-condition">${condition}</span>
                </div>
                <div class="weather-update-time">
                    <i class="fas fa-clock"></i>
                    Last update: ${recordDate}
                </div>
            </div>

            <div class="weather-farm-details">
                <div class="weather-detail-item">
                    <div class="weather-detail-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="weather-detail-info">
                        <span class="weather-detail-label">Humidity</span>
                        <span class="weather-detail-value">${humidity}%</span>
                    </div>
                </div>

                <div class="weather-detail-item">
                    <div class="weather-detail-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green);">
                        <i class="fas fa-cloud-rain"></i>
                    </div>
                    <div class="weather-detail-info">
                        <span class="weather-detail-label">Rainfall</span>
                        <span class="weather-detail-value">${rainfall} mm</span>
                    </div>
                </div>

                <div class="weather-detail-item">
                    <div class="weather-detail-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                        <i class="fas fa-wind"></i>
                    </div>
                    <div class="weather-detail-info">
                        <span class="weather-detail-label">Wind Speed</span>
                        <span class="weather-detail-value">${windSpeed} km/h</span>
                    </div>
                </div>

                <div class="weather-detail-item">
                    <div class="weather-detail-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                        <i class="fas fa-compress-arrows-alt"></i>
                    </div>
                    <div class="weather-detail-info">
                        <span class="weather-detail-label">Pressure</span>
                        <span class="weather-detail-value">${pressure} hPa</span>
                    </div>
                </div>

                ${uvIndex !== '--' ? `
                <div class="weather-detail-item">
                    <div class="weather-detail-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        <i class="fas fa-sun"></i>
                    </div>
                    <div class="weather-detail-info">
                        <span class="weather-detail-label">UV Index</span>
                        <span class="weather-detail-value">${uvIndex}</span>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

/**
 * Display weather data for all farms
 */
function displayWeatherData(weatherDataByFarm, allWeatherData) {
    const container = document.getElementById('weatherFarmsGrid');
    if (!container) {
        console.error('❌ weatherFarmsGrid not found');
        return;
    }

    if (!weatherDataByFarm || weatherDataByFarm.length === 0) {
        displayEmptyWeatherState();
        return;
    }

    container.innerHTML = weatherDataByFarm.map(({ farm, latestWeather }) => {
        const temp = latestWeather.temperature ? parseFloat(latestWeather.temperature).toFixed(1) : '--';
        const humidity = latestWeather.humidity ? parseFloat(latestWeather.humidity).toFixed(1) : '--';
        const rainfall = latestWeather.rainfall ? parseFloat(latestWeather.rainfall).toFixed(2) : '--';
        const windSpeed = latestWeather.windSpeed ? parseFloat(latestWeather.windSpeed).toFixed(1) : '--';
        const pressure = latestWeather.atmosphericPressure ? parseFloat(latestWeather.atmosphericPressure).toFixed(0) : '--';
        const uvIndex = latestWeather.uvIndex || '--';
        const condition = latestWeather.weatherCondition || 'Unknown';
        const recordDate = latestWeather.recordDate ? formatDateTime(latestWeather.recordDate) : 'N/A';

        // Get weather icon based on condition
        const weatherIcon = getWeatherIcon(condition, temp);

        return `
            <div class="weather-farm-card">
                <div class="weather-farm-header">
                    <div class="weather-farm-info">
                        <h3>
                            <i class="fas fa-map-marker-alt"></i>
                            ${escapeHtml(farm.farmName || 'Unknown Farm')}
                        </h3>
                        <p class="weather-farm-location">
                            ${farm.latitude}°N, ${farm.longitude}°E
                        </p>
                    </div>
                    <div class="weather-farm-icon">
                        ${weatherIcon}
                    </div>
                </div>

                <div class="weather-farm-main">
                    <div class="weather-temp-display">
                        <span class="weather-temp-value">${temp}°C</span>
                        <span class="weather-condition">${condition}</span>
                    </div>
                    <div class="weather-update-time">
                        <i class="fas fa-clock"></i>
                        Last update: ${recordDate}
                    </div>
                </div>

                <div class="weather-farm-details">
                    <div class="weather-detail-item">
                        <div class="weather-detail-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="weather-detail-info">
                            <span class="weather-detail-label">Humidity</span>
                            <span class="weather-detail-value">${humidity}%</span>
                        </div>
                    </div>

                    <div class="weather-detail-item">
                        <div class="weather-detail-icon" style="background: rgba(34, 197, 94, 0.1); color: var(--primary-green);">
                            <i class="fas fa-cloud-rain"></i>
                        </div>
                        <div class="weather-detail-info">
                            <span class="weather-detail-label">Rainfall</span>
                            <span class="weather-detail-value">${rainfall} mm</span>
                        </div>
                    </div>

                    <div class="weather-detail-item">
                        <div class="weather-detail-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                            <i class="fas fa-wind"></i>
                        </div>
                        <div class="weather-detail-info">
                            <span class="weather-detail-label">Wind Speed</span>
                            <span class="weather-detail-value">${windSpeed} km/h</span>
                        </div>
                    </div>

                    <div class="weather-detail-item">
                        <div class="weather-detail-icon" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">
                            <i class="fas fa-compress-arrows-alt"></i>
                        </div>
                        <div class="weather-detail-info">
                            <span class="weather-detail-label">Pressure</span>
                            <span class="weather-detail-value">${pressure} hPa</span>
                        </div>
                    </div>

                    ${uvIndex !== '--' ? `
                    <div class="weather-detail-item">
                        <div class="weather-detail-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                            <i class="fas fa-sun"></i>
                        </div>
                        <div class="weather-detail-info">
                            <span class="weather-detail-label">UV Index</span>
                            <span class="weather-detail-value">${uvIndex}</span>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

/**
 * Update weather statistics
 */
function updateWeatherStatistics(allWeatherData) {
    if (!allWeatherData || allWeatherData.length === 0) {
        updateElement('weatherAvgTemp', '--°C');
        updateElement('weatherTotalRainfall', '-- mm');
        updateElement('weatherAvgHumidity', '--%');
        updateElement('weatherRiskCount', '0');
        return;
    }

    // Calculate average temperature
    const temps = allWeatherData
        .map(w => parseFloat(w.temperature))
        .filter(t => !isNaN(t));
    const avgTemp = temps.length > 0 
        ? (temps.reduce((a, b) => a + b, 0) / temps.length).toFixed(1)
        : '--';

    // Calculate total rainfall (last 7 days)
    const recentData = allWeatherData.filter(w => {
        const date = new Date(w.recordDate || w.createdAt || 0);
        const daysAgo = (Date.now() - date.getTime()) / (1000 * 60 * 60 * 24);
        return daysAgo <= 7;
    });
    const totalRainfall = recentData
        .map(w => parseFloat(w.rainfall || 0))
        .filter(r => !isNaN(r))
        .reduce((a, b) => a + b, 0)
        .toFixed(2);

    // Calculate average humidity
    const humidities = allWeatherData
        .map(w => parseFloat(w.humidity))
        .filter(h => !isNaN(h));
    const avgHumidity = humidities.length > 0
        ? (humidities.reduce((a, b) => a + b, 0) / humidities.length).toFixed(1)
        : '--';

    updateElement('weatherAvgTemp', `${avgTemp}°C`);
    updateElement('weatherTotalRainfall', `${totalRainfall} mm`);
    updateElement('weatherAvgHumidity', `${avgHumidity}%`);
}

/**
 * Display weather charts
 */
function displayWeatherCharts(allWeatherData) {
    const canvas = document.getElementById('weatherHistoryChart');
    if (!canvas) {
        console.warn('⚠️ weatherHistoryChart canvas not found');
        return;
    }

    if (!allWeatherData || allWeatherData.length === 0) {
        console.warn('⚠️ No weather data to display in chart');
        // Destroy existing chart if it exists
        if (window.weatherChart) {
            window.weatherChart.destroy();
            window.weatherChart = null;
        }
        return;
    }

    // Sort data by date
    const sortedData = allWeatherData
        .filter(w => w.recordDate || w.createdAt)
        .sort((a, b) => new Date(a.recordDate || a.createdAt) - new Date(b.recordDate || b.createdAt))
        .slice(-30); // Last 30 records

    const labels = sortedData.map(w => {
        const date = new Date(w.recordDate || w.createdAt);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    const temperatures = sortedData.map(w => parseFloat(w.temperature || 0));
    const rainfalls = sortedData.map(w => parseFloat(w.rainfall || 0));

    // Destroy existing chart if it exists
    if (window.weatherChart) {
        window.weatherChart.destroy();
    }

    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('❌ Chart.js is not loaded');
        canvas.parentElement.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: #666;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; color: #f59e0b;"></i>
                <p>Chart.js library is not loaded. Please refresh the page.</p>
            </div>
        `;
        return;
    }

    try {
        const ctx = canvas.getContext('2d');
        window.weatherChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Temperature (°C)',
                        data: temperatures,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4
                    },
                    {
                        label: 'Rainfall (mm)',
                        data: rainfalls,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4,
                        type: 'bar'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Temperature (°C)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Rainfall (mm)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
        console.log('✅ Weather chart created successfully');
    } catch (error) {
        console.error('❌ Error creating weather chart:', error);
        canvas.parentElement.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: #666;">
                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; color: #ef4444;"></i>
                <p>Error displaying chart: ${error.message}</p>
            </div>
        `;
    }
}

/**
 * Analyze weather risks
 */
function analyzeWeatherRisks(allWeatherData, farms) {
    const risks = [];
    
    if (!allWeatherData || allWeatherData.length === 0) {
        displayWeatherRisks(risks);
        return;
    }

    // Get recent data (last 7 days)
    const recentData = allWeatherData.filter(w => {
        const date = new Date(w.recordDate || w.createdAt || 0);
        const daysAgo = (Date.now() - date.getTime()) / (1000 * 60 * 60 * 24);
        return daysAgo <= 7;
    });

    if (recentData.length === 0) {
        displayWeatherRisks(risks);
        return;
    }

    // Calculate averages
    const avgTemp = recentData
        .map(w => parseFloat(w.temperature))
        .filter(t => !isNaN(t))
        .reduce((a, b) => a + b, 0) / recentData.length;

    const totalRainfall = recentData
        .map(w => parseFloat(w.rainfall || 0))
        .filter(r => !isNaN(r))
        .reduce((a, b) => a + b, 0);

    const avgHumidity = recentData
        .map(w => parseFloat(w.humidity))
        .filter(h => !isNaN(h))
        .reduce((a, b) => a + b, 0) / recentData.length;

    // Flood Risk: High rainfall (>50mm in 7 days)
    if (totalRainfall > 50) {
        risks.push({
            type: 'FLOOD',
            severity: totalRainfall > 100 ? 'HIGH' : 'MEDIUM',
            message: `High rainfall detected: ${totalRainfall.toFixed(2)}mm in the last 7 days. Risk of flooding.`,
            icon: 'fa-water',
            color: '#3b82f6'
        });
    }

    // Drought Risk: Low rainfall (<5mm in 7 days) and low humidity
    if (totalRainfall < 5 && avgHumidity < 40) {
        risks.push({
            type: 'DROUGHT',
            severity: totalRainfall < 2 ? 'HIGH' : 'MEDIUM',
            message: `Drought conditions: Only ${totalRainfall.toFixed(2)}mm rainfall and ${avgHumidity.toFixed(1)}% humidity. Irrigation needed.`,
            icon: 'fa-sun',
            color: '#f59e0b'
        });
    }

    // Heat Stress: High temperature (>35°C)
    if (avgTemp > 35) {
        risks.push({
            type: 'HEAT_STRESS',
            severity: avgTemp > 40 ? 'HIGH' : 'MEDIUM',
            message: `High temperature: ${avgTemp.toFixed(1)}°C. Risk of heat stress for crops.`,
            icon: 'fa-thermometer-full',
            color: '#ef4444'
        });
    }

    // Cold Stress: Low temperature (<10°C)
    if (avgTemp < 10) {
        risks.push({
            type: 'COLD_STRESS',
            severity: avgTemp < 5 ? 'HIGH' : 'MEDIUM',
            message: `Low temperature: ${avgTemp.toFixed(1)}°C. Risk of cold stress for crops.`,
            icon: 'fa-snowflake',
            color: '#06b6d4'
        });
    }

    displayWeatherRisks(risks);
    updateElement('weatherRiskCount', risks.length);
}

/**
 * Display weather risks
 */
function displayWeatherRisks(risks) {
    const container = document.getElementById('weatherRiskAlertsContainer');
    if (!container) return;

    if (!risks || risks.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 2rem;">
                <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--primary-green); margin-bottom: 0.5rem;"></i>
                <p style="color: #666;">No active weather risks detected</p>
            </div>
        `;
        return;
    }

    container.innerHTML = risks.map(risk => `
        <div class="weather-risk-alert" style="border-left: 4px solid ${risk.color};">
            <div class="weather-risk-header">
                <div class="weather-risk-icon" style="color: ${risk.color};">
                    <i class="fas ${risk.icon}"></i>
                </div>
                <div class="weather-risk-info">
                    <h4>${risk.type.replace('_', ' ')} Risk</h4>
                    <span class="weather-risk-severity severity-${risk.severity.toLowerCase()}">${risk.severity}</span>
                </div>
            </div>
            <p class="weather-risk-message">${risk.message}</p>
        </div>
    `).join('');
}

/**
 * Generate AI Weather Prediction
 */
async function generateWeatherPrediction() {
    try {
        const btn = document.getElementById('generatePredictionBtn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        }

        showLoading();

        // Get recent weather data for analysis
        let allWeatherData = [];
        try {
            const recentResponse = await apiRequest(`/weather-data/recent?days=30`);
            if (Array.isArray(recentResponse)) {
                allWeatherData = recentResponse;
            } else if (recentResponse && recentResponse.data && Array.isArray(recentResponse.data)) {
                allWeatherData = recentResponse.data;
            }
        } catch (error) {
            console.warn('⚠️ Error loading weather data for prediction:', error.message);
        }

        if (allWeatherData.length === 0) {
            showToast('⚠️ No weather data available for prediction', 'warning');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate Prediction';
            }
            hideLoading();
            return;
        }

        // Analyze trends
        const sortedData = allWeatherData
            .filter(w => w.recordDate || w.createdAt)
            .sort((a, b) => new Date(a.recordDate || a.createdAt) - new Date(b.recordDate || b.createdAt));

        const recent7Days = sortedData.slice(-7);
        const previous7Days = sortedData.slice(-14, -7);

        // Calculate rainfall trend
        const recentRainfall = recent7Days
            .map(w => parseFloat(w.rainfall || 0))
            .reduce((a, b) => a + b, 0);
        const previousRainfall = previous7Days
            .map(w => parseFloat(w.rainfall || 0))
            .reduce((a, b) => a + b, 0);
        const rainfallTrend = recentRainfall > previousRainfall ? 'INCREASING' : 
                              recentRainfall < previousRainfall ? 'DECREASING' : 'STABLE';

        // Calculate temperature trend
        const recentAvgTemp = recent7Days
            .map(w => parseFloat(w.temperature))
            .filter(t => !isNaN(t))
            .reduce((a, b) => a + b, 0) / recent7Days.length;
        const previousAvgTemp = previous7Days
            .map(w => parseFloat(w.temperature))
            .filter(t => !isNaN(t))
            .reduce((a, b) => a + b, 0) / previous7Days.length;
        const tempTrend = recentAvgTemp > previousAvgTemp ? 'INCREASING' : 
                         recentAvgTemp < previousAvgTemp ? 'DECREASING' : 'STABLE';

        // Generate predictions
        const predictions = {
            rainfallTrend: rainfallTrend,
            temperatureTrend: tempTrend,
            risks: [],
            impacts: []
        };

        // Predict risks
        if (recentRainfall > 50) {
            predictions.risks.push({
                type: 'FLOOD',
                probability: recentRainfall > 100 ? 'HIGH' : 'MEDIUM',
                message: 'High probability of flooding in the next 7 days'
            });
        }

        if (recentRainfall < 5 && recentAvgTemp > 30) {
            predictions.risks.push({
                type: 'DROUGHT',
                probability: recentRainfall < 2 ? 'HIGH' : 'MEDIUM',
                message: 'Drought conditions expected to continue'
            });
        }

        if (recentAvgTemp > 35) {
            predictions.risks.push({
                type: 'HEAT_STRESS',
                probability: recentAvgTemp > 40 ? 'HIGH' : 'MEDIUM',
                message: 'Heat stress risk for crops'
            });
        }

        // Predict impacts
        if (rainfallTrend === 'DECREASING' && recentRainfall < 10) {
            predictions.impacts.push({
                type: 'IRRIGATION_NEED',
                message: 'Increased irrigation needed due to low rainfall'
            });
        }

        if (tempTrend === 'INCREASING' && recentAvgTemp > 30) {
            predictions.impacts.push({
                type: 'CROP_STRESS',
                message: 'High temperatures may cause crop stress'
            });
        }

        if (rainfallTrend === 'INCREASING' && recentRainfall > 30) {
            predictions.impacts.push({
                type: 'PLANTING_DELAY',
                message: 'Heavy rainfall may delay planting activities'
            });
        }

        // Display predictions
        displayWeatherPredictions(predictions);

        showToast('✅ Weather prediction generated successfully!', 'success');

    } catch (error) {
        console.error('❌ Error generating prediction:', error);
        showToast('❌ Error generating prediction', 'error');
    } finally {
        const btn = document.getElementById('generatePredictionBtn');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Generate Prediction';
        }
        hideLoading();
    }
}

/**
 * Display weather predictions
 */
function displayWeatherPredictions(predictions) {
    const container = document.getElementById('weatherPredictionsContainer');
    if (!container) return;

    const rainfallIcon = predictions.rainfallTrend === 'INCREASING' ? '📈' : 
                        predictions.rainfallTrend === 'DECREASING' ? '📉' : '➡️';
    const tempIcon = predictions.temperatureTrend === 'INCREASING' ? '📈' : 
                     predictions.temperatureTrend === 'DECREASING' ? '📉' : '➡️';

    container.innerHTML = `
        <div class="weather-predictions-content">
            <!-- Trends -->
            <div class="weather-prediction-section">
                <h4><i class="fas fa-chart-line"></i> Weather Trends (Next 7 Days)</h4>
                <div class="prediction-trends">
                    <div class="prediction-trend-item">
                        <div class="trend-icon">${rainfallIcon}</div>
                        <div class="trend-info">
                            <span class="trend-label">Rainfall Trend</span>
                            <span class="trend-value trend-${predictions.rainfallTrend.toLowerCase()}">${predictions.rainfallTrend}</span>
                        </div>
                    </div>
                    <div class="prediction-trend-item">
                        <div class="trend-icon">${tempIcon}</div>
                        <div class="trend-info">
                            <span class="trend-label">Temperature Trend</span>
                            <span class="trend-value trend-${predictions.temperatureTrend.toLowerCase()}">${predictions.temperatureTrend}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Risks -->
            ${predictions.risks.length > 0 ? `
            <div class="weather-prediction-section">
                <h4><i class="fas fa-exclamation-triangle"></i> Risk Alerts</h4>
                <div class="prediction-risks">
                    ${predictions.risks.map(risk => `
                        <div class="prediction-risk-item risk-${risk.probability.toLowerCase()}">
                            <i class="fas fa-${risk.type === 'FLOOD' ? 'water' : risk.type === 'DROUGHT' ? 'sun' : 'thermometer-full'}"></i>
                            <div class="risk-info">
                                <span class="risk-type">${risk.type}</span>
                                <span class="risk-probability">${risk.probability} Probability</span>
                                <p class="risk-message">${risk.message}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            <!-- Impacts -->
            ${predictions.impacts.length > 0 ? `
            <div class="weather-prediction-section">
                <h4><i class="fas fa-seedling"></i> Agricultural Impact</h4>
                <div class="prediction-impacts">
                    ${predictions.impacts.map(impact => `
                        <div class="prediction-impact-item">
                            <i class="fas fa-${impact.type === 'IRRIGATION_NEED' ? 'tint' : impact.type === 'CROP_STRESS' ? 'exclamation-circle' : 'calendar-times'}"></i>
                            <span>${impact.message}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
        </div>
    `;
}

/**
 * Display agricultural impact
 */
function displayAgriculturalImpact(allWeatherData, farms) {
    const container = document.getElementById('agriculturalImpactContainer');
    if (!container) return;

    if (!allWeatherData || allWeatherData.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: 2rem;">
                <i class="fas fa-info-circle" style="font-size: 2rem; color: #3b82f6; margin-bottom: 0.5rem;"></i>
                <p style="color: #666;">Agricultural impact analysis will appear here</p>
            </div>
        `;
        return;
    }

    const recentData = allWeatherData.filter(w => {
        const date = new Date(w.recordDate || w.createdAt || 0);
        const daysAgo = (Date.now() - date.getTime()) / (1000 * 60 * 60 * 24);
        return daysAgo <= 7;
    });

    const impacts = [];

    const avgTemp = recentData
        .map(w => parseFloat(w.temperature))
        .filter(t => !isNaN(t))
        .reduce((a, b) => a + b, 0) / recentData.length;

    const totalRainfall = recentData
        .map(w => parseFloat(w.rainfall || 0))
        .filter(r => !isNaN(r))
        .reduce((a, b) => a + b, 0);

    if (totalRainfall < 5) {
        impacts.push({
            icon: 'fa-tint',
            title: 'Irrigation Needed',
            message: 'Low rainfall detected. Consider increasing irrigation frequency.',
            color: '#3b82f6'
        });
    }

    if (avgTemp > 35) {
        impacts.push({
            icon: 'fa-thermometer-full',
            title: 'Heat Stress',
            message: 'High temperatures may stress crops. Ensure adequate water supply.',
            color: '#ef4444'
        });
    }

    if (totalRainfall > 50) {
        impacts.push({
            icon: 'fa-calendar-times',
            title: 'Planting Delay',
            message: 'Heavy rainfall may delay planting activities. Monitor soil conditions.',
            color: '#f59e0b'
        });
    }

    if (impacts.length === 0) {
        impacts.push({
            icon: 'fa-check-circle',
            title: 'Optimal Conditions',
            message: 'Weather conditions are favorable for agricultural activities.',
            color: '#22c55e'
        });
    }

    container.innerHTML = impacts.map(impact => `
        <div class="agricultural-impact-item" style="border-left: 4px solid ${impact.color};">
            <div class="impact-icon" style="color: ${impact.color};">
                <i class="fas ${impact.icon}"></i>
            </div>
            <div class="impact-content">
                <h4>${impact.title}</h4>
                <p>${impact.message}</p>
            </div>
        </div>
    `).join('');
}

/**
 * Get weather icon based on condition and temperature
 */
function getWeatherIcon(condition, temperature) {
    const temp = parseFloat(temperature) || 20;
    const cond = (condition || '').toLowerCase();

    if (cond.includes('rain') || cond.includes('drizzle')) {
        return '<i class="fas fa-cloud-rain" style="font-size: 3rem; color: #3b82f6;"></i>';
    } else if (cond.includes('storm') || cond.includes('thunder')) {
        return '<i class="fas fa-bolt" style="font-size: 3rem; color: #f59e0b;"></i>';
    } else if (cond.includes('cloud') || cond.includes('overcast')) {
        return '<i class="fas fa-cloud" style="font-size: 3rem; color: #94a3b8;"></i>';
    } else if (cond.includes('sun') || cond.includes('clear')) {
        return '<i class="fas fa-sun" style="font-size: 3rem; color: #f59e0b;"></i>';
    } else if (temp > 30) {
        return '<i class="fas fa-sun" style="font-size: 3rem; color: #ef4444;"></i>';
    } else if (temp < 15) {
        return '<i class="fas fa-snowflake" style="font-size: 3rem; color: #06b6d4;"></i>';
    } else {
        return '<i class="fas fa-cloud-sun" style="font-size: 3rem; color: #3b82f6;"></i>';
    }
}

/**
 * Display empty weather state
 */
function displayEmptyWeatherState(message = null) {
    const container = document.getElementById('weatherFarmsGrid');
    if (container) {
        const defaultMessage = 'Weather data will appear here once available for your farm locations.';
        container.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1; padding: 3rem 2rem;">
                <i class="fas fa-cloud-sun" style="font-size: 4rem; color: #ddd; margin-bottom: 1rem; opacity: 0.5;"></i>
                <h3 style="color: #666; margin-bottom: 0.5rem;">No Weather Data Available</h3>
                <p style="color: #999; margin-bottom: 1rem;">${message || defaultMessage}</p>
                <button class="btn btn-primary" onclick="loadWeatherData()" style="margin-top: 1rem;">
                    <i class="fas fa-sync-alt"></i>
                    Retry Loading
                </button>
            </div>
        `;
    }

    // Clear statistics
    updateElement('weatherAvgTemp', '--°C');
    updateElement('weatherTotalRainfall', '-- mm');
    updateElement('weatherAvgHumidity', '--%');
    updateElement('weatherRiskCount', '0');

    // Clear charts
    const chartCanvas = document.getElementById('weatherHistoryChart');
    if (chartCanvas && window.weatherChart) {
        window.weatherChart.destroy();
        window.weatherChart = null;
    }

    // Clear predictions
    const predictionsContainer = document.getElementById('weatherPredictionsContainer');
    if (predictionsContainer) {
        predictionsContainer.innerHTML = `
            <div class="empty-state" style="padding: 3rem;">
                <i class="fas fa-brain" style="font-size: 3rem; color: #ddd; margin-bottom: 1rem;"></i>
                <p style="color: #666;">Click "Generate Prediction" to get AI-powered weather forecasts and agricultural insights</p>
            </div>
        `;
    }

    // Clear risks
    const risksContainer = document.getElementById('weatherRiskAlertsContainer');
    if (risksContainer) {
        risksContainer.innerHTML = `
            <div class="empty-state" style="padding: 2rem;">
                <i class="fas fa-check-circle" style="font-size: 2rem; color: var(--primary-green); margin-bottom: 0.5rem;"></i>
                <p style="color: #666;">No active weather risks detected</p>
            </div>
        `;
    }

    // Clear impact
    const impactContainer = document.getElementById('agriculturalImpactContainer');
    if (impactContainer) {
        impactContainer.innerHTML = `
            <div class="empty-state" style="padding: 2rem;">
                <i class="fas fa-info-circle" style="font-size: 2rem; color: #3b82f6; margin-bottom: 0.5rem;"></i>
                <p style="color: #666;">Agricultural impact analysis will appear here</p>
            </div>
        `;
    }
}

/**
 * View supply chain details
 */
async function viewSupplyChainDetails(stageId) {
    if (!stageId) {
        showToast('❌ Invalid stage ID', 'error');
        return;
    }

    try {
        showLoading();

        const stage = await apiRequest(`/supply-chain/${stageId}`);

        if (!stage) {
            showToast('❌ Stage not found', 'error');
            return;
        }

        showSupplyChainDetailsModal(stage);

    } catch (error) {
        console.error('Error loading stage details:', error);
        showToast('❌ Error loading stage details', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Show supply chain details modal
 */
function showSupplyChainDetailsModal(stage) {
    const modalHTML = `
        <div class="modal-overlay show" id="supplyChainModal" onclick="if(event.target === this) closeSupplyChainModal()">
            <div class="modal-container modal-large">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-info-circle"></i>
                        Supply Chain Stage Details
                    </h3>
                    <button class="modal-close" onclick="closeSupplyChainModal()" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="details-grid">
                        <div class="detail-item">
                            <label>Stage:</label>
                            <value><strong>${stage.stage}</strong></value>
                        </div>
                        <div class="detail-item">
                            <label>Stage Order:</label>
                            <value>${stage.stageOrder}</value>
                        </div>
                        <div class="detail-item">
                            <label>Location:</label>
                            <value>${stage.location || 'N/A'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Facility:</label>
                            <value>${stage.facilityName || 'N/A'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Responsible Party:</label>
                            <value>${stage.responsibleParty || 'N/A'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Quantity In:</label>
                            <value>${stage.quantityIn || 'N/A'} ${stage.unit || 'KG'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Quantity Out:</label>
                            <value>${stage.quantityOut || 'N/A'} ${stage.unit || 'KG'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Quality Status:</label>
                            <value>${stage.qualityStatus || 'N/A'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Tracking Code:</label>
                            <value>${stage.trackingCode || 'N/A'}</value>
                        </div>
                        <div class="detail-item">
                            <label>Start Date:</label>
                            <value>${stage.stageStartDate ? formatDateTime(stage.stageStartDate) : 'N/A'}</value>
                        </div>
                        <div class="detail-item">
                            <label>End Date:</label>
                            <value>${stage.stageEndDate ? formatDateTime(stage.stageEndDate) : 'Not completed'}</value>
                        </div>
                        ${stage.lossQuantity && parseFloat(stage.lossQuantity) > 0 ? `
                        <div class="detail-item full-width alert">
                            <label>Loss Information:</label>
                            <value>
                                ${stage.lossQuantity} ${stage.unit || 'KG'}
                                ${stage.lossPercentage ? `(${stage.lossPercentage}%)` : ''}
                                ${stage.lossReason ? `<br><small>${stage.lossReason}</small>` : ''}
                            </value>
                        </div>
                        ` : ''}
                        ${stage.notes ? `
                        <div class="detail-item full-width">
                            <label>Notes:</label>
                            <value>${stage.notes}</value>
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSupplyChainModal()">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                    ${!stage.stageEndDate ? `
                        <button type="button" class="btn btn-primary" onclick="editSupplyChainStage('${stage.id}')">
                            <i class="fas fa-edit"></i>
                            Edit
                        </button>
                        <button type="button" class="btn btn-success" onclick="completeStage('${stage.id}')">
                            <i class="fas fa-check"></i>
                            Complete Stage
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close supply chain modal
 */
function closeSupplyChainModal() {
    const modal = document.getElementById('supplyChainModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}

/**
 * Edit supply chain stage
 */
function editSupplyChainStage(stageId) {
    showToast('Edit stage functionality coming soon', 'info');
    closeSupplyChainModal();
}




















/**
 * Complete a supply chain stage with improved validation and UX
 */
async function completeStage(stageId) {
    try {
        showLoading();

        // First, fetch the stage data to get quantityIn
        const stageData = await apiRequest(`/supply-chain/${stageId}`);

        if (!stageData) {
            showToast('❌ Unable to load stage data', 'error');
            return;
        }

        const quantityIn = stageData.quantityIn || 0;
        const currentStage = stageData.stage || 'Unknown';
        const location = stageData.location || '';

        hideLoading();

        const modalHTML = `
            <div class="modal-overlay show" id="completeStageModal" onclick="if(event.target === this) closeCompleteStageModal()">
                <div class="modal-container">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-check-circle"></i>
                            Complete Supply Chain Stage
                        </h3>
                        <button class="modal-close" onclick="closeCompleteStageModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form id="completeStageForm" onsubmit="handleCompleteStage(event, '${stageId}', ${quantityIn})">
                        <div class="modal-body">
                            <!-- Stage Info Alert -->
                            <div class="alert alert-info" style="margin-bottom: 20px;">
                                <i class="fas fa-info-circle"></i>
                                <div>
                                    <strong>Stage:</strong> ${currentStage}<br>
                                    <strong>Location:</strong> ${location}<br>
                                    <strong>Input Quantity:</strong> <span style="color: #2563eb; font-weight: 600;">${quantityIn} KG</span>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">
                                    <i class="fas fa-balance-scale"></i>
                                    Quantity Out (KG) *
                                </label>
                                <input
                                    type="number"
                                    name="quantityOut"
                                    id="quantityOutInput"
                                    class="form-input"
                                    step="0.01"
                                    min="0.01"
                                    max="${quantityIn}"
                                    placeholder="Max: ${quantityIn} KG"
                                    required
                                    autofocus
                                    oninput="validateQuantityOut(this, ${quantityIn})"
                                >
                                <small class="form-hint">
                                    <i class="fas fa-info-circle"></i>
                                    Enter the quantity that exits this stage (Maximum: ${quantityIn} KG)
                                </small>
                                <small id="quantityOutError" class="form-hint" style="color: #dc2626; display: none;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Quantity out cannot exceed ${quantityIn} KG
                                </small>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">
                                    <i class="fas fa-star"></i>
                                    Quality Status *
                                </label>
                                <select name="qualityStatus" class="form-select" required>
                                    <option value="EXCELLENT">⭐⭐⭐⭐⭐ Excellent</option>
                                    <option value="GOOD" selected>⭐⭐⭐⭐ Good</option>
                                    <option value="FAIR">⭐⭐⭐ Fair</option>
                                    <option value="POOR">⭐⭐ Poor</option>
                                    <option value="REJECTED">❌ Rejected</option>
                                </select>
                                <small class="form-hint">
                                    <i class="fas fa-info-circle"></i>
                                    Assess the quality at completion
                                </small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-sticky-note"></i>
                                    Handling Notes
                                </label>
                                <textarea
                                    name="handlingNotes"
                                    class="form-input"
                                    rows="3"
                                    maxlength="3000"
                                    placeholder="Add any notes about this stage completion..."
                                ></textarea>
                                <small class="form-hint">
                                    <i class="fas fa-info-circle"></i>
                                    Optional: Add observations, issues, or special handling
                                </small>
                            </div>

                            <div class="alert alert-warning" style="margin-top: 16px;">
                                <i class="fas fa-lightbulb"></i>
                                <strong>Note:</strong> Completing this stage will set the end date to now and mark it as completed.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeCompleteStageModal()">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="submit" class="btn btn-success" id="submitCompleteBtn">
                                <i class="fas fa-check"></i>
                                Complete Stage
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

    } catch (error) {
        console.error('❌ Error loading stage data:', error);
        showToast('❌ Error loading stage data', 'error');
        hideLoading();
    }
}

/**
 * Validate quantity out input in real-time
 */
function validateQuantityOut(input, maxQuantity) {
    const value = parseFloat(input.value);
    const errorElement = document.getElementById('quantityOutError');
    const submitBtn = document.getElementById('submitCompleteBtn');

    if (isNaN(value)) {
        errorElement.style.display = 'none';
        return;
    }

    if (value > maxQuantity) {
        errorElement.style.display = 'block';
        input.style.borderColor = '#dc2626';
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
        submitBtn.style.cursor = 'not-allowed';
    } else if (value <= 0) {
        errorElement.style.display = 'none';
        errorElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Quantity must be greater than 0`;
        errorElement.style.display = 'block';
        input.style.borderColor = '#dc2626';
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
        submitBtn.style.cursor = 'not-allowed';
    } else {
        errorElement.style.display = 'none';
        input.style.borderColor = '#10b981';
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
    }
}




/**
 * Close complete stage modal
 */
function closeCompleteStageModal() {
    const modal = document.getElementById('completeStageModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}








/**
 * Handle complete stage form submission - IMPROVED VERSION
 */
async function handleCompleteStage(event, stageId, quantityIn) {
    event.preventDefault();

    try {
        showLoading();

        const formData = new FormData(event.target);

        // Parse and validate quantityOut
        const quantityOutRaw = formData.get('quantityOut');
        const quantityOut = parseFloat(quantityOutRaw);

        console.log('🐛 DEBUG - Form values:');
        console.log('  - quantityOut (raw):', quantityOutRaw);
        console.log('  - quantityOut (parsed):', quantityOut);
        console.log('  - quantityIn (max allowed):', quantityIn);
        console.log('  - handlingNotes:', formData.get('handlingNotes'));
        console.log('  - qualityStatus:', formData.get('qualityStatus'));

        // Client-side validation
        if (isNaN(quantityOut) || quantityOut <= 0) {
            showToast('❌ Quantity must be a valid number greater than 0', 'error');
            hideLoading();
            return;
        }

        if (quantityOut > quantityIn) {
            showToast(`❌ Quantity out (${quantityOut} KG) cannot exceed quantity in (${quantityIn} KG)`, 'error');
            hideLoading();
            return;
        }

        // Build the completion data
        const completionData = {
            quantityOut: quantityOut,
            handlingNotes: formData.get('handlingNotes')?.trim() || '',
            qualityStatus: formData.get('qualityStatus')
        };

        // Validate quality status
        if (!completionData.qualityStatus) {
            showToast('❌ Please select a quality status', 'error');
            hideLoading();
            return;
        }

        console.log('📤 Completing stage:', stageId, completionData);
        console.log('🐛 DEBUG - Final JSON to send:', JSON.stringify(completionData));

        // API Call
        const response = await apiRequest(`/supply-chain/${stageId}/complete`, {
            method: 'POST',
            body: JSON.stringify(completionData)
        });

        console.log('✅ Stage completed successfully:', response);

        showToast('✅ Stage completed successfully!', 'success');
        closeCompleteStageModal();

        // Reload the data
        await loadSupplyChainData();

    } catch (error) {
        console.error('❌ Error completing stage:', error);
        console.error('❌ Error stack:', error.stack);

        let errorMessage = 'Error completing stage';

        // Parse error message if it's JSON
        if (error.message) {
            try {
                // Check if the error message contains JSON
                const jsonMatch = error.message.match(/\{.*\}/);
                if (jsonMatch) {
                    const errorData = JSON.parse(jsonMatch[0]);
                    if (errorData.message) {
                        errorMessage = errorData.message;
                    }
                }
            } catch (parseError) {
                // If parsing fails, use the original error message
                if (error.message.includes('400')) {
                    errorMessage = 'Invalid data. Please check your input values.';
                } else if (error.message.includes('404')) {
                    errorMessage = 'Stage not found. It may have been deleted.';
                } else if (error.message.includes('500')) {
                    errorMessage = 'Server error. Please try again later.';
                }
            }
        }

        showToast(`❌ ${errorMessage}`, 'error');
    } finally {
        hideLoading();
    }
}


/**
 * Open add supply chain modal
 */
function openAddSupplyChainModal() {
    showToast('Add supply chain stage functionality coming soon', 'info');
}

/**
 * Initialize supply chain search
 */
function initSupplyChainSearch() {
    const searchInput = document.getElementById('supplyChainSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(() => {
            filterSupplyChainData();
        }, 300));
    }
}

/**
 * Filter supply chain data
 */
function filterSupplyChainData() {
    const searchTerm = document.getElementById('supplyChainSearchInput')?.value.toLowerCase() || '';
    const groups = document.querySelectorAll('.supply-chain-group');

    groups.forEach(group => {
        const text = group.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            group.style.display = 'block';
        } else {
            group.style.display = 'none';
        }
    });
}

/**
 * Initialize on load
 */
document.addEventListener('DOMContentLoaded', () => {
    initSupplyChainSearch();
});

console.log('✅ Supply Chain module loaded');





















/**
 * Helper function to update element
 */
function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    }
}





    /**
     * Display supply chain timeline
     */
    function displaySupplyChainTimeline(supplyChainData) {
      const container = document.getElementById('supplyChainContainer');
      if (!container) return;

      if (supplyChainData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-truck"></i>
            <p>No supply chain tracking data available</p>
          </div>
        `;
        return;
      }

      const stageColors = {
        'HARVEST': '#22c55e',
        'COLLECTION': '#3b82f6',
        'STORAGE': '#f59e0b',
        'PROCESSING': '#8b5cf6',
        'PACKAGING': '#ec4899',
        'TRANSPORT': '#14b8a6',
        'DISTRIBUTION': '#f97316',
        'RETAIL': '#06b6d4'
      };

      container.innerHTML = supplyChainData.map(item => `
        <div class="supply-chain-item">
          <div class="supply-chain-header">
            <div>
              <div class="supply-chain-tracking-code">Tracking: ${item.trackingCode}</div>
              <h3 class="supply-chain-title">${item.productionCode || 'Production'} - ${item.cropName || 'Crop'}</h3>
            </div>
          </div>
          <div class="supply-chain-stages">
            ${(item.stages || []).map(stage => `
              <div class="stage-card" style="border-left-color: ${stageColors[stage.stageName] || '#666'};">
                <div class="stage-name">
                  <i class="fas ${getStageIcon(stage.stageName)}"></i>
                  ${stage.stageName}
                </div>
                <div class="stage-details">
                  <strong>Date:</strong> ${formatDateTime(stage.timestamp)}<br>
                  <strong>Location:</strong> ${stage.location || 'N/A'}<br>
                  ${stage.handler ? `<strong>Handler:</strong> ${stage.handler}<br>` : ''}
                  ${stage.notes ? `<strong>Notes:</strong> ${stage.notes}` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    /**
     * Get stage icon
     */
    function getStageIcon(stageName) {
      const icons = {
        'HARVEST': 'fa-seedling',
        'COLLECTION': 'fa-hand-holding',
        'STORAGE': 'fa-warehouse',
        'PROCESSING': 'fa-cogs',
        'PACKAGING': 'fa-box',
        'TRANSPORT': 'fa-truck',
        'DISTRIBUTION': 'fa-shipping-fast',
        'RETAIL': 'fa-store'
      };
      return icons[stageName] || 'fa-circle';
    }

    // ============================================================================
    // WEATHER DATA MODULE
    // ============================================================================

    /**
     * Load weather data
     */
    // Old weather functions removed - using new comprehensive implementation above

    // ============================================================================
    // ALERTS MODULE
    // ============================================================================

    /**
     * Load alerts data
     */
    /**
     * Load alerts data with AI analysis
     */
    async function loadAlertsData() {
      try {
        showLoading();
        console.log('🚨 Loading food security alerts...');

        if (!currentUser || !currentUser.id) {
            console.error('❌ No current user found');
            displayEmptyAlertsState('No user session found. Please login again.');
            hideLoading();
            return;
        }

        // ✅ STEP 1: Get alerts from database
        let databaseAlerts = [];
        try {
            const response = await apiRequest('/food-security-alerts/active?page=0&size=100');
            
            // Handle different response formats
            if (Array.isArray(response)) {
                databaseAlerts = response;
            } else if (response && response.data) {
                if (Array.isArray(response.data)) {
                    databaseAlerts = response.data;
                } else if (response.data.content && Array.isArray(response.data.content)) {
                    databaseAlerts = response.data.content;
                }
            } else if (response && response.content && Array.isArray(response.content)) {
                databaseAlerts = response.content;
            }
            
            console.log(`✅ Loaded ${databaseAlerts.length} alerts from database`);
        } catch (error) {
            console.warn('⚠️ Error loading alerts from database:', error.message);
            databaseAlerts = [];
        }

        // ✅ STEP 2: Generate AI alerts based on real data
        console.log('🤖 Generating AI alerts based on real farm data...');
        const aiAlerts = await generateAIAlerts();

        // ✅ STEP 3: Combine database alerts and AI alerts
        const allAlerts = [...databaseAlerts, ...aiAlerts];
        
        // Sort by priority (CRITICAL first, then by date)
        allAlerts.sort((a, b) => {
            const levelPriority = { 'CRITICAL': 5, 'HIGH': 4, 'MEDIUM': 3, 'LOW': 2, 'INFO': 1 };
            const aPriority = levelPriority[a.alertLevel] || 0;
            const bPriority = levelPriority[b.alertLevel] || 0;
            if (aPriority !== bPriority) return bPriority - aPriority;
            
            const aDate = new Date(a.alertDate || a.createdAt || 0);
            const bDate = new Date(b.alertDate || b.createdAt || 0);
            return bDate - aDate;
        });

        console.log(`✅ Total alerts: ${allAlerts.length} (${databaseAlerts.length} from DB, ${aiAlerts.length} AI-generated)`);

        // ✅ STEP 4: Update statistics
        updateAlertsStatistics(allAlerts);

        // ✅ STEP 5: Store alerts globally for filtering
        allAlertsData = allAlerts;

        // ✅ STEP 6: Display alerts
        displayAlertsList(allAlerts);

      } catch (error) {
        console.error('❌ Error loading alerts:', error);
        showToast('Error loading alerts: ' + error.message, 'error');
        displayEmptyAlertsState('Error loading alerts. Please try again.');
      } finally {
        hideLoading();
      }
    }

    /**
     * Generate AI alerts based on real farm data
     */
    async function generateAIAlerts() {
        const aiAlerts = [];
        
        try {
            if (!currentUser || !currentUser.id) {
                return aiAlerts;
            }

            const farmerId = currentUser.id;

            // ✅ Get all relevant data for analysis
            const [farms, productions, inventory, weatherData, transactions] = await Promise.all([
                apiRequest(`/farms/farmer/${farmerId}/all`).catch(() => []),
                apiRequest(`/v1/crop-productions/farmer/${farmerId}`).catch(() => ({ data: [] })),
                apiRequest(`/v1/inventories/farmer/${farmerId}`).catch(() => []),
                apiRequest(`/weather-data/recent?days=7`).catch(() => []),
                apiRequest(`/transactions/farmer/${farmerId}`).catch(() => [])
            ]);

            const farmsList = Array.isArray(farms) ? farms : [];
            const productionsList = Array.isArray(productions) ? productions : 
                                   (productions.data && Array.isArray(productions.data) ? productions.data : []);
            const inventoryList = Array.isArray(inventory) ? inventory : [];
            const weatherList = Array.isArray(weatherData) ? weatherData : [];
            const transactionsList = Array.isArray(transactions) ? transactions : 
                                    (transactions.content && Array.isArray(transactions.content) ? transactions.content : []);

            console.log(`📊 Analyzing: ${farmsList.length} farms, ${productionsList.length} productions, ${inventoryList.length} inventory items, ${weatherList.length} weather records`);

            // ✅ ALERT 1: Low Inventory Alert
            const lowStockItems = inventoryList.filter(item => {
                const available = parseFloat(item.availableQuantity || 0);
                const total = parseFloat(item.totalQuantity || 0);
                return available > 0 && total > 0 && (available / total) < 0.2; // Less than 20% remaining
            });

            if (lowStockItems.length > 0) {
                aiAlerts.push({
                    id: 'AI-LOW-STOCK-' + Date.now(),
                    alertCode: 'AI-LOW-STOCK',
                    alertTitle: 'Low Inventory Stock Alert',
                    alertCategory: 'PRODUCTION',
                    alertLevel: lowStockItems.length > 5 ? 'HIGH' : 'MEDIUM',
                    description: `${lowStockItems.length} crop(s) have low stock levels (less than 20% remaining). Consider restocking soon to avoid production delays.`,
                    severityScore: lowStockItems.length > 5 ? 8 : 5,
                    affectedCrops: JSON.stringify(lowStockItems.map(item => item.cropName || 'Unknown')),
                    alertDate: new Date().toISOString(),
                    source: 'AI Analysis System',
                    isActive: true,
                    recommendedActions: `1. Review inventory levels for: ${lowStockItems.slice(0, 3).map(i => i.cropName || 'Unknown').join(', ')}\n2. Plan restocking for critical crops\n3. Check production schedules`,
                    isAIGenerated: true
                });
            }

            // ✅ ALERT 2: Weather Risk Alert
            if (weatherList.length > 0) {
                const recentWeather = weatherList.slice(0, 7);
                const avgTemp = recentWeather
                    .map(w => parseFloat(w.temperature))
                    .filter(t => !isNaN(t))
                    .reduce((a, b) => a + b, 0) / recentWeather.length;
                
                const totalRainfall = recentWeather
                    .map(w => parseFloat(w.rainfall || 0))
                    .filter(r => !isNaN(r))
                    .reduce((a, b) => a + b, 0);

                if (avgTemp > 35) {
                    aiAlerts.push({
                        id: 'AI-HEAT-STRESS-' + Date.now(),
                        alertCode: 'AI-HEAT-STRESS',
                        alertTitle: 'Heat Stress Warning',
                        alertCategory: 'WEATHER',
                        alertLevel: avgTemp > 40 ? 'HIGH' : 'MEDIUM',
                        description: `High temperatures detected (${avgTemp.toFixed(1)}°C average). Your crops may experience heat stress. Ensure adequate irrigation and consider shade protection.`,
                        severityScore: avgTemp > 40 ? 8 : 6,
                        alertDate: new Date().toISOString(),
                        source: 'AI Weather Analysis',
                        isActive: true,
                        recommendedActions: '1. Increase irrigation frequency\n2. Monitor soil moisture levels\n3. Consider applying mulch to retain moisture\n4. Check for signs of wilting or leaf burn',
                        isAIGenerated: true
                    });
                }

                if (totalRainfall < 5 && avgTemp > 30) {
                    aiAlerts.push({
                        id: 'AI-DROUGHT-' + Date.now(),
                        alertCode: 'AI-DROUGHT',
                        alertTitle: 'Drought Conditions Alert',
                        alertCategory: 'WEATHER',
                        alertLevel: 'HIGH',
                        description: `Drought conditions detected: Only ${totalRainfall.toFixed(2)}mm rainfall in the last 7 days with high temperatures. Immediate irrigation action required.`,
                        severityScore: 9,
                        alertDate: new Date().toISOString(),
                        source: 'AI Weather Analysis',
                        isActive: true,
                        recommendedActions: '1. Schedule immediate irrigation\n2. Monitor soil moisture daily\n3. Consider water conservation measures\n4. Check crop water requirements',
                        isAIGenerated: true
                    });
                }

                if (totalRainfall > 50) {
                    aiAlerts.push({
                        id: 'AI-FLOOD-RISK-' + Date.now(),
                        alertCode: 'AI-FLOOD-RISK',
                        alertTitle: 'Flood Risk Warning',
                        alertCategory: 'WEATHER',
                        alertLevel: totalRainfall > 100 ? 'CRITICAL' : 'HIGH',
                        description: `Heavy rainfall detected: ${totalRainfall.toFixed(2)}mm in the last 7 days. Risk of flooding and waterlogging. Protect your crops and storage facilities.`,
                        severityScore: totalRainfall > 100 ? 10 : 8,
                        alertDate: new Date().toISOString(),
                        source: 'AI Weather Analysis',
                        isActive: true,
                        recommendedActions: '1. Check drainage systems\n2. Move stored crops to higher ground\n3. Monitor water levels\n4. Prepare for potential crop damage',
                        isAIGenerated: true
                    });
                }
            }

            // ✅ ALERT 3: Production Issues
            const activeProductions = productionsList.filter(p => 
                p.status === 'ACTIVE' || p.status === 'IN_PROGRESS'
            );

            if (activeProductions.length > 0) {
                const overdueProductions = activeProductions.filter(p => {
                    if (!p.expectedHarvestDate) return false;
                    const expectedDate = new Date(p.expectedHarvestDate);
                    const today = new Date();
                    return today > expectedDate;
                });

                if (overdueProductions.length > 0) {
                    aiAlerts.push({
                        id: 'AI-OVERDUE-HARVEST-' + Date.now(),
                        alertCode: 'AI-OVERDUE-HARVEST',
                        alertTitle: 'Overdue Harvest Alert',
                        alertCategory: 'PRODUCTION',
                        alertLevel: 'MEDIUM',
                        description: `${overdueProductions.length} production(s) have passed their expected harvest date. Review and update harvest schedules.`,
                        severityScore: 6,
                        affectedCrops: JSON.stringify(overdueProductions.map(p => p.cropName || 'Unknown')),
                        alertDate: new Date().toISOString(),
                        source: 'AI Production Analysis',
                        isActive: true,
                        recommendedActions: '1. Review harvest schedules\n2. Check crop maturity\n3. Update production records\n4. Plan harvest activities',
                        isAIGenerated: true
                    });
                }
            }

            // ✅ ALERT 4: Transaction Issues
            const pendingTransactions = transactionsList.filter(t => 
                t.status === 'PENDING' || t.transactionStatus === 'PENDING'
            );

            if (pendingTransactions.length > 5) {
                aiAlerts.push({
                    id: 'AI-PENDING-TRANSACTIONS-' + Date.now(),
                    alertCode: 'AI-PENDING-TRANSACTIONS',
                    alertTitle: 'Multiple Pending Transactions',
                    alertCategory: 'MARKET',
                    alertLevel: 'MEDIUM',
                    description: `You have ${pendingTransactions.length} pending transactions. Consider following up to ensure timely payments.`,
                    severityScore: 5,
                    alertDate: new Date().toISOString(),
                    source: 'AI Market Analysis',
                    isActive: true,
                    recommendedActions: '1. Review pending transactions\n2. Contact buyers for updates\n3. Update transaction statuses\n4. Follow up on payments',
                    isAIGenerated: true
                });
            }

            // ✅ ALERT 5: Farm Health
            if (farmsList.length > 0) {
                const farmsWithoutRecentActivity = farmsList.filter(farm => {
                    // Check if farm has recent production or activity
                    const farmProductions = productionsList.filter(p => p.farmId === farm.id);
                    return farmProductions.length === 0;
                });

                if (farmsWithoutRecentActivity.length > 0 && farmsWithoutRecentActivity.length === farmsList.length) {
                    aiAlerts.push({
                        id: 'AI-NO-ACTIVITY-' + Date.now(),
                        alertCode: 'AI-NO-ACTIVITY',
                        alertTitle: 'No Recent Farm Activity',
                        alertCategory: 'PRODUCTION',
                        alertLevel: 'LOW',
                        description: `No recent production activity detected on your farms. Consider planning new crop productions.`,
                        severityScore: 3,
                        alertDate: new Date().toISOString(),
                        source: 'AI Farm Analysis',
                        isActive: true,
                        recommendedActions: '1. Plan new crop productions\n2. Review seasonal planting schedules\n3. Check farm conditions\n4. Start new production cycles',
                        isAIGenerated: true
                    });
                }
            }

            console.log(`✅ Generated ${aiAlerts.length} AI alerts`);

        } catch (error) {
            console.error('❌ Error generating AI alerts:', error);
        }

        return aiAlerts;
    }



/**
 * Display alerts list - IMPROVED VERSION WITH AI SUPPORT
 */
function displayAlertsList(alerts) {
  const container = document.getElementById('alertsList');
  if (!container) {
    console.error('❌ alertsList container not found');
    return;
  }

  // ✅ CORRECTION: Extraire le tableau depuis data.content
  let alertsList = [];
  if (Array.isArray(alerts)) {
    alertsList = alerts;
  } else if (alerts && alerts.data && Array.isArray(alerts.data.content)) {
    alertsList = alerts.data.content;
  } else if (alerts && alerts.data && Array.isArray(alerts.data)) {
    alertsList = alerts.data;
  } else if (alerts && alerts.content && Array.isArray(alerts.content)) {
    alertsList = alerts.content;
  } else {
    console.warn('⚠️ Unexpected alerts format:', alerts);
    alertsList = [];
  }

  if (alertsList.length === 0) {
    displayEmptyAlertsState('No active alerts at the moment. Your farm operations appear to be running smoothly.');
    return;
  }

  console.log(`📊 Displaying ${alertsList.length} alerts`);

  container.innerHTML = alertsList.map(alert => {
    if (!alert || !alert.alertTitle) {
      return '';
    }

    const alertLevel = alert.alertLevel || 'INFO';
    const levelLower = alertLevel.toLowerCase();
    const category = alert.alertCategory || alert.category || 'GENERAL';
    const description = alert.description || 'No description available';
    const alertDate = alert.alertDate ? formatDateTime(alert.alertDate) : 'N/A';
    const severityScore = alert.severityScore || 5;
    const isAIGenerated = alert.isAIGenerated || false;
    const recommendedActions = alert.recommendedActions || null;
    const affectedCrops = alert.affectedCrops ? (typeof alert.affectedCrops === 'string' ? JSON.parse(alert.affectedCrops) : alert.affectedCrops) : null;

    // Level colors
    const levelColors = {
      'critical': { bg: 'rgba(239, 68, 68, 0.15)', border: '#ef4444', text: '#ef4444', icon: 'fa-exclamation-circle' },
      'high': { bg: 'rgba(245, 158, 11, 0.15)', border: '#f59e0b', text: '#f59e0b', icon: 'fa-exclamation-triangle' },
      'medium': { bg: 'rgba(59, 130, 246, 0.15)', border: '#3b82f6', text: '#3b82f6', icon: 'fa-info-circle' },
      'low': { bg: 'rgba(139, 92, 246, 0.15)', border: '#8b5cf6', text: '#8b5cf6', icon: 'fa-bell' },
      'info': { bg: 'rgba(34, 197, 94, 0.15)', border: '#22c55e', text: '#22c55e', icon: 'fa-info' }
    };

    const levelStyle = levelColors[levelLower] || levelColors['info'];

    // Category icons
    const categoryIcons = {
      'PRODUCTION': 'fa-seedling',
      'WEATHER': 'fa-cloud-sun',
      'MARKET': 'fa-chart-line',
      'DISEASE': 'fa-virus',
      'POLICY': 'fa-gavel',
      'GENERAL': 'fa-bell'
    };

    const categoryIcon = categoryIcons[category] || 'fa-bell';

    return `
      <div class="alert-item" style="border-left: 4px solid ${levelStyle.border}; background: ${levelStyle.bg};">
        <div class="alert-item-header">
          <div class="alert-item-title-section">
            ${isAIGenerated ? `
            <span class="ai-badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-right: 8px;">
              <i class="fas fa-brain"></i> AI
            </span>
            ` : ''}
            <h4 class="alert-item-title" style="color: var(--text-primary); margin: 0; font-size: 18px; font-weight: 700;">
              ${escapeHtml(alert.alertTitle)}
            </h4>
          </div>
          <div class="alert-item-badges">
            <span class="alert-level" style="background: ${levelStyle.border}; color: white; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
              <i class="fas ${levelStyle.icon}"></i> ${alertLevel}
            </span>
            ${severityScore ? `
            <span class="severity-score" style="background: rgba(0,0,0,0.1); color: var(--text-secondary); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
              Severity: ${severityScore}/10
            </span>
            ` : ''}
          </div>
        </div>

        <div class="alert-item-body">
          <p class="alert-item-message" style="color: var(--text-secondary); line-height: 1.6; margin: 12px 0;">
            ${escapeHtml(description)}
          </p>

          ${affectedCrops && Array.isArray(affectedCrops) && affectedCrops.length > 0 ? `
          <div class="alert-affected-items" style="margin: 12px 0; padding: 8px 12px; background: rgba(0,0,0,0.05); border-radius: 8px;">
            <strong style="color: var(--text-primary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
              <i class="fas fa-seedling"></i> Affected Crops:
            </strong>
            <div style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 6px;">
              ${affectedCrops.map(crop => `
                <span style="background: rgba(34, 197, 94, 0.15); color: var(--primary-green); padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                  ${escapeHtml(crop)}
                </span>
              `).join('')}
            </div>
          </div>
          ` : ''}

          ${recommendedActions ? `
          <div class="alert-recommendations" style="margin: 12px 0; padding: 12px; background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); border-left: 3px solid #ffc107; border-radius: 8px;">
            <strong style="color: #856404; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
              <i class="fas fa-lightbulb" style="color: #ffc107;"></i> Recommended Actions:
            </strong>
            <div style="color: #666; font-size: 13px; line-height: 1.8; white-space: pre-line;">
              ${escapeHtml(recommendedActions)}
            </div>
          </div>
          ` : ''}
        </div>

        <div class="alert-item-footer" style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.1); margin-top: 12px;">
          <div class="alert-item-meta" style="display: flex; gap: 16px; flex-wrap: wrap;">
            <span style="color: var(--text-secondary); font-size: 12px; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-calendar-alt" style="color: ${levelStyle.border};"></i>
              ${alertDate}
            </span>
            <span style="color: var(--text-secondary); font-size: 12px; display: flex; align-items: center; gap: 6px;">
              <i class="fas ${categoryIcon}" style="color: ${levelStyle.border};"></i>
              ${category}
            </span>
            ${alert.source ? `
            <span style="color: var(--text-secondary); font-size: 12px; display: flex; align-items: center; gap: 6px;">
              <i class="fas fa-source" style="color: ${levelStyle.border};"></i>
              ${escapeHtml(alert.source)}
            </span>
            ` : ''}
          </div>
          <div class="alert-item-actions">
            ${alert.id || alert.alertCode ? `
            <button class="btn-icon" onclick="viewAlertDetails('${alert.id || alert.alertCode}')" title="View Details" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#3b82f6'; this.style.color='white';" onmouseout="this.style.background='rgba(59, 130, 246, 0.1)'; this.style.color='#3b82f6';">
              <i class="fas fa-eye"></i>
            </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }).filter(html => html !== '').join('');
}

/**
 * Update alerts statistics
 */
function updateAlertsStatistics(alerts) {
    if (!alerts || alerts.length === 0) {
        updateElement('alertsCriticalCount', '0');
        updateElement('alertsHighCount', '0');
        updateElement('alertsTotalCount', '0');
        updateElement('aiAlertsCount', '0');
        return;
    }

    const critical = alerts.filter(a => a.alertLevel === 'CRITICAL').length;
    const high = alerts.filter(a => a.alertLevel === 'HIGH').length;
    const total = alerts.length;
    const aiGenerated = alerts.filter(a => a.isAIGenerated === true).length;

    updateElement('alertsCriticalCount', critical);
    updateElement('alertsHighCount', high);
    updateElement('alertsTotalCount', total);
    updateElement('aiAlertsCount', aiGenerated);
}

/**
 * Display empty alerts state
 */
function displayEmptyAlertsState(message = null) {
    const container = document.getElementById('alertsList');
    if (container) {
        const defaultMessage = 'No active alerts at the moment. Your farm operations appear to be running smoothly.';
        container.innerHTML = `
            <div class="empty-state" style="padding: 4rem 2rem; text-align: center;">
                <div style="width: 100px; height: 100px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--primary-green);"></i>
                </div>
                <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.5rem;">No Active Alerts</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto;">
                    ${message || defaultMessage}
                </p>
                <button class="btn btn-primary" onclick="generateAIAnalysis()" style="margin-top: 1rem;">
                    <i class="fas fa-brain"></i>
                    Generate AI Analysis
                </button>
            </div>
        `;
    }

    updateAlertsStatistics([]);
}

/**
 * Generate comprehensive AI analysis
 */
async function generateAIAnalysis() {
    try {
        const btn = document.getElementById('generateAIAnalysisBtn');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        }

        showLoading();
        showToast('🤖 Generating AI analysis based on your farm data...', 'info');

        if (!currentUser || !currentUser.id) {
            showToast('❌ No user session found', 'error');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic"></i> Generate AI Analysis';
            }
            hideLoading();
            return;
        }

        const farmerId = currentUser.id;

        // ✅ Collect all real data
        console.log('📊 Collecting farm data for AI analysis...');
        
        const [farms, productions, inventory, weatherData, transactions, soilData] = await Promise.all([
            apiRequest(`/farms/farmer/${farmerId}/all`).catch(() => []),
            apiRequest(`/v1/crop-productions/farmer/${farmerId}`).catch(() => ({ data: [] })),
            apiRequest(`/v1/inventories/farmer/${farmerId}`).catch(() => []),
            apiRequest(`/weather-data/recent?days=30`).catch(() => []),
            apiRequest(`/transactions/farmer/${farmerId}`).catch(() => []),
            apiRequest(`/v1/soil-data/farmer/${farmerId}`).catch(() => [])
        ]);

        const farmsList = Array.isArray(farms) ? farms : [];
        const productionsList = Array.isArray(productions) ? productions : 
                               (productions.data && Array.isArray(productions.data) ? productions.data : []);
        const inventoryList = Array.isArray(inventory) ? inventory : [];
        const weatherList = Array.isArray(weatherData) ? weatherData : [];
        const transactionsList = Array.isArray(transactions) ? transactions : 
                                (transactions.content && Array.isArray(transactions.content) ? transactions.content : []);
        const soilList = Array.isArray(soilData) ? soilData : [];

        console.log(`✅ Collected data: ${farmsList.length} farms, ${productionsList.length} productions, ${inventoryList.length} inventory, ${weatherList.length} weather, ${transactionsList.length} transactions, ${soilList.length} soil records`);

        // ✅ Perform AI Analysis
        const analysis = performAIAnalysis({
            farms: farmsList,
            productions: productionsList,
            inventory: inventoryList,
            weather: weatherList,
            transactions: transactionsList,
            soil: soilList
        });

        // ✅ Display analysis
        displayAIAnalysis(analysis);

        showToast('✅ AI analysis generated successfully!', 'success');

    } catch (error) {
        console.error('❌ Error generating AI analysis:', error);
        showToast('❌ Error generating AI analysis: ' + error.message, 'error');
    } finally {
        const btn = document.getElementById('generateAIAnalysisBtn');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Generate AI Analysis';
        }
        hideLoading();
    }
}

/**
 * Perform comprehensive AI analysis on farm data
 */
function performAIAnalysis(data) {
    const analysis = {
        summary: {
            overallHealth: 'GOOD',
            riskLevel: 'LOW',
            recommendations: []
        },
        weather: {
            status: 'NORMAL',
            risks: [],
            trends: {},
            recommendations: []
        },
        production: {
            status: 'ACTIVE',
            issues: [],
            opportunities: [],
            recommendations: []
        },
        inventory: {
            status: 'ADEQUATE',
            warnings: [],
            recommendations: []
        },
        market: {
            status: 'STABLE',
            insights: [],
            recommendations: []
        },
        soil: {
            status: 'HEALTHY',
            issues: [],
            recommendations: []
        }
    };

    // ✅ WEATHER ANALYSIS
    if (data.weather && data.weather.length > 0) {
        const recentWeather = data.weather.slice(0, 7);
        const avgTemp = recentWeather
            .map(w => parseFloat(w.temperature))
            .filter(t => !isNaN(t))
            .reduce((a, b) => a + b, 0) / recentWeather.length;
        
        const totalRainfall = recentWeather
            .map(w => parseFloat(w.rainfall || 0))
            .filter(r => !isNaN(r))
            .reduce((a, b) => a + b, 0);

        const avgHumidity = recentWeather
            .map(w => parseFloat(w.humidity))
            .filter(h => !isNaN(h))
            .reduce((a, b) => a + b, 0) / recentWeather.length;

        // Temperature trend
        if (avgTemp > 35) {
            analysis.weather.risks.push({
                type: 'HEAT_STRESS',
                severity: avgTemp > 40 ? 'HIGH' : 'MEDIUM',
                message: `High temperatures (${avgTemp.toFixed(1)}°C) may stress crops`,
                recommendation: 'Increase irrigation frequency and monitor soil moisture'
            });
            analysis.weather.status = 'WARNING';
        } else if (avgTemp < 15) {
            analysis.weather.risks.push({
                type: 'COLD_STRESS',
                severity: avgTemp < 10 ? 'HIGH' : 'MEDIUM',
                message: `Low temperatures (${avgTemp.toFixed(1)}°C) may affect crop growth`,
                recommendation: 'Consider protective measures for sensitive crops'
            });
            analysis.weather.status = 'WARNING';
        }

        // Rainfall analysis
        if (totalRainfall < 5) {
            analysis.weather.risks.push({
                type: 'DROUGHT',
                severity: 'HIGH',
                message: `Low rainfall (${totalRainfall.toFixed(2)}mm) - drought conditions`,
                recommendation: 'Schedule irrigation immediately'
            });
            analysis.weather.status = 'CRITICAL';
        } else if (totalRainfall > 50) {
            analysis.weather.risks.push({
                type: 'FLOOD_RISK',
                severity: totalRainfall > 100 ? 'CRITICAL' : 'HIGH',
                message: `Heavy rainfall (${totalRainfall.toFixed(2)}mm) - flood risk`,
                recommendation: 'Check drainage systems and protect stored crops'
            });
            analysis.weather.status = 'CRITICAL';
        }

        analysis.weather.trends = {
            temperature: avgTemp > 30 ? 'INCREASING' : avgTemp < 20 ? 'DECREASING' : 'STABLE',
            rainfall: totalRainfall > 30 ? 'INCREASING' : totalRainfall < 10 ? 'DECREASING' : 'STABLE',
            humidity: avgHumidity > 70 ? 'HIGH' : avgHumidity < 40 ? 'LOW' : 'NORMAL'
        };
    }

    // ✅ PRODUCTION ANALYSIS
    if (data.productions && data.productions.length > 0) {
        const activeProductions = data.productions.filter(p => 
            p.status === 'ACTIVE' || p.status === 'IN_PROGRESS'
        );

        if (activeProductions.length === 0) {
            analysis.production.issues.push({
                type: 'NO_ACTIVE_PRODUCTION',
                message: 'No active crop productions detected',
                recommendation: 'Plan and start new crop productions for the season'
            });
            analysis.production.status = 'INACTIVE';
        } else {
            const overdue = activeProductions.filter(p => {
                if (!p.expectedHarvestDate) return false;
                return new Date() > new Date(p.expectedHarvestDate);
            });

            if (overdue.length > 0) {
                analysis.production.issues.push({
                    type: 'OVERDUE_HARVEST',
                    message: `${overdue.length} production(s) past harvest date`,
                    recommendation: 'Review and update harvest schedules'
                });
            }

            analysis.production.opportunities.push({
                type: 'EXPAND_PRODUCTION',
                message: `You have ${activeProductions.length} active production(s)`,
                recommendation: 'Consider expanding successful crop varieties'
            });
        }
    }

    // ✅ INVENTORY ANALYSIS
    if (data.inventory && data.inventory.length > 0) {
        const lowStock = data.inventory.filter(item => {
            const available = parseFloat(item.availableQuantity || 0);
            const total = parseFloat(item.totalQuantity || 0);
            return available > 0 && total > 0 && (available / total) < 0.2;
        });

        if (lowStock.length > 0) {
            analysis.inventory.warnings.push({
                type: 'LOW_STOCK',
                message: `${lowStock.length} item(s) with low stock (less than 20%)`,
                recommendation: 'Restock critical inventory items soon'
            });
            analysis.inventory.status = 'LOW';
        }

        const totalValue = data.inventory.reduce((sum, item) => {
            const price = parseFloat(item.unitPrice || 0);
            const qty = parseFloat(item.availableQuantity || 0);
            return sum + (price * qty);
        }, 0);

        analysis.inventory.totalValue = totalValue;
    }

    // ✅ MARKET ANALYSIS
    if (data.transactions && data.transactions.length > 0) {
        const pending = data.transactions.filter(t => 
            t.status === 'PENDING' || t.transactionStatus === 'PENDING'
        );

        const completed = data.transactions.filter(t => 
            t.status === 'PAID' || t.status === 'COMPLETED' || 
            t.transactionStatus === 'PAID' || t.transactionStatus === 'COMPLETED'
        );

        if (pending.length > completed.length) {
            analysis.market.insights.push({
                type: 'PENDING_TRANSACTIONS',
                message: `${pending.length} pending transactions need attention`,
                recommendation: 'Follow up on pending transactions for timely payments'
            });
        }

        const totalRevenue = completed.reduce((sum, t) => {
            return sum + parseFloat(t.totalAmount || 0);
        }, 0);

        analysis.market.totalRevenue = totalRevenue;
    }

    // ✅ SOIL ANALYSIS
    if (data.soil && data.soil.length > 0) {
        const recentSoil = data.soil.slice(0, 5);
        const avgPh = recentSoil
            .map(s => parseFloat(s.phLevel))
            .filter(p => !isNaN(p))
            .reduce((a, b) => a + b, 0) / recentSoil.length;

        if (avgPh < 6.0 || avgPh > 7.5) {
            analysis.soil.issues.push({
                type: 'PH_IMBALANCE',
                message: `Soil pH is ${avgPh.toFixed(2)} (optimal: 6.0-7.5)`,
                recommendation: avgPh < 6.0 ? 'Apply lime to raise pH' : 'Apply sulfur to lower pH'
            });
            analysis.soil.status = 'NEEDS_ATTENTION';
        }
    }

    // ✅ OVERALL HEALTH ASSESSMENT
    const riskCount = analysis.weather.risks.length + 
                     analysis.production.issues.length + 
                     analysis.inventory.warnings.length;

    if (riskCount > 5) {
        analysis.summary.overallHealth = 'NEEDS_ATTENTION';
        analysis.summary.riskLevel = 'HIGH';
    } else if (riskCount > 2) {
        analysis.summary.overallHealth = 'GOOD';
        analysis.summary.riskLevel = 'MEDIUM';
    }

    // Generate overall recommendations
    if (analysis.weather.status === 'CRITICAL') {
        analysis.summary.recommendations.push('⚠️ URGENT: Address weather-related risks immediately');
    }
    if (analysis.inventory.status === 'LOW') {
        analysis.summary.recommendations.push('📦 Restock inventory items with low stock levels');
    }
    if (analysis.production.status === 'INACTIVE') {
        analysis.summary.recommendations.push('🌾 Plan new crop productions for the season');
    }

    return analysis;
}

/**
 * Display AI analysis results
 */
function displayAIAnalysis(analysis) {
    const container = document.getElementById('aiAnalysisContainer');
    if (!container) return;

    const healthColors = {
        'GOOD': { color: '#22c55e', icon: 'fa-check-circle' },
        'NEEDS_ATTENTION': { color: '#f59e0b', icon: 'fa-exclamation-triangle' },
        'CRITICAL': { color: '#ef4444', icon: 'fa-times-circle' }
    };

    const healthStyle = healthColors[analysis.summary.overallHealth] || healthColors['GOOD'];

    container.innerHTML = `
        <div class="ai-analysis-content" style="padding: 20px;">
            <!-- Overall Health Summary -->
            <div class="analysis-section" style="margin-bottom: 32px;">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-heartbeat" style="color: ${healthStyle.color};"></i>
                    Overall Farm Health
                </h4>
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px; padding: 16px; background: ${healthStyle.color}15; border-left: 4px solid ${healthStyle.color}; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas ${healthStyle.icon}" style="font-size: 2rem; color: ${healthStyle.color};"></i>
                            <div>
                                <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Status</div>
                                <div style="font-size: 20px; font-weight: 700; color: ${healthStyle.color};">${analysis.summary.overallHealth}</div>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1; min-width: 200px; padding: 16px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-shield-alt" style="font-size: 2rem; color: #3b82f6;"></i>
                            <div>
                                <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Risk Level</div>
                                <div style="font-size: 20px; font-weight: 700; color: #3b82f6;">${analysis.summary.riskLevel}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weather Analysis -->
            ${analysis.weather.risks.length > 0 || Object.keys(analysis.weather.trends).length > 0 ? `
            <div class="analysis-section" style="margin-bottom: 32px;">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-cloud-sun" style="color: #3b82f6;"></i>
                    Weather Analysis
                </h4>
                ${analysis.weather.risks.map(risk => `
                    <div style="padding: 12px 16px; background: ${risk.severity === 'HIGH' || risk.severity === 'CRITICAL' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; border-left: 4px solid ${risk.severity === 'HIGH' || risk.severity === 'CRITICAL' ? '#ef4444' : '#f59e0b'}; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${risk.type.replace('_', ' ')}</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${risk.message}</div>
                        <div style="color: var(--text-primary); font-size: 13px; font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: #ffc107;"></i> ${risk.recommendation}
                        </div>
                    </div>
                `).join('')}
                ${Object.keys(analysis.weather.trends).length > 0 ? `
                    <div style="padding: 12px 16px; background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--primary-green); border-radius: 8px; margin-top: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">Weather Trends</div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            ${Object.entries(analysis.weather.trends).map(([key, value]) => `
                                <div>
                                    <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">${key}</div>
                                    <div style="font-weight: 700; color: var(--text-primary);">${value}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
            ` : ''}

            <!-- Production Analysis -->
            ${analysis.production.issues.length > 0 || analysis.production.opportunities.length > 0 ? `
            <div class="analysis-section" style="margin-bottom: 32px;">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-seedling" style="color: var(--primary-green);"></i>
                    Production Analysis
                </h4>
                ${analysis.production.issues.map(issue => `
                    <div style="padding: 12px 16px; background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${issue.type.replace('_', ' ')}</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${issue.message}</div>
                        <div style="color: var(--text-primary); font-size: 13px; font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: #ffc107;"></i> ${issue.recommendation}
                        </div>
                    </div>
                `).join('')}
                ${analysis.production.opportunities.map(opp => `
                    <div style="padding: 12px 16px; background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--primary-green); border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${opp.type.replace('_', ' ')}</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${opp.message}</div>
                        <div style="color: var(--text-primary); font-size: 13px; font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: var(--primary-green);"></i> ${opp.recommendation}
                        </div>
                    </div>
                `).join('')}
            </div>
            ` : ''}

            <!-- Inventory Analysis -->
            ${analysis.inventory.warnings.length > 0 || analysis.inventory.totalValue ? `
            <div class="analysis-section" style="margin-bottom: 32px;">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-boxes" style="color: #8b5cf6;"></i>
                    Inventory Analysis
                </h4>
                ${analysis.inventory.totalValue ? `
                    <div style="padding: 12px 16px; background: rgba(139, 92, 246, 0.1); border-left: 4px solid #8b5cf6; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary);">Total Inventory Value</div>
                        <div style="font-size: 24px; font-weight: 700; color: #8b5cf6; margin-top: 4px;">${formatCurrency(analysis.inventory.totalValue)}</div>
                    </div>
                ` : ''}
                ${analysis.inventory.warnings.map(warning => `
                    <div style="padding: 12px 16px; background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${warning.type.replace('_', ' ')}</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${warning.message}</div>
                        <div style="color: var(--text-primary); font-size: 13px; font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: #ffc107;"></i> ${warning.recommendation}
                        </div>
                    </div>
                `).join('')}
            </div>
            ` : ''}

            <!-- Market Analysis -->
            ${analysis.market.insights.length > 0 || analysis.market.totalRevenue ? `
            <div class="analysis-section" style="margin-bottom: 32px;">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-chart-line" style="color: #3b82f6;"></i>
                    Market Analysis
                </h4>
                ${analysis.market.totalRevenue ? `
                    <div style="padding: 12px 16px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary);">Total Revenue (Completed Transactions)</div>
                        <div style="font-size: 24px; font-weight: 700; color: #3b82f6; margin-top: 4px;">${formatCurrency(analysis.market.totalRevenue)}</div>
                    </div>
                ` : ''}
                ${analysis.market.insights.map(insight => `
                    <div style="padding: 12px 16px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${insight.type.replace('_', ' ')}</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${insight.message}</div>
                        <div style="color: var(--text-primary); font-size: 13px; font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: #3b82f6;"></i> ${insight.recommendation}
                        </div>
                    </div>
                `).join('')}
            </div>
            ` : ''}

            <!-- Soil Analysis -->
            ${analysis.soil.issues.length > 0 ? `
            <div class="analysis-section" style="margin-bottom: 32px;">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-mountain" style="color: #8b5cf6;"></i>
                    Soil Health Analysis
                </h4>
                ${analysis.soil.issues.map(issue => `
                    <div style="padding: 12px 16px; background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${issue.type.replace('_', ' ')}</div>
                        <div style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">${issue.message}</div>
                        <div style="color: var(--text-primary); font-size: 13px; font-weight: 600;">
                            <i class="fas fa-lightbulb" style="color: #ffc107;"></i> ${issue.recommendation}
                        </div>
                    </div>
                `).join('')}
            </div>
            ` : ''}

            <!-- Overall Recommendations -->
            ${analysis.summary.recommendations.length > 0 ? `
            <div class="analysis-section">
                <h4 style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-list-check" style="color: var(--primary-green);"></i>
                    Key Recommendations
                </h4>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${analysis.summary.recommendations.map((rec, index) => `
                        <div style="padding: 12px 16px; background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--primary-green); border-radius: 8px;">
                            <div style="display: flex; align-items: flex-start; gap: 12px;">
                                <span style="background: var(--primary-green); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0;">${index + 1}</span>
                                <div style="color: var(--text-primary); font-weight: 600; flex: 1;">${rec}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
        </div>
    `;
}

/**
 * View alert details
 */
async function viewAlertDetails(alertId) {
    try {
        showLoading();
        
        let alert = null;
        
        // ✅ Check if it's an AI-generated alert (starts with "AI-")
        if (alertId && alertId.startsWith('AI-')) {
            // Find the alert in our local data
            if (allAlertsData && allAlertsData.length > 0) {
                alert = allAlertsData.find(a => a.id === alertId);
            }
            
            if (!alert) {
                showToast('AI alert not found in local data', 'error');
                hideLoading();
                return;
            }
            
            console.log('✅ Using AI-generated alert from local data:', alert);
        } else {
            // ✅ It's a database alert, fetch from API
            try {
                const response = await apiRequest(`/food-security-alerts/${alertId}`);
                
                // Handle different response formats
                if (response && response.data) {
                    alert = response.data;
                } else if (Array.isArray(response) && response.length > 0) {
                    alert = response[0];
                } else if (response && response.id) {
                    alert = response;
                } else {
                    alert = response;
                }
                
                if (!alert || !alert.id) {
                    showToast('Alert not found in database', 'error');
                    hideLoading();
                    return;
                }
                
                console.log('✅ Loaded alert from database:', alert);
            } catch (apiError) {
                // If API fails, try to find in local data as fallback
                console.warn('⚠️ API call failed, trying local data:', apiError.message);
                if (allAlertsData && allAlertsData.length > 0) {
                    alert = allAlertsData.find(a => a.id === alertId);
                }
                
                if (!alert) {
                    showToast('Alert not found. It may have been removed.', 'error');
                    hideLoading();
                    return;
                }
            }
        }
        
        if (!alert) {
            showToast('Alert not found', 'error');
            hideLoading();
            return;
        }

        // Prepare alert data
        const alertLevel = alert.alertLevel || 'INFO';
        const levelLower = alertLevel.toLowerCase();
        const category = alert.alertCategory || alert.category || 'GENERAL';
        const description = alert.description || 'No description available';
        const alertDate = alert.alertDate ? formatDateTime(alert.alertDate) : 
                         (alert.createdAt ? formatDateTime(alert.createdAt) : 'N/A');
        const source = alert.source || 'System';
        const isAIGenerated = alert.isAIGenerated || alertId.startsWith('AI-');
        const recommendedActions = alert.recommendedActions || null;
        const affectedCrops = alert.affectedCrops ? 
            (typeof alert.affectedCrops === 'string' ? JSON.parse(alert.affectedCrops) : alert.affectedCrops) : 
            null;
        const severityScore = alert.severityScore || null;
        const affectedRegion = alert.affectedRegion || null;
        const affectedPopulation = alert.affectedPopulation || null;
        const economicImpact = alert.economicImpact || null;
        const mitigationMeasures = alert.mitigationMeasures || null;

        // Level colors
        const levelColors = {
            'critical': { color: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
            'high': { color: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
            'medium': { color: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
            'low': { color: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
            'info': { color: '#22c55e', bg: 'rgba(34, 197, 94, 0.1)' }
        };

        const levelStyle = levelColors[levelLower] || levelColors['info'];

        // Show alert details in modal
        const modalHTML = `
            <div class="modal-overlay show" id="alertDetailsModal" onclick="if(event.target === this) closeAlertModal()">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${escapeHtml(alert.alertTitle || 'Alert Details')}
                            ${isAIGenerated ? `
                            <span class="ai-badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; margin-left: 12px; display: inline-flex; align-items: center; gap: 4px;">
                                <i class="fas fa-brain"></i> AI Generated
                            </span>
                            ` : ''}
                        </h3>
                        <button class="modal-close" onclick="closeAlertModal()" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <div class="details-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="detail-item" style="padding: 12px; background: ${levelStyle.bg}; border-radius: 8px;">
                                <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Alert Level</label>
                                <value>
                                    <span class="alert-level" style="background: ${levelStyle.color}; color: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; display: inline-block;">
                                        ${alertLevel}
                                    </span>
                                </value>
                            </div>
                            <div class="detail-item" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Category</label>
                                <value style="font-weight: 600; color: var(--text-primary);">${category}</value>
                            </div>
                            <div class="detail-item" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Alert Date</label>
                                <value style="font-weight: 600; color: var(--text-primary);">${alertDate}</value>
                            </div>
                            <div class="detail-item" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Source</label>
                                <value style="font-weight: 600; color: var(--text-primary);">${escapeHtml(source)}</value>
                            </div>
                            ${severityScore ? `
                            <div class="detail-item" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                                <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Severity Score</label>
                                <value style="font-weight: 700; color: ${levelStyle.color}; font-size: 18px;">${severityScore}/10</value>
                            </div>
                            ` : ''}
                        </div>

                        ${affectedRegion ? `
                        <div class="detail-section" style="margin-bottom: 20px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px;">
                            <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Affected Region</label>
                            <value style="font-weight: 600; color: var(--text-primary);">${escapeHtml(affectedRegion)}</value>
                        </div>
                        ` : ''}

                        ${affectedPopulation ? `
                        <div class="detail-section" style="margin-bottom: 20px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-left: 4px solid #f59e0b; border-radius: 8px;">
                            <label style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Affected Population</label>
                            <value style="font-weight: 700; color: var(--text-primary); font-size: 18px;">${affectedPopulation.toLocaleString()}</value>
                        </div>
                        ` : ''}

                        <div class="detail-section" style="margin-bottom: 20px;">
                            <h4 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                                Description
                            </h4>
                            <p style="color: var(--text-secondary); line-height: 1.8; padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin: 0;">
                                ${escapeHtml(description)}
                            </p>
                        </div>

                        ${affectedCrops && Array.isArray(affectedCrops) && affectedCrops.length > 0 ? `
                        <div class="detail-section" style="margin-bottom: 20px;">
                            <h4 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-seedling" style="color: var(--primary-green);"></i>
                                Affected Crops
                            </h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                                ${affectedCrops.map(crop => `
                                    <span style="background: rgba(34, 197, 94, 0.15); color: var(--primary-green); padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 600;">
                                        ${escapeHtml(crop)}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${recommendedActions ? `
                        <div class="detail-section" style="margin-bottom: 20px;">
                            <h4 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-lightbulb" style="color: #ffc107;"></i>
                                Recommended Actions
                            </h4>
                            <div style="white-space: pre-line; padding: 16px; background: linear-gradient(135deg, #fff8e1 0%, #fffbf0 100%); border-left: 4px solid #ffc107; border-radius: 8px; color: #666; line-height: 1.8;">
                                ${escapeHtml(recommendedActions)}
                            </div>
                        </div>
                        ` : ''}

                        ${mitigationMeasures ? `
                        <div class="detail-section" style="margin-bottom: 20px;">
                            <h4 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-shield-alt" style="color: #3b82f6;"></i>
                                Mitigation Measures
                            </h4>
                            <div style="white-space: pre-line; padding: 16px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px; color: #666; line-height: 1.8;">
                                ${escapeHtml(mitigationMeasures)}
                            </div>
                        </div>
                        ` : ''}

                        ${economicImpact ? `
                        <div class="detail-section" style="margin-bottom: 20px; padding: 16px; background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; border-radius: 8px;">
                            <h4 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-dollar-sign" style="color: #ef4444;"></i>
                                Economic Impact
                            </h4>
                            <value style="font-weight: 700; color: #ef4444; font-size: 20px;">${formatCurrency(economicImpact)}</value>
                        </div>
                        ` : ''}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeAlertModal()">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

    } catch (error) {
        console.error('❌ Error loading alert details:', error);
        showToast('Error loading alert details: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Close alert modal
 */
function closeAlertModal() {
    const modal = document.getElementById('alertDetailsModal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            document.getElementById('modalContainer').innerHTML = '';
        }, 300);
    }
}






/**
 * Load policies data - VERSION ULTRA-ROBUSTE
 */
// Store policies globally for filtering
let allPoliciesData = [];






/**
 * Load policies data - VERSION CORRIGÉE
 */
async function loadPoliciesData() {
  try {
    showLoading();
    console.log('🔄 Loading policies data...');

    let policies = [];

    // ✅ ÉTAPE 1: Essayer d'abord /policies avec pagination
    try {
      console.log('🔄 Fetching policies from /policies endpoint...');
      const response = await apiRequest('/policies?page=0&size=100');

      console.log('📦 Raw response:', response);

      // ✅ Gérer la structure de réponse du backend
      if (response) {
        // Si c'est une ApiResponse avec data
        if (response.data) {
          // Si data.content existe (Page response)
          if (response.data.content && Array.isArray(response.data.content)) {
            policies = response.data.content;
            console.log('✅ Found policies in response.data.content');
          }
          // Si data est directement un tableau
          else if (Array.isArray(response.data)) {
            policies = response.data;
            console.log('✅ Found policies in response.data (array)');
          }
          // Si data est un objet Page
          else if (response.data.content) {
            policies = response.data.content;
            console.log('✅ Found policies in response.data.content (Page object)');
          }
        }
        // Si la réponse est directement un tableau
        else if (Array.isArray(response)) {
          policies = response;
          console.log('✅ Found policies in response (direct array)');
        }
        // Si c'est un objet Page directement
        else if (response.content && Array.isArray(response.content)) {
          policies = response.content;
          console.log('✅ Found policies in response.content (Page)');
        }
      }

      console.log(`📊 Loaded ${policies.length} policies from /policies`);

    } catch (error) {
      console.error('❌ Error loading from /policies:', error);

      // ✅ FALLBACK: Essayer /policies/active
      try {
        console.log('🔄 Trying fallback: /policies/active...');
        const activeResponse = await apiRequest('/policies/active');

        console.log('📦 Active response:', activeResponse);

        if (activeResponse) {
          if (activeResponse.data && Array.isArray(activeResponse.data)) {
            policies = activeResponse.data;
          } else if (Array.isArray(activeResponse)) {
            policies = activeResponse;
          }
        }

        console.log(`📊 Loaded ${policies.length} policies from /policies/active`);

      } catch (fallbackError) {
        console.error('❌ Fallback also failed:', fallbackError);
      }
    }

    // ✅ Debug: Afficher les policies trouvées
    console.log('📋 Final policies array:', policies);
    console.log('📋 First policy sample:', policies.length > 0 ? policies[0] : 'NONE');

    // Store all policies
    allPoliciesData = policies;

    // ✅ ÉTAPE 2: Filtrer les policies actives
    const activePolicies = policies.filter(p => {
      const isActive = p.status === 'ACTIVE';
      const isEffective = p.effectiveDate && new Date(p.effectiveDate) <= new Date();
      const notExpired = !p.expiryDate || new Date(p.expiryDate) >= new Date();

      return isActive || (isEffective && notExpired);
    });

    console.log(`✅ Total: ${policies.length}, Active: ${activePolicies.length}`);

    // ✅ ÉTAPE 3: Mise à jour des statistiques
    if (policies.length > 0) {
      updatePoliciesStatistics(policies);
    }

    // ✅ ÉTAPE 4: Affichage
    if (policies.length === 0) {
      console.warn('⚠️ No policies found - showing empty state');
      displayEmptyPoliciesState('No policies available. The database may be empty.');
    } else if (activePolicies.length > 0) {
      console.log('✅ Displaying active policies');
      displayPoliciesGrid(activePolicies);
      showToast(`✅ Loaded ${activePolicies.length} active policies`, 'success');
    } else {
      console.log('ℹ️ No active policies - showing all policies');
      displayPoliciesGrid(policies);
      showToast(`ℹ️ Showing ${policies.length} policies (no active policies found)`, 'info');
    }

  } catch (error) {
    console.error('❌ Critical error in loadPoliciesData:', error);
    console.error('❌ Error stack:', error.stack);
    showToast('Unable to load policies: ' + error.message, 'error');
    displayEmptyPoliciesState('Error loading policies. Please refresh the page.');
  } finally {
    hideLoading();
  }
}

/**
 * Update policies statistics
 */
function updatePoliciesStatistics(policies) {
  if (!policies || policies.length === 0) {
    return;
  }

  const active = policies.filter(p => p.status === 'ACTIVE').length;
  const expired = policies.filter(p => p.status === 'EXPIRED').length;
  const draft = policies.filter(p => p.status === 'DRAFT').length;
  
  // Calculate total budget
  const totalBudget = policies
    .filter(p => p.status === 'ACTIVE' && p.totalBudget)
    .reduce((sum, p) => sum + parseFloat(p.totalBudget || 0), 0);

  console.log(`📊 Policies Stats: ${active} active, ${expired} expired, ${draft} draft, Budget: ${formatCurrency(totalBudget)}`);
}

/**
 * Display policies grid - IMPROVED VERSION WITH BETTER DESIGN
 */
function displayPoliciesGrid(policies) {
  const container = document.getElementById('policiesGrid');
  if (!container) {
    console.warn('⚠️ policiesGrid container not found');
    return;
  }

  if (!policies || policies.length === 0) {
    displayEmptyPoliciesState('No policies available at the moment.');
    return;
  }

  console.log(`📊 Displaying ${policies.length} policies`);

  container.innerHTML = policies.map(policy => {
    // ✅ Validation stricte de chaque policy
    if (!policy || !policy.policyName) {
      console.warn('⚠️ Invalid policy data:', policy);
      return '';
    }

    const policyName = policy.policyName || 'Unnamed Policy';
    const policyCode = policy.policyCode || '';
    const policyType = policy.policyType || 'N/A';
    const policyCategory = policy.policyCategory || 'GENERAL';
    const description = policy.description || 'No description available';
    const eligibility = policy.eligibilityCriteria || policy.targetBeneficiaries || null;
    const benefits = policy.benefits || null;
    const deadline = policy.applicationDeadline ? formatDate(policy.applicationDeadline) : null;
    const effectiveDate = policy.effectiveDate ? formatDate(policy.effectiveDate) : null;
    const expiryDate = policy.expiryDate ? formatDate(policy.expiryDate) : null;
    const status = policy.status || 'UNKNOWN';
    const statusLower = status.toLowerCase();
    const policyId = policy.id || '';
    const totalBudget = policy.totalBudget ? formatCurrency(policy.totalBudget) : null;
    const implementingAgency = policy.implementingAgency || null;
    const geographicScope = policy.geographicScope || null;

    // Status colors
    const statusColors = {
      'active': { bg: 'rgba(34, 197, 94, 0.15)', border: '#22c55e', text: '#22c55e' },
      'expired': { bg: 'rgba(107, 114, 128, 0.15)', border: '#6b7280', text: '#6b7280' },
      'draft': { bg: 'rgba(245, 158, 11, 0.15)', border: '#f59e0b', text: '#f59e0b' },
      'unknown': { bg: 'rgba(59, 130, 246, 0.15)', border: '#3b82f6', text: '#3b82f6' }
    };

    const statusStyle = statusColors[statusLower] || statusColors['unknown'];

    // Type icons
    const typeIcons = {
      'SUBSIDY': 'fa-hand-holding-usd',
      'CREDIT_PROGRAM': 'fa-credit-card',
      'INSURANCE': 'fa-shield-alt',
      'REGULATION': 'fa-gavel',
      'SUPPORT_PROGRAM': 'fa-hands-helping'
    };

    const typeIcon = typeIcons[policyType] || 'fa-file-alt';

    // Check if expiring soon (within 30 days)
    const isExpiringSoon = expiryDate && new Date(expiryDate) > new Date() && 
                          new Date(expiryDate) <= new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);

    return `
      <div class="policy-card" style="background: var(--card-bg); border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border: 2px solid transparent; overflow: hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative;">
        ${isExpiringSoon ? `
        <div style="position: absolute; top: 0; right: 0; background: linear-gradient(135deg, #f59e0b, #f97316); color: white; padding: 4px 12px; border-radius: 0 0 0 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; z-index: 10;">
          <i class="fas fa-clock"></i> Expiring Soon
        </div>
        ` : ''}
        
        <div class="policy-header" style="padding: 24px 24px 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%); border-bottom: 2px solid rgba(34, 197, 94, 0.1);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
            <div style="flex: 1;">
              <span class="policy-type-badge" style="display: inline-flex; align-items: center; gap: 6px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">
                <i class="fas ${typeIcon}"></i> ${policyType.replace('_', ' ')}
              </span>
              <h3 class="policy-title" style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin: 0; line-height: 1.3;">
                ${escapeHtml(policyName)}
              </h3>
              ${policyCode ? `
              <p style="font-size: 12px; color: var(--text-secondary); margin: 4px 0 0 0;">
                <i class="fas fa-hashtag"></i> ${escapeHtml(policyCode)}
              </p>
              ` : ''}
            </div>
            <span class="status-badge" style="background: ${statusStyle.bg}; color: ${statusStyle.text}; border: 2px solid ${statusStyle.border}; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; white-space: nowrap;">
              ${status}
            </span>
          </div>
        </div>

        <div class="policy-body" style="padding: 20px 24px;">
          <p class="policy-description" style="color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
            ${escapeHtml(description.substring(0, 200))}${description.length > 200 ? '...' : ''}
          </p>

          <div class="policy-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
            ${effectiveDate ? `
            <div class="policy-detail-item" style="padding: 12px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6; border-radius: 8px;">
              <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">
                <i class="fas fa-calendar-check" style="color: #3b82f6;"></i> Effective Date
              </label>
              <value style="font-weight: 700; color: var(--text-primary); font-size: 14px;">${effectiveDate}</value>
            </div>
            ` : ''}
            
            ${expiryDate ? `
            <div class="policy-detail-item" style="padding: 12px; background: ${isExpiringSoon ? 'rgba(245, 158, 11, 0.1)' : 'rgba(107, 114, 128, 0.1)'}; border-left: 3px solid ${isExpiringSoon ? '#f59e0b' : '#6b7280'}; border-radius: 8px;">
              <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">
                <i class="fas fa-calendar-times" style="color: ${isExpiringSoon ? '#f59e0b' : '#6b7280'};"></i> Expiry Date
              </label>
              <value style="font-weight: 700; color: var(--text-primary); font-size: 14px;">${expiryDate}</value>
            </div>
            ` : ''}
            
            ${totalBudget ? `
            <div class="policy-detail-item" style="padding: 12px; background: rgba(34, 197, 94, 0.1); border-left: 3px solid var(--primary-green); border-radius: 8px;">
              <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">
                <i class="fas fa-dollar-sign" style="color: var(--primary-green);"></i> Total Budget
              </label>
              <value style="font-weight: 700; color: var(--text-primary); font-size: 14px;">${totalBudget}</value>
            </div>
            ` : ''}
            
            ${implementingAgency ? `
            <div class="policy-detail-item" style="padding: 12px; background: rgba(139, 92, 246, 0.1); border-left: 3px solid #8b5cf6; border-radius: 8px;">
              <label style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">
                <i class="fas fa-building" style="color: #8b5cf6;"></i> Agency
              </label>
              <value style="font-weight: 600; color: var(--text-primary); font-size: 13px;">${escapeHtml(implementingAgency.substring(0, 30))}${implementingAgency.length > 30 ? '...' : ''}</value>
            </div>
            ` : ''}
          </div>

          ${eligibility ? `
          <div style="padding: 12px; background: rgba(59, 130, 246, 0.05); border-left: 3px solid #3b82f6; border-radius: 8px; margin-bottom: 16px;">
            <strong style="font-size: 12px; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
              <i class="fas fa-users" style="color: #3b82f6;"></i> Eligibility
            </strong>
            <p style="color: var(--text-secondary); font-size: 13px; margin: 0; line-height: 1.6;">
              ${escapeHtml(typeof eligibility === 'string' ? eligibility.substring(0, 150) : JSON.stringify(eligibility).substring(0, 150))}${(typeof eligibility === 'string' ? eligibility.length : JSON.stringify(eligibility).length) > 150 ? '...' : ''}
            </p>
          </div>
          ` : ''}

          ${benefits ? `
          <div style="padding: 12px; background: rgba(34, 197, 94, 0.05); border-left: 3px solid var(--primary-green); border-radius: 8px; margin-bottom: 16px;">
            <strong style="font-size: 12px; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
              <i class="fas fa-gift" style="color: var(--primary-green);"></i> Benefits
            </strong>
            <p style="color: var(--text-secondary); font-size: 13px; margin: 0; line-height: 1.6;">
              ${escapeHtml(benefits.substring(0, 150))}${benefits.length > 150 ? '...' : ''}
            </p>
          </div>
          ` : ''}
        </div>

        <div class="policy-footer" style="padding: 16px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
          ${deadline ? `
          <div style="font-size: 12px; color: var(--text-secondary);">
            <i class="fas fa-clock" style="color: #f59e0b;"></i>
            <strong>Deadline:</strong> ${deadline}
          </div>
          ` : `
          <div style="font-size: 12px; color: var(--text-secondary);">
            <i class="fas fa-info-circle"></i>
            ${geographicScope || 'General Policy'}
          </div>
          `}
          <button class="btn btn-primary" onclick="viewPolicyDetails('${policyId}')" style="padding: 8px 20px; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
            <i class="fas fa-eye"></i>
            View Details
          </button>
        </div>
      </div>
    `;
  }).filter(html => html !== '').join('');

  // Si aucune policy valide
  if (container.innerHTML.trim() === '') {
    displayEmptyPoliciesState('No valid policy data to display');
  }
}

/**
 * Display empty policies state
 */
function displayEmptyPoliciesState(message = null) {
  const container = document.getElementById('policiesGrid');
  if (container) {
    const defaultMessage = 'No policies available at the moment. Check back later for new agricultural policies and subsidies.';
    container.innerHTML = `
      <div class="empty-state" style="padding: 4rem 2rem; text-align: center;">
        <div style="width: 100px; height: 100px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
          <i class="fas fa-gavel" style="font-size: 3rem; color: var(--primary-green);"></i>
        </div>
        <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.5rem;">No Policies Available</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto;">
          ${message || defaultMessage}
        </p>
        <button class="btn btn-primary" onclick="loadPoliciesData()" style="margin-top: 1rem;">
          <i class="fas fa-sync-alt"></i>
          Refresh
        </button>
      </div>
    `;
  }
}




/**
 * View policy details - IMPROVED VERSION
 */
async function viewPolicyDetails(policyId) {
  if (!policyId) {
    showToast('❌ Invalid policy ID', 'error');
    return;
  }

  try {
    showLoading();

    // ✅ Try to find in local data first (faster)
    let policy = null;
    if (allPoliciesData && allPoliciesData.length > 0) {
      policy = allPoliciesData.find(p => p.id === policyId || p.policyCode === policyId);
    }

    // ✅ If not found locally, fetch from API
    if (!policy) {
      try {
        const response = await apiRequest(`/policies/${policyId}`);
        
        // Handle different response formats
        if (response) {
          if (response.data) {
            policy = response.data;
          } else if (response.id || response.policyCode) {
            policy = response;
          } else if (Array.isArray(response) && response.length > 0) {
            policy = response[0];
          }
        }

        if (!policy) {
          // Try by policy code
          try {
            const codeResponse = await apiRequest(`/policies/code/${policyId}`);
            if (codeResponse && codeResponse.data) {
              policy = codeResponse.data;
            } else if (codeResponse && codeResponse.id) {
              policy = codeResponse;
            }
          } catch (codeError) {
            console.warn('⚠️ Policy not found by code:', codeError.message);
          }
        }
      } catch (apiError) {
        console.error('❌ Error loading policy from API:', apiError);
        // If API fails, try local data again
        if (allPoliciesData && allPoliciesData.length > 0) {
          policy = allPoliciesData.find(p => p.id === policyId || p.policyCode === policyId);
        }
      }
    }

    if (!policy) {
      showToast('❌ Policy not found', 'error');
      hideLoading();
      return;
    }

    console.log('✅ Policy loaded:', policy);
    showPolicyDetailsModal(policy);

  } catch (error) {
    console.error('❌ Error in viewPolicyDetails:', error);
    showToast('❌ Error loading policy details: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}




/**
 * Show policy details modal - VERSION CORRIGÉE
 */
function showPolicyDetailsModal(policy) {
  if (!policy) {
    showToast('❌ Invalid policy data', 'error');
    return;
  }

  // ✅ Mapping des champs corrects selon le modèle backend
  const policyName = policy.policyName || 'Unnamed Policy';
  const policyCode = policy.policyCode || 'N/A';
  const policyType = policy.policyType || 'N/A';
  const policyCategory = policy.policyCategory || 'N/A';
  const status = policy.status || 'UNKNOWN';
  const statusLower = status.toLowerCase();

  const description = policy.description || 'No description available';
  const objectives = policy.objectives || null;
  const targetBeneficiaries = policy.targetBeneficiaries || null;
  const eligibilityCriteria = policy.eligibilityCriteria || null;
  const benefits = policy.benefits || null;
  const applicationProcedure = policy.applicationProcedure || null;
  const requiredDocuments = policy.requiredDocuments || null;
  const implementingAgency = policy.implementingAgency || null;
  const contactInformation = policy.contactInformation || null;
  const geographicScope = policy.geographicScope || null;

  const effectiveDate = policy.effectiveDate ? formatDate(policy.effectiveDate) : 'N/A';
  const expiryDate = policy.expiryDate ? formatDate(policy.expiryDate) : 'N/A';
  const lastReviewDate = policy.lastReviewDate ? formatDate(policy.lastReviewDate) : null;
  const nextReviewDate = policy.nextReviewDate ? formatDate(policy.nextReviewDate) : null;

  const totalBudgetAllocated = policy.totalBudgetAllocated
    ? formatCurrency(policy.totalBudgetAllocated)
    : null;
  const budgetUtilized = policy.budgetUtilized
    ? formatCurrency(policy.budgetUtilized)
    : null;
  const totalBeneficiaries = policy.totalBeneficiaries || null;
  const utilizationRate = policy.utilizationRate || null;

  const isClimateSmartCompliant = policy.isClimateSmartCompliant || false;
  const isYouthFocused = policy.isYouthFocused || false;

  const modalHTML = `
    <div class="modal-overlay show" id="policyModal" onclick="if(event.target === this) closePolicyModal()">
      <div class="modal-container modal-large">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-gavel"></i>
            ${policyName}
          </h3>
          <button class="modal-close" onclick="closePolicyModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="policy-full-details">

            <!-- Basic Information -->
            <div class="detail-section">
              <h4><i class="fas fa-info-circle"></i> Policy Information</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <label>Policy Code:</label>
                  <value>${policyCode}</value>
                </div>
                <div class="detail-item">
                  <label>Type:</label>
                  <value>${policyType}</value>
                </div>
                <div class="detail-item">
                  <label>Category:</label>
                  <value>${policyCategory}</value>
                </div>
                <div class="detail-item">
                  <label>Status:</label>
                  <value><span class="status-badge status-${statusLower}">${status}</span></value>
                </div>
                <div class="detail-item">
                  <label>Effective Date:</label>
                  <value>${effectiveDate}</value>
                </div>
                <div class="detail-item">
                  <label>Expiry Date:</label>
                  <value>${expiryDate}</value>
                </div>
                ${geographicScope ? `
                <div class="detail-item">
                  <label>Geographic Scope:</label>
                  <value>${geographicScope}</value>
                </div>
                ` : ''}
                ${implementingAgency ? `
                <div class="detail-item">
                  <label>Implementing Agency:</label>
                  <value>${implementingAgency}</value>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Description -->
            <div class="detail-section">
              <h4><i class="fas fa-file-alt"></i> Description</h4>
              <p>${description}</p>
            </div>

            <!-- Objectives -->
            ${objectives ? `
            <div class="detail-section">
              <h4><i class="fas fa-bullseye"></i> Objectives</h4>
              <p>${objectives}</p>
            </div>
            ` : ''}

            <!-- Target Beneficiaries -->
            ${targetBeneficiaries ? `
            <div class="detail-section">
              <h4><i class="fas fa-users"></i> Target Beneficiaries</h4>
              <p>${targetBeneficiaries}</p>
            </div>
            ` : ''}

            <!-- Eligibility Criteria -->
            ${eligibilityCriteria ? `
            <div class="detail-section">
              <h4><i class="fas fa-check-circle"></i> Eligibility Criteria</h4>
              <p>${eligibilityCriteria}</p>
            </div>
            ` : ''}

            <!-- Benefits -->
            ${benefits ? `
            <div class="detail-section">
              <h4><i class="fas fa-gift"></i> Benefits</h4>
              <p>${benefits}</p>
            </div>
            ` : ''}

            <!-- Application Procedure -->
            ${applicationProcedure ? `
            <div class="detail-section">
              <h4><i class="fas fa-clipboard-list"></i> Application Procedure</h4>
              <p>${applicationProcedure}</p>
            </div>
            ` : ''}

            <!-- Required Documents -->
            ${requiredDocuments ? `
            <div class="detail-section">
              <h4><i class="fas fa-file-pdf"></i> Required Documents</h4>
              <p>${requiredDocuments}</p>
            </div>
            ` : ''}

            <!-- Budget Information -->
            ${totalBudgetAllocated || budgetUtilized ? `
            <div class="detail-section">
              <h4><i class="fas fa-money-bill-wave"></i> Budget Information</h4>
              <div class="details-grid">
                ${totalBudgetAllocated ? `
                <div class="detail-item">
                  <label>Total Budget Allocated:</label>
                  <value>${totalBudgetAllocated}</value>
                </div>
                ` : ''}
                ${budgetUtilized ? `
                <div class="detail-item">
                  <label>Budget Utilized:</label>
                  <value>${budgetUtilized}</value>
                </div>
                ` : ''}
                ${utilizationRate ? `
                <div class="detail-item">
                  <label>Utilization Rate:</label>
                  <value>${utilizationRate}%</value>
                </div>
                ` : ''}
              </div>
            </div>
            ` : ''}

            <!-- Performance Metrics -->
            ${totalBeneficiaries ? `
            <div class="detail-section">
              <h4><i class="fas fa-chart-line"></i> Performance Metrics</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <label>Total Beneficiaries:</label>
                  <value>${totalBeneficiaries.toLocaleString()}</value>
                </div>
              </div>
            </div>
            ` : ''}

            <!-- Review Dates -->
            ${lastReviewDate || nextReviewDate ? `
            <div class="detail-section">
              <h4><i class="fas fa-calendar-check"></i> Review Schedule</h4>
              <div class="details-grid">
                ${lastReviewDate ? `
                <div class="detail-item">
                  <label>Last Review Date:</label>
                  <value>${lastReviewDate}</value>
                </div>
                ` : ''}
                ${nextReviewDate ? `
                <div class="detail-item">
                  <label>Next Review Date:</label>
                  <value>${nextReviewDate}</value>
                </div>
                ` : ''}
              </div>
            </div>
            ` : ''}

            <!-- Special Attributes -->
            ${isClimateSmartCompliant || isYouthFocused ? `
            <div class="detail-section">
              <h4><i class="fas fa-star"></i> Special Attributes</h4>
              <div class="badges-list">
                ${isClimateSmartCompliant ? `
                  <span class="badge badge-success">
                    <i class="fas fa-leaf"></i>
                    Climate Smart Compliant
                  </span>
                ` : ''}
                ${isYouthFocused ? `
                  <span class="badge badge-info">
                    <i class="fas fa-user-graduate"></i>
                    Youth Focused
                  </span>
                ` : ''}
              </div>
            </div>
            ` : ''}

            <!-- Contact Information -->
            ${contactInformation ? `
            <div class="detail-section">
              <h4><i class="fas fa-phone"></i> Contact Information</h4>
              <p>${contactInformation}</p>
            </div>
            ` : ''}

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closePolicyModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
          ${status === 'ACTIVE' && applicationProcedure ? `
            <button type="button" class="btn btn-primary" onclick="showApplicationInfo('${policy.id}')">
              <i class="fas fa-paper-plane"></i>
              How to Apply
            </button>
          ` : ''}
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Show application information
 */
function showApplicationInfo(policyId) {
  showToast('ℹ️ Please contact the implementing agency for application details', 'info');
}

    /**
     * Close policy modal
     */
    function closePolicyModal() {
      document.getElementById('modalContainer').innerHTML = '';
    }






















    /**
     * Apply for policy
     */
    function applyForPolicy(policyId) {
      showToast('Policy application feature - To be implemented', 'info');
    }

    // ============================================================================
    // AI RECOMMENDATIONS MODULE - COMPLETE IMPLEMENTATION
    // ============================================================================

    // Store recommendations globally for filtering
    let allRecommendationsData = [];
    let aiChatHistory = [];

    /**
     * Load recommendations data - IMPROVED VERSION
     */
    async function loadRecommendationsData() {
      try {
        showLoading();
        console.log('🤖 Loading AI recommendations...');

        if (!currentUser || !currentUser.id) {
          console.error('❌ No current user found');
          displayEmptyRecommendationsState('No user session found. Please login again.');
          hideLoading();
          return;
        }

        const farmerId = currentUser.id;

        // ✅ STEP 1: Get recommendations from database
        let databaseRecommendations = [];
        try {
          const response = await apiRequest(`/ai-recommendations/farmer/${farmerId}`);
          
          if (Array.isArray(response)) {
            databaseRecommendations = response;
          } else if (response && response.data && Array.isArray(response.data)) {
            databaseRecommendations = response.data;
          } else if (response && response.content && Array.isArray(response.content)) {
            databaseRecommendations = response.content;
          }
          
          console.log(`✅ Loaded ${databaseRecommendations.length} recommendations from database`);
        } catch (error) {
          console.warn('⚠️ Error loading recommendations from database:', error.message);
          databaseRecommendations = [];
        }

        // ✅ STEP 2: Generate AI recommendations based on real data
        console.log('🤖 Generating AI recommendations based on real farm data...');
        const aiRecommendations = await generateAIRecommendationsFromData();

        // ✅ STEP 3: Combine database and AI recommendations
        const allRecommendations = [...databaseRecommendations, ...aiRecommendations];
        
        // Sort by priority and confidence
        allRecommendations.sort((a, b) => {
          const priorityOrder = { 'URGENT': 4, 'HIGH': 3, 'MEDIUM': 2, 'LOW': 1 };
          const aPriority = priorityOrder[a.priority] || 0;
          const bPriority = priorityOrder[b.priority] || 0;
          if (aPriority !== bPriority) return bPriority - aPriority;
          
          const aConfidence = a.confidenceScore || 0;
          const bConfidence = b.confidenceScore || 0;
          return bConfidence - aConfidence;
        });

        console.log(`✅ Total recommendations: ${allRecommendations.length} (${databaseRecommendations.length} from DB, ${aiRecommendations.length} AI-generated)`);

        // ✅ STEP 4: Store globally for filtering
        allRecommendationsData = allRecommendations;

        // ✅ STEP 5: Update statistics
        updateRecommendationsStatistics(allRecommendations);

        // ✅ STEP 6: Display recommendations
        displayRecommendationsGrid(allRecommendations);

        // ✅ STEP 7: Render comparison charts
        renderComparisonCharts();

        if (allRecommendations.length > 0) {
          showToast(`✅ Loaded ${allRecommendations.length} recommendations`, 'success');
        }

      } catch (error) {
        console.error('❌ Error loading recommendations:', error);
        showToast('Error loading recommendations: ' + error.message, 'error');
        displayEmptyRecommendationsState('Error loading recommendations. Please try again.');
      } finally {
        hideLoading();
      }
    }

    /**
     * Generate AI recommendations based on real farm data
     */
    async function generateAIRecommendationsFromData() {
      const recommendations = [];
      
      try {
        if (!currentUser || !currentUser.id) {
          return recommendations;
        }

        const farmerId = currentUser.id;

        // ✅ Collect all real data
        const [farms, productions, inventory, weatherData, transactions, soilData, fertilizerUsage, irrigationData] = await Promise.all([
          apiRequest(`/farms/farmer/${farmerId}/all`).catch(() => []),
          apiRequest(`/v1/crop-productions/farmer/${farmerId}`).catch(() => ({ data: [] })),
          apiRequest(`/v1/inventories/farmer/${farmerId}`).catch(() => []),
          apiRequest(`/weather-data/recent?days=30`).catch(() => []),
          apiRequest(`/transactions/farmer/${farmerId}`).catch(() => []),
          apiRequest(`/v1/soil-data/farmer/${farmerId}`).catch(() => []),
          apiRequest(`/fertilizer-usages/farmer/${farmerId}`).catch(() => ({ content: [] })),
          apiRequest(`/irrigation/farmer/${farmerId}`).catch(() => ({ data: [] }))
        ]);

        const farmsList = Array.isArray(farms) ? farms : [];
        const productionsList = Array.isArray(productions) ? productions : 
                               (productions.data && Array.isArray(productions.data) ? productions.data : []);
        const inventoryList = Array.isArray(inventory) ? inventory : [];
        const weatherList = Array.isArray(weatherData) ? weatherData : [];
        const transactionsList = Array.isArray(transactions) ? transactions : 
                                (transactions.content && Array.isArray(transactions.content) ? transactions.content : []);
        const soilList = Array.isArray(soilData) ? soilData : [];
        // ✅ Parse fertilizer usage response (returns { content: [], totalElements: 0, ... })
        const fertilizerList = Array.isArray(fertilizerUsage) ? fertilizerUsage : 
                              (fertilizerUsage.content && Array.isArray(fertilizerUsage.content) ? fertilizerUsage.content : []);
        // ✅ Parse irrigation data response (returns { data: [], success: true, ... } or direct array)
        const irrigationList = Array.isArray(irrigationData) ? irrigationData : 
                               (irrigationData.data && Array.isArray(irrigationData.data) ? irrigationData.data : []);

        console.log(`📊 Analyzing: ${farmsList.length} farms, ${productionsList.length} productions, ${inventoryList.length} inventory, ${weatherList.length} weather, ${soilList.length} soil records`);

        // ✅ RECOMMENDATION 1: Fertilizer Optimization
        if (fertilizerList.length > 0) {
          const recentFertilizer = fertilizerList.slice(-5);
          const avgEffectiveness = recentFertilizer
            .map(f => parseFloat(f.effectivenessRating || 0))
            .filter(r => !isNaN(r))
            .reduce((a, b) => a + b, 0) / recentFertilizer.length;

          if (avgEffectiveness < 3) {
            recommendations.push({
              id: 'AI-FERTILIZER-' + Date.now(),
              farmerId: farmerId,
              recommendationType: 'FERTILIZER',
              title: 'Optimize Fertilizer Application',
              description: `Your recent fertilizer applications show an average effectiveness rating of ${avgEffectiveness.toFixed(1)}/5. Consider adjusting fertilizer types, quantities, or application timing based on soil analysis.`,
              actionItems: `1. Review soil test results\n2. Adjust fertilizer NPK ratios\n3. Consider organic alternatives\n4. Time applications with crop growth stages\n5. Monitor crop response`,
              priority: avgEffectiveness < 2 ? 'URGENT' : 'HIGH',
              confidenceScore: 0.85,
              generatedBy: 'AI Analysis System',
              isRead: false,
              isImplemented: false,
              isActive: true,
              validFrom: new Date().toISOString(),
              createdAt: new Date().toISOString()
            });
          }
        }

        // ✅ RECOMMENDATION 2: Irrigation Optimization
        if (irrigationList.length > 0) {
          const recentIrrigation = irrigationList.slice(-7);
          const avgEfficiency = recentIrrigation
            .map(i => parseFloat(i.waterEfficiency || 0))
            .filter(e => !isNaN(e))
            .reduce((a, b) => a + b, 0) / recentIrrigation.length;

          if (avgEfficiency < 70) {
            recommendations.push({
              id: 'AI-IRRIGATION-' + Date.now(),
              farmerId: farmerId,
              recommendationType: 'IRRIGATION',
              title: 'Improve Water Efficiency',
              description: `Your irrigation water efficiency is ${avgEfficiency.toFixed(1)}%. Consider implementing drip irrigation, scheduling based on weather forecasts, and monitoring soil moisture levels.`,
              actionItems: `1. Install soil moisture sensors\n2. Schedule irrigation during cooler hours\n3. Use mulching to retain moisture\n4. Consider drip irrigation systems\n5. Monitor weather forecasts`,
              priority: avgEfficiency < 50 ? 'URGENT' : 'HIGH',
              confidenceScore: 0.80,
              generatedBy: 'AI Analysis System',
              isRead: false,
              isImplemented: false,
              isActive: true,
              validFrom: new Date().toISOString(),
              createdAt: new Date().toISOString()
            });
          }
        }

        // ✅ RECOMMENDATION 3: Soil Health
        if (soilList.length > 0) {
          const recentSoil = soilList.slice(-3);
          const avgPh = recentSoil
            .map(s => parseFloat(s.phLevel))
            .filter(p => !isNaN(p))
            .reduce((a, b) => a + b, 0) / recentSoil.length;

          if (avgPh < 6.0 || avgPh > 7.5) {
            recommendations.push({
              id: 'AI-SOIL-' + Date.now(),
              farmerId: farmerId,
              recommendationType: 'SOIL_MANAGEMENT',
              title: 'Soil pH Adjustment Needed',
              description: `Your soil pH is ${avgPh.toFixed(2)} (optimal range: 6.0-7.5). ${avgPh < 6.0 ? 'Apply lime to raise pH.' : 'Apply sulfur to lower pH.'} This will improve nutrient availability and crop yields.`,
              actionItems: `1. Test soil pH regularly\n2. ${avgPh < 6.0 ? 'Apply agricultural lime' : 'Apply elemental sulfur'}\n3. Monitor pH changes over time\n4. Adjust fertilizer applications accordingly\n5. Consider organic matter amendments`,
              priority: 'HIGH',
              confidenceScore: 0.90,
              generatedBy: 'AI Analysis System',
              isRead: false,
              isImplemented: false,
              isActive: true,
              validFrom: new Date().toISOString(),
              createdAt: new Date().toISOString()
            });
          }
        }

        // ✅ RECOMMENDATION 4: Production Timing
        if (productionsList.length > 0) {
          const activeProductions = productionsList.filter(p => 
            p.status === 'ACTIVE' || p.status === 'IN_PROGRESS'
          );

          activeProductions.forEach(production => {
            if (production.expectedHarvestDate) {
              const harvestDate = new Date(production.expectedHarvestDate);
              const today = new Date();
              const daysUntilHarvest = Math.ceil((harvestDate - today) / (1000 * 60 * 60 * 24));

              if (daysUntilHarvest <= 30 && daysUntilHarvest > 0) {
                recommendations.push({
                  id: 'AI-HARVEST-' + Date.now() + '-' + production.id,
                  farmerId: farmerId,
                  cropProductionId: production.id,
                  recommendationType: 'HARVEST',
                  title: `Prepare for Harvest: ${production.cropName || 'Crop'}`,
                  description: `Your ${production.cropName || 'crop'} is expected to be ready for harvest in ${daysUntilHarvest} days. Start preparing harvesting equipment, storage facilities, and market connections.`,
                  actionItems: `1. Inspect crop maturity\n2. Prepare harvesting equipment\n3. Arrange storage facilities\n4. Contact buyers/markets\n5. Plan post-harvest handling\n6. Check weather forecasts`,
                  priority: daysUntilHarvest <= 7 ? 'URGENT' : 'HIGH',
                  confidenceScore: 0.75,
                  generatedBy: 'AI Analysis System',
                  isRead: false,
                  isImplemented: false,
                  isActive: true,
                  validFrom: new Date().toISOString(),
                  createdAt: new Date().toISOString()
                });
              }
            }
          });
        }

        // ✅ RECOMMENDATION 5: Weather Adaptation
        if (weatherList.length > 0) {
          const recentWeather = weatherList.slice(0, 7);
          const avgTemp = recentWeather
            .map(w => parseFloat(w.temperature))
            .filter(t => !isNaN(t))
            .reduce((a, b) => a + b, 0) / recentWeather.length;
          
          const totalRainfall = recentWeather
            .map(w => parseFloat(w.rainfall || 0))
            .filter(r => !isNaN(r))
            .reduce((a, b) => a + b, 0);

          if (avgTemp > 35 || totalRainfall < 5) {
            recommendations.push({
              id: 'AI-WEATHER-' + Date.now(),
              farmerId: farmerId,
              recommendationType: 'WEATHER_ADAPTATION',
              title: 'Weather Adaptation Required',
              description: `${avgTemp > 35 ? `High temperatures (${avgTemp.toFixed(1)}°C) detected.` : ''} ${totalRainfall < 5 ? `Low rainfall (${totalRainfall.toFixed(2)}mm) in the last 7 days.` : ''} Adjust your farming practices to adapt to current weather conditions.`,
              actionItems: `${avgTemp > 35 ? '1. Increase irrigation frequency\n2. Provide shade for sensitive crops\n3. Apply mulch to retain moisture\n' : ''}${totalRainfall < 5 ? '4. Schedule additional irrigation\n5. Monitor soil moisture daily\n6. Consider drought-resistant varieties\n' : ''}7. Check weather forecasts regularly`,
              priority: avgTemp > 40 || totalRainfall < 2 ? 'URGENT' : 'HIGH',
              confidenceScore: 0.85,
              generatedBy: 'AI Analysis System',
              isRead: false,
              isImplemented: false,
              isActive: true,
              validFrom: new Date().toISOString(),
              createdAt: new Date().toISOString()
            });
          }
        }

        // ✅ RECOMMENDATION 6: Inventory Management
        if (inventoryList.length > 0) {
          const lowStockItems = inventoryList.filter(item => {
            const available = parseFloat(item.availableQuantity || 0);
            const total = parseFloat(item.totalQuantity || 0);
            return available > 0 && total > 0 && (available / total) < 0.2;
          });

          if (lowStockItems.length > 0) {
            recommendations.push({
              id: 'AI-INVENTORY-' + Date.now(),
              farmerId: farmerId,
              recommendationType: 'GENERAL',
              title: 'Restock Inventory Items',
              description: `${lowStockItems.length} inventory item(s) have low stock levels (less than 20% remaining). Restock soon to avoid production delays.`,
              actionItems: `1. Review inventory levels\n2. Identify critical items\n3. Contact suppliers\n4. Plan restocking schedule\n5. Consider bulk purchasing for discounts`,
              priority: lowStockItems.length > 5 ? 'URGENT' : 'MEDIUM',
              confidenceScore: 0.70,
              generatedBy: 'AI Analysis System',
              isRead: false,
              isImplemented: false,
              isActive: true,
              validFrom: new Date().toISOString(),
              createdAt: new Date().toISOString()
            });
          }
        }

        // ✅ RECOMMENDATION 7: Market Timing
        if (transactionsList.length > 0) {
          const recentTransactions = transactionsList
            .filter(t => t.status === 'PAID' || t.status === 'COMPLETED')
            .slice(-10);
          
          if (recentTransactions.length > 0) {
            const avgPrice = recentTransactions
              .map(t => parseFloat(t.pricePerUnit || 0))
              .filter(p => !isNaN(p) && p > 0)
              .reduce((a, b) => a + b, 0) / recentTransactions.length;

            // Check if there are active productions that could be sold
            const activeProductions = productionsList.filter(p => 
              (p.status === 'ACTIVE' || p.status === 'IN_PROGRESS') && 
              p.expectedHarvestDate &&
              new Date(p.expectedHarvestDate) <= new Date(Date.now() + 60 * 24 * 60 * 60 * 1000)
            );

            if (activeProductions.length > 0 && avgPrice > 0) {
              recommendations.push({
                id: 'AI-MARKET-' + Date.now(),
                farmerId: farmerId,
                recommendationType: 'MARKET_TIMING',
                title: 'Market Timing Opportunity',
                description: `You have ${activeProductions.length} production(s) nearing harvest. Recent market prices average ${formatCurrency(avgPrice)} per unit. Consider pre-selling or timing your harvest to maximize profits.`,
                actionItems: `1. Monitor current market prices\n2. Contact potential buyers\n3. Consider pre-selling contracts\n4. Time harvest for optimal prices\n5. Compare prices across markets`,
                priority: 'MEDIUM',
                confidenceScore: 0.65,
                generatedBy: 'AI Analysis System',
                isRead: false,
                isImplemented: false,
                isActive: true,
                validFrom: new Date().toISOString(),
                createdAt: new Date().toISOString()
              });
            }
          }
        }

        console.log(`✅ Generated ${recommendations.length} AI recommendations`);

      } catch (error) {
        console.error('❌ Error generating AI recommendations:', error);
      }

      return recommendations;
    }

    /**
     * Generate comprehensive AI recommendations (called by button)
     */
    async function generateAIRecommendations() {
      try {
        const btn = document.getElementById('generateAIRecommendationsBtn');
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        }

        showLoading();
        showToast('🤖 Generating comprehensive AI recommendations...', 'info');

        // Generate and reload
        await loadRecommendationsData();

        showToast('✅ AI recommendations generated successfully!', 'success');

      } catch (error) {
        console.error('❌ Error generating recommendations:', error);
        showToast('❌ Error generating recommendations: ' + error.message, 'error');
      } finally {
        const btn = document.getElementById('generateAIRecommendationsBtn');
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-brain"></i> Generate AI Analysis';
        }
        hideLoading();
      }
    }

    /**
     * Display recommendations grid
     */
    /**
     * Display recommendations grid - IMPROVED VERSION
     */
    function displayRecommendationsGrid(recommendations) {
      const container = document.getElementById('recommendationsGrid');
      if (!container) {
        console.warn('⚠️ recommendationsGrid container not found');
        return;
      }

      if (!recommendations || recommendations.length === 0) {
        displayEmptyRecommendationsState('No recommendations available. Click "Generate AI Analysis" to get personalized recommendations.');
        return;
      }

      console.log(`📊 Displaying ${recommendations.length} recommendations`);

      container.innerHTML = recommendations.map(rec => {
        if (!rec || !rec.title) {
          return '';
        }

        const recType = rec.recommendationType || 'GENERAL';
        const priority = rec.priority || 'MEDIUM';
        const priorityLower = priority.toLowerCase();
        const confidence = rec.confidenceScore || 0.5;
        const isAIGenerated = rec.generatedBy === 'AI Analysis System' || rec.id.startsWith('AI-');
        const actionItems = rec.actionItems || '';

        // Priority colors
        const priorityColors = {
          'urgent': { bg: 'rgba(239, 68, 68, 0.15)', border: '#ef4444', text: '#ef4444' },
          'high': { bg: 'rgba(245, 158, 11, 0.15)', border: '#f59e0b', text: '#f59e0b' },
          'medium': { bg: 'rgba(59, 130, 246, 0.15)', border: '#3b82f6', text: '#3b82f6' },
          'low': { bg: 'rgba(139, 92, 246, 0.15)', border: '#8b5cf6', text: '#8b5cf6' }
        };

        const priorityStyle = priorityColors[priorityLower] || priorityColors['medium'];

        // Type icons
        const typeIcons = {
          'FERTILIZER': 'fa-seedling',
          'WATER': 'fa-tint',
          'IRRIGATION': 'fa-water',
          'SEEDS': 'fa-seedling',
          'PESTICIDE': 'fa-spray-can',
          'SOIL_MANAGEMENT': 'fa-mountain',
          'HARVEST': 'fa-hand-holding',
          'PLANTING': 'fa-seedling',
          'WEATHER_ADAPTATION': 'fa-cloud-sun',
          'MARKET_TIMING': 'fa-chart-line',
          'GENERAL': 'fa-lightbulb'
        };

        const typeIcon = typeIcons[recType] || 'fa-lightbulb';

        return `
          <div class="recommendation-card" style="background: var(--card-bg); border-radius: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); border: 2px solid ${priorityStyle.border}; overflow: hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative;">
            ${isAIGenerated ? `
            <div style="position: absolute; top: 12px; right: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; z-index: 10;">
              <i class="fas fa-brain"></i> AI
            </div>
            ` : ''}
            
            <div class="recommendation-header" style="padding: 24px 24px 16px; background: linear-gradient(135deg, ${priorityStyle.bg}, rgba(255,255,255,0.1)); border-bottom: 2px solid ${priorityStyle.border};">
              <div style="display: flex; align-items: flex-start; gap: 16px;">
                <div style="width: 60px; height: 60px; background: ${priorityStyle.bg}; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                  <i class="fas ${typeIcon}" style="font-size: 28px; color: ${priorityStyle.border};"></i>
                </div>
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                    <div>
                      <span style="display: inline-block; background: ${priorityStyle.border}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px;">
                        ${recType.replace('_', ' ')}
                      </span>
                      <h3 style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin: 0; line-height: 1.3;">
                        ${escapeHtml(rec.title)}
                      </h3>
                    </div>
                    <span style="background: ${priorityStyle.bg}; color: ${priorityStyle.text}; border: 2px solid ${priorityStyle.border}; padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; white-space: nowrap;">
                      ${priority}
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="recommendation-body" style="padding: 20px 24px;">
              <p style="color: var(--text-secondary); line-height: 1.7; margin-bottom: 20px;">
                ${escapeHtml(rec.description)}
              </p>

              ${actionItems ? `
              <div style="padding: 16px; background: rgba(34, 197, 94, 0.05); border-left: 4px solid var(--primary-green); border-radius: 8px; margin-bottom: 16px;">
                <strong style="font-size: 13px; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; margin-bottom: 12px;">
                  <i class="fas fa-tasks" style="color: var(--primary-green);"></i> Recommended Actions
                </strong>
                <div style="color: var(--text-secondary); font-size: 14px; line-height: 1.8; white-space: pre-line;">
                  ${escapeHtml(actionItems)}
                </div>
              </div>
              ` : ''}

              <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                <div style="flex: 1;">
                  <div style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 4px;">AI Confidence</div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="flex: 1; height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden;">
                      <div style="height: 100%; width: ${(confidence * 100)}%; background: linear-gradient(90deg, ${priorityStyle.border}, ${priorityStyle.text}); transition: width 0.3s;"></div>
                    </div>
                    <span style="font-weight: 700; color: ${priorityStyle.text}; font-size: 14px;">${(confidence * 100).toFixed(0)}%</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="recommendation-footer" style="padding: 16px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
              <div style="font-size: 12px; color: var(--text-secondary);">
                <i class="fas fa-calendar-alt" style="color: ${priorityStyle.border};"></i>
                ${rec.createdAt ? formatDateTime(rec.createdAt) : 'Just now'}
              </div>
              <div style="display: flex; gap: 8px;">
                ${!rec.isRead ? `
                <button class="btn btn-secondary btn-sm" onclick="markRecommendationAsRead('${rec.id}')" style="padding: 6px 14px; font-size: 12px;">
                  <i class="fas fa-check"></i> Mark Read
                </button>
                ` : ''}
                <button class="btn btn-primary btn-sm" onclick="viewRecommendationDetails('${rec.id}')" style="padding: 6px 14px; font-size: 12px;">
                  <i class="fas fa-eye"></i> Details
                </button>
              </div>
            </div>
          </div>
        `;
      }).filter(html => html !== '').join('');
    }

    /**
     * Update recommendations statistics
     */
    function updateRecommendationsStatistics(recommendations) {
      if (!recommendations || recommendations.length === 0) {
        updateElement('recommendationsTotalCount', '0');
        updateElement('recommendationsUrgentCount', '0');
        updateElement('recommendationsImplementedCount', '0');
        updateElement('aiConfidenceScore', '--');
        return;
      }

      const total = recommendations.length;
      const urgent = recommendations.filter(r => r.priority === 'URGENT').length;
      const implemented = recommendations.filter(r => r.isImplemented === true).length;
      const avgConfidence = recommendations
        .map(r => r.confidenceScore || 0)
        .reduce((a, b) => a + b, 0) / recommendations.length;

      updateElement('recommendationsTotalCount', total);
      updateElement('recommendationsUrgentCount', urgent);
      updateElement('recommendationsImplementedCount', implemented);
      updateElement('aiConfidenceScore', `${(avgConfidence * 100).toFixed(0)}%`);
    }

    /**
     * Display empty recommendations state
     */
    function displayEmptyRecommendationsState(message = null) {
      const container = document.getElementById('recommendationsGrid');
      if (container) {
        const defaultMessage = 'No recommendations available. Click "Generate AI Analysis" to get personalized recommendations based on your farm data.';
        container.innerHTML = `
          <div class="empty-state" style="padding: 4rem 2rem; text-align: center;">
            <div style="width: 100px; height: 100px; margin: 0 auto 1.5rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-brain" style="font-size: 3rem; color: #8b5cf6;"></i>
            </div>
            <h3 style="color: var(--text-primary); margin-bottom: 0.5rem; font-size: 1.5rem;">No Recommendations Available</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto;">
              ${message || defaultMessage}
            </p>
            <button class="btn btn-primary" onclick="generateAIRecommendations()" style="margin-top: 1rem;">
              <i class="fas fa-brain"></i>
              Generate AI Recommendations
            </button>
          </div>
        `;
      }
    }

    /**
     * Get recommendation icon
     */
    function getRecommendationIcon(type) {
      const icons = {
        'FERTILIZER': 'fa-seedling',
        'WATER': 'fa-tint',
        'IRRIGATION': 'fa-water',
        'SEEDS': 'fa-seedling',
        'PESTICIDE': 'fa-spray-can',
        'SOIL_MANAGEMENT': 'fa-mountain',
        'HARVEST': 'fa-hand-holding',
        'PLANTING': 'fa-seedling',
        'WEATHER_ADAPTATION': 'fa-cloud-sun',
        'MARKET_TIMING': 'fa-chart-line',
        'GENERAL': 'fa-lightbulb'
      };
      return icons[type] || 'fa-lightbulb';
    }

    /**
     * Mark recommendation as read
     */
    async function markRecommendationAsRead(recommendationId) {
      try {
        // Only mark DB recommendations, not AI-generated ones
        if (!recommendationId.startsWith('AI-')) {
          await apiRequest(`/ai-recommendations/${recommendationId}/read`, {
            method: 'PUT'
          });
        }

        // Update local data
        const rec = allRecommendationsData.find(r => r.id === recommendationId);
        if (rec) {
          rec.isRead = true;
          rec.readAt = new Date().toISOString();
        }

        // Re-display
        displayRecommendationsGrid(allRecommendationsData);
        updateRecommendationsStatistics(allRecommendationsData);

        showToast('✅ Recommendation marked as read', 'success');
      } catch (error) {
        console.error('Error marking recommendation as read:', error);
        showToast('Error marking recommendation as read', 'error');
      }
    }

    /**
     * View recommendation details
     */
    function viewRecommendationDetails(recommendationId) {
      const rec = allRecommendationsData.find(r => r.id === recommendationId);
      if (!rec) {
        showToast('Recommendation not found', 'error');
        return;
      }

      // Show details in modal
      const modalHTML = `
        <div class="modal-overlay show" id="recommendationModal" onclick="if(event.target === this) closeRecommendationModal()">
          <div class="modal-container modal-large">
            <div class="modal-header">
              <h3 class="modal-title">
                <i class="fas fa-lightbulb"></i>
                ${escapeHtml(rec.title)}
              </h3>
              <button class="modal-close" onclick="closeRecommendationModal()" type="button">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 20px;">
                <span style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase;">
                  ${rec.recommendationType || 'GENERAL'}
                </span>
                <span style="background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; margin-left: 8px;">
                  ${rec.priority || 'MEDIUM'}
                </span>
              </div>
              <div style="margin-bottom: 20px;">
                <h4>Description</h4>
                <p style="color: var(--text-secondary); line-height: 1.8;">${escapeHtml(rec.description)}</p>
              </div>
              ${rec.actionItems ? `
              <div style="margin-bottom: 20px;">
                <h4>Recommended Actions</h4>
                <div style="padding: 16px; background: rgba(34, 197, 94, 0.05); border-left: 4px solid var(--primary-green); border-radius: 8px;">
                  <div style="white-space: pre-line; color: var(--text-secondary); line-height: 1.8;">${escapeHtml(rec.actionItems)}</div>
                </div>
              </div>
              ` : ''}
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Confidence Score</div>
                  <div style="font-size: 24px; font-weight: 700; color: var(--primary-green);">${((rec.confidenceScore || 0) * 100).toFixed(0)}%</div>
                </div>
                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Generated By</div>
                  <div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(rec.generatedBy || 'System')}</div>
                </div>
                <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                  <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Created</div>
                  <div style="font-weight: 600; color: var(--text-primary);">${rec.createdAt ? formatDateTime(rec.createdAt) : 'N/A'}</div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeRecommendationModal()">
                <i class="fas fa-times"></i>
                Close
              </button>
              ${!rec.isRead ? `
              <button type="button" class="btn btn-primary" onclick="markRecommendationAsRead('${rec.id}'); closeRecommendationModal();">
                <i class="fas fa-check"></i>
                Mark as Read
              </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;

      document.getElementById('modalContainer').innerHTML = modalHTML;
    }

    /**
     * Close recommendation modal
     */
    function closeRecommendationModal() {
      const modal = document.getElementById('recommendationModal');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
          document.getElementById('modalContainer').innerHTML = '';
        }, 300);
      }
    }

    /**
     * Render comparison charts based on real data
     */
    async function renderComparisonCharts() {
      try {
        if (!currentUser || !currentUser.id) return;

        const farmerId = currentUser.id;

        // Collect data for charts with proper error handling
        const [productions, fertilizerUsage, irrigationData, transactions] = await Promise.all([
          apiRequest(`/v1/crop-productions/farmer/${farmerId}`).catch(() => ({ data: [] })),
          apiRequest(`/fertilizer-usages/farmer/${farmerId}`).catch(() => ({ content: [] })),
          apiRequest(`/irrigation/farmer/${farmerId}`).catch(() => ({ data: [] })),
          apiRequest(`/transactions/farmer/${farmerId}`).catch(() => ({ content: [] }))
        ]);

        // ✅ Parse responses correctly based on backend structure
        const productionsList = Array.isArray(productions) ? productions : 
                               (productions.data && Array.isArray(productions.data) ? productions.data : []);
        
        // Fertilizer usage returns { content: [], totalElements: 0, ... }
        const fertilizerList = Array.isArray(fertilizerUsage) ? fertilizerUsage : 
                              (fertilizerUsage.content && Array.isArray(fertilizerUsage.content) ? fertilizerUsage.content : []);
        
        // Irrigation data returns { success: true, data: [], ... } or direct array
        const irrigationList = Array.isArray(irrigationData) ? irrigationData : 
                               (irrigationData.data && Array.isArray(irrigationData.data) ? irrigationData.data : []);
        
        // Transactions returns { content: [], ... }
        const transactionsList = Array.isArray(transactions) ? transactions : 
                                (transactions.content && Array.isArray(transactions.content) ? transactions.content : []);

        // ✅ Chart 1: Production Trends
        renderProductionTrendsChart(productionsList);

        // ✅ Chart 2: Cost Analysis
        renderCostAnalysisChart(fertilizerList, irrigationList);

        // ✅ Chart 3: Yield Predictions
        renderYieldPredictionsChart(productionsList);

        // ✅ Chart 4: Resource Usage
        renderResourceUsageChart(fertilizerList, irrigationList);

      } catch (error) {
        console.error('❌ Error rendering comparison charts:', error);
      }
    }

    /**
     * Render production trends chart
     */
    function renderProductionTrendsChart(productions) {
      const canvas = document.getElementById('productionTrendsChart');
      if (!canvas || !productions || productions.length === 0) return;

      // Group by month
      const monthlyData = {};
      productions.forEach(p => {
        if (p.plantingDate) {
          const date = new Date(p.plantingDate);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = { count: 0, totalYield: 0 };
          }
          monthlyData[monthKey].count++;
          monthlyData[monthKey].totalYield += parseFloat(p.expectedYield || 0);
        }
      });

      const labels = Object.keys(monthlyData).sort();
      const counts = labels.map(key => monthlyData[key].count);
      const yields = labels.map(key => monthlyData[key].totalYield);

      // ✅ Safe Chart.js cleanup
      if (window.productionTrendsChart && typeof window.productionTrendsChart.destroy === 'function') {
        try {
          window.productionTrendsChart.destroy();
        } catch (e) {
          console.warn('Error destroying productionTrendsChart:', e);
        }
      }

      const ctx = canvas.getContext('2d');
      window.productionTrendsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Number of Productions',
            data: counts,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4
          }, {
            label: 'Total Expected Yield (KG)',
            data: yields,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.4,
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: { size: 12, weight: '600' }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 12 }
            }
          },
          scales: {
            y: { 
              position: 'left', 
              title: { 
                display: true, 
                text: 'Number of Productions',
                font: { size: 12, weight: 'bold' }
              }
            },
            y1: { 
              position: 'right', 
              title: { 
                display: true, 
                text: 'Yield (KG)',
                font: { size: 12, weight: 'bold' }
              }, 
              grid: { drawOnChartArea: false },
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' KG';
                }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 0
              }
            }
          }
        }
      });
    }

    /**
     * Render cost analysis chart
     */
    function renderCostAnalysisChart(fertilizerList, irrigationList) {
      const canvas = document.getElementById('costAnalysisChart');
      if (!canvas) return;

      const fertilizerCost = fertilizerList.reduce((sum, f) => sum + parseFloat(f.totalCost || 0), 0);
      const irrigationCost = irrigationList.reduce((sum, i) => sum + parseFloat(i.totalCost || 0), 0);
      const totalCost = fertilizerCost + irrigationCost;

      // ✅ Safe Chart.js cleanup
      if (window.costAnalysisChart && typeof window.costAnalysisChart.destroy === 'function') {
        try {
          window.costAnalysisChart.destroy();
        } catch (e) {
          console.warn('Error destroying costAnalysisChart:', e);
        }
      }

      const ctx = canvas.getContext('2d');
      window.costAnalysisChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Fertilizer', 'Irrigation'],
          datasets: [{
            data: [fertilizerCost, irrigationCost],
            backgroundColor: ['#3b82f6', '#22c55e'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              position: 'bottom',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: { size: 12, weight: '600' }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 12 },
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const percentage = totalCost > 0 ? ((value / totalCost) * 100).toFixed(1) : 0;
                  return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }

    /**
     * Render yield predictions chart with precise AI predictions based on real data
     */
    function renderYieldPredictionsChart(productions) {
      const canvas = document.getElementById('yieldPredictionsChart');
      if (!canvas || !productions || productions.length === 0) return;

      const activeProductions = productions.filter(p => 
        p.status === 'ACTIVE' || p.status === 'IN_PROGRESS' || p.productionStatus === 'PLANTED' || p.productionStatus === 'GROWING'
      );

      if (activeProductions.length === 0) return;

      // Get historical data for prediction accuracy
      const harvestedProductions = productions.filter(p => 
        p.productionStatus === 'HARVESTED' && p.actualYield
      );

      // Calculate historical yield ratios per crop
      const cropYieldRatios = {};
      harvestedProductions.forEach(p => {
        const cropId = p.cropId || 'unknown';
        const expected = parseFloat(p.expectedYield || 0);
        const actual = parseFloat(p.actualYield || 0);
        if (expected > 0) {
          if (!cropYieldRatios[cropId]) {
            cropYieldRatios[cropId] = [];
          }
          cropYieldRatios[cropId].push(actual / expected);
        }
      });

      // Calculate average ratio per crop
      const avgRatios = {};
      Object.keys(cropYieldRatios).forEach(cropId => {
        const ratios = cropYieldRatios[cropId];
        avgRatios[cropId] = ratios.reduce((a, b) => a + b, 0) / ratios.length;
      });

      const labels = activeProductions.map(p => {
        // Try to get crop name from cropId
        const cropId = p.cropId || 'unknown';
        return p.cropName || `Crop ${cropId.substring(0, 8)}`;
      }).slice(0, 10);
      
      const expectedYields = activeProductions.map(p => parseFloat(p.expectedYield || 0)).slice(0, 10);
      
      // ✅ PRECISE AI PREDICTION: Use historical data for accurate predictions
      const predictedYields = activeProductions.slice(0, 10).map((p, idx) => {
        const cropId = p.cropId || 'unknown';
        const historicalRatio = avgRatios[cropId];
        const expected = parseFloat(p.expectedYield || 0);
        
        if (historicalRatio && !isNaN(historicalRatio) && historicalRatio > 0) {
          // Use historical average ratio (more accurate)
          return expected * historicalRatio;
        } else {
          // Fallback: Use overall average if crop-specific data not available
          const overallAvg = Object.values(avgRatios).length > 0 
            ? Object.values(avgRatios).reduce((a, b) => a + b, 0) / Object.values(avgRatios).length
            : 0.95; // Default 95% if no historical data
          return expected * overallAvg;
        }
      });

      // ✅ Safe Chart.js cleanup
      if (window.yieldPredictionsChart && typeof window.yieldPredictionsChart.destroy === 'function') {
        try {
          window.yieldPredictionsChart.destroy();
        } catch (e) {
          console.warn('Error destroying yieldPredictionsChart:', e);
        }
      }

      const ctx = canvas.getContext('2d');
      window.yieldPredictionsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Expected Yield (KG)',
            data: expectedYields,
            backgroundColor: 'rgba(59, 130, 246, 0.6)',
            borderColor: '#3b82f6',
            borderWidth: 2
          }, {
            label: 'AI Predicted Yield (KG)',
            data: predictedYields,
            backgroundColor: 'rgba(34, 197, 94, 0.6)',
            borderColor: '#22c55e',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: { size: 12, weight: '600' }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 12 },
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  const diff = context.datasetIndex === 1 
                    ? ((value - expectedYields[context.dataIndex]) / expectedYields[context.dataIndex] * 100).toFixed(1)
                    : '';
                  return `${context.dataset.label}: ${value.toLocaleString()} KG${diff ? ` (${diff > 0 ? '+' : ''}${diff}%)` : ''}`;
                }
              }
            }
          },
          scales: {
            y: { 
              beginAtZero: true, 
              title: { 
                display: true, 
                text: 'Yield (KG)',
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' KG';
                }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 0
              }
            }
          }
        }
      });
    }

    /**
     * Render resource usage chart
     */
    function renderResourceUsageChart(fertilizerList, irrigationList) {
      const canvas = document.getElementById('resourceUsageChart');
      if (!canvas) return;

      // Group by month
      const monthlyUsage = {};
      
      fertilizerList.forEach(f => {
        if (f.applicationDate) {
          const date = new Date(f.applicationDate);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyUsage[monthKey]) {
            monthlyUsage[monthKey] = { fertilizer: 0, water: 0 };
          }
          monthlyUsage[monthKey].fertilizer += parseFloat(f.quantity || 0);
        }
      });

      irrigationList.forEach(i => {
        if (i.irrigationDate) {
          const date = new Date(i.irrigationDate);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyUsage[monthKey]) {
            monthlyUsage[monthKey] = { fertilizer: 0, water: 0 };
          }
          monthlyUsage[monthKey].water += parseFloat(i.waterUsed || 0);
        }
      });

      const labels = Object.keys(monthlyUsage).sort().slice(-6);
      const fertilizerData = labels.map(key => monthlyUsage[key]?.fertilizer || 0);
      const waterData = labels.map(key => monthlyUsage[key]?.water || 0);

      // ✅ Safe Chart.js cleanup
      if (window.resourceUsageChart && typeof window.resourceUsageChart.destroy === 'function') {
        try {
          window.resourceUsageChart.destroy();
        } catch (e) {
          console.warn('Error destroying resourceUsageChart:', e);
        }
      }

      const ctx = canvas.getContext('2d');
      window.resourceUsageChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Fertilizer (KG)',
            data: fertilizerData,
            backgroundColor: '#8b5cf6',
            yAxisID: 'y'
          }, {
            label: 'Water (Liters)',
            data: waterData,
            backgroundColor: '#3b82f6',
            yAxisID: 'y1'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: { size: 12, weight: '600' }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 14, weight: 'bold' },
              bodyFont: { size: 12 },
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  return `${context.dataset.label}: ${value.toLocaleString()} ${context.dataset.label.includes('Fertilizer') ? 'KG' : 'Liters'}`;
                }
              }
            }
          },
          scales: {
            y: { 
              position: 'left', 
              title: { 
                display: true, 
                text: 'Fertilizer (KG)',
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' KG';
                }
              }
            },
            y1: { 
              position: 'right', 
              title: { 
                display: true, 
                text: 'Water (Liters)',
                font: { size: 12, weight: 'bold' }
              }, 
              grid: { drawOnChartArea: false },
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' L';
                }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 0
              }
            }
          }
        }
      });
    }

    /**
     * Send AI chat message
     */
    async function sendAIChatMessage() {
      const input = document.getElementById('aiChatInput');
      if (!input || !input.value.trim()) return;

      const question = input.value.trim();
      input.value = '';

      // Add user message to chat
      addChatMessage('user', question);

      // Show loading
      const sendBtn = document.getElementById('sendChatBtn');
      if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      }

      try {
        // Generate AI response based on real data
        const response = await generateAIResponse(question);
        addChatMessage('assistant', response);

      } catch (error) {
        console.error('Error generating AI response:', error);
        addChatMessage('assistant', 'I apologize, but I encountered an error. Please try again or rephrase your question.');
      } finally {
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
        }
      }
    }

    /**
     * Generate AI response based on question and real data - IMPROVED VERSION
     */
    async function generateAIResponse(question) {
      const questionLower = question.toLowerCase().trim();

      if (!currentUser || !currentUser.id) {
        return 'Please login to get personalized recommendations based on your farm data.';
      }

      const farmerId = currentUser.id;

      // ✅ Collect ALL relevant data for comprehensive analysis
      const [farms, productions, inventory, weatherData, soilData, transactions, fertilizerUsage, irrigationData] = await Promise.all([
        apiRequest(`/farms/farmer/${farmerId}/all`).catch(() => []),
        apiRequest(`/v1/crop-productions/farmer/${farmerId}`).catch(() => ({ data: [] })),
        apiRequest(`/v1/inventories/farmer/${farmerId}`).catch(() => []),
        apiRequest(`/weather-data/recent?days=30`).catch(() => []),
        apiRequest(`/v1/soil-data/farmer/${farmerId}`).catch(() => []),
        apiRequest(`/transactions/farmer/${farmerId}`).catch(() => ({ content: [] })),
        apiRequest(`/fertilizer-usages/farmer/${farmerId}`).catch(() => ({ content: [] })),
        apiRequest(`/irrigation/farmer/${farmerId}`).catch(() => ({ data: [] }))
      ]);

      const farmsList = Array.isArray(farms) ? farms : [];
      const productionsList = Array.isArray(productions) ? productions : 
                             (productions.data && Array.isArray(productions.data) ? productions.data : []);
      const inventoryList = Array.isArray(inventory) ? inventory : [];
      const weatherList = Array.isArray(weatherData) ? weatherData : [];
      const soilList = Array.isArray(soilData) ? soilData : [];
      const transactionsList = Array.isArray(transactions) ? transactions : 
                             (transactions.content && Array.isArray(transactions.content) ? transactions.content : []);
      const fertilizerList = Array.isArray(fertilizerUsage) ? fertilizerUsage : 
                            (fertilizerUsage.content && Array.isArray(fertilizerUsage.content) ? fertilizerUsage.content : []);
      const irrigationList = Array.isArray(irrigationData) ? irrigationData : 
                            (irrigationData.data && Array.isArray(irrigationData.data) ? irrigationData.data : []);

      // ✅ IMPROVED: Analyze question with better intent detection
      let response = '';

      // Weather-related questions
      if (questionLower.includes('weather') || questionLower.includes('rain') || questionLower.includes('temperature')) {
        if (weatherList.length > 0) {
          const recent = weatherList[0];
          const avgTemp = weatherList.slice(0, 7)
            .map(w => parseFloat(w.temperature))
            .filter(t => !isNaN(t))
            .reduce((a, b) => a + b, 0) / Math.min(7, weatherList.length);
          const totalRain = weatherList.slice(0, 7)
            .map(w => parseFloat(w.rainfall || 0))
            .filter(r => !isNaN(r))
            .reduce((a, b) => a + b, 0);

          response = `Based on recent weather data from your farms:\n\n`;
          response += `🌡️ **Temperature**: Average ${avgTemp.toFixed(1)}°C\n`;
          response += `🌧️ **Rainfall**: ${totalRain.toFixed(2)}mm in the last 7 days\n`;
          response += `💧 **Humidity**: ${recent.humidity || 'N/A'}%\n\n`;
          
          if (avgTemp > 35) {
            response += `⚠️ **Recommendation**: High temperatures detected. Increase irrigation frequency and monitor soil moisture.`;
          } else if (totalRain < 5) {
            response += `⚠️ **Recommendation**: Low rainfall. Schedule additional irrigation to prevent drought stress.`;
          } else {
            response += `✅ Weather conditions are favorable for most crops.`;
          }
        } else {
          response = 'I don\'t have recent weather data for your farms. Please ensure weather monitoring is set up.';
        }
      }
      // ✅ IMPROVED: Production-related questions with detailed analysis
      else if (questionLower.includes('production') || questionLower.includes('crop') || questionLower.includes('yield') || 
               questionLower.includes('harvest') || questionLower.includes('planting') || questionLower.includes('growing')) {
        if (productionsList.length > 0) {
          const active = productionsList.filter(p => 
            p.productionStatus === 'PLANTED' || p.productionStatus === 'GROWING' || 
            p.productionStatus === 'ACTIVE' || p.productionStatus === 'IN_PROGRESS'
          );
          const harvested = productionsList.filter(p => p.productionStatus === 'HARVESTED');
          const completed = productionsList.filter(p => p.productionStatus === 'COMPLETED');

          response = `🌾 **Crop Production Overview**:\n\n`;
          response += `📊 **Summary**:\n`;
          response += `   • Total Productions: ${productionsList.length}\n`;
          response += `   • Active: ${active.length}\n`;
          response += `   • Harvested: ${harvested.length}\n`;
          response += `   • Completed: ${completed.length}\n\n`;

          if (active.length > 0) {
            response += `🌱 **Active Productions** (${active.length}):\n`;
            active.slice(0, 10).forEach((p, idx) => {
              const expectedYield = parseFloat(p.expectedYield || 0);
              const actualYield = parseFloat(p.actualYield || 0);
              const area = parseFloat(p.areaInHectares || 0);
              const yieldPerHa = area > 0 ? (expectedYield / area).toFixed(2) : 'N/A';
              
              response += `   ${idx + 1}. **${p.cropName || 'Unknown Crop'}**\n`;
              response += `      • Status: ${p.productionStatus || 'Active'}\n`;
              response += `      • Area: ${area.toFixed(2)} hectares\n`;
              response += `      • Expected Yield: ${expectedYield.toLocaleString()} KG\n`;
              if (actualYield > 0) {
                response += `      • Actual Yield: ${actualYield.toLocaleString()} KG\n`;
                const diff = ((actualYield - expectedYield) / expectedYield * 100).toFixed(1);
                response += `      • Performance: ${diff > 0 ? '+' : ''}${diff}% vs expected\n`;
              }
              response += `      • Yield per Hectare: ${yieldPerHa} KG/ha\n`;
              if (p.plantingDate) {
                const daysSince = Math.floor((new Date() - new Date(p.plantingDate)) / (1000 * 60 * 60 * 24));
                response += `      • Days since planting: ${daysSince} days\n`;
              }
              response += `\n`;
            });

            const totalExpectedYield = active.reduce((sum, p) => sum + parseFloat(p.expectedYield || 0), 0);
            const totalArea = active.reduce((sum, p) => sum + parseFloat(p.areaInHectares || 0), 0);
            const avgYieldPerHa = totalArea > 0 ? (totalExpectedYield / totalArea).toFixed(2) : 0;

            response += `📈 **Total Active Production**:\n`;
            response += `   • Total Area: ${totalArea.toFixed(2)} hectares\n`;
            response += `   • Total Expected Yield: ${totalExpectedYield.toLocaleString()} KG\n`;
            response += `   • Average Yield per Hectare: ${avgYieldPerHa} KG/ha\n\n`;

            // ✅ AI Recommendations based on production data
            response += `💡 **AI Recommendations**:\n`;
            if (totalArea > 0 && avgYieldPerHa < 2000) {
              response += `   ⚠️ Yield per hectare is below optimal. Consider:\n`;
              response += `      1. Soil nutrient testing and fertilization\n`;
              response += `      2. Improved irrigation scheduling\n`;
              response += `      3. Pest and disease monitoring\n`;
              response += `      4. Crop rotation planning\n`;
            } else {
              response += `   ✅ Production metrics look good. Continue monitoring:\n`;
              response += `      1. Growth stages and development\n`;
              response += `      2. Weather impact on crops\n`;
              response += `      3. Market timing for harvest\n`;
            }
          } else {
            response += `⚠️ **No Active Productions**\n\n`;
            response += `You currently don't have any active crop productions. Consider:\n`;
            response += `1. Starting new productions for the current season\n`;
            response += `2. Reviewing soil conditions before planting\n`;
            response += `3. Planning based on weather forecasts\n`;
            response += `4. Checking market prices for crop selection\n`;
          }

          if (harvested.length > 0) {
            const totalHarvested = harvested.reduce((sum, p) => sum + parseFloat(p.actualYield || 0), 0);
            response += `\n✅ **Harvested Productions**: ${harvested.length} (Total: ${totalHarvested.toLocaleString()} KG)\n`;
          }
        } else {
          response = `❌ **No Production Data Available**\n\n`;
          response += `You don't have any crop production records. To get started:\n`;
          response += `1. Create a new crop production record\n`;
          response += `2. Select your farm and crop type\n`;
          response += `3. Enter planting details and expected yield\n`;
          response += `4. Monitor and update as crops grow\n`;
        }
      }
      // ✅ IMPROVED: Soil-related questions with comprehensive analysis
      else if (questionLower.includes('soil') || questionLower.includes('ph') || questionLower.includes('nutrient') || 
               questionLower.includes('fertilizer') || questionLower.includes('npk')) {
        if (soilList.length > 0) {
          const recent = soilList[0];
          const ph = parseFloat(recent.phLevel || 0);
          const organicMatter = parseFloat(recent.organicMatter || 0);
          const moisture = parseFloat(recent.moistureContent || recent.moisture || 0);
          const nitrogen = parseFloat(recent.nitrogen || 0);
          const phosphorus = parseFloat(recent.phosphorus || 0);
          const potassium = parseFloat(recent.potassium || 0);

          response = `🌱 **Comprehensive Soil Analysis**:\n\n`;
          response += `📊 **Current Soil Status**:\n`;
          response += `   • pH Level: ${ph > 0 ? ph.toFixed(2) : 'N/A'} ${ph > 0 ? (ph < 6.0 ? '⚠️ (Acidic)' : ph > 7.5 ? '⚠️ (Alkaline)' : '✅ (Optimal)') : ''}\n`;
          response += `   • Organic Matter: ${organicMatter > 0 ? organicMatter.toFixed(2) + '%' : 'N/A'}\n`;
          response += `   • Moisture Content: ${moisture > 0 ? moisture.toFixed(1) + '%' : 'N/A'}\n\n`;

          response += `🧪 **NPK Nutrient Levels**:\n`;
          response += `   • Nitrogen (N): ${nitrogen > 0 ? nitrogen.toFixed(1) + ' ppm' : 'N/A'} ${nitrogen > 0 ? (nitrogen < 40 ? '⚠️ (Low)' : nitrogen > 150 ? '⚠️ (High)' : '✅ (Optimal)') : ''}\n`;
          response += `   • Phosphorus (P): ${phosphorus > 0 ? phosphorus.toFixed(1) + ' ppm' : 'N/A'} ${phosphorus > 0 ? (phosphorus < 25 ? '⚠️ (Low)' : phosphorus > 100 ? '⚠️ (High)' : '✅ (Optimal)') : ''}\n`;
          response += `   • Potassium (K): ${potassium > 0 ? potassium.toFixed(1) + ' ppm' : 'N/A'} ${potassium > 0 ? (potassium < 150 ? '⚠️ (Low)' : potassium > 500 ? '⚠️ (High)' : '✅ (Optimal)') : ''}\n\n`;

          // ✅ Detailed recommendations
          const recommendations = [];
          if (ph > 0) {
            if (ph < 6.0) {
              recommendations.push(`⚠️ **pH Too Low (${ph.toFixed(2)})**: Apply agricultural lime at 2-4 tons/hectare to raise pH to optimal range (6.0-7.5)`);
            } else if (ph > 7.5) {
              recommendations.push(`⚠️ **pH Too High (${ph.toFixed(2)})**: Apply elemental sulfur or acidifying fertilizers to lower pH`);
            } else {
              recommendations.push(`✅ **pH Optimal**: Current pH (${ph.toFixed(2)}) is in the optimal range for most crops`);
            }
          }

          if (nitrogen > 0 && nitrogen < 40) {
            recommendations.push(`⚠️ **Low Nitrogen**: Apply nitrogen-rich fertilizer (e.g., Urea, Ammonium Nitrate) at recommended rates`);
          } else if (nitrogen > 150) {
            recommendations.push(`⚠️ **High Nitrogen**: Reduce nitrogen application to prevent nutrient imbalance and environmental issues`);
          }

          if (phosphorus > 0 && phosphorus < 25) {
            recommendations.push(`⚠️ **Low Phosphorus**: Apply phosphorus fertilizer (e.g., Superphosphate, Triple Superphosphate)`);
          }

          if (potassium > 0 && potassium < 150) {
            recommendations.push(`⚠️ **Low Potassium**: Apply potash fertilizer (e.g., Potassium Chloride, Potassium Sulfate)`);
          }

          if (organicMatter > 0 && organicMatter < 3) {
            recommendations.push(`⚠️ **Low Organic Matter**: Add compost, manure, or organic amendments (2-3 tons/hectare) to improve soil structure`);
          }

          if (moisture > 0) {
            if (moisture < 20) {
              recommendations.push(`💧 **Low Soil Moisture (${moisture.toFixed(1)}%)**: Increase irrigation frequency immediately`);
            } else if (moisture > 60) {
              recommendations.push(`🌊 **High Soil Moisture (${moisture.toFixed(1)}%)**: Improve drainage to prevent waterlogging`);
            }
          }

          if (recommendations.length > 0) {
            response += `💡 **AI Recommendations**:\n`;
            recommendations.forEach((rec, idx) => {
              response += `   ${idx + 1}. ${rec}\n`;
            });
          } else {
            response += `✅ **Soil Health Status**: All parameters are within optimal ranges. Continue current management practices.\n`;
          }

          // ✅ Fertilizer usage analysis
          if (fertilizerList.length > 0) {
            const recentFertilizer = fertilizerList.slice(0, 5);
            response += `\n📊 **Recent Fertilizer Applications** (${fertilizerList.length} total):\n`;
            recentFertilizer.forEach(f => {
              response += `   • ${f.fertilizerName || 'Unknown'}: ${f.quantity || 0} ${f.unit || 'KG'} on ${f.applicationDate ? new Date(f.applicationDate).toLocaleDateString() : 'N/A'}\n`;
            });
          }
        } else {
          response = `❌ **No Soil Data Available**\n\n`;
          response += `I don't have recent soil analysis data for your farms. To get accurate recommendations:\n`;
          response += `1. Conduct soil tests regularly (every 6 months)\n`;
          response += `2. Test for pH, NPK, and organic matter\n`;
          response += `3. Record results in the system\n`;
          response += `4. Update soil data after amendments\n`;
        }
      }
      // ✅ IMPROVED: Inventory-related questions with detailed analysis
      else if (questionLower.includes('inventory') || questionLower.includes('stock') || questionLower.includes('supply')) {
        if (inventoryList.length > 0) {
          const lowStock = inventoryList.filter(item => {
            const available = parseFloat(item.availableQuantity || 0);
            const total = parseFloat(item.totalQuantity || 0);
            return available > 0 && total > 0 && (available / total) < 0.2;
          });
          const criticalStock = inventoryList.filter(item => {
            const available = parseFloat(item.availableQuantity || 0);
            const total = parseFloat(item.totalQuantity || 0);
            return available > 0 && total > 0 && (available / total) < 0.1;
          });
          const totalValue = inventoryList.reduce((sum, item) => {
            const qty = parseFloat(item.availableQuantity || 0);
            const price = parseFloat(item.unitPrice || 0);
            return sum + (qty * price);
          }, 0);

          response = `📦 **Inventory Management Overview**:\n\n`;
          response += `📊 **Summary**:\n`;
          response += `   • Total Items: ${inventoryList.length}\n`;
          response += `   • Low Stock (<20%): ${lowStock.length}\n`;
          if (criticalStock.length > 0) {
            response += `\n   • ⚠️ CRITICAL Stock (<10%): ${criticalStock.length}`;
          }
          response += `\n   • Total Inventory Value: RWF ${totalValue.toLocaleString()}\n\n`;

          if (criticalStock.length > 0) {
            response += `🚨 **CRITICAL - Immediate Action Required**:\n`;
            criticalStock.forEach(item => {
              const available = parseFloat(item.availableQuantity || 0);
              const total = parseFloat(item.totalQuantity || 0);
              const percentage = ((available / total) * 100).toFixed(1);
              response += `   • **${item.cropName || 'Unknown'}**: ${available.toLocaleString()} / ${total.toLocaleString()} (${percentage}%)\n`;
            });
            response += `\n`;
          }

          if (lowStock.length > 0) {
            response += `⚠️ **Items Needing Restock** (${lowStock.length}):\n`;
            lowStock.slice(0, 10).forEach(item => {
              const available = parseFloat(item.availableQuantity || 0);
              const total = parseFloat(item.totalQuantity || 0);
              const percentage = ((available / total) * 100).toFixed(1);
              const needed = total - available;
              response += `   • **${item.cropName || 'Unknown'}**: ${available.toLocaleString()} / ${total.toLocaleString()} (${percentage}%) - Need ${needed.toLocaleString()} ${item.unit || 'units'}\n`;
            });
            response += `\n💡 **Recommendation**: Restock these items within 1-2 weeks to avoid production delays.\n\n`;
          } else {
            response += `✅ **Stock Status**: All inventory items have adequate stock levels (above 20%).\n\n`;
          }

          // ✅ Top inventory items by value
          const topItems = inventoryList
            .map(item => ({
              name: item.cropName || 'Unknown',
              value: parseFloat(item.availableQuantity || 0) * parseFloat(item.unitPrice || 0),
              quantity: parseFloat(item.availableQuantity || 0)
            }))
            .sort((a, b) => b.value - a.value)
            .slice(0, 5);

          if (topItems.length > 0) {
            response += `💰 **Top Inventory Items by Value**:\n`;
            topItems.forEach((item, idx) => {
              response += `   ${idx + 1}. ${item.name}: ${item.quantity.toLocaleString()} units (RWF ${item.value.toLocaleString()})\n`;
            });
          }
        } else {
          response = `❌ **No Inventory Data Available**\n\n`;
          response += `Start tracking your inventory for better management:\n`;
          response += `1. Add inventory items with quantities\n`;
          response += `2. Set minimum stock levels\n`;
          response += `3. Update quantities after use\n`;
          response += `4. Enable low stock alerts\n`;
        }
      }
      // ✅ IMPROVED: Irrigation-related questions
      else if (questionLower.includes('irrigation') || questionLower.includes('water') || questionLower.includes('watering')) {
        if (irrigationList.length > 0 || weatherList.length > 0 || soilList.length > 0) {
          const recentIrrigation = irrigationList.slice(0, 7);
          const totalWaterUsed = recentIrrigation.reduce((sum, i) => sum + parseFloat(i.waterUsed || 0), 0);
          const avgWaterPerSession = recentIrrigation.length > 0 ? totalWaterUsed / recentIrrigation.length : 0;

          const recentWeather = weatherList.slice(0, 7);
          const totalRainfall = recentWeather.reduce((sum, w) => sum + parseFloat(w.rainfall || 0), 0);
          const avgTemp = recentWeather.length > 0 
            ? recentWeather.reduce((sum, w) => sum + parseFloat(w.temperature || 0), 0) / recentWeather.length 
            : 0;

          const recentSoil = soilList[0];
          const soilMoisture = parseFloat(recentSoil?.moistureContent || recentSoil?.moisture || 0);

          response = `💧 **Irrigation Management Analysis**:\n\n`;
          response += `📊 **Current Status**:\n`;
          response += `   • Recent Irrigation Sessions: ${recentIrrigation.length}\n`;
          response += `   • Total Water Used (Last 7 days): ${totalWaterUsed.toLocaleString()} Liters\n`;
          response += `   • Average per Session: ${avgWaterPerSession.toFixed(0)} Liters\n`;
          response += `   • Rainfall (Last 7 days): ${totalRainfall.toFixed(2)}mm\n`;
          response += `   • Soil Moisture: ${soilMoisture > 0 ? soilMoisture.toFixed(1) + '%' : 'N/A'}\n`;
          response += `   • Average Temperature: ${avgTemp > 0 ? avgTemp.toFixed(1) + '°C' : 'N/A'}\n\n`;

          // ✅ AI Irrigation Recommendations
          let irrigationNeed = 0;
          const recommendations = [];

          if (totalRainfall < 10) {
            irrigationNeed += 40;
            recommendations.push(`⚠️ Low rainfall (${totalRainfall.toFixed(2)}mm) - Increase irrigation frequency`);
          }
          if (soilMoisture > 0 && soilMoisture < 20) {
            irrigationNeed += 40;
            recommendations.push(`⚠️ Low soil moisture (${soilMoisture.toFixed(1)}%) - Immediate irrigation needed`);
          }
          if (avgTemp > 30) {
            irrigationNeed += 20;
            recommendations.push(`🌡️ High temperature (${avgTemp.toFixed(1)}°C) - Increase water application`);
          }
          if (totalRainfall > 50) {
            recommendations.push(`🌊 Heavy rainfall (${totalRainfall.toFixed(2)}mm) - Reduce or pause irrigation`);
          }
          if (soilMoisture > 60) {
            recommendations.push(`🌊 High soil moisture (${soilMoisture.toFixed(1)}%) - Stop irrigation, improve drainage`);
          }

          if (irrigationNeed > 70) {
            response += `🚨 **URGENT**: High irrigation need detected (${irrigationNeed}%)\n`;
            response += `   • Schedule irrigation immediately\n`;
            response += `   • Use early morning or evening timing\n`;
            response += `   • Apply deep watering (not surface)\n\n`;
          } else if (irrigationNeed > 40) {
            response += `⚠️ **Moderate**: Irrigation needed (${irrigationNeed}%)\n`;
            response += `   • Schedule additional irrigation sessions\n`;
            response += `   • Monitor soil moisture daily\n\n`;
          } else {
            response += `✅ **Adequate**: Current irrigation schedule appears sufficient\n\n`;
          }

          if (recommendations.length > 0) {
            response += `💡 **Recommendations**:\n`;
            recommendations.forEach((rec, idx) => {
              response += `   ${idx + 1}. ${rec}\n`;
            });
          }

          response += `\n📋 **Best Practices**:\n`;
          response += `   • Water deeply but less frequently\n`;
          response += `   • Use drip irrigation for efficiency\n`;
          response += `   • Monitor soil moisture at root depth\n`;
          response += `   • Apply mulch to reduce evaporation\n`;
          response += `   • Adjust based on weather forecasts\n`;
        } else {
          response = `❌ **Insufficient Data for Irrigation Analysis**\n\n`;
          response += `I need weather and/or soil data to provide irrigation recommendations. Please:\n`;
          response += `1. Record irrigation activities\n`;
          response += `2. Monitor weather conditions\n`;
          response += `3. Check soil moisture regularly\n`;
        }
      }
      // ✅ IMPROVED: Market/Transaction-related questions
      else if (questionLower.includes('market') || questionLower.includes('price') || questionLower.includes('transaction') || 
               questionLower.includes('sell') || questionLower.includes('revenue') || questionLower.includes('income')) {
        if (transactionsList.length > 0) {
          const recentTransactions = transactionsList.slice(0, 10);
          const totalRevenue = transactionsList.reduce((sum, t) => sum + parseFloat(t.totalAmount || 0), 0);
          const avgTransactionValue = totalRevenue / transactionsList.length;
          const completedTransactions = transactionsList.filter(t => 
            t.transactionStatus === 'COMPLETED' || t.transactionStatus === 'PAID'
          );
          const pendingTransactions = transactionsList.filter(t => 
            t.transactionStatus === 'PENDING' || t.transactionStatus === 'CONFIRMED'
          );

          response = `💰 **Market & Transaction Analysis**:\n\n`;
          response += `📊 **Summary**:\n`;
          response += `   • Total Transactions: ${transactionsList.length}\n`;
          response += `   • Completed: ${completedTransactions.length}\n`;
          response += `   • Pending: ${pendingTransactions.length}\n`;
          response += `   • Total Revenue: RWF ${totalRevenue.toLocaleString()}\n`;
          response += `   • Average Transaction Value: RWF ${avgTransactionValue.toLocaleString()}\n\n`;

          if (recentTransactions.length > 0) {
            response += `📈 **Recent Transactions** (Last 10):\n`;
            recentTransactions.forEach((t, idx) => {
              response += `   ${idx + 1}. ${t.cropName || 'Crop'}: ${parseFloat(t.quantity || 0).toLocaleString()} ${t.unit || 'KG'} - RWF ${parseFloat(t.totalAmount || 0).toLocaleString()} (${t.transactionStatus || 'N/A'})\n`;
            });
          }

          if (pendingTransactions.length > 0) {
            const pendingValue = pendingTransactions.reduce((sum, t) => sum + parseFloat(t.totalAmount || 0), 0);
            response += `\n⏳ **Pending Transactions**: ${pendingTransactions.length} (Total Value: RWF ${pendingValue.toLocaleString()})\n`;
            response += `   • Follow up on pending transactions\n`;
            response += `   • Ensure timely delivery and payment\n`;
          }

          response += `\n💡 **Market Recommendations**:\n`;
          response += `   1. Monitor market prices regularly\n`;
          response += `   2. Time harvests for peak prices\n`;
          response += `   3. Build relationships with reliable buyers\n`;
          response += `   4. Consider contract farming for stability\n`;
          response += `   5. Track transaction trends for planning\n`;
        } else {
          response = `❌ **No Transaction Data Available**\n\n`;
          response += `You don't have any transaction records yet. To start selling:\n`;
          response += `1. Create transactions with buyers\n`;
          response += `2. Record crop sales and prices\n`;
          response += `3. Track payment status\n`;
          response += `4. Analyze market trends\n`;
        }
      }
      // ✅ IMPROVED: General farming advice with comprehensive recommendations
      else if (questionLower.includes('recommend') || questionLower.includes('advice') || questionLower.includes('help') || 
               questionLower.includes('suggest') || questionLower.includes('what should') || questionLower.includes('how to')) {
        response = `💡 **Comprehensive Farm Management Recommendations**\n\n`;
        response += `📊 **Your Farm Overview**:\n`;
        response += `   • Farms: ${farmsList.length}\n`;
        response += `   • Active Productions: ${productionsList.filter(p => 
          p.productionStatus === 'PLANTED' || p.productionStatus === 'GROWING' || 
          p.productionStatus === 'ACTIVE' || p.productionStatus === 'IN_PROGRESS'
        ).length}\n`;
        response += `   • Inventory Items: ${inventoryList.length}\n`;
        response += `   • Recent Weather Records: ${weatherList.length}\n`;
        response += `   • Soil Tests: ${soilList.length}\n`;
        response += `   • Transactions: ${transactionsList.length}\n\n`;

        // ✅ Personalized recommendations based on actual data
        const recommendations = [];

        if (weatherList.length === 0) {
          recommendations.push(`🌤️ **Set up weather monitoring** - Track temperature, rainfall, and humidity for better decision-making`);
        }
        if (soilList.length === 0) {
          recommendations.push(`🌱 **Conduct soil tests** - Test pH, NPK, and organic matter every 6 months`);
        }
        if (productionsList.length === 0) {
          recommendations.push(`🌾 **Start crop production** - Create production records to track yields and performance`);
        }
        if (inventoryList.length === 0) {
          recommendations.push(`📦 **Track inventory** - Monitor stock levels to avoid production delays`);
        }

        const activeProductions = productionsList.filter(p => 
          p.productionStatus === 'PLANTED' || p.productionStatus === 'GROWING' || 
          p.productionStatus === 'ACTIVE' || p.productionStatus === 'IN_PROGRESS'
        );
        if (activeProductions.length > 0) {
          recommendations.push(`✅ **Monitor active crops** - You have ${activeProductions.length} active production(s). Track growth stages and adjust inputs`);
        }

        if (weatherList.length > 0) {
          const recentRain = weatherList.slice(0, 7).reduce((sum, w) => sum + parseFloat(w.rainfall || 0), 0);
          if (recentRain < 5) {
            recommendations.push(`💧 **Increase irrigation** - Low rainfall (${recentRain.toFixed(2)}mm) in last 7 days`);
          }
        }

        if (soilList.length > 0) {
          const recentSoil = soilList[0];
          const ph = parseFloat(recentSoil.phLevel || 0);
          if (ph > 0 && (ph < 6.0 || ph > 7.5)) {
            recommendations.push(`🌱 **Adjust soil pH** - Current pH (${ph.toFixed(2)}) is outside optimal range (6.0-7.5)`);
          }
        }

        if (recommendations.length > 0) {
          response += `🎯 **Priority Recommendations**:\n`;
          recommendations.forEach((rec, idx) => {
            response += `   ${idx + 1}. ${rec}\n`;
          });
        } else {
          response += `✅ **General Best Practices**:\n`;
          response += `   1. Monitor weather forecasts regularly\n`;
          response += `   2. Maintain optimal soil pH (6.0-7.5)\n`;
          response += `   3. Schedule irrigation based on weather and soil moisture\n`;
          response += `   4. Keep inventory levels above 20%\n`;
          response += `   5. Plan harvest timing for optimal market prices\n`;
          response += `   6. Rotate crops to maintain soil health\n`;
          response += `   7. Use integrated pest management\n`;
          response += `   8. Keep detailed production records\n`;
        }

        response += `\n💬 **Ask me specific questions**:\n`;
        response += `   • "What's the weather forecast?"\n`;
        response += `   • "How are my crops doing?"\n`;
        response += `   • "Check my soil health"\n`;
        response += `   • "Do I need irrigation?"\n`;
        response += `   • "What's my inventory status?"\n`;
      }
      // ✅ IMPROVED: Default response with comprehensive help
      else {
        response = `👋 **Hello! I'm your AI Agricultural Assistant**\n\n`;
        response += `I can help you with comprehensive farming insights based on your real farm data:\n\n`;
        response += `🌤️ **Weather & Climate**:\n`;
        response += `   • Current conditions and forecasts\n`;
        response += `   • Temperature, rainfall, and humidity analysis\n`;
        response += `   • Weather impact on crops\n`;
        response += `   • Irrigation recommendations based on weather\n\n`;
        response += `🌾 **Crop Production**:\n`;
        response += `   • Production status and yields\n`;
        response += `   • Growth stage monitoring\n`;
        response += `   • Harvest planning\n`;
        response += `   • Performance analysis\n\n`;
        response += `🌱 **Soil Management**:\n`;
        response += `   • Soil health analysis (pH, NPK, organic matter)\n`;
        response += `   • Nutrient recommendations\n`;
        response += `   • Fertilizer application guidance\n`;
        response += `   • Soil improvement strategies\n\n`;
        response += `💧 **Irrigation**:\n`;
        response += `   • Water needs assessment\n`;
        response += `   • Irrigation scheduling\n`;
        response += `   • Water usage optimization\n`;
        response += `   • Drought management\n\n`;
        response += `📦 **Inventory Management**:\n`;
        response += `   • Stock levels and alerts\n`;
        response += `   • Restocking recommendations\n`;
        response += `   • Inventory value analysis\n\n`;
        response += `💰 **Market & Sales**:\n`;
        response += `   • Transaction analysis\n`;
        response += `   • Revenue tracking\n`;
        response += `   • Market recommendations\n\n`;
        response += `💡 **General Farming Advice**:\n`;
        response += `   • Best practices\n`;
        response += `   • Personalized recommendations\n`;
        response += `   • Problem-solving guidance\n\n`;
        response += `📝 **Example Questions**:\n`;
        response += `   • "What's the weather forecast for next week?"\n`;
        response += `   • "How are my crops performing?"\n`;
        response += `   • "Do I need to irrigate today?"\n`;
        response += `   • "What's my soil pH and nutrient levels?"\n`;
        response += `   • "Check my inventory for low stock items"\n`;
        response += `   • "What are my recent transactions?"\n`;
        response += `   • "Give me farming recommendations"\n`;
        response += `   • "How can I improve my yields?"\n\n`;
        response += `💬 **Just ask me anything about your farm!**`;
      }

      return response;
    }

    /**
     * Add message to chat
     */
    function addChatMessage(role, message) {
      const container = document.getElementById('aiChatMessages');
      if (!container) return;

      const messageDiv = document.createElement('div');
      messageDiv.className = `ai-message ai-${role}`;
      
      if (role === 'user') {
        messageDiv.style.cssText = 'padding: 16px; background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; border-radius: 8px; margin-left: auto; max-width: 80%;';
        messageDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <i class="fas fa-user" style="color: #3b82f6;"></i>
            <strong style="color: var(--text-primary);">You</strong>
          </div>
          <p style="color: var(--text-secondary); margin: 0; line-height: 1.6; white-space: pre-line;">${escapeHtml(message)}</p>
        `;
      } else {
        messageDiv.style.cssText = 'padding: 16px; background: rgba(34, 197, 94, 0.1); border-left: 4px solid var(--primary-green); border-radius: 8px; max-width: 80%;';
        messageDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <i class="fas fa-robot" style="color: var(--primary-green);"></i>
            <strong style="color: var(--text-primary);">AI Assistant</strong>
          </div>
          <p style="color: var(--text-secondary); margin: 0; line-height: 1.6; white-space: pre-line;">${escapeHtml(message)}</p>
        `;
      }

      container.appendChild(messageDiv);
      container.scrollTop = container.scrollHeight;
    }

    /**
     * Filter recommendations
     */
    function filterRecommendations() {
      const typeFilter = document.getElementById('recommendationsTypeFilter');
      const priorityFilter = document.getElementById('recommendationsPriorityFilter');

      if (!typeFilter || !priorityFilter) return;

      const typeValue = typeFilter.value;
      const priorityValue = priorityFilter.value;

      const filtered = allRecommendationsData.filter(rec => {
        if (typeValue && rec.recommendationType !== typeValue) return false;
        if (priorityValue && rec.priority !== priorityValue) return false;
        return true;
      });

      displayRecommendationsGrid(filtered);
      updateRecommendationsStatistics(filtered);
    }

    /**
     * Clear recommendations filters
     */
    function clearRecommendationsFilters() {
      const typeFilter = document.getElementById('recommendationsTypeFilter');
      const priorityFilter = document.getElementById('recommendationsPriorityFilter');

      if (typeFilter) typeFilter.value = '';
      if (priorityFilter) priorityFilter.value = '';

      displayRecommendationsGrid(allRecommendationsData);
      updateRecommendationsStatistics(allRecommendationsData);
    }









/**
 * Mark recommendation as read
 */
async function markRecommendationAsRead(recommendationId) {
  try {
    // ✅ FIX: Only send API request for database recommendations (not AI-generated ones)
    if (!recommendationId.startsWith('AI-')) {
      await apiRequest(`/ai-recommendations/${recommendationId}/read`, {
        method: 'PUT'
      });
      showToast('✅ Recommendation marked as read', 'success');
    } else {
      // For AI-generated recommendations, just update locally
      showToast('✅ AI recommendation marked as read', 'success');
    }

    // Update local data (works for both DB and AI recommendations)
    const rec = allRecommendationsData.find(r => r.id === recommendationId);
    if (rec) {
      rec.isRead = true;
      rec.readAt = new Date().toISOString();
    }

    // Re-display with updated data
    displayRecommendationsGrid(allRecommendationsData);
    updateRecommendationsStatistics(allRecommendationsData);

  } catch (error) {
    console.error('Error marking recommendation as read:', error);
    showToast('Error marking recommendation as read', 'error');
  }
}







    // ============================================================================
    // ============================================================================
    // PRODUCTION PREDICTIONS MODULE - IMPROVED WITH REAL DATA & CHARTS
    // ============================================================================

    // Global variables for predictions charts
    let yieldComparisonChart = null;
    let productionTrendChart = null;
    let cropPerformanceChart = null;
    let seasonalForecastChart = null;




/**
 * ✅ FIXED: Load and generate predictions based on real data
 * Now properly awaits the async generateAIPredictions function
 */
async function loadPredictionsData() {
  try {
    if (!currentUser || !currentUser.id) {
      showToast('Please login to view predictions', 'warning');
      return;
    }

    showLoading();
    const farmerId = currentUser.id;

    console.log('📊 Loading predictions data for farmer:', farmerId);

    // ✅ Collect ALL real data for accurate predictions
    const [productions, farms, weatherData, soilData, fertilizerUsage, irrigationData, transactions] = await Promise.all([
      apiRequest(`/v1/crop-productions/farmer/${farmerId}`).catch(() => ({ data: [] })),
      apiRequest(`/farms/farmer/${farmerId}/all`).catch(() => []),
      apiRequest(`/weather-data/recent?days=30`).catch(() => []),
      apiRequest(`/v1/soil-data/farmer/${farmerId}`).catch(() => []),
      apiRequest(`/fertilizer-usages/farmer/${farmerId}`).catch(() => ({ content: [] })),
      apiRequest(`/irrigation/farmer/${farmerId}`).catch(() => ({ data: [] })),
      apiRequest(`/transactions/farmer/${farmerId}`).catch(() => ({ content: [] }))
    ]);

    console.log('📦 Raw data loaded:', {
      productions,
      farms: farms.length,
      weather: weatherData.length
    });

    const productionsList = Array.isArray(productions) ? productions :
                           (productions.data && Array.isArray(productions.data) ? productions.data : []);
    const farmsList = Array.isArray(farms) ? farms : [];
    const weatherList = Array.isArray(weatherData) ? weatherData : [];
    const soilList = Array.isArray(soilData) ? soilData : [];
    const fertilizerList = Array.isArray(fertilizerUsage) ? fertilizerUsage :
                          (fertilizerUsage.content && Array.isArray(fertilizerUsage.content) ? fertilizerUsage.content : []);
    const irrigationList = Array.isArray(irrigationData) ? irrigationData :
                          (irrigationData.data && Array.isArray(irrigationData.data) ? irrigationData.data : []);

    console.log('✅ Processed data:', {
      productions: productionsList.length,
      farms: farmsList.length,
      weather: weatherList.length,
      soil: soilList.length,
      fertilizer: fertilizerList.length,
      irrigation: irrigationList.length
    });

    // ✅ CRITICAL FIX: Add await here because generateAIPredictions is now async
    const predictions = await generateAIPredictions(
      productionsList,
      farmsList,
      weatherList,
      soilList,
      fertilizerList,
      irrigationList
    );

    console.log('✅ Predictions generated:', predictions);

    // ✅ Verify predictions is an array before proceeding
    if (!Array.isArray(predictions)) {
      console.error('❌ Predictions is not an array:', predictions);
      throw new Error('Invalid predictions data structure');
    }

    // ✅ Display predictions and charts
    displayPredictionsSummary(predictions);
    displayPredictionsGrid(predictions);
    renderPredictionCharts(predictions, productionsList, weatherList, soilList);

    if (predictions.length > 0) {
      showToast(`Generated ${predictions.length} AI prediction${predictions.length > 1 ? 's' : ''} based on your data`, 'success');
    } else {
      showToast('No active productions found for predictions', 'info');
    }

  } catch (error) {
    console.error('❌ Error loading predictions:', error);
    showToast('Error generating predictions: ' + error.message, 'error');
    displayPredictionsError();
  } finally {
    hideLoading();
  }
}





/**
 * ✅ FIXED: Generate AI predictions from real data with proper crop names
 */
async function generateAIPredictions(productions, farms, weather, soil, fertilizer, irrigation) {
  const predictions = [];

  // Get active productions
  const activeProductions = productions.filter(p =>
    p.productionStatus === 'PLANTED' || p.productionStatus === 'GROWING' ||
    p.productionStatus === 'ACTIVE' || p.productionStatus === 'IN_PROGRESS'
  );

  // Get historical harvested productions for analysis
  const harvestedProductions = productions.filter(p =>
    p.productionStatus === 'HARVESTED' && p.actualYield && parseFloat(p.actualYield) > 0
  );

  // Calculate average historical yield per crop
  const cropYieldHistory = {};
  harvestedProductions.forEach(p => {
    const cropId = p.cropId || 'unknown';
    if (!cropYieldHistory[cropId]) {
      cropYieldHistory[cropId] = { yields: [], areas: [], count: 0 };
    }
    const yield = parseFloat(p.actualYield || 0);
    const area = parseFloat(p.areaInHectares || 1);
    if (yield > 0 && area > 0) {
      cropYieldHistory[cropId].yields.push(yield / area); // Yield per hectare
      cropYieldHistory[cropId].areas.push(area);
      cropYieldHistory[cropId].count++;
    }
  });

  // Calculate average soil quality
  const avgSoilQuality = calculateAverageSoilQuality(soil);
  const avgWeatherScore = calculateWeatherScore(weather);

  // ✅ FIX: Enrich each production with crop name BEFORE generating predictions
  const enrichedProductions = await Promise.all(activeProductions.map(async (production) => {
    try {
      // If crop name is missing, fetch it
      if (production.cropId && !production.cropName) {
        try {
          console.log('🔄 Fetching crop name for ID:', production.cropId);
          const cropResponse = await apiRequest(`/v1/crops/${production.cropId}`);
          const crop = cropResponse.data || cropResponse;
          production.cropName = crop.cropName || crop.name || 'Unknown Crop';
          console.log('✅ Crop name fetched:', production.cropName);
        } catch (error) {
          console.warn(`⚠️ Error fetching crop ${production.cropId}:`, error);
          production.cropName = 'Unknown Crop';
        }
      } else if (!production.cropName) {
        production.cropName = 'Unknown Crop';
      }
    } catch (error) {
      console.warn('⚠️ Error enriching production:', error);
      production.cropName = 'Unknown Crop';
    }
    return production;
  }));

  console.log('✅ Enriched productions with crop names:', enrichedProductions.length);

  // Generate predictions for each enriched production
  enrichedProductions.forEach(production => {
    const cropId = production.cropId || 'unknown';
    const area = parseFloat(production.areaInHectares || 0);
    const expectedYield = parseFloat(production.expectedYield || 0);

    // Get historical data for this crop
    const history = cropYieldHistory[cropId];
    let baseYieldPerHa = 0;
    let confidence = 0.5;

    if (history && history.yields.length > 0) {
      // Calculate average historical yield per hectare
      baseYieldPerHa = history.yields.reduce((a, b) => a + b, 0) / history.yields.length;
      confidence = Math.min(0.95, 0.6 + (history.count * 0.05)); // More data = higher confidence
    } else if (expectedYield > 0 && area > 0) {
      // Use expected yield if no history
      baseYieldPerHa = expectedYield / area;
      confidence = 0.5;
    } else {
      // Default yield if no data
      baseYieldPerHa = 2.5; // Default 2.5 tons/ha
      confidence = 0.3;
    }

    // ✅ AI Adjustment factors based on current conditions
    let adjustmentFactor = 1.0;

    // Soil quality adjustment (0.8 to 1.2)
    if (avgSoilQuality > 0) {
      adjustmentFactor *= (0.8 + (avgSoilQuality / 100) * 0.4);
    }

    // Weather score adjustment (0.85 to 1.15)
    if (avgWeatherScore > 0) {
      adjustmentFactor *= (0.85 + (avgWeatherScore / 100) * 0.3);
    }

    // Fertilizer usage adjustment
    if (fertilizer.length > 0) {
      const recentFertilizer = fertilizer.slice(0, 3);
      const totalFertilizer = recentFertilizer.reduce((sum, f) => sum + parseFloat(f.quantity || 0), 0);
      if (totalFertilizer > 0) {
        adjustmentFactor *= 1.05; // Positive impact of fertilizer
      }
    }

    // Irrigation adjustment
    if (irrigation.length > 0) {
      const recentIrrigation = irrigation.slice(0, 7);
      const totalWater = recentIrrigation.reduce((sum, i) => sum + parseFloat(i.waterUsed || 0), 0);
      if (totalWater > 0) {
        adjustmentFactor *= 1.03; // Positive impact of irrigation
      }
    }

    // Calculate predicted yield
    const predictedYieldPerHa = baseYieldPerHa * adjustmentFactor;
    const predictedTotalYield = predictedYieldPerHa * area;

    // Calculate min/max range (±15% for uncertainty)
    const minYield = predictedTotalYield * 0.85;
    const maxYield = predictedTotalYield * 1.15;

    // ✅ Use the enriched crop name (already fetched above)
    const cropName = production.cropName;

    console.log(`📊 Prediction for ${cropName}:`, {
      predictedYield: predictedTotalYield,
      confidence: confidence
    });

    predictions.push({
      id: production.id || `pred-${Date.now()}-${Math.random()}`,
      cropId: cropId,
      cropName: cropName, // ✅ Now has the real crop name
      farmId: production.farmId,
      areaInHectares: area,
      expectedYield: expectedYield,
      predictedYield: predictedTotalYield,
      predictedYieldPerHa: predictedYieldPerHa,
      minYield: minYield,
      maxYield: maxYield,
      confidenceLevel: confidence,
      modelAccuracy: Math.min(0.95, confidence + 0.1),
      season: getCurrentSeason(),
      year: new Date().getFullYear(),
      plantingDate: production.plantingDate,
      expectedHarvestDate: production.expectedHarvestDate,
      soilQuality: avgSoilQuality,
      weatherScore: avgWeatherScore,
      adjustmentFactors: {
        soil: avgSoilQuality > 0 ? (0.8 + (avgSoilQuality / 100) * 0.4) : 1.0,
        weather: avgWeatherScore > 0 ? (0.85 + (avgWeatherScore / 100) * 0.3) : 1.0,
        fertilizer: fertilizer.length > 0 ? 1.05 : 1.0,
        irrigation: irrigation.length > 0 ? 1.03 : 1.0
      }
    });
  });

  console.log('✅ Generated predictions with crop names:', predictions);
  return predictions;
}




    /**
     * ✅ Calculate average soil quality score
     */
    function calculateAverageSoilQuality(soilList) {
      if (!soilList || soilList.length === 0) return 70; // Default

      const scores = soilList.map(soil => {
        let score = 0;
        let maxScore = 0;

        if (soil.phLevel) {
          maxScore += 30;
          const ph = parseFloat(soil.phLevel);
          if (ph >= 6.0 && ph <= 7.5) score += 30;
          else if ((ph >= 5.5 && ph < 6.0) || (ph > 7.5 && ph <= 8.0)) score += 20;
          else score += 10;
        }

        if (soil.organicMatter) {
          maxScore += 25;
          const om = parseFloat(soil.organicMatter);
          if (om >= 5.0) score += 25;
          else if (om >= 3.0) score += 20;
          else if (om >= 2.0) score += 15;
          else score += 10;
        }

        if (soil.nitrogen && soil.phosphorus && soil.potassium) {
          maxScore += 25;
          const n = parseFloat(soil.nitrogen);
          const p = parseFloat(soil.phosphorus);
          const k = parseFloat(soil.potassium);
          if (n >= 40 && n <= 150) score += 8;
          if (p >= 25 && p <= 100) score += 8;
          if (k >= 150 && k <= 500) score += 9;
        }

        return maxScore > 0 ? (score * 100) / maxScore : 0;
      });

      return scores.reduce((a, b) => a + b, 0) / scores.length;
    }

    /**
     * ✅ Calculate weather score
     */
    function calculateWeatherScore(weatherList) {
      if (!weatherList || weatherList.length === 0) return 70; // Default

      const recent = weatherList.slice(0, 14);
      if (recent.length === 0) return 70;

      let score = 0;
      recent.forEach(w => {
        const temp = parseFloat(w.temperature || 0);
        const humidity = parseFloat(w.humidity || 0);
        const rainfall = parseFloat(w.rainfall || 0);

        let tempScore = 0;
        if (temp >= 20 && temp <= 30) tempScore = 100;
        else if (temp >= 15 && temp <= 35) tempScore = 70;
        else tempScore = 40;

        let humidityScore = 0;
        if (humidity >= 40 && humidity <= 70) humidityScore = 100;
        else if (humidity >= 30 && humidity <= 80) humidityScore = 70;
        else humidityScore = 40;

        let rainfallScore = 0;
        if (rainfall >= 2 && rainfall <= 10) rainfallScore = 100;
        else if (rainfall >= 1 && rainfall <= 15) rainfallScore = 70;
        else rainfallScore = 40;

        score += (tempScore + humidityScore + rainfallScore) / 3;
      });

      return score / recent.length;
    }

    /**
     * ✅ Get current season
     */
    function getCurrentSeason() {
      const month = new Date().getMonth();
      if (month >= 2 && month <= 4) return 'Spring';
      if (month >= 5 && month <= 7) return 'Summer';
      if (month >= 8 && month <= 10) return 'Fall';
      return 'Winter';
    }

    /**
     * ✅ Display predictions summary cards
     */
    function displayPredictionsSummary(predictions) {
      const container = document.getElementById('predictionsSummaryCards');
      if (!container) return;

      if (predictions.length === 0) {
        container.innerHTML = '';
        return;
      }

      const totalPredictedYield = predictions.reduce((sum, p) => sum + parseFloat(p.predictedYield || 0), 0);
      const avgConfidence = predictions.reduce((sum, p) => sum + parseFloat(p.confidenceLevel || 0), 0) / predictions.length;
      const totalArea = predictions.reduce((sum, p) => sum + parseFloat(p.areaInHectares || 0), 0);
      const avgYieldPerHa = totalArea > 0 ? totalPredictedYield / totalArea : 0;

      container.innerHTML = `
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
            <i class="fas fa-seedling"></i>
          </div>
          <div class="stat-value">${totalPredictedYield.toLocaleString()}</div>
          <div class="stat-label">Total Predicted Yield (KG)</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="stat-value">${avgYieldPerHa.toFixed(2)}</div>
          <div class="stat-label">Avg Yield per Hectare (KG/ha)</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <i class="fas fa-brain"></i>
          </div>
          <div class="stat-value">${(avgConfidence * 100).toFixed(0)}%</div>
          <div class="stat-label">AI Confidence Level</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
            <i class="fas fa-map"></i>
          </div>
          <div class="stat-value">${totalArea.toFixed(2)}</div>
          <div class="stat-label">Total Area (Hectares)</div>
        </div>
      `;
    }

    /**
     * ✅ IMPROVED: Display predictions grid with detailed information
     */
    function displayPredictionsGrid(predictions) {
      const container = document.getElementById('predictionsGrid');
      if (!container) return;

      if (!predictions || predictions.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-chart-area" style="font-size: 48px; color: var(--text-light); margin-bottom: 16px;"></i>
            <p style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">No Active Productions</p>
            <p class="empty-state-hint">Start a new crop production to get AI-powered predictions based on your historical data, weather, and soil conditions.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = predictions.map(pred => {
        const confidenceColor = pred.confidenceLevel >= 0.8 ? '#22c55e' : pred.confidenceLevel >= 0.6 ? '#f59e0b' : '#ef4444';
        const yieldDiff = pred.expectedYield > 0 
          ? ((pred.predictedYield - pred.expectedYield) / pred.expectedYield * 100).toFixed(1)
          : 0;
        const yieldDiffColor = yieldDiff > 0 ? '#22c55e' : yieldDiff < 0 ? '#ef4444' : '#666';

        return `
          <div class="prediction-card" style="background: var(--card-bg); border-radius: 16px; padding: 24px; box-shadow: var(--shadow); border: 1px solid var(--border-color);">
            <div class="prediction-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color);">
              <div>
                <div class="prediction-crop" style="font-size: 20px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">${pred.cropName || 'Crop'}</div>
                <div class="prediction-season" style="font-size: 14px; color: var(--text-secondary);">${pred.season} ${pred.year}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Confidence</div>
                <div style="font-size: 18px; font-weight: 700; color: ${confidenceColor};">${(pred.confidenceLevel * 100).toFixed(0)}%</div>
              </div>
            </div>
            <div class="prediction-body">
              <div class="prediction-yield" style="text-align: center; padding: 20px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 20px;">
                <div class="prediction-yield-label" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">AI Predicted Yield</div>
                <div class="prediction-yield-value" style="font-size: 36px; font-weight: 700; color: var(--primary-green);">
                  ${pred.predictedYield.toLocaleString()}
                  <span class="prediction-yield-unit" style="font-size: 18px; color: var(--text-secondary);"> KG</span>
                </div>
                <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
                  ${pred.predictedYieldPerHa.toFixed(2)} KG/ha
                </div>
                ${pred.expectedYield > 0 ? `
                  <div style="margin-top: 12px; padding: 8px; background: ${yieldDiffColor}20; border-radius: 8px; font-size: 13px; color: ${yieldDiffColor}; font-weight: 600;">
                    ${yieldDiff > 0 ? '↑' : yieldDiff < 0 ? '↓' : '→'} ${Math.abs(yieldDiff)}% vs Expected
                  </div>
                ` : ''}
              </div>
              <div class="prediction-metrics" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                <div class="prediction-metric" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                  <div class="prediction-metric-label" style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Min Expected</div>
                  <div class="prediction-metric-value" style="font-size: 16px; font-weight: 700; color: var(--text-primary);">${pred.minYield.toLocaleString()} KG</div>
                </div>
                <div class="prediction-metric" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                  <div class="prediction-metric-label" style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Max Expected</div>
                  <div class="prediction-metric-value" style="font-size: 16px; font-weight: 700; color: var(--text-primary);">${pred.maxYield.toLocaleString()} KG</div>
                </div>
                <div class="prediction-metric" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                  <div class="prediction-metric-label" style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Area</div>
                  <div class="prediction-metric-value" style="font-size: 16px; font-weight: 700; color: var(--text-primary);">${pred.areaInHectares.toFixed(2)} ha</div>
                </div>
                <div class="prediction-metric" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                  <div class="prediction-metric-label" style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Model Accuracy</div>
                  <div class="prediction-metric-value" style="font-size: 16px; font-weight: 700; color: var(--primary-green);">${(pred.modelAccuracy * 100).toFixed(0)}%</div>
                </div>
              </div>
              ${pred.adjustmentFactors ? `
                <div style="margin-top: 16px; padding: 12px; background: var(--light-green); border-radius: 8px; border-left: 4px solid var(--primary-green);">
                  <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">AI Analysis Factors:</div>
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 11px;">
                    <div>🌱 Soil Quality: ${pred.soilQuality.toFixed(0)}%</div>
                    <div>🌤️ Weather Score: ${pred.weatherScore.toFixed(0)}%</div>
                    <div>🧪 Fertilizer Impact: ${pred.adjustmentFactors.fertilizer > 1 ? '+' : ''}${((pred.adjustmentFactors.fertilizer - 1) * 100).toFixed(0)}%</div>
                    <div>💧 Irrigation Impact: ${pred.adjustmentFactors.irrigation > 1 ? '+' : ''}${((pred.adjustmentFactors.irrigation - 1) * 100).toFixed(0)}%</div>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    /**
     * ✅ Display error state
     */
    function displayPredictionsError() {
      const container = document.getElementById('predictionsGrid');
      if (!container) return;

      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--error-color); margin-bottom: 16px;"></i>
          <p style="font-size: 18px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">Error Loading Predictions</p>
          <p class="empty-state-hint">Please try refreshing or contact support if the issue persists.</p>
          <button class="btn btn-primary" onclick="loadPredictionsData()" style="margin-top: 16px;">
            <i class="fas fa-sync-alt"></i> Try Again
          </button>
        </div>
      `;
    }

    /**
     * ✅ Render prediction comparison charts
     */
    function renderPredictionCharts(predictions, productions, weather, soil) {
      renderYieldComparisonChart(predictions, productions);
      renderProductionTrendChart(predictions, productions);
      renderCropPerformanceChart(predictions);
      renderSeasonalForecastChart(predictions, productions);
    }

    /**
     * ✅ Render yield comparison chart (Historical vs Predicted)
     */
    function renderYieldComparisonChart(predictions, productions) {
      const canvas = document.getElementById('yieldComparisonChart');
      if (!canvas) return;

      // Get historical harvested data
      const harvested = productions.filter(p => 
        p.productionStatus === 'HARVESTED' && p.actualYield && parseFloat(p.actualYield) > 0
      );

      // Group by crop
      const cropData = {};
      predictions.forEach(pred => {
        const cropName = pred.cropName || 'Unknown';
        if (!cropData[cropName]) {
          cropData[cropName] = { predicted: 0, historical: [] };
        }
        cropData[cropName].predicted += pred.predictedYield;
      });

      harvested.forEach(h => {
        const cropName = h.cropName || 'Unknown';
        if (!cropData[cropName]) {
          cropData[cropName] = { predicted: 0, historical: [] };
        }
        cropData[cropName].historical.push(parseFloat(h.actualYield || 0));
      });

      const crops = Object.keys(cropData);
      const historicalYields = crops.map(crop => {
        const yields = cropData[crop].historical;
        return yields.length > 0 ? yields.reduce((a, b) => a + b, 0) / yields.length : 0;
      });
      const predictedYields = crops.map(crop => cropData[crop].predicted);

      // Destroy existing chart properly
      if (yieldComparisonChart && typeof yieldComparisonChart.destroy === 'function') {
        yieldComparisonChart.destroy();
        yieldComparisonChart = null;
      }
      
      // Also check if Chart.js has a chart registered on this canvas
      const existingChart = Chart.getChart(canvas);
      if (existingChart) {
        existingChart.destroy();
      }

      const ctx = canvas.getContext('2d');
      yieldComparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: crops,
          datasets: [{
            label: 'Historical Average Yield (KG)',
            data: historicalYields,
            backgroundColor: 'rgba(59, 130, 246, 0.6)',
            borderColor: '#3b82f6',
            borderWidth: 2
          }, {
            label: 'AI Predicted Yield (KG)',
            data: predictedYields,
            backgroundColor: 'rgba(34, 197, 94, 0.6)',
            borderColor: '#22c55e',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15,
                font: { size: 12, weight: '600' }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              callbacks: {
                label: function(context) {
                  const value = context.parsed.y;
                  const diff = context.datasetIndex === 1 && historicalYields[context.dataIndex] > 0
                    ? ((value - historicalYields[context.dataIndex]) / historicalYields[context.dataIndex] * 100).toFixed(1)
                    : '';
                  return `${context.dataset.label}: ${value.toLocaleString()} KG${diff ? ` (${diff > 0 ? '+' : ''}${diff}%)` : ''}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Yield (KG)',
                font: { size: 12, weight: 'bold' }
              },
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + ' KG';
                }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 0
              }
            }
          }
        }
      });
    }

    /**
     * ✅ Render production trend chart
     */
    function renderProductionTrendChart(predictions, productions) {
      const canvas = document.getElementById('productionTrendChart');
      if (!canvas) return;

      // Get monthly data for last 6 months
      const monthlyData = {};
      const now = new Date();

      // Historical data
      productions.filter(p => p.actualHarvestDate || p.createdAt).forEach(p => {
        const date = new Date(p.actualHarvestDate || p.createdAt);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = { historical: 0, predicted: 0 };
        }
        if (p.actualYield) {
          monthlyData[monthKey].historical += parseFloat(p.actualYield || 0);
        }
      });

      // Predicted data (next 3 months)
      for (let i = 0; i < 3; i++) {
        const futureDate = new Date(now.getFullYear(), now.getMonth() + i + 1, 1);
        const monthKey = `${futureDate.getFullYear()}-${String(futureDate.getMonth() + 1).padStart(2, '0')}`;
        if (!monthlyData[monthKey]) {
          monthlyData[monthKey] = { historical: 0, predicted: 0 };
        }
        // Add predictions for this month
        predictions.forEach(pred => {
          if (pred.expectedHarvestDate) {
            const harvestDate = new Date(pred.expectedHarvestDate);
            if (harvestDate.getMonth() === futureDate.getMonth() && harvestDate.getFullYear() === futureDate.getFullYear()) {
              monthlyData[monthKey].predicted += pred.predictedYield;
            }
          }
        });
      }

      const sortedMonths = Object.keys(monthlyData).sort().slice(-6);
      const labels = sortedMonths.map(m => {
        const [year, month] = m.split('-');
        return new Date(year, parseInt(month) - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      });
      const historicalData = sortedMonths.map(m => monthlyData[m].historical);
      const predictedData = sortedMonths.map(m => monthlyData[m].predicted);

      // Destroy existing chart properly
      if (productionTrendChart && typeof productionTrendChart.destroy === 'function') {
        productionTrendChart.destroy();
        productionTrendChart = null;
      }
      
      // Also check if Chart.js has a chart registered on this canvas
      const existingChart = Chart.getChart(canvas);
      if (existingChart) {
        existingChart.destroy();
      }

      const ctx = canvas.getContext('2d');
      productionTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Historical Production',
            data: historicalData,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            fill: true
          }, {
            label: 'AI Predicted Production',
            data: predictedData,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.4,
            fill: true,
            borderDash: [5, 5]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} KG`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Production (KG)',
                font: { size: 12, weight: 'bold' }
              }
            }
          }
        }
      });
    }

    /**
     * ✅ Render crop performance chart
     */
    function renderCropPerformanceChart(predictions) {
      const canvas = document.getElementById('cropPerformanceChart');
      if (!canvas) return;

      // Group by crop and calculate performance metrics
      const cropPerformance = {};
      predictions.forEach(pred => {
        const cropName = pred.cropName || 'Unknown';
        if (!cropPerformance[cropName]) {
          cropPerformance[cropName] = {
            predictedYield: 0,
            area: 0,
            confidence: [],
            count: 0
          };
        }
        cropPerformance[cropName].predictedYield += pred.predictedYield;
        cropPerformance[cropName].area += pred.areaInHectares;
        cropPerformance[cropName].confidence.push(pred.confidenceLevel);
        cropPerformance[cropName].count++;
      });

      const crops = Object.keys(cropPerformance);
      const yields = crops.map(crop => cropPerformance[crop].predictedYield);
      const avgConfidence = crops.map(crop => {
        const confs = cropPerformance[crop].confidence;
        return confs.reduce((a, b) => a + b, 0) / confs.length;
      });

      // Destroy existing chart properly
      if (cropPerformanceChart && typeof cropPerformanceChart.destroy === 'function') {
        cropPerformanceChart.destroy();
        cropPerformanceChart = null;
      }
      
      // Also check if Chart.js has a chart registered on this canvas
      const existingChart = Chart.getChart(canvas);
      if (existingChart) {
        existingChart.destroy();
      }

      const ctx = canvas.getContext('2d');
      cropPerformanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: crops,
          datasets: [{
            label: 'Predicted Yield (KG)',
            data: yields,
            backgroundColor: 'rgba(34, 197, 94, 0.6)',
            borderColor: '#22c55e',
            borderWidth: 2,
            yAxisID: 'y'
          }, {
            label: 'Confidence Level (%)',
            data: avgConfidence.map(c => c * 100),
            type: 'line',
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            borderWidth: 3,
            yAxisID: 'y1',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              position: 'left',
              title: {
                display: true,
                text: 'Yield (KG)',
                font: { size: 12, weight: 'bold' }
              }
            },
            y1: {
              beginAtZero: true,
              max: 100,
              position: 'right',
              title: {
                display: true,
                text: 'Confidence (%)',
                font: { size: 12, weight: 'bold' }
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    }

    /**
     * ✅ Render seasonal forecast chart
     */
    function renderSeasonalForecastChart(predictions, productions) {
      const canvas = document.getElementById('seasonalForecastChart');
      if (!canvas) return;

      // Group by season
      const seasonData = {
        'Spring': { historical: 0, predicted: 0 },
        'Summer': { historical: 0, predicted: 0 },
        'Fall': { historical: 0, predicted: 0 },
        'Winter': { historical: 0, predicted: 0 }
      };

      // Historical data by season
      productions.filter(p => p.actualHarvestDate && p.actualYield).forEach(p => {
        const date = new Date(p.actualHarvestDate);
        const month = date.getMonth();
        let season = 'Spring';
        if (month >= 5 && month <= 7) season = 'Summer';
        else if (month >= 8 && month <= 10) season = 'Fall';
        else if (month >= 11 || month <= 1) season = 'Winter';
        
        seasonData[season].historical += parseFloat(p.actualYield || 0);
      });

      // Predicted data by season
      predictions.forEach(pred => {
        const season = pred.season || 'Spring';
        if (seasonData[season]) {
          seasonData[season].predicted += pred.predictedYield;
        }
      });

      const seasons = Object.keys(seasonData);
      const historicalData = seasons.map(s => seasonData[s].historical);
      const predictedData = seasons.map(s => seasonData[s].predicted);

      // Destroy existing chart properly
      if (seasonalForecastChart && typeof seasonalForecastChart.destroy === 'function') {
        seasonalForecastChart.destroy();
        seasonalForecastChart = null;
      }
      
      // Also check if Chart.js has a chart registered on this canvas
      const existingChart = Chart.getChart(canvas);
      if (existingChart) {
        existingChart.destroy();
      }

      const ctx = canvas.getContext('2d');
      seasonalForecastChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: seasons,
          datasets: [{
            label: 'Historical Average',
            data: historicalData,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            borderWidth: 2
          }, {
            label: 'AI Predicted',
            data: predictedData,
            borderColor: '#22c55e',
            backgroundColor: 'rgba(34, 197, 94, 0.2)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            r: {
              beginAtZero: true
            }
          }
        }
      });
    }

    /**
     * ✅ Refresh production predictions (called by button)
     */
    function refreshProductionPredictions() {
      showToast('Refreshing predictions...', 'info');
      loadPredictionsData();
    }

    /**
     * ✅ IMPROVED: Refresh entire dashboard page
     */
    function refreshDashboard() {
      showToast('Refreshing dashboard...', 'info');
      
      // Get current active section
      const currentSection = document.querySelector('.content-section.active');
      const currentSectionName = currentSection ? currentSection.id.replace('Section', '').toLowerCase() : 'dashboard';
      
      // Reload all data for current section
      if (typeof loadSectionData === 'function') {
        loadSectionData(currentSectionName);
      }
      
      // Also reload dashboard data if not already on dashboard
      if (currentSectionName !== 'dashboard' && typeof loadDashboardData === 'function') {
        loadDashboardData();
      }
      
      // Force reload predictions if on predictions section
      if (currentSectionName === 'predictions') {
        loadPredictionsData();
      }
      
      // Force reload recommendations if on recommendations section
      if (currentSectionName === 'recommendations') {
        if (typeof loadRecommendationsData === 'function') {
          loadRecommendationsData();
        }
      }
      
      showToast('Dashboard refreshed successfully', 'success');
    }

    // ✅ Make refreshDashboard available globally for refresh button
    window.refreshDashboard = refreshDashboard;

    // ============================================================================
    // REPORTS MODULE
    // ============================================================================

    /**
     * Initialize reports listeners
     */
    function initReportsListeners() {
      const previewBtn = document.querySelector('[data-action="preview-report"]');
      if (previewBtn) {
        previewBtn.addEventListener('click', previewReport);
      }

      const pdfBtn = document.querySelector('[data-action="generate-pdf-report"]');
      if (pdfBtn) {
        pdfBtn.addEventListener('click', generatePDFReport);
      }

      const excelBtn = document.querySelector('[data-action="generate-excel-report"]');
      if (excelBtn) {
        excelBtn.addEventListener('click', generateExcelReport);
      }

      const closePreviewBtn = document.querySelector('[data-action="close-preview"]');
      if (closePreviewBtn) {
        closePreviewBtn.addEventListener('click', () => {
          document.getElementById('reportPreview').style.display = 'none';
        });
      }
    }

    /**
     * Preview report
     */
    async function previewReport() {
      try {
        showLoading();

        const reportType = document.getElementById('reportType').value;
        const reportPeriod = document.getElementById('reportPeriod').value;
        const dateFrom = document.getElementById('reportDateFrom').value;
        const dateTo = document.getElementById('reportDateTo').value;

        // Generate report data
        const reportData = await generateReportData(reportType, reportPeriod, dateFrom, dateTo);

        // Display preview
        const previewContainer = document.getElementById('reportPreview');
        const previewContent = document.getElementById('reportPreviewContent');

        previewContent.innerHTML = generateReportHTML(reportType, reportData);
        previewContainer.style.display = 'block';

        showToast('Report preview generated', 'success');

      } catch (error) {
        console.error('Error generating report preview:', error);
        showToast('Error generating report preview', 'error');
      } finally {
        hideLoading();
      }
    }



    /**
     * Generate report data
     */
    async function generateReportData(reportType, period, dateFrom, dateTo) {
      const data = {
        reportType: reportType,
        period: period,
        dateFrom: dateFrom,
        dateTo: dateTo,
        generatedAt: new Date().toISOString(),
        farmerName: currentUser ? currentUser.fullName : 'Unknown',
        farmerEmail: currentUser ? currentUser.email : 'Unknown'
      };

      try {
        switch (reportType) {
          case 'farm-overview':
            data.content = await generateFarmOverviewReport(dateFrom, dateTo);
            break;
          case 'production-summary':
            data.content = await generateProductionSummaryReport(dateFrom, dateTo);
            break;
          case 'financial-report':
            data.content = await generateFinancialReport(dateFrom, dateTo);
            break;
          case 'resource-usage':
            data.content = await generateResourceUsageReport(dateFrom, dateTo);
            break;
          case 'inventory-report':
            data.content = await generateInventoryReport(dateFrom, dateTo);
            break;
          default:
            throw new Error('Invalid report type');
        }

        return data;
      } catch (error) {
        console.error('Error generating report data:', error);
        throw error;
      }
    }

    /**
     * Generate farm overview report
     */
    async function generateFarmOverviewReport(dateFrom, dateTo) {
      const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
      const farms = farmsResponse || [];

      const totalFarms = farms.length;
      const totalArea = farms.reduce((sum, farm) => sum + (parseFloat(farm.farmSize || farm.sizeHectares || 0)), 0);
      const irrigatedFarms = farms.filter(f => f.irrigationSystem && f.irrigationSystem !== 'RAIN_FED').length;
      const activeFarms = farms.filter(f => f.isActive !== false).length;

      // Soil type distribution (only real data, no "Unknown")
      const soilTypeDistribution = {};
      farms.forEach(farm => {
        const soilType = farm.soilType;
        if (soilType && soilType.trim() !== '') {
          soilTypeDistribution[soilType] = (soilTypeDistribution[soilType] || 0) + 1;
        }
      });

      // Irrigation system distribution (only real data, no "Unknown")
      const irrigationDistribution = {};
      farms.forEach(farm => {
        const irrigation = farm.irrigationSystem;
        if (irrigation && irrigation.trim() !== '') {
          const formatted = formatIrrigationForReport(irrigation);
          irrigationDistribution[formatted] = (irrigationDistribution[formatted] || 0) + 1;
        }
      });

      return {
        summary: {
          totalFarms,
          totalArea: totalArea.toFixed(2),
          irrigatedFarms,
          activeFarms,
          inactiveFarms: totalFarms - activeFarms
        },
        farms: farms.map(farm => {
          // Build location from coordinates if available
          let location = '';
          if (farm.location) {
            location = farm.location;
          } else if (farm.latitude && farm.longitude) {
            location = `${parseFloat(farm.latitude).toFixed(4)}, ${parseFloat(farm.longitude).toFixed(4)}`;
          }
          
          return {
            name: farm.farmName || '',
            code: farm.farmCode || '',
            location: location,
            size: parseFloat(farm.farmSize || farm.sizeHectares || 0),
            soilType: farm.soilType || '',
            irrigationSystem: formatIrrigationForReport(farm.irrigationSystem),
            status: farm.isActive ? 'Active' : 'Inactive'
          };
        }),
        soilTypeDistribution,
        irrigationDistribution
      };
    }

    /**
     * Generate production summary report
     */



    async function generateProductionSummaryReport(dateFrom, dateTo) {
      const productionsResponse = await apiRequest(`/v1/crop-productions/farmer/${currentUser.id}`);
      let productions = [];
      
      // Handle response format
      if (productionsResponse && productionsResponse.data) {
        productions = Array.isArray(productionsResponse.data) ? productionsResponse.data : [];
      } else if (Array.isArray(productionsResponse)) {
        productions = productionsResponse;
      }

      // Enrich productions with crop names
      const enrichedProductions = await Promise.all(productions.map(async (p) => {
        try {
          // Fetch crop details if missing
          if (p.cropId && !p.cropName) {
            try {
              const cropResponse = await apiRequest(`/v1/crops/${p.cropId}`);
              const crop = cropResponse.data || cropResponse;
              p.cropName = crop.cropName || crop.name || '';
            } catch (error) {
              console.warn(`Error fetching crop ${p.cropId}:`, error);
            }
          }
        } catch (error) {
          console.warn('Error enriching production:', error);
        }
        return p;
      }));

      // Use enriched productions
      productions = enrichedProductions;

      // Filter by date range if provided
      if (dateFrom && dateTo) {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);
        productions = productions.filter(p => {
          if (!p.plantingDate) return true;
          const plantingDate = new Date(p.plantingDate);
          return plantingDate >= from && plantingDate <= to;
        });
      }

      const totalProductions = productions.length;
      const activeProductions = productions.filter(p =>
        ['PLANTED', 'GROWING'].includes(p.productionStatus)
      ).length;
      const completedProductions = productions.filter(p =>
        p.productionStatus === 'HARVESTED'
      ).length;

      const totalArea = productions.reduce((sum, p) =>
        sum + (parseFloat(p.areaPlanted) || 0), 0
      );

      const totalYield = productions.reduce((sum, p) =>
        sum + (parseFloat(p.actualYield) || 0), 0
      );

      const totalExpectedYield = productions.reduce((sum, p) =>
        sum + (parseFloat(p.expectedYield) || 0), 0
      );

      // Crop type distribution (only real data)
      const cropDistribution = {};
      productions.forEach(p => {
        const crop = p.cropName;
        if (crop && crop.trim() !== '') {
          if (!cropDistribution[crop]) {
            cropDistribution[crop] = {
              count: 0,
              area: 0,
              yield: 0
            };
          }
          cropDistribution[crop].count++;
          cropDistribution[crop].area += parseFloat(p.areaPlanted) || 0;
          cropDistribution[crop].yield += parseFloat(p.actualYield) || 0;
        }
      });

      // Season distribution (only real data)
      const seasonDistribution = {};
      productions.forEach(p => {
        if (p.season && p.year) {
          const season = `${p.season} ${p.year}`;
          seasonDistribution[season] = (seasonDistribution[season] || 0) + 1;
        }
      });

      // Status distribution (only real data)
      const statusDistribution = {};
      productions.forEach(p => {
        const status = p.productionStatus;
        if (status && status.trim() !== '') {
          statusDistribution[status] = (statusDistribution[status] || 0) + 1;
        }
      });

      return {
        summary: {
          totalProductions,
          activeProductions,
          completedProductions,
          totalArea: totalArea.toFixed(2),
          totalYield: totalYield.toFixed(2),
          totalExpectedYield: totalExpectedYield.toFixed(2),
          averageYield: totalProductions > 0 ? (totalYield / totalProductions).toFixed(2) : 0
        },
        productions: productions.map(p => {
          // Get crop name if not already present
          let cropName = p.cropName || '';
          if (!cropName && p.crop) {
            cropName = p.crop.cropName || p.crop.name || '';
          }
          
          return {
            code: p.productionCode || p.id || '',
            crop: cropName,
            season: p.season ? (p.year ? `${p.season} ${p.year}` : String(p.season)) : '',
            area: parseFloat(p.areaPlanted || 0),
            expectedYield: parseFloat(p.expectedYield || 0),
            actualYield: parseFloat(p.actualYield || 0),
            plantingDate: p.plantingDate ? formatDate(p.plantingDate) : '',
            expectedHarvestDate: p.expectedHarvestDate ? formatDate(p.expectedHarvestDate) : '',
            actualHarvestDate: p.actualHarvestDate ? formatDate(p.actualHarvestDate) : '',
            status: p.productionStatus || ''
          };
        }),
        cropDistribution,
        seasonDistribution,
        statusDistribution
      };
    }

    /**
     * Generate financial report
     */
    async function generateFinancialReport(dateFrom, dateTo) {
      // Fetch all financial data
      const [
        fertilizerResponse,
        irrigationResponse,
        inventoryResponse,
        transactionsResponse
      ] = await Promise.all([
        apiRequest('/fertilizer-usages'),
        apiRequest(`/irrigation/farm/${currentUser.id}`),
        apiRequest(`/v1/inventories/farmer/${currentUser.id}`),
        apiRequest(`/transactions/farmer/${currentUser.id}`)
      ]);

      let fertilizers = [];
      let irrigations = [];
      let inventory = [];
      let transactions = [];
      
      // Handle fertilizer response
      if (fertilizerResponse && fertilizerResponse.content) {
        fertilizers = Array.isArray(fertilizerResponse.content) ? fertilizerResponse.content : [];
      } else if (Array.isArray(fertilizerResponse)) {
        fertilizers = fertilizerResponse;
      }
      
      // Handle irrigation response
      if (irrigationResponse && irrigationResponse.content) {
        irrigations = Array.isArray(irrigationResponse.content) ? irrigationResponse.content : [];
      } else if (Array.isArray(irrigationResponse)) {
        irrigations = irrigationResponse;
      }
      
      // Handle inventory response
      if (inventoryResponse && inventoryResponse.data) {
        inventory = Array.isArray(inventoryResponse.data) ? inventoryResponse.data : [];
      } else if (inventoryResponse && inventoryResponse.content) {
        inventory = Array.isArray(inventoryResponse.content) ? inventoryResponse.content : [];
      } else if (Array.isArray(inventoryResponse)) {
        inventory = inventoryResponse;
      }
      
      // Handle transactions response
      if (transactionsResponse && transactionsResponse.content) {
        transactions = Array.isArray(transactionsResponse.content) ? transactionsResponse.content : [];
      } else if (Array.isArray(transactionsResponse)) {
        transactions = transactionsResponse;
      }

      // Filter by date range if provided
      if (dateFrom && dateTo) {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);

        fertilizers = fertilizers.filter(f => {
          const date = new Date(f.applicationDate);
          return date >= from && date <= to;
        });

        irrigations = irrigations.filter(i => {
          const date = new Date(i.irrigationDate);
          return date >= from && date <= to;
        });

        transactions = transactions.filter(t => {
          const date = new Date(t.transactionDate);
          return date >= from && date <= to;
        });
      }

      // Calculate costs
      const fertilizerCost = fertilizers.reduce((sum, f) =>
        sum + (parseFloat(f.totalCost) || 0), 0
      );

      const irrigationCost = irrigations.reduce((sum, i) =>
        sum + (parseFloat(i.totalCost) || 0), 0
      );

      const totalCosts = fertilizerCost + irrigationCost;

      // Calculate revenues
      const totalRevenue = transactions
        .filter(t => t.transactionStatus === 'PAID')
        .reduce((sum, t) => sum + (parseFloat(t.totalAmount) || 0), 0);

      const netRevenue = transactions
        .filter(t => t.transactionStatus === 'PAID')
        .reduce((sum, t) => sum + (parseFloat(t.netAmount) || 0), 0);

      const transactionFees = totalRevenue - netRevenue;

      // Calculate inventory value
      const inventoryValue = Array.isArray(inventory) ? inventory.reduce((sum, item) =>
        sum + (parseFloat(item.totalMarketValue) || 0), 0
      ) : 0;

      // Profit/Loss
      const profitLoss = netRevenue - totalCosts;

      // Monthly breakdown
      const monthlyData = {};

      transactions.forEach(t => {
        if (t.transactionStatus === 'PAID') {
          const date = new Date(t.transactionDate);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

          if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = {
              revenue: 0,
              costs: 0,
              profit: 0
            };
          }
          monthlyData[monthKey].revenue += parseFloat(t.netAmount) || 0;
        }
      });

      fertilizers.forEach(f => {
        const date = new Date(f.applicationDate);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (monthlyData[monthKey]) {
          monthlyData[monthKey].costs += parseFloat(f.totalCost) || 0;
        }
      });

      irrigations.forEach(i => {
        const date = new Date(i.irrigationDate);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (monthlyData[monthKey]) {
          monthlyData[monthKey].costs += parseFloat(i.totalCost) || 0;
        }
      });

      // Calculate profit for each month
      Object.keys(monthlyData).forEach(month => {
        monthlyData[month].profit = monthlyData[month].revenue - monthlyData[month].costs;
      });

      // Enrich transactions with buyer and crop names
      const enrichedTransactions = await Promise.all(transactions.map(async (t) => {
        try {
          // Fetch buyer details if missing
          if (t.buyerId && !t.buyerName && !t.buyerFullName) {
            try {
              const buyerResponse = await apiRequest(`/users/${t.buyerId}`);
              const buyer = buyerResponse.data || buyerResponse;
              t.buyerName = buyer.fullName || buyer.username || '';
            } catch (error) {
              console.warn(`Error fetching buyer ${t.buyerId}:`, error);
            }
          }

          // Fetch crop details if missing
          if (t.cropId && !t.cropName) {
            try {
              const cropResponse = await apiRequest(`/v1/crops/${t.cropId}`);
              const crop = cropResponse.data || cropResponse;
              t.cropName = crop.cropName || crop.name || '';
            } catch (error) {
              console.warn(`Error fetching crop ${t.cropId}:`, error);
            }
          }
        } catch (error) {
          console.warn('Error enriching transaction:', error);
        }
        return t;
      }));

      return {
        summary: {
          totalRevenue: totalRevenue,
          totalExpenses: totalCosts,
          netProfit: profitLoss,
          profitMargin: totalRevenue > 0 ? ((profitLoss / totalRevenue) * 100).toFixed(1) : 0,
          totalTransactions: transactions.length,
          avgTransactionValue: transactions.length > 0 ? (totalRevenue / transactions.length) : 0
        },
        transactions: enrichedTransactions.map(t => ({
          date: t.transactionDate ? formatDate(t.transactionDate) : (t.createdAt ? formatDate(t.createdAt) : ''),
          buyer: t.buyerName || t.buyerFullName || '',
          crop: t.cropName || '',
          quantity: parseFloat(t.quantity || 0),
          unit: t.unit || 'KG',
          amount: parseFloat(t.totalAmount || t.netAmount || 0),
          status: t.transactionStatus || ''
        })),
        monthlyData
      };
    }

    /**
     * Generate resource usage report
     */
    async function generateResourceUsageReport(dateFrom, dateTo) {
      const [
        fertilizerResponse,
        irrigationResponse
      ] = await Promise.all([
        apiRequest('/fertilizer-usages'),
        apiRequest(`/irrigation/farm/${currentUser.id}`)
      ]);

      let fertilizers = [];
      let irrigations = [];
      
      // Handle fertilizer response
      if (fertilizerResponse && fertilizerResponse.content) {
        fertilizers = Array.isArray(fertilizerResponse.content) ? fertilizerResponse.content : [];
      } else if (Array.isArray(fertilizerResponse)) {
        fertilizers = fertilizerResponse;
      }
      
      // Handle irrigation response
      if (irrigationResponse && irrigationResponse.content) {
        irrigations = Array.isArray(irrigationResponse.content) ? irrigationResponse.content : [];
      } else if (Array.isArray(irrigationResponse)) {
        irrigations = irrigationResponse;
      }

      // Filter by date range if provided
      if (dateFrom && dateTo) {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);

        fertilizers = fertilizers.filter(f => {
          const date = new Date(f.applicationDate);
          return date >= from && date <= to;
        });

        irrigations = irrigations.filter(i => {
          const date = new Date(i.irrigationDate);
          return date >= from && date <= to;
        });
      }

      // Fertilizer statistics
      const totalFertilizerApplications = fertilizers.length;
      const totalFertilizerQuantity = fertilizers.reduce((sum, f) =>
        sum + (parseFloat(f.quantity) || 0), 0
      );
      const totalFertilizerCost = fertilizers.reduce((sum, f) =>
        sum + (parseFloat(f.totalCost) || 0), 0
      );

      // Fertilizer type distribution (only real data)
      const fertilizerTypeDistribution = {};
      fertilizers.forEach(f => {
        const type = f.fertilizerType;
        if (type && type.trim() !== '') {
          if (!fertilizerTypeDistribution[type]) {
            fertilizerTypeDistribution[type] = {
              applications: 0,
              quantity: 0,
              cost: 0
            };
          }
          fertilizerTypeDistribution[type].applications++;
          fertilizerTypeDistribution[type].quantity += parseFloat(f.quantity) || 0;
          fertilizerTypeDistribution[type].cost += parseFloat(f.totalCost) || 0;
        }
      });

      // Irrigation statistics
      const totalIrrigationSessions = irrigations.length;
      const totalWaterUsed = irrigations.reduce((sum, i) =>
        sum + (parseFloat(i.waterAmountLiters) || 0), 0
      );
      const totalIrrigationCost = irrigations.reduce((sum, i) =>
        sum + (parseFloat(i.totalCost) || 0), 0
      );
      const avgWaterEfficiency = irrigations.length > 0
        ? irrigations.reduce((sum, i) => sum + (parseFloat(i.waterUseEfficiency) || 0), 0) / irrigations.length
        : 0;

      // Irrigation method distribution (only real data)
      const irrigationMethodDistribution = {};
      irrigations.forEach(i => {
        const method = i.irrigationMethod;
        if (method && method.trim() !== '') {
          if (!irrigationMethodDistribution[method]) {
            irrigationMethodDistribution[method] = {
              sessions: 0,
              waterUsed: 0,
              cost: 0
            };
          }
          irrigationMethodDistribution[method].sessions++;
          irrigationMethodDistribution[method].waterUsed += parseFloat(i.waterAmountLiters) || 0;
          irrigationMethodDistribution[method].cost += parseFloat(i.totalCost) || 0;
        }
      });

      // Water source distribution (only real data)
      const waterSourceDistribution = {};
      irrigations.forEach(i => {
        const source = i.waterSource;
        if (source && source.trim() !== '') {
          waterSourceDistribution[source] = (waterSourceDistribution[source] || 0) + 1;
        }
      });

      return {
        summary: {
          fertilizerApplications: totalFertilizerApplications,
          totalFertilizerQuantity: totalFertilizerQuantity.toFixed(2) + ' KG',
          totalFertilizerCost: formatCurrency(totalFertilizerCost),
          irrigationSessions: totalIrrigationSessions,
          totalWaterUsed: totalWaterUsed.toFixed(2) + ' L',
          totalIrrigationCost: formatCurrency(totalIrrigationCost),
          avgWaterEfficiency: (avgWaterEfficiency * 100).toFixed(1) + '%',
          totalResourceCost: formatCurrency(totalFertilizerCost + totalIrrigationCost)
        },
        fertilizerUsage: fertilizers.map(f => ({
          date: f.applicationDate ? formatDate(f.applicationDate) : '',
          type: f.fertilizerType || '',
          name: f.fertilizerName || '',
          quantity: parseFloat(f.quantity || 0),
          method: f.applicationMethod || '',
          cost: parseFloat(f.totalCost || 0),
          effectiveness: f.effectivenessRating ? `${f.effectivenessRating}/5` : ''
        })),
        irrigationData: irrigations.map(i => ({
          date: i.irrigationDate ? formatDate(i.irrigationDate) : '',
          method: i.irrigationMethod || '',
          waterUsed: parseFloat(i.waterAmountLiters || 0),
          duration: i.durationMinutes ? `${i.durationMinutes} min` : '',
          cost: parseFloat(i.totalCost || 0),
          waterSource: i.waterSource || ''
        })),
        summary: {
          totalFertilizerCost: totalFertilizerCost,
          totalIrrigationCost: totalIrrigationCost,
          totalWaterUsed: totalWaterUsed,
          waterEfficiency: avgWaterEfficiency * 100,
          totalResourceCost: totalFertilizerCost + totalIrrigationCost
        }
      };
    }

    /**
     * Generate inventory report
     */
    async function generateInventoryReport(dateFrom, dateTo) {
      const inventoryResponse = await apiRequest(`/v1/inventories/farmer/${currentUser.id}`);
      let inventory = [];
      
      // Handle response format
      if (inventoryResponse && inventoryResponse.data) {
        inventory = Array.isArray(inventoryResponse.data) ? inventoryResponse.data : [];
      } else if (inventoryResponse && inventoryResponse.content) {
        inventory = Array.isArray(inventoryResponse.content) ? inventoryResponse.content : [];
      } else if (Array.isArray(inventoryResponse)) {
        inventory = inventoryResponse;
      }

      // Filter by date range if provided (based on storage date)
      if (dateFrom && dateTo) {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);
        inventory = inventory.filter(item => {
          if (!item.storageDate) return true;
          const date = new Date(item.storageDate);
          return date >= from && date <= to;
        });
      }

      const totalItems = inventory.length;
      const totalQuantity = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.currentQuantity) || 0), 0
      );
      const totalValue = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.totalMarketValue) || 0), 0
      );
      const availableQuantity = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.availableQuantity) || 0), 0
      );

      // Status distribution (only real data)
      const statusDistribution = {};
      inventory.forEach(item => {
        const status = item.status;
        if (status && status.trim() !== '') {
          statusDistribution[status] = (statusDistribution[status] || 0) + 1;
        }
      });

      // Quality distribution (only real data)
      const qualityDistribution = {};
      inventory.forEach(item => {
        const quality = item.qualityGrade;
        if (quality && quality.trim() !== '') {
          qualityDistribution[quality] = (qualityDistribution[quality] || 0) + 1;
        }
      });

      // Crop distribution (only real data)
      const cropDistribution = {};
      inventory.forEach(item => {
        const crop = item.cropName || item.itemName;
        if (crop && crop.trim() !== '') {
          if (!cropDistribution[crop]) {
            cropDistribution[crop] = {
              quantity: 0,
              value: 0
            };
          }
          cropDistribution[crop].quantity += parseFloat(item.currentQuantity) || 0;
          cropDistribution[crop].value += parseFloat(item.totalMarketValue) || 0;
        }
      });

      // Expiring items (within 30 days)
      const today = new Date();
      const expiringItems = inventory.filter(item => {
        if (!item.expiryDate) return false;
        const expiry = new Date(item.expiryDate);
        const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
        return daysUntil > 0 && daysUntil <= 30;
      });

      // Expired items
      const expiredItems = inventory.filter(item => {
        if (!item.expiryDate) return false;
        const expiry = new Date(item.expiryDate);
        return expiry < today;
      });

      // Low stock items (available < 20% of current)
      const lowStockItems = inventory.filter(item => {
        const available = parseFloat(item.availableQuantity) || 0;
        const current = parseFloat(item.currentQuantity) || 0;
        return current > 0 && available < current * 0.2;
      });

      return {
        summary: {
          totalItems,
          totalQuantity: totalQuantity.toFixed(2) + ' KG',
          availableQuantity: availableQuantity.toFixed(2) + ' KG',
          totalValue: formatCurrency(totalValue),
          averageValuePerItem: totalItems > 0 ? formatCurrency(totalValue / totalItems) : formatCurrency(0),
          expiringItemsCount: expiringItems.length,
          expiredItemsCount: expiredItems.length,
          lowStockItemsCount: lowStockItems.length
        },
        items: inventory.map(item => ({
          code: item.inventoryCode || '',
          name: item.itemName || item.cropName || '',
          category: item.category || '',
          quantity: parseFloat(item.currentQuantity || 0),
          unit: item.unit || 'KG',
          value: parseFloat(item.totalMarketValue || 0),
          status: item.status || ''
        })),
        statusDistribution,
        qualityDistribution,
        cropDistribution,
        alerts: {
          expiring: expiringItems.map(item => ({
            code: item.inventoryCode,
            crop: item.cropName,
            quantity: `${item.currentQuantity} ${item.unit}`,
            expiryDate: formatDate(item.expiryDate),
            daysUntilExpiry: Math.ceil((new Date(item.expiryDate) - today) / (1000 * 60 * 60 * 24))
          })),
          expired: expiredItems.map(item => ({
            code: item.inventoryCode,
            crop: item.cropName,
            quantity: `${item.currentQuantity} ${item.unit}`,
            expiryDate: formatDate(item.expiryDate)
          })),
          lowStock: lowStockItems.map(item => ({
            code: item.inventoryCode,
            crop: item.cropName,
            available: `${item.availableQuantity} ${item.unit}`,
            total: `${item.currentQuantity} ${item.unit}`
          }))
        }
      };
    }

    /**
     * Generate report HTML
     */
    /**
     * ✅ IMPROVED: Generate professional report HTML with logo
     */
    function generateReportHTML(reportType, reportData) {
      const reportTitles = {
        'farm-overview': 'Farm Overview Report',
        'production-summary': 'Production Summary Report',
        'financial-report': 'Financial Report',
        'resource-usage': 'Resource Usage Report',
        'inventory-report': 'Inventory Report'
      };

      const reportIcons = {
        'farm-overview': '🏡',
        'production-summary': '🌾',
        'financial-report': '💰',
        'resource-usage': '💧',
        'inventory-report': '📦'
      };

      let html = `
        <style>
          .report-document {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 210mm;
            margin: 0 auto;
            padding: 20mm;
            background: #ffffff;
            color: #333333;
            line-height: 1.6;
          }
          .report-header {
            border-bottom: 4px solid #22c55e;
            padding-bottom: 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
          }
          .report-logo {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            border: 3px solid #22c55e;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
          }
          .report-header-content {
            flex: 1;
          }
          .report-title {
            font-size: 32px;
            font-weight: 700;
            color: #22c55e;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
          }
          .report-subtitle {
            font-size: 14px;
            color: #666666;
            margin: 0;
            font-weight: 500;
          }
          .report-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #22c55e;
          }
          .report-meta-item {
            display: flex;
            flex-direction: column;
          }
          .report-meta-label {
            font-size: 11px;
            color: #666666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 4px;
          }
          .report-meta-value {
            font-size: 14px;
            color: #333333;
            font-weight: 600;
          }
          .report-section {
            margin-bottom: 40px;
            page-break-inside: avoid;
          }
          .report-section h2 {
            font-size: 22px;
            font-weight: 700;
            color: #22c55e;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
          }
          .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
          }
          .summary-item {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 16px;
            border-radius: 10px;
            border-left: 4px solid #22c55e;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          }
          .summary-item label {
            font-size: 12px;
            color: #666666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            display: block;
            margin-bottom: 6px;
          }
          .summary-item value {
            font-size: 20px;
            font-weight: 700;
            color: #22c55e;
            display: block;
          }
          .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            overflow: hidden;
          }
          .report-table thead {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
          }
          .report-table th {
            padding: 14px 12px;
            text-align: left;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }
          .report-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #333333;
          }
          .report-table tbody tr:hover {
            background: #f8f9fa;
          }
          .report-table tbody tr:last-child td {
            border-bottom: none;
          }
          .distribution-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
          }
          .distribution-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #22c55e;
          }
          .distribution-label {
            font-weight: 600;
            color: #333333;
          }
          .distribution-value {
            font-weight: 700;
            color: #22c55e;
          }
          .text-success {
            color: #22c55e;
          }
          .text-error {
            color: #ef4444;
          }
          .text-warning {
            color: #f59e0b;
          }
          .alert-row {
            background: #fef3c7;
          }
          .alert-row.expired {
            background: #fee2e2;
          }
          @media print {
            .report-document {
              padding: 15mm;
            }
            .report-section {
              page-break-inside: avoid;
            }
          }
        </style>
        <div class="report-document">
          <div class="report-header">
            <img src="images/logo.jpeg" alt="AgriGuard AI Logo" class="report-logo" onerror="this.style.display='none'">
            <div class="report-header-content">
              <h1 class="report-title">
                ${reportIcons[reportType] || '📊'} ${reportTitles[reportType]}
              </h1>
              <p class="report-subtitle">AgriGuard AI - Smart Agriculture Management System</p>
              <div class="report-meta">
                <div class="report-meta-item">
                  <span class="report-meta-label">Generated</span>
                  <span class="report-meta-value">${formatDateTime(reportData.generatedAt)}</span>
                </div>
                <div class="report-meta-item">
                  <span class="report-meta-label">Farmer</span>
                  <span class="report-meta-value">${reportData.farmerName}</span>
                </div>
                <div class="report-meta-item">
                  <span class="report-meta-label">Email</span>
                  <span class="report-meta-value">${reportData.farmerEmail}</span>
                </div>
                ${reportData.dateFrom && reportData.dateTo ? `
                  <div class="report-meta-item">
                    <span class="report-meta-label">Period</span>
                    <span class="report-meta-value">${formatDate(reportData.dateFrom)} to ${formatDate(reportData.dateTo)}</span>
                  </div>
                ` : ''}
              </div>
            </div>
          </div>
      `;

      switch (reportType) {
        case 'farm-overview':
          html += generateFarmOverviewHTML(reportData.content);
          break;
        case 'production-summary':
          html += generateProductionSummaryHTML(reportData.content);
          break;
        case 'financial-report':
          html += generateFinancialReportHTML(reportData.content);
          break;
        case 'resource-usage':
          html += generateResourceUsageHTML(reportData.content);
          break;
        case 'inventory-report':
          html += generateInventoryReportHTML(reportData.content);
          break;
      }

      html += `</div>`;
      return html;
    }

    /**
     * ✅ IMPROVED: Generate farm overview HTML with professional design
     */
    function generateFarmOverviewHTML(content) {
      return `
        <div class="report-section">
          <h2>📊 Summary Statistics</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Total Farms</label>
              <value>${content.summary.totalFarms}</value>
            </div>
            <div class="summary-item">
              <label>Total Area</label>
              <value>${content.summary.totalArea} ha</value>
            </div>
            <div class="summary-item">
              <label>Irrigated Farms</label>
              <value>${content.summary.irrigatedFarms}</value>
            </div>
            <div class="summary-item">
              <label>Active Farms</label>
              <value>${content.summary.activeFarms}</value>
            </div>
            <div class="summary-item">
              <label>Inactive Farms</label>
              <value>${content.summary.inactiveFarms || 0}</value>
            </div>
            <div class="summary-item">
              <label>Average Farm Size</label>
              <value>${content.summary.totalFarms > 0 ? (parseFloat(content.summary.totalArea) / content.summary.totalFarms).toFixed(2) : 0} ha</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>🏡 Farm Details</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Farm Name</th>
                <th>Code</th>
                <th>Location</th>
                <th>Size (ha)</th>
                <th>Soil Type</th>
                <th>Irrigation System</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${content.farms.length > 0 ? content.farms.map(farm => `
                <tr>
                  <td><strong>${farm.name || 'N/A'}</strong></td>
                  <td>${farm.code || 'N/A'}</td>
                  <td>${farm.location || 'N/A'}</td>
                  <td>${parseFloat(farm.size || 0).toFixed(2)}</td>
                  <td>${farm.soilType || 'N/A'}</td>
                  <td>${farm.irrigationSystem || 'N/A'}</td>
                  <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; ${farm.status === 'Active' ? 'background: #dcfce7; color: #166534;' : 'background: #fee2e2; color: #991b1b;'}">${farm.status || 'N/A'}</span></td>
                </tr>
              `).join('') : `
                <tr>
                  <td colspan="7" style="text-align: center; padding: 40px; color: #666;">No farm data available</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>🌱 Soil Type Distribution</h2>
          <div class="distribution-list">
            ${Object.keys(content.soilTypeDistribution || {}).length > 0 ? Object.entries(content.soilTypeDistribution).map(([type, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${type || 'Unknown'}:</span>
                <span class="distribution-value">${count} ${count === 1 ? 'farm' : 'farms'}</span>
              </div>
            `).join('') : '<p style="color: #666; padding: 20px; text-align: center;">No soil type data available</p>'}
          </div>
        </div>

        <div class="report-section">
          <h2>💧 Irrigation System Distribution</h2>
          <div class="distribution-list">
            ${Object.keys(content.irrigationDistribution || {}).length > 0 ? Object.entries(content.irrigationDistribution).map(([system, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${system || 'Unknown'}:</span>
                <span class="distribution-value">${count} ${count === 1 ? 'farm' : 'farms'}</span>
              </div>
            `).join('') : '<p style="color: #666; padding: 20px; text-align: center;">No irrigation system data available</p>'}
          </div>
        </div>
      `;
    }






    /**
     * ✅ IMPROVED: Generate production summary HTML with professional design
     */
    function generateProductionSummaryHTML(content) {
      return `
        <div class="report-section">
          <h2>📊 Production Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Total Productions</label>
              <value>${content.summary.totalProductions || 0}</value>
            </div>
            <div class="summary-item">
              <label>Active Productions</label>
              <value>${content.summary.activeProductions || 0}</value>
            </div>
            <div class="summary-item">
              <label>Completed Productions</label>
              <value>${content.summary.completedProductions || 0}</value>
            </div>
            <div class="summary-item">
              <label>Total Area</label>
              <value>${parseFloat(content.summary.totalArea || 0).toFixed(2)} ha</value>
            </div>
            <div class="summary-item">
              <label>Total Yield</label>
              <value>${parseFloat(content.summary.totalYield || 0).toFixed(2)} T</value>
            </div>
            <div class="summary-item">
              <label>Expected Yield</label>
              <value>${parseFloat(content.summary.totalExpectedYield || 0).toFixed(2)} T</value>
            </div>
            <div class="summary-item">
              <label>Average Yield per Hectare</label>
              <value>${parseFloat(content.summary.averageYield || 0).toFixed(2)} T/ha</value>
            </div>
            <div class="summary-item">
              <label>Yield Efficiency</label>
              <value>${content.summary.totalExpectedYield > 0 ? ((parseFloat(content.summary.totalYield || 0) / parseFloat(content.summary.totalExpectedYield)) * 100).toFixed(1) : 0}%</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>🌾 Production Details</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Crop</th>
                <th>Season</th>
                <th>Area (ha)</th>
                <th>Expected Yield (T)</th>
                <th>Actual Yield (T)</th>
                <th>Planting Date</th>
                <th>Harvest Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${content.productions && content.productions.length > 0 ? content.productions.map(prod => `
                <tr>
                  <td><strong>${prod.code || 'N/A'}</strong></td>
                  <td>${prod.crop || 'N/A'}</td>
                  <td>${prod.season || 'N/A'}</td>
                  <td>${parseFloat(prod.area || 0).toFixed(2)}</td>
                  <td>${prod.expectedYield ? parseFloat(prod.expectedYield).toFixed(2) : 'N/A'}</td>
                  <td>${prod.actualYield ? parseFloat(prod.actualYield).toFixed(2) : 'N/A'}</td>
                  <td>${prod.plantingDate || 'N/A'}</td>
                  <td>${prod.actualHarvestDate || 'N/A'}</td>
                  <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; ${prod.status === 'HARVESTED' ? 'background: #dcfce7; color: #166534;' : prod.status === 'GROWING' || prod.status === 'PLANTED' ? 'background: #dbeafe; color: #1e40af;' : 'background: #f3f4f6; color: #374151;'}">${prod.status || 'N/A'}</span></td>
                </tr>
              `).join('') : `
                <tr>
                  <td colspan="9" style="text-align: center; padding: 40px; color: #666;">No production data available</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>📊 Crop Distribution</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Crop</th>
                <th>Count</th>
                <th>Total Area (ha)</th>
                <th>Total Yield (T)</th>
                <th>Average Yield (T/ha)</th>
              </tr>
            </thead>
            <tbody>
              ${Object.keys(content.cropDistribution || {}).length > 0 ? Object.entries(content.cropDistribution).map(([crop, data]) => `
                <tr>
                  <td><strong>${crop || 'Unknown'}</strong></td>
                  <td>${data.count || 0}</td>
                  <td>${parseFloat(data.area || 0).toFixed(2)}</td>
                  <td>${parseFloat(data.yield || 0).toFixed(2)}</td>
                  <td>${data.area > 0 ? (parseFloat(data.yield || 0) / parseFloat(data.area)).toFixed(2) : '0.00'}</td>
                </tr>
              `).join('') : `
                <tr>
                  <td colspan="5" style="text-align: center; padding: 40px; color: #666;">No crop distribution data available</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>📅 Season Distribution</h2>
          <div class="distribution-list">
            ${Object.keys(content.seasonDistribution || {}).length > 0 ? Object.entries(content.seasonDistribution).map(([season, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${season || 'Unknown'}:</span>
                <span class="distribution-value">${count} ${count === 1 ? 'production' : 'productions'}</span>
              </div>
            `).join('') : '<p style="color: #666; padding: 20px; text-align: center;">No season distribution data available</p>'}
          </div>
        </div>

        <div class="report-section">
          <h2>📈 Status Distribution</h2>
          <div class="distribution-list">
            ${Object.keys(content.statusDistribution || {}).length > 0 ? Object.entries(content.statusDistribution).map(([status, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${status || 'Unknown'}:</span>
                <span class="distribution-value">${count} ${count === 1 ? 'production' : 'productions'}</span>
              </div>
            `).join('') : '<p style="color: #666; padding: 20px; text-align: center;">No status distribution data available</p>'}
          </div>
        </div>
      `;
    }

    /**
     * ✅ IMPROVED: Generate financial report HTML with professional design
     */
    function generateFinancialReportHTML(content) {
      const profitLossValue = parseFloat((content.summary.profitLoss || '0').toString().replace(/[^\d.-]/g, ''));
      const isProfit = profitLossValue >= 0;
      
      return `
        <div class="report-section">
          <h2>💰 Financial Summary</h2>
          <div class="summary-grid">
            <div class="summary-item" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
              <label>Total Revenue</label>
              <value style="color: #1e40af;">${content.summary.totalRevenue || 'RWF 0'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);">
              <label>Net Revenue</label>
              <value style="color: #166534;">${content.summary.netRevenue || 'RWF 0'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
              <label>Transaction Fees</label>
              <value style="color: #92400e;">${content.summary.transactionFees || 'RWF 0'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
              <label>Total Costs</label>
              <value style="color: #991b1b;">${content.summary.totalCosts || 'RWF 0'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, ${isProfit ? '#dcfce7 0%, #bbf7d0 100%' : '#fee2e2 0%, #fecaca 100%'});">
              <label>Profit/Loss</label>
              <value style="color: ${isProfit ? '#166534' : '#991b1b'}; font-size: 24px;">
                <strong>${content.summary.profitLoss || 'RWF 0'}</strong>
              </value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);">
              <label>Profit Margin</label>
              <value style="color: #3730a3;">${content.summary.profitMargin || '0%'}</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>💸 Cost Breakdown</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Fertilizer Costs</label>
              <value>${content.summary.fertilizerCost || 'RWF 0'}</value>
            </div>
            <div class="summary-item">
              <label>Irrigation Costs</label>
              <value>${content.summary.irrigationCost || 'RWF 0'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);">
              <label>Inventory Value</label>
              <value style="color: #3730a3;">${content.summary.inventoryValue || 'RWF 0'}</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>📅 Monthly Financial Performance</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Month</th>
                <th>Revenue</th>
                <th>Costs</th>
                <th>Profit/Loss</th>
                <th>Margin</th>
              </tr>
            </thead>
            <tbody>
              ${Object.keys(content.monthlyData || {}).length > 0 ? Object.entries(content.monthlyData).sort().map(([month, data]) => {
                const monthDate = new Date(month + '-01');
                const monthLabel = monthDate.toLocaleString('default', { month: 'short', year: 'numeric' });
                const profit = parseFloat(data.profit || 0);
                const revenue = parseFloat(data.revenue || 0);
                const margin = revenue > 0 ? ((profit / revenue) * 100).toFixed(1) : '0.0';
                return `
                  <tr>
                    <td><strong>${monthLabel}</strong></td>
                    <td>${formatCurrency(data.revenue || 0)}</td>
                    <td>${formatCurrency(data.costs || 0)}</td>
                    <td class="${profit >= 0 ? 'text-success' : 'text-error'}">
                      <strong>${formatCurrency(profit)}</strong>
                    </td>
                    <td class="${profit >= 0 ? 'text-success' : 'text-error'}">
                      <strong>${margin}%</strong>
                    </td>
                  </tr>
                `;
              }).join('') : `
                <tr>
                  <td colspan="5" style="text-align: center; padding: 40px; color: #666;">No monthly financial data available</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>💳 Transaction History</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Date</th>
                <th>Buyer</th>
                <th>Crop</th>
                <th>Quantity</th>
                <th>Total Amount</th>
                <th>Net Amount</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${content.transactions && content.transactions.length > 0 ? content.transactions.map(tx => `
                <tr>
                  <td><strong>${tx.code || 'N/A'}</strong></td>
                  <td>${tx.date || 'N/A'}</td>
                  <td>${tx.buyer || 'N/A'}</td>
                  <td>${tx.crop || 'N/A'}</td>
                  <td>${tx.quantity || '0'}</td>
                  <td><strong>${tx.totalAmount || 'RWF 0'}</strong></td>
                  <td><strong>${tx.netAmount || 'RWF 0'}</strong></td>
                  <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; ${tx.status === 'PAID' || tx.status === 'COMPLETED' ? 'background: #dcfce7; color: #166534;' : tx.status === 'PENDING' ? 'background: #fef3c7; color: #92400e;' : 'background: #fee2e2; color: #991b1b;'}">${tx.status || 'N/A'}</span></td>
                </tr>
              `).join('') : `
                <tr>
                  <td colspan="8" style="text-align: center; padding: 40px; color: #666;">No transaction data available</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>
      `;
    }

    /**
     * ✅ IMPROVED: Generate resource usage HTML with professional design
     */
    function generateResourceUsageHTML(content) {
      return `
        <div class="report-section">
          <h2>💧 Resource Usage Summary</h2>
          <div class="summary-grid">
            <div class="summary-item" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
              <label>Fertilizer Applications</label>
              <value style="color: #92400e;">${content.summary.fertilizerApplications || 0}</value>
            </div>
            <div class="summary-item">
              <label>Total Fertilizer Quantity</label>
              <value>${content.summary.totalFertilizerQuantity || '0 KG'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
              <label>Fertilizer Cost</label>
              <value style="color: #991b1b;">${content.summary.totalFertilizerCost || 'RWF 0'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
              <label>Irrigation Sessions</label>
              <value style="color: #1e40af;">${content.summary.irrigationSessions || 0}</value>
            </div>
            <div class="summary-item">
              <label>Total Water Used</label>
              <value>${content.summary.totalWaterUsed || '0 L'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
              <label>Irrigation Cost</label>
              <value style="color: #991b1b;">${content.summary.totalIrrigationCost || 'RWF 0'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);">
              <label>Water Efficiency</label>
              <value style="color: #166534;">${content.summary.avgWaterEfficiency || '0%'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-left: 4px solid #ef4444;">
              <label>Total Resource Cost</label>
              <value style="color: #991b1b; font-size: 24px;"><strong>${content.summary.totalResourceCost || 'RWF 0'}</strong></value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>🧪 Fertilizer Usage Details</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Name</th>
                <th>Quantity (KG)</th>
                <th>Method</th>
                <th>Cost</th>
                <th>Effectiveness</th>
              </tr>
            </thead>
            <tbody>
              ${content.fertilizer && content.fertilizer.applications && content.fertilizer.applications.length > 0 ? content.fertilizer.applications.map(f => `
                <tr>
                  <td>${f.date || 'N/A'}</td>
                  <td><strong>${f.type || 'N/A'}</strong></td>
                  <td>${f.name || 'N/A'}</td>
                  <td>${parseFloat(f.quantity || 0).toFixed(2)}</td>
                  <td>${f.method || 'N/A'}</td>
                  <td><strong>${f.cost || 'RWF 0'}</strong></td>
                  <td>${f.effectiveness || 'N/A'}</td>
                </tr>
              `).join('') : `
                <tr>
                  <td colspan="7" style="text-align: center; padding: 40px; color: #666;">No fertilizer usage data available</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>📊 Fertilizer Type Distribution</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Applications</th>
                <th>Total Quantity (KG)</th>
                <th>Total Cost</th>
                <th>Average Cost per Application</th>
              </tr>
            </thead>
            <tbody>
              ${content.fertilizer && content.fertilizer.typeDistribution && Object.keys(content.fertilizer.typeDistribution).length > 0 ? Object.entries(content.fertilizer.typeDistribution).map(([type, data]) => `
                <tr>
                  <td><strong>${type || 'Unknown'}</strong></td>
                  <td>${data.applications || 0}</td>
                  <td>${parseFloat(data.quantity || 0).toFixed(2)}</td>
                  <td><strong>${formatCurrency(data.cost || 0)}</strong></td>
                  <td>${data.applications > 0 ? formatCurrency((data.cost || 0) / data.applications) : 'RWF 0'}</td>
                </tr>
              `).join('') : `
                <tr>
                  <td colspan="5" style="text-align: center; padding: 40px; color: #666;">No fertilizer type distribution data available</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>💧 Irrigation Details</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Water Amount (L)</th>
                <th>Duration (min)</th>
                <th>Method</th>
                <th>Source</th>
                <th>Efficiency (%)</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody>
              ${content.irrigation && content.irrigation.sessions && content.irrigation.sessions.length > 0 ? content.irrigation.sessions.map(i => `
                <tr>
                  <td>${i.date || 'N/A'}</td>
                  <td><strong>${parseFloat(i.waterAmount || 0).toLocaleString()}</strong></td>
                  <td>${i.duration || 'N/A'}</td>
                  <td>${i.method || 'N/A'}</td>
                  <td>${i.source || 'N/A'}</td>
                  <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; ${parseFloat(i.efficiency || 0) >= 70 ? 'background: #dcfce7; color: #166534;' : parseFloat(i.efficiency || 0) >= 50 ? 'background: #fef3c7; color: #92400e;' : 'background: #fee2e2; color: #991b1b;'}">${i.efficiency || '0'}%</span></td>
                  <td><strong>${i.cost || 'RWF 0'}</strong></td>
                </tr>
              `).join('') : `
                <tr>
                  <td colspan="7" style="text-align: center; padding: 40px; color: #666;">No irrigation data available</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>📊 Irrigation Method Distribution</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Method</th>
                <th>Sessions</th>
                <th>Water Used (L)</th>
                <th>Total Cost</th>
                <th>Average per Session</th>
              </tr>
            </thead>
            <tbody>
              ${content.irrigation && content.irrigation.methodDistribution && Object.keys(content.irrigation.methodDistribution).length > 0 ? Object.entries(content.irrigation.methodDistribution).map(([method, data]) => `
                <tr>
                  <td><strong>${method || 'Unknown'}</strong></td>
                  <td>${data.sessions || 0}</td>
                  <td>${parseFloat(data.waterUsed || 0).toLocaleString()}</td>
                  <td><strong>${formatCurrency(data.cost || 0)}</strong></td>
                  <td>${data.sessions > 0 ? formatCurrency((data.cost || 0) / data.sessions) : 'RWF 0'}</td>
                </tr>
              `).join('') : `
                <tr>
                  <td colspan="5" style="text-align: center; padding: 40px; color: #666;">No irrigation method distribution data available</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>🌊 Water Source Distribution</h2>
          <div class="distribution-list">
            ${content.irrigation && content.irrigation.sourceDistribution && Object.keys(content.irrigation.sourceDistribution).length > 0 ? Object.entries(content.irrigation.sourceDistribution).map(([source, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${source || 'Unknown'}:</span>
                <span class="distribution-value">${count} ${count === 1 ? 'session' : 'sessions'}</span>
              </div>
            `).join('') : '<p style="color: #666; padding: 20px; text-align: center;">No water source distribution data available</p>'}
          </div>
        </div>
      `;
    }

    /**
     * ✅ IMPROVED: Generate inventory report HTML with professional design
     */
    function generateInventoryReportHTML(content) {
      return `
        <div class="report-section">
          <h2>📦 Inventory Summary</h2>
          <div class="summary-grid">
            <div class="summary-item" style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);">
              <label>Total Items</label>
              <value style="color: #3730a3;">${content.summary.totalItems || 0}</value>
            </div>
            <div class="summary-item">
              <label>Total Quantity</label>
              <value>${content.summary.totalQuantity || '0 KG'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);">
              <label>Available Quantity</label>
              <value style="color: #166534;">${content.summary.availableQuantity || '0 KG'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #1e40af;">
              <label>Total Value</label>
              <value style="color: #1e40af; font-size: 22px;"><strong>${content.summary.totalValue || 'RWF 0'}</strong></value>
            </div>
            <div class="summary-item">
              <label>Average Value per Item</label>
              <value>${content.summary.averageValuePerItem || 'RWF 0'}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
              <label>Expiring Items</label>
              <value style="color: #92400e; font-weight: 700;">${content.summary.expiringItemsCount || 0}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
              <label>Expired Items</label>
              <value style="color: #991b1b; font-weight: 700;">${content.summary.expiredItemsCount || 0}</value>
            </div>
            <div class="summary-item" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
              <label>Low Stock Items</label>
              <value style="color: #92400e; font-weight: 700;">${content.summary.lowStockItemsCount || 0}</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>📋 Inventory Items</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Crop</th>
                <th>Quantity (KG)</th>
                <th>Available (KG)</th>
                <th>Quality</th>
                <th>Status</th>
                <th>Value</th>
                <th>Storage Date</th>
                <th>Expiry Date</th>
              </tr>
            </thead>
            <tbody>
              ${content.items && content.items.length > 0 ? content.items.map(item => {
                const isExpired = item.status === 'EXPIRED';
                const isExpiring = item.status === 'EXPIRING';
                const isLowStock = item.status === 'LOW_STOCK';
                return `
                <tr class="${isExpired ? 'alert-row expired' : isExpiring || isLowStock ? 'alert-row' : ''}">
                  <td><strong>${item.code || 'N/A'}</strong></td>
                  <td>${item.crop || 'N/A'}</td>
                  <td><strong>${parseFloat(item.quantity || 0).toLocaleString()}</strong></td>
                  <td>${parseFloat(item.available || 0).toLocaleString()}</td>
                  <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; ${item.quality === 'PREMIUM' || item.quality === 'HIGH' ? 'background: #dcfce7; color: #166534;' : item.quality === 'MEDIUM' ? 'background: #fef3c7; color: #92400e;' : 'background: #fee2e2; color: #991b1b;'}">${item.quality || 'N/A'}</span></td>
                  <td><span style="padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; ${item.status === 'AVAILABLE' ? 'background: #dcfce7; color: #166534;' : item.status === 'LOW_STOCK' || item.status === 'EXPIRING' ? 'background: #fef3c7; color: #92400e;' : 'background: #fee2e2; color: #991b1b;'}">${item.status || 'N/A'}</span></td>
                  <td><strong>${item.value || 'RWF 0'}</strong></td>
                  <td>${item.storageDate || 'N/A'}</td>
                  <td>${item.expiryDate || 'N/A'}</td>
                </tr>
              `;
              }).join('') : `
                <tr>
                  <td colspan="9" style="text-align: center; padding: 40px; color: #666;">No inventory items available</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>📊 Status Distribution</h2>
          <div class="distribution-list">
            ${content.statusDistribution && Object.keys(content.statusDistribution).length > 0 ? Object.entries(content.statusDistribution).map(([status, count]) => `
              <div class="distribution-item" style="${status === 'AVAILABLE' ? 'background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);' : status === 'LOW_STOCK' || status === 'EXPIRING' ? 'background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);' : 'background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);'}">
                <span class="distribution-label"><strong>${status || 'Unknown'}:</strong></span>
                <span class="distribution-value">${count} ${count === 1 ? 'item' : 'items'}</span>
              </div>
            `).join('') : '<p style="color: #666; padding: 20px; text-align: center;">No status distribution data available</p>'}
          </div>
        </div>

        <div class="report-section">
          <h2>⭐ Quality Distribution</h2>
          <div class="distribution-list">
            ${content.qualityDistribution && Object.keys(content.qualityDistribution).length > 0 ? Object.entries(content.qualityDistribution).map(([quality, count]) => `
              <div class="distribution-item" style="${quality === 'PREMIUM' || quality === 'HIGH' ? 'background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);' : quality === 'MEDIUM' ? 'background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);' : 'background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);'}">
                <span class="distribution-label"><strong>${quality || 'Unknown'}:</strong></span>
                <span class="distribution-value">${count} ${count === 1 ? 'item' : 'items'}</span>
              </div>
            `).join('') : '<p style="color: #666; padding: 20px; text-align: center;">No quality distribution data available</p>'}
          </div>
        </div>

        <div class="report-section">
          <h2>🌾 Crop Distribution</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Crop</th>
                <th>Quantity (KG)</th>
                <th>Value</th>
                <th>Average Value per KG</th>
              </tr>
            </thead>
            <tbody>
              ${content.cropDistribution && Object.keys(content.cropDistribution).length > 0 ? Object.entries(content.cropDistribution).map(([crop, data]) => `
                <tr>
                  <td><strong>${crop || 'Unknown'}</strong></td>
                  <td>${parseFloat(data.quantity || 0).toLocaleString()}</td>
                  <td><strong>${formatCurrency(data.value || 0)}</strong></td>
                  <td>${data.quantity > 0 ? formatCurrency((data.value || 0) / parseFloat(data.quantity)) : 'RWF 0'}</td>
                </tr>
              `).join('') : `
                <tr>
                  <td colspan="4" style="text-align: center; padding: 40px; color: #666;">No crop distribution data available</td>
                </tr>
              `}
            </tbody>
          </table>
        </div>

        ${content.alerts.expiring.length > 0 ? `
          <div class="report-section">
            <h2 class="text-warning">⚠️ Expiring Items Alert</h2>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Crop</th>
                  <th>Quantity</th>
                  <th>Expiry Date</th>
                  <th>Days Until Expiry</th>
                </tr>
              </thead>
              <tbody>
                ${content.alerts.expiring.map(item => `
                  <tr class="alert-row">
                    <td>${item.code}</td>
                    <td>${item.crop}</td>
                    <td>${item.quantity}</td>
                    <td>${item.expiryDate}</td>
                    <td class="text-warning"><strong>${item.daysUntilExpiry} days</strong></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}

        ${content.alerts.expired.length > 0 ? `
          <div class="report-section">
            <h2 class="text-error">🚫 Expired Items Alert</h2>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Crop</th>
                  <th>Quantity</th>
                  <th>Expiry Date</th>
                </tr>
              </thead>
              <tbody>
                ${content.alerts.expired.map(item => `
                  <tr class="alert-row expired">
                    <td>${item.code}</td>
                    <td>${item.crop}</td>
                    <td>${item.quantity}</td>
                    <td>${item.expiryDate}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}

        ${content.alerts.lowStock.length > 0 ? `
          <div class="report-section">
            <h2 class="text-warning">📦 Low Stock Alert</h2>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Crop</th>
                  <th>Available</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                ${content.alerts.lowStock.map(item => `
                  <tr class="alert-row">
                    <td>${item.code}</td>
                    <td>${item.crop}</td>
                    <td class="text-warning"><strong>${item.available}</strong></td>
                    <td>${item.total}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}
      `;
    }













    /**
     * ✅ IMPROVED: Generate professional PDF report with logo - Each section on its own page
     */
    async function generatePDFReport() {
      try {
        showLoading();
        showToast('Generating professional PDF report...', 'info');

        const reportType = document.getElementById('reportType').value;
        const reportPeriod = document.getElementById('reportPeriod').value;
        const dateFrom = document.getElementById('reportDateFrom').value;
        const dateTo = document.getElementById('reportDateTo').value;

        // Generate report data
        const reportData = await generateReportData(reportType, reportPeriod, dateFrom, dateTo);

        // Create PDF with professional settings
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const margin = 15;
        const contentWidth = pageWidth - (margin * 2);
        let currentY = margin + 30; // Start after header

        // Load logo once
        let logoData = null;
        try {
          const logoImg = new Image();
          logoImg.crossOrigin = 'anonymous';
          logoImg.src = 'images/logo.jpeg';
          logoData = await new Promise((resolve) => {
            logoImg.onload = () => {
              try {
                const canvas = document.createElement('canvas');
                canvas.width = logoImg.width;
                canvas.height = logoImg.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(logoImg, 0, 0);
                resolve(canvas.toDataURL('image/jpeg', 0.9));
              } catch (e) {
                resolve(null);
              }
            };
            logoImg.onerror = () => resolve(null);
            setTimeout(() => resolve(null), 2000);
          });
        } catch (error) {
          console.warn('Logo loading error:', error);
        }

        /**
         * Add header with logo to current page - Professional design like the example
         */
        function addPageHeader(pageNum, totalPages) {
          // Logo in top-left corner (circular green background)
          if (logoData) {
            try {
              const logoSize = 25;
              const logoX = margin;
              const logoY = 5;
              
              // Draw circular background for logo
              pdf.setFillColor(34, 197, 94);
              pdf.circle(logoX + logoSize/2, logoY + logoSize/2, logoSize/2, 'F');
              
              // Add logo image
              pdf.addImage(logoData, 'JPEG', logoX + 2, logoY + 2, logoSize - 4, logoSize - 4);
            } catch (e) {
              // If logo fails, draw a simple green circle
              pdf.setFillColor(34, 197, 94);
              pdf.circle(margin + 12.5, 17.5, 12.5, 'F');
            }
          } else {
            // Draw a simple green circle if no logo
            pdf.setFillColor(34, 197, 94);
            pdf.circle(margin + 12.5, 17.5, 12.5, 'F');
          }

          // Title centered (like "Crops Management Report")
          const reportTitles = {
            'farm-overview': 'Farm Overview Report',
            'production-summary': 'Production Summary Report',
            'financial-report': 'Financial Report',
            'resource-usage': 'Resource Usage Report',
            'inventory-report': 'Inventory Report'
          };
          const title = reportTitles[reportType] || 'Report';
          
          pdf.setFontSize(18);
          pdf.setTextColor(0, 0, 0);
          pdf.setFont(undefined, 'bold');
          pdf.text(title, pageWidth / 2, 20, { align: 'center' });

          // Metadata below title
          currentY = 30;
          pdf.setFontSize(9);
          pdf.setTextColor(100, 100, 100);
          pdf.setFont(undefined, 'normal');
          
          const reportTypeLabels = {
            'farm-overview': 'Farm Overview',
            'production-summary': 'Production Summary',
            'financial-report': 'Financial',
            'resource-usage': 'Resource Usage',
            'inventory-report': 'Inventory'
          };
          
          const periodLabels = {
            'this-month': 'This Month',
            'last-month': 'Last Month',
            'this-year': 'This Year',
            'last-year': 'Last Year',
            'all': 'ALL'
          };
          
          pdf.text(`Report Type: ${reportTypeLabels[reportType] || 'ALL'}`, margin + 30, currentY);
          pdf.text(`Date Range: ${dateFrom && dateTo ? `${dateFrom} to ${dateTo}` : periodLabels[reportPeriod] || 'ALL'}`, margin + 30, currentY + 5);
          pdf.text(`Generated: ${new Date().toLocaleString()}`, margin + 30, currentY + 10);
          
          // Get total records count
          let totalRecords = 0;
          if (reportData && reportData.content) {
            if (reportData.content.farms) totalRecords = reportData.content.farms.length;
            else if (reportData.content.productions) totalRecords = reportData.content.productions.length;
            else if (reportData.content.transactions) totalRecords = reportData.content.transactions.length;
            else if (reportData.content.items) totalRecords = reportData.content.items.length;
            else if (reportData.content.fertilizerUsage) totalRecords = reportData.content.fertilizerUsage.length;
          }
          
          pdf.text(`Total Records: ${totalRecords}`, margin + 30, currentY + 15);
          pdf.text(`Downloaded by: ${currentUser.fullName || 'User'}`, margin + 30, currentY + 20);

          // Reset Y position after header
          currentY = margin + 60;
        }

        /**
         * Add footer to current page
         */
        function addPageFooter() {
          const footerY = pageHeight - 15;
          
          // Footer line
          pdf.setDrawColor(34, 197, 94);
          pdf.setLineWidth(0.5);
          pdf.line(margin, footerY - 5, pageWidth - margin, footerY - 5);
          
          // Footer text
          pdf.setFontSize(8);
          pdf.setTextColor(100, 100, 100);
          pdf.text(
            'AgriGuard AI - Smart Agriculture Management System',
            pageWidth / 2,
            footerY,
            { align: 'center' }
          );
        }

        /**
         * Check if new page is needed and add it
         */
        function checkNewPage(requiredHeight) {
          if (currentY + requiredHeight > pageHeight - 30) {
            addPageFooter();
            pdf.addPage();
            addPageHeader(pdf.internal.getNumberOfPages(), 0); // Will update total later
            return true;
          }
          return false;
        }

        /**
         * Add a section with title (NO EMOJI - clean text only)
         */
        function addSection(title) {
          checkNewPage(20);
          
          pdf.setFontSize(14);
          pdf.setTextColor(34, 197, 94);
          pdf.setFont(undefined, 'bold');
          pdf.text(title, margin, currentY);
          currentY += 8;
          
          // Section underline
          pdf.setDrawColor(34, 197, 94);
          pdf.setLineWidth(0.3);
          pdf.line(margin, currentY, pageWidth - margin, currentY);
          currentY += 10;
        }

        /**
         * Add summary grid
         */
        function addSummaryGrid(items) {
          const itemsPerRow = 3;
          const itemWidth = (contentWidth - 10) / itemsPerRow;
          const itemHeight = 15;
          let row = 0;
          let col = 0;

          items.forEach((item, index) => {
            if (index > 0 && index % itemsPerRow === 0) {
              row++;
              col = 0;
              currentY += itemHeight + 5;
            }

            checkNewPage(itemHeight + 5);

            const x = margin + (col * itemWidth);
            const y = currentY;

            // Background box
            pdf.setFillColor(245, 247, 250);
            pdf.rect(x, y, itemWidth - 5, itemHeight, 'F');

            // Label
            pdf.setFontSize(8);
            pdf.setTextColor(100, 100, 100);
            pdf.setFont(undefined, 'normal');
            pdf.text(item.label, x + 3, y + 5);

            // Value
            pdf.setFontSize(10);
            pdf.setTextColor(34, 197, 94);
            pdf.setFont(undefined, 'bold');
            pdf.text(item.value, x + 3, y + 12);

            col++;
          });

          currentY += itemHeight + 15;
        }

        /**
         * Add table with professional green header using autoTable (handles text wrapping)
         */
        function addTable(headers, rows) {
          if (!rows || rows.length === 0) {
            pdf.setFontSize(10);
            pdf.setTextColor(150, 150, 150);
            pdf.text('No data available', margin, currentY);
            currentY += 10;
            return;
          }

          // Use autoTable for proper text wrapping and professional layout
          const tableData = rows.map(row => 
            row.map(cell => {
              // Clean text from HTML tags, emojis, and special characters
              let cellText = String(cell || '')
                .replace(/<[^>]*>/g, '') // Remove HTML tags
                .replace(/[🌧️💦💧🌊✋🏡🌱📊💰📦🌾🌿💳📋]/g, '') // Remove emojis
                .replace(/[Ø=ÜÊØ<BáØ<B1]/g, '') // Remove corrupted characters
                .trim();
              return cellText || '';
            })
          );

          // Calculate optimal column widths (autoTable will handle wrapping)
          const colWidths = headers.map((header, i) => {
            // Use proportional widths, but ensure minimum width
            const baseWidth = contentWidth / headers.length;
            const maxContentWidth = Math.max(
              pdf.getTextWidth(header),
              ...tableData.map(row => {
                const cellText = String(row[i] || '');
                return pdf.getTextWidth(cellText);
              })
            );
            // Use the larger of base width or content width (with padding)
            return Math.max(baseWidth, Math.min(maxContentWidth + 5, baseWidth * 1.5));
          });

          // Normalize widths to fit content width
          const totalWidth = colWidths.reduce((sum, w) => sum + w, 0);
          if (totalWidth > contentWidth) {
            const scale = contentWidth / totalWidth;
            colWidths.forEach((w, i) => colWidths[i] = w * scale);
          }

          // Check if autoTable is available
          if (typeof pdf.autoTable !== 'function') {
            console.error('jsPDF autoTable plugin is not loaded. Please ensure the script is included.');
            showToast('Error: PDF table plugin not loaded. Please refresh the page.', 'error');
            // Fallback: use simple table rendering without autoTable
            addSimpleTableFallback(headers, rows);
            return;
          }

          pdf.autoTable({
            startY: currentY,
            head: [headers],
            body: tableData,
            theme: 'grid',
            headStyles: {
              fillColor: [34, 197, 94],
              textColor: [255, 255, 255],
              fontStyle: 'bold',
              fontSize: 10,
              halign: 'center',
              cellPadding: 4
            },
            bodyStyles: {
              fillColor: [255, 255, 255],
              textColor: [0, 0, 0],
              fontSize: 9,
              halign: 'left',
              cellPadding: 3,
              overflow: 'linebreak',
              cellWidth: 'wrap'
            },
            alternateRowStyles: {
              fillColor: [255, 255, 255]
            },
            columnStyles: headers.reduce((styles, header, i) => {
              styles[i] = {
                cellWidth: colWidths[i],
                halign: 'left',
                valign: 'top',
                overflow: 'linebreak',
                cellPadding: 3
              };
              return styles;
            }, {}),
            styles: {
              cellPadding: 3,
              lineWidth: 0.1,
              lineColor: [220, 220, 220],
              overflow: 'linebreak'
            },
            margin: { left: margin, right: margin },
            didDrawPage: function(data) {
              // Add footer on each page
              addPageFooter();
            }
          });

          // Update currentY after table
          currentY = pdf.lastAutoTable.finalY + 10;
        }

        /**
         * Fallback: Simple table rendering without autoTable
         */
        function addSimpleTableFallback(headers, rows) {
          if (!rows || rows.length === 0) {
            pdf.setFontSize(10);
            pdf.setTextColor(150, 150, 150);
            pdf.text('No data available', margin, currentY);
            currentY += 10;
            return;
          }

          const colWidths = headers.map(() => contentWidth / headers.length);
          const rowHeight = 9;
          const headerHeight = 12;

          // Table header with green background
          checkNewPage(headerHeight + (rows.length * rowHeight) + 5);
          
          let headerX = margin;
          pdf.setFillColor(34, 197, 94);
          pdf.rect(margin, currentY, contentWidth, headerHeight, 'F');
          
          headers.forEach((header, i) => {
            pdf.setFontSize(10);
            pdf.setTextColor(255, 255, 255);
            pdf.setFont(undefined, 'bold');
            const textWidth = pdf.getTextWidth(header);
            pdf.text(header, headerX + (colWidths[i] / 2) - (textWidth / 2), currentY + 8);
            headerX += colWidths[i];
          });
          currentY += headerHeight;

          // Table rows
          rows.forEach((row, rowIndex) => {
            checkNewPage(rowHeight);
            
            pdf.setFillColor(255, 255, 255);
            pdf.rect(margin, currentY, contentWidth, rowHeight, 'F');
            
            pdf.setDrawColor(220, 220, 220);
            pdf.setLineWidth(0.1);
            pdf.line(margin, currentY, pageWidth - margin, currentY);

            let cellX = margin;
            row.forEach((cell, cellIndex) => {
              pdf.setFontSize(9);
              pdf.setTextColor(0, 0, 0);
              pdf.setFont(undefined, 'normal');
              
              let cellText = String(cell || '')
                .replace(/<[^>]*>/g, '')
                .replace(/[🌧️💦💧🌊✋🏡🌱📊💰📦🌾🌿💳📋]/g, '')
                .replace(/[Ø=ÜÊØ<BáØ<B1]/g, '')
                .trim();
              
              // Truncate if too long
              if (cellText.length > 30) {
                cellText = cellText.substring(0, 27) + '...';
              }
              
              const textWidth = pdf.getTextWidth(cellText);
              pdf.text(cellText, cellX + (colWidths[cellIndex] / 2) - (textWidth / 2), currentY + 6.5);
              cellX += colWidths[cellIndex];
            });
            currentY += rowHeight;
          });

          pdf.setDrawColor(220, 220, 220);
          pdf.setLineWidth(0.1);
          pdf.line(margin, currentY, pageWidth - margin, currentY);

          currentY += 10;
        }

        /**
         * Add distribution list
         */
        function addDistributionList(items) {
          items.forEach((item, index) => {
            checkNewPage(8);
            
            pdf.setFontSize(9);
            pdf.setTextColor(50, 50, 50);
            pdf.text(`${item.label}:`, margin, currentY);
            
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(34, 197, 94);
            pdf.text(item.value, margin + 80, currentY);
            
            currentY += 8;
          });
          currentY += 5;
        }

        // Generate report content based on type
        let pageNum = 1;
        addPageHeader(pageNum, 1);

        // Helper function to get real data or empty string
        function getRealValue(value, defaultValue = '') {
          if (value === null || value === undefined || value === '' || value === 'N/A' || value === 'Unknown') {
            return defaultValue;
          }
          return String(value);
        }

        // Generate sections based on report type
        switch (reportType) {
          case 'farm-overview':
            addSection('Summary Statistics');
            addSummaryGrid([
              { label: 'Total Farms', value: String(reportData.content.summary.totalFarms || 0) },
              { label: 'Total Area', value: `${reportData.content.summary.totalArea || '0.00'} ha` },
              { label: 'Irrigated Farms', value: String(reportData.content.summary.irrigatedFarms || 0) },
              { label: 'Active Farms', value: String(reportData.content.summary.activeFarms || 0) },
              { label: 'Inactive Farms', value: String(reportData.content.summary.inactiveFarms || 0) },
              { label: 'Avg Farm Size', value: `${reportData.content.summary.totalFarms > 0 ? (parseFloat(reportData.content.summary.totalArea || 0) / reportData.content.summary.totalFarms).toFixed(2) : '0.00'} ha` }
            ]);

            addSection('Farm Details');
            const farmHeaders = ['Farm Name', 'Code', 'Location', 'Size (ha)', 'Soil Type', 'Irrigation', 'Status'];
            const farmRows = (reportData.content.farms || []).map(farm => [
              getRealValue(farm.name),
              getRealValue(farm.code),
              getRealValue(farm.location),
              parseFloat(farm.size || 0).toFixed(2),
              getRealValue(farm.soilType),
              formatIrrigationForReport(farm.irrigationSystem),
              getRealValue(farm.status)
            ]);
            addTable(farmHeaders, farmRows);

            addSection('Soil Type Distribution');
            const soilItems = Object.entries(reportData.content.soilTypeDistribution || {}).map(([type, count]) => ({
              label: getRealValue(type, 'Not Specified'),
              value: `${count} ${count === 1 ? 'farm' : 'farms'}`
            }));
            if (soilItems.length > 0) {
              addDistributionList(soilItems);
            }

            addSection('Irrigation System Distribution');
            const irrigationItems = Object.entries(reportData.content.irrigationDistribution || {}).map(([system, count]) => ({
              label: formatIrrigationForReport(system),
              value: `${count} ${count === 1 ? 'farm' : 'farms'}`
            }));
            if (irrigationItems.length > 0) {
              addDistributionList(irrigationItems);
            }
            break;

          case 'production-summary':
            addSection('Production Summary');
            addSummaryGrid([
              { label: 'Total Productions', value: String(reportData.content.summary.totalProductions || 0) },
              { label: 'Active Productions', value: String(reportData.content.summary.activeProductions || 0) },
              { label: 'Completed Productions', value: String(reportData.content.summary.completedProductions || 0) },
              { label: 'Total Area', value: `${parseFloat(reportData.content.summary.totalArea || 0).toFixed(2)} ha` },
              { label: 'Total Yield', value: `${parseFloat(reportData.content.summary.totalYield || 0).toFixed(2)} T` },
              { label: 'Expected Yield', value: `${parseFloat(reportData.content.summary.totalExpectedYield || 0).toFixed(2)} T` },
              { label: 'Avg Yield/ha', value: `${parseFloat(reportData.content.summary.averageYield || 0).toFixed(2)} T/ha` },
              { label: 'Yield Efficiency', value: `${reportData.content.summary.totalExpectedYield > 0 ? ((parseFloat(reportData.content.summary.totalYield || 0) / parseFloat(reportData.content.summary.totalExpectedYield)) * 100).toFixed(1) : 0}%` }
            ]);

            addSection('Production Details');
            const prodHeaders = ['Code', 'Crop', 'Season', 'Area (ha)', 'Expected (T)', 'Actual (T)', 'Planting Date', 'Harvest Date', 'Status'];
            const prodRows = (reportData.content.productions || []).map(prod => [
              getRealValue(prod.code),
              getRealValue(prod.crop),
              getRealValue(prod.season),
              parseFloat(prod.area || 0).toFixed(2),
              prod.expectedYield ? parseFloat(prod.expectedYield).toFixed(2) : '0.00',
              prod.actualYield ? parseFloat(prod.actualYield).toFixed(2) : '0.00',
              getRealValue(prod.plantingDate),
              getRealValue(prod.actualHarvestDate),
              getRealValue(prod.status)
            ]);
            addTable(prodHeaders, prodRows);
            break;

          case 'resource-usage':
            addSection('Resource Usage Summary');
            addSummaryGrid([
              { label: 'Total Fertilizer Cost', value: `RF ${parseFloat(reportData.content.summary.totalFertilizerCost || 0).toLocaleString()}` },
              { label: 'Total Irrigation Cost', value: `RF ${parseFloat(reportData.content.summary.totalIrrigationCost || 0).toLocaleString()}` },
              { label: 'Total Water Used', value: `${parseFloat(reportData.content.summary.totalWaterUsed || 0).toFixed(2)} L` },
              { label: 'Water Efficiency', value: `${parseFloat(reportData.content.summary.waterEfficiency || 0).toFixed(1)}%` },
              { label: 'Total Resource Cost', value: `RF ${parseFloat(reportData.content.summary.totalResourceCost || 0).toLocaleString()}` }
            ]);

            addSection('Fertilizer Usage Details');
            const fertHeaders = ['Date', 'Type', 'Name', 'Quantity (kg)', 'Method', 'Cost', 'Effectiveness'];
            const fertRows = (reportData.content.fertilizerUsage || []).map(fert => [
              getRealValue(fert.date),
              getRealValue(fert.type),
              getRealValue(fert.name),
              parseFloat(fert.quantity || 0).toFixed(2),
              getRealValue(fert.method),
              `RF ${parseFloat(fert.cost || 0).toLocaleString()}`,
              getRealValue(fert.effectiveness)
            ]);
            addTable(fertHeaders, fertRows);

            addSection('Irrigation Details');
            const irrHeaders = ['Date', 'Method', 'Water Used (L)', 'Duration (min)', 'Cost', 'Source'];
            const irrRows = (reportData.content.irrigationData || []).map(irr => [
              getRealValue(irr.date),
              formatIrrigationForReport(irr.method),
              parseFloat(irr.waterUsed || 0).toFixed(2),
              getRealValue(irr.duration),
              `RF ${parseFloat(irr.cost || 0).toLocaleString()}`,
              getRealValue(irr.waterSource)
            ]);
            addTable(irrHeaders, irrRows);
            break;

          case 'financial-report':
            addSection('Financial Summary');
            addSummaryGrid([
              { label: 'Total Revenue', value: `RF ${parseFloat(reportData.content.summary.totalRevenue || 0).toLocaleString()}` },
              { label: 'Total Expenses', value: `RF ${parseFloat(reportData.content.summary.totalExpenses || 0).toLocaleString()}` },
              { label: 'Net Profit', value: `RF ${parseFloat(reportData.content.summary.netProfit || 0).toLocaleString()}` },
              { label: 'Profit Margin', value: `${parseFloat(reportData.content.summary.profitMargin || 0).toFixed(1)}%` },
              { label: 'Total Transactions', value: String(reportData.content.summary.totalTransactions || 0) },
              { label: 'Avg Transaction Value', value: `RF ${parseFloat(reportData.content.summary.avgTransactionValue || 0).toLocaleString()}` }
            ]);

            addSection('Transaction History');
            const transHeaders = ['Date', 'Buyer', 'Crop', 'Quantity', 'Amount', 'Status'];
            const transRows = (reportData.content.transactions || []).map(trans => [
              getRealValue(trans.date),
              getRealValue(trans.buyer),
              getRealValue(trans.crop),
              `${trans.quantity || 0} ${trans.unit || 'kg'}`,
              `RF ${parseFloat(trans.amount || 0).toLocaleString()}`,
              getRealValue(trans.status)
            ]);
            addTable(transHeaders, transRows);
            break;

          case 'inventory-report':
            addSection('Inventory Summary');
            addSummaryGrid([
              { label: 'Total Items', value: String(reportData.content.summary.totalItems || 0) },
              { label: 'Total Value', value: `RF ${parseFloat(reportData.content.summary.totalValue || 0).toLocaleString()}` },
              { label: 'Low Stock Items', value: String(reportData.content.summary.lowStockItems || 0) },
              { label: 'Expiring Items', value: String(reportData.content.summary.expiringItems || 0) },
              { label: 'Expired Items', value: String(reportData.content.summary.expiredItems || 0) }
            ]);

            addSection('Inventory Items');
            const invHeaders = ['Code', 'Item Name', 'Category', 'Quantity', 'Unit', 'Value', 'Status'];
            const invRows = (reportData.content.items || []).map(item => [
              getRealValue(item.code),
              getRealValue(item.name),
              getRealValue(item.category),
              parseFloat(item.quantity || 0).toFixed(2),
              getRealValue(item.unit),
              `RF ${parseFloat(item.value || 0).toLocaleString()}`,
              getRealValue(item.status)
            ]);
            addTable(invHeaders, invRows);
            break;
        }

        // Update total pages and add footers
        const totalPages = pdf.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
          pdf.setPage(i);
          addPageHeader(i, totalPages);
          addPageFooter();
        }

        // Save PDF
        const reportTitles = {
          'farm-overview': 'Farm_Overview',
          'production-summary': 'Production_Summary',
          'financial-report': 'Financial_Report',
          'resource-usage': 'Resource_Usage',
          'inventory-report': 'Inventory_Report'
        };
        const fileName = `${reportTitles[reportType] || 'Report'}_${new Date().toISOString().split('T')[0]}_${Date.now()}.pdf`;
        pdf.save(fileName);

        showToast('✅ Professional PDF report generated successfully!', 'success');

      } catch (error) {
        console.error('Error generating PDF report:', error);
        showToast('❌ Error generating PDF report. Please try again.', 'error');
      } finally {
        hideLoading();
      }
    }

    /**
     * ✅ Refresh reports section
     */
    function refreshReportsSection() {
      showToast('Refreshing reports section...', 'info');
      // Reset form values
      document.getElementById('reportType').value = 'farm-overview';
      document.getElementById('reportPeriod').value = 'this-month';
      document.getElementById('reportDateFrom').value = '';
      document.getElementById('reportDateTo').value = '';
      document.getElementById('reportPreview').style.display = 'none';
      showToast('Reports section refreshed', 'success');
    }

    /**
     * Generate Excel report
     */
    async function generateExcelReport() {
      try {
        showLoading();

        const reportType = document.getElementById('reportType').value;
        const reportPeriod = document.getElementById('reportPeriod').value;
        const dateFrom = document.getElementById('reportDateFrom').value;
        const dateTo = document.getElementById('reportDateTo').value;

        // Generate report data
        const reportData = await generateReportData(reportType, reportPeriod, dateFrom, dateTo);

        // Create workbook
        const wb = XLSX.utils.book_new();

        // Add summary sheet
        const summaryData = [];
        summaryData.push(['Smart Agriculture Management System']);
        summaryData.push(['Report Type', reportType.replace('-', ' ').toUpperCase()]);
        summaryData.push(['Generated', formatDateTime(reportData.generatedAt)]);
        summaryData.push(['Farmer', reportData.farmerName]);
        summaryData.push(['Email', reportData.farmerEmail]);
        if (reportData.dateFrom && reportData.dateTo) {
          summaryData.push(['Period', `${formatDate(reportData.dateFrom)} to ${formatDate(reportData.dateTo)}`]);
        }
        summaryData.push([]);

        // Add content based on report type
        switch (reportType) {
          case 'farm-overview':
            addFarmOverviewToExcel(wb, reportData.content, summaryData);
            break;
          case 'production-summary':
            addProductionSummaryToExcel(wb, reportData.content, summaryData);
            break;
          case 'financial-report':
            addFinancialReportToExcel(wb, reportData.content, summaryData);
            break;
          case 'resource-usage':
            addResourceUsageToExcel(wb, reportData.content, summaryData);
            break;
          case 'inventory-report':
            addInventoryReportToExcel(wb, reportData.content, summaryData);
            break;
        }

        // Save Excel file
        const fileName = `${reportType}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);

        showToast('Excel report generated successfully', 'success');

      } catch (error) {
        console.error('Error generating Excel report:', error);
        showToast('Error generating Excel report', 'error');
      } finally {
        hideLoading();
      }
    }

    /**
     * Add farm overview to Excel
     */
    function addFarmOverviewToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['SUMMARY']);
      summaryData.push(['Total Farms', content.summary.totalFarms]);
      summaryData.push(['Total Area (ha)', content.summary.totalArea]);
      summaryData.push(['Irrigated Farms', content.summary.irrigatedFarms]);
      summaryData.push(['Active Farms', content.summary.activeFarms]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Farms details
      const farmsData = [['Farm Name', 'Code', 'Location', 'Size (ha)', 'Soil Type', 'Irrigation', 'Status']];
      content.farms.forEach(farm => {
        farmsData.push([
          farm.name,
          farm.code,
          farm.location,
          farm.size,
          farm.soilType,
          farm.irrigationSystem,
          farm.status
        ]);
      });

      const wsF = XLSX.utils.aoa_to_sheet(farmsData);
      XLSX.utils.book_append_sheet(wb, wsF, 'Farms');
    }

    /**
     * Add production summary to Excel
     */
    function addProductionSummaryToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['SUMMARY']);
      summaryData.push(['Total Productions', content.summary.totalProductions]);
      summaryData.push(['Active Productions', content.summary.activeProductions]);
      summaryData.push(['Completed', content.summary.completedProductions]);
      summaryData.push(['Total Area (ha)', content.summary.totalArea]);
      summaryData.push(['Total Yield (T)', content.summary.totalYield]);
      summaryData.push(['Average Yield (T/ha)', content.summary.averageYield]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Productions details
      const prodData = [['Code', 'Crop', 'Season', 'Area (ha)', 'Expected Yield', 'Actual Yield', 'Planting Date', 'Harvest Date', 'Status']];
      content.productions.forEach(prod => {
        prodData.push([
          prod.code,
          prod.crop,
          prod.season,
          prod.area,
          prod.expectedYield || 'N/A',
          prod.actualYield || 'N/A',
          prod.plantingDate,
          prod.actualHarvestDate,
          prod.status
        ]);
      });

      const wsP = XLSX.utils.aoa_to_sheet(prodData);
      XLSX.utils.book_append_sheet(wb, wsP, 'Productions');
    }

    /**
     * Add financial report to Excel
     */
    function addFinancialReportToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['FINANCIAL SUMMARY']);
      summaryData.push(['Total Revenue', content.summary.totalRevenue]);
      summaryData.push(['Net Revenue', content.summary.netRevenue]);
      summaryData.push(['Transaction Fees', content.summary.transactionFees]);
      summaryData.push(['Total Costs', content.summary.totalCosts]);
      summaryData.push(['Profit/Loss', content.summary.profitLoss]);
      summaryData.push(['Profit Margin', content.summary.profitMargin]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Transactions
      const txData = [['Code', 'Date', 'Buyer', 'Crop', 'Quantity', 'Total Amount', 'Net Amount', 'Status']];
      content.transactions.forEach(tx => {
        txData.push([
          tx.code,
          tx.date,
          tx.buyer,
          tx.crop,
          tx.quantity,
          tx.totalAmount,
          tx.netAmount,
          tx.status
        ]);
      });

      const wsTx = XLSX.utils.aoa_to_sheet(txData);
      XLSX.utils.book_append_sheet(wb, wsTx, 'Transactions');
    }




    /**
     * Add resource usage to Excel
     */
    function addResourceUsageToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['RESOURCE USAGE SUMMARY']);
      summaryData.push(['Fertilizer Applications', content.summary.fertilizerApplications]);
      summaryData.push(['Total Fertilizer', content.summary.totalFertilizerQuantity]);
      summaryData.push(['Fertilizer Cost', content.summary.totalFertilizerCost]);
      summaryData.push(['Irrigation Sessions', content.summary.irrigationSessions]);
      summaryData.push(['Total Water Used', content.summary.totalWaterUsed]);
      summaryData.push(['Irrigation Cost', content.summary.totalIrrigationCost]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Fertilizer details
      const fertData = [['Date', 'Type', 'Name', 'Quantity', 'Method', 'Cost', 'Effectiveness']];
      content.fertilizer.applications.forEach(f => {
        fertData.push([
          f.date,
          f.type,
          f.name,
          f.quantity,
          f.method,
          f.cost,
          f.effectiveness
        ]);
      });

      const wsF = XLSX.utils.aoa_to_sheet(fertData);
      XLSX.utils.book_append_sheet(wb, wsF, 'Fertilizer Usage');

      // Irrigation details
      const irrigData = [['Date', 'Water Amount', 'Duration', 'Method', 'Source', 'Efficiency', 'Cost']];
      content.irrigation.sessions.forEach(i => {
        irrigData.push([
          i.date,
          i.waterAmount,
          i.duration,
          i.method,
          i.source,
          i.efficiency,
          i.cost
        ]);
      });

      const wsI = XLSX.utils.aoa_to_sheet(irrigData);
      XLSX.utils.book_append_sheet(wb, wsI, 'Irrigation Sessions');
    }

    /**
     * Add inventory report to Excel
     */
    function addInventoryReportToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['INVENTORY SUMMARY']);
      summaryData.push(['Total Items', content.summary.totalItems]);
      summaryData.push(['Total Quantity', content.summary.totalQuantity]);
      summaryData.push(['Available Quantity', content.summary.availableQuantity]);
      summaryData.push(['Total Value', content.summary.totalValue]);
      summaryData.push(['Expiring Items', content.summary.expiringItemsCount]);
      summaryData.push(['Expired Items', content.summary.expiredItemsCount]);
      summaryData.push(['Low Stock Items', content.summary.lowStockItemsCount]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Inventory items
      const invData = [['Code', 'Crop', 'Quantity', 'Available', 'Quality', 'Status', 'Value', 'Storage Date', 'Expiry Date']];
      content.items.forEach(item => {
        invData.push([
          item.code,
          item.crop,
          item.quantity,
          item.available,
          item.quality,
          item.status,
          item.value,
          item.storageDate,
          item.expiryDate
        ]);
      });

      const wsInv = XLSX.utils.aoa_to_sheet(invData);
      XLSX.utils.book_append_sheet(wb, wsInv, 'Inventory Items');

      // Expiring items alert
      if (content.alerts.expiring.length > 0) {
        const expiringData = [['Code', 'Crop', 'Quantity', 'Expiry Date', 'Days Until Expiry']];
        content.alerts.expiring.forEach(item => {
          expiringData.push([
            item.code,
            item.crop,
            item.quantity,
            item.expiryDate,
            item.daysUntilExpiry
          ]);
        });

        const wsExp = XLSX.utils.aoa_to_sheet(expiringData);
        XLSX.utils.book_append_sheet(wb, wsExp, 'Expiring Items');
      }

      // Expired items alert
      if (content.alerts.expired.length > 0) {
        const expiredData = [['Code', 'Crop', 'Quantity', 'Expiry Date']];
        content.alerts.expired.forEach(item => {
          expiredData.push([
            item.code,
            item.crop,
            item.quantity,
            item.expiryDate
          ]);
        });

        const wsExpired = XLSX.utils.aoa_to_sheet(expiredData);
        XLSX.utils.book_append_sheet(wb, wsExpired, 'Expired Items');
      }

      // Low stock alert
      if (content.alerts.lowStock.length > 0) {
        const lowStockData = [['Code', 'Crop', 'Available', 'Total']];
        content.alerts.lowStock.forEach(item => {
          lowStockData.push([
            item.code,
            item.crop,
            item.available,
            item.total
          ]);
        });

        const wsLow = XLSX.utils.aoa_to_sheet(lowStockData);
        XLSX.utils.book_append_sheet(wb, wsLow, 'Low Stock Items');
      }
    }

    /**
     * Helper function to update element text content
     */
    function updateElement(elementId, value) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = value;
      }
    }


    /**
     * Initialize all action buttons
     */
    // ============================================================================
    // NOTIFICATIONS SYSTEM
    // ============================================================================
    
    let notifications = [];
    let notificationInterval = null;

    // Load notifications from API
    async function loadNotifications() {
        try {
            if (!currentUser || !currentUser.email) {
                console.warn('⚠️ No current user found for notifications');
                return;
            }

            const token = authToken || localStorage.getItem('authToken');
            if (!token) {
                console.warn('⚠️ No auth token found');
                return;
            }

            // Fetch notifications from chat API
            const response = await fetch(`${API_CONFIG.BASE_URL}/chat/notifications`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            notifications = Array.isArray(data) ? data : [];

            // Also fetch farmer-specific notifications (new farms, productions, etc.)
            await loadFarmerSpecificNotifications();

            displayNotifications();
            updateNotificationBadge();

        } catch (error) {
            console.error('❌ Error loading notifications:', error);
            // Fallback: create sample notifications for demo
            notifications = [];
            displayNotifications();
        }
    }

    // Load farmer-specific notifications
    async function loadFarmerSpecificNotifications() {
        try {
            if (!currentUser || !currentUser.id) return;

            const farmerId = currentUser.id;

            // Check for new farms
            try {
                const farmsResponse = await apiRequest(`/farms/farmer/${farmerId}/all`);
                const farms = Array.isArray(farmsResponse) ? farmsResponse : [];
                
                // Get recently created farms (last 24 hours)
                const recentFarms = farms.filter(farm => {
                    if (!farm.createdAt) return false;
                    const created = new Date(farm.createdAt);
                    const now = new Date();
                    const diffHours = (now - created) / (1000 * 60 * 60);
                    return diffHours <= 24;
                });

                recentFarms.forEach(farm => {
                    const exists = notifications.some(n => 
                        n.content && n.content.includes(`Farm "${farm.farmName}"`) && 
                        n.type === 'SYSTEM_ALERT'
                    );
                    if (!exists) {
                        notifications.unshift({
                            id: `farm-${farm.id}`,
                            senderId: 'SYSTEM',
                            recipientId: currentUser.email,
                            content: `New farm "${farm.farmName}" has been registered successfully!`,
                            type: 'SYSTEM_ALERT',
                            read: false,
                            timestamp: farm.createdAt || new Date().toISOString()
                        });
                    }
                });
            } catch (error) {
                console.warn('Error loading farm notifications:', error);
            }

            // Check for new productions
            try {
                const productionsResponse = await apiRequest(`/v1/crop-productions/farmer/${farmerId}`);
                const productions = Array.isArray(productionsResponse) ? productionsResponse : 
                                  (productionsResponse.data ? productionsResponse.data : []);

                const recentProductions = productions.filter(prod => {
                    if (!prod.createdAt) return false;
                    const created = new Date(prod.createdAt);
                    const now = new Date();
                    const diffHours = (now - created) / (1000 * 60 * 60);
                    return diffHours <= 24;
                });

                recentProductions.forEach(prod => {
                    const exists = notifications.some(n => 
                        n.content && n.content.includes(`Production`) && 
                        n.type === 'SYSTEM_ALERT'
                    );
                    if (!exists) {
                        notifications.unshift({
                            id: `prod-${prod.id}`,
                            senderId: 'SYSTEM',
                            recipientId: currentUser.email,
                            content: `New crop production has been created! Check your productions section.`,
                            type: 'SYSTEM_ALERT',
                            read: false,
                            timestamp: prod.createdAt || new Date().toISOString()
                        });
                    }
                });
            } catch (error) {
                console.warn('Error loading production notifications:', error);
            }

        } catch (error) {
            console.error('Error loading farmer-specific notifications:', error);
        }
    }

    // Display notifications in dropdown
    function displayNotifications() {
        const notificationsList = document.getElementById('notificationsList');
        const notificationBadge = document.getElementById('notificationCount');

        if (!notificationsList) return;

        const unreadCount = notifications.filter(n => !n.read).length;

        if (notificationBadge) {
            notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
        }

        if (notifications.length === 0) {
            notificationsList.innerHTML = `
                <div class="notification-empty">
                    <i class="fas fa-bell-slash"></i>
                    <p>No notifications</p>
                    <small>You're all caught up!</small>
                </div>
            `;
            return;
        }

        // Sort by timestamp (newest first)
        const sortedNotifications = [...notifications].sort((a, b) => {
            const dateA = new Date(a.timestamp || 0);
            const dateB = new Date(b.timestamp || 0);
            return dateB - dateA;
        });

        notificationsList.innerHTML = sortedNotifications.map(notification => {
            const isUnread = !notification.read;
            const timeAgo = formatTimeAgo(notification.timestamp);
            const icon = getNotificationIcon(notification.type);

            return `
                <div class="notification-item ${isUnread ? 'unread' : ''}" onclick="markNotificationAsRead(${notification.id})" data-notification-id="${notification.id}">
                    <div class="notification-item-title">
                        <i class="${icon}" style="margin-right: 0.5rem; color: var(--primary-green);"></i>
                        ${getNotificationTitle(notification.type)}
                    </div>
                    <div class="notification-item-message">
                        ${escapeHtml(notification.content || notification.message || 'New notification')}
                    </div>
                    <div class="notification-item-time">
                        <i class="fas fa-clock"></i>
                        ${timeAgo}
                    </div>
                </div>
            `;
        }).join('');
    }

    // Update notification badge count
    function updateNotificationBadge() {
        const notificationBadge = document.getElementById('notificationCount');
        if (notificationBadge) {
            const unreadCount = notifications.filter(n => !n.read).length;
            notificationBadge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
        }
    }

    // Mark notification as read
    async function markNotificationAsRead(notificationId) {
        try {
            const notification = notifications.find(n => n.id === notificationId);
            if (!notification) return;

            // Update locally
            notification.read = true;
            displayNotifications();
            updateNotificationBadge();

            // Mark as read on server if it's a chat notification
            if (notificationId && typeof notificationId === 'number') {
                const token = authToken || localStorage.getItem('authToken');
                if (token) {
                    await fetch(`${API_CONFIG.BASE_URL}/chat/notifications/${notificationId}/read`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                }
            }
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    }

    // Mark all notifications as read
    async function markAllNotificationsAsRead() {
        try {
            notifications.forEach(n => n.read = true);
            displayNotifications();
            updateNotificationBadge();

            const token = authToken || localStorage.getItem('authToken');
            if (token) {
                // Mark all as read on server
                notifications.forEach(async (notification) => {
                    if (notification.id && typeof notification.id === 'number' && !notification.read) {
                        try {
                            await fetch(`${API_CONFIG.BASE_URL}/chat/notifications/${notification.id}/read`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                }
                            });
                        } catch (error) {
                            console.warn('Error marking notification as read:', error);
                        }
                    }
                });
            }
        } catch (error) {
            console.error('Error marking all notifications as read:', error);
        }
    }

    // Toggle notifications dropdown
    function toggleNotifications() {
        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown) {
            const isVisible = dropdown.style.display === 'block' || dropdown.classList.contains('show');
            if (isVisible) {
                dropdown.style.display = 'none';
                dropdown.classList.remove('show');
            } else {
                dropdown.style.display = 'block';
                dropdown.classList.add('show');
                loadNotifications(); // Refresh when opening
            }
        }
    }

    // Helper functions
    function formatTimeAgo(timestamp) {
        if (!timestamp) return 'Just now';
        const now = new Date();
        const time = new Date(timestamp);
        const diffMs = now - time;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
        if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        return formatDate(timestamp);
    }

    function getNotificationIcon(type) {
        const icons = {
            'MESSAGE': 'fas fa-comment',
            'SYSTEM_ALERT': 'fas fa-info-circle',
            'FARM': 'fas fa-tractor',
            'PRODUCTION': 'fas fa-seedling',
            'TRANSACTION': 'fas fa-dollar-sign'
        };
        return icons[type] || 'fas fa-bell';
    }

    function getNotificationTitle(type) {
        const titles = {
            'MESSAGE': 'New Message',
            'SYSTEM_ALERT': 'System Alert',
            'FARM': 'Farm Update',
            'PRODUCTION': 'Production Update',
            'TRANSACTION': 'Transaction Update'
        };
        return titles[type] || 'Notification';
    }

    // Close notifications dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('notificationDropdown');
        const btn = document.getElementById('notificationBtn');
        if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
            dropdown.style.display = 'none';
            dropdown.classList.remove('show');
        }
    });

    // Initialize notifications on page load
    function initNotifications() {
        const notificationBtn = document.getElementById('notificationBtn');
        if (notificationBtn) {
            notificationBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleNotifications();
            });
        }

        // Load notifications every 30 seconds
        loadNotifications();
        if (notificationInterval) {
            clearInterval(notificationInterval);
        }
        notificationInterval = setInterval(loadNotifications, 30000);
    }

    // ============================================================================
    // END NOTIFICATIONS SYSTEM
    // ============================================================================

    function initActionButtons() {
      // Add Farm buttons
      document.querySelectorAll('[data-action="add-farm"]').forEach(btn => {
        btn.addEventListener('click', openAddFarmModal);
      });

      // Add Production buttons
      document.querySelectorAll('[data-action="add-production"]').forEach(btn => {
        btn.addEventListener('click', openAddProductionModal);
      });

      // Add Inventory buttons
      document.querySelectorAll('[data-action="add-inventory"]').forEach(btn => {
        btn.addEventListener('click', openAddInventoryModal);
      });

      // Refresh buttons
      document.querySelectorAll('[data-action="refresh-farms"]').forEach(btn => {
        btn.addEventListener('click', () => loadFarmsData());
      });

      document.querySelectorAll('[data-action="refresh-crops"]').forEach(btn => {
        btn.addEventListener('click', () => loadCropsData());
      });

      document.querySelectorAll('[data-action="refresh-productions"]').forEach(btn => {
        btn.addEventListener('click', () => loadProductionData());
      });

      document.querySelectorAll('[data-action="refresh-inventory"]').forEach(btn => {
        btn.addEventListener('click', () => loadInventoryData());
      });

      document.querySelectorAll('[data-action="refresh-fertilizer"]').forEach(btn => {
        btn.addEventListener('click', () => loadFertilizerData());
      });

      document.querySelectorAll('[data-action="refresh-irrigation"]').forEach(btn => {
        btn.addEventListener('click', () => loadIrrigationData());
      });

      document.querySelectorAll('[data-action="refresh-soil"]').forEach(btn => {
        btn.addEventListener('click', () => loadSoilData());
      });

      document.querySelectorAll('[data-action="refresh-market-prices"]').forEach(btn => {
        btn.addEventListener('click', () => loadMarketPricesData());
      });

      document.querySelectorAll('[data-action="refresh-transactions"]').forEach(btn => {
        btn.addEventListener('click', () => loadTransactionsData());
      });

      document.querySelectorAll('[data-action="refresh-supply-chain"]').forEach(btn => {
        btn.addEventListener('click', () => loadSupplyChainData());
      });

      document.querySelectorAll('[data-action="refresh-weather"]').forEach(btn => {
        btn.addEventListener('click', () => loadWeatherData());
      });

      document.querySelectorAll('[data-action="refresh-alerts"]').forEach(btn => {
        btn.addEventListener('click', () => loadAlertsData());
      });

      document.querySelectorAll('[data-action="refresh-policies"]').forEach(btn => {
        btn.addEventListener('click', () => loadPoliciesData());
      });

      document.querySelectorAll('[data-action="refresh-recommendations"]').forEach(btn => {
        btn.addEventListener('click', () => loadRecommendationsData());
      });

      // ✅ Production Predictions refresh button
      document.querySelectorAll('[data-action="refresh-predictions"]').forEach(btn => {
        btn.addEventListener('click', () => refreshProductionPredictions());
      });
      
      // ✅ Also handle onclick refresh button in predictions section
      const predictionsRefreshBtn = document.querySelector('#predictionsSection [onclick*="refresh"]');
      if (predictionsRefreshBtn) {
        predictionsRefreshBtn.onclick = () => refreshProductionPredictions();
      }

      // Export buttons
    document.querySelectorAll('[data-action="export-farms"]').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    exportFarmsToExcel();
  });
});

      document.querySelectorAll('[data-action="export-productions"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export productions feature - To be implemented', 'info'));
      });



      document.querySelectorAll('[data-action="export-fertilizer"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export fertilizer feature - To be implemented', 'info'));
      });

      document.querySelectorAll('[data-action="export-irrigation"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export irrigation feature - To be implemented', 'info'));
      });

      document.querySelectorAll('[data-action="export-transactions"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export transactions feature - To be implemented', 'info'));
      });

      // Tasks and Activities refresh
      document.querySelectorAll('[data-action="refresh-tasks"]').forEach(btn => {
        btn.addEventListener('click', () => loadUpcomingTasks());
      });

      document.querySelectorAll('[data-action="refresh-activities"]').forEach(btn => {
        btn.addEventListener('click', () => loadRecentActivities());
      });

      // Clear filter buttons
      document.querySelectorAll('[data-action="clear-filters"]').forEach(btn => {
        btn.addEventListener('click', clearFilters);
      });

      document.querySelectorAll('[data-action="clear-crop-filters"]').forEach(btn => {
        btn.addEventListener('click', clearCropFilters);
      });

      document.querySelectorAll('[data-action="clear-production-filters"]').forEach(btn => {
        btn.addEventListener('click', clearProductionFilters);
      });

      document.querySelectorAll('[data-action="clear-inventory-filters"]').forEach(btn => {
        btn.addEventListener('click', clearInventoryFilters);
      });

      document.querySelectorAll('[data-action="clear-fertilizer-filters"]').forEach(btn => {
        btn.addEventListener('click', clearFertilizerFilters);
      });

      document.querySelectorAll('[data-action="clear-irrigation-filters"]').forEach(btn => {
        btn.addEventListener('click', clearIrrigationFilters);
      });

      document.querySelectorAll('[data-action="clear-market-prices-filters"]').forEach(btn => {
        btn.addEventListener('click', clearMarketPricesFilters);
      });

      document.querySelectorAll('[data-action="clear-transactions-filters"]').forEach(btn => {
        btn.addEventListener('click', clearTransactionsFilters);
      });

      document.querySelectorAll('[data-action="clear-alerts-filters"]').forEach(btn => {
        btn.addEventListener('click', clearAlertsFilters);
      });

      // Alerts filter listeners
      const alertsSearchInput = document.getElementById('alertsSearchInput');
      const alertsLevelFilter = document.getElementById('alertsLevelFilter');
      const alertsCategoryFilter = document.getElementById('alertsCategoryFilter');

      if (alertsSearchInput) {
        alertsSearchInput.addEventListener('input', filterAlerts);
        alertsSearchInput.addEventListener('keyup', filterAlerts);
      }

      if (alertsLevelFilter) {
        alertsLevelFilter.addEventListener('change', filterAlerts);
      }

      if (alertsCategoryFilter) {
        alertsCategoryFilter.addEventListener('change', filterAlerts);
      }

      document.querySelectorAll('[data-action="clear-policies-filters"]').forEach(btn => {
        btn.addEventListener('click', clearPoliciesFilters);
      });

      // Policies filter listeners
      const policiesSearchInput = document.getElementById('policiesSearchInput');
      const policiesTypeFilter = document.getElementById('policiesTypeFilter');
      const policiesStatusFilter = document.getElementById('policiesStatusFilter');

      if (policiesSearchInput) {
        policiesSearchInput.addEventListener('input', filterPolicies);
        policiesSearchInput.addEventListener('keyup', filterPolicies);
      }

      if (policiesTypeFilter) {
        policiesTypeFilter.addEventListener('change', filterPolicies);
      }

      if (policiesStatusFilter) {
        policiesStatusFilter.addEventListener('change', filterPolicies);
      }

      document.querySelectorAll('[data-action="clear-recommendations-filters"]').forEach(btn => {
        btn.addEventListener('click', clearRecommendationsFilters);
      });

      // Recommendations filter listeners
      const recommendationsTypeFilter = document.getElementById('recommendationsTypeFilter');
      const recommendationsPriorityFilter = document.getElementById('recommendationsPriorityFilter');

      if (recommendationsTypeFilter) {
        recommendationsTypeFilter.addEventListener('change', filterRecommendations);
      }

      if (recommendationsPriorityFilter) {
        recommendationsPriorityFilter.addEventListener('change', filterRecommendations);
      }
    }

    /**
     * Clear filter functions
     */
    function clearFilters() {
      const searchInput = document.getElementById('farmsSearchInput');
      const soilTypeFilter = document.getElementById('farmsSoilTypeFilter');
      const irrigationFilter = document.getElementById('farmsIrrigationFilter');

      if (searchInput) searchInput.value = '';
      if (soilTypeFilter) soilTypeFilter.value = '';
      if (irrigationFilter) irrigationFilter.value = '';

      loadFarmsData();
    }

    function clearCropFilters() {
      const searchInput = document.getElementById('cropsSearchInput');
      const typeFilter = document.getElementById('cropsTypeFilter');
      const seasonFilter = document.getElementById('cropsSeasonFilter');
      const demandFilter = document.getElementById('cropsDemandFilter');

      if (searchInput) searchInput.value = '';
      if (typeFilter) typeFilter.value = '';
      if (seasonFilter) seasonFilter.value = '';
      if (demandFilter) demandFilter.value = '';

      loadCropsData();
    }

    function clearProductionFilters() {
      const searchInput = document.getElementById('productionSearchInput');
      const statusFilter = document.getElementById('productionStatusFilter');
      const seasonFilter = document.getElementById('productionSeasonFilter');
      const yearFilter = document.getElementById('productionYearFilter');

      if (searchInput) searchInput.value = '';
      if (statusFilter) statusFilter.value = '';
      if (seasonFilter) seasonFilter.value = '';
      if (yearFilter) yearFilter.value = '';

      loadProductionData();
    }

    function clearInventoryFilters() {
      const searchInput = document.getElementById('inventorySearchInput');
      const statusFilter = document.getElementById('inventoryStatusFilter');
      const qualityFilter = document.getElementById('inventoryQualityFilter');

      if (searchInput) searchInput.value = '';
      if (statusFilter) statusFilter.value = '';
      if (qualityFilter) qualityFilter.value = '';

      loadInventoryData();
    }

    function clearFertilizerFilters() {
      const searchInput = document.getElementById('fertilizerSearchInput');
      const typeFilter = document.getElementById('fertilizerTypeFilter');
      const dateFrom = document.getElementById('fertilizerDateFrom');
      const dateTo = document.getElementById('fertilizerDateTo');

      if (searchInput) searchInput.value = '';
      if (typeFilter) typeFilter.value = '';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';

      loadFertilizerData();
    }

    function clearIrrigationFilters() {
      const searchInput = document.getElementById('irrigationSearchInput');
      const methodFilter = document.getElementById('irrigationMethodFilter');
      const sourceFilter = document.getElementById('irrigationSourceFilter');
      const dateFrom = document.getElementById('irrigationDateFrom');
      const dateTo = document.getElementById('irrigationDateTo');

      if (searchInput) searchInput.value = '';
      if (methodFilter) methodFilter.value = '';
      if (sourceFilter) sourceFilter.value = '';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';

      loadIrrigationData();
    }

    function clearMarketPricesFilters() {
      const searchInput = document.getElementById('marketPricesSearchInput');
      const typeFilter = document.getElementById('marketPricesTypeFilter');
      const trendFilter = document.getElementById('marketPricesTrendFilter');

      if (searchInput) searchInput.value = '';
      if (typeFilter) typeFilter.value = '';
      if (trendFilter) trendFilter.value = '';

      loadMarketPricesData();
    }

    function clearTransactionsFilters() {
      const searchInput = document.getElementById('transactionsSearchInput');
      const statusFilter = document.getElementById('transactionsStatusFilter');
      const dateFrom = document.getElementById('transactionsDateFrom');
      const dateTo = document.getElementById('transactionsDateTo');

      if (searchInput) searchInput.value = '';
      if (statusFilter) statusFilter.value = '';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';

      loadTransactionsData();
    }

    // Store alerts globally for filtering
    let allAlertsData = [];

    function clearAlertsFilters() {
      const searchInput = document.getElementById('alertsSearchInput');
      const levelFilter = document.getElementById('alertsLevelFilter');
      const categoryFilter = document.getElementById('alertsCategoryFilter');

      if (searchInput) searchInput.value = '';
      if (levelFilter) levelFilter.value = '';
      if (categoryFilter) categoryFilter.value = '';

      // Re-display all alerts
      if (allAlertsData.length > 0) {
        displayAlertsList(allAlertsData);
        updateAlertsStatistics(allAlertsData);
      } else {
        loadAlertsData();
      }
    }

    /**
     * Filter alerts based on search and filters
     */
    function filterAlerts() {
      const searchInput = document.getElementById('alertsSearchInput');
      const levelFilter = document.getElementById('alertsLevelFilter');
      const categoryFilter = document.getElementById('alertsCategoryFilter');

      if (!searchInput || !levelFilter || !categoryFilter) return;

      const searchTerm = (searchInput.value || '').toLowerCase();
      const levelValue = levelFilter.value;
      const categoryValue = categoryFilter.value;

      const filtered = allAlertsData.filter(alert => {
        // Search filter
        if (searchTerm) {
          const titleMatch = (alert.alertTitle || '').toLowerCase().includes(searchTerm);
          const descMatch = (alert.description || '').toLowerCase().includes(searchTerm);
          if (!titleMatch && !descMatch) return false;
        }

        // Level filter
        if (levelValue && alert.alertLevel !== levelValue) {
          return false;
        }

        // Category filter
        if (categoryValue) {
          const alertCategory = alert.alertCategory || alert.category || '';
          if (alertCategory !== categoryValue) {
            return false;
          }
        }

        return true;
      });

      displayAlertsList(filtered);
      updateAlertsStatistics(filtered);
    }




/**
 * Export productions to Excel
 */
async function exportProductionsToExcel() {
    try {
        showLoading();
        showToast('Preparing export...', 'info');

        // Récupérer les productions
        const productionsResponse = await apiRequest(`/v1/crop-productions/by-farmer/${currentUser.id}`);
        let allProductions = [];

        if (productionsResponse) {
            if (Array.isArray(productionsResponse)) allProductions = productionsResponse;
            else if (productionsResponse.data && Array.isArray(productionsResponse.data)) allProductions = productionsResponse.data;
            else if (productionsResponse.data?.content) allProductions = productionsResponse.data.content;
            else if (productionsResponse.content) allProductions = productionsResponse.content;
        }

        allProductions = allProductions.filter(p => p && p.productionStatus);

        if (allProductions.length > 0) {
            allProductions = await enrichProductionsWithCropNames(allProductions);
        }

        if (allProductions.length === 0) {
            showToast('No productions to export', 'warning');
            hideLoading();
            return;
        }

        // Headers
        const headers = [
            'Production Code', 'Crop Name', 'Status', 'Season', 'Year',
            'Area Planted (ha)', 'Expected Yield (T/ha)', 'Actual Yield (T/ha)',
            'Planting Date', 'Expected Harvest', 'Actual Harvest', 'Production Method', 'Seed Variety'
        ];

        // Rows
        const rows = allProductions.map(p => [
            p.productionCode || '',
            p.cropName || '',
            p.productionStatus || '',
            p.season || '',
            p.year || '',
            p.areaPlanted || 0,
            p.expectedYield || '',
            p.actualYield || '',
            p.plantingDate ? p.plantingDate.split('T')[0] : '',
            p.expectedHarvestDate ? p.expectedHarvestDate.split('T')[0] : '',
            p.actualHarvestDate ? p.actualHarvestDate.split('T')[0] : '',
            p.productionMethod || '',
            p.seedVariety || ''
        ]);

        // Build XLSX manually (Office Open XML)
        const sheetName = 'Productions';

        function escapeXml(s) {
            return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;');
        }

        // Shared strings
        const strings = [];
        const strMap = {};
        function addString(val) {
            const s = String(val);
            if (!(s in strMap)) { strMap[s] = strings.length; strings.push(s); }
            return strMap[s];
        }

        // Pre-register all strings
        headers.forEach(h => addString(h));
        rows.forEach(row => row.forEach(cell => { if (typeof cell === 'string') addString(cell); }));

        function cellRef(col, row) {
            let c = '';
            let n = col;
            while (n >= 0) { c = String.fromCharCode(65 + (n % 26)) + c; n = Math.floor(n / 26) - 1; }
            return c + (row + 1);
        }

        // sheet1.xml
        let sheetRows = '';
        // Header row (style 1 = bold green header)
        let headerCells = headers.map((h, ci) => `<c r="${cellRef(ci,0)}" t="s" s="1"><v>${addString(h)}</v></c>`).join('');
        sheetRows += `<row r="1">${headerCells}</row>`;

        // Data rows
        rows.forEach((row, ri) => {
            let cells = row.map((cell, ci) => {
                const ref = cellRef(ci, ri + 1);
                const numCols = [5, 6, 7]; // areaPlanted, expectedYield, actualYield
                if (numCols.includes(ci) && cell !== '' && !isNaN(cell)) {
                    return `<c r="${ref}" s="2"><v>${cell}</v></c>`;
                }
                return `<c r="${ref}" t="s" s="2"><v>${addString(String(cell))}</v></c>`;
            }).join('');
            sheetRows += `<row r="${ri + 2}">${cells}</row>`;
        });

        const sheet1 = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<sheetViews><sheetView tabSelected="1" workbookViewId="0"/></sheetViews>
<sheetFormatPr defaultRowHeight="20"/>
<cols>${headers.map((_,i) => `<col min="${i+1}" max="${i+1}" width="22" customWidth="1"/>`).join('')}</cols>
<sheetData>${sheetRows}</sheetData>
</worksheet>`;

        // styles.xml with green header
        const styles = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<fonts count="3">
  <font><sz val="11"/><name val="Calibri"/></font>
  <font><b/><sz val="11"/><color rgb="FFFFFFFF"/><name val="Calibri"/></font>
  <font><sz val="11"/><name val="Calibri"/></font>
</fonts>
<fills count="3">
  <fill><patternFill patternType="none"/></fill>
  <fill><patternFill patternType="solid"><fgColor rgb="FF10B981"/></patternFill></fill>
  <fill><patternFill patternType="solid"><fgColor rgb="FFF0FDF4"/></patternFill></fill>
</fills>
<borders count="2">
  <border><left/><right/><top/><bottom/><diagonal/></border>
  <border><left style="thin"><color rgb="FF10B981"/></left><right style="thin"><color rgb="FF10B981"/></right><top style="thin"><color rgb="FF10B981"/></top><bottom style="thin"><color rgb="FF10B981"/></bottom><diagonal/></border>
</borders>
<cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>
<cellXfs count="3">
  <xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/>
  <xf numFmtId="0" fontId="1" fillId="1" borderId="1" xfId="0" applyFont="1" applyFill="1" applyBorder="1" applyAlignment="1"><alignment horizontal="center" vertical="center"/></xf>
  <xf numFmtId="0" fontId="2" fillId="2" borderId="1" xfId="0" applyFill="1" applyBorder="1"/>
</cellXfs>
</styleSheet>`;

        const sharedStrings = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="${strings.length}" uniqueCount="${strings.length}">
${strings.map(s => `<si><t>${escapeXml(s)}</t></si>`).join('')}
</sst>`;

        const workbook = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
<sheets><sheet name="${sheetName}" sheetId="1" r:id="rId1"/></sheets>
</workbook>`;

        const rels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
<Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings" Target="sharedStrings.xml"/>
</Relationships>`;

        const topRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
</Relationships>`;

        const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
<Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
<Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>
<Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/>
</Types>`;

        // ZIP manually using DecompressionStream trick — use simple zip builder
        const files = {
            '[Content_Types].xml': contentTypes,
            '_rels/.rels': topRels,
            'xl/workbook.xml': workbook,
            'xl/_rels/workbook.xml.rels': rels,
            'xl/worksheets/sheet1.xml': sheet1,
            'xl/styles.xml': styles,
            'xl/sharedStrings.xml': sharedStrings
        };

        const blob = await buildZipBlob(files);
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Crop_Productions_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showToast('✅ Export successful!', 'success');

    } catch (error) {
        console.error('❌ Export error:', error);
        showToast('Failed to export: ' + error.message, 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Build a ZIP blob from a map of {path: content}
 */
async function buildZipBlob(files) {
    const entries = [];

    for (const [name, content] of Object.entries(files)) {
        const encoder = new TextEncoder();
        const data = encoder.encode(content);
        const crc = crc32(data);
        entries.push({ name, data, crc });
    }

    const parts = [];
    const centralDir = [];
    let offset = 0;

    for (const entry of entries) {
        const nameBytes = new TextEncoder().encode(entry.name);

        // Local file header
        const local = new Uint8Array(30 + nameBytes.length);
        const lv = new DataView(local.buffer);
        lv.setUint32(0, 0x04034b50, true);  // signature
        lv.setUint16(4, 20, true);           // version needed
        lv.setUint16(6, 0, true);            // flags
        lv.setUint16(8, 0, true);            // compression (store)
        lv.setUint16(10, 0, true);           // mod time
        lv.setUint16(12, 0, true);           // mod date
        lv.setUint32(14, entry.crc, true);   // crc32
        lv.setUint32(18, entry.data.length, true); // compressed size
        lv.setUint32(22, entry.data.length, true); // uncompressed size
        lv.setUint16(26, nameBytes.length, true);  // name length
        lv.setUint16(28, 0, true);           // extra length
        local.set(nameBytes, 30);

        parts.push(local);
        parts.push(entry.data);

        // Central directory entry
        const cd = new Uint8Array(46 + nameBytes.length);
        const cv = new DataView(cd.buffer);
        cv.setUint32(0, 0x02014b50, true);
        cv.setUint16(4, 20, true);
        cv.setUint16(6, 20, true);
        cv.setUint16(8, 0, true);
        cv.setUint16(10, 0, true);
        cv.setUint16(12, 0, true);
        cv.setUint16(14, 0, true);
        cv.setUint32(16, entry.crc, true);
        cv.setUint32(20, entry.data.length, true);
        cv.setUint32(24, entry.data.length, true);
        cv.setUint16(28, nameBytes.length, true);
        cv.setUint16(30, 0, true);
        cv.setUint16(32, 0, true);
        cv.setUint16(34, 0, true);
        cv.setUint16(36, 0, true);
        cv.setUint16(38, 0, true);
        cv.setUint32(40, 0, true);
        cv.setUint32(42, offset, true);
        cd.set(nameBytes, 46);

        centralDir.push(cd);
        offset += local.length + entry.data.length;
    }

    const cdOffset = offset;
    let cdSize = 0;
    for (const cd of centralDir) { parts.push(cd); cdSize += cd.length; }

    // End of central directory
    const eocd = new Uint8Array(22);
    const ev = new DataView(eocd.buffer);
    ev.setUint32(0, 0x06054b50, true);
    ev.setUint16(4, 0, true);
    ev.setUint16(6, 0, true);
    ev.setUint16(8, entries.length, true);
    ev.setUint16(10, entries.length, true);
    ev.setUint32(12, cdSize, true);
    ev.setUint32(16, cdOffset, true);
    ev.setUint16(20, 0, true);
    parts.push(eocd);

    let totalLen = 0;
    for (const p of parts) totalLen += p.length;
    const result = new Uint8Array(totalLen);
    let pos = 0;
    for (const p of parts) { result.set(p, pos); pos += p.length; }

    return new Blob([result], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
}

/**
 * CRC32 implementation
 */
function crc32(data) {
    let crc = 0xFFFFFFFF;
    for (let i = 0; i < data.length; i++) {
        crc ^= data[i];
        for (let j = 0; j < 8; j++) {
            crc = (crc >>> 1) ^ (crc & 1 ? 0xEDB88320 : 0);
        }
    }
    return (crc ^ 0xFFFFFFFF) >>> 0;
}

// ✅ Remplacer l'ancien listener Export par celui-ci
document.querySelectorAll('[data-action="export-productions"]').forEach(btn => {
    btn.addEventListener('click', exportProductionsToExcel);
});
    /**
     * Filter policies based on search and filters
     */
    function filterPolicies() {
      const searchInput = document.getElementById('policiesSearchInput');
      const typeFilter = document.getElementById('policiesTypeFilter');
      const statusFilter = document.getElementById('policiesStatusFilter');

      if (!searchInput || !typeFilter || !statusFilter) return;

      const searchTerm = (searchInput.value || '').toLowerCase();
      const typeValue = typeFilter.value;
      const statusValue = statusFilter.value;

      const filtered = allPoliciesData.filter(policy => {
        // Search filter
        if (searchTerm) {
          const nameMatch = (policy.policyName || '').toLowerCase().includes(searchTerm);
          const descMatch = (policy.description || '').toLowerCase().includes(searchTerm);
          const codeMatch = (policy.policyCode || '').toLowerCase().includes(searchTerm);
          if (!nameMatch && !descMatch && !codeMatch) return false;
        }

        // Type filter
        if (typeValue && policy.policyType !== typeValue) {
          return false;
        }

        // Status filter
        if (statusValue) {
          if (statusValue === 'ACTIVE') {
            // Check if policy is actually active
            const isActive = policy.status === 'ACTIVE' || 
              (policy.effectiveDate && new Date(policy.effectiveDate) <= new Date() && 
               (!policy.expiryDate || new Date(policy.expiryDate) >= new Date()));
            if (!isActive) return false;
          } else if (policy.status !== statusValue) {
            return false;
          }
        }

        return true;
      });

      displayPoliciesGrid(filtered);
    }

    function clearPoliciesFilters() {
      const searchInput = document.getElementById('policiesSearchInput');
      const typeFilter = document.getElementById('policiesTypeFilter');
      const statusFilter = document.getElementById('policiesStatusFilter');

      if (searchInput) searchInput.value = '';
      if (typeFilter) typeFilter.value = '';
      if (statusFilter) statusFilter.value = '';

      // Re-display all policies
      if (allPoliciesData.length > 0) {
        displayPoliciesGrid(allPoliciesData);
      } else {
        loadPoliciesData();
      }
    }

    // clearRecommendationsFilters function is defined above in the AI Recommendations module







  // ============================================================================
  // PAGE INITIALIZATION
  // ============================================================================

  /**
   * Initialize the dashboard on page load
   */
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      if (DEBUG_MODE) {
        console.log('=== DASHBOARD INITIALIZATION ===');
        console.log('Starting dashboard initialization...');
      }

      // Show loading overlay
      showLoading();

      // CORRECTION: Utiliser UserSessionHandler au lieu de loadUserSession()
      const sessionHandler = UserSessionHandler.getInstance();

      // Vérifier si l'utilisateur est authentifié
      if (!sessionHandler.isAuthenticated()) {
        console.error('No valid user session found');
        window.location.href = '/login.html';
        return;
      }

      // Charger l'utilisateur depuis la session
      const user = sessionHandler.getCurrentUser();
      if (!user) {
        console.error('Could not retrieve user data');
        window.location.href = '/login.html';
        return;
      }

      // Assigner à currentUser pour le reste du code
      currentUser = user;
      authToken = user.token || sessionHandler.getAuthToken();

      if (DEBUG_MODE) {
        console.log('User session loaded:', {
          id: user.id || user.userId,
          email: user.email,
          role: user.role,
          fullName: user.fullName
        });
      }

      // Update UI with user info
      updateProfileDisplay();
      updateCurrentDate();

      // Initialize navigation
      initNavigation();

      // Initialize action buttons
      initActionButtons();

      // Initialize notifications system
      initNotifications();

      // Initialize reports listeners
      initReportsListeners();

      // Load initial dashboard data
      await loadDashboardData();

      if (DEBUG_MODE) {
        console.log('Dashboard initialized successfully');
        console.log('=================================');
      }

      // Show success message
      showToast(`Welcome back, ${user.fullName}!`, 'success');

    } catch (error) {
      console.error('Error initializing dashboard:', error);
      showToast('Error loading dashboard. Please refresh the page.', 'error');
    } finally {
      hideLoading();
    }
  });




    /**
     * Handle page visibility change - refresh data when page becomes visible
     */
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && currentUser) {
        // Refresh current section data when page becomes visible
        const activeSection = document.querySelector('.content-section.active');
        if (activeSection) {
          const sectionId = activeSection.id.replace('Section', '');
          loadSectionData(sectionId);
        }
      }
    });

    /**
     * Handle window resize - adjust charts
     */
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        // Resize all charts
        Object.values(charts).forEach(chart => {
          if (chart) {
            chart.resize();
          }
        });
      }, 250);
    });

    /**
     * Cleanup before page unload
     */
    window.addEventListener('beforeunload', () => {
      // Destroy all charts
      Object.values(charts).forEach(chart => {
        if (chart) {
          chart.destroy();
        }
      });
    });

    // ============================================================================
    // ERROR HANDLERS
    // ============================================================================

    /**
     * Global error handler
     */
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      if (DEBUG_MODE) {
        showToast('An unexpected error occurred', 'error');
      }
    });

    /**
     * Global unhandled rejection handler
     */
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      if (DEBUG_MODE) {
        showToast('An unexpected error occurred', 'error');
      }
    });

    // ============================================================================
    // CONSOLE MESSAGE
    // ============================================================================

    if (DEBUG_MODE) {
      console.log('%c🌾 AgriGuard AI - Farmer Dashboard', 'color: #22c55e; font-size: 20px; font-weight: bold;');
      console.log('%cDashboard Version: 1.0.0', 'color: #666; font-size: 12px;');
      console.log('%cAPI Base URL: ' + API_CONFIG.BASE_URL, 'color: #666; font-size: 12px;');
      console.log('%cDebug Mode: ON', 'color: #f59e0b; font-size: 12px; font-weight: bold;');
    }

</script>
</body>
</html>