<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriGuard AI - Farmer Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>







        :root {
        --primary-green: #22c55e;
        --primary-dark: #16a34a;
        --secondary-green: #10b981;
        --accent-green: #34d399;
        --light-green: #dcfce7;
        --dark-green: #166534;
        --forest-green: #065f46;
        --success-color: #22c55e;
        --warning-color: #f59e0b;
        --error-color: #ef4444;
        --info-color: #3b82f6;
        --bg-primary: #ffffff;
        --bg-secondary: #f8f9fa;
        --bg-sidebar: #e8f5e8;
        --text-primary: #333333;
        --text-secondary: #666666;
        --border-color: #e0e0e0;
        --hover-bg: rgba(34, 197, 94, 0.1);
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 8px 25px rgba(34, 197, 94, 0.15);
        --gradient-primary: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
        --gradient-bg: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
        --card-bg: #ffffff;
        --modal-bg: rgba(0, 0, 0, 0.5);
    }

    .dark-mode {
        --bg-primary: #1a1a1a;
        --bg-secondary: #2d2d2d;
        --bg-sidebar: #1f2937;
        --text-primary: #ffffff;
        --text-secondary: #cccccc;
        --border-color: #404040;
        --hover-bg: rgba(34, 197, 94, 0.2);
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        --card-bg: #374151;
        --gradient-bg: linear-gradient(135deg, #1f2937 0%, #374151 50%, #4b5563 100%);
    }

    /* Reset & Base Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: var(--gradient-bg);
        color: var(--text-primary);
        transition: all 0.3s ease;
        overflow-x: hidden;
    }

    /* Dashboard Container */
    .dashboard-container {
        display: flex;
        height: 100vh;
    }

    /* Sidebar Styles */
    .sidebar {
        width: 280px;
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: fixed;
        height: 100vh;
        z-index: 1000;
        box-shadow: var(--shadow);
        overflow-y: auto;
    }

    .sidebar.collapsed {
        width: 70px;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 12px;
        flex-shrink: 0;
    }

    .logo {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--gradient-primary);
        color: white;
        font-size: 24px;
        box-shadow: var(--shadow);
        animation: pulse 2s infinite;
        flex-shrink: 0;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .company-info {
        flex: 1;
        transition: opacity 0.3s ease;
        overflow: hidden;
    }

    .company-name {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 2px;
        white-space: nowrap;
    }

    .company-tagline {
        font-size: 11px;
        color: var(--primary-green);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .sidebar.collapsed .company-info {
        opacity: 0;
        width: 0;
    }

    /* Sidebar Navigation */
    .sidebar-nav {
        flex: 1;
        padding: 20px 0;
        overflow-y: auto;
    }

    .nav-section {
        margin-bottom: 30px;
    }

    .nav-section-title {
        padding: 0 20px 10px;
        font-size: 11px;
        font-weight: 700;
        color: var(--primary-green);
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: opacity 0.3s ease;
    }

    .sidebar.collapsed .nav-section-title {
        opacity: 0;
        height: 0;
        margin: 0;
        padding: 0;
    }

    .nav-menu {
        list-style: none;
    }

    .nav-item {
        margin-bottom: 4px;
    }

    .nav-link {
        display: flex;
        align-items: center;
        padding: 14px 20px;
        color: var(--text-primary);
        text-decoration: none;
        border-radius: 0 25px 25px 0;
        margin-right: 20px;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .nav-link::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.1), transparent);
        transition: left 0.5s ease;
    }

    .nav-link:hover::before {
        left: 100%;
    }

    .nav-link i {
        width: 22px;
        margin-right: 14px;
        font-size: 18px;
        flex-shrink: 0;
    }

    .nav-link span {
        transition: opacity 0.3s ease;
        white-space: nowrap;
        font-weight: 500;
    }

    .sidebar.collapsed .nav-link span {
        opacity: 0;
    }

    .sidebar.collapsed .nav-link {
        margin-right: 0;
        border-radius: 0;
        justify-content: center;
    }

    .nav-link:hover {
        background: var(--hover-bg);
        color: var(--primary-green);
        transform: translateX(5px);
    }

    .nav-item.active .nav-link {
        background: var(--gradient-primary);
        color: white;
        box-shadow: var(--shadow);
    }

    .nav-item.active .nav-link:hover {
        background: var(--gradient-primary);
        color: white;
    }

    /* Main Content Area */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-left: 280px;
        transition: margin-left 0.3s ease;
    }

    .main-content.sidebar-collapsed {
        margin-left: 70px;
    }

    /* Header */
    .header {
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        padding: 0 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 80px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        flex-shrink: 0;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 24px;
    }

    .sidebar-toggle {
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: 20px;
        cursor: pointer;
        padding: 12px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .sidebar-toggle:hover {
        background: var(--hover-bg);
        color: var(--primary-green);
        transform: scale(1.1);
    }

    .greeting-section {
        display: flex;
        flex-direction: column;
    }

    .greeting-text {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 2px;
    }

    .current-date {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Search Container */
    .search-container {
        position: relative;
        width: 400px;
    }

    .search-input {
        width: 100%;
        padding: 12px 50px 12px 20px;
        border: 2px solid var(--border-color);
        border-radius: 25px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 15px;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
    }

    .search-icon {
        position: absolute;
        right: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 18px;
    }

    /* Header Right */
    .header-right {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .theme-toggle {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        color: var(--text-primary);
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .theme-toggle:hover {
        background: var(--hover-bg);
        border-color: var(--primary-green);
        transform: translateY(-2px);
    }

    .notification-btn {
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: 20px;
        cursor: pointer;
        position: relative;
        padding: 12px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .notification-btn:hover {
        background: var(--hover-bg);
        color: var(--primary-green);
    }

    .notification-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: var(--error-color);
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        animation: bounce 1s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-5px); }
        60% { transform: translateY(-3px); }
    }

    .profile-section {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .profile-section:hover {
        background: var(--hover-bg);
    }

    .profile-avatar {
        width: 45px;
        height: 45px;
        background: var(--gradient-primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 16px;
        transition: all 0.3s ease;
        box-shadow: var(--shadow);
    }

    .profile-info {
        display: flex;
        flex-direction: column;
    }

    .profile-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .profile-role {
        font-size: 12px;
        color: var(--primary-green);
        font-weight: 500;
        text-transform: capitalize;
    }

    .logout-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: 20px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s ease;
        margin-left: 12px;
    }

    .logout-btn:hover {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
        transform: scale(1.1);
    }

    /* Content Area */
    .content {
        flex: 1;
        padding: 32px;
        background: var(--bg-secondary);
        overflow-y: auto;
        min-height: calc(100vh - 80px);
    }

    /* Content Sections */
    .content-section {
        display: none;
    }

    .content-section.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Section Header */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .section-header-left {
        flex: 1;
    }

    .section-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .section-subtitle {
        font-size: 16px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .section-header-right {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    /* Welcome Banner */
    .welcome-banner {
        background: var(--gradient-primary);
        border-radius: 16px;
        padding: 40px;
        margin-bottom: 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow-lg);
        color: white;
        flex-wrap: wrap;
        gap: 24px;
    }

    .welcome-content {
        flex: 1;
    }

    .welcome-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .welcome-subtitle {
        font-size: 18px;
        opacity: 0.9;
    }

    .welcome-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    /* Stat Cards */
    .stat-card {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        margin-bottom: 16px;
    }

    .stat-icon.farms { background: linear-gradient(135deg, #22c55e, #16a34a); }
    .stat-icon.productions { background: linear-gradient(135deg, #10b981, #047857); }
    .stat-icon.inventory { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .stat-icon.alerts { background: linear-gradient(135deg, #f59e0b, #d97706); }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .stat-sublabel {
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Mini Stat Cards */
    .stats-mini-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-mini-card {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.3s ease;
    }

    .stat-mini-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }

    .stat-mini-card.alert {
        border-left: 4px solid var(--error-color);
    }

    .stat-mini-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        background: var(--hover-bg);
        color: var(--primary-green);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .stat-mini-content {
        flex: 1;
    }

    .stat-mini-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .stat-mini-label {
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    /* Charts Section */
    .charts-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    .chart-card {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .chart-filter {
        padding: 8px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chart-filter:focus {
        outline: none;
        border-color: var(--primary-green);
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    /* Dashboard Info Grid */
    .dashboard-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
    }

    .info-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .info-card-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .info-card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .info-card-content {
        padding: 24px;
        max-height: 400px;
        overflow-y: auto;
    }

    /* Task List */
    .task-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .task-item {
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        border-left: 4px solid var(--primary-green);
        transition: all 0.3s ease;
    }

    .task-item:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow);
    }

    .task-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .task-details {
        display: flex;
        gap: 16px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    /* Activity List */
    .activity-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .activity-item {
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        display: flex;
        gap: 16px;
        transition: all 0.3s ease;
    }

    .activity-item:hover {
        box-shadow: var(--shadow);
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--hover-bg);
        color: var(--primary-green);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .activity-content {
        flex: 1;
    }

    .activity-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .activity-time {
        font-size: 12px;
        color: var(--text-secondary);
    }

    /* Alerts Section */
    .alerts-section {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 32px;
    }

    .alerts-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .alerts-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alerts-view-all {
        color: var(--primary-green);
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .alerts-view-all:hover {
        text-decoration: underline;
    }

    .alerts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;
    }

    .alert-card {
        padding: 16px;
        border-radius: 10px;
        border-left: 4px solid;
        background: var(--bg-secondary);
        transition: all 0.3s ease;
    }

    .alert-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
    }

    .alert-card.critical { border-left-color: var(--error-color); }
    .alert-card.high { border-left-color: var(--warning-color); }
    .alert-card.medium { border-left-color: var(--info-color); }
    .alert-card.low { border-left-color: var(--primary-green); }

    .alert-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .alert-level {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .alert-level.critical {
        background: var(--error-color);
        color: white;
    }

    .alert-level.high {
        background: var(--warning-color);
        color: white;
    }

    .alert-title {
        font-size: 15px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .alert-description {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5;
    }

    /* Weather Widget */
    .weather-widget {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 32px;
    }

    .weather-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .weather-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .weather-location {
        font-size: 14px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .weather-content {
        display: flex;
        gap: 32px;
        align-items: center;
    }

    .weather-current {
        flex: 1;
    }

    .weather-temp {
        font-size: 48px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .weather-condition {
        font-size: 18px;
        color: var(--text-secondary);
    }

    .weather-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        flex: 2;
    }

    .weather-detail {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .weather-detail i {
        font-size: 24px;
        color: var(--primary-green);
    }

    .weather-detail span {
        font-size: 13px;
        color: var(--text-secondary);
        display: block;
    }

    .weather-detail strong {
        font-size: 18px;
        color: var(--text-primary);
        font-weight: 600;
        display: block;
    }

    /* Weather Current Card (for weather section) */
    .weather-current-card {
        background: var(--gradient-primary);
        color: white;
        padding: 40px;
        border-radius: 16px;
        margin-bottom: 32px;
        box-shadow: var(--shadow-lg);
    }

    .weather-main {
        margin-bottom: 32px;
    }

    .weather-temp-large {
        font-size: 72px;
        font-weight: 700;
        margin-bottom: 12px;
    }

    .weather-condition-large {
        font-size: 24px;
        opacity: 0.9;
        margin-bottom: 16px;
    }

    .weather-location-large {
        font-size: 16px;
        opacity: 0.8;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .weather-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .weather-detail-card {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .weather-detail-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .weather-detail-content {
        flex: 1;
    }

    .weather-detail-label {
        font-size: 13px;
        opacity: 0.8;
        margin-bottom: 4px;
    }

    .weather-detail-value {
        font-size: 20px;
        font-weight: 700;
    }

    /* Filter Section */
    .filter-section {
        background: var(--card-bg);
        padding: 24px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
    }

    .search-box {
        position: relative;
        margin-bottom: 16px;
    }

    .search-box i {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-secondary);
        font-size: 16px;
    }

    .search-box input {
        width: 100%;
        padding: 12px 20px 12px 50px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 15px;
        transition: all 0.3s ease;
    }

    .search-box input:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
    }

    .filter-controls {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .filter-select {
        padding: 10px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
        min-width: 150px;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary-green);
    }

    /* Buttons */
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

    .btn i {
        font-size: 16px;
    }

    .btn-primary {
        background: var(--gradient-primary);
        color: white;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 2px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--hover-bg);
        border-color: var(--primary-green);
        color: var(--primary-green);
    }

    .btn-info {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 13px;
    }

    /* Farms Grid */
    .farms-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .farm-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .farm-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .farm-card-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .farm-card-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .farm-card-location {
        font-size: 14px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .farm-card-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .farm-card-badge.active {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .farm-card-body {
        padding: 20px;
    }

    .farm-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 16px;
    }

    .farm-info-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .farm-info-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .farm-info-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .farm-card-footer {
        padding: 16px 20px;
        background: var(--bg-secondary);
        display: flex;
        gap: 8px;
    }

    .farm-action-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .farm-action-btn.view {
        background: rgba(34, 197, 94, 0.1);
        color: var(--primary-green);
    }

    .farm-action-btn.view:hover {
        background: var(--primary-green);
        color: white;
    }

    .farm-action-btn.edit {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .farm-action-btn.edit:hover {
        background: #3b82f6;
        color: white;
    }

    .farm-action-btn.delete {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .farm-action-btn.delete:hover {
        background: #ef4444;
        color: white;
    }







/* Crops Grid - IMPROVED DESIGN */
.crops-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 28px;
    margin-bottom: 32px;
}

.crop-card {
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 2px solid transparent;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.crop-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, #22c55e, #10b981, #059669);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.crop-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.3);
}

.crop-card:hover::before {
    opacity: 1;
}

.crop-card-header {
    padding: 32px 24px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
    text-align: center;
    position: relative;
}

.crop-icon {
    font-size: 64px;
    margin-bottom: 16px;
    filter: drop-shadow(0 4px 12px rgba(34, 197, 94, 0.2));
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-8px); }
}

.crop-name {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 12px;
    line-height: 1.3;
}

.crop-category {
    padding: 8px 16px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border-radius: 24px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-block;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.crop-card-body {
    padding: 24px;
    display: flex;
    flex-direction: column;
    justify-content: center; /* Centers content vertically */
    min-height: 300px; /* Ensures enough space */
}

.crop-info-list {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.crop-info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 16px;
    background: var(--bg-secondary);
    border-radius: 12px;
    border-left: 3px solid #22c55e;
    transition: all 0.3s ease;
}

.crop-info-item:hover {
    background: rgba(34, 197, 94, 0.08);
    transform: translateX(4px);
}

.crop-info-label {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.crop-info-label::before {
    content: '‚Ä¢';
    color: #22c55e;
    font-weight: bold;
    font-size: 18px;
}

.crop-info-value {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    background: rgba(34, 197, 94, 0.1);
    padding: 4px 12px;
    border-radius: 8px;
}

/* Crop Card Footer - View Details Button */
.crop-card-body .btn {
    width: 100%;
    margin-top: 20px;
    padding: 14px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.crop-card-body .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    background: linear-gradient(135deg, #16a34a, #15803d);
}

.crop-card-body .btn i {
    font-size: 16px;
}

    /* Production Timeline */
    .production-timeline {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .production-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .production-card:hover {
        box-shadow: var(--shadow-lg);
    }

    .production-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .production-title-section {
        flex: 1;
    }

    .production-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .production-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .production-status {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .production-status.planned {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .production-status.planted {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .production-status.growing {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .production-status.harvested {
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
    }

    .production-status.sold {
        background: rgba(6, 182, 212, 0.1);
        color: #06b6d4;
    }

    .production-body {
        padding: 20px;
    }

    .production-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .production-info-item {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .production-info-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: var(--hover-bg);
        color: var(--primary-green);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .production-info-content {
        flex: 1;
    }

    .production-info-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
    }

    .production-info-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .production-footer {
        padding: 16px 20px;
        background: var(--bg-secondary);
        display: flex;
        gap: 8px;
    }










/* ============================================================================
   IMPROVED INVENTORY CARD DESIGN - PROFESSIONAL & MODERN
   ============================================================================ */

.inventory-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 28px;
    margin-bottom: 32px;
}

.inventory-card {
    background: var(--card-bg);
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 2px solid transparent;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.inventory-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, #22c55e, #10b981, #059669);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.inventory-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.3);
}

.inventory-card:hover::before {
    opacity: 1;
}

.inventory-header {
    padding: 28px 24px 20px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
    border-bottom: 2px solid rgba(34, 197, 94, 0.1);
    position: relative;
}

.inventory-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.inventory-title::before {
    content: 'üì¶';
    font-size: 28px;
    filter: drop-shadow(0 2px 4px rgba(34, 197, 94, 0.2));
}

.inventory-badges {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 12px;
}

.inventory-badge {
    padding: 8px 16px;
    border-radius: 24px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.inventory-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.inventory-badge.available {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.inventory-badge.reserved {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.inventory-badge.sold {
    background: linear-gradient(135deg, #8b5cf6, #6d28d9);
    color: white;
}

.inventory-badge.expired {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.inventory-body {
    padding: 24px;
}

.inventory-info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 20px;
}

.inventory-info-item {
    padding: 14px 16px;
    background: var(--bg-secondary);
    border-radius: 12px;
    border-left: 3px solid #22c55e;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.inventory-info-item:hover {
    background: rgba(34, 197, 94, 0.08);
    transform: translateX(4px);
}

.inventory-info-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.inventory-info-label::before {
    content: '‚Ä¢';
    color: #22c55e;
    font-weight: bold;
    font-size: 16px;
}

.inventory-info-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
}







.quality-badge {
    display: inline-block;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.quality-badge.quality-excellent {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
}

.quality-badge.quality-good {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.quality-badge.quality-fair {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.quality-badge.quality-poor {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.inventory-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid var(--border-color);
}

.inventory-actions .btn {
    flex: 1;
    padding: 12px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.inventory-actions .btn-secondary {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
    border: 2px solid rgba(59, 130, 246, 0.2);
}

.inventory-actions .btn-secondary:hover {
    background: #3b82f6;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.inventory-actions .btn-primary {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.inventory-actions .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .inventory-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .inventory-info-grid {
        grid-template-columns: 1fr;
    }

    .inventory-actions {
        flex-direction: column;
    }
}
    /* Table Section */
    .table-section {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        margin-bottom: 32px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    .data-table th {
        background: var(--bg-secondary);
        font-weight: 600;
        color: var(--text-primary);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .data-table td {
        color: var(--text-primary);
        font-size: 14px;
    }

    .data-table tr:hover {
        background: var(--hover-bg);
    }

    .data-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Action Buttons in Tables */
    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .action-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .action-btn-view {
        background: rgba(34, 197, 94, 0.1);
        color: var(--primary-green);
    }

    .action-btn-view:hover {
        background: var(--primary-green);
        color: white;
    }

    .action-btn-edit {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .action-btn-edit:hover {
        background: #3b82f6;
        color: white;
    }

    .action-btn-delete {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .action-btn-delete:hover {
        background: #ef4444;
        color: white;
    }

/* ============================================================================
   IMPROVED SOIL DATA CARD DESIGN - COMPACT & SYSTEM COLORS
   ============================================================================ */

.soil-data-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.soil-card,
.soil-data-card {
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    border: 2px solid transparent;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.soil-card::before,
.soil-data-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #22c55e, #10b981, #059669);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.soil-card:hover,
.soil-data-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 8px 24px rgba(34, 197, 94, 0.2);
    border-color: rgba(34, 197, 94, 0.3);
}

.soil-card:hover::before,
.soil-data-card:hover::before {
    opacity: 1;
}

.soil-card-header,
.soil-header {
    padding: 20px 20px 16px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
    border-bottom: 1px solid rgba(34, 197, 94, 0.1);
}

.soil-header-left {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.soil-card-title,
.soil-farm-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    line-height: 1.3;
}

.soil-farm-name i {
    color: #22c55e;
    font-size: 18px;
}

.soil-card-subtitle,
.soil-sample-code {
    font-size: 12px;
    color: #16a34a;
    font-weight: 600;
    background: rgba(34, 197, 94, 0.1);
    padding: 4px 10px;
    border-radius: 12px;
    display: inline-block;
    letter-spacing: 0.3px;
}

.soil-date {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: 500;
}

.soil-date i {
    color: #22c55e;
    font-size: 11px;
}

.soil-metrics,
.soil-card-body {
    padding: 20px;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.soil-metric {
    padding: 12px 14px;
    background: var(--bg-secondary);
    border-radius: 10px;
    border-left: 3px solid #22c55e;
    transition: all 0.3s ease;
}

.soil-metric:hover {
    background: rgba(34, 197, 94, 0.08);
    transform: translateX(4px);
}

.soil-metric-label {
    font-size: 11px;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
    letter-spacing: 0.3px;
}

.soil-metric-label::before {
    content: '‚óè';
    color: #22c55e;
    font-size: 10px;
}

.soil-metric-label i {
    font-size: 11px;
    color: #22c55e;
}

.soil-metric-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    display: block;
    line-height: 1.2;
}

/* pH Level Status Colors - System Green Theme */
.soil-metric-value.ph-optimal {
    color: #22c55e;
}

.soil-metric-value.ph-acidic {
    color: #ef4444;
}

.soil-metric-value.ph-alkaline {
    color: #f59e0b;
}

/* NPK Level Indicators - System Green Theme */
.soil-metric.npk-high {
    border-left-color: #22c55e;
}

.soil-metric.npk-high .soil-metric-value {
    color: #22c55e;
}

.soil-metric.npk-medium {
    border-left-color: #f59e0b;
}

.soil-metric.npk-medium .soil-metric-value {
    color: #f59e0b;
}

.soil-metric.npk-low {
    border-left-color: #ef4444;
}

.soil-metric.npk-low .soil-metric-value {
    color: #ef4444;
}

/* Primary pH Metric - Full Width */
.soil-metric.ph-primary {
    grid-column: 1 / -1;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
    border-left-width: 4px;
    padding: 14px 16px;
}

.soil-metric.ph-primary .soil-metric-label {
    font-size: 12px;
    margin-bottom: 8px;
}

.soil-metric.ph-primary .soil-metric-value {
    font-size: 20px;
}

.soil-metric.ph-primary .ph-status-label {
    color: var(--text-secondary);
    font-size: 11px;
    font-weight: 600;
    margin-top: 4px;
    display: block;
}

/* Recommendations Section - Compact */
.soil-recommendations,
.soil-notes {
    margin: 0 20px 16px;
    padding: 14px;
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border-left: 4px solid #f59e0b;
    border-radius: 10px;
}

.soil-recommendations h4,
.soil-notes h4 {
    margin: 0 0 8px 0;
    color: #92400e;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 700;
}

.soil-recommendations h4 i,
.soil-notes h4 i {
    font-size: 14px;
    color: #f59e0b;
}

.soil-recommendations p,
.soil-notes p {
    margin: 0;
    line-height: 1.5;
    color: #78350f;
    font-size: 12px;
    font-weight: 500;
}

/* Footer Section - Compact */
.soil-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 20px;
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    gap: 12px;
    flex-wrap: wrap;
}

.soil-meta {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
}

.soil-meta-item {
    font-size: 11px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: 500;
}

.soil-meta-item i {
    color: #22c55e;
    font-size: 11px;
}

.soil-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.soil-actions .btn {
    padding: 8px 14px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 12px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.soil-actions .btn i {
    font-size: 12px;
}

.soil-actions .btn-secondary {
    background: rgba(34, 197, 94, 0.1);
    color: #16a34a;
    border: 1px solid rgba(34, 197, 94, 0.2);
}

.soil-actions .btn-secondary:hover {
    background: #22c55e;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.soil-actions .btn-primary {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border: none;
}

.soil-actions .btn-primary:hover {
    background: linear-gradient(135deg, #16a34a, #15803d);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

/* Responsive Design */
@media (max-width: 768px) {
    .soil-data-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .soil-metrics,
    .soil-card-body {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 16px;
    }

    .soil-card-header,
    .soil-header {
        padding: 16px;
    }

    .soil-footer {
        flex-direction: column;
        align-items: flex-start;
        padding: 12px 16px;
    }

    .soil-actions {
        width: 100%;
    }

    .soil-actions .btn {
        flex: 1;
        justify-content: center;
    }
}

    /* Market Prices Grid */
    .market-prices-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 24px;
    }

    .market-price-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: 24px;
        transition: all 0.3s ease;
    }

    .market-price-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .market-price-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .market-price-crop {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .market-price-trend {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .market-price-trend.increasing {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .market-price-trend.decreasing {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
    }

    .market-price-trend.stable {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
    }

    .market-price-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--primary-green);
        margin-bottom: 8px;
    }

    .market-price-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    /* Supply Chain */
    .supply-chain-legend {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-bottom: 24px;
        padding: 16px;
        background: var(--card-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .supply-chain-container {
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .supply-chain-item {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: 24px;
    }

    .supply-chain-header {
        margin-bottom: 24px;
    }

    .supply-chain-tracking-code {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .supply-chain-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .supply-chain-stages {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 16px;
    }

    .stage-card {
        min-width: 200px;
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        border-left: 4px solid;
        transition: all 0.3s ease;
    }

    .stage-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
    }

    .stage-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .stage-details {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.6;
    }

    /* Alerts List */
    .alerts-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .alert-item {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        border-left: 4px solid;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .alert-item:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow-lg);
    }

    .alert-item.critical {
        border-left-color: var(--error-color);
    }

    .alert-item.high {
        border-left-color: var(--warning-color);
    }

    .alert-item.medium {
        border-left-color: var(--info-color);
    }

    .alert-item.low {
        border-left-color: var(--primary-green);
    }

    .alert-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .alert-item-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .alert-item-message {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 12px;
    }

    .alert-item-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: var(--text-secondary);
    }

    /* Policies Grid */
    .policies-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .policy-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .policy-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .policy-header {
        padding: 20px;
        background: var(--hover-bg);
        border-bottom: 1px solid var(--border-color);
    }

    .policy-type {
        padding: 6px 12px;
        background: var(--primary-green);
        color: white;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
        margin-bottom: 12px;
    }

    .policy-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .policy-body {
        padding: 20px;
    }

    .policy-description {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 16px;
    }

    .policy-details {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .policy-detail-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        background: var(--bg-secondary);
        border-radius: 8px;
        font-size: 13px;
    }

    .policy-detail-label {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .policy-detail-value {
        color: var(--text-primary);
        font-weight: 600;
    }

    /* Recommendations Grid */
    .recommendations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .recommendation-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        padding: 24px;
        transition: all 0.3s ease;
    }

    .recommendation-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .recommendation-header {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
    }

    .recommendation-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        background: var(--gradient-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
    }

    .recommendation-title-section {
        flex: 1;
    }

    .recommendation-type {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 4px;
    }

    .recommendation-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .recommendation-priority {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .recommendation-priority.urgent {
        background: var(--error-color);
        color: white;
    }

    .recommendation-priority.high {
        background: var(--warning-color);
        color: white;
    }

    .recommendation-priority.medium {
        background: var(--info-color);
        color: white;
    }

    .recommendation-priority.low {
        background: var(--primary-green);
        color: white;
    }

    .recommendation-description {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 16px;
    }

    .recommendation-details {
        padding: 16px;
        background: var(--bg-secondary);
        border-radius: 10px;
        font-size: 13px;
        color: var(--text-primary);
    }

    .recommendation-footer {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .recommendation-confidence {
        font-size: 12px;
        color: var(--text-secondary);
    }

    .recommendation-confidence strong {
        color: var(--primary-green);
        font-weight: 700;
    }

    /* Predictions Grid */
    .predictions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
    }

    .prediction-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .prediction-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .prediction-header {
        padding: 20px;
        background: var(--gradient-primary);
        color: white;
    }

    .prediction-crop {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .prediction-season {
        font-size: 14px;
        opacity: 0.9;
    }

    .prediction-body {
        padding: 24px;
    }

    .prediction-yield {
        text-align: center;
        margin-bottom: 24px;
    }

    .prediction-yield-label {
        font-size: 13px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .prediction-yield-value {
        font-size: 48px;
        font-weight: 700;
        color: var(--primary-green);
    }

    .prediction-yield-unit {
        font-size: 16px;
        color: var(--text-secondary);
    }

    .prediction-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .prediction-metric {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 10px;
        text-align: center;
    }

    .prediction-metric-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }

    .prediction-metric-value {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
    }

    /* Report Configuration */
    .report-config-card {
        background: var(--card-bg);
        padding: 32px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        margin-bottom: 32px;
    }

    .report-config-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 24px;
    }

    .report-config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .form-input,
    .form-select {
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
    }

    .report-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

/* Report Preview - PROFESSIONAL & MATURE DESIGN */
.report-preview-card {
  background: var(--card-bg);
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  border: 1px solid #e5e7eb;
  overflow: hidden;
  margin-top: 32px;
}

.report-preview-header {
  padding: 20px 28px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f9fafb;
}

.report-preview-title {
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
  display: flex;
  align-items: center;
  gap: 10px;
}

.report-preview-title::before {
  content: 'üìã';
  font-size: 20px;
}

.report-preview-content {
  padding: 40px;
  max-height: 600px;
  overflow-y: auto;
  background: #ffffff;
}

/* Report Document Styling */
.report-document {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  color: #1f2937;
  line-height: 1.6;
}

.report-header {
  border-bottom: 2px solid #e5e7eb;
  padding-bottom: 20px;
  margin-bottom: 28px;
  background: #ffffff;
  padding: 24px;
  border-radius: 0;
}

.report-header h1 {
  font-size: 24px;
  font-weight: 600;
  color: #111827;
  margin: 0 0 12px 0;
  display: flex;
  align-items: center;
  gap: 10px;
  letter-spacing: -0.5px;
}

.report-header h1::before {
  content: '';
  display: none;
}

.report-meta {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 10px;
  margin-top: 16px;
  padding: 16px;
  background: #f9fafb;
  border-radius: 6px;
  border-left: 3px solid #6b7280;
}

.report-meta p {
  margin: 0;
  font-size: 13px;
  color: #6b7280;
  display: flex;
  align-items: center;
  gap: 6px;
  line-height: 1.5;
}

.report-meta strong {
  color: #374151;
  font-weight: 600;
  min-width: 90px;
}

.report-section {
  margin-bottom: 32px;
  padding: 24px;
  background: #ffffff;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
  box-shadow: none;
  transition: none;
}

.report-section:hover {
  box-shadow: none;
  border-color: #e5e7eb;
}

.report-section h2 {
  font-size: 18px;
  font-weight: 600;
  color: #111827;
  margin: 0 0 16px 0;
  padding-bottom: 10px;
  border-bottom: 2px solid #e5e7eb;
  display: flex;
  align-items: center;
  gap: 8px;
  letter-spacing: -0.3px;
}

.report-section h2::before {
  content: '';
  display: none;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-top: 16px;
}

.summary-item {
  padding: 16px;
  background: #f9fafb;
  border-radius: 6px;
  border-left: 3px solid #6b7280;
  transition: none;
}

.summary-item:hover {
  transform: none;
  box-shadow: none;
}

.summary-item label {
  display: block;
  font-size: 12px;
  color: #6b7280;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  margin-bottom: 6px;
}

.summary-item value {
  display: block;
  font-size: 20px;
  font-weight: 600;
  color: #111827;
}

.report-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 16px;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.report-table thead {
  background: #f3f4f6;
}

.report-table th {
  padding: 12px 14px;
  text-align: left;
  font-size: 12px;
  font-weight: 600;
  color: #374151;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  border-bottom: 2px solid #e5e7eb;
}

.report-table tbody tr:hover {
  background: #f9fafb;
  transform: none;
}

.report-table tbody tr:nth-child(even) {
  background: #f9fafb;
}

.report-table tbody tr:hover {
  background: #f0fdf4;
  transform: scale(1.01);
}

.report-table td {
  padding: 14px 16px;
  font-size: 14px;
  color: #374151;
  border-bottom: 1px solid #e5e7eb;
}

.distribution-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  margin-top: 16px;
}

.distribution-item {
  padding: 12px 16px;
  background: #f9fafb;
  border-radius: 6px;
  border-left: 3px solid #6b7280;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: none;
}

.distribution-item:hover {
  transform: none;
  box-shadow: none;
}

.distribution-label {
  font-weight: 500;
  color: #6b7280;
  font-size: 13px;
}

.distribution-value {
  font-weight: 600;
  color: #111827;
  font-size: 14px;
}

/* Scrollbar Styling for Report */
.report-preview-content::-webkit-scrollbar {
  width: 10px;
}

.report-preview-content::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 10px;
}

.report-preview-content::-webkit-scrollbar-thumb {
  background: #22c55e;
  border-radius: 10px;
}

.report-preview-content::-webkit-scrollbar-thumb:hover {
  background: #16a34a;
}

    /* Status Badges */
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        display: inline-block;
    }

    .status-active {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .status-inactive {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error-color);
    }

    .status-pending {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .status-completed {
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: var(--modal-bg);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 32px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(50px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: var(--hover-bg);
        color: var(--primary-green);
    }

    .modal-body {
        margin-bottom: 24px;
    }

    .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    /* Loading Overlay */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }

    .loading-overlay.show {
        display: flex;
    }

    .loader {
        border: 8px solid rgba(255, 255, 255, 0.2);
        border-top: 8px solid var(--primary-green);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .toast {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 16px 20px;
        box-shadow: var(--shadow-lg);
        border-left: 4px solid;
        animation: slideInRight 0.3s ease;
        max-width: 400px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toast.success { border-left-color: var(--success-color); }
    .toast.error { border-left-color: var(--error-color); }
    .toast.warning { border-left-color: var(--warning-color); }
    .toast.info { border-left-color: var(--info-color); }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .toast-icon {
        font-size: 20px;
    }

    .toast.success .toast-icon { color: var(--success-color); }
    .toast.error .toast-icon { color: var(--error-color); }
    .toast.warning .toast-icon { color: var(--warning-color); }
    .toast.info .toast-icon { color: var(--info-color); }

    .toast-message {
        color: var(--text-primary);
        font-weight: 500;
        font-size: 14px;
        flex: 1;
    }

    .toast-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 4px;
        font-size: 18px;
        transition: all 0.3s ease;
    }

    .toast-close:hover {
        color: var(--text-primary);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-state p {
        font-size: 18px;
        margin-top: 12px;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--primary-green);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }

    /* Responsive Design */
    @media (max-width: 1400px) {
        .charts-section {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 1200px) {
        .dashboard-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .farms-grid,
        .crops-grid,
        .inventory-grid,
        .market-prices-grid,
        .policies-grid,
        .recommendations-grid,
        .predictions-grid {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
    }

    @media (max-width: 992px) {
        .header {
            padding: 0 20px;
        }

        .search-container {
            width: 250px;
        }

        .greeting-text {
            font-size: 20px;
        }

        .content {
            padding: 24px 20px;
        }

        .section-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .section-header-right {
            width: 100%;
        }

        .welcome-banner {
            padding: 32px 24px;
        }

        .welcome-title {
            font-size: 28px;
        }

        .dashboard-info-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .sidebar {
            transform: translateX(-100%);
            width: 280px;
        }

        .sidebar.mobile-open {
            transform: translateX(0);
        }

        .main-content {
            margin-left: 0;
        }

        .header {
            height: auto;
            padding: 16px;
            flex-direction: column;
            gap: 16px;
        }

        .header-left {
            width: 100%;
            justify-content: space-between;
        }

        .search-container {
            width: 100%;
            order: 3;
        }

        .header-right {
            width: 100%;
            justify-content: space-between;
        }

        .greeting-section {
            flex: 1;
        }

        .greeting-text {
            font-size: 18px;
        }

        .current-date {
            font-size: 12px;
        }

        .profile-info {
            display: none;
        }

        .content {
            padding: 20px 16px;
        }

        .section-title {
            font-size: 24px;
        }

        .welcome-banner {
            padding: 24px 20px;
            flex-direction: column;
        }

        .welcome-title {
            font-size: 24px;
        }

        .welcome-subtitle {
            font-size: 16px;
        }

        .welcome-actions {
            width: 100%;
            flex-direction: column;
        }

        .welcome-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .dashboard-grid,
        .stats-mini-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .charts-section {
            grid-template-columns: 1fr;
        }

        .chart-container {
            height: 250px;
        }

        .farms-grid,
        .crops-grid,
        .inventory-grid,
        .market-prices-grid,
        .soil-data-grid,
        .policies-grid,
        .recommendations-grid,
        .predictions-grid {
            grid-template-columns: 1fr;
        }

        .filter-section {
            padding: 16px;
        }

        .filter-controls {
            flex-direction: column;
        }

        .filter-select {
            width: 100%;
        }

        .section-header-right {
            flex-direction: column;
        }

        .section-header-right .btn {
            width: 100%;
            justify-content: center;
        }

        .weather-content {
            flex-direction: column;
        }

        .weather-details {
            grid-template-columns: repeat(2, 1fr);
        }

        .weather-current-card {
            padding: 24px 20px;
        }

        .weather-temp-large {
            font-size: 56px;
        }

        .weather-details-grid {
            grid-template-columns: 1fr;
        }

        .production-info-grid {
            grid-template-columns: 1fr;
        }

        .modal-content {
            width: 95%;
            padding: 24px 20px;
            max-height: 95vh;
        }

        .modal-title {
            font-size: 20px;
        }

        .report-config-grid {
            grid-template-columns: 1fr;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            min-width: 600px;
        }
    }

    @media (max-width: 480px) {
        .stat-value {
            font-size: 28px;
        }

        .stat-mini-value {
            font-size: 20px;
        }

        .chart-title {
            font-size: 16px;
        }

        .farm-info-grid,
        .soil-metrics,
        .prediction-metrics {
            grid-template-columns: 1fr;
        }

        .weather-details {
            grid-template-columns: 1fr;
        }

        .supply-chain-stages {
            flex-direction: column;
        }

        .stage-card {
            min-width: 100%;
        }

        .toast {
            max-width: calc(100vw - 40px);
        }

        .toast-container {
            left: 20px;
            right: 20px;
        }
    }

    /* Print Styles */
    @media print {
        .sidebar,
        .header,
        .filter-section,
        .section-header-right,
        .btn,
        .action-buttons,
        .farm-card-footer,
        .production-footer,
        .modal,
        .toast-container,
        .loading-overlay {
            display: none !important;
        }

        .main-content {
            margin-left: 0;
        }

        .content {
            padding: 0;
        }

        .card,
        .stat-card,
        .chart-card,
        .farm-card,
        .crop-card,
        .inventory-card {
            box-shadow: none;
            border: 1px solid #ddd;
            page-break-inside: avoid;
        }
    }

    /* Dark Mode Adjustments */
    .dark-mode .nav-link:hover {
        background: rgba(34, 197, 94, 0.15);
    }

    .dark-mode .data-table tr:hover {
        background: rgba(34, 197, 94, 0.1);
    }

    .dark-mode .search-input,
    .dark-mode .filter-select,
    .dark-mode .form-input,
    .dark-mode .form-select {
        background: var(--bg-primary);
    }

    .dark-mode .loader {
        border-color: rgba(255, 255, 255, 0.1);
        border-top-color: var(--primary-green);
    }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-in {
        animation: fadeInUp 0.5s ease;
    }

    /* Utility Classes */
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .text-right { text-align: right; }

    .mt-1 { margin-top: 8px; }
    .mt-2 { margin-top: 16px; }
    .mt-3 { margin-top: 24px; }
    .mt-4 { margin-top: 32px; }

    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 24px; }
    .mb-4 { margin-bottom: 32px; }

    .p-1 { padding: 8px; }
    .p-2 { padding: 16px; }
    .p-3 { padding: 24px; }
    .p-4 { padding: 32px; }

    .flex { display: flex; }
    .flex-column { flex-direction: column; }
    .flex-wrap { flex-wrap: wrap; }
    .justify-between { justify-content: space-between; }
    .justify-center { justify-content: center; }
    .items-center { align-items: center; }
    .gap-1 { gap: 8px; }
    .gap-2 { gap: 16px; }
    .gap-3 { gap: 24px; }

    .w-full { width: 100%; }
    .h-full { height: 100%; }

    .rounded { border-radius: 8px; }
    .rounded-lg { border-radius: 12px; }
    .rounded-xl { border-radius: 16px; }

    .shadow { box-shadow: var(--shadow); }
    .shadow-lg { box-shadow: var(--shadow-lg); }

    .cursor-pointer { cursor: pointer; }

    .overflow-hidden { overflow: hidden; }
    .overflow-auto { overflow: auto; }

    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-success { color: var(--success-color); }
    .text-warning { color: var(--warning-color); }
    .text-error { color: var(--error-color); }

    .bg-primary { background: var(--bg-primary); }
    .bg-secondary { background: var(--bg-secondary); }

    .font-bold { font-weight: 700; }
    .font-semibold { font-weight: 600; }
    .font-medium { font-weight: 500; }

    .text-xs { font-size: 12px; }
    .text-sm { font-size: 13px; }
    .text-base { font-size: 14px; }
    .text-lg { font-size: 16px; }
    .text-xl { font-size: 18px; }
    .text-2xl { font-size: 20px; }
    .text-3xl { font-size: 24px; }





        /* ============================================================================
   MODAL IMPROVEMENTS - RESPONSIVE & CENTERED
   ============================================================================ */

/* Modal Overlay - Am√©lioration */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(5px);
  z-index: 9999;
  overflow-y: auto;
  padding: 20px;
  animation: fadeIn 0.3s ease;
}

.modal-overlay.show {
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Modal Container - Centr√© et Responsive */
.modal-container {
  background: var(--card-bg);
  border-radius: 20px;
  width: 100%;
  max-width: 700px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  margin: auto;
  position: relative;
}

.modal-container.modal-large {
  max-width: 1000px;
}

.modal-container.modal-small {
  max-width: 500px;
}

/* Modal Header - Am√©lior√© */
.modal-header {
  padding: 24px 32px;
  border-bottom: 2px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
  border-radius: 20px 20px 0 0;
  position: sticky;
  top: 0;
  z-index: 10;
}

.modal-title {
  font-size: 22px;
  font-weight: 700;
  color: white;
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 0;
}

.modal-title i {
  font-size: 24px;
}

.modal-close {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  color: white;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  flex-shrink: 0;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: rotate(90deg);
}

/* Modal Body - Am√©lior√© */
.modal-body {
  padding: 32px 32px 0 32px; /* ‚úÖ REMOVE BOTTOM PADDING */
  max-height: calc(90vh - 180px);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}


/* Form should take available space */
.modal-body form {
  display: flex;
  flex-direction: column;
  flex: 1;
}

/* Form grid should be scrollable */
.modal-body .form-grid {
  flex: 1;
  overflow-y: auto;
  padding-right: 8px;
  padding-bottom: 20px; /* ‚úÖ ADD THIS - Creates space at bottom */
  margin-bottom: 0;
}





/* Scrollbar personnalis√© pour modal */
.modal-body::-webkit-scrollbar {
  width: 8px;
}

.modal-body::-webkit-scrollbar-track {
  background: var(--bg-secondary);
  border-radius: 10px;
}

.modal-body::-webkit-scrollbar-thumb {
  background: var(--primary-green);
  border-radius: 10px;
}

.modal-body::-webkit-scrollbar-thumb:hover {
  background: var(--primary-dark);
}

/* Modal Footer - Am√©lior√© */
.modal-footer {
  padding: 20px 32px;
  border-top: 2px solid var(--border-color);
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  background: var(--bg-secondary);
  border-radius: 0 0 20px 20px;
  position: sticky;
  bottom: 0;
  left: 0;           /* ‚úÖ ADD THIS */
  right: 0;          /* ‚úÖ ADD THIS */
  width: 100%;       /* ‚úÖ ADD THIS */
  z-index: 10;
  margin-top: 40px;
  margin-left: -32px;  /* ‚úÖ ADD THIS - Compensates for body padding */
  margin-right: -32px; /* ‚úÖ ADD THIS - Compensates for body padding */
  padding-left: 64px;  /* ‚úÖ ADD THIS - Adjusts padding back */
  padding-right: 64px; /* ‚úÖ ADD THIS - Adjusts padding back */
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
}

/* Form Grid - Responsive */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 24px;
  margin-bottom: 24px;
}

/* Form Group - Am√©lior√© */
.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group.form-group-full {
  grid-column: 1 / -1;
}

/* Form Label - Avec ic√¥nes */
.form-label {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.form-label i {
  color: var(--primary-green);
  font-size: 16px;
}

.form-label::after {
  content: '';
  display: none;
}

/* Form Input & Select - Design moderne */
.form-input,
.form-select {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid var(--border-color);
  border-radius: 12px;
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-size: 15px;
  font-weight: 500;
  transition: all 0.3s ease;
  font-family: 'Inter', sans-serif;
}

.form-input:focus,
.form-select:focus {
  outline: none;
  border-color: var(--primary-green);
  box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
  background: var(--bg-primary);
}

.form-input::placeholder {
  color: var(--text-secondary);
  opacity: 0.7;
}

.form-input:invalid:not(:placeholder-shown) {
  border-color: var(--error-color);
}

.form-input:valid:not(:placeholder-shown) {
  border-color: var(--success-color);
}

/* Form Select - Am√©lioration */
.form-select {
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2322c55e' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 16px center;
  padding-right: 40px;
}

/* Form Checkbox - Style personnalis√© */
.form-checkbox {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  user-select: none;
}

.form-checkbox input[type="checkbox"] {
  width: 20px;
  height: 20px;
  border: 2px solid var(--border-color);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  appearance: none;
  position: relative;
}

.form-checkbox input[type="checkbox"]:checked {
  background: var(--primary-green);
  border-color: var(--primary-green);
}

.form-checkbox input[type="checkbox"]:checked::after {
  content: '\f00c';
  font-family: 'Font Awesome 5 Free';
  font-weight: 900;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-size: 12px;
}

.form-checkbox span {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
}

/* Buttons dans modal - Am√©lior√© */
.modal-footer .btn {
  padding: 14px 28px;
  font-size: 15px;
  font-weight: 600;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
}

.modal-footer .btn i {
  font-size: 16px;
}

.modal-footer .btn-primary {
  background: var(--gradient-primary);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.modal-footer .btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
}

.modal-footer .btn-secondary {
  background: transparent;
  color: var(--text-primary);
  border: 2px solid var(--border-color);
}

.modal-footer .btn-secondary:hover {
  background: var(--hover-bg);
  border-color: var(--primary-green);
  color: var(--primary-green);
}

/* Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

/* Responsive Design pour Modaux */
@media (max-width: 768px) {
  .modal-overlay {
    padding: 10px;
  }

  .modal-container {
    max-width: 100%;
    max-height: 95vh;
    border-radius: 16px;
  }

  .modal-header {
    padding: 20px 24px;
    border-radius: 16px 16px 0 0;
  }

  .modal-title {
    font-size: 18px;
  }

  .modal-body {
    padding: 24px 20px;
    max-height: calc(95vh - 160px);
  }

  .modal-footer {
    padding: 16px 20px;
    flex-direction: column-reverse;
    border-radius: 0 0 16px 16px;
  }

  .modal-footer .btn {
    width: 100%;
    justify-content: center;
  }

  .form-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }

  .modal-close {
    width: 36px;
    height: 36px;
    font-size: 18px;
  }
}

@media (max-width: 480px) {
  .modal-container {
    border-radius: 12px;
  }

  .modal-header {
    padding: 16px 20px;
    border-radius: 12px 12px 0 0;
  }

  .modal-title {
    font-size: 16px;
  }

  .modal-title i {
    font-size: 20px;
  }

  .modal-body {
    padding: 20px 16px;
  }

  .modal-footer {
    padding: 12px 16px;
    border-radius: 0 0 12px 12px;
  }

  .form-input,
  .form-select {
    padding: 12px 14px;
    font-size: 14px;
  }

  .form-label {
    font-size: 13px;
  }

  .modal-footer .btn {
    padding: 12px 20px;
    font-size: 14px;
  }
}

/* Dark Mode pour Modaux */
.dark-mode .modal-overlay {
  background: rgba(0, 0, 0, 0.8);
}

.dark-mode .modal-container {
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
}

.dark-mode .form-input:focus,
.dark-mode .form-select:focus {
  background: var(--bg-primary);
}


        /* Supply Chain Styles */
.supply-chain-group {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.supply-chain-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid #f0f0f0;
}

.supply-chain-timeline {
    position: relative;
    padding-left: 40px;
}

.timeline-item {
    position: relative;
    padding-bottom: 32px;
}

.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: -28px;
    top: 40px;
    width: 2px;
    height: calc(100% - 40px);
    background: #e0e0e0;
}

.timeline-item.completed:not(:last-child)::after {
    background: #22c55e;
}

.timeline-marker {
    position: absolute;
    left: -40px;
    top: 0;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: white;
    border: 3px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1;
}

.timeline-item.completed .timeline-marker {
    border-color: #22c55e;
    background: #22c55e;
    color: white;
}

.timeline-item.active .timeline-marker {
    border-color: #3b82f6;
    background: #3b82f6;
    color: white;
}

.timeline-content {
    background: #f9fafb;
    border-radius: 8px;
    padding: 20px;
    border-left: 4px solid #e0e0e0;
}

.timeline-item.completed .timeline-content {
    border-left-color: #22c55e;
}

.timeline-item.active .timeline-content {
    border-left-color: #3b82f6;
}

.timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.timeline-header h4 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
}

.timeline-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.detail-row {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #6b7280;
}

.detail-row i {
    width: 20px;
    color: #9ca3af;
}

.detail-row.alert-warning {
    color: #d97706;
    background: #fef3c7;
    padding: 8px;
    border-radius: 4px;
}

.timeline-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid #e5e7eb;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.stat-icon.primary { background: #dbeafe; color: #3b82f6; }
.stat-icon.success { background: #dcfce7; color: #22c55e; }
.stat-icon.warning { background: #fef3c7; color: #f59e0b; }
.stat-icon.danger { background: #fee2e2; color: #ef4444; }

.stat-content {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: #1f2937;
}

.stat-content small {
    font-size: 12px;
    color: #9ca3af;
}



        .policy-full-details {
  max-height: 70vh;
  overflow-y: auto;
  padding: 10px;
}

.detail-section {
  margin-bottom: 25px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  border-left: 4px solid #3498db;
}

.detail-section h4 {
  margin: 0 0 15px 0;
  color: #2c3e50;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
}

.detail-section h4 i {
  color: #3498db;
}

.detail-section p {
  line-height: 1.8;
  color: #495057;
  margin: 0;
}

.details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 10px;
}

.detail-item {
  padding: 12px;
  background: white;
  border-radius: 6px;
  border: 1px solid #dee2e6;
}

.detail-item label {
  display: block;
  font-size: 0.875rem;
  color: #6c757d;
  margin-bottom: 5px;
  font-weight: 500;
}

.detail-item value {
  display: block;
  font-size: 1rem;
  font-weight: 600;
  color: #2c3e50;
}

.badges-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 500;
}

.badge-success {
  background: #d4edda;
  color: #155724;
}

.badge-info {
  background: #d1ecf1;
  color: #0c5460;
}

.badge i {
  font-size: 0.9rem;
}

@media (max-width: 768px) {
  .details-grid {
    grid-template-columns: 1fr;
  }

  .policy-full-details {
    max-height: 60vh;
  }
}

    </style>
</head>
<body>








<div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
</div>

<div class="toast-container" id="toastContainer"></div>

<div class="dashboard-container">
    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo" style="width: 45px; height: 45px; background: none; animation: none; box-shadow: none;">
                <img src="images/logo.jpeg" alt="AgriGuard AI Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
            </div>
            <div class="company-info">
                <div class="company-name">AgriGuard AI</div>
                <div class="company-tagline">Smart Farming</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">Main</h3>
                <ul class="nav-menu">
                    <li class="nav-item active">
                        <a class="nav-link" data-section="dashboard">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="farms">
                            <i class="fas fa-map-marked-alt"></i>
                            <span>My Farms</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="crops">
                            <i class="fas fa-seedling"></i>
                            <span>Crop Catalog</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="production">
                            <i class="fas fa-tractor"></i>
                            <span>Productions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="inventory">
                            <i class="fas fa-warehouse"></i>
                            <span>Inventory</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Resources</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="fertilizer">
                            <i class="fas fa-flask"></i>
                            <span>Fertilizer Usage</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="irrigation">
                            <i class="fas fa-tint"></i>
                            <span>Irrigation Data</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="soil">
                            <i class="fas fa-mountain"></i>
                            <span>Soil Data</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Market</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="market-prices">
                            <i class="fas fa-chart-line"></i>
                            <span>Market Prices</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="transactions">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Transactions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="supply-chain">
                            <i class="fas fa-truck"></i>
                            <span>Supply Chain</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Information</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="weather">
                            <i class="fas fa-cloud-sun"></i>
                            <span>Weather Data</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="alerts">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Security Alerts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="policies">
                            <i class="fas fa-gavel"></i>
                            <span>Policies & Subsidies</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="recommendations">
                            <i class="fas fa-lightbulb"></i>
                            <span>AI Recommendations</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Analytics</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="predictions">
                            <i class="fas fa-chart-area"></i>
                            <span>Production Predictions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="reports">
                            <i class="fas fa-file-alt"></i>
                            <span>Reports</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="main-content" id="mainContent">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="greeting-section">
                    <div class="greeting-text" id="greetingText">Good Morning, Farmer!</div>
                    <div class="current-date" id="currentDate"></div>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search..." id="globalSearch">
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="header-right">
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                    <span>Dark Mode</span>
                </button>
                <button class="notification-btn" id="notificationBtn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationCount">0</span>
                </button>
                <div class="profile-section" id="profileSection">
                    <div class="profile-avatar" id="profileAvatar">F</div>
                    <div class="profile-info">
                        <div class="profile-name" id="profileName">Farmer Name</div>
                        <div class="profile-role">Farmer</div>
                    </div>
                    <button class="logout-btn" id="logoutBtn" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Sections -->
        <main class="content">
            <!-- Dashboard Home Section -->
            <div id="dashboardSection" class="content-section active">
                <div class="welcome-banner">
                    <div class="welcome-content">
                        <h1 class="welcome-title">Welcome to Your Dashboard</h1>
                        <p class="welcome-subtitle">Manage your farms, track production, and grow smarter</p>
                    </div>
                    <div class="welcome-actions">
                        <button class="btn btn-primary" data-action="add-farm">
                            <i class="fas fa-plus"></i>
                            Add New Farm
                        </button>
                        <button class="btn btn-primary" data-action="add-production">
                            <i class="fas fa-plus"></i>
                            Start Production
                        </button>
                    </div>
                </div>

                <!-- Quick Statistics -->
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon farms">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div class="stat-value" id="dashTotalFarms">0</div>
                        <div class="stat-label">Total Farms</div>
                        <div class="stat-sublabel" id="dashTotalArea">0 hectares</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon productions">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-value" id="dashActiveProductions">0</div>
                        <div class="stat-label">Active Productions</div>
                        <div class="stat-sublabel" id="dashTotalProductions">0 total</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon inventory">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <div class="stat-value" id="dashInventoryValue">RWF 0</div>
                        <div class="stat-label">Inventory Value</div>
                        <div class="stat-sublabel" id="dashInventoryItems">0 items</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon alerts">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-value" id="dashCriticalAlerts">0</div>
                        <div class="stat-label">Critical Alerts</div>
                        <div class="stat-sublabel" id="dashTotalAlerts">0 total alerts</div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Production Trends (Last 6 Months)</h3>
                            <select class="chart-filter" id="productionTrendFilter">
                                <option value="all">All Crops</option>
                                <option value="cereals">Cereals</option>
                                <option value="vegetables">Vegetables</option>
                                <option value="fruits">Fruits</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="productionTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Cost Breakdown</h3>
                            <select class="chart-filter" id="costBreakdownFilter">
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="costBreakdownChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Upcoming Tasks and Recent Activities -->
                <div class="dashboard-info-grid">
                    <div class="info-card">
                        <div class="info-card-header">
                            <h3 class="info-card-title">
                                <i class="fas fa-tasks"></i>
                                Upcoming Tasks
                            </h3>
                            <button class="btn btn-secondary btn-sm" data-action="refresh-tasks">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="info-card-content">
                            <div class="task-list" id="upcomingTasksList">
                                <div class="empty-state">
                                    <i class="fas fa-tasks"></i>
                                    <p>Loading upcoming tasks...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-card-header">
                            <h3 class="info-card-title">
                                <i class="fas fa-history"></i>
                                Recent Activities
                            </h3>
                            <button class="btn btn-secondary btn-sm" data-action="refresh-activities">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="info-card-content">
                            <div class="activity-list" id="recentActivitiesList">
                                <div class="empty-state">
                                    <i class="fas fa-history"></i>
                                    <p>Loading recent activities...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Critical Alerts Section -->
                <div class="alerts-section">
                    <div class="alerts-header">
                        <h3 class="alerts-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Critical Alerts
                        </h3>
                        <a href="#" class="alerts-view-all" data-section="alerts">View All Alerts</a>
                    </div>
                    <div class="alerts-grid" id="criticalAlertsGrid">
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <p>No critical alerts at the moment</p>
                        </div>
                    </div>
                </div>

                <!-- Weather Widget -->
                <div class="weather-widget">
                    <div class="weather-header">
                        <h3 class="weather-title">
                            <i class="fas fa-cloud-sun"></i>
                            Current Weather
                        </h3>
                        <div class="weather-location" id="weatherLocation">
                            <i class="fas fa-map-marker-alt"></i>
                            Loading...
                        </div>
                    </div>
                    <div class="weather-content" id="weatherContent">
                        <div class="weather-current">
                            <div class="weather-temp" id="weatherTemp">--¬∞C</div>
                            <div class="weather-condition" id="weatherCondition">Loading...</div>
                        </div>
                        <div class="weather-details">
                            <div class="weather-detail">
                                <i class="fas fa-tint"></i>
                                <span>Humidity</span>
                                <strong id="weatherHumidity">--%</strong>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-wind"></i>
                                <span>Wind Speed</span>
                                <strong id="weatherWind">-- km/h</strong>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-cloud-rain"></i>
                                <span>Rainfall</span>
                                <strong id="weatherRainfall">-- mm</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Farms Section -->
            <div id="farmsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">My Farms</h2>
                        <p class="section-subtitle">Manage your agricultural lands</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-farm">
                            <i class="fas fa-plus"></i>
                            Add New Farm
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-farms">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-farms">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Farms Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-map"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="farmsTotalCount">0</div>
                            <div class="stat-mini-label">Total Farms</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-ruler-combined"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="farmsTotalArea">0 ha</div>
                            <div class="stat-mini-label">Total Area</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="farmsIrrigated">0</div>
                            <div class="stat-mini-label">Irrigated Farms</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="farmsActive">0</div>
                            <div class="stat-mini-label">Active Farms</div>
                        </div>
                    </div>
                </div>

                <!-- Farms Filter and Search -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search farms by name or location..." id="farmsSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="farmsSoilTypeFilter">
                            <option value="">All Soil Types</option>
                            <option value="clay">Clay</option>
                            <option value="loam">Loam</option>
                            <option value="sand">Sand</option>
                            <option value="silt">Silt</option>
                        </select>
                        <select class="filter-select" id="farmsIrrigationFilter">
                            <option value="">All Irrigation Systems</option>
                            <option value="RAIN_FED">Rain Fed</option>
                            <option value="SPRINKLER">Sprinkler</option>
                            <option value="DRIP">Drip Irrigation</option>
                            <option value="FLOOD">Flood Irrigation</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Farms Grid -->
                <div class="farms-grid" id="farmsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading your farms...</p>
                    </div>
                </div>
            </div>

            <!-- Crops Catalog Section -->
            <div id="cropsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Crop Catalog</h2>
                        <p class="section-subtitle">Browse available crops and their requirements</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-crops">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Crops Filter and Search -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search crops by name..." id="cropsSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="cropsTypeFilter">
                            <option value="">All Crop Types</option>
                            <option value="CEREALS">Cereals</option>
                            <option value="VEGETABLES">Vegetables</option>
                            <option value="FRUITS">Fruits</option>
                            <option value="LEGUMES">Legumes</option>
                            <option value="TUBERS">Tubers</option>
                            <option value="CASH_CROPS">Cash Crops</option>
                        </select>
                        <select class="filter-select" id="cropsSeasonFilter">
                            <option value="">All Seasons</option>
                            <option value="SEASON_A">Season A</option>
                            <option value="SEASON_B">Season B</option>
                            <option value="SEASON_C">Season C</option>
                        </select>
                        <select class="filter-select" id="cropsDemandFilter">
                            <option value="">All Demand Levels</option>
                            <option value="HIGH">High Demand</option>
                            <option value="MEDIUM">Medium Demand</option>
                            <option value="LOW">Low Demand</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-crop-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Crops Grid -->
                <div class="crops-grid" id="cropsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading crop catalog...</p>
                    </div>
                </div>
            </div>






            <!-- Production Section -->
            <div id="productionSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Crop Productions</h2>
                        <p class="section-subtitle">Track your planting and harvest activities</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-production">
                            <i class="fas fa-plus"></i>
                            Start Production
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-productions">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-productions">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Production Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="prodTotalCount">0</div>
                            <div class="stat-mini-label">Total Productions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-leaf"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="prodActive">0</div>
                            <div class="stat-mini-label">Active Productions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="prodHarvested">0</div>
                            <div class="stat-mini-label">Harvested</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="prodTotalYield">0 T</div>
                            <div class="stat-mini-label">Total Yield</div>
                        </div>
                    </div>
                </div>

                <!-- Production Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search productions..." id="productionSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="productionStatusFilter">
                            <option value="">All Status</option>
                            <option value="PLANNED">Planned</option>
                            <option value="PLANTED">Planted</option>
                            <option value="GROWING">Growing</option>
                            <option value="HARVESTED">Harvested</option>
                            <option value="SOLD">Sold</option>
                        </select>
                        <select class="filter-select" id="productionSeasonFilter">
                            <option value="">All Seasons</option>
                            <option value="SEASON_A">Season A</option>
                            <option value="SEASON_B">Season B</option>
                            <option value="SEASON_C">Season C</option>
                        </select>
                        <select class="filter-select" id="productionYearFilter">
                            <option value="">All Years</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-production-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Production Timeline View -->
                <div class="production-timeline" id="productionTimeline">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading productions...</p>
                    </div>
                </div>
            </div>

            <!-- Inventory Section -->
            <div id="inventorySection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Inventory Management</h2>
                        <p class="section-subtitle">Track your stored products</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-inventory">
                            <i class="fas fa-plus"></i>
                            Add Stock
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-inventory">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-inventory">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Inventory Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="invTotalItems">0</div>
                            <div class="stat-mini-label">Total Items</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-weight"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="invTotalQuantity">0 KG</div>
                            <div class="stat-mini-label">Total Quantity</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="invTotalValue">RWF 0</div>
                            <div class="stat-mini-label">Total Value</div>
                        </div>
                    </div>
                    <div class="stat-mini-card alert">
                        <div class="stat-mini-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="invAlerts">0</div>
                            <div class="stat-mini-label">Active Alerts</div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Alerts -->
                <div class="inventory-alerts" id="inventoryAlerts">
                    <!-- Alerts will be dynamically inserted here -->
                </div>

                <!-- Inventory Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search inventory..." id="inventorySearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="inventoryStatusFilter">
                            <option value="">All Status</option>
                            <option value="AVAILABLE">Available</option>
                            <option value="RESERVED">Reserved</option>
                            <option value="SOLD">Sold</option>
                            <option value="EXPIRED">Expired</option>
                        </select>
                        <select class="filter-select" id="inventoryQualityFilter">
                            <option value="">All Quality</option>
                            <option value="EXCELLENT">Excellent</option>
                            <option value="GOOD">Good</option>
                            <option value="FAIR">Fair</option>
                            <option value="POOR">Poor</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-inventory-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Inventory Grid -->
                <div class="inventory-grid" id="inventoryGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading inventory...</p>
                    </div>
                </div>
            </div>

            <!-- Fertilizer Usage Section -->
            <div id="fertilizerSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Fertilizer Usage</h2>
                        <p class="section-subtitle">Track fertilizer applications and costs</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-fertilizer">
                            <i class="fas fa-plus"></i>
                            Record Usage
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-fertilizer">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-fertilizer">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Fertilizer Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-flask"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="fertTotalApplications">0</div>
                            <div class="stat-mini-label">Total Applications</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-weight-hanging"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="fertTotalQuantity">0 KG</div>
                            <div class="stat-mini-label">Total Quantity</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="fertTotalCost">RWF 0</div>
                            <div class="stat-mini-label">Total Cost</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="fertAvgEffectiveness">0</div>
                            <div class="stat-mini-label">Avg Effectiveness</div>
                        </div>
                    </div>
                </div>

                <!-- Fertilizer Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Cost by Fertilizer Type</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="fertilizerCostChart"></canvas>
                    </div>
                </div>

                <!-- Fertilizer Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search fertilizer records..." id="fertilizerSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="fertilizerTypeFilter">
                            <option value="">All Types</option>
                            <option value="ORGANIC">Organic</option>
                            <option value="NPK">NPK</option>
                            <option value="NITROGEN">Nitrogen</option>
                            <option value="PHOSPHATE">Phosphate</option>
                            <option value="POTASH">Potash</option>
                        </select>
                        <input type="date" class="filter-select" id="fertilizerDateFrom" placeholder="From Date">
                        <input type="date" class="filter-select" id="fertilizerDateTo" placeholder="To Date">
                        <button class="btn btn-secondary" data-action="clear-fertilizer-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Fertilizer Table -->
                <div class="table-section">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>Date</th>
                                <th>Crop Production</th>
                                <th>Fertilizer Type</th>
                                <th>Name</th>
                                <th>Quantity</th>
                                <th>Method</th>
                                <th>Cost</th>
                                <th>Effectiveness</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="fertilizerTableBody">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading fertilizer records...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Irrigation Data Section -->
            <div id="irrigationSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Irrigation Data</h2>
                        <p class="section-subtitle">Monitor water usage and efficiency</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" data-action="add-irrigation">
                            <i class="fas fa-plus"></i>
                            Record Irrigation
                        </button>
                        <button class="btn btn-secondary" data-action="refresh-irrigation">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-irrigation">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Irrigation Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="irrigTotalSessions">0</div>
                            <div class="stat-mini-label">Total Sessions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-water"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="irrigTotalWater">0 L</div>
                            <div class="stat-mini-label">Total Water Used</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="irrigTotalCost">RWF 0</div>
                            <div class="stat-mini-label">Total Cost</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="irrigAvgEfficiency">0%</div>
                            <div class="stat-mini-label">Avg Efficiency</div>
                        </div>
                    </div>
                </div>

                <!-- Irrigation Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Water Usage Trends</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="irrigationTrendChart"></canvas>
                    </div>
                </div>

                <!-- Irrigation Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search irrigation records..." id="irrigationSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="irrigationMethodFilter">
                            <option value="">All Methods</option>
                            <option value="SPRINKLER">Sprinkler</option>
                            <option value="DRIP">Drip</option>
                            <option value="FLOOD">Flood</option>
                            <option value="FURROW">Furrow</option>
                            <option value="MANUAL">Manual</option>
                        </select>
                        <select class="filter-select" id="irrigationSourceFilter">
                            <option value="">All Sources</option>
                            <option value="WELL">Well</option>
                            <option value="RIVER">River</option>
                            <option value="LAKE">Lake</option>
                            <option value="RAINWATER">Rainwater</option>
                        </select>
                        <input type="date" class="filter-select" id="irrigationDateFrom" placeholder="From Date">
                        <input type="date" class="filter-select" id="irrigationDateTo" placeholder="To Date">
                        <button class="btn btn-secondary" data-action="clear-irrigation-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Irrigation Table -->
                <div class="table-section">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>Date</th>
                                <th>Farm</th>
                                <th>Water Amount</th>
                                <th>Duration</th>
                                <th>Method</th>
                                <th>Source</th>
                                <th>Moisture Before</th>
                                <th>Moisture After</th>
                                <th>Cost</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="irrigationTableBody">
                            <tr>
                                <td colspan="10" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading irrigation records...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Soil Data Section -->
            <div id="soilSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Soil Data</h2>
                        <p class="section-subtitle">Monitor soil health and quality</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-soil">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Soil Data Grid -->
                <div class="soil-data-grid" id="soilDataGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading soil data...</p>
                    </div>
                </div>
            </div>

            <!-- Market Prices Section -->
            <div id="marketPricesSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Market Prices</h2>
                        <p class="section-subtitle">Track real-time crop prices</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-market-prices">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Market Prices Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search crops or markets..." id="marketPricesSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="marketPricesTypeFilter">
                            <option value="">All Market Types</option>
                            <option value="WHOLESALE">Wholesale</option>
                            <option value="RETAIL">Retail</option>
                            <option value="FARM_GATE">Farm Gate</option>
                            <option value="EXPORT">Export</option>
                        </select>
                        <select class="filter-select" id="marketPricesTrendFilter">
                            <option value="">All Trends</option>
                            <option value="INCREASING">Increasing</option>
                            <option value="STABLE">Stable</option>
                            <option value="DECREASING">Decreasing</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-market-prices-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Market Prices Grid -->
                <div class="market-prices-grid" id="marketPricesGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading market prices...</p>
                    </div>
                </div>
            </div>

            <!-- Transactions Section -->
            <div id="transactionsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">My Transactions</h2>
                        <p class="section-subtitle">Track your sales and purchases</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-transactions">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                        <button class="btn btn-info" data-action="export-transactions">
                            <i class="fas fa-file-excel"></i>
                            Export
                        </button>
                    </div>
                </div>

                <!-- Transactions Statistics -->
                <div class="stats-mini-grid">
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="txTotalCount">0</div>
                            <div class="stat-mini-label">Total Transactions</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="txCompleted">0</div>
                            <div class="stat-mini-label">Completed</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="txTotalAmount">RWF 0</div>
                            <div class="stat-mini-label">Total Amount</div>
                        </div>
                    </div>
                    <div class="stat-mini-card">
                        <div class="stat-mini-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="stat-mini-content">
                            <div class="stat-mini-value" id="txNetAmount">RWF 0</div>
                            <div class="stat-mini-label">Net Amount</div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search transactions..." id="transactionsSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="transactionsStatusFilter">
                            <option value="">All Status</option>
                            <option value="PENDING">Pending</option>
                            <option value="CONFIRMED">Confirmed</option>
                            <option value="DELIVERED">Delivered</option>
                            <option value="PAID">Paid</option>
                            <option value="CANCELLED">Cancelled</option>
                        </select>
                        <input type="date" class="filter-select" id="transactionsDateFrom" placeholder="From Date">
                        <input type="date" class="filter-select" id="transactionsDateTo" placeholder="To Date">
                        <button class="btn btn-secondary" data-action="clear-transactions-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Transactions Table -->
                <div class="table-section">
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>Transaction Code</th>
                                <th>Date</th>
                                <th>Buyer</th>
                                <th>Crop</th>
                                <th>Quantity</th>
                                <th>Total Amount</th>
                                <th>Net Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="transactionsTableBody">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading transactions...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Supply Chain Section -->
            <div id="supplyChainSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Supply Chain Tracking</h2>
                        <p class="section-subtitle">Track your products through the supply chain</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-supply-chain">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Supply Chain Search -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search by tracking code or production..." id="supplyChainSearchInput">
                    </div>
                </div>

                <!-- Supply Chain Stages Legend -->
                <div class="supply-chain-legend">
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #22c55e;"></span>
                        <span>Harvest</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #3b82f6;"></span>
                        <span>Collection</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #f59e0b;"></span>
                        <span>Storage</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #8b5cf6;"></span>
                        <span>Processing</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #ec4899;"></span>
                        <span>Packaging</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #14b8a6;"></span>
                        <span>Transport</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #f97316;"></span>
                        <span>Distribution</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot" style="background: #06b6d4;"></span>
                        <span>Retail</span>
                    </div>
                </div>

                <!-- Supply Chain Timeline -->
                <div class="supply-chain-container" id="supplyChainContainer">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading supply chain data...</p>
                    </div>
                </div>
            </div>

            <!-- Weather Data Section -->
            <div id="weatherSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Weather Data</h2>
                        <p class="section-subtitle">Monitor weather conditions</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-weather">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Current Weather -->
                <div class="weather-current-card">
                    <div class="weather-main">
                        <div class="weather-temp-large" id="weatherTempLarge">--¬∞C</div>
                        <div class="weather-condition-large" id="weatherConditionLarge">Loading...</div>
                        <div class="weather-location-large" id="weatherLocationLarge">
                            <i class="fas fa-map-marker-alt"></i>
                            Location
                        </div>
                    </div>
                    <div class="weather-details-grid">
                        <div class="weather-detail-card">
                            <div class="weather-detail-icon">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div class="weather-detail-content">
                                <div class="weather-detail-label">Humidity</div>
                                <div class="weather-detail-value" id="weatherHumidityLarge">--%</div>
                            </div>
                        </div>
                        <div class="weather-detail-card">
                            <div class="weather-detail-icon">
                                <i class="fas fa-wind"></i>
                            </div>
                            <div class="weather-detail-content">
                                <div class="weather-detail-label">Wind Speed</div>
                                <div class="weather-detail-value" id="weatherWindLarge">-- km/h</div>
                            </div>
                        </div>
                        <div class="weather-detail-card">
                            <div class="weather-detail-icon">
                                <i class="fas fa-cloud-rain"></i>
                            </div>
                            <div class="weather-detail-content">
                                <div class="weather-detail-label">Rainfall</div>
                                <div class="weather-detail-value" id="weatherRainfallLarge">-- mm</div>
                            </div>
                        </div>
                        <div class="weather-detail-card">
                            <div class="weather-detail-icon">
                                <i class="fas fa-compress-arrows-alt"></i>
                            </div>
                            <div class="weather-detail-content">
                                <div class="weather-detail-label">Pressure</div>
                                <div class="weather-detail-value" id="weatherPressureLarge">-- hPa</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weather History Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Temperature & Rainfall Trends (Last 7 Days)</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="weatherHistoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Food Security Alerts Section -->
            <div id="alertsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Food Security Alerts</h2>
                        <p class="section-subtitle">Stay informed about agricultural alerts</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-alerts">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Alerts Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search alerts..." id="alertsSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="alertsLevelFilter">
                            <option value="">All Levels</option>
                            <option value="CRITICAL">Critical</option>
                            <option value="HIGH">High</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="LOW">Low</option>
                            <option value="INFO">Info</option>
                        </select>
                        <select class="filter-select" id="alertsCategoryFilter">
                            <option value="">All Categories</option>
                            <option value="PRODUCTION">Production</option>
                            <option value="WEATHER">Weather</option>
                            <option value="MARKET">Market</option>
                            <option value="DISEASE">Disease</option>
                            <option value="POLICY">Policy</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-alerts-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Alerts Grid -->
                <div class="alerts-list" id="alertsList">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading alerts...</p>
                    </div>
                </div>
            </div>

            <!-- Policies Section -->
            <div id="policiesSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Agricultural Policies & Subsidies</h2>
                        <p class="section-subtitle">Explore available government support</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-policies">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Policies Filter -->
                <div class="filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search policies..." id="policiesSearchInput">
                    </div>
                    <div class="filter-controls">
                        <select class="filter-select" id="policiesTypeFilter">
                            <option value="">All Types</option>
                            <option value="SUBSIDY">Subsidy</option>
                            <option value="CREDIT_PROGRAM">Credit Program</option>
                            <option value="INSURANCE">Insurance</option>
                            <option value="REGULATION">Regulation</option>
                            <option value="SUPPORT_PROGRAM">Support Program</option>
                        </select>
                        <select class="filter-select" id="policiesStatusFilter">
                            <option value="">All Status</option>
                            <option value="ACTIVE">Active</option>
                            <option value="DRAFT">Draft</option>
                            <option value="EXPIRED">Expired</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-policies-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Policies Grid -->
                <div class="policies-grid" id="policiesGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading policies...</p>
                    </div>
                </div>
            </div>

            <!-- AI Recommendations Section -->
            <div id="recommendationsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">AI Recommendations</h2>
                        <p class="section-subtitle">Get smart recommendations for your farm</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-recommendations">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Recommendations Filter -->
                <div class="filter-section">
                    <div class="filter-controls">
                        <select class="filter-select" id="recommendationsTypeFilter">
                            <option value="">All Types</option>
                            <option value="FERTILIZER">Fertilizer</option>
                            <option value="WATER">Water</option>
                            <option value="SEEDS">Seeds</option>
                            <option value="PESTICIDE">Pesticide</option>
                        </select>
                        <select class="filter-select" id="recommendationsPriorityFilter">
                            <option value="">All Priorities</option>
                            <option value="URGENT">Urgent</option>
                            <option value="HIGH">High</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="LOW">Low</option>
                        </select>
                        <button class="btn btn-secondary" data-action="clear-recommendations-filters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Recommendations Grid -->
                <div class="recommendations-grid" id="recommendationsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading AI recommendations...</p>
                    </div>
                </div>
            </div>

            <!-- Production Predictions Section -->
            <div id="predictionsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Production Predictions</h2>
                        <p class="section-subtitle">AI-powered production forecasts</p>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-secondary" data-action="refresh-predictions">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Predictions Grid -->
                <div class="predictions-grid" id="predictionsGrid">
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading predictions...</p>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="content-section">
                <div class="section-header">
                    <div class="section-header-left">
                        <h2 class="section-title">Reports & Analytics</h2>
                        <p class="section-subtitle">Generate comprehensive farm reports</p>
                    </div>
                </div>

                <!-- Report Configuration -->
                <div class="report-config-card">
                    <h3 class="report-config-title">Report Configuration</h3>
                    <div class="report-config-grid">
                        <div class="form-group">
                            <label class="form-label">Report Type</label>
                            <select class="form-select" id="reportType">
                                <option value="farm-overview">Farm Overview</option>
                                <option value="production-summary">Production Summary</option>
                                <option value="financial-report">Financial Report</option>
                                <option value="resource-usage">Resource Usage</option>
                                <option value="inventory-report">Inventory Report</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Time Period</label>
                            <select class="form-select" id="reportPeriod">
                                <option value="this-month">This Month</option>
                                <option value="last-month">Last Month</option>
                                <option value="this-quarter">This Quarter</option>
                                <option value="this-year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">From Date</label>
                            <input type="date" class="form-input" id="reportDateFrom">
                        </div>
                        <div class="form-group">
                            <label class="form-label">To Date</label>
                            <input type="date" class="form-input" id="reportDateTo">
                        </div>
                    </div>
                    <div class="report-actions">
                        <button class="btn btn-primary" data-action="generate-pdf-report">
                            <i class="fas fa-file-pdf"></i>
                            Generate PDF Report
                        </button>
                        <button class="btn btn-info" data-action="generate-excel-report">
                            <i class="fas fa-file-excel"></i>
                            Generate Excel Report
                        </button>
                        <button class="btn btn-secondary" data-action="preview-report">
                            <i class="fas fa-eye"></i>
                            Preview Report
                        </button>
                    </div>
                </div>

                <!-- Report Preview -->
                <div class="report-preview-card" id="reportPreview" style="display: none;">
                    <div class="report-preview-header">
                        <h3 class="report-preview-title">Report Preview</h3>
                        <button class="btn btn-secondary btn-sm" data-action="close-preview">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="report-preview-content" id="reportPreviewContent">
                        <!-- Report content will be inserted here -->
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>




<!-- Modals will be added via JavaScript -->
<div id="modalContainer"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="js/SessionTracker.js"></script>
<script src="js/user_session_handler.js"></script>
<script >




    // ============================================================================
    // GLOBAL CONFIGURATION
    // ============================================================================
    const DEBUG_MODE = false; // <-- AJOUTER CETTE LIGNE ICI (ligne ~20)
    const API_CONFIG = {
      BASE_URL: 'http://localhost:1010/api',
      TIMEOUT: 30000,
      RETRY_ATTEMPTS: 3
    };
      // Authentication state
      let currentUser = null;
      let authToken = null;

      // Charts instances
      let charts = {
      productionTrend: null,
      costBreakdown: null,
      fertilizerCost: null,
      irrigationTrend: null,
      weatherHistory: null
      };

      // ============================================================================
      // UTILITY FUNCTIONS
      // ============================================================================

      /**
      * Show loading overlay
      */
      function showLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'flex';
      }

      /**
      * Hide loading overlay
      */
      function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) overlay.style.display = 'none';
      }

      /**
      * Show toast notification
      */
      function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      if (!container) return;

      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;

      const icon = {
      success: 'fa-check-circle',
      error: 'fa-exclamation-circle',
      warning: 'fa-exclamation-triangle',
      info: 'fa-info-circle'
      }[type] || 'fa-info-circle';

      toast.innerHTML = `
      <i class="fas ${icon}"></i>
      <span>${message}</span>
      <button class="toast-close" onclick="this.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
      `;

      container.appendChild(toast);

      setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease forwards';
      setTimeout(() => toast.remove(), 300);
      }, 5000);
      }

      /**
      * Format currency
      */
      function formatCurrency(amount) {
      return new Intl.NumberFormat('en-RW', {
      style: 'currency',
      currency: 'RWF',
      minimumFractionDigits: 0
      }).format(amount || 0);
      }

      /**
      * Format date
      */
      function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
      }).format(date);
      }

      /**
      * Format datetime
      */
      function formatDateTime(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
      }).format(date);
      }

      /**
      * Get auth headers
      */
      function getAuthHeaders() {
      const token = localStorage.getItem('authToken');
      return {
      'Content-Type': 'application/json',
      'Authorization': token ? `Bearer ${token}` : ''
      };
      }





// FarmerDashboard.html - Corrections JavaScript






async function apiRequest(endpoint, options = {}) {
    const url = `${API_CONFIG.BASE_URL}${endpoint}`;

    const config = {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': localStorage.getItem('authToken') ? `Bearer ${localStorage.getItem('authToken')}` : ''
        },
        ...options
    };

    try {
        console.log(`üîÑ API Call: ${config.method} ${url}`);

        const response = await fetch(url, config);

        if (!response.ok) {
            const errorText = await response.text();
            console.error(`‚ùå HTTP Error ${response.status}:`, errorText);

            if (response.status === 401) {
                handleUnauthorized();
                throw new Error('Authentication required');
            }

            if (response.status === 500) {
                // ‚úÖ CORRECTION: Pour les endpoints de liste, retourner un tableau vide
                if (endpoint.includes('/v1/inventories/farmer/') ||
                    endpoint.includes('/farms/farmer/') ||
                    endpoint.includes('/v1/crop-productions/farm/')) {  // ‚úÖ CHANG√â ICI
                    console.warn('Server error for list endpoint, returning empty array');
                    return [];
                }
                throw new Error('Server error: ' + (errorText || 'Internal server error'));
            }

            throw new Error(`HTTP ${response.status}: ${errorText || 'Request failed'}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.warn('‚ö†Ô∏è Non-JSON response received');
            return null;
        }

        const data = await response.json();
        console.log(`‚úÖ API Success: ${endpoint}`, data);
        return data;

    } catch (error) {
        console.error('üí• API Request Failed:', error);

        // ‚úÖ CORRECTION: Pour les endpoints de liste en cas d'erreur r√©seau
        if (endpoint.includes('/v1/inventories/farmer/') ||
            endpoint.includes('/farms/farmer/') ||
            endpoint.includes('/v1/crop-productions/farm/')) {  // ‚úÖ CHANG√â ICI
            console.warn('Network error for list endpoint, returning empty array');
            return [];
        }

        throw error;
    }
}













      /**
      * Handle unauthorized access
      */
      function handleUnauthorized() {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = '/login.html';
      }



  /**
   * Load user session
   */
  function loadUserSession() {
    const sessionHandler = UserSessionHandler.getInstance();

    // V√©rifier l'authentification
    if (!sessionHandler.isAuthenticated()) {
      handleUnauthorized();
      return null;
    }

    // R√©cup√©rer l'utilisateur
    const user = sessionHandler.getCurrentUser();
    if (!user) {
      handleUnauthorized();
      return null;
    }

    try {
      currentUser = user;
      authToken = user.token || sessionHandler.getAuthToken();
      return currentUser;
    } catch (error) {
      console.error('Error loading user session:', error);
      handleUnauthorized();
      return null;
    }
  }



  /**
   * Update profile display
   */
  function updateProfileDisplay() {
    if (!currentUser) {
      const sessionHandler = UserSessionHandler.getInstance();
      currentUser = sessionHandler.getCurrentUser();
    }

    if (!currentUser) return;

    const profileName = document.getElementById('profileName');
    const profileAvatar = document.getElementById('profileAvatar');
    const greetingText = document.getElementById('greetingText');

    if (profileName) profileName.textContent = currentUser.fullName || 'Farmer';

    if (greetingText) {
      const hour = new Date().getHours();
      const greeting = hour < 12 ? 'Good Morning' : hour < 18 ? 'Good Afternoon' : 'Good Evening';
      greetingText.textContent = `${greeting}, ${currentUser.fullName || 'Farmer'}!`;
    }

    if (profileAvatar) {
      const photoData = currentUser.photo || currentUser.photoBase64 || currentUser.profileImageUrl;
      if (photoData) {
        const imgSrc = photoData.startsWith('data:image/') || photoData.startsWith('http')
          ? photoData
          : `data:image/jpeg;base64,${photoData}`;
        profileAvatar.innerHTML = `<img src="${imgSrc}" alt="Profile" onerror="this.parentElement.textContent='${(currentUser.fullName || 'F').charAt(0).toUpperCase()}'">`;
      } else {
        profileAvatar.textContent = (currentUser.fullName || 'F').charAt(0).toUpperCase();
      }
    }
  }

      /**
      * Update current date display
      */
      function updateCurrentDate() {
      const dateElement = document.getElementById('currentDate');
      if (dateElement) {
      const today = new Date();
      dateElement.textContent = new Intl.DateTimeFormat('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
      }).format(today);
      }
      }

      // ============================================================================
      // NAVIGATION AND UI MANAGEMENT
      // ============================================================================

      /**
      * Initialize navigation
      */
      function initNavigation() {
      const navLinks = document.querySelectorAll('.nav-link');

      navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
      e.preventDefault();
      const section = link.getAttribute('data-section');
      if (section) {
      navigateToSection(section);
      }
      });
      });

      // Sidebar toggle
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebar = document.getElementById('sidebar');

      if (sidebarToggle && sidebar) {
      sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      });
      }

      // Theme toggle
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
      themeToggle.addEventListener('click', toggleTheme);
      loadThemePreference();
      }

      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
      logoutBtn.addEventListener('click', handleLogout);
      }
      }

      /**
      * Navigate to section
      */
      function navigateToSection(sectionName) {
      // Hide all sections
      const sections = document.querySelectorAll('.content-section');
      sections.forEach(section => section.classList.remove('active'));

      // Show target section
      const targetSection = document.getElementById(`${sectionName}Section`);
      if (targetSection) {
      targetSection.classList.add('active');
      }

      // Update nav active state
      const navLinks = document.querySelectorAll('.nav-link');
      navLinks.forEach(link => {
      link.parentElement.classList.remove('active');
      if (link.getAttribute('data-section') === sectionName) {
      link.parentElement.classList.add('active');
      }
      });

      // Load section data
      loadSectionData(sectionName);
      }

      /**
      * Load section data
      */
      async function loadSectionData(section) {
      switch (section) {
      case 'dashboard':
      await loadDashboardData();
      break;
      case 'farms':
      await loadFarmsData();
      break;
      case 'crops':
      await loadCropsData();
      break;
      case 'production':
      await loadProductionData();
      break;
      case 'inventory':
      await loadInventoryData();
      break;
      case 'fertilizer':
      await loadFertilizerData();
      break;
      case 'irrigation':
      await loadIrrigationData();
      break;
      case 'soil':
      await loadSoilData();
      break;
      case 'market-prices':
      await loadMarketPricesData();
      break;
      case 'transactions':
      await loadTransactionsData();
      break;
      case 'supply-chain':
      await loadSupplyChainData();
      break;
      case 'weather':
      await loadWeatherData();
      break;
      case 'alerts':
      await loadAlertsData();
      break;
      case 'policies':
      await loadPoliciesData();
      break;
      case 'recommendations':
      await loadRecommendationsData();
      break;
      case 'predictions':
      await loadPredictionsData();
      break;
      case 'reports':
      // Reports section doesn't need auto-load
      break;
      default:
      console.warn('Unknown section:', section);
      }
      }



/**
 * Toggle theme - VERSION CORRIG√âE
 */
function toggleTheme() {
  const body = document.body;
  const themeToggle = document.getElementById('themeToggle');

  // Toggle dark mode class
  const isDark = body.classList.toggle('dark-mode');

  // Save preference
  localStorage.setItem('theme', isDark ? 'dark' : 'light');

  // Update button
  if (themeToggle) {
    const icon = themeToggle.querySelector('i');
    const text = themeToggle.querySelector('span');

    if (isDark) {
      if (icon) icon.className = 'fas fa-sun';
      if (text) text.textContent = 'Light Mode';
    } else {
      if (icon) icon.className = 'fas fa-moon';
      if (text) text.textContent = 'Dark Mode';
    }
  }

  console.log('‚úÖ Theme toggled to:', isDark ? 'dark' : 'light');
}

/**
 * Load theme preference - VERSION CORRIG√âE
 */
function loadThemePreference() {
  const theme = localStorage.getItem('theme');
  const body = document.body;
  const themeToggle = document.getElementById('themeToggle');

  if (theme === 'dark') {
    body.classList.add('dark-mode');

    if (themeToggle) {
      const icon = themeToggle.querySelector('i');
      const text = themeToggle.querySelector('span');

      if (icon) icon.className = 'fas fa-sun';
      if (text) text.textContent = 'Light Mode';
    }

    console.log('‚úÖ Dark mode loaded from preferences');
  }
}
      /**
      * Handle logout
      */
      function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = '/login.html';
      }
      }

      // ============================================================================
      // DASHBOARD HOME MODULE
      // ============================================================================

      /**
      * Load dashboard data
      */
      async function loadDashboardData() {
      try {
      showLoading();

      // Load all dashboard components in parallel
      await Promise.all([
      loadDashboardStats(),
      loadDashboardCharts(),
      loadUpcomingTasks(),
      loadRecentActivities(),
      loadCriticalAlerts(),
      loadWeatherWidget()
      ]);

      } catch (error) {
      console.error('Error loading dashboard:', error);
      showToast('Error loading dashboard data', 'error');
      } finally {
      hideLoading();
      }
      }


async function loadDashboardStats() {
    try {
        // VALIDATION USER
        if (!currentUser || !currentUser.id) {
            console.error('‚ùå No current user found');
            displayDefaultStats();
            return;
        }

        if (DEBUG_MODE) {
            console.log('üîÑ Loading dashboard stats for user:', currentUser.id);
        }

        // R√âCUP√âRATION FERMES
        let farms = [];
        try {
            const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
            farms = Array.isArray(farmsResponse) ? farmsResponse : [];
        } catch (error) {
            console.warn('‚ö†Ô∏è Farms load warning:', error.message);
            farms = [];
        }

        const totalFarms = farms.length;
        const totalArea = farms.reduce((sum, farm) =>
            sum + (parseFloat(farm.farmSize || farm.sizeHectares) || 0), 0);

        // R√âCUP√âRATION PRODUCTIONS - ‚úÖ CORRECTION DU ENDPOINT
        let allProductions = [];
        if (farms.length > 0) {
            try {
                const productionPromises = farms.map(farm =>
                    apiRequest(`/v1/crop-productions/farm/${farm.id}`)  // ‚úÖ CHANGEMENT ICI - RETIR√â /all
                        .catch(err => {
                            console.warn(`‚ö†Ô∏è Production load failed for farm ${farm.id}`);
                            return [];
                        })
                );
                const productionArrays = await Promise.all(productionPromises);

                // ‚úÖ GESTION DE LA R√âPONSE API
                allProductions = productionArrays.flatMap(response => {
                    if (Array.isArray(response)) {
                        return response;
                    } else if (response && response.data && Array.isArray(response.data)) {
                        return response.data;
                    } else if (response && response.content && Array.isArray(response.content)) {
                        return response.content;
                    }
                    return [];
                }).filter(p => p);

            } catch (error) {
                console.warn('‚ö†Ô∏è Productions load warning:', error.message);
            }
        }

        const activeProductions = allProductions.filter(p =>
            ['PLANTED', 'GROWING'].includes(p.productionStatus)
        ).length;
        const totalProductions = allProductions.length;

        // R√âCUP√âRATION INVENTAIRE - GESTION ULTRA-ROBUSTE
        let inventory = [];
        let inventoryValue = 0;
        let inventoryItems = 0;

        try {
            console.log('üì¶ Fetching inventory for farmer:', currentUser.id);

            const inventoryResponse = await apiRequest(`/v1/inventories/farmer/${currentUser.id}`);

            // GESTION MULTI-FORMAT DE LA R√âPONSE
            if (inventoryResponse) {
                if (Array.isArray(inventoryResponse)) {
                    inventory = inventoryResponse;
                } else if (inventoryResponse.data && Array.isArray(inventoryResponse.data)) {
                    inventory = inventoryResponse.data;
                } else if (inventoryResponse.content && Array.isArray(inventoryResponse.content)) {
                    inventory = inventoryResponse.content;
                } else if (inventoryResponse.success === true && Array.isArray(inventoryResponse.data)) {
                    inventory = inventoryResponse.data;
                } else {
                    console.warn('‚ö†Ô∏è Unexpected inventory format:', inventoryResponse);
                    inventory = [];
                }
            }

            console.log(`‚úÖ Inventory loaded: ${inventory.length} items`);

            // CALCUL VALEUR AVEC S√âCURIT√â
            inventoryValue = inventory.reduce((sum, item) => {
                try {
                    const value = parseFloat(item.totalMarketValue || 0);
                    return sum + (isNaN(value) ? 0 : value);
                } catch (e) {
                    return sum;
                }
            }, 0);

            inventoryItems = inventory.length;

        } catch (error) {
            console.warn('‚ö†Ô∏è Inventory load warning:', error.message);
            inventory = [];
            inventoryValue = 0;
            inventoryItems = 0;
        }

        // R√âCUP√âRATION ALERTES - GESTION ULTRA-ROBUSTE
        let alerts = [];
        let criticalAlerts = 0;
        try {
            const alertsResponse = await apiRequest('/food-security-alerts/active');

            // GESTION MULTI-FORMAT DE LA R√âPONSE
            if (alertsResponse) {
                if (Array.isArray(alertsResponse)) {
                    alerts = alertsResponse;
                } else if (alertsResponse.data && Array.isArray(alertsResponse.data)) {
                    alerts = alertsResponse.data;
                } else if (alertsResponse.content && Array.isArray(alertsResponse.content)) {
                    alerts = alertsResponse.content;
                } else if (alertsResponse.success === true) {
                    if (Array.isArray(alertsResponse.data)) {
                        alerts = alertsResponse.data;
                    } else if (alertsResponse.data && Array.isArray(alertsResponse.data.content)) {
                        alerts = alertsResponse.data.content;
                    }
                }
            }

            if (!Array.isArray(alerts)) {
                console.warn('‚ö†Ô∏è Alerts response is not an array:', alertsResponse);
                alerts = [];
            }

            criticalAlerts = alerts.filter(a =>
                a && a.alertLevel && ['CRITICAL', 'HIGH'].includes(a.alertLevel)
            ).length;

        } catch (error) {
            console.warn('‚ö†Ô∏è Alerts load warning:', error.message);
            alerts = [];
            criticalAlerts = 0;
        }

        // MISE √Ä JOUR UI - TOUJOURS AFFICHER DES VALEURS
        updateElement('dashTotalFarms', totalFarms);
        updateElement('dashTotalArea', `${totalArea.toFixed(2)} ha`);
        updateElement('dashActiveProductions', activeProductions);
        updateElement('dashTotalProductions', `${totalProductions} total`);
        updateElement('dashInventoryValue', formatCurrency(inventoryValue));
        updateElement('dashInventoryItems', `${inventoryItems} items`);
        updateElement('dashCriticalAlerts', criticalAlerts);
        updateElement('dashTotalAlerts', `${alerts.length} total alerts`);

        if (DEBUG_MODE) {
            console.log('‚úÖ Dashboard stats updated successfully');
        }

    } catch (error) {
        console.error('üí• Error loading dashboard stats:', error);
        displayDefaultStats();
    }
}







/**
 * Afficher des statistiques par d√©faut en cas d'erreur
 */
function displayDefaultStats() {
    updateElement('dashTotalFarms', 0);
    updateElement('dashTotalArea', '0 ha');
    updateElement('dashActiveProductions', 0);
    updateElement('dashTotalProductions', '0 total');
    updateElement('dashInventoryValue', formatCurrency(0));
    updateElement('dashInventoryItems', '0 items');
    updateElement('dashCriticalAlerts', 0);
    updateElement('dashTotalAlerts', '0 total alerts');
}




async function loadDashboardCharts() {
    try {
        // R√©cup√©rer les fermes
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

        // R√©cup√©rer les productions pour toutes les fermes
        let productions = [];
        if (farms.length > 0) {
            const productionPromises = farms.map(farm =>
                apiRequest(`/v1/crop-productions/farm/${farm.id}`).catch(() => [])  // ‚úÖ CORRECTION ICI
            );
            const productionArrays = await Promise.all(productionPromises);
            productions = productionArrays.flat().filter(p => p);
        }

        // Get last 6 months production data
        const last6Months = [];
        const today = new Date();
        for (let i = 5; i >= 0; i--) {
            const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
            last6Months.push({
                month: date.toLocaleString('default', { month: 'short' }),
                year: date.getFullYear(),
                value: 0
            });
        }

        productions.forEach(prod => {
            if (prod.actualYield && prod.actualHarvestDate) {
                const harvestDate = new Date(prod.actualHarvestDate);
                const monthKey = harvestDate.toLocaleString('default', { month: 'short' });
                const monthData = last6Months.find(m =>
                    m.month === monthKey && m.year === harvestDate.getFullYear()
                );
                if (monthData) {
                    monthData.value += parseFloat(prod.actualYield) || 0;
                }
            }
        });

        createProductionTrendChart(last6Months);

        // Cost breakdown chart
        let fertilizers = [];
        try {
            const fertilizerResponse = await apiRequest(`/fertilizer-usages/crop-production/${currentUser.id}`);
            fertilizers = Array.isArray(fertilizerResponse) ? fertilizerResponse : [];
        } catch (error) {
            console.warn('Error loading fertilizer data:', error);
            fertilizers = [];
        }

        let irrigations = [];
        try {
            const irrigationResponse = await apiRequest(`/irrigation/farm/${currentUser.id}`);
            irrigations = Array.isArray(irrigationResponse) ? irrigationResponse :
                         (irrigationResponse && Array.isArray(irrigationResponse.content)) ? irrigationResponse.content : [];
        } catch (error) {
            console.warn('Error loading irrigation data:', error);
            irrigations = [];
        }

        const totalFertilizerCost = fertilizers.reduce((sum, f) =>
            sum + (parseFloat(f.totalCost) || 0), 0
        );
        const totalIrrigationCost = irrigations.reduce((sum, i) =>
            sum + (parseFloat(i.totalCost) || 0), 0
        );
        const totalStorageCost = 50000;

        createCostBreakdownChart({
            fertilizer: totalFertilizerCost,
            irrigation: totalIrrigationCost,
            storage: totalStorageCost
        });

    } catch (error) {
        console.error('Error loading dashboard charts:', error);
    }
}






      /**
      * Create production trend chart
      */
      function createProductionTrendChart(data) {
      const ctx = document.getElementById('productionTrendChart');
      if (!ctx) return;

      if (charts.productionTrend) {
      charts.productionTrend.destroy();
      }

      charts.productionTrend = new Chart(ctx, {
      type: 'line',
      data: {
      labels: data.map(d => d.month),
      datasets: [{
      label: 'Production (Tonnes)',
      data: data.map(d => d.value),
      borderColor: '#22c55e',
      backgroundColor: 'rgba(34, 197, 94, 0.1)',
      borderWidth: 2,
      fill: true,
      tension: 0.4
      }]
      },
      options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
      legend: {
      display: false
      }
      },
      scales: {
      y: {
      beginAtZero: true,
      ticks: {
      callback: function(value) {
      return value + ' T';
      }
      }
      }
      }
      }
      });
      }

      /**
      * Create cost breakdown chart
      */
      function createCostBreakdownChart(costs) {
      const ctx = document.getElementById('costBreakdownChart');
      if (!ctx) return;

      if (charts.costBreakdown) {
      charts.costBreakdown.destroy();
      }

      charts.costBreakdown = new Chart(ctx, {
      type: 'doughnut',
      data: {
      labels: ['Fertilizer', 'Irrigation', 'Storage'],
      datasets: [{
      data: [costs.fertilizer, costs.irrigation, costs.storage],
      backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b'],
      borderWidth: 0
      }]
      },
      options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
      legend: {
      position: 'bottom'
      }
      }
      }
      });
      }




async function loadUpcomingTasks() {
    try {
        const container = document.getElementById('upcomingTasksList');
        if (!container) return;

        // R√©cup√©rer les fermes puis les productions
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = farmsResponse || [];

        let productions = [];
        if (farms.length > 0) {
            const productionPromises = farms.map(farm =>
                apiRequest(`/v1/crop-productions/farm/${farm.id}`).catch(() => [])  // ‚úÖ CORRECTION ICI
            );
            const productionArrays = await Promise.all(productionPromises);
            productions = productionArrays.flat();
        }

        const today = new Date();
        const upcoming = productions
            .filter(p => p.expectedHarvestDate && new Date(p.expectedHarvestDate) > today)
            .sort((a, b) => new Date(a.expectedHarvestDate) - new Date(b.expectedHarvestDate))
            .slice(0, 5);

        if (upcoming.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>No upcoming tasks</p>
                </div>
            `;
            return;
        }

        container.innerHTML = upcoming.map(prod => {
            const daysUntil = Math.ceil((new Date(prod.expectedHarvestDate) - today) / (1000 * 60 * 60 * 24));
            return `
                <div class="task-item">
                    <div class="task-icon">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <div class="task-content">
                        <div class="task-title">Harvest ${prod.cropName || 'Crop'}</div>
                        <div class="task-date">Expected in ${daysUntil} days</div>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading upcoming tasks:', error);
    }
}




async function loadRecentActivities() {
    try {
        const container = document.getElementById('recentActivitiesList');
        if (!container) return;

        const activities = [];

        // R√©cup√©rer les fermes puis les productions
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = farmsResponse || [];

        let productions = [];
        if (farms.length > 0) {
            const productionPromises = farms.map(farm =>
                apiRequest(`/v1/crop-productions/farm/${farm.id}`).catch(() => [])  // ‚úÖ CORRECTION ICI
            );
            const productionArrays = await Promise.all(productionPromises);
            productions = productionArrays.flat();
        }

        // Recent productions (limit to 5)
        const recentProductions = productions.slice(0, 5);
        recentProductions.forEach(prod => {
            activities.push({
                icon: 'fa-seedling',
                title: `${prod.productionStatus} - ${prod.cropName || 'Crop'}`,
                date: prod.plantingDate || prod.createdAt,
                type: 'production'
            });
        });

        // Sort by date
        activities.sort((a, b) => new Date(b.date) - new Date(a.date));
        const recent = activities.slice(0, 10);

        if (recent.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <p>No recent activities</p>
                </div>
            `;
            return;
        }

        container.innerHTML = recent.map(activity => `
            <div class="activity-item">
                <div class="activity-icon">
                    <i class="fas ${activity.icon}"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-title">${activity.title}</div>
                    <div class="activity-date">${formatDateTime(activity.date)}</div>
                </div>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading recent activities:', error);
    }
}






/**
 * Load critical alerts
 */
async function loadCriticalAlerts() {
    try {
        const container = document.getElementById('criticalAlertsGrid');
        if (!container) return;

        const alertsResponse = await apiRequest('/food-security-alerts/active');
        // CORRECTION: S'assurer que c'est toujours un tableau
        const allAlerts = Array.isArray(alertsResponse) ? alertsResponse : [];
        const criticalAlerts = allAlerts.filter(a =>
            ['CRITICAL', 'HIGH'].includes(a.alertLevel)
        ).slice(0, 3);

        if (criticalAlerts.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>No critical alerts at the moment</p>
                </div>
            `;
            return;
        }

        container.innerHTML = criticalAlerts.map(alert => `
            <div class="alert-card alert-${alert.alertLevel.toLowerCase()}">
                <div class="alert-header">
                    <span class="alert-badge">${alert.alertLevel}</span>
                    <span class="alert-date">${formatDate(alert.alertDate)}</span>
                </div>
                <h4 class="alert-title">${alert.alertTitle}</h4>
                <p class="alert-description">${alert.description ? alert.description.substring(0, 100) + '...' : 'No description'}</p>
            </div>
        `).join('');

    } catch (error) {
        console.error('Error loading critical alerts:', error);
        const container = document.getElementById('criticalAlertsGrid');
        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading alerts</p>
                </div>
            `;
        }
    }
}
      /**
      * Load weather widget
      */
      async function loadWeatherWidget() {
      try {
      const weatherResponse = await apiRequest('/weather-data/recent?days=1');
      const weatherData = weatherResponse && weatherResponse.length > 0 ? weatherResponse[0] : null;

      if (weatherData) {
      updateElement('weatherTemp', `${weatherData.temperature || '--'}¬∞C`);
      updateElement('weatherCondition', weatherData.weatherCondition || 'Loading...');
      updateElement('weatherHumidity', `${weatherData.humidity || '--'}%`);
      updateElement('weatherWind', `${weatherData.windSpeed || '--'} km/h`);
      updateElement('weatherRainfall', `${weatherData.rainfall || '--'} mm`);
      updateElement('weatherLocation', `
      <i class="fas fa-map-marker-alt"></i>
      ${weatherData.location || 'Location'}
      `);
      }

      } catch (error) {
      console.error('Error loading weather widget:', error);
      }
      }

      // ============================================================================
      // FARMS MODULE
      // ============================================================================

      /**
      * Load farms data
      */
      async function loadFarmsData() {
      try {
      showLoading();

      const response = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
      const farms = response || [];

      // Update statistics
      const totalFarms = farms.length;
      const totalArea = farms.reduce((sum, farm) => sum + (parseFloat(farm.sizeHectares) || 0), 0);
      const irrigatedFarms = farms.filter(f => f.irrigationSystem !== 'RAIN_FED').length;
      const activeFarms = farms.filter(f => f.isActive !== false).length;

      updateElement('farmsTotalCount', totalFarms);
      updateElement('farmsTotalArea', `${totalArea.toFixed(2)} ha`);
      updateElement('farmsIrrigated', irrigatedFarms);
      updateElement('farmsActive', activeFarms);

      // Display farms grid
      displayFarmsGrid(farms);

      } catch (error) {
      console.error('Error loading farms:', error);
      showToast('Error loading farms data', 'error');
      } finally {
      hideLoading();
      }
      }

      /**
      * Display farms grid
      */
      function displayFarmsGrid(farms) {
      const container = document.getElementById('farmsGrid');
      if (!container) return;

      if (farms.length === 0) {
      container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-map-marked-alt"></i>
        <p>No farms registered yet</p>
        <button class="btn btn-primary" onclick="openAddFarmModal()">
          <i class="fas fa-plus"></i>
          Add Your First Farm
        </button>
      </div>
      `;
      return;
      }

      container.innerHTML = farms.map(farm => `
      <div class="farm-card">
        <div class="farm-header">
          <h3 class="farm-name">${farm.farmName}</h3>
          <div class="farm-actions">
            <button class="btn-icon" onclick="editFarm('${farm.id}')" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon" onclick="viewFarmDetails('${farm.id}')" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
          </div>
        </div>
        <div class="farm-info">
          <div class="farm-info-item">
            <i class="fas fa-map-marker-alt"></i>
            <span>${farm.location || 'N/A'}</span>
          </div>
          <div class="farm-info-item">
            <i class="fas fa-ruler-combined"></i>
            <span>${farm.sizeHectares} hectares</span>
          </div>
          <div class="farm-info-item">
            <i class="fas fa-mountain"></i>
            <span>${farm.soilType || 'N/A'}</span>
          </div>
          <div class="farm-info-item">
            <i class="fas fa-tint"></i>
            <span>${formatIrrigationSystem(farm.irrigationSystem)}</span>
          </div>
          ${farm.electricityAvailable ?
          '<div class="farm-badge"><i class="fas fa-bolt"></i> Electricity</div>' : ''
          }
        </div>
        <div class="farm-coordinates">
          <small>
            <i class="fas fa-map-pin"></i>
            ${farm.latitude}, ${farm.longitude}
          </small>
        </div>
      </div>
      `).join('');
      }

      /**
      * Format irrigation system
      */
      function formatIrrigationSystem(system) {
      const systems = {
      'RAIN_FED': 'Rain Fed',
      'SPRINKLER': 'Sprinkler',
      'DRIP': 'Drip Irrigation',
      'FLOOD': 'Flood Irrigation',
      'FURROW': 'Furrow Irrigation'
      };
      return systems[system] || system;
      }







/**
 * ============================================
 * FARM MANAGEMENT - FIXED VERSION
 * ============================================
 * Corrections apport√©es:
 * 1. Mapping correct des champs: sizeHectares -> farmSize
 * 2. Validation am√©lior√©e
 * 3. Gestion des erreurs optimis√©e
 * 4. Support complet de tous les champs du mod√®le backend
 */













/**
 * Open add farm modal - VERSION COMPL√àTE CORRIG√âE
 */
function openAddFarmModal() {
  const modalHTML = `
    <div class="modal-overlay show" id="farmModal" onclick="if(event.target === this) closeFarmModal()">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-map-marked-alt"></i>
            Add New Farm
          </h3>
          <button class="modal-close" onclick="closeFarmModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="addFarmForm">
            <div class="form-grid">

              <!-- Farm Name -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-tag"></i>
                  Farm Name *
                </label>
                <input
                  type="text"
                  class="form-input"
                  name="farmName"
                  placeholder="e.g., Green Valley Farm"
                  required
                  minlength="3"
                  maxlength="100"
                >
                <small class="form-hint">Between 3-100 characters</small>
              </div>

              <!-- Farm Code -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-barcode"></i>
                  Farm Code
                </label>
                <input
                  type="text"
                  class="form-input"
                  name="farmCode"
                  placeholder="Auto-generated if empty"
                  maxlength="20"
                >
                <small class="form-hint">Leave empty to auto-generate</small>
              </div>

              <!-- Size (Hectares) -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-ruler-combined"></i>
                  Size (Hectares) *
                </label>
                <input
                  type="number"
                  class="form-input"
                  name="farmSize"
                  step="0.01"
                  min="0.01"
                  max="999999.99"
                  placeholder="e.g., 5.50"
                  required
                >
                <small class="form-hint">Must be greater than 0</small>
              </div>

              <!-- Location -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-map-marker-alt"></i>
                  Location
                </label>
                <input
                  type="text"
                  class="form-input"
                  name="location"
                  placeholder="e.g., Kigali, Gasabo District"
                  maxlength="200"
                >
                <small class="form-hint">Optional: City, District, Province</small>
              </div>

              <!-- Latitude -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-globe"></i>
                  Latitude *
                </label>
                <input
                  type="number"
                  class="form-input"
                  name="latitude"
                  step="0.000001"
                  min="-90"
                  max="90"
                  placeholder="e.g., -1.9536"
                  required
                >
                <small class="form-hint">Between -90 and 90</small>
              </div>

              <!-- Longitude -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-globe-americas"></i>
                  Longitude *
                </label>
                <input
                  type="number"
                  class="form-input"
                  name="longitude"
                  step="0.000001"
                  min="-180"
                  max="180"
                  placeholder="e.g., 30.0606"
                  required
                >
                <small class="form-hint">Between -180 and 180</small>
              </div>

              <!-- Altitude (Optional) -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-mountain"></i>
                  Altitude (meters)
                </label>
                <input
                  type="number"
                  class="form-input"
                  name="altitude"
                  step="0.01"
                  min="0"
                  placeholder="e.g., 1500"
                >
                <small class="form-hint">Optional: Elevation in meters</small>
              </div>

              <!-- Soil Type -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-layer-group"></i>
                  Soil Type *
                </label>
                <select class="form-select" name="soilType" required>
                  <option value="">Select Soil Type</option>
                  <option value="Clay">üü§ Clay</option>
                  <option value="Loam">üü´ Loam</option>
                  <option value="Sand">üü° Sand</option>
                  <option value="Silt">‚ö™ Silt</option>
                  <option value="Sandy Loam">üü® Sandy Loam</option>
                  <option value="Clay Loam">üü´ Clay Loam</option>
                  <option value="Silty Clay">üü§ Silty Clay</option>
                  <option value="Sandy Clay">üüß Sandy Clay</option>
                </select>
              </div>

              <!-- Irrigation System -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-tint"></i>
                  Irrigation System
                </label>
                <select class="form-select" name="irrigationSystem">
                  <option value="RAIN_FED">üåßÔ∏è Rain Fed (Default)</option>
                  <option value="SPRINKLER">üí¶ Sprinkler System</option>
                  <option value="DRIP">üíß Drip Irrigation</option>
                  <option value="FLOOD">üåä Flood Irrigation</option>
                  <option value="MANUAL">‚úã Manual Irrigation</option>
                </select>
              </div>

              <!-- Topography -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-chart-area"></i>
                  Topography
                </label>
                <select class="form-select" name="topography">
                  <option value="">Select Topography (Optional)</option>
                  <option value="Flat">‚¨ú Flat Terrain</option>
                  <option value="Gentle Slope">üìê Gentle Slope (0-5¬∞)</option>
                  <option value="Moderate Slope">‚õ∞Ô∏è Moderate Slope (5-15¬∞)</option>
                  <option value="Steep Slope">üèîÔ∏è Steep Slope (15-30¬∞)</option>
                  <option value="Hilly">üóª Hilly Terrain</option>
                  <option value="Valley">‚õ∞Ô∏è Valley</option>
                  <option value="Terraced">üèûÔ∏è Terraced Land</option>
                </select>
              </div>

              <!-- Water Source -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-water"></i>
                  Water Source
                </label>
                <input
                  type="text"
                  class="form-input"
                  name="waterSource"
                  placeholder="e.g., River, Well, Borehole"
                  maxlength="100"
                >
                <small class="form-hint">Optional: Main water source</small>
              </div>

              <!-- Road Access Quality -->
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-road"></i>
                  Road Access Quality
                </label>
                <select class="form-select" name="roadAccessQuality">
                  <option value="MODERATE">üöó Moderate (Default)</option>
                  <option value="GOOD">‚úÖ Good Access</option>
                  <option value="POOR">‚ö†Ô∏è Poor Access</option>
                </select>
              </div>

              <!-- Electricity Available -->
              <div class="form-group form-group-full">
                <div class="form-checkbox-container">
                  <label class="form-checkbox">
                    <input type="checkbox" name="electricityAvailable">
                    <span>
                      <i class="fas fa-bolt"></i>
                      Electricity Available on this Farm
                    </span>
                  </label>
                  <small class="form-hint">Check if the farm has electrical power access</small>
                </div>
              </div>

            </div>

            <!-- ‚úÖ BUTTONS NOW INSIDE FORM -->
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="closeFarmModal()">
                <i class="fas fa-times"></i>
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Save Farm
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;

  // Ajouter l'√©couteur d'√©v√©nement pour le formulaire
  const form = document.getElementById('addFarmForm');
  if (form) {
    form.addEventListener('submit', handleAddFarm);
  }

  // Ajouter validation en temps r√©el
  addFormValidation();
}












/**
 * Ajouter validation en temps r√©el aux champs du formulaire
 */
function addFormValidation() {
  const form = document.getElementById('addFarmForm');
  if (!form) return;

  // Validation pour la latitude
  const latitudeInput = form.querySelector('input[name="latitude"]');
  if (latitudeInput) {
    latitudeInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (isNaN(value)) {
        this.setCustomValidity('Please enter a valid number');
      } else if (value < -90 || value > 90) {
        this.setCustomValidity('Latitude must be between -90 and 90');
      } else {
        this.setCustomValidity('');
      }
    });
  }

  // Validation pour la longitude
  const longitudeInput = form.querySelector('input[name="longitude"]');
  if (longitudeInput) {
    longitudeInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (isNaN(value)) {
        this.setCustomValidity('Please enter a valid number');
      } else if (value < -180 || value > 180) {
        this.setCustomValidity('Longitude must be between -180 and 180');
      } else {
        this.setCustomValidity('');
      }
    });
  }

  // Validation pour la taille (farmSize)
  const sizeInput = form.querySelector('input[name="farmSize"]');
  if (sizeInput) {
    sizeInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (isNaN(value)) {
        this.setCustomValidity('Please enter a valid number');
      } else if (value <= 0) {
        this.setCustomValidity('Farm size must be greater than 0');
      } else if (value > 999999.99) {
        this.setCustomValidity('Farm size is too large');
      } else {
        this.setCustomValidity('');
      }
    });
  }

  // Validation pour l'altitude
  const altitudeInput = form.querySelector('input[name="altitude"]');
  if (altitudeInput) {
    altitudeInput.addEventListener('input', function() {
      const value = parseFloat(this.value);
      if (this.value && (isNaN(value) || value < 0)) {
        this.setCustomValidity('Altitude must be a positive number');
      } else {
        this.setCustomValidity('');
      }
    });
  }

  // Auto-g√©n√©ration du Farm Code
  const farmNameInput = form.querySelector('input[name="farmName"]');
  const farmCodeInput = form.querySelector('input[name="farmCode"]');

  if (farmNameInput && farmCodeInput) {
    farmNameInput.addEventListener('blur', function() {
      if (!farmCodeInput.value) {
        const name = this.value.trim();
        if (name) {
          const year = new Date().getFullYear();
          const prefix = name.substring(0, 3).toUpperCase().replace(/[^A-Z]/g, 'X');
          const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
          const code = `FARM-${year}-${prefix}${random}`;
          farmCodeInput.value = code;
        }
      }
    });
  }
}

/**
 * Handle add farm - VERSION CORRIG√âE
 * FIX: Mapping correct des champs selon le mod√®le backend
 */
async function handleAddFarm(e) {
  e.preventDefault();

  const formData = new FormData(e.target);

  // CORRECTION PRINCIPALE: Utiliser les bons noms de champs
  const farmData = {
    farmerId: currentUser.id,
    farmName: formData.get('farmName').trim(),
    farmCode: formData.get('farmCode')?.trim() || null,
    farmSize: parseFloat(formData.get('farmSize')), // CORRIG√â: √©tait "sizeHectares"
    soilType: formData.get('soilType'),
    latitude: parseFloat(formData.get('latitude')),
    longitude: parseFloat(formData.get('longitude')),
    altitude: formData.get('altitude') ? parseFloat(formData.get('altitude')) : null,
    irrigationSystem: formData.get('irrigationSystem') || 'RAIN_FED',
    topography: formData.get('topography') || null,
    waterSource: formData.get('waterSource')?.trim() || null,
    electricityAvailable: formData.get('electricityAvailable') === 'on',
    roadAccessQuality: formData.get('roadAccessQuality') || 'MODERATE'
  };

  // Validation c√¥t√© client
  const validationErrors = validateFarmData(farmData);
  if (validationErrors.length > 0) {
    showToast('‚ùå Validation errors: ' + validationErrors.join(', '), 'error');
    return;
  }

  try {
    showLoading();

    console.log('üì§ Sending farm data:', farmData);

    const response = await apiRequest('/farms', {
      method: 'POST',
      body: JSON.stringify(farmData)
    });

    console.log('‚úÖ Farm created:', response);
    showToast('‚úÖ Farm added successfully!', 'success');
    closeFarmModal();

    // Recharger les donn√©es
    await loadFarmsData();

  } catch (error) {
    console.error('‚ùå Error adding farm:', error);

    // Gestion d'erreur am√©lior√©e
    let errorMessage = 'Error adding farm';

    if (error.message.includes('Farm size is required')) {
      errorMessage = 'Farm size is required and must be greater than 0';
    } else if (error.message.includes('validation')) {
      errorMessage = 'Validation error: Please check all required fields';
    } else if (error.message.includes('duplicate')) {
      errorMessage = 'Farm code already exists. Please use a different code';
    } else {
      errorMessage = error.message;
    }

    showToast('‚ùå ' + errorMessage, 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Valider les donn√©es du formulaire
 */
function validateFarmData(data) {
  const errors = [];

  // Validations obligatoires
  if (!data.farmName || data.farmName.length < 3) {
    errors.push('Farm name must be at least 3 characters');
  }
  if (!data.farmSize || data.farmSize <= 0) {
    errors.push('Farm size must be greater than 0');
  }
  if (!data.soilType) {
    errors.push('Soil type is required');
  }
  if (!data.latitude || data.latitude < -90 || data.latitude > 90) {
    errors.push('Valid latitude is required (-90 to 90)');
  }
  if (!data.longitude || data.longitude < -180 || data.longitude > 180) {
    errors.push('Valid longitude is required (-180 to 180)');
  }

  // Validations optionnelles
  if (data.altitude !== null && data.altitude < 0) {
    errors.push('Altitude must be positive');
  }
  if (data.farmCode && data.farmCode.length > 20) {
    errors.push('Farm code must not exceed 20 characters');
  }

  return errors;
}

/**
 * Open edit farm modal
 */
async function openEditFarmModal(farmId) {
  try {
    showLoading();

    const farm = await apiRequest(`/farms/${farmId}`, { method: 'GET' });

    const modalHTML = `
      <div class="modal-overlay show" id="farmModal" onclick="if(event.target === this) closeFarmModal()">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fas fa-edit"></i>
              Edit Farm: ${farm.farmName}
            </h3>
            <button class="modal-close" onclick="closeFarmModal()" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <form id="editFarmForm" data-farm-id="${farm.id}">
              <div class="form-grid">

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-tag"></i>
                    Farm Name *
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="farmName"
                    value="${farm.farmName}"
                    required
                    minlength="3"
                    maxlength="100"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-barcode"></i>
                    Farm Code
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="farmCode"
                    value="${farm.farmCode || ''}"
                    maxlength="20"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-ruler-combined"></i>
                    Size (Hectares) *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="farmSize"
                    value="${farm.farmSize}"
                    step="0.01"
                    min="0.01"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-globe"></i>
                    Latitude *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="latitude"
                    value="${farm.latitude}"
                    step="0.000001"
                    min="-90"
                    max="90"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-globe-americas"></i>
                    Longitude *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="longitude"
                    value="${farm.longitude}"
                    step="0.000001"
                    min="-180"
                    max="180"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-mountain"></i>
                    Altitude (meters)
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="altitude"
                    value="${farm.altitude || ''}"
                    step="0.01"
                    min="0"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-layer-group"></i>
                    Soil Type *
                  </label>
                  <select class="form-select" name="soilType" required>
                    <option value="Clay" ${farm.soilType === 'Clay' ? 'selected' : ''}>üü§ Clay</option>
                    <option value="Loam" ${farm.soilType === 'Loam' ? 'selected' : ''}>üü´ Loam</option>
                    <option value="Sand" ${farm.soilType === 'Sand' ? 'selected' : ''}>üü° Sand</option>
                    <option value="Silt" ${farm.soilType === 'Silt' ? 'selected' : ''}>‚ö™ Silt</option>
                    <option value="Sandy Loam" ${farm.soilType === 'Sandy Loam' ? 'selected' : ''}>üü® Sandy Loam</option>
                    <option value="Clay Loam" ${farm.soilType === 'Clay Loam' ? 'selected' : ''}>üü´ Clay Loam</option>
                    <option value="Silty Clay" ${farm.soilType === 'Silty Clay' ? 'selected' : ''}>üü§ Silty Clay</option>
                    <option value="Sandy Clay" ${farm.soilType === 'Sandy Clay' ? 'selected' : ''}>üüß Sandy Clay</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-tint"></i>
                    Irrigation System
                  </label>
                  <select class="form-select" name="irrigationSystem">
                    <option value="RAIN_FED" ${farm.irrigationSystem === 'RAIN_FED' ? 'selected' : ''}>üåßÔ∏è Rain Fed</option>
                    <option value="SPRINKLER" ${farm.irrigationSystem === 'SPRINKLER' ? 'selected' : ''}>üí¶ Sprinkler</option>
                    <option value="DRIP" ${farm.irrigationSystem === 'DRIP' ? 'selected' : ''}>üíß Drip</option>
                    <option value="FLOOD" ${farm.irrigationSystem === 'FLOOD' ? 'selected' : ''}>üåä Flood</option>
                    <option value="MANUAL" ${farm.irrigationSystem === 'MANUAL' ? 'selected' : ''}>‚úã Manual</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-chart-area"></i>
                    Topography
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="topography"
                    value="${farm.topography || ''}"
                    maxlength="50"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-water"></i>
                    Water Source
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="waterSource"
                    value="${farm.waterSource || ''}"
                    maxlength="100"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-road"></i>
                    Road Access Quality
                  </label>
                  <select class="form-select" name="roadAccessQuality">
                    <option value="GOOD" ${farm.roadAccessQuality === 'GOOD' ? 'selected' : ''}>‚úÖ Good</option>
                    <option value="MODERATE" ${farm.roadAccessQuality === 'MODERATE' ? 'selected' : ''}>üöó Moderate</option>
                    <option value="POOR" ${farm.roadAccessQuality === 'POOR' ? 'selected' : ''}>‚ö†Ô∏è Poor</option>
                  </select>
                </div>

                <div class="form-group form-group-full">
                  <div class="form-checkbox-container">
                    <label class="form-checkbox">
                      <input type="checkbox" name="electricityAvailable" ${farm.electricityAvailable ? 'checked' : ''}>
                      <span>
                        <i class="fas fa-bolt"></i>
                        Electricity Available
                      </span>
                    </label>
                  </div>
                </div>

              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeFarmModal()">
                  <i class="fas fa-times"></i>
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  Update Farm
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;

    const form = document.getElementById('editFarmForm');
    if (form) {
      form.addEventListener('submit', handleEditFarm);
    }

    addFormValidation();

  } catch (error) {
    console.error('Error loading farm data:', error);
    showToast('‚ùå Error loading farm data', 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Handle edit farm
 */
async function handleEditFarm(e) {
  e.preventDefault();

  const farmId = e.target.dataset.farmId;
  const formData = new FormData(e.target);

  const farmData = {
    farmerId: currentUser.id,
    farmName: formData.get('farmName').trim(),
    farmCode: formData.get('farmCode')?.trim() || null,
    farmSize: parseFloat(formData.get('farmSize')),
    soilType: formData.get('soilType'),
    latitude: parseFloat(formData.get('latitude')),
    longitude: parseFloat(formData.get('longitude')),
    altitude: formData.get('altitude') ? parseFloat(formData.get('altitude')) : null,
    irrigationSystem: formData.get('irrigationSystem') || 'RAIN_FED',
    topography: formData.get('topography')?.trim() || null,
    waterSource: formData.get('waterSource')?.trim() || null,
    electricityAvailable: formData.get('electricityAvailable') === 'on',
    roadAccessQuality: formData.get('roadAccessQuality') || 'MODERATE'
  };

  const validationErrors = validateFarmData(farmData);
  if (validationErrors.length > 0) {
    showToast('‚ùå Validation errors: ' + validationErrors.join(', '), 'error');
    return;
  }

  try {
    showLoading();

    await apiRequest(`/farms/${farmId}`, {
      method: 'PUT',
      body: JSON.stringify(farmData)
    });

    showToast('‚úÖ Farm updated successfully!', 'success');
    closeFarmModal();
    await loadFarmsData();

  } catch (error) {
    console.error('Error updating farm:', error);
    showToast('‚ùå Error updating farm: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Delete farm with confirmation
 */
async function deleteFarm(farmId, farmName) {
  if (!confirm(`Are you sure you want to delete "${farmName}"?\n\nThis action cannot be undone.`)) {
    return;
  }

  try {
    showLoading();

    await apiRequest(`/farms/${farmId}`, {
      method: 'DELETE'
    });

    showToast('‚úÖ Farm deleted successfully!', 'success');
    await loadFarmsData();

  } catch (error) {
    console.error('Error deleting farm:', error);
    showToast('‚ùå Error deleting farm: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Close farm modal
 */
function closeFarmModal() {
  const modal = document.getElementById('farmModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}

/**
 * Load farms data
 */
async function loadFarmsData() {
  try {
    showLoading();

    const farms = await apiRequest(`/farms/farmer/${currentUser.id}/all`, {
      method: 'GET'
    });

    console.log('‚úÖ Farms loaded:', farms);

    // Afficher les fermes dans l'interface
    displayFarms(farms);
    updateFarmStatistics(farms);

  } catch (error) {
    console.error('Error loading farms:', error);
    showToast('‚ùå Error loading farms', 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Display farms in the UI
 */
function displayFarms(farms) {
  const container = document.getElementById('farmsContainer');
  if (!container) return;

  if (!farms || farms.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-tractor"></i>
        </div>
        <h3>No Farms Yet</h3>
        <p>Start by adding your first farm to begin managing your agricultural operations.</p>
        <button class="btn btn-primary" onclick="openAddFarmModal()">
          <i class="fas fa-plus"></i>
          Add Your First Farm
        </button>
      </div>
    `;
    return;
  }

  const farmsHTML = farms.map(farm => `
    <div class="farm-card" data-farm-id="${farm.id}">
      <div class="farm-card-header">
        <div class="farm-header-left">
          <h3 class="farm-name">
            <i class="fas fa-map-marked-alt"></i>
            ${farm.farmName}
          </h3>
          ${farm.farmCode ? `<span class="farm-code">${farm.farmCode}</span>` : ''}
        </div>
        <div class="farm-actions">
          <button class="btn-icon" onclick="openEditFarmModal('${farm.id}')" title="Edit Farm">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn-icon btn-danger" onclick="deleteFarm('${farm.id}', '${farm.farmName}')" title="Delete Farm">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>

      <div class="farm-card-body">
        <div class="farm-info-grid">

          <div class="farm-info-item">
            <div class="info-icon">
              <i class="fas fa-ruler-combined"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Size</span>
              <span class="info-value">${farm.farmSize} ha</span>
            </div>
          </div>

          <div class="farm-info-item">
            <div class="info-icon">
              <i class="fas fa-layer-group"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Soil Type</span>
              <span class="info-value">${farm.soilType}</span>
            </div>
          </div>

          <div class="farm-info-item">
            <div class="info-icon">
              <i class="fas fa-tint"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Irrigation</span>
              <span class="info-value">${formatIrrigationSystem(farm.irrigationSystem)}</span>
            </div>
          </div>

          <div class="farm-info-item">
            <div class="info-icon">
              <i class="fas fa-globe"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Coordinates</span>
              <span class="info-value">${farm.latitude.toFixed(4)}, ${farm.longitude.toFixed(4)}</span>
            </div>
          </div>

          ${farm.altitude ? `
          <div class="farm-info-item">
            <div class="info-icon">
              <i class="fas fa-mountain"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Altitude</span>
              <span class="info-value">${farm.altitude} m</span>
            </div>
          </div>
          ` : ''}

          ${farm.topography ? `
          <div class="farm-info-item">
            <div class="info-icon">
              <i class="fas fa-chart-area"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Topography</span>
              <span class="info-value">${farm.topography}</span>
            </div>
          </div>
          ` : ''}

          ${farm.waterSource ? `
          <div class="farm-info-item">
            <div class="info-icon">
              <i class="fas fa-water"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Water Source</span>
              <span class="info-value">${farm.waterSource}</span>
            </div>
          </div>
          ` : ''}

          <div class="farm-info-item">
            <div class="info-icon">
              <i class="fas fa-road"></i>
            </div>
            <div class="info-content">
              <span class="info-label">Road Access</span>
              <span class="info-value">${formatRoadAccess(farm.roadAccessQuality)}</span>
            </div>
          </div>

        </div>

        <div class="farm-badges">
          <span class="badge ${farm.electricityAvailable ? 'badge-success' : 'badge-secondary'}">
            <i class="fas fa-bolt"></i>
            ${farm.electricityAvailable ? 'Electricity Available' : 'No Electricity'}
          </span>
          <span class="badge badge-info">
            <i class="fas fa-chart-pie"></i>
            ${getSizeCategory(farm.farmSize)}
          </span>
        </div>
      </div>

      <div class="farm-card-footer">
        <small class="text-muted">
          <i class="fas fa-clock"></i>
          Created: ${formatDate(farm.createdAt)}
        </small>
        ${farm.updatedAt && farm.updatedAt !== farm.createdAt ? `
        <small class="text-muted">
          <i class="fas fa-sync"></i>
          Updated: ${formatDate(farm.updatedAt)}
        </small>
        ` : ''}
      </div>
    </div>
  `).join('');

  container.innerHTML = farmsHTML;
}

/**
 * Update farm statistics
 */
function updateFarmStatistics(farms) {
  const statsContainer = document.getElementById('farmStats');
  if (!statsContainer) return;

  const totalFarms = farms.length;
  const totalArea = farms.reduce((sum, farm) => sum + parseFloat(farm.farmSize), 0);
  const avgSize = totalFarms > 0 ? (totalArea / totalFarms).toFixed(2) : 0;
  const withElectricity = farms.filter(f => f.electricityAvailable).length;

  // Soil type distribution
  const soilTypes = {};
  farms.forEach(farm => {
    soilTypes[farm.soilType] = (soilTypes[farm.soilType] || 0) + 1;
  });
  const mostCommonSoil = Object.entries(soilTypes).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';

  // Irrigation distribution
  const irrigationTypes = {};
  farms.forEach(farm => {
    irrigationTypes[farm.irrigationSystem] = (irrigationTypes[farm.irrigationSystem] || 0) + 1;
  });

  // Size categories
  const smallFarms = farms.filter(f => parseFloat(f.farmSize) <= 2).length;
  const mediumFarms = farms.filter(f => parseFloat(f.farmSize) > 2 && parseFloat(f.farmSize) <= 10).length;
  const largeFarms = farms.filter(f => parseFloat(f.farmSize) > 10).length;

  const statsHTML = `
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon primary">
          <i class="fas fa-tractor"></i>
        </div>
        <div class="stat-content">
          <span class="stat-label">Total Farms</span>
          <span class="stat-value">${totalFarms}</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon success">
          <i class="fas fa-expand-arrows-alt"></i>
        </div>
        <div class="stat-content">
          <span class="stat-label">Total Area</span>
          <span class="stat-value">${totalArea.toFixed(2)} ha</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon info">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
          <span class="stat-label">Average Size</span>
          <span class="stat-value">${avgSize} ha</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon warning">
          <i class="fas fa-bolt"></i>
        </div>
        <div class="stat-content">
          <span class="stat-label">With Electricity</span>
          <span class="stat-value">${withElectricity} / ${totalFarms}</span>
        </div>
      </div>
    </div>

    <div class="stats-details">
      <div class="stats-section">
        <h4><i class="fas fa-chart-pie"></i> Farm Size Distribution</h4>
        <div class="distribution-bars">
          <div class="dist-item">
            <span class="dist-label">Small (‚â§2 ha)</span>
            <div class="dist-bar">
              <div class="dist-fill" style="width: ${totalFarms > 0 ? (smallFarms / totalFarms * 100) : 0}%"></div>
            </div>
            <span class="dist-value">${smallFarms}</span>
          </div>
          <div class="dist-item">
            <span class="dist-label">Medium (2-10 ha)</span>
            <div class="dist-bar">
              <div class="dist-fill" style="width: ${totalFarms > 0 ? (mediumFarms / totalFarms * 100) : 0}%"></div>
            </div>
            <span class="dist-value">${mediumFarms}</span>
          </div>
          <div class="dist-item">
            <span class="dist-label">Large (>10 ha)</span>
            <div class="dist-bar">
              <div class="dist-fill" style="width: ${totalFarms > 0 ? (largeFarms / totalFarms * 100) : 0}%"></div>
            </div>
            <span class="dist-value">${largeFarms}</span>
          </div>
        </div>
      </div>

      <div class="stats-section">
        <h4><i class="fas fa-layer-group"></i> Most Common Soil Type</h4>
        <p class="highlight-value">${mostCommonSoil}</p>
      </div>

      <div class="stats-section">
        <h4><i class="fas fa-tint"></i> Irrigation Systems</h4>
        <div class="badges-list">
          ${Object.entries(irrigationTypes).map(([type, count]) => `
            <span class="badge badge-info">
              ${formatIrrigationSystem(type)}: ${count}
            </span>
          `).join('')}
        </div>
      </div>
    </div>
  `;

  statsContainer.innerHTML = statsHTML;
}

/**
 * Helper: Format irrigation system
 */
function formatIrrigationSystem(system) {
  const systems = {
    'RAIN_FED': 'üåßÔ∏è Rain Fed',
    'SPRINKLER': 'üí¶ Sprinkler',
    'DRIP': 'üíß Drip',
    'FLOOD': 'üåä Flood',
    'MANUAL': '‚úã Manual'
  };
  return systems[system] || system;
}

/**
 * Helper: Format road access
 */
function formatRoadAccess(quality) {
  const qualities = {
    'GOOD': '‚úÖ Good',
    'MODERATE': 'üöó Moderate',
    'POOR': '‚ö†Ô∏è Poor'
  };
  return qualities[quality] || quality;
}

/**
 * Helper: Get size category
 */
function getSizeCategory(size) {
  const sizeNum = parseFloat(size);
  if (sizeNum <= 2) return 'Small Farm';
  if (sizeNum <= 10) return 'Medium Farm';
  return 'Large Farm';
}

/**
 * Helper: Format date
 */
function formatDate(dateString) {
  if (!dateString) return 'N/A';

  const date = new Date(dateString);
  const options = {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  };

  return date.toLocaleDateString('en-US', options);
}

/**
 * View farm details
 */
async function viewFarmDetails(farmId) {
  try {
    showLoading();

    const farm = await apiRequest(`/farms/${farmId}`, { method: 'GET' });

    const modalHTML = `
      <div class="modal-overlay show" id="farmDetailsModal" onclick="if(event.target === this) closeDetailsModal()">
        <div class="modal-container modal-large">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fas fa-info-circle"></i>
              Farm Details: ${farm.farmName}
            </h3>
            <button class="modal-close" onclick="closeDetailsModal()" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="details-grid">
              <div class="details-section">
                <h4><i class="fas fa-info"></i> Basic Information</h4>
                <dl class="details-list">
                  <dt>Farm Name:</dt>
                  <dd>${farm.farmName}</dd>

                  <dt>Farm Code:</dt>
                  <dd>${farm.farmCode || 'N/A'}</dd>

                  <dt>Size:</dt>
                  <dd>${farm.farmSize} hectares (${getSizeCategory(farm.farmSize)})</dd>

                  <dt>Soil Type:</dt>
                  <dd>${farm.soilType}</dd>
                </dl>
              </div>

              <div class="details-section">
                <h4><i class="fas fa-map-marker-alt"></i> Location</h4>
                <dl class="details-list">
                  <dt>Latitude:</dt>
                  <dd>${farm.latitude}¬∞</dd>

                  <dt>Longitude:</dt>
                  <dd>${farm.longitude}¬∞</dd>

                  ${farm.altitude ? `
                  <dt>Altitude:</dt>
                  <dd>${farm.altitude} meters</dd>
                  ` : ''}

                  ${farm.topography ? `
                  <dt>Topography:</dt>
                  <dd>${farm.topography}</dd>
                  ` : ''}
                </dl>
              </div>

              <div class="details-section">
                <h4><i class="fas fa-tools"></i> Infrastructure</h4>
                <dl class="details-list">
                  <dt>Irrigation System:</dt>
                  <dd>${formatIrrigationSystem(farm.irrigationSystem)}</dd>

                  ${farm.waterSource ? `
                  <dt>Water Source:</dt>
                  <dd>${farm.waterSource}</dd>
                  ` : ''}

                  <dt>Electricity:</dt>
                  <dd>
                    <span class="badge ${farm.electricityAvailable ? 'badge-success' : 'badge-secondary'}">
                      ${farm.electricityAvailable ? '‚úÖ Available' : '‚ùå Not Available'}
                    </span>
                  </dd>

                  <dt>Road Access:</dt>
                  <dd>${formatRoadAccess(farm.roadAccessQuality)}</dd>
                </dl>
              </div>

              <div class="details-section">
                <h4><i class="fas fa-clock"></i> Timestamps</h4>
                <dl class="details-list">
                  <dt>Created:</dt>
                  <dd>${formatDate(farm.createdAt)}</dd>

                  <dt>Last Updated:</dt>
                  <dd>${formatDate(farm.updatedAt)}</dd>
                </dl>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDetailsModal()">
              <i class="fas fa-times"></i>
              Close
            </button>
            <button type="button" class="btn btn-primary" onclick="closeDetailsModal(); openEditFarmModal('${farm.id}')">
              <i class="fas fa-edit"></i>
              Edit Farm
            </button>
          </div>
        </div>
      </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;

  } catch (error) {
    console.error('Error loading farm details:', error);
    showToast('‚ùå Error loading farm details', 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Close details modal
 */
function closeDetailsModal() {
  const modal = document.getElementById('farmDetailsModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}

/**
 * Export farms to CSV
 */
function exportFarmsToCSV(farms) {
  if (!farms || farms.length === 0) {
    showToast('‚ö†Ô∏è No farms to export', 'warning');
    return;
  }

  const headers = [
    'Farm Name', 'Farm Code', 'Size (ha)', 'Soil Type',
    'Latitude', 'Longitude', 'Altitude (m)', 'Irrigation System',
    'Topography', 'Water Source', 'Electricity', 'Road Access',
    'Created At', 'Updated At'
  ];

  const rows = farms.map(farm => [
    farm.farmName,
    farm.farmCode || '',
    farm.farmSize,
    farm.soilType,
    farm.latitude,
    farm.longitude,
    farm.altitude || '',
    farm.irrigationSystem,
    farm.topography || '',
    farm.waterSource || '',
    farm.electricityAvailable ? 'Yes' : 'No',
    farm.roadAccessQuality,
    farm.createdAt,
    farm.updatedAt
  ]);

  let csvContent = headers.join(',') + '\n';
  rows.forEach(row => {
    csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
  });

  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `farms_export_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);

  showToast('‚úÖ Farms exported successfully!', 'success');
}

/**
 * Initialize farms module on page load
 */
document.addEventListener('DOMContentLoaded', function() {
  if (window.location.pathname.includes('farmer') || window.location.pathname.includes('farms')) {
    loadFarmsData();
  }
});










      /**
      * Edit farm
      */
      async function editFarm(farmId) {
      try {
      showLoading();

      const farm = await apiRequest(`/farms/${farmId}`);

      // Open modal with farm data
      openEditFarmModal(farm);

      } catch (error) {
      console.error('Error loading farm details:', error);
      showToast('Error loading farm details', 'error');
      } finally {
      hideLoading();
      }
      }

      /**
      * Open edit farm modal
      */
      function openEditFarmModal(farm) {
      const modalHTML = `
      <div class="modal-overlay" id="farmModal">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">Edit Farm</h3>
            <button class="modal-close" onclick="closeFarmModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <form id="editFarmForm">
              <input type="hidden" name="farmId" value="${farm.id}">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">Farm Name *</label>
                  <input type="text" class="form-input" name="farmName" value="${farm.farmName}" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Farm Code *</label>
                  <input type="text" class="form-input" name="farmCode" value="${farm.farmCode}" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Size (Hectares) *</label>
                  <input type="number" class="form-input" name="sizeHectares" value="${farm.sizeHectares}" step="0.01" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Location *</label>
                  <input type="text" class="form-input" name="location" value="${farm.location}" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Latitude *</label>
                  <input type="number" class="form-input" name="latitude" value="${farm.latitude}" step="0.000001" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Longitude *</label>
                  <input type="number" class="form-input" name="longitude" value="${farm.longitude}" step="0.000001" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Soil Type *</label>
                  <select class="form-select" name="soilType" required>
                    <option value="">Select Soil Type</option>
                    <option value="Clay" ${farm.soilType === 'Clay' ? 'selected' : ''}>Clay</option>
                    <option value="Loam" ${farm.soilType === 'Loam' ? 'selected' : ''}>Loam</option>
                    <option value="Sand" ${farm.soilType === 'Sand' ? 'selected' : ''}>Sand</option>
                    <option value="Silt" ${farm.soilType === 'Silt' ? 'selected' : ''}>Silt</option>
                    <option value="Sandy Loam" ${farm.soilType === 'Sandy Loam' ? 'selected' : ''}>Sandy Loam</option>
                    <option value="Clay Loam" ${farm.soilType === 'Clay Loam' ? 'selected' : ''}>Clay Loam</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Irrigation System *</label>
                  <select class="form-select" name="irrigationSystem" required>
                    <option value="">Select Irrigation System</option>
                    <option value="RAIN_FED" ${farm.irrigationSystem === 'RAIN_FED' ? 'selected' : ''}>Rain Fed</option>
                    <option value="SPRINKLER" ${farm.irrigationSystem === 'SPRINKLER' ? 'selected' : ''}>Sprinkler</option>
                    <option value="DRIP" ${farm.irrigationSystem === 'DRIP' ? 'selected' : ''}>Drip Irrigation</option>
                    <option value="FLOOD" ${farm.irrigationSystem === 'FLOOD' ? 'selected' : ''}>Flood Irrigation</option>
                    <option value="FURROW" ${farm.irrigationSystem === 'FURROW' ? 'selected' : ''}>Furrow Irrigation</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Topography</label>
                  <input type="text" class="form-input" name="topography" value="${farm.topography || ''}">
                </div>
                <div class="form-group form-group-full">
                  <label class="form-checkbox">
                    <input type="checkbox" name="electricityAvailable" ${farm.electricityAvailable ? 'checked' : ''}>
                    <span>Electricity Available</span>
                  </label>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeFarmModal()">
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  Update Farm
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      `;

      document.getElementById('modalContainer').innerHTML = modalHTML;

      document.getElementById('editFarmForm').addEventListener('submit', handleEditFarm);
      }

      /**
      * Handle edit farm
      */
      async function handleEditFarm(e) {
      e.preventDefault();

      const formData = new FormData(e.target);
      const farmId = formData.get('farmId');

      const farmData = {
      farmerId: currentUser.id,
      farmName: formData.get('farmName'),
      farmCode: formData.get('farmCode'),
      sizeHectares: parseFloat(formData.get('sizeHectares')),
      location: formData.get('location'),
      latitude: parseFloat(formData.get('latitude')),
      longitude: parseFloat(formData.get('longitude')),
      soilType: formData.get('soilType'),
      irrigationSystem: formData.get('irrigationSystem'),
      topography: formData.get('topography') || null,
      electricityAvailable: formData.get('electricityAvailable') === 'on'
      };

      try {
      showLoading();

      await apiRequest(`/farms/${farmId}`, {
      method: 'PUT',
      body: JSON.stringify(farmData)
      });

      showToast('Farm updated successfully', 'success');
      closeFarmModal();
      await loadFarmsData();

      } catch (error) {
      console.error('Error updating farm:', error);
      showToast('Error updating farm: ' + error.message, 'error');
      } finally {
      hideLoading();
      }
      }

      /**
      * View farm details
      */
      async function viewFarmDetails(farmId) {
      try {
      showLoading();

      const farm = await apiRequest(`/farms/${farmId}`);

      // Show farm details modal
      showFarmDetailsModal(farm);

      } catch (error) {
      console.error('Error loading farm details:', error);
      showToast('Error loading farm details', 'error');
      } finally {
      hideLoading();
      }
      }

      /**
      * Show farm details modal
      */
      function showFarmDetailsModal(farm) {
      const modalHTML = `
      <div class="modal-overlay" id="farmModal">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">${farm.farmName}</h3>
            <button class="modal-close" onclick="closeFarmModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="details-grid">
              <div class="detail-item">
                <label>Farm Code</label>
                <value>${farm.farmCode}</value>
              </div>
              <div class="detail-item">
                <label>Size</label>
                <value>${farm.sizeHectares} hectares</value>
              </div>
              <div class="detail-item">
                <label>Location</label>
                <value>${farm.location}</value>
              </div>
              <div class="detail-item">
                <label>Coordinates</label>
                <value>${farm.latitude}, ${farm.longitude}</value>
              </div>
              <div class="detail-item">
                <label>Soil Type</label>
                <value>${farm.soilType}</value>
              </div>
              <div class="detail-item">
                <label>Irrigation System</label>
                <value>${formatIrrigationSystem(farm.irrigationSystem)}</value>
              </div>
              <div class="detail-item">
                <label>Topography</label>
                <value>${farm.topography || 'N/A'}</value>
              </div>
              <div class="detail-item">
                <label>Electricity</label>
                <value>${farm.electricityAvailable ? 'Available' : 'Not Available'}</value>
              </div>
              <div class="detail-item">
                <label>Created At</label>
                <value>${formatDateTime(farm.createdAt)}</value>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeFarmModal()">
              Close
            </button>
            <button class="btn btn-primary" onclick="editFarm('${farm.id}')">
              <i class="fas fa-edit"></i>
              Edit Farm
            </button>
          </div>
        </div>
      </div>
      `;

      document.getElementById('modalContainer').innerHTML = modalHTML;
      }









      // ============================================================================
      // CROPS CATALOG MODULE
      // ============================================================================

     /**
 * Load crops data - CORRECTION
 */
async function loadCropsData() {
  try {
    showLoading();

    const response = await apiRequest('/v1/crops/all');

    // CORRECTION: G√©rer les diff√©rents formats de r√©ponse
    let crops = [];
    if (Array.isArray(response)) {
      crops = response;
    } else if (response && response.data && Array.isArray(response.data)) {
      crops = response.data;
    } else if (response && response.content && Array.isArray(response.content)) {
      crops = response.content;
    } else {
      console.warn('‚ö†Ô∏è Unexpected crops response format:', response);
      crops = [];
    }

    displayCropsGrid(crops);

  } catch (error) {
    console.error('Error loading crops:', error);
    showToast('Error loading crops catalog', 'error');

    // Afficher un √©tat vide en cas d'erreur
    const container = document.getElementById('cropsGrid');
    if (container) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <p>Unable to load crops catalog</p>
          <button class="btn btn-primary mt-4" onclick="loadCropsData()">
            <i class="fas fa-redo"></i>
            Try Again
          </button>
        </div>
      `;
    }
  } finally {
    hideLoading();
  }
}

      /**
      * Display crops grid
      */










/**
 * Display crops grid
 */
function displayCropsGrid(crops) {
  const container = document.getElementById('cropsGrid');
  if (!container) return;

  if (crops.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-seedling"></i>
        <p>No crops available</p>
      </div>
    `;
    return;
  }

  container.innerHTML = crops.map(crop => `
    <div class="crop-card">
      <div class="crop-card-header">
        <div class="crop-icon">üåæ</div>
        <h3 class="crop-name">${crop.cropName}</h3>
        <span class="crop-category">${crop.cropType}</span>
      </div>
      <div class="crop-card-body">
        <div class="crop-info-list">
          <div class="crop-info-item">
            <span class="crop-info-label">Scientific Name</span>
            <span class="crop-info-value">${crop.scientificName || 'N/A'}</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Variety</span>
            <span class="crop-info-value">${crop.variety || 'N/A'}</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Growing Period</span>
            <span class="crop-info-value">${crop.growingPeriodDays} days</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Planting Season</span>
            <span class="crop-info-value">${crop.plantingSeason}</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Harvest Season</span>
            <span class="crop-info-value">${crop.harvestSeason}</span>
          </div>
          <div class="crop-info-item">
            <span class="crop-info-label">Market Demand</span>
            <span class="crop-info-value">${crop.marketDemandLevel}</span>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="viewCropDetails('${crop.id}')">
          <i class="fas fa-eye"></i>
          View Details
        </button>
      </div>
    </div>
  `).join('');
}












      /**
      * View crop details
      */
      async function viewCropDetails(cropId) {
      try {
      showLoading();

      const crop = await apiRequest(`/v1/crops/${cropId}`);

      showCropDetailsModal(crop);

      } catch (error) {
      console.error('Error loading crop details:', error);
      showToast('Error loading crop details', 'error');
      } finally {
      hideLoading();
      }
      }

      /**
      * Show crop details modal
      */
      function showCropDetailsModal(crop) {
      const modalHTML = `
      <div class="modal-overlay" id="cropModal">
        <div class="modal-container modal-large">
          <div class="modal-header">
            <h3 class="modal-title">${crop.cropName}</h3>
            <button class="modal-close" onclick="closeCropModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="crop-details">
              <div class="details-section">
                <h4>Basic Information</h4>
                <div class="details-grid">
                  <div class="detail-item">
                    <label>Scientific Name</label>
                    <value>${crop.scientificName || 'N/A'}</value>
                  </div>
                  <div class="detail-item">
                    <label>Crop Type</label>
                    <value>${crop.cropType}</value>
                  </div>
                  <div class="detail-item">
                    <label>Variety</label>
                    <value>${crop.variety || 'N/A'}</value>
                  </div>
                  <div class="detail-item">
                    <label>Market Demand</label>
                    <value>${crop.marketDemandLevel}</value>
                  </div>
                </div>
              </div>

              <div class="details-section">
                <h4>Growing Requirements</h4>
                <div class="details-grid">
                  <div class="detail-item">
                    <label>Growing Period</label>
                    <value>${crop.growingPeriodDays} days</value>
                  </div>
                  <div class="detail-item">
                    <label>Planting Season</label>
                    <value>${crop.plantingSeason}</value>
                  </div>
                  <div class="detail-item">
                    <label>Harvest Season</label>
                    <value>${crop.harvestSeason}</value>
                  </div>
                  <div class="detail-item">
                    <label>Temperature Range</label>
                    <value>${crop.optimalTemperatureMin}¬∞C - ${crop.optimalTemperatureMax}¬∞C</value>
                  </div>
                  <div class="detail-item">
                    <label>Rainfall</label>
                    <value>${crop.rainfallRequirementMm} mm</value>
                  </div>
                  <div class="detail-item">
                    <label>Water Requirement</label>
                    <value>${crop.waterRequirementMm} mm</value>
                  </div>
                </div>
              </div>

              <div class="details-section">
                <h4>Soil Requirements</h4>
                <div class="details-grid">
                  <div class="detail-item">
                    <label>pH Range</label>
                    <value>${crop.soilPhMin} - ${crop.soilPhMax}</value>
                  </div>
                  <div class="detail-item">
                    <label>Soil Type</label>
                    <value>${crop.soilType || 'N/A'}</value>
                  </div>
                  <div class="detail-item">
                    <label>Soil Moisture</label>
                    <value>${crop.soilMoistureLevel || 'N/A'}</value>
                  </div>
                </div>
              </div>

              ${crop.description ? `
              <div class="details-section">
                <h4>Description</h4>
                <p>${crop.description}</p>
              </div>
              ` : ''}

              ${crop.nutritionalValue ? `
              <div class="details-section">
                <h4>Nutritional Value</h4>
                <p>${crop.nutritionalValue}</p>
              </div>
              ` : ''}
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCropModal()">
              Close
            </button>
          </div>
        </div>
      </div>
      `;

      document.getElementById('modalContainer').innerHTML = modalHTML;
      }

      /**
      * Close crop modal
      */
      function closeCropModal() {
      document.getElementById('modalContainer').innerHTML = '';
      }

      // ============================================================================
      // CROP PRODUCTION MODULE
      // ============================================================================

/**
 * Load production data - CORRECTION COMPL√àTE
 */
async function loadProductionData() {
    try {
        showLoading();

        // R√©cup√©rer les fermes puis les productions
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

        let allProductions = [];
        if (farms.length > 0) {
            const productionPromises = farms.map(farm =>
                apiRequest(`/v1/crop-productions/farm/${farm.id}`).catch(() => [])
            );
            const productionArrays = await Promise.all(productionPromises);

            // ‚úÖ CORRECTION : G√©rer le format de r√©ponse API
            allProductions = productionArrays.flatMap(response => {
                if (Array.isArray(response)) {
                    return response;
                } else if (response && response.data && Array.isArray(response.data)) {
                    return response.data;
                } else if (response && response.content && Array.isArray(response.content)) {
                    return response.content;
                }
                return [];
            }).filter(p => p && p.productionStatus); // ‚úÖ Filtrer les productions valides
        }

        // Update statistics
        const totalCount = allProductions.length;
        const active = allProductions.filter(p =>
            p.productionStatus && ['PLANTED', 'GROWING'].includes(p.productionStatus)
        ).length;
        const harvested = allProductions.filter(p =>
            p.productionStatus === 'HARVESTED'
        ).length;
        const totalYield = allProductions.reduce((sum, p) =>
            sum + (parseFloat(p.actualYield) || 0), 0
        );

        updateElement('prodTotalCount', totalCount);
        updateElement('prodActive', active);
        updateElement('prodHarvested', harvested);
        updateElement('prodTotalYield', `${totalYield.toFixed(2)} T`);

        displayProductionTimeline(allProductions);

    } catch (error) {
        console.error('Error loading productions:', error);
        showToast('Error loading productions data', 'error');

        // ‚úÖ Afficher un √©tat vide en cas d'erreur
        const container = document.getElementById('productionTimeline');
        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Unable to load production data</p>
                    <button class="btn btn-primary mt-4" onclick="loadProductionData()">
                        <i class="fas fa-redo"></i>
                        Try Again
                    </button>
                </div>
            `;
        }
    } finally {
        hideLoading();
    }
}






/**
 * Utility function to safely handle API responses
 */
function safeApiResponse(data, defaultValue = []) {
    if (Array.isArray(data)) {
        return data;
    }
    if (data && Array.isArray(data.content)) {
        return data.content;
    }
    if (data && typeof data === 'object') {
        // Si c'est un objet unique, le mettre dans un tableau
        return [data];
    }
    return defaultValue;
}



/**
 * Display production timeline - VERSION S√âCURIS√âE
 */
function displayProductionTimeline(productions) {
    const container = document.getElementById('productionTimeline');
    if (!container) return;

    // ‚úÖ CORRECTION : V√©rifier que les productions sont valides
    if (!productions || productions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-seedling"></i>
                <p>No crop productions registered yet</p>
                <button class="btn btn-primary" onclick="openAddProductionModal()">
                    <i class="fas fa-plus"></i>
                    Start First Production
                </button>
            </div>
        `;
        return;
    }

    container.innerHTML = productions.map(prod => {
        // ‚úÖ CORRECTION : Valider chaque production avant affichage
        if (!prod || !prod.productionStatus) {
            console.warn('Invalid production data:', prod);
            return '';
        }

        const statusLower = prod.productionStatus.toLowerCase();
        const cropName = prod.cropName || 'Unknown Crop';
        const productionCode = prod.productionCode || 'N/A';
        const season = prod.season || 'N/A';
        const year = prod.year || '';
        const areaPlanted = prod.areaPlanted || 0;
        const expectedYield = prod.expectedYield || 'N/A';
        const actualYield = prod.actualYield || null;
        const plantingDate = prod.plantingDate ? formatDate(prod.plantingDate) : 'N/A';
        const expectedHarvestDate = prod.expectedHarvestDate ? formatDate(prod.expectedHarvestDate) : 'N/A';
        const actualHarvestDate = prod.actualHarvestDate ? formatDate(prod.actualHarvestDate) : null;

        return `
            <div class="production-card">
                <div class="production-header">
                    <div class="production-info">
                        <h3 class="production-title">${cropName}</h3>
                        <span class="production-code">${productionCode}</span>
                    </div>
                    <span class="production-status status-${statusLower}">${prod.productionStatus}</span>
                </div>
                <div class="production-details">
                    <div class="production-detail-item">
                        <label>Season:</label>
                        <span>${season} ${year}</span>
                    </div>
                    <div class="production-detail-item">
                        <label>Area:</label>
                        <span>${areaPlanted} ha</span>
                    </div>
                    <div class="production-detail-item">
                        <label>Expected Yield:</label>
                        <span>${expectedYield} T/ha</span>
                    </div>
                    ${actualYield ? `
                        <div class="production-detail-item">
                            <label>Actual Yield:</label>
                            <span>${actualYield} T/ha</span>
                        </div>
                    ` : ''}
                </div>
                <div class="production-dates">
                    <div class="date-item">
                        <i class="fas fa-calendar-plus"></i>
                        <span>Planted: ${plantingDate}</span>
                    </div>
                    <div class="date-item">
                        <i class="fas fa-calendar-check"></i>
                        <span>Expected Harvest: ${expectedHarvestDate}</span>
                    </div>
                    ${actualHarvestDate ? `
                        <div class="date-item">
                            <i class="fas fa-check-circle"></i>
                            <span>Harvested: ${actualHarvestDate}</span>
                        </div>
                    ` : ''}
                </div>
                <div class="production-actions">
                    <button class="btn btn-secondary btn-sm" onclick="viewProductionDetails('${prod.id}')">
                        <i class="fas fa-eye"></i>
                        View
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="editProduction('${prod.id}')">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    ${prod.productionStatus === 'GROWING' ? `
                        <button class="btn btn-success btn-sm" onclick="markAsHarvested('${prod.id}')">
                            <i class="fas fa-warehouse"></i>
                            Mark Harvested
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    }).filter(html => html !== '').join(''); // ‚úÖ Filtrer les √©l√©ments vides

    // Si aucune production valide n'a √©t√© affich√©e
    if (container.innerHTML.trim() === '') {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-seedling"></i>
                <p>No valid production data to display</p>
                <button class="btn btn-primary" onclick="loadProductionData()">
                    <i class="fas fa-redo"></i>
                    Reload
                </button>
            </div>
        `;
    }
}



/**
 * Open add production modal - CORRECTION COMPL√àTE
 */
async function openAddProductionModal() {
  try {
    showLoading();

    // CORRECTION: R√©cup√©rer et extraire correctement les crops
    const cropsResponse = await apiRequest('/v1/crops/all');

    let crops = [];
    if (cropsResponse) {
      if (Array.isArray(cropsResponse)) {
        crops = cropsResponse;
      } else if (cropsResponse.data && Array.isArray(cropsResponse.data)) {
        crops = cropsResponse.data;
      } else if (cropsResponse.content && Array.isArray(cropsResponse.content)) {
        crops = cropsResponse.content;
      } else {
        console.warn('‚ö†Ô∏è Unexpected crops response format:', cropsResponse);
        crops = [];
      }
    }

    // R√©cup√©rer les fermes de l'utilisateur
    const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
    const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

    if (farms.length === 0) {
      showToast('Please add a farm before starting production', 'warning');
      hideLoading();
      return;
    }

    if (crops.length === 0) {
      showToast('No crops available. Please contact administrator.', 'warning');
      hideLoading();
      return;
    }

    const modalHTML = `
      <div class="modal-overlay" id="productionModal" onclick="if(event.target === this) closeProductionModal()">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">
              <i class="fas fa-seedling"></i>
              Start New Production
            </h3>
            <button class="modal-close" onclick="closeProductionModal()" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <form id="addProductionForm">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-map-marked-alt"></i>
                    Farm *
                  </label>
                  <select class="form-select" name="farmId" required>
                    <option value="">Select Farm</option>
                    ${farms.map(farm => `
                      <option value="${farm.id}">${farm.farmName} (${farm.sizeHectares} ha)</option>
                    `).join('')}
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-leaf"></i>
                    Crop *
                  </label>
                  <select class="form-select" name="cropId" required>
                    <option value="">Select Crop</option>
                    ${crops.map(crop => `
                      <option value="${crop.id}">${crop.cropName} (${crop.cropType})</option>
                    `).join('')}
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-barcode"></i>
                    Production Code *
                  </label>
                  <input
                    type="text"
                    class="form-input"
                    name="productionCode"
                    placeholder="PROD-2024-001"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-calendar-alt"></i>
                    Season *
                  </label>
                  <select class="form-select" name="season" required>
                    <option value="">Select Season</option>
                    <option value="SEASON_A">Season A (Sept-Feb)</option>
                    <option value="SEASON_B">Season B (Mar-June)</option>
                    <option value="SEASON_C">Season C (June-Aug)</option>
                    <option value="OFF_SEASON">Off Season</option>
                  </select>
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-calendar"></i>
                    Year *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="year"
                    value="${new Date().getFullYear()}"
                    min="2020"
                    max="2030"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-ruler-combined"></i>
                    Area Planted (ha) *
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="areaPlanted"
                    step="0.01"
                    min="0.01"
                    placeholder="1.50"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-weight"></i>
                    Expected Yield (T/ha)
                  </label>
                  <input
                    type="number"
                    class="form-input"
                    name="expectedYield"
                    step="0.01"
                    min="0"
                    placeholder="2.50"
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-calendar-plus"></i>
                    Planting Date *
                  </label>
                  <input
                    type="date"
                    class="form-input"
                    name="plantingDate"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-calendar-check"></i>
                    Expected Harvest Date *
                  </label>
                  <input
                    type="date"
                    class="form-input"
                    name="expectedHarvestDate"
                    required
                  >
                </div>

                <div class="form-group">
                  <label class="form-label">
                    <i class="fas fa-cogs"></i>
                    Production Method
                  </label>
                  <select class="form-select" name="productionMethod">
                    <option value="">Select Method</option>
                    <option value="ORGANIC">Organic</option>
                    <option value="CONVENTIONAL">Conventional</option>
                    <option value="INTEGRATED">Integrated</option>
                  </select>
                </div>
              </div>

              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProductionModal()">
                  <i class="fas fa-times"></i>
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  Start Production
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `;

    document.getElementById('modalContainer').innerHTML = modalHTML;

    // Ajouter l'√©couteur d'√©v√©nement pour le formulaire
    const form = document.getElementById('addProductionForm');
    if (form) {
      form.addEventListener('submit', handleAddProduction);
    }

  } catch (error) {
    console.error('Error opening add production modal:', error);
    showToast('Error loading form data: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}



/**
 * Handle add production - CORRECTION
 */
async function handleAddProduction(e) {
  e.preventDefault();

  const formData = new FormData(e.target);

  const productionData = {
    farmId: formData.get('farmId'),
    cropId: formData.get('cropId'),
    productionCode: formData.get('productionCode'),
    season: formData.get('season'),
    year: parseInt(formData.get('year')),
    areaPlanted: parseFloat(formData.get('areaPlanted')),
    expectedYield: formData.get('expectedYield') ? parseFloat(formData.get('expectedYield')) : null,
    plantingDate: formData.get('plantingDate'),
    expectedHarvestDate: formData.get('expectedHarvestDate'),
    productionMethod: formData.get('productionMethod') || null,
    productionStatus: 'PLANNED'
  };

  // Validation
  if (!productionData.farmId || !productionData.cropId) {
    showToast('Please fill in all required fields', 'error');
    return;
  }

  try {
    showLoading();

    await apiRequest('/crop-productions', {
      method: 'POST',
      body: JSON.stringify(productionData)
    });

    showToast('Production started successfully', 'success');
    closeProductionModal();
    await loadProductionData();

  } catch (error) {
    console.error('Error adding production:', error);
    showToast('Error starting production: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}






      /**
      * Close production modal
      */
      function closeProductionModal() {
      document.getElementById('modalContainer').innerHTML = '';
      }

      /**
      * View production details
      */
      async function viewProductionDetails(productionId) {
      try {
      showLoading();

      const production = await apiRequest(`/crop-productions/${productionId}`);

      showProductionDetailsModal(production);

      } catch (error) {
      console.error('Error loading production details:', error);
      showToast('Error loading production details', 'error');
      } finally {
      hideLoading();
      }
      }

      /**
      * Show production details modal
      */
      function showProductionDetailsModal(production) {
      const modalHTML = `
      <div class="modal-overlay" id="productionModal">
        <div class="modal-container modal-large">
          <div class="modal-header">
            <h3 class="modal-title">Production Details</h3>
            <button class="modal-close" onclick="closeProductionModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="details-grid">
              <div class="detail-item">
                <label>Production Code</label>
                <value>${production.productionCode}</value>
              </div>
              <div class="detail-item">
                <label>Crop</label>
                <value>${production.cropName || 'N/A'}</value>
              </div>
              <div class="detail-item">
                <label>Season</label>
                <value>${production.season} ${production.year}</value>
              </div>
              <div class="detail-item">
                <label>Status</label>
                <value><span class="status-badge status-${production.productionStatus.toLowerCase()}">${production.productionStatus}</span></value>
              </div>
              <div class="detail-item">
                <label>Area Planted</label>
                <value>${production.areaPlanted} ha</value>
              </div>
              <div class="detail-item">
                <label>Expected Yield</label>
                <value>${production.expectedYield || 'N/A'} T/ha</value>
              </div>
              ${production.actualYield ? `
              <div class="detail-item">
                <label>Actual Yield</label>
                <value>${production.actualYield} T/ha</value>
              </div>
              <div class="detail-item">
                <label>Total Production</label>
                <value>${production.totalProduction || 'N/A'} T</value>
              </div>
              ` : ''}
              <div class="detail-item">
                <label>Planting Date</label>
                <value>${formatDate(production.plantingDate)}</value>
              </div>
              <div class="detail-item">
                <label>Expected Harvest Date</label>
                <value>${formatDate(production.expectedHarvestDate)}</value>
              </div>
              ${production.actualHarvestDate ? `
              <div class="detail-item">
                <label>Actual Harvest Date</label>
                <value>${formatDate(production.actualHarvestDate)}</value>
              </div>
              ` : ''}
              ${production.productionMethod ? `
              <div class="detail-item">
                <label>Production Method</label>
                <value>${production.productionMethod}</value>
              </div>
              ` : ''}
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeProductionModal()">
              Close
            </button>
            <button class="btn btn-primary" onclick="editProduction('${production.id}')">
              <i class="fas fa-edit"></i>
              Edit
            </button>
          </div>
        </div>
      </div>
      `;

      document.getElementById('modalContainer').innerHTML = modalHTML;
      }

      /**
      * Edit production
      */
      function editProduction(productionId) {
      // Implementation similar to editFarm
      showToast('Edit production feature - To be implemented', 'info');
      }

      /**
      * Mark as harvested
      */
      function markAsHarvested(productionId) {
      // Implementation to update production status and add harvest details
      showToast('Mark as harvested feature - To be implemented', 'info');
      }

      // ============================================================================
      // INVENTORY MODULE
      // ============================================================================



/**
 * CORRECTION : Chargement robuste des donn√©es d'inventaire
 */
async function loadInventoryData() {
    const container = document.getElementById('inventoryGrid');
    if (!container) return;

    try {
        showLoading();
        console.log('üîÑ Loading inventory data for farmer:', currentUser.id);

        // Utiliser le farmerId de l'utilisateur connect√©
        let inventory = [];
        try {
            const response = await apiRequest(`/v1/inventories/farmer/${currentUser.id}`);

            // Gestion des diff√©rents formats de r√©ponse
            if (Array.isArray(response)) {
                inventory = response;
            } else if (response && response.data) {
                inventory = Array.isArray(response.data) ? response.data : [];
            } else if (response && response.content) {
                inventory = Array.isArray(response.content) ? response.content : [];
            } else {
                console.warn('‚ö†Ô∏è Unexpected inventory response format:', response);
                inventory = [];
            }

            console.log(`üì¶ Loaded ${inventory.length} inventory items`);

        } catch (error) {
            console.warn('‚ö†Ô∏è Inventory load warning:', error.message);
            inventory = []; // Retourner tableau vide en cas d'erreur
        }

        // Mise √† jour des statistiques
        updateInventoryStats(inventory);

        // Affichage des donn√©es
        displayInventoryGrid(inventory);
        displayInventoryAlerts(inventory);

    } catch (error) {
        console.error('‚ùå Inventory load error:', error);
        showToast('Unable to load inventory data', 'warning');

        // Affichage d'un √©tat d'erreur convivial
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <p>Unable to load inventory</p>
                <button class="btn btn-primary mt-4" onclick="loadInventoryData()">
                    <i class="fas fa-redo"></i>
                    Try Again
                </button>
            </div>
        `;
    } finally {
        hideLoading();
    }
}



/**
 * Mise √† jour des statistiques d'inventaire
 */
function updateInventoryStats(inventory) {
    const totalItems = inventory.length;
    const totalQuantity = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.currentQuantity) || 0), 0
    );
    const totalValue = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.totalMarketValue) || 0), 0
    );

    updateElement('invTotalItems', totalItems);
    updateElement('invTotalQuantity', `${totalQuantity.toFixed(2)} KG`);
    updateElement('invTotalValue', formatCurrency(totalValue));
    updateElement('invAlerts', calculateAlertsCount(inventory));
}

/**
 * Calculer le nombre d'alertes d'inventaire
 */
function calculateAlertsCount(inventory) {
    if (!Array.isArray(inventory) || inventory.length === 0) {
        return 0;
    }

    const today = new Date();
    let alertsCount = 0;

    inventory.forEach(item => {
        try {
            // Alerte pour les articles expir√©s ou expirant bient√¥t
            if (item.expiryDate) {
                const expiry = new Date(item.expiryDate);

                // V√©rifier que la date est valide
                if (!isNaN(expiry.getTime())) {
                    const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));

                    // Article expir√© ou expire dans les 30 jours
                    if (daysUntil <= 30) {
                        alertsCount++;
                    }
                }
            }

            // Alerte pour stock faible
            const available = parseFloat(item.availableQuantity) || 0;
            const current = parseFloat(item.currentQuantity) || 0;

            if (current > 0 && available < current * 0.2) {
                alertsCount++;
            }

        } catch (error) {
            console.error('Error calculating alert for item:', item.id, error);
        }
    });

    return alertsCount;
}









/**
 * Display inventory grid - PROFESSIONAL DESIGN
 */
function displayInventoryGrid(inventory) {
  const container = document.getElementById('inventoryGrid');
  if (!container) return;

  if (inventory.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-box"></i>
        <p>No inventory items yet</p>
        <button class="btn btn-primary" onclick="openAddInventoryModal()">
          <i class="fas fa-plus"></i>
          Add First Item
        </button>
      </div>
    `;
    return;
  }

  container.innerHTML = inventory.map(item => `
    <div class="inventory-card">
      <div class="inventory-header">
        <h3 class="inventory-title">${item.cropName || 'Product'}</h3>
        <div class="inventory-badges">
          <span class="inventory-badge ${item.status.toLowerCase()}">${item.status}</span>
          ${item.qualityGrade ? `
            <span class="quality-badge quality-${item.qualityGrade.toLowerCase()}">${item.qualityGrade}</span>
          ` : ''}
        </div>
      </div>

      <div class="inventory-body">
        <div class="inventory-info-grid">
          <div class="inventory-info-item">
            <span class="inventory-info-label">Code</span>
            <span class="inventory-info-value">${item.inventoryCode}</span>
          </div>

          <div class="inventory-info-item">
            <span class="inventory-info-label">Quantity</span>
            <span class="inventory-info-value">${item.currentQuantity} ${item.unit}</span>
          </div>

          <div class="inventory-info-item">
            <span class="inventory-info-label">Available</span>
            <span class="inventory-info-value">${item.availableQuantity} ${item.unit}</span>
          </div>

          <div class="inventory-info-item">
            <span class="inventory-info-label">Value</span>
            <span class="inventory-info-value">${formatCurrency(item.totalMarketValue)}</span>
          </div>

          ${item.expiryDate ? `
          <div class="inventory-info-item">
            <span class="inventory-info-label">Expires</span>
            <span class="inventory-info-value">${formatDate(item.expiryDate)}</span>
          </div>
          ` : ''}
        </div>

        <div class="inventory-actions">
          <button class="btn btn-secondary btn-sm" onclick="viewInventoryDetails('${item.id}')">
            <i class="fas fa-eye"></i>
            View
          </button>
          <button class="btn btn-primary btn-sm" onclick="editInventory('${item.id}')">
            <i class="fas fa-edit"></i>
            Edit
          </button>
        </div>
      </div>
    </div>
  `).join('');
}









/**
 * Display inventory alerts - CORRECTION
 */
function displayInventoryAlerts(inventory) {
    const container = document.getElementById('inventoryAlerts');
    if (!container) return;

    const today = new Date();
    const alerts = [];

    inventory.forEach(item => {
        // CORRECTION: V√©rifications strictes
        if (!item || !item.expiryDate) return;

        try {
            const expiry = new Date(item.expiryDate);

            // V√©rifier que la date est valide
            if (isNaN(expiry.getTime())) {
                console.warn('Invalid expiry date for item:', item.id);
                return;
            }

            const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));

            if (daysUntil <= 0) {
                alerts.push({
                    level: 'critical',
                    icon: 'fa-exclamation-triangle',
                    message: `${item.cropName || 'Unknown item'} has expired`,
                    item: item
                });
            } else if (daysUntil <= 7) {
                alerts.push({
                    level: 'high',
                    icon: 'fa-exclamation-circle',
                    message: `${item.cropName || 'Unknown item'} expires in ${daysUntil} days`,
                    item: item
                });
            } else if (daysUntil <= 30) {
                alerts.push({
                    level: 'medium',
                    icon: 'fa-clock',
                    message: `${item.cropName || 'Unknown item'} expires in ${daysUntil} days`,
                    item: item
                });
            }
        } catch (error) {
            console.error('Error processing expiry date for item:', item.id, error);
        }

        // Low stock alerts avec v√©rifications
        try {
            const available = parseFloat(item.availableQuantity) || 0;
            const current = parseFloat(item.currentQuantity) || 0;

            if (current > 0 && available < current * 0.2) {
                alerts.push({
                    level: 'medium',
                    icon: 'fa-box',
                    message: `Low stock: ${item.cropName || 'Unknown item'} (${available} ${item.unit || 'units'} remaining)`,
                    item: item
                });
            }
        } catch (error) {
            console.error('Error processing stock levels for item:', item.id, error);
        }
    });

    if (alerts.length === 0) {
        container.innerHTML = '';
        return;
    }

    container.innerHTML = `
        <div class="alerts-banner">
            <h4><i class="fas fa-bell"></i> Inventory Alerts</h4>
            <div class="alerts-list">
                ${alerts.map(alert => `
                    <div class="alert-item alert-${alert.level}">
                        <i class="fas ${alert.icon}"></i>
                        <span>${alert.message}</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}





      /**
      * Open add inventory modal
      */
      function openAddInventoryModal() {
      showToast('Add inventory feature - To be implemented', 'info');
      }

      /**
      * View inventory details
      */
      function viewInventoryDetails(inventoryId) {
      showToast('View inventory details feature - To be implemented', 'info');
      }

      /**
      * Edit inventory
      */
      function editInventory(inventoryId) {
      showToast('Edit inventory feature - To be implemented', 'info');
      }




/**
 * CORRECTION COMPL√àTE: Load fertilizer data
 */
async function loadFertilizerData() {
    try {
        showLoading();

        if (!currentUser || !currentUser.id) {
            console.warn('‚ö†Ô∏è No current user found');
            displayEmptyFertilizerData();
            return;
        }

        console.log('üîÑ Loading fertilizer data for farmer:', currentUser.id);

        // CORRECTION: Utiliser le bon endpoint
        let fertilizers = [];
        try {
            const response = await apiRequest(`/fertilizer-usages/farmer/${currentUser.id}`);

            // G√©rer les diff√©rents formats de r√©ponse
            if (Array.isArray(response)) {
                fertilizers = response;
            } else if (response && response.content && Array.isArray(response.content)) {
                fertilizers = response.content;
            } else if (response && response.data && Array.isArray(response.data)) {
                fertilizers = response.data;
            } else {
                console.warn('‚ö†Ô∏è Unexpected fertilizer response format:', response);
                fertilizers = [];
            }

            console.log(`‚úÖ Loaded ${fertilizers.length} fertilizer records`);

        } catch (error) {
            console.warn('‚ö†Ô∏è Error loading fertilizer data:', error.message);
            fertilizers = [];
        }

        // Calculer les statistiques
        const totalApplications = fertilizers.length;
        const totalQuantity = fertilizers.reduce((sum, f) =>
            sum + (parseFloat(f.quantity) || 0), 0
        );
        const totalCost = fertilizers.reduce((sum, f) =>
            sum + (parseFloat(f.totalCost) || 0), 0
        );
        const avgEffectiveness = fertilizers.length > 0
            ? fertilizers.reduce((sum, f) => sum + (parseFloat(f.effectivenessRating) || 0), 0) / fertilizers.length
            : 0;

        // Mettre √† jour les statistiques
        updateElement('fertTotalApplications', totalApplications);
        updateElement('fertTotalQuantity', `${totalQuantity.toFixed(2)} KG`);
        updateElement('fertTotalCost', formatCurrency(totalCost));
        updateElement('fertAvgEffectiveness', avgEffectiveness > 0 ? `${avgEffectiveness.toFixed(1)}/5` : 'N/A');

        // Afficher les donn√©es
        displayFertilizerTable(fertilizers);
        createFertilizerCostChart(fertilizers);

    } catch (error) {
        console.error('‚ùå Error loading fertilizer data:', error);
        showToast('Unable to load fertilizer data', 'warning');
        displayEmptyFertilizerData();
    } finally {
        hideLoading();
    }
}


/**
 * Afficher un √©tat vide pour les fertilisants
 */
function displayEmptyFertilizerData() {
    updateElement('fertTotalApplications', 0);
    updateElement('fertTotalQuantity', '0 KG');
    updateElement('fertTotalCost', formatCurrency(0));
    updateElement('fertAvgEffectiveness', 'N/A');

    const tbody = document.getElementById('fertilizerTableBody');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="empty-state">
                    <i class="fas fa-flask"></i>
                    <p>No fertilizer usage records yet</p>
                </td>
            </tr>
        `;
    }
}


      /**
      * Display fertilizer table
      */
      function displayFertilizerTable(fertilizers) {
      const tbody = document.getElementById('fertilizerTableBody');
      if (!tbody) return;

      if (fertilizers.length === 0) {
      tbody.innerHTML = `
      <tr>
        <td colspan="9" class="empty-state">
          <i class="fas fa-flask"></i>
          <p>No fertilizer usage records yet</p>
        </td>
      </tr>
      `;
      return;
      }

      tbody.innerHTML = fertilizers.map(fert => `
      <tr>
        <td>${formatDate(fert.applicationDate)}</td>
        <td>${fert.cropProductionCode || 'N/A'}</td>
        <td>${fert.fertilizerType}</td>
        <td>${fert.fertilizerName}</td>
        <td>${fert.quantity} ${fert.unit}</td>
        <td>${fert.applicationMethod}</td>
        <td>${formatCurrency(fert.totalCost)}</td>
        <td>${fert.effectivenessRating ? `‚≠ê ${fert.effectivenessRating}/5` : 'N/A'}</td>
        <td>
          <button class="btn-icon" onclick="viewFertilizerDetails('${fert.id}')">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn-icon" onclick="editFertilizer('${fert.id}')">
            <i class="fas fa-edit"></i>
          </button>
        </td>
      </tr>
      `).join('');
      }

      /**
      * Create fertilizer cost chart
      */
      function createFertilizerCostChart(fertilizers) {
      const ctx = document.getElementById('fertilizerCostChart');
      if (!ctx) return;

      // Group by fertilizer type
      const costByType = {};
      fertilizers.forEach(fert => {
      const type = fert.fertilizerType;
      if (!costByType[type]) {
      costByType[type] = 0;
      }
      costByType[type] += parseFloat(fert.totalCost) || 0;
      });

      if (charts.fertilizerCost) {
      charts.fertilizerCost.destroy();
      }

      charts.fertilizerCost = new Chart(ctx, {
      type: 'bar',
      data: {
      labels: Object.keys(costByType),
      datasets: [{
      label: 'Total Cost (RWF)',
      data: Object.values(costByType),
      backgroundColor: '#3b82f6',
      borderWidth: 0
      }]
      },
      options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
      legend: {
      display: false
      }
      },
      scales: {
      y: {
      beginAtZero: true,
      ticks: {
      callback: function(value) {
      return formatCurrency(value);
      }
      }
      }
      }
      }
      });
      }

      /**
      * View fertilizer details
      */
      function viewFertilizerDetails(fertilizerId) {
      showToast('View fertilizer details feature - To be implemented', 'info');
      }

      /**
      * Edit fertilizer
      */
      function editFertilizer(fertilizerId) {
      showToast('Edit fertilizer feature - To be implemented', 'info');
      }




/**
 * CORRECTION: Load irrigation data
 */
async function loadIrrigationData() {
    try {
        showLoading();

        if (!currentUser || !currentUser.id) {
            console.warn('‚ö†Ô∏è No current user found');
            displayEmptyIrrigationData();
            return;
        }

        console.log('üîÑ Loading irrigation data for farmer:', currentUser.id);

        // R√©cup√©rer les fermes d'abord
        const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
        const farms = Array.isArray(farmsResponse) ? farmsResponse : [];

        let irrigations = [];

        if (farms.length > 0) {
            // R√©cup√©rer les irrigations pour chaque ferme
            const irrigationPromises = farms.map(farm =>
                apiRequest(`/irrigation/farm/${farm.id}`).catch(() => [])
            );

            const irrigationArrays = await Promise.all(irrigationPromises);
            irrigations = irrigationArrays.flat().filter(i => i);
        }

        console.log(`‚úÖ Loaded ${irrigations.length} irrigation records`);

        // Calculer les statistiques
        const totalSessions = irrigations.length;
        const totalWater = irrigations.reduce((sum, i) =>
            sum + (parseFloat(i.waterAmountLiters) || 0), 0
        );
        const totalCost = irrigations.reduce((sum, i) =>
            sum + (parseFloat(i.totalCost) || 0), 0
        );
        const avgEfficiency = irrigations.length > 0
            ? irrigations.reduce((sum, i) => sum + (parseFloat(i.waterUseEfficiency) || 0), 0) / irrigations.length
            : 0;

        // Mettre √† jour les statistiques
        updateElement('irrigTotalSessions', totalSessions);
        updateElement('irrigTotalWater', `${totalWater.toFixed(2)} L`);
        updateElement('irrigTotalCost', formatCurrency(totalCost));
        updateElement('irrigAvgEfficiency', avgEfficiency > 0 ? `${(avgEfficiency * 100).toFixed(1)}%` : 'N/A');

        // Afficher les donn√©es
        displayIrrigationTable(irrigations);
        createIrrigationTrendChart(irrigations);

    } catch (error) {
        console.error('‚ùå Error loading irrigation data:', error);
        showToast('Unable to load irrigation data', 'warning');
        displayEmptyIrrigationData();
    } finally {
        hideLoading();
    }
}

/**
 * Afficher un √©tat vide pour l'irrigation
 */
function displayEmptyIrrigationData() {
    updateElement('irrigTotalSessions', 0);
    updateElement('irrigTotalWater', '0 L');
    updateElement('irrigTotalCost', formatCurrency(0));
    updateElement('irrigAvgEfficiency', 'N/A');

    const tbody = document.getElementById('irrigationTableBody');
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="empty-state">
                    <i class="fas fa-tint"></i>
                    <p>No irrigation records yet</p>
                </td>
            </tr>
        `;
    }
}

      /**
      * Display irrigation table
      */
      function displayIrrigationTable(irrigations) {
      const tbody = document.getElementById('irrigationTableBody');
      if (!tbody) return;

      if (irrigations.length === 0) {
      tbody.innerHTML = `
      <tr>
        <td colspan="10" class="empty-state">
          <i class="fas fa-tint"></i>
          <p>No irrigation records yet</p>
        </td>
      </tr>
      `;
      return;
      }

      tbody.innerHTML = irrigations.map(irrig => `
      <tr>
        <td>${formatDate(irrig.irrigationDate)}</td>
        <td>${irrig.farmName || 'N/A'}</td>
        <td>${irrig.waterAmountLiters} L</td>
        <td>${irrig.durationMinutes} min</td>
        <td>${irrig.irrigationMethod}</td>
        <td>${irrig.waterSource}</td>
        <td>${irrig.soilMoistureBefore || 'N/A'}%</td>
        <td>${irrig.soilMoistureAfter || 'N/A'}%</td>
        <td>${formatCurrency(irrig.totalCost)}</td>
        <td>
          <button class="btn-icon" onclick="viewIrrigationDetails('${irrig.id}')">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn-icon" onclick="editIrrigation('${irrig.id}')">
            <i class="fas fa-edit"></i>
          </button>
        </td>
      </tr>
      `).join('');
      }

      /**
      * Create irrigation trend chart
      */
      function createIrrigationTrendChart(irrigations) {
      const ctx = document.getElementById('irrigationTrendChart');
      if (!ctx) return;

      // Group by month
      const monthlyData = {};
      irrigations.forEach(irrig => {
      const date = new Date(irrig.irrigationDate);
      const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

      if (!monthlyData[monthKey]) {
      monthlyData[monthKey] = 0;
      }
      monthlyData[monthKey] += parseFloat(irrig.waterAmountLiters) || 0;
      });

      const sortedKeys = Object.keys(monthlyData).sort();
      const labels = sortedKeys.map(key => {
      const [year, month] = key.split('-');
      return new Date(year, parseInt(month) - 1).toLocaleString('default', { month: 'short', year: 'numeric' });
      });
      const data = sortedKeys.map(key => monthlyData[key]);

      if (charts.irrigationTrend) {
      charts.irrigationTrend.destroy();
      }

      charts.irrigationTrend = new Chart(ctx, {
      type: 'line',
      data: {
      labels: labels,
      datasets: [{
      label: 'Water Usage (Liters)',
      data: data,
      borderColor: '#3b82f6',
      backgroundColor: 'rgba(59, 130, 246, 0.1)',
      borderWidth: 2,
      fill: true,
      tension: 0.4
      }]
      },
      options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
      legend: {
      display: false
      }
      },
      scales: {
      y: {
      beginAtZero: true,
      ticks: {
      callback: function(value) {
      return value.toLocaleString() + ' L';
      }
      }
      }
      }
      }
      });
      }

      /**
      * View irrigation details
      */
      function viewIrrigationDetails(irrigationId) {
      showToast('View irrigation details feature - To be implemented', 'info');
      }


// ============================================================================
// SOIL DATA MODULE - CORRECTED VERSION
// ============================================================================

/**
 * Load soil data - CORRECTION COMPL√àTE
 * Fix: Utiliser le bon endpoint v1 et g√©rer les erreurs proprement
 */
async function loadSoilData() {
  try {
    showLoading();

    if (!currentUser || !currentUser.id) {
      console.warn('‚ö†Ô∏è No current user found');
      displayEmptySoilData();
      return;
    }

    console.log('üîÑ Loading soil data for farmer:', currentUser.id);

    // CORRECTION 1: R√©cup√©rer d'abord les fermes de l'utilisateur
    let farms = [];
    try {
      const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
      farms = Array.isArray(farmsResponse) ? farmsResponse : [];
      console.log(`‚úÖ Loaded ${farms.length} farms`);
    } catch (error) {
      console.warn('‚ö†Ô∏è Error loading farms:', error.message);
      farms = [];
    }

    if (farms.length === 0) {
      console.warn('‚ö†Ô∏è No farms found for user');
      displayEmptySoilData();
      return;
    }

    // CORRECTION 2: R√©cup√©rer les donn√©es de sol pour chaque ferme avec le bon endpoint
    let allSoilData = [];

    for (const farm of farms) {
      try {
        console.log(`üîÑ Fetching soil data for farm ${farm.id}`);

        // CORRECTION 3: Utiliser le bon endpoint /api/v1/soil-data/farm/{farmId}
        const soilResponse = await apiRequest(`/v1/soil-data/farm/${farm.id}/all`);

        // CORRECTION 4: G√©rer diff√©rents formats de r√©ponse
        let farmSoilData = [];
        if (Array.isArray(soilResponse)) {
          farmSoilData = soilResponse;
        } else if (soilResponse && soilResponse.content && Array.isArray(soilResponse.content)) {
          farmSoilData = soilResponse.content;
        } else if (soilResponse && soilResponse.data && Array.isArray(soilResponse.data)) {
          farmSoilData = soilResponse.data;
        } else if (soilResponse && typeof soilResponse === 'object') {
          // Si c'est un objet unique, le mettre dans un tableau
          farmSoilData = [soilResponse];
        } else {
          console.warn(`‚ö†Ô∏è Unexpected soil data format for farm ${farm.id}:`, soilResponse);
          farmSoilData = [];
        }

        console.log(`‚úÖ Loaded ${farmSoilData.length} soil records for farm ${farm.id}`);
        allSoilData = allSoilData.concat(farmSoilData);

      } catch (error) {
        console.warn(`‚ö†Ô∏è Error loading soil data for farm ${farm.id}:`, error.message);
        // Continue avec les autres fermes m√™me en cas d'erreur
      }
    }

    console.log(`‚úÖ Total soil data records loaded: ${allSoilData.length}`);

    // Afficher les donn√©es
    displaySoilDataGrid(allSoilData, farms);
    updateSoilDataStatistics(allSoilData);

  } catch (error) {
    console.error('‚ùå Error loading soil data:', error);
    showToast('Unable to load soil data', 'warning');
    displayEmptySoilData();
  } finally {
    hideLoading();
  }
}














/**
 * Display soil data grid - COMPACT & SYSTEM COLORS
 */
function displaySoilDataGrid(soilData, farms) {
  const container = document.getElementById('soilDataGrid');
  if (!container) {
    console.warn('‚ö†Ô∏è Soil data container not found');
    return;
  }

  if (!soilData || soilData.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-mountain"></i>
        </div>
        <h3>No Soil Data Available</h3>
        <p>No soil analysis records found for your farms.</p>
        <p class="empty-state-hint">
          <i class="fas fa-info-circle"></i>
          Contact your agricultural advisor for soil testing services
        </p>
        <button class="btn btn-primary mt-4" onclick="showSoilTestingInfo()">
          <i class="fas fa-flask"></i>
          Learn About Soil Testing
        </button>
      </div>
    `;
    return;
  }

  // Create farm map
  const farmMap = new Map();
  if (farms && Array.isArray(farms)) {
    farms.forEach(farm => farmMap.set(farm.id, farm));
  }

  container.innerHTML = soilData.map(soil => {
    const farm = farmMap.get(soil.farmId);
    const farmName = farm ? farm.farmName : 'Unknown Farm';

    // Get pH values and status
    const phLevel = soil.phLevel ? parseFloat(soil.phLevel).toFixed(2) : 'N/A';
    const phStatus = getPhStatus(soil.phLevel);
    const phLabel = getPhLabel(soil.phLevel);

    // Get NPK levels with status
    const nitrogenLevel = soil.nitrogenLevel || 'N/A';
    const nitrogenStatus = getNutrientStatus(soil.nitrogenLevel);
    const phosphorusLevel = soil.phosphorusLevel || 'N/A';
    const phosphorusStatus = getNutrientStatus(soil.phosphorusLevel);
    const potassiumLevel = soil.potassiumLevel || 'N/A';
    const potassiumStatus = getNutrientStatus(soil.potassiumLevel);

    const organicMatter = soil.organicMatter ? parseFloat(soil.organicMatter).toFixed(2) + '%' : 'N/A';
    const moisture = soil.moisture ? parseFloat(soil.moisture).toFixed(2) + '%' : 'N/A';
    const measurementDate = soil.measurementDate ? formatDate(soil.measurementDate) : 'N/A';
    const sampleCode = soil.sampleCode || 'N/A';
    const depthCm = soil.depthCm ? soil.depthCm + ' cm' : 'N/A';
    const soilTexture = soil.soilTexture || 'N/A';

    return `
      <div class="soil-data-card" data-soil-id="${soil.id}">
        <div class="soil-header">
          <div class="soil-header-left">
            <h3 class="soil-farm-name">
              <i class="fas fa-map-marked-alt"></i>
              ${farmName}
            </h3>
            <span class="soil-sample-code">Sample: ${sampleCode}</span>
            <div class="soil-date">
              <i class="fas fa-calendar"></i>
              ${measurementDate}
            </div>
          </div>
        </div>

        <div class="soil-metrics">
          <!-- pH Level - Primary Metric -->
          <div class="soil-metric ph-primary">
            <span class="soil-metric-label">pH Level</span>
            <span class="soil-metric-value ph-${phStatus}">${phLevel}</span>
            <span class="ph-status-label">${phLabel}</span>
          </div>

          <!-- Nitrogen (N) -->
          <div class="soil-metric npk-${nitrogenStatus}">
            <span class="soil-metric-label">
              <i class="fas fa-leaf"></i>
              Nitrogen
            </span>
            <span class="soil-metric-value">${nitrogenLevel}</span>
          </div>

          <!-- Phosphorus (P) -->
          <div class="soil-metric npk-${phosphorusStatus}">
            <span class="soil-metric-label">
              <i class="fas fa-seedling"></i>
              Phosphorus
            </span>
            <span class="soil-metric-value">${phosphorusLevel}</span>
          </div>

          <!-- Potassium (K) -->
          <div class="soil-metric npk-${potassiumStatus}">
            <span class="soil-metric-label">
              <i class="fas fa-spa"></i>
              Potassium
            </span>
            <span class="soil-metric-value">${potassiumLevel}</span>
          </div>

          <!-- Organic Matter -->
          <div class="soil-metric">
            <span class="soil-metric-label">
              <i class="fas fa-recycle"></i>
              Organic
            </span>
            <span class="soil-metric-value">${organicMatter}</span>
          </div>

          <!-- Moisture -->
          <div class="soil-metric">
            <span class="soil-metric-label">
              <i class="fas fa-water"></i>
              Moisture
            </span>
            <span class="soil-metric-value">${moisture}</span>
          </div>

          <!-- Depth -->
          <div class="soil-metric">
            <span class="soil-metric-label">
              <i class="fas fa-ruler-vertical"></i>
              Depth
            </span>
            <span class="soil-metric-value">${depthCm}</span>
          </div>

          <!-- Soil Texture -->
          <div class="soil-metric">
            <span class="soil-metric-label">
              <i class="fas fa-hand-paper"></i>
              Texture
            </span>
            <span class="soil-metric-value">${soilTexture}</span>
          </div>
        </div>

        ${soil.recommendations ? `
        <div class="soil-recommendations">
          <h4>
            <i class="fas fa-lightbulb"></i>
            Recommendations
          </h4>
          <p>${soil.recommendations}</p>
        </div>
        ` : ''}

        <div class="soil-footer">
          <div class="soil-meta">
            ${soil.laboratoryName ? `
            <span class="soil-meta-item">
              <i class="fas fa-flask"></i>
              ${soil.laboratoryName}
            </span>
            ` : ''}
            ${soil.testingMethod ? `
            <span class="soil-meta-item">
              <i class="fas fa-microscope"></i>
              ${soil.testingMethod}
            </span>
            ` : ''}
          </div>
          <div class="soil-actions">
            <button class="btn btn-secondary btn-sm" onclick="viewSoilDetails('${soil.id}')">
              <i class="fas fa-eye"></i>
              View Report
            </button>
            <button class="btn btn-primary btn-sm" onclick="downloadSoilReport('${soil.id}')">
              <i class="fas fa-download"></i>
              Download
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

/**
 * Helper: Get nutrient status (for NPK)
 */
function getNutrientStatus(level) {
  if (!level || level === 'N/A') return 'medium';
  const levelUpper = level.toUpperCase();
  if (levelUpper.includes('HIGH') || levelUpper.includes('GOOD')) return 'high';
  if (levelUpper.includes('LOW') || levelUpper.includes('POOR') || levelUpper.includes('VERY_LOW')) return 'low';
  return 'medium';
}












/**
 * Update soil data statistics
 */
function updateSoilDataStatistics(soilData) {
  const statsContainer = document.getElementById('soilStats');
  if (!statsContainer || !soilData || soilData.length === 0) return;

  try {
    // Calculer les statistiques
    const totalSamples = soilData.length;

    // pH moyen
    const phValues = soilData
      .filter(s => s.phLevel)
      .map(s => parseFloat(s.phLevel));
    const avgPh = phValues.length > 0
      ? (phValues.reduce((a, b) => a + b, 0) / phValues.length).toFixed(2)
      : 0;

    // Organic matter moyen
    const organicValues = soilData
      .filter(s => s.organicMatter)
      .map(s => parseFloat(s.organicMatter));
    const avgOrganic = organicValues.length > 0
      ? (organicValues.reduce((a, b) => a + b, 0) / organicValues.length).toFixed(2)
      : 0;

    // Compter les sols avec probl√®mes
    let problematicSoils = 0;
    soilData.forEach(soil => {
      if (soil.phLevel) {
        const ph = parseFloat(soil.phLevel);
        if (ph < 5.5 || ph > 8.0) problematicSoils++;
      }
      if (soil.organicMatter && parseFloat(soil.organicMatter) < 2.0) {
        problematicSoils++;
      }
    });

    // Tests n√©cessaires (simul√© - bas√© sur la date du dernier test)
    const today = new Date();
    let testsDue = 0;
    soilData.forEach(soil => {
      if (soil.nextTestDueDate) {
        const dueDate = new Date(soil.nextTestDueDate);
        if (dueDate <= today) testsDue++;
      }
    });

    // Afficher les statistiques
    const statsHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon primary">
            <i class="fas fa-vial"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Total Samples</span>
            <span class="stat-value">${totalSamples}</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon info">
            <i class="fas fa-tint"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Average pH</span>
            <span class="stat-value">${avgPh}</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon success">
            <i class="fas fa-recycle"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Avg Organic Matter</span>
            <span class="stat-value">${avgOrganic}%</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon ${problematicSoils > 0 ? 'warning' : 'success'}">
            <i class="fas fa-${problematicSoils > 0 ? 'exclamation-triangle' : 'check-circle'}"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Problematic Soils</span>
            <span class="stat-value">${problematicSoils}</span>
          </div>
        </div>

        ${testsDue > 0 ? `
        <div class="stat-card">
          <div class="stat-icon warning">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Tests Due</span>
            <span class="stat-value">${testsDue}</span>
          </div>
        </div>
        ` : ''}
      </div>
    `;

    statsContainer.innerHTML = statsHTML;

  } catch (error) {
    console.error('Error updating soil statistics:', error);
  }
}

/**
 * Display empty soil data state
 */
function displayEmptySoilData() {
  const container = document.getElementById('soilDataGrid');
  if (!container) return;

  container.innerHTML = `
    <div class="empty-state">
      <div class="empty-icon">
        <i class="fas fa-mountain"></i>
      </div>
      <h3>No Soil Data Available</h3>
      <p>Start managing your soil health by conducting soil tests.</p>
      <div class="empty-state-actions">
        <button class="btn btn-primary" onclick="showSoilTestingInfo()">
          <i class="fas fa-flask"></i>
          Learn About Soil Testing
        </button>
      </div>
    </div>
  `;

  // R√©initialiser les stats
  const statsContainer = document.getElementById('soilStats');
  if (statsContainer) {
    statsContainer.innerHTML = `
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-vial"></i>
          </div>
          <div class="stat-content">
            <span class="stat-label">Total Samples</span>
            <span class="stat-value">0</span>
          </div>
        </div>
      </div>
    `;
  }
}

/**
 * Get pH status class
 */
function getPhStatus(ph) {
  const phValue = parseFloat(ph);
  if (isNaN(phValue)) return 'unknown';

  if (phValue >= 6.0 && phValue <= 7.5) return 'good';
  if ((phValue >= 5.5 && phValue < 6.0) || (phValue > 7.5 && phValue <= 8.0)) return 'moderate';
  return 'poor';
}

/**
 * Get pH label
 */
function getPhLabel(ph) {
  const phValue = parseFloat(ph);
  if (isNaN(phValue)) return 'Unknown';

  if (phValue >= 6.0 && phValue <= 7.5) return 'Optimal';
  if (phValue < 6.0) return 'Acidic';
  return 'Alkaline';
}

/**
 * View soil details - CORRECTION
 */
async function viewSoilDetails(soilId) {
  try {
    showLoading();

    // CORRECTION: Utiliser le bon endpoint
    const soil = await apiRequest(`/v1/soil-data/${soilId}`);

    showSoilDetailsModal(soil);

  } catch (error) {
    console.error('Error loading soil details:', error);
    showToast('‚ùå Error loading soil details', 'error');
  } finally {
    hideLoading();
  }
}

/**
 * Show soil details modal
 */
function showSoilDetailsModal(soil) {
  if (!soil) return;

  const modalHTML = `
    <div class="modal-overlay show" id="soilModal" onclick="if(event.target === this) closeSoilModal()">
      <div class="modal-container modal-large">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-flask"></i>
            Soil Analysis Report
          </h3>
          <button class="modal-close" onclick="closeSoilModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="soil-report">

            <!-- Sample Information -->
            <div class="report-section">
              <h4><i class="fas fa-info-circle"></i> Sample Information</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <label>Sample Code:</label>
                  <value>${soil.sampleCode || 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Measurement Date:</label>
                  <value>${soil.measurementDate ? formatDate(soil.measurementDate) : 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Depth:</label>
                  <value>${soil.depthCm || 'N/A'} cm</value>
                </div>
                <div class="detail-item">
                  <label>Soil Texture:</label>
                  <value>${soil.soilTexture || 'N/A'}</value>
                </div>
              </div>
            </div>

            <!-- Chemical Properties -->
            <div class="report-section">
              <h4><i class="fas fa-flask"></i> Chemical Properties</h4>
              <div class="details-grid">
                <div class="detail-item highlight">
                  <label>pH Level:</label>
                  <value class="${getPhStatus(soil.phLevel)}">
                    ${soil.phLevel ? parseFloat(soil.phLevel).toFixed(2) : 'N/A'}
                    <span class="status-badge">${getPhLabel(soil.phLevel)}</span>
                  </value>
                </div>
                <div class="detail-item">
                  <label>Nitrogen (N):</label>
                  <value>${soil.nitrogenLevel || 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Phosphorus (P):</label>
                  <value>${soil.phosphorusLevel || 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Potassium (K):</label>
                  <value>${soil.potassiumLevel || 'N/A'}</value>
                </div>
                <div class="detail-item">
                  <label>Organic Matter:</label>
                  <value>${soil.organicMatter ? parseFloat(soil.organicMatter).toFixed(2) + '%' : 'N/A'}</value>
                </div>
                ${soil.electricalConductivity ? `
                <div class="detail-item">
                  <label>EC (Salinity):</label>
                  <value>${soil.electricalConductivity} dS/m</value>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Physical Properties -->
            <div class="report-section">
              <h4><i class="fas fa-layer-group"></i> Physical Properties</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <label>Moisture:</label>
                  <value>${soil.moisture ? parseFloat(soil.moisture).toFixed(2) + '%' : 'N/A'}</value>
                </div>
                ${soil.bulkDensity ? `
                <div class="detail-item">
                  <label>Bulk Density:</label>
                  <value>${soil.bulkDensity} g/cm¬≥</value>
                </div>
                ` : ''}
                ${soil.porosity ? `
                <div class="detail-item">
                  <label>Porosity:</label>
                  <value>${soil.porosity}%</value>
                </div>
                ` : ''}
                ${soil.drainageClass ? `
                <div class="detail-item">
                  <label>Drainage Class:</label>
                  <value>${soil.drainageClass}</value>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Laboratory Information -->
            ${soil.laboratoryName || soil.testingMethod ? `
            <div class="report-section">
              <h4><i class="fas fa-microscope"></i> Laboratory Information</h4>
              <div class="details-grid">
                ${soil.laboratoryName ? `
                <div class="detail-item">
                  <label>Laboratory:</label>
                  <value>${soil.laboratoryName}</value>
                </div>
                ` : ''}
                ${soil.testingMethod ? `
                <div class="detail-item">
                  <label>Testing Method:</label>
                  <value>${soil.testingMethod}</value>
                </div>
                ` : ''}
                ${soil.testedBy ? `
                <div class="detail-item">
                  <label>Tested By:</label>
                  <value>${soil.testedBy}</value>
                </div>
                ` : ''}
              </div>
            </div>
            ` : ''}

            <!-- Recommendations -->
            ${soil.recommendations ? `
            <div class="report-section recommendations">
              <h4><i class="fas fa-lightbulb"></i> Recommendations</h4>
              <div class="recommendations-content">
                <p>${soil.recommendations}</p>
              </div>
            </div>
            ` : ''}

            <!-- Notes -->
            ${soil.notes ? `
            <div class="report-section">
              <h4><i class="fas fa-sticky-note"></i> Additional Notes</h4>
              <div class="notes-content">
                <p>${soil.notes}</p>
              </div>
            </div>
            ` : ''}

            <!-- Next Test Due -->
            ${soil.nextTestDueDate ? `
            <div class="report-section">
              <h4><i class="fas fa-calendar-check"></i> Next Test Schedule</h4>
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Next soil test recommended by: <strong>${formatDate(soil.nextTestDueDate)}</strong>
              </div>
            </div>
            ` : ''}

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeSoilModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
          <button type="button" class="btn btn-primary" onclick="downloadSoilReport('${soil.id}')">
            <i class="fas fa-download"></i>
            Download PDF
          </button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close soil modal
 */
function closeSoilModal() {
  const modal = document.getElementById('soilModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}









/**
 * Download soil report as PDF - IMPROVED VERSION
 */
async function downloadSoilReport(soilId) {
  try {
    showLoading();
    showToast('Generating PDF report...', 'info');

    // R√©cup√©rer les donn√©es compl√®tes
    const soil = await apiRequest(`/v1/soil-data/${soilId}`);

    // Cr√©er le contenu HTML pour le PDF
    const reportHTML = generateSoilReportHTML(soil);

    // Cr√©er un conteneur temporaire
    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = reportHTML;
    tempContainer.style.padding = '20px';
    tempContainer.style.backgroundColor = 'white';
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    tempContainer.style.width = '210mm'; // A4 width
    document.body.appendChild(tempContainer);

    // G√©n√©rer le PDF avec html2canvas et jsPDF
    const canvas = await html2canvas(tempContainer, {
      scale: 2,
      useCORS: true,
      logging: false,
      backgroundColor: '#ffffff'
    });
    const imgData = canvas.toDataURL('image/png');

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgWidth = 210;
    const pageHeight = 297;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    // Nettoyer
    document.body.removeChild(tempContainer);

    // Sauvegarder
    const fileName = `soil_report_${soil.sampleCode || soil.id}_${new Date().toISOString().split('T')[0]}.pdf`;
    pdf.save(fileName);

    showToast('‚úÖ PDF report downloaded successfully', 'success');

  } catch (error) {
    console.error('Error generating PDF:', error);
    showToast('‚ùå Error generating PDF report', 'error');
  } finally {
    hideLoading();
  }
}












/**
 * Generate HTML for soil report PDF - PROFESSIONAL & ONE PAGE
 */
function generateSoilReportHTML(soil) {
  const phLevel = soil.phLevel ? parseFloat(soil.phLevel).toFixed(2) : 'N/A';
  const phStatus = getPhStatus(soil.phLevel);
  const phLabel = getPhLabel(soil.phLevel);

  return `
    <div style="font-family: Arial, sans-serif; padding: 15px; background: #ffffff; color: #1f2937; font-size: 11px;">

      <!-- Header Section -->
      <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #22c55e;">
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="width: 70%;">
              <h1 style="margin: 0 0 4px 0; font-size: 20px; color: #1f2937; font-weight: 700;">Soil Analysis Report</h1>
              <p style="margin: 0; color: #22c55e; font-size: 10px; font-weight: 600; text-transform: uppercase;">AgriGuard AI - Smart Farming</p>
            </td>
            <td style="width: 30%; text-align: right; vertical-align: top;">
              <div style="font-size: 9px; color: #6b7280;">
                <strong>Report Date:</strong><br>${formatDate(new Date().toISOString())}<br>
                <strong>Sample:</strong> ${soil.sampleCode || 'N/A'}
              </div>
            </td>
          </tr>
        </table>
      </div>

      <!-- Sample Information -->
      <div style="margin-bottom: 12px;">
        <h2 style="margin: 0 0 6px 0; font-size: 12px; color: #16a34a; font-weight: 700; border-bottom: 1px solid #e5e7eb; padding-bottom: 3px;">SAMPLE INFORMATION</h2>
        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
          <tr>
            <td style="width: 25%; padding: 4px; background: #f9fafb; border: 1px solid #e5e7eb;"><strong>Sample Code:</strong></td>
            <td style="width: 25%; padding: 4px; border: 1px solid #e5e7eb;">${soil.sampleCode || 'N/A'}</td>
            <td style="width: 25%; padding: 4px; background: #f9fafb; border: 1px solid #e5e7eb;"><strong>Date:</strong></td>
            <td style="width: 25%; padding: 4px; border: 1px solid #e5e7eb;">${soil.measurementDate ? formatDate(soil.measurementDate) : 'N/A'}</td>
          </tr>
          <tr>
            <td style="padding: 4px; background: #f9fafb; border: 1px solid #e5e7eb;"><strong>Depth:</strong></td>
            <td style="padding: 4px; border: 1px solid #e5e7eb;">${soil.depthCm || 'N/A'} cm</td>
            <td style="padding: 4px; background: #f9fafb; border: 1px solid #e5e7eb;"><strong>Texture:</strong></td>
            <td style="padding: 4px; border: 1px solid #e5e7eb;">${soil.soilTexture || 'N/A'}</td>
          </tr>
        </table>
      </div>

      <!-- Chemical Analysis -->
      <div style="margin-bottom: 12px;">
        <h2 style="margin: 0 0 6px 0; font-size: 12px; color: #16a34a; font-weight: 700; border-bottom: 1px solid #e5e7eb; padding-bottom: 3px;">CHEMICAL ANALYSIS</h2>
        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
          <thead>
            <tr style="background: #f3f4f6;">
              <th style="padding: 5px; text-align: left; border: 1px solid #e5e7eb; font-weight: 700;">Parameter</th>
              <th style="padding: 5px; text-align: center; border: 1px solid #e5e7eb; font-weight: 700;">Value</th>
              <th style="padding: 5px; text-align: center; border: 1px solid #e5e7eb; font-weight: 700;">Status</th>
              <th style="padding: 5px; text-align: left; border: 1px solid #e5e7eb; font-weight: 700;">Interpretation</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="padding: 5px; border: 1px solid #e5e7eb;"><strong>pH Level</strong></td>
              <td style="padding: 5px; text-align: center; border: 1px solid #e5e7eb; font-weight: 700; color: ${phStatus === 'good' ? '#22c55e' : phStatus === 'moderate' ? '#f59e0b' : '#ef4444'};">${phLevel}</td>
              <td style="padding: 5px; text-align: center; border: 1px solid #e5e7eb;">
                <span style="padding: 2px 8px; background: ${phStatus === 'good' ? '#22c55e' : phStatus === 'moderate' ? '#f59e0b' : '#ef4444'}; color: white; border-radius: 10px; font-size: 9px; font-weight: 600;">${phLabel}</span>
              </td>
              <td style="padding: 5px; border: 1px solid #e5e7eb; font-size: 9px;">${getPhInterpretation(phStatus)}</td>
            </tr>
            <tr style="background: #f9fafb;">
              <td style="padding: 5px; border: 1px solid #e5e7eb;"><strong>Nitrogen (N)</strong></td>
              <td style="padding: 5px; text-align: center; border: 1px solid #e5e7eb; font-weight: 700; color: ${getNutrientColor(soil.nitrogenLevel)};">${soil.nitrogenLevel || 'N/A'}</td>
              <td style="padding: 5px; text-align: center; border: 1px solid #e5e7eb;">
                <span style="padding: 2px 8px; background: ${getNutrientColor(soil.nitrogenLevel)}; color: white; border-radius: 10px; font-size: 9px; font-weight: 600;">${getNutrientStatusLabel(soil.nitrogenLevel)}</span>
              </td>
              <td style="padding: 5px; border: 1px solid #e5e7eb; font-size: 9px;">Essential for leaf growth</td>
            </tr>
            <tr>
              <td style="padding: 5px; border: 1px solid #e5e7eb;"><strong>Phosphorus (P)</strong></td>
              <td style="padding: 5px; text-align: center; border: 1px solid #e5e7eb; font-weight: 700; color: ${getNutrientColor(soil.phosphorusLevel)};">${soil.phosphorusLevel || 'N/A'}</td>
              <td style="padding: 5px; text-align: center; border: 1px solid #e5e7eb;">
                <span style="padding: 2px 8px; background: ${getNutrientColor(soil.phosphorusLevel)}; color: white; border-radius: 10px; font-size: 9px; font-weight: 600;">${getNutrientStatusLabel(soil.phosphorusLevel)}</span>
              </td>
              <td style="padding: 5px; border: 1px solid #e5e7eb; font-size: 9px;">Important for root development</td>
            </tr>
            <tr style="background: #f9fafb;">
              <td style="padding: 5px; border: 1px solid #e5e7eb;"><strong>Potassium (K)</strong></td>
              <td style="padding: 5px; text-align: center; border: 1px solid #e5e7eb; font-weight: 700; color: ${getNutrientColor(soil.potassiumLevel)};">${soil.potassiumLevel || 'N/A'}</td>
              <td style="padding: 5px; text-align: center; border: 1px solid #e5e7eb;">
                <span style="padding: 2px 8px; background: ${getNutrientColor(soil.potassiumLevel)}; color: white; border-radius: 10px; font-size: 9px; font-weight: 600;">${getNutrientStatusLabel(soil.potassiumLevel)}</span>
              </td>
              <td style="padding: 5px; border: 1px solid #e5e7eb; font-size: 9px;">Crucial for overall plant health</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Physical Properties -->
      <div style="margin-bottom: 12px;">
        <h2 style="margin: 0 0 6px 0; font-size: 12px; color: #16a34a; font-weight: 700; border-bottom: 1px solid #e5e7eb; padding-bottom: 3px;">PHYSICAL PROPERTIES</h2>
        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
          <tr>
            <td style="width: 25%; padding: 4px; background: #f9fafb; border: 1px solid #e5e7eb;"><strong>Organic Matter:</strong></td>
            <td style="width: 25%; padding: 4px; border: 1px solid #e5e7eb;">${soil.organicMatter ? parseFloat(soil.organicMatter).toFixed(2) + '%' : 'N/A'}</td>
            <td style="width: 25%; padding: 4px; background: #f9fafb; border: 1px solid #e5e7eb;"><strong>Moisture:</strong></td>
            <td style="width: 25%; padding: 4px; border: 1px solid #e5e7eb;">${soil.moisture ? parseFloat(soil.moisture).toFixed(2) + '%' : 'N/A'}</td>
          </tr>
          ${soil.bulkDensity || soil.electricalConductivity ? `
          <tr>
            ${soil.bulkDensity ? `
            <td style="padding: 4px; background: #f9fafb; border: 1px solid #e5e7eb;"><strong>Bulk Density:</strong></td>
            <td style="padding: 4px; border: 1px solid #e5e7eb;">${soil.bulkDensity} g/cm¬≥</td>
            ` : '<td colspan="2" style="border: 1px solid #e5e7eb;"></td>'}
            ${soil.electricalConductivity ? `
            <td style="padding: 4px; background: #f9fafb; border: 1px solid #e5e7eb;"><strong>EC (Salinity):</strong></td>
            <td style="padding: 4px; border: 1px solid #e5e7eb;">${soil.electricalConductivity} dS/m</td>
            ` : '<td colspan="2" style="border: 1px solid #e5e7eb;"></td>'}
          </tr>
          ` : ''}
        </table>
      </div>

      ${soil.recommendations ? `
      <!-- Recommendations -->
      <div style="margin-bottom: 12px; background: #fffbeb; padding: 10px; border-left: 3px solid #f59e0b; border-radius: 4px;">
        <h2 style="margin: 0 0 5px 0; font-size: 11px; color: #92400e; font-weight: 700;">RECOMMENDATIONS</h2>
        <p style="margin: 0; line-height: 1.5; color: #78350f; font-size: 10px;">${soil.recommendations}</p>
      </div>
      ` : ''}

      <!-- Laboratory & Footer -->
      <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
        <table style="width: 100%; border-collapse: collapse; font-size: 9px; color: #6b7280;">
          <tr>
            <td style="width: 50%; vertical-align: top;">
              ${soil.laboratoryName ? `<strong>Laboratory:</strong> ${soil.laboratoryName}<br>` : ''}
              ${soil.testingMethod ? `<strong>Method:</strong> ${soil.testingMethod}<br>` : ''}
              ${soil.testedBy ? `<strong>Tested by:</strong> ${soil.testedBy}` : ''}
            </td>
            <td style="width: 50%; text-align: right; vertical-align: top;">
              <strong>Generated:</strong> ${formatDateTime(new Date().toISOString())}<br>
              <strong style="color: #22c55e;">AgriGuard AI</strong> - Smart Agriculture Management
            </td>
          </tr>
        </table>
      </div>
    </div>
  `;
}






/**
 * Helper: Get pH interpretation
 */
function getPhInterpretation(status) {
  if (status === 'good') return 'Optimal range for most crops';
  if (status === 'moderate') return 'Acceptable but may need adjustment';
  return 'Requires correction for optimal growth';
}

/**
 * Helper: Get nutrient status label
 */
function getNutrientStatusLabel(level) {
  if (!level || level === 'N/A') return 'N/A';
  const levelUpper = level.toUpperCase();
  if (levelUpper.includes('HIGH') || levelUpper.includes('GOOD')) return 'Good';
  if (levelUpper.includes('VERY_LOW')) return 'Very Low';
  if (levelUpper.includes('LOW') || levelUpper.includes('POOR')) return 'Low';
  return 'Medium';
}

/**
 * Helper: Get nutrient color based on level
 */
function getNutrientColor(level) {
  if (!level || level === 'N/A') return '#6b7280';
  const levelUpper = level.toUpperCase();
  if (levelUpper.includes('HIGH') || levelUpper.includes('GOOD')) return '#22c55e';
  if (levelUpper.includes('LOW') || levelUpper.includes('POOR') || levelUpper.includes('VERY_LOW')) return '#ef4444';
  return '#f59e0b';
}











/**
 * Show soil testing info
 */
function showSoilTestingInfo() {
  const modalHTML = `
    <div class="modal-overlay show" id="infoModal" onclick="if(event.target === this) closeInfoModal()">
      <div class="modal-container">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-info-circle"></i>
            About Soil Testing
          </h3>
          <button class="modal-close" onclick="closeInfoModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="info-content">
            <h4><i class="fas fa-question-circle"></i> Why Test Your Soil?</h4>
            <p>Regular soil testing is essential for:</p>
            <ul>
              <li>Understanding nutrient levels in your soil</li>
              <li>Optimizing fertilizer application</li>
              <li>Improving crop yields</li>
              <li>Preventing nutrient deficiencies</li>
              <li>Managing soil pH levels</li>
              <li>Making informed farming decisions</li>
            </ul>

            <h4 style="margin-top: 20px;"><i class="fas fa-calendar-check"></i> When to Test?</h4>
            <p>It's recommended to test your soil:</p>
            <ul>
              <li>Before the growing season (every 1-3 years)</li>
              <li>When starting a new farm or field</li>
              <li>If you notice poor crop performance</li>
              <li>After significant changes in management practices</li>
            </ul>

            <h4 style="margin-top: 20px;"><i class="fas fa-flask"></i> What Gets Tested?</h4>
            <p>A comprehensive soil test typically measures:</p>
            <ul>
              <li><strong>pH Level:</strong> Soil acidity/alkalinity</li>
              <li><strong>NPK:</strong> Nitrogen, Phosphorus, Potassium</li>
              <li><strong>Organic Matter:</strong> Soil health indicator</li>
              <li><strong>Micronutrients:</strong> Essential trace elements</li>
              <li><strong>Salinity:</strong> Salt content in soil</li>
            </ul>

            <h4 style="margin-top: 20px;"><i class="fas fa-phone"></i> How to Get Started?</h4>
            <p>Contact your local agricultural extension office or:</p>
            <ul>
              <li>Visit a certified soil testing laboratory</li>
              <li>Consult with an agricultural advisor</li>
              <li>Contact the Ministry of Agriculture</li>
            </ul>

            <div class="alert alert-info" style="margin-top: 20px;">
              <i class="fas fa-lightbulb"></i>
              <strong>Pro Tip:</strong> Keep records of all soil tests to track changes over time and make better management decisions.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="closeInfoModal()">
            <i class="fas fa-check"></i>
            Got It
          </button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Close info modal
 */
function closeInfoModal() {
  const modal = document.getElementById('infoModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}

/**
 * Helper function to update element content safely
 */
function updateElement(elementId, content) {
  const element = document.getElementById(elementId);
  if (element) {
    if (typeof content === 'object' && content !== null) {
      element.innerHTML = content;
    } else {
      element.textContent = content;
    }
  }
}

/**
 * Format date helper
 */
function formatDate(dateString) {
  if (!dateString) return 'N/A';

  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'N/A';

    return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    }).format(date);
  } catch (error) {
    return 'N/A';
  }
}

/**
 * Format datetime helper
 */
function formatDateTime(dateString) {
  if (!dateString) return 'N/A';

  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'N/A';

    return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }).format(date);
  } catch (error) {
    return 'N/A';
  }
}

// ============================================================================
// STYLES POUR LE MODULE SOIL DATA
// ============================================================================

/**
 * Ajouter ces styles CSS √† votre fichier principal
 */
const soilDataStyles = `
<style>
/* Soil Data Card Styles */
.soil-data-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  padding: 20px;
  transition: all 0.3s ease;
  border-left: 4px solid #3498db;
}

.soil-data-card:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transform: translateY(-2px);
}

.soil-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #ecf0f1;
}

.soil-farm-name {
  margin: 0;
  font-size: 1.25rem;
  color: #2c3e50;
  display: flex;
  align-items: center;
  gap: 8px;
}

.soil-sample-code {
  display: block;
  font-size: 0.875rem;
  color: #7f8c8d;
  margin-top: 5px;
}

.soil-date {
  font-size: 0.875rem;
  color: #7f8c8d;
  display: flex;
  align-items: center;
  gap: 5px;
}

/* Soil Metrics Grid */
.soil-metrics {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.soil-metric {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: #f8f9fa;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.soil-metric:hover {
  background: #e9ecef;
}

.soil-metric-primary {
  grid-column: 1 / -1;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
}

.metric-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  flex-shrink: 0;
}

.soil-metric-primary .metric-icon {
  background: rgba(255, 255, 255, 0.2);
  color: white;
}

.metric-icon.good {
  background: #d4edda;
  color: #155724;
}

.metric-icon.moderate {
  background: #fff3cd;
  color: #856404;
}

.metric-icon.poor {
  background: #f8d7da;
  color: #721c24;
}

.metric-content {
  flex: 1;
}

.metric-label {
  display: block;
  font-size: 0.875rem;
  color: #6c757d;
  margin-bottom: 4px;
}

.soil-metric-primary .metric-label {
  color: rgba(255, 255, 255, 0.9);
}

.metric-value {
  font-size: 1.25rem;
  font-weight: 600;
  color: #2c3e50;
}

.metric-value-large {
  font-size: 2rem;
  font-weight: 700;
  color: white;
  line-height: 1;
}

.metric-status {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-top: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.metric-status.good {
  background: rgba(255, 255, 255, 0.3);
  color: white;
}

.metric-status.moderate {
  background: rgba(255, 193, 7, 0.3);
  color: white;
}

.metric-status.poor {
  background: rgba(220, 53, 69, 0.3);
  color: white;
}

/* Recommendations Section */
.soil-recommendations,
.soil-notes {
  margin: 20px 0;
  padding: 15px;
  background: #fff8e1;
  border-left: 4px solid #ffc107;
  border-radius: 8px;
}

.soil-recommendations h4,
.soil-notes h4 {
  margin: 0 0 10px 0;
  color: #f57c00;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 1rem;
}

.soil-recommendations p,
.soil-notes p {
  margin: 0;
  line-height: 1.6;
  color: #5d4037;
}

/* Soil Footer */
.soil-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid #ecf0f1;
  gap: 15px;
  flex-wrap: wrap;
}

.soil-meta {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

.soil-meta-item {
  font-size: 0.875rem;
  color: #7f8c8d;
  display: flex;
  align-items: center;
  gap: 5px;
}

.soil-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

/* Report Modal Styles */
.soil-report {
  max-height: 70vh;
  overflow-y: auto;
  padding: 10px;
}

.report-section {
  margin-bottom: 25px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
}

.report-section h4 {
  margin: 0 0 15px 0;
  color: #2c3e50;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.1rem;
  border-bottom: 2px solid #3498db;
  padding-bottom: 10px;
}

.report-section.recommendations {
  background: #e8f5e9;
  border-left: 4px solid #4caf50;
}

.recommendations-content,
.notes-content {
  padding: 10px;
  line-height: 1.8;
  color: #2c3e50;
}

.details-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.detail-item {
  padding: 12px;
  background: white;
  border-radius: 6px;
  border: 1px solid #dee2e6;
}

.detail-item.highlight {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
}

.detail-item label {
  display: block;
  font-size: 0.875rem;
  color: #6c757d;
  margin-bottom: 5px;
  font-weight: 500;
}

.detail-item.highlight label {
  color: rgba(255, 255, 255, 0.9);
}

.detail-item value {
  display: block;
  font-size: 1.1rem;
  font-weight: 600;
  color: #2c3e50;
}

.detail-item.highlight value {
  color: white;
  font-size: 1.5rem;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #6c757d;
}

.empty-icon {
  font-size: 4rem;
  color: #dee2e6;
  margin-bottom: 20px;
}

.empty-state h3 {
  margin: 0 0 10px 0;
  color: #495057;
}

.empty-state p {
  margin: 10px 0;
  font-size: 1rem;
}

.empty-state-hint {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  background: #e3f2fd;
  border-radius: 8px;
  color: #1976d2;
  font-size: 0.875rem;
  margin-top: 15px;
}

.empty-state-actions {
  margin-top: 25px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .soil-metrics {
    grid-template-columns: 1fr;
  }

  .soil-header {
    flex-direction: column;
    gap: 15px;
  }

  .soil-footer {
    flex-direction: column;
    align-items: flex-start;
  }

  .details-grid {
    grid-template-columns: 1fr;
  }
}

/* Info Modal Content Styles */
.info-content h4 {
  color: #2c3e50;
  margin-top: 20px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.info-content ul {
  padding-left: 20px;
  line-height: 1.8;
}

.info-content li {
  margin-bottom: 8px;
  color: #495057;
}

.alert {
  padding: 15px;
  border-radius: 8px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.alert-info {
  background: #e3f2fd;
  border-left: 4px solid #2196f3;
  color: #0d47a1;
}

.alert i {
  font-size: 1.2rem;
  flex-shrink: 0;
  margin-top: 2px;
}
</style>
`;

// Export pour utilisation
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    loadSoilData,
    viewSoilDetails,
    downloadSoilReport,
    showSoilTestingInfo
  };
}





      // ============================================================================
      // MARKET PRICES MODULE
      // ============================================================================

      /**
      * Load market prices data
      */
      async function loadMarketPricesData() {
      try {
      showLoading();

      const response = await apiRequest('/market-prices');
      const prices = response.content || response || [];

      displayMarketPricesGrid(prices);

      } catch (error) {
      console.error('Error loading market prices:', error);
      showToast('Error loading market prices', 'error');
      } finally {
      hideLoading();
      }
      }

      /**
      * Display market prices grid
      */
      function displayMarketPricesGrid(prices) {
      const container = document.getElementById('marketPricesGrid');
      if (!container) return;

      if (prices.length === 0) {
      container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-chart-line"></i>
        <p>No market prices available</p>
      </div>
      `;
      return;
      }

      container.innerHTML = prices.map(price => `
      <div class="market-price-card">
        <div class="price-header">
          <h3>${price.cropName || 'Crop'}</h3>
          <span class="price-value">${formatCurrency(price.pricePerKg)}/kg</span>
        </div>
        <div class="price-details">
          <div class="price-detail-item">
            <label>Market:</label>
            <span>${price.marketName}</span>
          </div>
          <div class="price-detail-item">
            <label>Location:</label>
            <span>${price.location}</span>
          </div>
          <div class="price-detail-item">
            <label>Type:</label>
            <span>${price.marketType}</span>
          </div>
          <div class="price-detail-item">
            <label>Demand:</label>
            <span class="demand-${price.demandLevel.toLowerCase()}">${price.demandLevel}</span>
          </div>
          <div class="price-detail-item">
            <label>Trend:</label>
            <span class="trend-${price.priceTrend.toLowerCase()}">
                              <i class="fas ${getTrendIcon(price.priceTrend)}"></i>
                              ${price.priceTrend}
                          </span>
          </div>
          <div class="price-detail-item">
            <label>Date:</label>
            <span>${formatDate(price.priceDate)}</span>
          </div>
        </div>
      </div>
      `).join('');
      }

      /**
      * Get trend icon
      */
      function getTrendIcon(trend) {
      const icons = {
      'INCREASING': 'fa-arrow-up',
      'DECREASING': 'fa-arrow-down',
      'STABLE': 'fa-minus'
      };
      return icons[trend] || 'fa-minus';
      }





/**
 * Load transactions data - VERSION CORRIG√âE
 */
async function loadTransactionsData() {
  try {
    showLoading();

    // ‚úÖ CORRECTION: Validation utilisateur
    if (!currentUser || !currentUser.id) {
      console.error('‚ùå No current user found');
      displayEmptyTransactions();
      return;
    }

    if (DEBUG_MODE) {
      console.log('üîÑ Loading transactions for farmer:', currentUser.id);
    }

    // ‚úÖ R√©cup√©ration des transactions
    const response = await apiRequest(`/transactions/farmer/${currentUser.id}`);

    // ‚úÖ Extraction des donn√©es
    let transactions = [];
    if (Array.isArray(response)) {
      transactions = response;
    } else if (response && response.content && Array.isArray(response.content)) {
      transactions = response.content;
    } else if (response && response.data && Array.isArray(response.data)) {
      transactions = response.data;
    } else {
      console.warn('‚ö†Ô∏è Unexpected transactions response format:', response);
      transactions = [];
    }

    console.log(`‚úÖ Loaded ${transactions.length} transactions`);

    // ‚úÖ Filtrer les transactions valides
    const validTransactions = transactions.filter(tx =>
      tx && typeof tx === 'object' && tx.transactionStatus
    );

    if (validTransactions.length < transactions.length) {
      console.warn(`‚ö†Ô∏è Filtered out ${transactions.length - validTransactions.length} invalid transactions`);
    }

    // Update statistics
    const totalCount = validTransactions.length;
    const completed = validTransactions.filter(t =>
      t.transactionStatus === 'PAID' || t.transactionStatus === 'COMPLETED'
    ).length;

    const totalAmount = validTransactions.reduce((sum, t) => {
      const amount = parseFloat(t.totalAmount);
      return sum + (isNaN(amount) ? 0 : amount);
    }, 0);

    const netAmount = validTransactions.reduce((sum, t) => {
      const amount = parseFloat(t.netAmount);
      return sum + (isNaN(amount) ? 0 : amount);
    }, 0);

    // ‚úÖ Mise √† jour UI avec gestion d'erreur
    updateElement('txTotalCount', totalCount);
    updateElement('txCompleted', completed);
    updateElement('txTotalAmount', formatCurrency(totalAmount));
    updateElement('txNetAmount', formatCurrency(netAmount));

    // ‚úÖ Affichage du tableau
    displayTransactionsTable(validTransactions);

  } catch (error) {
    console.error('‚ùå Error loading transactions:', error);
    showToast('Unable to load transactions data', 'warning');
    displayEmptyTransactions();
  } finally {
    hideLoading();
  }
}



/**
 * Afficher un √©tat vide pour les transactions
 */
function displayEmptyTransactions() {
  // R√©initialiser les statistiques
  updateElement('txTotalCount', 0);
  updateElement('txCompleted', 0);
  updateElement('txTotalAmount', formatCurrency(0));
  updateElement('txNetAmount', formatCurrency(0));

  // Afficher l'√©tat vide dans le tableau
  const tbody = document.getElementById('transactionsTableBody');
  if (tbody) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="empty-state">
          <div class="empty-icon">
            <i class="fas fa-exchange-alt"></i>
          </div>
          <p>No transactions available</p>
          <p class="empty-state-hint">
            Your transaction history will appear here once you start selling your produce
          </p>
        </td>
      </tr>
    `;
  }
}






/**
 * Display transactions table - VERSION CORRIG√âE
 */
function displayTransactionsTable(transactions) {
  const tbody = document.getElementById('transactionsTableBody');
  if (!tbody) return;

  // ‚úÖ CORRECTION 1: G√©rer le format de r√©ponse API
  let transactionsList = [];
  if (Array.isArray(transactions)) {
    transactionsList = transactions;
  } else if (transactions && transactions.content && Array.isArray(transactions.content)) {
    transactionsList = transactions.content;
  } else if (transactions && transactions.data && Array.isArray(transactions.data)) {
    transactionsList = transactions.data;
  } else {
    console.warn('‚ö†Ô∏è Unexpected transactions format:', transactions);
    transactionsList = [];
  }

  if (transactionsList.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="empty-state">
          <i class="fas fa-exchange-alt"></i>
          <p>No transactions yet</p>
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = transactionsList.map(tx => {
    // ‚úÖ CORRECTION 2: Validation compl√®te de chaque transaction
    if (!tx || !tx.transactionStatus) {
      console.warn('‚ö†Ô∏è Invalid transaction data:', tx);
      return '';
    }

    // ‚úÖ CORRECTION 3: G√©rer les valeurs nulles/undefined
    const transactionCode = tx.transactionCode || 'N/A';
    const transactionDate = tx.transactionDate ? formatDate(tx.transactionDate) : 'N/A';
    const buyerName = tx.buyerName || 'Unknown Buyer';
    const cropName = tx.cropName || 'N/A';
    const quantity = tx.quantity || 0;
    const unit = tx.unit || 'KG';
    const totalAmount = tx.totalAmount ? formatCurrency(tx.totalAmount) : formatCurrency(0);
    const netAmount = tx.netAmount ? formatCurrency(tx.netAmount) : formatCurrency(0);
    const transactionStatus = tx.transactionStatus || 'UNKNOWN';
    const statusLower = transactionStatus.toLowerCase();
    const transactionId = tx.id || tx.transactionId || '';

    return `
      <tr>
        <td><strong>${transactionCode}</strong></td>
        <td>${transactionDate}</td>
        <td>${buyerName}</td>
        <td>${cropName}</td>
        <td>${quantity} ${unit}</td>
        <td>${totalAmount}</td>
        <td>${netAmount}</td>
        <td><span class="status-badge status-${statusLower}">${transactionStatus}</span></td>
        <td>
          <button class="btn-icon" onclick="viewTransactionDetails('${transactionId}')" title="View Details">
            <i class="fas fa-eye"></i>
          </button>
          ${transactionStatus === 'PENDING' ? `
            <button class="btn-icon" onclick="updateTransactionStatus('${transactionId}', 'CONFIRMED')" title="Confirm">
              <i class="fas fa-check"></i>
            </button>
          ` : ''}
        </td>
      </tr>
    `;
  }).filter(html => html !== '').join(''); // ‚úÖ Filtrer les transactions invalides
}




/**
 * View transaction details - VERSION S√âCURIS√âE
 */
async function viewTransactionDetails(transactionId) {
  if (!transactionId) {
    showToast('‚ùå Invalid transaction ID', 'error');
    return;
  }

  try {
    showLoading();

    const transaction = await apiRequest(`/transactions/${transactionId}`);

    if (!transaction) {
      showToast('‚ùå Transaction not found', 'error');
      return;
    }

    showTransactionDetailsModal(transaction);

  } catch (error) {
    console.error('Error loading transaction details:', error);
    showToast('‚ùå Error loading transaction details', 'error');
  } finally {
    hideLoading();
  }
}


/**
 * Show transaction details modal - VERSION S√âCURIS√âE
 */
function showTransactionDetailsModal(tx) {
  if (!tx) return;

  // ‚úÖ Validation et valeurs par d√©faut
  const transactionCode = tx.transactionCode || 'N/A';
  const transactionDate = tx.transactionDate ? formatDateTime(tx.transactionDate) : 'N/A';
  const buyerName = tx.buyerName || 'Unknown Buyer';
  const cropName = tx.cropName || 'N/A';
  const quantity = tx.quantity || 0;
  const unit = tx.unit || 'KG';
  const pricePerUnit = tx.pricePerUnit ? formatCurrency(tx.pricePerUnit) : formatCurrency(0);
  const totalAmount = tx.totalAmount ? formatCurrency(tx.totalAmount) : formatCurrency(0);
  const transactionFee = tx.transactionFee ? formatCurrency(tx.transactionFee) : formatCurrency(0);
  const netAmount = tx.netAmount ? formatCurrency(tx.netAmount) : formatCurrency(0);
  const paymentMethod = tx.paymentMethod || 'N/A';
  const transactionStatus = tx.transactionStatus || 'UNKNOWN';
  const statusLower = transactionStatus.toLowerCase();
  const deliveryAddress = tx.deliveryAddress || null;
  const notes = tx.notes || null;

  const modalHTML = `
    <div class="modal-overlay show" id="transactionModal" onclick="if(event.target === this) closeTransactionModal()">
      <div class="modal-container modal-large">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-receipt"></i>
            Transaction Details
          </h3>
          <button class="modal-close" onclick="closeTransactionModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="details-grid">
            <div class="detail-item">
              <label>Transaction Code</label>
              <value><strong>${transactionCode}</strong></value>
            </div>
            <div class="detail-item">
              <label>Date</label>
              <value>${transactionDate}</value>
            </div>
            <div class="detail-item">
              <label>Buyer</label>
              <value>${buyerName}</value>
            </div>
            <div class="detail-item">
              <label>Crop</label>
              <value>${cropName}</value>
            </div>
            <div class="detail-item">
              <label>Quantity</label>
              <value>${quantity} ${unit}</value>
            </div>
            <div class="detail-item">
              <label>Price per Unit</label>
              <value>${pricePerUnit}</value>
            </div>
            <div class="detail-item">
              <label>Total Amount</label>
              <value>${totalAmount}</value>
            </div>
            <div class="detail-item">
              <label>Transaction Fee</label>
              <value>${transactionFee}</value>
            </div>
            <div class="detail-item">
              <label>Net Amount</label>
              <value class="text-success"><strong>${netAmount}</strong></value>
            </div>
            <div class="detail-item">
              <label>Payment Method</label>
              <value>${paymentMethod}</value>
            </div>
            <div class="detail-item">
              <label>Status</label>
              <value><span class="status-badge status-${statusLower}">${transactionStatus}</span></value>
            </div>
            ${deliveryAddress ? `
            <div class="detail-item full-width">
              <label>Delivery Address</label>
              <value>${deliveryAddress}</value>
            </div>
            ` : ''}
            ${notes ? `
            <div class="detail-item full-width">
              <label>Notes</label>
              <value>${notes}</value>
            </div>
            ` : ''}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeTransactionModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
          ${transactionStatus === 'PENDING' ? `
            <button type="button" class="btn btn-primary" onclick="updateTransactionStatus('${tx.id}', 'CONFIRMED')">
              <i class="fas fa-check"></i>
              Confirm Transaction
            </button>
          ` : ''}
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;
}



/**
 * Close transaction modal
 */
function closeTransactionModal() {
  const modal = document.getElementById('transactionModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      document.getElementById('modalContainer').innerHTML = '';
    }, 300);
  }
}

/**
 * Update transaction status - VERSION S√âCURIS√âE
 */
async function updateTransactionStatus(transactionId, newStatus) {
  if (!transactionId) {
    showToast('‚ùå Invalid transaction ID', 'error');
    return;
  }

  if (!confirm(`Are you sure you want to change the status to ${newStatus}?`)) {
    return;
  }

  try {
    showLoading();

    await apiRequest(`/transactions/${transactionId}/status`, {
      method: 'PUT',
      body: JSON.stringify({ status: newStatus })
    });

    showToast('‚úÖ Transaction status updated successfully', 'success');
    closeTransactionModal();
    await loadTransactionsData();

  } catch (error) {
    console.error('Error updating transaction status:', error);
    showToast('‚ùå Error updating transaction status: ' + error.message, 'error');
  } finally {
    hideLoading();
  }
}



async function loadSupplyChainData() {
    try {
        showLoading();

        // ‚úÖ CORRECTION: Utiliser l'endpoint correct
        const supplyChains = await apiRequest(`/supply-chain/farmer/${currentUser.id}`)
            .catch(err => {
                console.warn('‚ö†Ô∏è Supply chain load failed:', err);
                return []; // Retourner tableau vide en cas d'erreur
            });

        // ‚úÖ G√©rer les diff√©rents formats de r√©ponse
        let chains = [];
        if (Array.isArray(supplyChains)) {
            chains = supplyChains;
        } else if (supplyChains && supplyChains.data && Array.isArray(supplyChains.data)) {
            chains = supplyChains.data;
        } else if (supplyChains && supplyChains.content && Array.isArray(supplyChains.content)) {
            chains = supplyChains.content;
        }

        console.log(`‚úÖ Supply chains loaded: ${chains.length} records`);

        // Afficher les donn√©es
        displaySupplyChainData(chains);

        // Mettre √† jour les statistiques
        updateSupplyChainStats(chains);

    } catch (error) {
        console.error('üí• Error loading supply chain:', error);

        // Afficher un √©tat vide au lieu d'une erreur bloquante
        const container = document.getElementById('supplyChainContainer');
        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-link"></i>
                    <h3>No Supply Chain Data</h3>
                    <p>No supply chain tracking data available yet.</p>
                </div>
            `;
        }
    } finally {
        hideLoading();
    }
}



/**
 * Display supply chain data - VERSION AVEC DEBUG
 */
function displaySupplyChainData(chains) {
    const container = document.getElementById('supplyChainContainer');
    if (!container) {
        console.warn('‚ö†Ô∏è supplyChainContainer not found');
        return;
    }

    // ‚úÖ DEBUG: Afficher les donn√©es re√ßues
    console.log('üì¶ Supply chains data:', chains);

    if (!chains || chains.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-link"></i>
                <h3>No Supply Chain Data</h3>
                <p>No supply chain tracking records available yet.</p>
                <button class="btn btn-primary mt-4" onclick="openAddSupplyChainModal()">
                    <i class="fas fa-plus"></i>
                    Add Supply Chain Stage
                </button>
            </div>
        `;
        return;
    }

    // ‚úÖ V√©rifier que chaque chain a des stages
    const validChains = chains.filter(chain => {
        if (!chain.stage) {
            console.warn('‚ö†Ô∏è Chain sans stage:', chain);
            return false;
        }
        return true;
    });

    if (validChains.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Invalid Supply Chain Data</h3>
                <p>Supply chain data exists but is not properly formatted.</p>
            </div>
        `;
        return;
    }

    // Grouper par crop production
    const groupedChains = {};
    validChains.forEach(chain => {
        const key = chain.cropProductionId || 'unknown';
        if (!groupedChains[key]) {
            groupedChains[key] = [];
        }
        groupedChains[key].push(chain);
    });

    let html = '';

    Object.entries(groupedChains).forEach(([cropProductionId, stages]) => {
        // Trier par stageOrder
        stages.sort((a, b) => (a.stageOrder || 0) - (b.stageOrder || 0));

        html += `
            <div class="supply-chain-group">
                <div class="supply-chain-header">
                    <h3>
                        <i class="fas fa-seedling"></i>
                        Production: ${cropProductionId}
                    </h3>
                    <span class="badge badge-info">${stages.length} stages</span>
                </div>

                <div class="supply-chain-timeline">
                    ${stages.map((stage, index) => {
                        const isCompleted = stage.stageEndDate ? true : false;
                        const stageName = stage.stage || 'UNKNOWN';

                        return `
                        <div class="timeline-item ${isCompleted ? 'completed' : 'active'}">
                            <div class="timeline-marker">
                                <i class="fas ${getStageIcon(stageName)}"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <h4>${stageName}</h4>
                                    <span class="badge ${isCompleted ? 'badge-success' : 'badge-warning'}">
                                        ${isCompleted ? 'Completed' : 'In Progress'}
                                    </span>
                                </div>
                                <div class="timeline-details">
                                    ${stage.location ? `
                                    <div class="detail-row">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>${stage.location}${stage.facilityName ? ` - ${stage.facilityName}` : ''}</span>
                                    </div>
                                    ` : ''}

                                    ${stage.quantityIn ? `
                                    <div class="detail-row">
                                        <i class="fas fa-box"></i>
                                        <span>Quantity: ${stage.quantityIn} ${stage.unit || 'KG'}</span>
                                        ${stage.quantityOut ? ` ‚Üí ${stage.quantityOut} ${stage.unit || 'KG'}` : ''}
                                    </div>
                                    ` : ''}

                                    ${stage.responsibleParty ? `
                                    <div class="detail-row">
                                        <i class="fas fa-user"></i>
                                        <span>${stage.responsibleParty}</span>
                                    </div>
                                    ` : ''}

                                    ${stage.stageStartDate ? `
                                    <div class="detail-row">
                                        <i class="fas fa-calendar"></i>
                                        <span>Started: ${formatDateTime(stage.stageStartDate)}</span>
                                    </div>
                                    ` : ''}

                                    ${stage.stageEndDate ? `
                                        <div class="detail-row">
                                            <i class="fas fa-check"></i>
                                            <span>Completed: ${formatDateTime(stage.stageEndDate)}</span>
                                        </div>
                                    ` : ''}

                                    ${stage.lossQuantity && parseFloat(stage.lossQuantity) > 0 ? `
                                        <div class="detail-row alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <span>Loss: ${stage.lossQuantity} ${stage.unit || 'KG'} (${stage.lossPercentage}%)</span>
                                            ${stage.lossReason ? `<br><small>${stage.lossReason}</small>` : ''}
                                        </div>
                                    ` : ''}

                                    ${stage.qualityStatus ? `
                                    <div class="detail-row">
                                        <i class="fas fa-star"></i>
                                        <span>Quality: ${stage.qualityStatus}</span>
                                    </div>
                                    ` : ''}

                                    ${stage.trackingCode ? `
                                        <div class="detail-row">
                                            <i class="fas fa-barcode"></i>
                                            <span>Tracking: ${stage.trackingCode}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="timeline-actions">
                                    <button class="btn-icon" onclick="viewSupplyChainDetails('${stage.id}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn-icon" onclick="editSupplyChain('${stage.id}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${!isCompleted ? `
                                        <button class="btn-icon btn-success" onclick="completeStage('${stage.id}')" title="Complete Stage">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('')}
                </div>
            </div>
        `;
    });

    if (html) {
        container.innerHTML = html;
    } else {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>No Valid Supply Chain Data</h3>
                <p>Could not display supply chain information.</p>
            </div>
        `;
    }
}





/**
 * Update supply chain statistics
 */
function updateSupplyChainStats(chains) {
    const statsContainer = document.getElementById('supplyChainStats');
    if (!statsContainer) return;

    const totalStages = chains.length;
    const completedStages = chains.filter(c => c.stageEndDate).length;
    const activeStages = totalStages - completedStages;
    const totalLosses = chains.reduce((sum, c) =>
        sum + (parseFloat(c.lossQuantity) || 0), 0
    );
    const avgLossPercentage = chains.length > 0
        ? (chains.reduce((sum, c) => sum + (parseFloat(c.lossPercentage) || 0), 0) / chains.length).toFixed(2)
        : 0;

    statsContainer.innerHTML = `
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="fas fa-link"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Total Stages</span>
                    <span class="stat-value">${totalStages}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Completed</span>
                    <span class="stat-value">${completedStages}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon warning">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Active</span>
                    <span class="stat-value">${activeStages}</span>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Total Losses</span>
                    <span class="stat-value">${totalLosses.toFixed(2)} KG</span>
                    <small>${avgLossPercentage}% avg</small>
                </div>
            </div>
        </div>
    `;
}

/**
 * Get icon for stage
 */
function getStageIcon(stage) {
    const icons = {
        'HARVEST': 'fa-seedling',
        'COLLECTION': 'fa-boxes',
        'STORAGE': 'fa-warehouse',
        'PROCESSING': 'fa-industry',
        'PACKAGING': 'fa-box',
        'TRANSPORT': 'fa-truck',
        'DISTRIBUTION': 'fa-shipping-fast',
        'RETAIL': 'fa-store'
    };
    return icons[stage] || 'fa-circle';
}

/**
 * View supply chain details
 */
async function viewSupplyChainDetails(stageId) {
    try {
        showLoading();
        const stage = await apiRequest(`/supply-chain/${stageId}`);

        const modalHTML = `
            <div class="modal-overlay show" id="supplyChainModal">
                <div class="modal-container modal-large">
                    <div class="modal-header">
                        <h3><i class="fas fa-info-circle"></i> Supply Chain Stage Details</h3>
                        <button class="modal-close" onclick="closeSupplyChainModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="details-grid">
                            <div class="detail-item">
                                <label>Stage</label>
                                <value>${stage.stage}</value>
                            </div>
                            <div class="detail-item">
                                <label>Location</label>
                                <value>${stage.location}</value>
                            </div>
                            <div class="detail-item">
                                <label>Facility</label>
                                <value>${stage.facilityName || 'N/A'}</value>
                            </div>
                            <div class="detail-item">
                                <label>Responsible Party</label>
                                <value>${stage.responsibleParty}</value>
                            </div>
                            <div class="detail-item">
                                <label>Quantity In</label>
                                <value>${stage.quantityIn} ${stage.unit}</value>
                            </div>
                            <div class="detail-item">
                                <label>Quantity Out</label>
                                <value>${stage.quantityOut || 'N/A'} ${stage.unit || ''}</value>
                            </div>
                            <div class="detail-item">
                                <label>Quality Status</label>
                                <value>${stage.qualityStatus}</value>
                            </div>
                            <div class="detail-item">
                                <label>Tracking Code</label>
                                <value>${stage.trackingCode}</value>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeSupplyChainModal()">Close</button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('modalContainer').innerHTML = modalHTML;

    } catch (error) {
        console.error('Error loading stage details:', error);
        showToast('Error loading stage details', 'error');
    } finally {
        hideLoading();
    }
}

/**
 * Close supply chain modal
 */
function closeSupplyChainModal() {
    document.getElementById('modalContainer').innerHTML = '';
}

/**
 * Edit supply chain stage
 */
function editSupplyChain(stageId) {
    showToast('Edit functionality coming soon', 'info');
}

/**
 * Complete stage
 */
function completeStage(stageId) {
    showToast('Complete stage functionality coming soon', 'info');
}

/**
 * Open add supply chain modal
 */
function openAddSupplyChainModal() {
    showToast('Add supply chain functionality coming soon', 'info');
}

/**
 * Helper function to update element
 */
function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
    }
}





    /**
     * Display supply chain timeline
     */
    function displaySupplyChainTimeline(supplyChainData) {
      const container = document.getElementById('supplyChainContainer');
      if (!container) return;

      if (supplyChainData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-truck"></i>
            <p>No supply chain tracking data available</p>
          </div>
        `;
        return;
      }

      const stageColors = {
        'HARVEST': '#22c55e',
        'COLLECTION': '#3b82f6',
        'STORAGE': '#f59e0b',
        'PROCESSING': '#8b5cf6',
        'PACKAGING': '#ec4899',
        'TRANSPORT': '#14b8a6',
        'DISTRIBUTION': '#f97316',
        'RETAIL': '#06b6d4'
      };

      container.innerHTML = supplyChainData.map(item => `
        <div class="supply-chain-item">
          <div class="supply-chain-header">
            <div>
              <div class="supply-chain-tracking-code">Tracking: ${item.trackingCode}</div>
              <h3 class="supply-chain-title">${item.productionCode || 'Production'} - ${item.cropName || 'Crop'}</h3>
            </div>
          </div>
          <div class="supply-chain-stages">
            ${(item.stages || []).map(stage => `
              <div class="stage-card" style="border-left-color: ${stageColors[stage.stageName] || '#666'};">
                <div class="stage-name">
                  <i class="fas ${getStageIcon(stage.stageName)}"></i>
                  ${stage.stageName}
                </div>
                <div class="stage-details">
                  <strong>Date:</strong> ${formatDateTime(stage.timestamp)}<br>
                  <strong>Location:</strong> ${stage.location || 'N/A'}<br>
                  ${stage.handler ? `<strong>Handler:</strong> ${stage.handler}<br>` : ''}
                  ${stage.notes ? `<strong>Notes:</strong> ${stage.notes}` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    /**
     * Get stage icon
     */
    function getStageIcon(stageName) {
      const icons = {
        'HARVEST': 'fa-seedling',
        'COLLECTION': 'fa-hand-holding',
        'STORAGE': 'fa-warehouse',
        'PROCESSING': 'fa-cogs',
        'PACKAGING': 'fa-box',
        'TRANSPORT': 'fa-truck',
        'DISTRIBUTION': 'fa-shipping-fast',
        'RETAIL': 'fa-store'
      };
      return icons[stageName] || 'fa-circle';
    }

    // ============================================================================
    // WEATHER DATA MODULE
    // ============================================================================

    /**
     * Load weather data
     */
    async function loadWeatherData() {
      try {
        showLoading();

        const response = await apiRequest('/weather-data/recent?days=7');
        const weatherData = response || [];

        if (weatherData.length > 0) {
          const current = weatherData[0];
          displayCurrentWeather(current);
        }

        displayWeatherHistory(weatherData);

      } catch (error) {
        console.error('Error loading weather data:', error);
        showToast('Error loading weather data', 'error');
      } finally {
        hideLoading();
      }
    }

    /**
     * Display current weather
     */
    function displayCurrentWeather(weather) {
      updateElement('weatherTempLarge', `${weather.temperature || '--'}¬∞C`);
      updateElement('weatherConditionLarge', weather.weatherCondition || 'N/A');
      updateElement('weatherLocationLarge', `
        <i class="fas fa-map-marker-alt"></i>
        ${weather.location || 'Location'}
      `);
      updateElement('weatherHumidityLarge', `${weather.humidity || '--'}%`);
      updateElement('weatherWindLarge', `${weather.windSpeed || '--'} km/h`);
      updateElement('weatherRainfallLarge', `${weather.rainfall || '--'} mm`);
      updateElement('weatherPressureLarge', `${weather.pressure || '--'} hPa`);
    }

    /**
     * Display weather history
     */
    function displayWeatherHistory(weatherData) {
      const ctx = document.getElementById('weatherHistoryChart');
      if (!ctx) return;

      const sortedData = weatherData.sort((a, b) =>
        new Date(a.measurementDate) - new Date(b.measurementDate)
      );

      const labels = sortedData.map(d =>
        formatDate(d.measurementDate)
      );
      const temperatures = sortedData.map(d => d.temperature || 0);
      const rainfall = sortedData.map(d => d.rainfall || 0);

      if (charts.weatherHistory) {
        charts.weatherHistory.destroy();
      }

      charts.weatherHistory = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Temperature (¬∞C)',
              data: temperatures,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              yAxisID: 'y',
              tension: 0.4
            },
            {
              label: 'Rainfall (mm)',
              data: rainfall,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              yAxisID: 'y1',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Temperature (¬∞C)'
              }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Rainfall (mm)'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    }

    // ============================================================================
    // ALERTS MODULE
    // ============================================================================

    /**
     * Load alerts data
     */
    async function loadAlertsData() {
      try {
        showLoading();

        const response = await apiRequest('/food-security-alerts/active');
        const alerts = response || [];

        displayAlertsList(alerts);

      } catch (error) {
        console.error('Error loading alerts:', error);
        showToast('Error loading alerts', 'error');
      } finally {
        hideLoading();
      }
    }



/**
 * Display alerts list - VERSION CORRIG√âE
 */
function displayAlertsList(alerts) {
  const container = document.getElementById('alertsList');
  if (!container) return;

  // ‚úÖ CORRECTION: Extraire le tableau depuis data.content
  let alertsList = [];
  if (Array.isArray(alerts)) {
    alertsList = alerts;
  } else if (alerts && alerts.data && Array.isArray(alerts.data.content)) {
    alertsList = alerts.data.content;
  } else if (alerts && alerts.data && Array.isArray(alerts.data)) {
    alertsList = alerts.data;
  } else if (alerts && alerts.content && Array.isArray(alerts.content)) {
    alertsList = alerts.content;
  } else {
    console.warn('‚ö†Ô∏è Unexpected alerts format:', alerts);
    alertsList = [];
  }

  if (alertsList.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-check-circle"></i>
        <p>No active alerts</p>
      </div>
    `;
    return;
  }

  container.innerHTML = alertsList.map(alert => `
    <div class="alert-item alert-${alert.alertLevel.toLowerCase()}">
      <div class="alert-item-header">
        <h4 class="alert-item-title">${alert.alertTitle}</h4>
        <span class="alert-level alert-level-${alert.alertLevel.toLowerCase()}">${alert.alertLevel}</span>
      </div>
      <p class="alert-item-message">${alert.description}</p>
      <div class="alert-item-footer">
        <span><i class="fas fa-calendar"></i> ${formatDate(alert.alertDate)}</span>
        <span><i class="fas fa-tag"></i> ${alert.category}</span>
      </div>
    </div>
  `).join('');
}






/**
 * Load policies data - VERSION ULTRA-ROBUSTE
 */
async function loadPoliciesData() {
  try {
    showLoading();

    console.log('üîÑ Loading policies data...');

    // ‚úÖ R√©cup√©ration avec gestion d'erreur robuste
    let policies = [];
    try {
      const response = await apiRequest('/policies');

      // Gestion multi-format de la r√©ponse
      if (response) {
        if (Array.isArray(response)) {
          policies = response;
        } else if (response.content && Array.isArray(response.content)) {
          policies = response.content;
        } else if (response.data && Array.isArray(response.data)) {
          policies = response.data;
        } else if (response.data && response.data.content && Array.isArray(response.data.content)) {
          policies = response.data.content;
        } else {
          console.warn('‚ö†Ô∏è Unexpected policies format:', response);
          policies = [];
        }
      }

      console.log(`‚úÖ Loaded ${policies.length} policies`);

    } catch (error) {
      console.warn('‚ö†Ô∏è Error loading policies:', error.message);
      policies = [];
    }

    // Afficher les politiques
    displayPoliciesGrid(policies);

  } catch (error) {
    console.error('‚ùå Error in loadPoliciesData:', error);
    showToast('Unable to load policies', 'warning');

    // Afficher un √©tat vide
    const container = document.getElementById('policiesGrid');
    if (container) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">
            <i class="fas fa-gavel"></i>
          </div>
          <h3>Unable to Load Policies</h3>
          <p>There was an error loading policy data.</p>
          <button class="btn btn-primary mt-4" onclick="loadPoliciesData()">
            <i class="fas fa-redo"></i>
            Try Again
          </button>
        </div>
      `;
    }
  } finally {
    hideLoading();
  }
}

/**
 * Display policies grid - VERSION S√âCURIS√âE
 */
function displayPoliciesGrid(policies) {
  const container = document.getElementById('policiesGrid');
  if (!container) {
    console.warn('‚ö†Ô∏è policiesGrid container not found');
    return;
  }

  if (!policies || policies.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-gavel"></i>
        </div>
        <h3>No Policies Available</h3>
        <p>There are currently no agricultural policies to display.</p>
      </div>
    `;
    return;
  }

  container.innerHTML = policies.map(policy => {
    // ‚úÖ Validation stricte de chaque policy
    if (!policy || !policy.policyName) {
      console.warn('‚ö†Ô∏è Invalid policy data:', policy);
      return '';
    }

    const policyName = policy.policyName || 'Unnamed Policy';
    const policyType = policy.policyType || 'N/A';
    const description = policy.description || 'No description available';
    const eligibility = policy.eligibilityCriteria || null;
    const benefits = policy.benefits || null;
    const deadline = policy.applicationDeadline ? formatDate(policy.applicationDeadline) : null;
    const status = policy.status || 'UNKNOWN';
    const statusLower = status.toLowerCase();
    const policyId = policy.id || '';

    return `
      <div class="policy-card">
        <div class="policy-header">
          <span class="policy-type-badge">${policyType}</span>
          <h3 class="policy-title">${policyName}</h3>
        </div>
        <div class="policy-body">
          <p class="policy-description">${description}</p>
          <div class="policy-details">
            ${eligibility ? `
              <div class="policy-detail-item">
                <label>Eligibility</label>
                <value>${eligibility}</value>
              </div>
            ` : ''}
            ${benefits ? `
              <div class="policy-detail-item">
                <label>Benefits</label>
                <value>${benefits}</value>
              </div>
            ` : ''}
            ${deadline ? `
              <div class="policy-detail-item">
                <label>Deadline</label>
                <value>${deadline}</value>
              </div>
            ` : ''}
            <div class="policy-detail-item">
              <label>Status</label>
              <value><span class="status-badge status-${statusLower}">${status}</span></value>
            </div>
          </div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="viewPolicyDetails('${policyId}')">
          <i class="fas fa-eye"></i>
          View Details
        </button>
      </div>
    `;
  }).filter(html => html !== '').join('');

  // Si aucune policy valide
  if (container.innerHTML.trim() === '') {
    container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-triangle"></i>
        <p>No valid policy data to display</p>
      </div>
    `;
  }
}




/**
 * View policy details - VERSION CORRIG√âE
 */
async function viewPolicyDetails(policyId) {
  if (!policyId) {
    showToast('‚ùå Invalid policy ID', 'error');
    return;
  }

  try {
    showLoading();

    // ‚úÖ CORRECTION: Utiliser le bon endpoint
    const policy = await apiRequest(`/policies/${policyId}`);

    if (!policy) {
      showToast('‚ùå Policy not found', 'error');
      return;
    }

    showPolicyDetailsModal(policy);

  } catch (error) {
    console.error('Error loading policy details:', error);
    showToast('‚ùå Error loading policy details', 'error');
  } finally {
    hideLoading();
  }
}




/**
 * Show policy details modal - VERSION CORRIG√âE
 */
function showPolicyDetailsModal(policy) {
  if (!policy) {
    showToast('‚ùå Invalid policy data', 'error');
    return;
  }

  // ‚úÖ Mapping des champs corrects selon le mod√®le backend
  const policyName = policy.policyName || 'Unnamed Policy';
  const policyCode = policy.policyCode || 'N/A';
  const policyType = policy.policyType || 'N/A';
  const policyCategory = policy.policyCategory || 'N/A';
  const status = policy.status || 'UNKNOWN';
  const statusLower = status.toLowerCase();

  const description = policy.description || 'No description available';
  const objectives = policy.objectives || null;
  const targetBeneficiaries = policy.targetBeneficiaries || null;
  const eligibilityCriteria = policy.eligibilityCriteria || null;
  const benefits = policy.benefits || null;
  const applicationProcedure = policy.applicationProcedure || null;
  const requiredDocuments = policy.requiredDocuments || null;
  const implementingAgency = policy.implementingAgency || null;
  const contactInformation = policy.contactInformation || null;
  const geographicScope = policy.geographicScope || null;

  const effectiveDate = policy.effectiveDate ? formatDate(policy.effectiveDate) : 'N/A';
  const expiryDate = policy.expiryDate ? formatDate(policy.expiryDate) : 'N/A';
  const lastReviewDate = policy.lastReviewDate ? formatDate(policy.lastReviewDate) : null;
  const nextReviewDate = policy.nextReviewDate ? formatDate(policy.nextReviewDate) : null;

  const totalBudgetAllocated = policy.totalBudgetAllocated
    ? formatCurrency(policy.totalBudgetAllocated)
    : null;
  const budgetUtilized = policy.budgetUtilized
    ? formatCurrency(policy.budgetUtilized)
    : null;
  const totalBeneficiaries = policy.totalBeneficiaries || null;
  const utilizationRate = policy.utilizationRate || null;

  const isClimateSmartCompliant = policy.isClimateSmartCompliant || false;
  const isYouthFocused = policy.isYouthFocused || false;

  const modalHTML = `
    <div class="modal-overlay show" id="policyModal" onclick="if(event.target === this) closePolicyModal()">
      <div class="modal-container modal-large">
        <div class="modal-header">
          <h3 class="modal-title">
            <i class="fas fa-gavel"></i>
            ${policyName}
          </h3>
          <button class="modal-close" onclick="closePolicyModal()" type="button">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="policy-full-details">

            <!-- Basic Information -->
            <div class="detail-section">
              <h4><i class="fas fa-info-circle"></i> Policy Information</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <label>Policy Code:</label>
                  <value>${policyCode}</value>
                </div>
                <div class="detail-item">
                  <label>Type:</label>
                  <value>${policyType}</value>
                </div>
                <div class="detail-item">
                  <label>Category:</label>
                  <value>${policyCategory}</value>
                </div>
                <div class="detail-item">
                  <label>Status:</label>
                  <value><span class="status-badge status-${statusLower}">${status}</span></value>
                </div>
                <div class="detail-item">
                  <label>Effective Date:</label>
                  <value>${effectiveDate}</value>
                </div>
                <div class="detail-item">
                  <label>Expiry Date:</label>
                  <value>${expiryDate}</value>
                </div>
                ${geographicScope ? `
                <div class="detail-item">
                  <label>Geographic Scope:</label>
                  <value>${geographicScope}</value>
                </div>
                ` : ''}
                ${implementingAgency ? `
                <div class="detail-item">
                  <label>Implementing Agency:</label>
                  <value>${implementingAgency}</value>
                </div>
                ` : ''}
              </div>
            </div>

            <!-- Description -->
            <div class="detail-section">
              <h4><i class="fas fa-file-alt"></i> Description</h4>
              <p>${description}</p>
            </div>

            <!-- Objectives -->
            ${objectives ? `
            <div class="detail-section">
              <h4><i class="fas fa-bullseye"></i> Objectives</h4>
              <p>${objectives}</p>
            </div>
            ` : ''}

            <!-- Target Beneficiaries -->
            ${targetBeneficiaries ? `
            <div class="detail-section">
              <h4><i class="fas fa-users"></i> Target Beneficiaries</h4>
              <p>${targetBeneficiaries}</p>
            </div>
            ` : ''}

            <!-- Eligibility Criteria -->
            ${eligibilityCriteria ? `
            <div class="detail-section">
              <h4><i class="fas fa-check-circle"></i> Eligibility Criteria</h4>
              <p>${eligibilityCriteria}</p>
            </div>
            ` : ''}

            <!-- Benefits -->
            ${benefits ? `
            <div class="detail-section">
              <h4><i class="fas fa-gift"></i> Benefits</h4>
              <p>${benefits}</p>
            </div>
            ` : ''}

            <!-- Application Procedure -->
            ${applicationProcedure ? `
            <div class="detail-section">
              <h4><i class="fas fa-clipboard-list"></i> Application Procedure</h4>
              <p>${applicationProcedure}</p>
            </div>
            ` : ''}

            <!-- Required Documents -->
            ${requiredDocuments ? `
            <div class="detail-section">
              <h4><i class="fas fa-file-pdf"></i> Required Documents</h4>
              <p>${requiredDocuments}</p>
            </div>
            ` : ''}

            <!-- Budget Information -->
            ${totalBudgetAllocated || budgetUtilized ? `
            <div class="detail-section">
              <h4><i class="fas fa-money-bill-wave"></i> Budget Information</h4>
              <div class="details-grid">
                ${totalBudgetAllocated ? `
                <div class="detail-item">
                  <label>Total Budget Allocated:</label>
                  <value>${totalBudgetAllocated}</value>
                </div>
                ` : ''}
                ${budgetUtilized ? `
                <div class="detail-item">
                  <label>Budget Utilized:</label>
                  <value>${budgetUtilized}</value>
                </div>
                ` : ''}
                ${utilizationRate ? `
                <div class="detail-item">
                  <label>Utilization Rate:</label>
                  <value>${utilizationRate}%</value>
                </div>
                ` : ''}
              </div>
            </div>
            ` : ''}

            <!-- Performance Metrics -->
            ${totalBeneficiaries ? `
            <div class="detail-section">
              <h4><i class="fas fa-chart-line"></i> Performance Metrics</h4>
              <div class="details-grid">
                <div class="detail-item">
                  <label>Total Beneficiaries:</label>
                  <value>${totalBeneficiaries.toLocaleString()}</value>
                </div>
              </div>
            </div>
            ` : ''}

            <!-- Review Dates -->
            ${lastReviewDate || nextReviewDate ? `
            <div class="detail-section">
              <h4><i class="fas fa-calendar-check"></i> Review Schedule</h4>
              <div class="details-grid">
                ${lastReviewDate ? `
                <div class="detail-item">
                  <label>Last Review Date:</label>
                  <value>${lastReviewDate}</value>
                </div>
                ` : ''}
                ${nextReviewDate ? `
                <div class="detail-item">
                  <label>Next Review Date:</label>
                  <value>${nextReviewDate}</value>
                </div>
                ` : ''}
              </div>
            </div>
            ` : ''}

            <!-- Special Attributes -->
            ${isClimateSmartCompliant || isYouthFocused ? `
            <div class="detail-section">
              <h4><i class="fas fa-star"></i> Special Attributes</h4>
              <div class="badges-list">
                ${isClimateSmartCompliant ? `
                  <span class="badge badge-success">
                    <i class="fas fa-leaf"></i>
                    Climate Smart Compliant
                  </span>
                ` : ''}
                ${isYouthFocused ? `
                  <span class="badge badge-info">
                    <i class="fas fa-user-graduate"></i>
                    Youth Focused
                  </span>
                ` : ''}
              </div>
            </div>
            ` : ''}

            <!-- Contact Information -->
            ${contactInformation ? `
            <div class="detail-section">
              <h4><i class="fas fa-phone"></i> Contact Information</h4>
              <p>${contactInformation}</p>
            </div>
            ` : ''}

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closePolicyModal()">
            <i class="fas fa-times"></i>
            Close
          </button>
          ${status === 'ACTIVE' && applicationProcedure ? `
            <button type="button" class="btn btn-primary" onclick="showApplicationInfo('${policy.id}')">
              <i class="fas fa-paper-plane"></i>
              How to Apply
            </button>
          ` : ''}
        </div>
      </div>
    </div>
  `;

  document.getElementById('modalContainer').innerHTML = modalHTML;
}

/**
 * Show application information
 */
function showApplicationInfo(policyId) {
  showToast('‚ÑπÔ∏è Please contact the implementing agency for application details', 'info');
}

    /**
     * Close policy modal
     */
    function closePolicyModal() {
      document.getElementById('modalContainer').innerHTML = '';
    }

    /**
     * Apply for policy
     */
    function applyForPolicy(policyId) {
      showToast('Policy application feature - To be implemented', 'info');
    }

    // ============================================================================
    // AI RECOMMENDATIONS MODULE
    // ============================================================================

    /**
     * Load recommendations data
     */
    async function loadRecommendationsData() {
      try {
        showLoading();

        const response = await apiRequest(`/ai-recommendations/farmer/${currentUser.id}`);
        const recommendations = response || [];

        displayRecommendationsGrid(recommendations);

      } catch (error) {
        console.error('Error loading recommendations:', error);
        showToast('Error loading recommendations', 'error');
      } finally {
        hideLoading();
      }
    }

    /**
     * Display recommendations grid
     */
    function displayRecommendationsGrid(recommendations) {
      const container = document.getElementById('recommendationsGrid');
      if (!container) return;

      if (recommendations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-lightbulb"></i>
            <p>No recommendations available at the moment</p>
            <p class="empty-state-hint">AI recommendations will appear here based on your farm data</p>
          </div>
        `;
        return;
      }

      container.innerHTML = recommendations.map(rec => `
        <div class="recommendation-card">
          <div class="recommendation-header">
            <div class="recommendation-icon">
              <i class="fas ${getRecommendationIcon(rec.recommendationType)}"></i>
            </div>
            <div class="recommendation-title-section">
              <div class="recommendation-type">${rec.recommendationType}</div>
              <h3 class="recommendation-title">${rec.title}</h3>
            </div>
            <span class="recommendation-priority recommendation-priority-${rec.priority.toLowerCase()}">${rec.priority}</span>
          </div>
          <p class="recommendation-description">${rec.description}</p>
          ${rec.actionItems ? `
            <div class="recommendation-details">
              <h4>Recommended Actions:</h4>
              <ul>
                ${rec.actionItems.split(',').map(item => `<li>${item.trim()}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
          <div class="recommendation-footer">
            <div class="recommendation-confidence">
              <strong>${(rec.confidenceScore * 100).toFixed(0)}%</strong> confidence
            </div>
            <button class="btn btn-secondary btn-sm" onclick="markRecommendationAsRead('${rec.id}')">
              <i class="fas fa-check"></i>
              Mark as Read
            </button>
          </div>
        </div>
      `).join('');
    }

    /**
     * Get recommendation icon
     */
    function getRecommendationIcon(type) {
      const icons = {
        'FERTILIZER': 'fa-flask',
        'WATER': 'fa-tint',
        'SEEDS': 'fa-seedling',
        'PESTICIDE': 'fa-spray-can',
        'HARVEST': 'fa-warehouse',
        'PLANTING': 'fa-leaf'
      };
      return icons[type] || 'fa-lightbulb';
    }

    /**
     * Mark recommendation as read
     */
    async function markRecommendationAsRead(recommendationId) {
      try {
        await apiRequest(`/ai-recommendations/${recommendationId}/read`, {
          method: 'PUT'
        });

        showToast('Recommendation marked as read', 'success');
        await loadRecommendationsData();

      } catch (error) {
        console.error('Error marking recommendation as read:', error);
        showToast('Error updating recommendation', 'error');
      }
    }

    // ============================================================================
    // PRODUCTION PREDICTIONS MODULE
    // ============================================================================

    /**
     * Load predictions data
     */
    async function loadPredictionsData() {
      try {
        showLoading();

        const response = await apiRequest(`/production-predictions/farmer/${currentUser.id}`);
        const predictions = response || [];

        displayPredictionsGrid(predictions);

      } catch (error) {
        console.error('Error loading predictions:', error);
        showToast('Error loading predictions', 'error');
      } finally {
        hideLoading();
      }
    }

    /**
     * Display predictions grid
     */
    function displayPredictionsGrid(predictions) {
      const container = document.getElementById('predictionsGrid');
      if (!container) return;

      if (predictions.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-chart-area"></i>
            <p>No predictions available</p>
            <p class="empty-state-hint">AI predictions will be generated based on your historical data</p>
          </div>
        `;
        return;
      }

      container.innerHTML = predictions.map(pred => `
        <div class="prediction-card">
          <div class="prediction-header">
            <div class="prediction-crop">${pred.cropName || 'Crop'}</div>
            <div class="prediction-season">${pred.season} ${pred.year}</div>
          </div>
          <div class="prediction-body">
            <div class="prediction-yield">
              <div class="prediction-yield-label">Predicted Yield</div>
              <div class="prediction-yield-value">
                ${pred.predictedYield ? pred.predictedYield.toFixed(2) : '--'}
                <span class="prediction-yield-unit">T/ha</span>
              </div>
            </div>
            <div class="prediction-metrics">
              <div class="prediction-metric">
                <div class="prediction-metric-label">Min Expected</div>
                <div class="prediction-metric-value">${pred.minYield ? pred.minYield.toFixed(2) : '--'} T/ha</div>
              </div>
              <div class="prediction-metric">
                <div class="prediction-metric-label">Max Expected</div>
                <div class="prediction-metric-value">${pred.maxYield ? pred.maxYield.toFixed(2) : '--'} T/ha</div>
              </div>
              <div class="prediction-metric">
                <div class="prediction-metric-label">Confidence</div>
                <div class="prediction-metric-value">${pred.confidenceLevel ? (pred.confidenceLevel * 100).toFixed(0) : '--'}%</div>
              </div>
              <div class="prediction-metric">
                <div class="prediction-metric-label">Model Accuracy</div>
                <div class="prediction-metric-value">${pred.modelAccuracy ? (pred.modelAccuracy * 100).toFixed(0) : '--'}%</div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // ============================================================================
    // REPORTS MODULE
    // ============================================================================

    /**
     * Initialize reports listeners
     */
    function initReportsListeners() {
      const previewBtn = document.querySelector('[data-action="preview-report"]');
      if (previewBtn) {
        previewBtn.addEventListener('click', previewReport);
      }

      const pdfBtn = document.querySelector('[data-action="generate-pdf-report"]');
      if (pdfBtn) {
        pdfBtn.addEventListener('click', generatePDFReport);
      }

      const excelBtn = document.querySelector('[data-action="generate-excel-report"]');
      if (excelBtn) {
        excelBtn.addEventListener('click', generateExcelReport);
      }

      const closePreviewBtn = document.querySelector('[data-action="close-preview"]');
      if (closePreviewBtn) {
        closePreviewBtn.addEventListener('click', () => {
          document.getElementById('reportPreview').style.display = 'none';
        });
      }
    }

    /**
     * Preview report
     */
    async function previewReport() {
      try {
        showLoading();

        const reportType = document.getElementById('reportType').value;
        const reportPeriod = document.getElementById('reportPeriod').value;
        const dateFrom = document.getElementById('reportDateFrom').value;
        const dateTo = document.getElementById('reportDateTo').value;

        // Generate report data
        const reportData = await generateReportData(reportType, reportPeriod, dateFrom, dateTo);

        // Display preview
        const previewContainer = document.getElementById('reportPreview');
        const previewContent = document.getElementById('reportPreviewContent');

        previewContent.innerHTML = generateReportHTML(reportType, reportData);
        previewContainer.style.display = 'block';

        showToast('Report preview generated', 'success');

      } catch (error) {
        console.error('Error generating report preview:', error);
        showToast('Error generating report preview', 'error');
      } finally {
        hideLoading();
      }
    }



    /**
     * Generate report data
     */
    async function generateReportData(reportType, period, dateFrom, dateTo) {
      const data = {
        reportType: reportType,
        period: period,
        dateFrom: dateFrom,
        dateTo: dateTo,
        generatedAt: new Date().toISOString(),
        farmerName: currentUser ? currentUser.fullName : 'Unknown',
        farmerEmail: currentUser ? currentUser.email : 'Unknown'
      };

      try {
        switch (reportType) {
          case 'farm-overview':
            data.content = await generateFarmOverviewReport(dateFrom, dateTo);
            break;
          case 'production-summary':
            data.content = await generateProductionSummaryReport(dateFrom, dateTo);
            break;
          case 'financial-report':
            data.content = await generateFinancialReport(dateFrom, dateTo);
            break;
          case 'resource-usage':
            data.content = await generateResourceUsageReport(dateFrom, dateTo);
            break;
          case 'inventory-report':
            data.content = await generateInventoryReport(dateFrom, dateTo);
            break;
          default:
            throw new Error('Invalid report type');
        }

        return data;
      } catch (error) {
        console.error('Error generating report data:', error);
        throw error;
      }
    }

    /**
     * Generate farm overview report
     */
    async function generateFarmOverviewReport(dateFrom, dateTo) {
      const farmsResponse = await apiRequest(`/farms/farmer/${currentUser.id}/all`);
      const farms = farmsResponse || [];

      const totalFarms = farms.length;
      const totalArea = farms.reduce((sum, farm) => sum + (parseFloat(farm.sizeHectares) || 0), 0);
      const irrigatedFarms = farms.filter(f => f.irrigationSystem !== 'RAIN_FED').length;
      const activeFarms = farms.filter(f => f.isActive !== false).length;

      // Soil type distribution
      const soilTypeDistribution = {};
      farms.forEach(farm => {
        const soilType = farm.soilType || 'Unknown';
        soilTypeDistribution[soilType] = (soilTypeDistribution[soilType] || 0) + 1;
      });

      // Irrigation system distribution
      const irrigationDistribution = {};
      farms.forEach(farm => {
        const irrigation = farm.irrigationSystem || 'Unknown';
        irrigationDistribution[irrigation] = (irrigationDistribution[irrigation] || 0) + 1;
      });

      return {
        summary: {
          totalFarms,
          totalArea: totalArea.toFixed(2),
          irrigatedFarms,
          activeFarms,
          inactiveFarms: totalFarms - activeFarms
        },
        farms: farms.map(farm => ({
          name: farm.farmName,
          code: farm.farmCode,
          location: farm.location,
          size: farm.sizeHectares,
          soilType: farm.soilType,
          irrigationSystem: formatIrrigationSystem(farm.irrigationSystem),
          status: farm.isActive ? 'Active' : 'Inactive'
        })),
        soilTypeDistribution,
        irrigationDistribution
      };
    }

    /**
     * Generate production summary report
     */
    async function generateProductionSummaryReport(dateFrom, dateTo) {
      const productionsResponse = await apiRequest(`/crop-productions/farm/${currentUser.id}/all`);
      let productions = productionsResponse || [];

      // Filter by date range if provided
      if (dateFrom && dateTo) {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);
        productions = productions.filter(p => {
          const plantingDate = new Date(p.plantingDate);
          return plantingDate >= from && plantingDate <= to;
        });
      }

      const totalProductions = productions.length;
      const activeProductions = productions.filter(p =>
        ['PLANTED', 'GROWING'].includes(p.productionStatus)
      ).length;
      const completedProductions = productions.filter(p =>
        p.productionStatus === 'HARVESTED'
      ).length;

      const totalArea = productions.reduce((sum, p) =>
        sum + (parseFloat(p.areaPlanted) || 0), 0
      );

      const totalYield = productions.reduce((sum, p) =>
        sum + (parseFloat(p.actualYield) || 0), 0
      );

      const totalExpectedYield = productions.reduce((sum, p) =>
        sum + (parseFloat(p.expectedYield) || 0), 0
      );

      // Crop type distribution
      const cropDistribution = {};
      productions.forEach(p => {
        const crop = p.cropName || 'Unknown';
        if (!cropDistribution[crop]) {
          cropDistribution[crop] = {
            count: 0,
            area: 0,
            yield: 0
          };
        }
        cropDistribution[crop].count++;
        cropDistribution[crop].area += parseFloat(p.areaPlanted) || 0;
        cropDistribution[crop].yield += parseFloat(p.actualYield) || 0;
      });

      // Season distribution
      const seasonDistribution = {};
      productions.forEach(p => {
        const season = `${p.season} ${p.year}`;
        seasonDistribution[season] = (seasonDistribution[season] || 0) + 1;
      });

      // Status distribution
      const statusDistribution = {};
      productions.forEach(p => {
        const status = p.productionStatus || 'Unknown';
        statusDistribution[status] = (statusDistribution[status] || 0) + 1;
      });

      return {
        summary: {
          totalProductions,
          activeProductions,
          completedProductions,
          totalArea: totalArea.toFixed(2),
          totalYield: totalYield.toFixed(2),
          totalExpectedYield: totalExpectedYield.toFixed(2),
          averageYield: totalProductions > 0 ? (totalYield / totalProductions).toFixed(2) : 0
        },
        productions: productions.map(p => ({
          code: p.productionCode,
          crop: p.cropName,
          season: `${p.season} ${p.year}`,
          area: p.areaPlanted,
          expectedYield: p.expectedYield,
          actualYield: p.actualYield,
          plantingDate: formatDate(p.plantingDate),
          expectedHarvestDate: formatDate(p.expectedHarvestDate),
          actualHarvestDate: p.actualHarvestDate ? formatDate(p.actualHarvestDate) : 'N/A',
          status: p.productionStatus
        })),
        cropDistribution,
        seasonDistribution,
        statusDistribution
      };
    }

    /**
     * Generate financial report
     */
    async function generateFinancialReport(dateFrom, dateTo) {
      // Fetch all financial data
      const [
        fertilizerResponse,
        irrigationResponse,
        inventoryResponse,
        transactionsResponse
      ] = await Promise.all([
        apiRequest('/fertilizer-usages'),
        apiRequest(`/irrigation/farm/${currentUser.id}`),
        apiRequest(`/inventory/farmer/${currentUser.id}`),
        apiRequest(`/transactions/farmer/${currentUser.id}`)
      ]);

      let fertilizers = fertilizerResponse.content || fertilizerResponse || [];
      let irrigations = irrigationResponse.content || irrigationResponse || [];
      let inventory = inventoryResponse.content || inventoryResponse || [];
      let transactions = transactionsResponse.content || transactionsResponse || [];

      // Filter by date range if provided
      if (dateFrom && dateTo) {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);

        fertilizers = fertilizers.filter(f => {
          const date = new Date(f.applicationDate);
          return date >= from && date <= to;
        });

        irrigations = irrigations.filter(i => {
          const date = new Date(i.irrigationDate);
          return date >= from && date <= to;
        });

        transactions = transactions.filter(t => {
          const date = new Date(t.transactionDate);
          return date >= from && date <= to;
        });
      }

      // Calculate costs
      const fertilizerCost = fertilizers.reduce((sum, f) =>
        sum + (parseFloat(f.totalCost) || 0), 0
      );

      const irrigationCost = irrigations.reduce((sum, i) =>
        sum + (parseFloat(i.totalCost) || 0), 0
      );

      const totalCosts = fertilizerCost + irrigationCost;

      // Calculate revenues
      const totalRevenue = transactions
        .filter(t => t.transactionStatus === 'PAID')
        .reduce((sum, t) => sum + (parseFloat(t.totalAmount) || 0), 0);

      const netRevenue = transactions
        .filter(t => t.transactionStatus === 'PAID')
        .reduce((sum, t) => sum + (parseFloat(t.netAmount) || 0), 0);

      const transactionFees = totalRevenue - netRevenue;

      // Calculate inventory value
      const inventoryValue = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.totalMarketValue) || 0), 0
      );

      // Profit/Loss
      const profitLoss = netRevenue - totalCosts;

      // Monthly breakdown
      const monthlyData = {};

      transactions.forEach(t => {
        if (t.transactionStatus === 'PAID') {
          const date = new Date(t.transactionDate);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

          if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = {
              revenue: 0,
              costs: 0,
              profit: 0
            };
          }
          monthlyData[monthKey].revenue += parseFloat(t.netAmount) || 0;
        }
      });

      fertilizers.forEach(f => {
        const date = new Date(f.applicationDate);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (monthlyData[monthKey]) {
          monthlyData[monthKey].costs += parseFloat(f.totalCost) || 0;
        }
      });

      irrigations.forEach(i => {
        const date = new Date(i.irrigationDate);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (monthlyData[monthKey]) {
          monthlyData[monthKey].costs += parseFloat(i.totalCost) || 0;
        }
      });

      // Calculate profit for each month
      Object.keys(monthlyData).forEach(month => {
        monthlyData[month].profit = monthlyData[month].revenue - monthlyData[month].costs;
      });

      return {
        summary: {
          totalRevenue: formatCurrency(totalRevenue),
          netRevenue: formatCurrency(netRevenue),
          transactionFees: formatCurrency(transactionFees),
          totalCosts: formatCurrency(totalCosts),
          fertilizerCost: formatCurrency(fertilizerCost),
          irrigationCost: formatCurrency(irrigationCost),
          inventoryValue: formatCurrency(inventoryValue),
          profitLoss: formatCurrency(profitLoss),
          profitMargin: totalRevenue > 0 ? ((profitLoss / totalRevenue) * 100).toFixed(2) + '%' : '0%'
        },
        costs: {
          fertilizer: fertilizerCost,
          irrigation: irrigationCost,
          total: totalCosts
        },
        revenue: {
          total: totalRevenue,
          net: netRevenue,
          fees: transactionFees
        },
        transactions: transactions.map(t => ({
          code: t.transactionCode,
          date: formatDate(t.transactionDate),
          buyer: t.buyerName,
          crop: t.cropName,
          quantity: `${t.quantity} ${t.unit || 'KG'}`,
          totalAmount: formatCurrency(t.totalAmount),
          netAmount: formatCurrency(t.netAmount),
          status: t.transactionStatus
        })),
        monthlyData
      };
    }

    /**
     * Generate resource usage report
     */
    async function generateResourceUsageReport(dateFrom, dateTo) {
      const [
        fertilizerResponse,
        irrigationResponse
      ] = await Promise.all([
        apiRequest('/fertilizer-usages'),
        apiRequest(`/irrigation/farm/${currentUser.id}`)
      ]);

      let fertilizers = fertilizerResponse.content || fertilizerResponse || [];
      let irrigations = irrigationResponse.content || irrigationResponse || [];

      // Filter by date range if provided
      if (dateFrom && dateTo) {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);

        fertilizers = fertilizers.filter(f => {
          const date = new Date(f.applicationDate);
          return date >= from && date <= to;
        });

        irrigations = irrigations.filter(i => {
          const date = new Date(i.irrigationDate);
          return date >= from && date <= to;
        });
      }

      // Fertilizer statistics
      const totalFertilizerApplications = fertilizers.length;
      const totalFertilizerQuantity = fertilizers.reduce((sum, f) =>
        sum + (parseFloat(f.quantity) || 0), 0
      );
      const totalFertilizerCost = fertilizers.reduce((sum, f) =>
        sum + (parseFloat(f.totalCost) || 0), 0
      );

      // Fertilizer type distribution
      const fertilizerTypeDistribution = {};
      fertilizers.forEach(f => {
        const type = f.fertilizerType || 'Unknown';
        if (!fertilizerTypeDistribution[type]) {
          fertilizerTypeDistribution[type] = {
            applications: 0,
            quantity: 0,
            cost: 0
          };
        }
        fertilizerTypeDistribution[type].applications++;
        fertilizerTypeDistribution[type].quantity += parseFloat(f.quantity) || 0;
        fertilizerTypeDistribution[type].cost += parseFloat(f.totalCost) || 0;
      });

      // Irrigation statistics
      const totalIrrigationSessions = irrigations.length;
      const totalWaterUsed = irrigations.reduce((sum, i) =>
        sum + (parseFloat(i.waterAmountLiters) || 0), 0
      );
      const totalIrrigationCost = irrigations.reduce((sum, i) =>
        sum + (parseFloat(i.totalCost) || 0), 0
      );
      const avgWaterEfficiency = irrigations.length > 0
        ? irrigations.reduce((sum, i) => sum + (parseFloat(i.waterUseEfficiency) || 0), 0) / irrigations.length
        : 0;

      // Irrigation method distribution
      const irrigationMethodDistribution = {};
      irrigations.forEach(i => {
        const method = i.irrigationMethod || 'Unknown';
        if (!irrigationMethodDistribution[method]) {
          irrigationMethodDistribution[method] = {
            sessions: 0,
            waterUsed: 0,
            cost: 0
          };
        }
        irrigationMethodDistribution[method].sessions++;
        irrigationMethodDistribution[method].waterUsed += parseFloat(i.waterAmountLiters) || 0;
        irrigationMethodDistribution[method].cost += parseFloat(i.totalCost) || 0;
      });

      // Water source distribution
      const waterSourceDistribution = {};
      irrigations.forEach(i => {
        const source = i.waterSource || 'Unknown';
        waterSourceDistribution[source] = (waterSourceDistribution[source] || 0) + 1;
      });

      return {
        summary: {
          fertilizerApplications: totalFertilizerApplications,
          totalFertilizerQuantity: totalFertilizerQuantity.toFixed(2) + ' KG',
          totalFertilizerCost: formatCurrency(totalFertilizerCost),
          irrigationSessions: totalIrrigationSessions,
          totalWaterUsed: totalWaterUsed.toFixed(2) + ' L',
          totalIrrigationCost: formatCurrency(totalIrrigationCost),
          avgWaterEfficiency: (avgWaterEfficiency * 100).toFixed(1) + '%',
          totalResourceCost: formatCurrency(totalFertilizerCost + totalIrrigationCost)
        },
        fertilizer: {
          applications: fertilizers.map(f => ({
            date: formatDate(f.applicationDate),
            type: f.fertilizerType,
            name: f.fertilizerName,
            quantity: `${f.quantity} ${f.unit}`,
            method: f.applicationMethod,
            cost: formatCurrency(f.totalCost),
            effectiveness: f.effectivenessRating ? `${f.effectivenessRating}/5` : 'N/A'
          })),
          typeDistribution: fertilizerTypeDistribution
        },
        irrigation: {
          sessions: irrigations.map(i => ({
            date: formatDate(i.irrigationDate),
            waterAmount: `${i.waterAmountLiters} L`,
            duration: `${i.durationMinutes} min`,
            method: i.irrigationMethod,
            source: i.waterSource,
            efficiency: i.waterUseEfficiency ? (i.waterUseEfficiency * 100).toFixed(1) + '%' : 'N/A',
            cost: formatCurrency(i.totalCost)
          })),
          methodDistribution: irrigationMethodDistribution,
          sourceDistribution: waterSourceDistribution
        }
      };
    }

    /**
     * Generate inventory report
     */
    async function generateInventoryReport(dateFrom, dateTo) {
     const inventoryResponse = await ApiService.get(`/v1/inventories/farmer/${currentUser.id}`)
      let inventory = inventoryResponse.content || inventoryResponse || [];

      // Filter by date range if provided (based on storage date)
      if (dateFrom && dateTo) {
        const from = new Date(dateFrom);
        const to = new Date(dateTo);
        inventory = inventory.filter(item => {
          if (!item.storageDate) return true;
          const date = new Date(item.storageDate);
          return date >= from && date <= to;
        });
      }

      const totalItems = inventory.length;
      const totalQuantity = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.currentQuantity) || 0), 0
      );
      const totalValue = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.totalMarketValue) || 0), 0
      );
      const availableQuantity = inventory.reduce((sum, item) =>
        sum + (parseFloat(item.availableQuantity) || 0), 0
      );

      // Status distribution
      const statusDistribution = {};
      inventory.forEach(item => {
        const status = item.status || 'Unknown';
        statusDistribution[status] = (statusDistribution[status] || 0) + 1;
      });

      // Quality distribution
      const qualityDistribution = {};
      inventory.forEach(item => {
        const quality = item.qualityGrade || 'Unknown';
        qualityDistribution[quality] = (qualityDistribution[quality] || 0) + 1;
      });

      // Crop distribution
      const cropDistribution = {};
      inventory.forEach(item => {
        const crop = item.cropName || 'Unknown';
        if (!cropDistribution[crop]) {
          cropDistribution[crop] = {
            quantity: 0,
            value: 0
          };
        }
        cropDistribution[crop].quantity += parseFloat(item.currentQuantity) || 0;
        cropDistribution[crop].value += parseFloat(item.totalMarketValue) || 0;
      });

      // Expiring items (within 30 days)
      const today = new Date();
      const expiringItems = inventory.filter(item => {
        if (!item.expiryDate) return false;
        const expiry = new Date(item.expiryDate);
        const daysUntil = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
        return daysUntil > 0 && daysUntil <= 30;
      });

      // Expired items
      const expiredItems = inventory.filter(item => {
        if (!item.expiryDate) return false;
        const expiry = new Date(item.expiryDate);
        return expiry < today;
      });

      // Low stock items (available < 20% of current)
      const lowStockItems = inventory.filter(item => {
        const available = parseFloat(item.availableQuantity) || 0;
        const current = parseFloat(item.currentQuantity) || 0;
        return current > 0 && available < current * 0.2;
      });

      return {
        summary: {
          totalItems,
          totalQuantity: totalQuantity.toFixed(2) + ' KG',
          availableQuantity: availableQuantity.toFixed(2) + ' KG',
          totalValue: formatCurrency(totalValue),
          averageValuePerItem: totalItems > 0 ? formatCurrency(totalValue / totalItems) : formatCurrency(0),
          expiringItemsCount: expiringItems.length,
          expiredItemsCount: expiredItems.length,
          lowStockItemsCount: lowStockItems.length
        },
        items: inventory.map(item => ({
          code: item.inventoryCode,
          crop: item.cropName,
          quantity: `${item.currentQuantity} ${item.unit}`,
          available: `${item.availableQuantity} ${item.unit}`,
          quality: item.qualityGrade,
          status: item.status,
          value: formatCurrency(item.totalMarketValue),
          storageDate: item.storageDate ? formatDate(item.storageDate) : 'N/A',
          expiryDate: item.expiryDate ? formatDate(item.expiryDate) : 'N/A'
        })),
        statusDistribution,
        qualityDistribution,
        cropDistribution,
        alerts: {
          expiring: expiringItems.map(item => ({
            code: item.inventoryCode,
            crop: item.cropName,
            quantity: `${item.currentQuantity} ${item.unit}`,
            expiryDate: formatDate(item.expiryDate),
            daysUntilExpiry: Math.ceil((new Date(item.expiryDate) - today) / (1000 * 60 * 60 * 24))
          })),
          expired: expiredItems.map(item => ({
            code: item.inventoryCode,
            crop: item.cropName,
            quantity: `${item.currentQuantity} ${item.unit}`,
            expiryDate: formatDate(item.expiryDate)
          })),
          lowStock: lowStockItems.map(item => ({
            code: item.inventoryCode,
            crop: item.cropName,
            available: `${item.availableQuantity} ${item.unit}`,
            total: `${item.currentQuantity} ${item.unit}`
          }))
        }
      };
    }

/**
 * Generate report HTML - COMPLETELY NEW DESIGN
 */
/**
 * Generate report HTML - PROFESSIONAL PDF DESIGN WITH LOGO
 */
function generateReportHTML(reportType, reportData) {
  const reportTitles = {
    'farm-overview': 'Farm Overview Report',
    'production-summary': 'Production Summary Report',
    'financial-report': 'Financial Report',
    'resource-usage': 'Resource Usage Report',
    'inventory-report': 'Inventory Report'
  };

  let html = `
    <div class="report-document" style="max-width: 210mm; margin: 0 auto; font-family: 'Arial', 'Helvetica', sans-serif; background: white; color: #1f2937;">

      <!-- Professional Header with Logo -->
      <div style="background: #ffffff; padding: 30px 40px; border-bottom: 3px solid #22c55e; margin-bottom: 30px;">
        <table style="width: 100%; border-collapse: collapse;">
          <tr>
            <td style="width: 80px; vertical-align: top;">
              <img src="images/logo.jpeg" alt="AgriGuard AI" style="width: 70px; height: 70px; border-radius: 12px; box-shadow: 0 2px 8px rgba(34, 197, 94, 0.2);">
            </td>
            <td style="padding-left: 20px; vertical-align: top;">
              <h1 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700; color: #1f2937; letter-spacing: -0.5px;">${reportTitles[reportType]}</h1>
              <p style="margin: 0; font-size: 13px; color: #22c55e; font-weight: 600;">AgriGuard AI - Smart Agriculture Platform</p>
              <p style="margin: 4px 0 0 0; font-size: 11px; color: #6b7280;">Empowering Farmers with Data-Driven Insights</p>
            </td>
            <td style="width: 200px; text-align: right; vertical-align: top;">
              <div style="background: #f9fafb; padding: 12px; border-radius: 8px; border-left: 3px solid #22c55e;">
                <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;">REPORT DETAILS</div>
                <div style="font-size: 11px; color: #1f2937; margin-bottom: 3px;">
                  <strong>Generated:</strong><br>${formatDate(reportData.generatedAt)}
                </div>
                <div style="font-size: 11px; color: #1f2937;">
                  <strong>Farmer:</strong><br>${reportData.farmerName}
                </div>
              </div>
            </td>
          </tr>
        </table>
      </div>
  `;

switch (reportType) {
    case 'farm-overview':
      html += generateFarmOverviewHTML(reportData.content);
      break;
    case 'production-summary':
      html += generateProductionSummaryHTML(reportData.content);
      break;
    case 'financial-report':
      html += generateFinancialReportHTML(reportData.content);
      break;
    case 'resource-usage':
      html += generateResourceUsageHTML(reportData.content);
      break;
    case 'inventory-report':
      html += generateInventoryReportHTML(reportData.content);
      break;
  }

  html += `
      <!-- Footer -->
      <div style="margin-top: 30px; padding: 20px 0; border-top: 2px solid #e5e7eb; text-align: center; font-size: 11px; color: #6b7280;">
        <p style="margin: 0;">¬© ${new Date().getFullYear()} AgriGuard AI - All rights reserved | Generated on ${formatDateTime(new Date().toISOString())}</p>
      </div>
    </div>
  `;

  return html;
}











    /**
     * Generate farm overview HTML
     */
    function generateFarmOverviewHTML(content) {
      return `
        <div class="report-section">
          <h2>Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Total Farms:</label>
              <value>${content.summary.totalFarms}</value>
            </div>
            <div class="summary-item">
              <label>Total Area:</label>
              <value>${content.summary.totalArea} ha</value>
            </div>
            <div class="summary-item">
              <label>Irrigated Farms:</label>
              <value>${content.summary.irrigatedFarms}</value>
            </div>
            <div class="summary-item">
              <label>Active Farms:</label>
              <value>${content.summary.activeFarms}</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>Farm Details</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Farm Name</th>
                <th>Code</th>
                <th>Location</th>
                <th>Size (ha)</th>
                <th>Soil Type</th>
                <th>Irrigation</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${content.farms.map(farm => `
                <tr>
                  <td>${farm.name}</td>
                  <td>${farm.code}</td>
                  <td>${farm.location}</td>
                  <td>${farm.size}</td>
                  <td>${farm.soilType}</td>
                  <td>${farm.irrigationSystem}</td>
                  <td>${farm.status}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Soil Type Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.soilTypeDistribution).map(([type, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${type}:</span>
                <span class="distribution-value">${count} farms</span>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="report-section">
          <h2>Irrigation System Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.irrigationDistribution).map(([system, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${system}:</span>
                <span class="distribution-value">${count} farms</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }






    /**
     * Generate production summary HTML
     */
    function generateProductionSummaryHTML(content) {
      return `
        <div class="report-section">
          <h2>Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Total Productions:</label>
              <value>${content.summary.totalProductions}</value>
            </div>
            <div class="summary-item">
              <label>Active Productions:</label>
              <value>${content.summary.activeProductions}</value>
            </div>
            <div class="summary-item">
              <label>Completed:</label>
              <value>${content.summary.completedProductions}</value>
            </div>
            <div class="summary-item">
              <label>Total Area:</label>
              <value>${content.summary.totalArea} ha</value>
            </div>
            <div class="summary-item">
              <label>Total Yield:</label>
              <value>${content.summary.totalYield} T</value>
            </div>
            <div class="summary-item">
              <label>Average Yield:</label>
              <value>${content.summary.averageYield} T/ha</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>Production Details</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Crop</th>
                <th>Season</th>
                <th>Area (ha)</th>
                <th>Expected Yield</th>
                <th>Actual Yield</th>
                <th>Planting Date</th>
                <th>Harvest Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${content.productions.map(prod => `
                <tr>
                  <td>${prod.code}</td>
                  <td>${prod.crop}</td>
                  <td>${prod.season}</td>
                  <td>${prod.area}</td>
                  <td>${prod.expectedYield || 'N/A'}</td>
                  <td>${prod.actualYield || 'N/A'}</td>
                  <td>${prod.plantingDate}</td>
                  <td>${prod.actualHarvestDate}</td>
                  <td>${prod.status}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Crop Distribution</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Crop</th>
                <th>Count</th>
                <th>Total Area (ha)</th>
                <th>Total Yield (T)</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(content.cropDistribution).map(([crop, data]) => `
                <tr>
                  <td>${crop}</td>
                  <td>${data.count}</td>
                  <td>${data.area.toFixed(2)}</td>
                  <td>${data.yield.toFixed(2)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Season Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.seasonDistribution).map(([season, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${season}:</span>
                <span class="distribution-value">${count} productions</span>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="report-section">
          <h2>Status Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.statusDistribution).map(([status, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${status}:</span>
                <span class="distribution-value">${count} productions</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    /**
     * Generate financial report HTML
     */
    function generateFinancialReportHTML(content) {
      return `
        <div class="report-section">
          <h2>Financial Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Total Revenue:</label>
              <value>${content.summary.totalRevenue}</value>
            </div>
            <div class="summary-item">
              <label>Net Revenue:</label>
              <value>${content.summary.netRevenue}</value>
            </div>
            <div class="summary-item">
              <label>Transaction Fees:</label>
              <value>${content.summary.transactionFees}</value>
            </div>
            <div class="summary-item">
              <label>Total Costs:</label>
              <value>${content.summary.totalCosts}</value>
            </div>
            <div class="summary-item">
              <label>Profit/Loss:</label>
              <value class="${parseFloat(content.summary.profitLoss.replace(/[^\d.-]/g, '')) >= 0 ? 'text-success' : 'text-error'}">
                <strong>${content.summary.profitLoss}</strong>
              </value>
            </div>
            <div class="summary-item">
              <label>Profit Margin:</label>
              <value>${content.summary.profitMargin}</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>Cost Breakdown</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Fertilizer Costs:</label>
              <value>${content.summary.fertilizerCost}</value>
            </div>
            <div class="summary-item">
              <label>Irrigation Costs:</label>
              <value>${content.summary.irrigationCost}</value>
            </div>
            <div class="summary-item">
              <label>Inventory Value:</label>
              <value>${content.summary.inventoryValue}</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>Monthly Financial Performance</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Month</th>
                <th>Revenue</th>
                <th>Costs</th>
                <th>Profit/Loss</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(content.monthlyData).sort().map(([month, data]) => {
                const monthDate = new Date(month + '-01');
                const monthLabel = monthDate.toLocaleString('default', { month: 'short', year: 'numeric' });
                return `
                  <tr>
                    <td>${monthLabel}</td>
                    <td>${formatCurrency(data.revenue)}</td>
                    <td>${formatCurrency(data.costs)}</td>
                    <td class="${data.profit >= 0 ? 'text-success' : 'text-error'}">
                      <strong>${formatCurrency(data.profit)}</strong>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Transaction History</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Date</th>
                <th>Buyer</th>
                <th>Crop</th>
                <th>Quantity</th>
                <th>Total Amount</th>
                <th>Net Amount</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${content.transactions.map(tx => `
                <tr>
                  <td>${tx.code}</td>
                  <td>${tx.date}</td>
                  <td>${tx.buyer}</td>
                  <td>${tx.crop}</td>
                  <td>${tx.quantity}</td>
                  <td>${tx.totalAmount}</td>
                  <td>${tx.netAmount}</td>
                  <td>${tx.status}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    /**
     * Generate resource usage HTML
     */
    function generateResourceUsageHTML(content) {
      return `
        <div class="report-section">
          <h2>Resource Usage Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Fertilizer Applications:</label>
              <value>${content.summary.fertilizerApplications}</value>
            </div>
            <div class="summary-item">
              <label>Total Fertilizer:</label>
              <value>${content.summary.totalFertilizerQuantity}</value>
            </div>
            <div class="summary-item">
              <label>Fertilizer Cost:</label>
              <value>${content.summary.totalFertilizerCost}</value>
            </div>
            <div class="summary-item">
              <label>Irrigation Sessions:</label>
              <value>${content.summary.irrigationSessions}</value>
            </div>
            <div class="summary-item">
              <label>Total Water Used:</label>
              <value>${content.summary.totalWaterUsed}</value>
            </div>
            <div class="summary-item">
              <label>Irrigation Cost:</label>
              <value>${content.summary.totalIrrigationCost}</value>
            </div>
            <div class="summary-item">
              <label>Water Efficiency:</label>
              <value>${content.summary.avgWaterEfficiency}</value>
            </div>
            <div class="summary-item">
              <label>Total Resource Cost:</label>
              <value><strong>${content.summary.totalResourceCost}</strong></value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>Fertilizer Usage Details</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Name</th>
                <th>Quantity</th>
                <th>Method</th>
                <th>Cost</th>
                <th>Effectiveness</th>
              </tr>
            </thead>
            <tbody>
              ${content.fertilizer.applications.map(f => `
                <tr>
                  <td>${f.date}</td>
                  <td>${f.type}</td>
                  <td>${f.name}</td>
                  <td>${f.quantity}</td>
                  <td>${f.method}</td>
                  <td>${f.cost}</td>
                  <td>${f.effectiveness}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Fertilizer Type Distribution</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Applications</th>
                <th>Total Quantity (KG)</th>
                <th>Total Cost</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(content.fertilizer.typeDistribution).map(([type, data]) => `
                <tr>
                  <td>${type}</td>
                  <td>${data.applications}</td>
                  <td>${data.quantity.toFixed(2)}</td>
                  <td>${formatCurrency(data.cost)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Irrigation Details</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Water Amount</th>
                <th>Duration</th>
                <th>Method</th>
                <th>Source</th>
                <th>Efficiency</th>
                <th>Cost</th>
              </tr>
            </thead>
            <tbody>
              ${content.irrigation.sessions.map(i => `
                <tr>
                  <td>${i.date}</td>
                  <td>${i.waterAmount}</td>
                  <td>${i.duration}</td>
                  <td>${i.method}</td>
                  <td>${i.source}</td>
                  <td>${i.efficiency}</td>
                  <td>${i.cost}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Irrigation Method Distribution</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Method</th>
                <th>Sessions</th>
                <th>Water Used (L)</th>
                <th>Total Cost</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(content.irrigation.methodDistribution).map(([method, data]) => `
                <tr>
                  <td>${method}</td>
                  <td>${data.sessions}</td>
                  <td>${data.waterUsed.toFixed(2)}</td>
                  <td>${formatCurrency(data.cost)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Water Source Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.irrigation.sourceDistribution).map(([source, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${source}:</span>
                <span class="distribution-value">${count} sessions</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    /**
     * Generate inventory report HTML
     */
    function generateInventoryReportHTML(content) {
      return `
        <div class="report-section">
          <h2>Inventory Summary</h2>
          <div class="summary-grid">
            <div class="summary-item">
              <label>Total Items:</label>
              <value>${content.summary.totalItems}</value>
            </div>
            <div class="summary-item">
              <label>Total Quantity:</label>
              <value>${content.summary.totalQuantity}</value>
            </div>
            <div class="summary-item">
              <label>Available Quantity:</label>
              <value>${content.summary.availableQuantity}</value>
            </div>
            <div class="summary-item">
              <label>Total Value:</label>
              <value>${content.summary.totalValue}</value>
            </div>
            <div class="summary-item">
              <label>Average Value/Item:</label>
              <value>${content.summary.averageValuePerItem}</value>
            </div>
            <div class="summary-item">
              <label>Expiring Items:</label>
              <value class="text-warning">${content.summary.expiringItemsCount}</value>
            </div>
            <div class="summary-item">
              <label>Expired Items:</label>
              <value class="text-error">${content.summary.expiredItemsCount}</value>
            </div>
            <div class="summary-item">
              <label>Low Stock Items:</label>
              <value class="text-warning">${content.summary.lowStockItemsCount}</value>
            </div>
          </div>
        </div>

        <div class="report-section">
          <h2>Inventory Items</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Crop</th>
                <th>Quantity</th>
                <th>Available</th>
                <th>Quality</th>
                <th>Status</th>
                <th>Value</th>
                <th>Storage Date</th>
                <th>Expiry Date</th>
              </tr>
            </thead>
            <tbody>
              ${content.items.map(item => `
                <tr>
                  <td>${item.code}</td>
                  <td>${item.crop}</td>
                  <td>${item.quantity}</td>
                  <td>${item.available}</td>
                  <td>${item.quality}</td>
                  <td>${item.status}</td>
                  <td>${item.value}</td>
                  <td>${item.storageDate}</td>
                  <td>${item.expiryDate}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="report-section">
          <h2>Status Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.statusDistribution).map(([status, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${status}:</span>
                <span class="distribution-value">${count} items</span>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="report-section">
          <h2>Quality Distribution</h2>
          <div class="distribution-list">
            ${Object.entries(content.qualityDistribution).map(([quality, count]) => `
              <div class="distribution-item">
                <span class="distribution-label">${quality}:</span>
                <span class="distribution-value">${count} items</span>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="report-section">
          <h2>Crop Distribution</h2>
          <table class="report-table">
            <thead>
              <tr>
                <th>Crop</th>
                <th>Quantity (KG)</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(content.cropDistribution).map(([crop, data]) => `
                <tr>
                  <td>${crop}</td>
                  <td>${data.quantity.toFixed(2)}</td>
                  <td>${formatCurrency(data.value)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        ${content.alerts.expiring.length > 0 ? `
          <div class="report-section">
            <h2 class="text-warning">‚ö†Ô∏è Expiring Items Alert</h2>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Crop</th>
                  <th>Quantity</th>
                  <th>Expiry Date</th>
                  <th>Days Until Expiry</th>
                </tr>
              </thead>
              <tbody>
                ${content.alerts.expiring.map(item => `
                  <tr class="alert-row">
                    <td>${item.code}</td>
                    <td>${item.crop}</td>
                    <td>${item.quantity}</td>
                    <td>${item.expiryDate}</td>
                    <td class="text-warning"><strong>${item.daysUntilExpiry} days</strong></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}

        ${content.alerts.expired.length > 0 ? `
          <div class="report-section">
            <h2 class="text-error">üö´ Expired Items Alert</h2>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Crop</th>
                  <th>Quantity</th>
                  <th>Expiry Date</th>
                </tr>
              </thead>
              <tbody>
                ${content.alerts.expired.map(item => `
                  <tr class="alert-row expired">
                    <td>${item.code}</td>
                    <td>${item.crop}</td>
                    <td>${item.quantity}</td>
                    <td>${item.expiryDate}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}

        ${content.alerts.lowStock.length > 0 ? `
          <div class="report-section">
            <h2 class="text-warning">üì¶ Low Stock Alert</h2>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Crop</th>
                  <th>Available</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                ${content.alerts.lowStock.map(item => `
                  <tr class="alert-row">
                    <td>${item.code}</td>
                    <td>${item.crop}</td>
                    <td class="text-warning"><strong>${item.available}</strong></td>
                    <td>${item.total}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        ` : ''}
      `;
    }














    /**
     * Generate PDF report
     */
    async function generatePDFReport() {
      try {
        showLoading();

        const reportType = document.getElementById('reportType').value;
        const reportPeriod = document.getElementById('reportPeriod').value;
        const dateFrom = document.getElementById('reportDateFrom').value;
        const dateTo = document.getElementById('reportDateTo').value;

        // Generate report data
        const reportData = await generateReportData(reportType, reportPeriod, dateFrom, dateTo);

        // Create a temporary container for the report
        const tempContainer = document.createElement('div');
        tempContainer.innerHTML = generateReportHTML(reportType, reportData);
        tempContainer.style.padding = '20px';
        tempContainer.style.backgroundColor = 'white';
        tempContainer.style.position = 'absolute';
        tempContainer.style.left = '-9999px';
        document.body.appendChild(tempContainer);

        // Use html2canvas and jsPDF
        const canvas = await html2canvas(tempContainer);
        const imgData = canvas.toDataURL('image/png');

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const pageHeight = 295;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        // Remove temporary container
        document.body.removeChild(tempContainer);

        // Save PDF
        const fileName = `${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(fileName);

        showToast('PDF report generated successfully', 'success');

      } catch (error) {
        console.error('Error generating PDF report:', error);
        showToast('Error generating PDF report', 'error');
      } finally {
        hideLoading();
      }
    }

    /**
     * Generate Excel report
     */
    async function generateExcelReport() {
      try {
        showLoading();

        const reportType = document.getElementById('reportType').value;
        const reportPeriod = document.getElementById('reportPeriod').value;
        const dateFrom = document.getElementById('reportDateFrom').value;
        const dateTo = document.getElementById('reportDateTo').value;

        // Generate report data
        const reportData = await generateReportData(reportType, reportPeriod, dateFrom, dateTo);

        // Create workbook
        const wb = XLSX.utils.book_new();

        // Add summary sheet
        const summaryData = [];
        summaryData.push(['Smart Agriculture Management System']);
        summaryData.push(['Report Type', reportType.replace('-', ' ').toUpperCase()]);
        summaryData.push(['Generated', formatDateTime(reportData.generatedAt)]);
        summaryData.push(['Farmer', reportData.farmerName]);
        summaryData.push(['Email', reportData.farmerEmail]);
        if (reportData.dateFrom && reportData.dateTo) {
          summaryData.push(['Period', `${formatDate(reportData.dateFrom)} to ${formatDate(reportData.dateTo)}`]);
        }
        summaryData.push([]);

        // Add content based on report type
        switch (reportType) {
          case 'farm-overview':
            addFarmOverviewToExcel(wb, reportData.content, summaryData);
            break;
          case 'production-summary':
            addProductionSummaryToExcel(wb, reportData.content, summaryData);
            break;
          case 'financial-report':
            addFinancialReportToExcel(wb, reportData.content, summaryData);
            break;
          case 'resource-usage':
            addResourceUsageToExcel(wb, reportData.content, summaryData);
            break;
          case 'inventory-report':
            addInventoryReportToExcel(wb, reportData.content, summaryData);
            break;
        }

        // Save Excel file
        const fileName = `${reportType}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);

        showToast('Excel report generated successfully', 'success');

      } catch (error) {
        console.error('Error generating Excel report:', error);
        showToast('Error generating Excel report', 'error');
      } finally {
        hideLoading();
      }
    }

    /**
     * Add farm overview to Excel
     */
    function addFarmOverviewToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['SUMMARY']);
      summaryData.push(['Total Farms', content.summary.totalFarms]);
      summaryData.push(['Total Area (ha)', content.summary.totalArea]);
      summaryData.push(['Irrigated Farms', content.summary.irrigatedFarms]);
      summaryData.push(['Active Farms', content.summary.activeFarms]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Farms details
      const farmsData = [['Farm Name', 'Code', 'Location', 'Size (ha)', 'Soil Type', 'Irrigation', 'Status']];
      content.farms.forEach(farm => {
        farmsData.push([
          farm.name,
          farm.code,
          farm.location,
          farm.size,
          farm.soilType,
          farm.irrigationSystem,
          farm.status
        ]);
      });

      const wsF = XLSX.utils.aoa_to_sheet(farmsData);
      XLSX.utils.book_append_sheet(wb, wsF, 'Farms');
    }

    /**
     * Add production summary to Excel
     */
    function addProductionSummaryToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['SUMMARY']);
      summaryData.push(['Total Productions', content.summary.totalProductions]);
      summaryData.push(['Active Productions', content.summary.activeProductions]);
      summaryData.push(['Completed', content.summary.completedProductions]);
      summaryData.push(['Total Area (ha)', content.summary.totalArea]);
      summaryData.push(['Total Yield (T)', content.summary.totalYield]);
      summaryData.push(['Average Yield (T/ha)', content.summary.averageYield]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Productions details
      const prodData = [['Code', 'Crop', 'Season', 'Area (ha)', 'Expected Yield', 'Actual Yield', 'Planting Date', 'Harvest Date', 'Status']];
      content.productions.forEach(prod => {
        prodData.push([
          prod.code,
          prod.crop,
          prod.season,
          prod.area,
          prod.expectedYield || 'N/A',
          prod.actualYield || 'N/A',
          prod.plantingDate,
          prod.actualHarvestDate,
          prod.status
        ]);
      });

      const wsP = XLSX.utils.aoa_to_sheet(prodData);
      XLSX.utils.book_append_sheet(wb, wsP, 'Productions');
    }

    /**
     * Add financial report to Excel
     */
    function addFinancialReportToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['FINANCIAL SUMMARY']);
      summaryData.push(['Total Revenue', content.summary.totalRevenue]);
      summaryData.push(['Net Revenue', content.summary.netRevenue]);
      summaryData.push(['Transaction Fees', content.summary.transactionFees]);
      summaryData.push(['Total Costs', content.summary.totalCosts]);
      summaryData.push(['Profit/Loss', content.summary.profitLoss]);
      summaryData.push(['Profit Margin', content.summary.profitMargin]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Transactions
      const txData = [['Code', 'Date', 'Buyer', 'Crop', 'Quantity', 'Total Amount', 'Net Amount', 'Status']];
      content.transactions.forEach(tx => {
        txData.push([
          tx.code,
          tx.date,
          tx.buyer,
          tx.crop,
          tx.quantity,
          tx.totalAmount,
          tx.netAmount,
          tx.status
        ]);
      });

      const wsTx = XLSX.utils.aoa_to_sheet(txData);
      XLSX.utils.book_append_sheet(wb, wsTx, 'Transactions');
    }




    /**
     * Add resource usage to Excel
     */
    function addResourceUsageToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['RESOURCE USAGE SUMMARY']);
      summaryData.push(['Fertilizer Applications', content.summary.fertilizerApplications]);
      summaryData.push(['Total Fertilizer', content.summary.totalFertilizerQuantity]);
      summaryData.push(['Fertilizer Cost', content.summary.totalFertilizerCost]);
      summaryData.push(['Irrigation Sessions', content.summary.irrigationSessions]);
      summaryData.push(['Total Water Used', content.summary.totalWaterUsed]);
      summaryData.push(['Irrigation Cost', content.summary.totalIrrigationCost]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Fertilizer details
      const fertData = [['Date', 'Type', 'Name', 'Quantity', 'Method', 'Cost', 'Effectiveness']];
      content.fertilizer.applications.forEach(f => {
        fertData.push([
          f.date,
          f.type,
          f.name,
          f.quantity,
          f.method,
          f.cost,
          f.effectiveness
        ]);
      });

      const wsF = XLSX.utils.aoa_to_sheet(fertData);
      XLSX.utils.book_append_sheet(wb, wsF, 'Fertilizer Usage');

      // Irrigation details
      const irrigData = [['Date', 'Water Amount', 'Duration', 'Method', 'Source', 'Efficiency', 'Cost']];
      content.irrigation.sessions.forEach(i => {
        irrigData.push([
          i.date,
          i.waterAmount,
          i.duration,
          i.method,
          i.source,
          i.efficiency,
          i.cost
        ]);
      });

      const wsI = XLSX.utils.aoa_to_sheet(irrigData);
      XLSX.utils.book_append_sheet(wb, wsI, 'Irrigation Sessions');
    }

    /**
     * Add inventory report to Excel
     */
    function addInventoryReportToExcel(wb, content, summaryData) {
      // Summary data
      summaryData.push(['INVENTORY SUMMARY']);
      summaryData.push(['Total Items', content.summary.totalItems]);
      summaryData.push(['Total Quantity', content.summary.totalQuantity]);
      summaryData.push(['Available Quantity', content.summary.availableQuantity]);
      summaryData.push(['Total Value', content.summary.totalValue]);
      summaryData.push(['Expiring Items', content.summary.expiringItemsCount]);
      summaryData.push(['Expired Items', content.summary.expiredItemsCount]);
      summaryData.push(['Low Stock Items', content.summary.lowStockItemsCount]);

      const ws = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, ws, 'Summary');

      // Inventory items
      const invData = [['Code', 'Crop', 'Quantity', 'Available', 'Quality', 'Status', 'Value', 'Storage Date', 'Expiry Date']];
      content.items.forEach(item => {
        invData.push([
          item.code,
          item.crop,
          item.quantity,
          item.available,
          item.quality,
          item.status,
          item.value,
          item.storageDate,
          item.expiryDate
        ]);
      });

      const wsInv = XLSX.utils.aoa_to_sheet(invData);
      XLSX.utils.book_append_sheet(wb, wsInv, 'Inventory Items');

      // Expiring items alert
      if (content.alerts.expiring.length > 0) {
        const expiringData = [['Code', 'Crop', 'Quantity', 'Expiry Date', 'Days Until Expiry']];
        content.alerts.expiring.forEach(item => {
          expiringData.push([
            item.code,
            item.crop,
            item.quantity,
            item.expiryDate,
            item.daysUntilExpiry
          ]);
        });

        const wsExp = XLSX.utils.aoa_to_sheet(expiringData);
        XLSX.utils.book_append_sheet(wb, wsExp, 'Expiring Items');
      }

      // Expired items alert
      if (content.alerts.expired.length > 0) {
        const expiredData = [['Code', 'Crop', 'Quantity', 'Expiry Date']];
        content.alerts.expired.forEach(item => {
          expiredData.push([
            item.code,
            item.crop,
            item.quantity,
            item.expiryDate
          ]);
        });

        const wsExpired = XLSX.utils.aoa_to_sheet(expiredData);
        XLSX.utils.book_append_sheet(wb, wsExpired, 'Expired Items');
      }

      // Low stock alert
      if (content.alerts.lowStock.length > 0) {
        const lowStockData = [['Code', 'Crop', 'Available', 'Total']];
        content.alerts.lowStock.forEach(item => {
          lowStockData.push([
            item.code,
            item.crop,
            item.available,
            item.total
          ]);
        });

        const wsLow = XLSX.utils.aoa_to_sheet(lowStockData);
        XLSX.utils.book_append_sheet(wb, wsLow, 'Low Stock Items');
      }
    }

    /**
     * Helper function to update element text content
     */
    function updateElement(elementId, value) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = value;
      }
    }

    /**
     * Initialize all action buttons
     */
    function initActionButtons() {
      // Add Farm buttons
      document.querySelectorAll('[data-action="add-farm"]').forEach(btn => {
        btn.addEventListener('click', openAddFarmModal);
      });

      // Add Production buttons
      document.querySelectorAll('[data-action="add-production"]').forEach(btn => {
        btn.addEventListener('click', openAddProductionModal);
      });

      // Add Inventory buttons
      document.querySelectorAll('[data-action="add-inventory"]').forEach(btn => {
        btn.addEventListener('click', openAddInventoryModal);
      });

      // Refresh buttons
      document.querySelectorAll('[data-action="refresh-farms"]').forEach(btn => {
        btn.addEventListener('click', () => loadFarmsData());
      });

      document.querySelectorAll('[data-action="refresh-crops"]').forEach(btn => {
        btn.addEventListener('click', () => loadCropsData());
      });

      document.querySelectorAll('[data-action="refresh-productions"]').forEach(btn => {
        btn.addEventListener('click', () => loadProductionData());
      });

      document.querySelectorAll('[data-action="refresh-inventory"]').forEach(btn => {
        btn.addEventListener('click', () => loadInventoryData());
      });

      document.querySelectorAll('[data-action="refresh-fertilizer"]').forEach(btn => {
        btn.addEventListener('click', () => loadFertilizerData());
      });

      document.querySelectorAll('[data-action="refresh-irrigation"]').forEach(btn => {
        btn.addEventListener('click', () => loadIrrigationData());
      });

      document.querySelectorAll('[data-action="refresh-soil"]').forEach(btn => {
        btn.addEventListener('click', () => loadSoilData());
      });

      document.querySelectorAll('[data-action="refresh-market-prices"]').forEach(btn => {
        btn.addEventListener('click', () => loadMarketPricesData());
      });

      document.querySelectorAll('[data-action="refresh-transactions"]').forEach(btn => {
        btn.addEventListener('click', () => loadTransactionsData());
      });

      document.querySelectorAll('[data-action="refresh-supply-chain"]').forEach(btn => {
        btn.addEventListener('click', () => loadSupplyChainData());
      });

      document.querySelectorAll('[data-action="refresh-weather"]').forEach(btn => {
        btn.addEventListener('click', () => loadWeatherData());
      });

      document.querySelectorAll('[data-action="refresh-alerts"]').forEach(btn => {
        btn.addEventListener('click', () => loadAlertsData());
      });

      document.querySelectorAll('[data-action="refresh-policies"]').forEach(btn => {
        btn.addEventListener('click', () => loadPoliciesData());
      });

      document.querySelectorAll('[data-action="refresh-recommendations"]').forEach(btn => {
        btn.addEventListener('click', () => loadRecommendationsData());
      });

      document.querySelectorAll('[data-action="refresh-predictions"]').forEach(btn => {
        btn.addEventListener('click', () => loadPredictionsData());
      });

      // Export buttons
      document.querySelectorAll('[data-action="export-farms"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export farms feature - To be implemented', 'info'));
      });

      document.querySelectorAll('[data-action="export-productions"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export productions feature - To be implemented', 'info'));
      });

      document.querySelectorAll('[data-action="export-inventory"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export inventory feature - To be implemented', 'info'));
      });

      document.querySelectorAll('[data-action="export-fertilizer"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export fertilizer feature - To be implemented', 'info'));
      });

      document.querySelectorAll('[data-action="export-irrigation"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export irrigation feature - To be implemented', 'info'));
      });

      document.querySelectorAll('[data-action="export-transactions"]').forEach(btn => {
        btn.addEventListener('click', () => showToast('Export transactions feature - To be implemented', 'info'));
      });

      // Tasks and Activities refresh
      document.querySelectorAll('[data-action="refresh-tasks"]').forEach(btn => {
        btn.addEventListener('click', () => loadUpcomingTasks());
      });

      document.querySelectorAll('[data-action="refresh-activities"]').forEach(btn => {
        btn.addEventListener('click', () => loadRecentActivities());
      });

      // Clear filter buttons
      document.querySelectorAll('[data-action="clear-filters"]').forEach(btn => {
        btn.addEventListener('click', clearFilters);
      });

      document.querySelectorAll('[data-action="clear-crop-filters"]').forEach(btn => {
        btn.addEventListener('click', clearCropFilters);
      });

      document.querySelectorAll('[data-action="clear-production-filters"]').forEach(btn => {
        btn.addEventListener('click', clearProductionFilters);
      });

      document.querySelectorAll('[data-action="clear-inventory-filters"]').forEach(btn => {
        btn.addEventListener('click', clearInventoryFilters);
      });

      document.querySelectorAll('[data-action="clear-fertilizer-filters"]').forEach(btn => {
        btn.addEventListener('click', clearFertilizerFilters);
      });

      document.querySelectorAll('[data-action="clear-irrigation-filters"]').forEach(btn => {
        btn.addEventListener('click', clearIrrigationFilters);
      });

      document.querySelectorAll('[data-action="clear-market-prices-filters"]').forEach(btn => {
        btn.addEventListener('click', clearMarketPricesFilters);
      });

      document.querySelectorAll('[data-action="clear-transactions-filters"]').forEach(btn => {
        btn.addEventListener('click', clearTransactionsFilters);
      });

      document.querySelectorAll('[data-action="clear-alerts-filters"]').forEach(btn => {
        btn.addEventListener('click', clearAlertsFilters);
      });

      document.querySelectorAll('[data-action="clear-policies-filters"]').forEach(btn => {
        btn.addEventListener('click', clearPoliciesFilters);
      });

      document.querySelectorAll('[data-action="clear-recommendations-filters"]').forEach(btn => {
        btn.addEventListener('click', clearRecommendationsFilters);
      });
    }

    /**
     * Clear filter functions
     */
    function clearFilters() {
      const searchInput = document.getElementById('farmsSearchInput');
      const soilTypeFilter = document.getElementById('farmsSoilTypeFilter');
      const irrigationFilter = document.getElementById('farmsIrrigationFilter');

      if (searchInput) searchInput.value = '';
      if (soilTypeFilter) soilTypeFilter.value = '';
      if (irrigationFilter) irrigationFilter.value = '';

      loadFarmsData();
    }

    function clearCropFilters() {
      const searchInput = document.getElementById('cropsSearchInput');
      const typeFilter = document.getElementById('cropsTypeFilter');
      const seasonFilter = document.getElementById('cropsSeasonFilter');
      const demandFilter = document.getElementById('cropsDemandFilter');

      if (searchInput) searchInput.value = '';
      if (typeFilter) typeFilter.value = '';
      if (seasonFilter) seasonFilter.value = '';
      if (demandFilter) demandFilter.value = '';

      loadCropsData();
    }

    function clearProductionFilters() {
      const searchInput = document.getElementById('productionSearchInput');
      const statusFilter = document.getElementById('productionStatusFilter');
      const seasonFilter = document.getElementById('productionSeasonFilter');
      const yearFilter = document.getElementById('productionYearFilter');

      if (searchInput) searchInput.value = '';
      if (statusFilter) statusFilter.value = '';
      if (seasonFilter) seasonFilter.value = '';
      if (yearFilter) yearFilter.value = '';

      loadProductionData();
    }

    function clearInventoryFilters() {
      const searchInput = document.getElementById('inventorySearchInput');
      const statusFilter = document.getElementById('inventoryStatusFilter');
      const qualityFilter = document.getElementById('inventoryQualityFilter');

      if (searchInput) searchInput.value = '';
      if (statusFilter) statusFilter.value = '';
      if (qualityFilter) qualityFilter.value = '';

      loadInventoryData();
    }

    function clearFertilizerFilters() {
      const searchInput = document.getElementById('fertilizerSearchInput');
      const typeFilter = document.getElementById('fertilizerTypeFilter');
      const dateFrom = document.getElementById('fertilizerDateFrom');
      const dateTo = document.getElementById('fertilizerDateTo');

      if (searchInput) searchInput.value = '';
      if (typeFilter) typeFilter.value = '';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';

      loadFertilizerData();
    }

    function clearIrrigationFilters() {
      const searchInput = document.getElementById('irrigationSearchInput');
      const methodFilter = document.getElementById('irrigationMethodFilter');
      const sourceFilter = document.getElementById('irrigationSourceFilter');
      const dateFrom = document.getElementById('irrigationDateFrom');
      const dateTo = document.getElementById('irrigationDateTo');

      if (searchInput) searchInput.value = '';
      if (methodFilter) methodFilter.value = '';
      if (sourceFilter) sourceFilter.value = '';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';

      loadIrrigationData();
    }

    function clearMarketPricesFilters() {
      const searchInput = document.getElementById('marketPricesSearchInput');
      const typeFilter = document.getElementById('marketPricesTypeFilter');
      const trendFilter = document.getElementById('marketPricesTrendFilter');

      if (searchInput) searchInput.value = '';
      if (typeFilter) typeFilter.value = '';
      if (trendFilter) trendFilter.value = '';

      loadMarketPricesData();
    }

    function clearTransactionsFilters() {
      const searchInput = document.getElementById('transactionsSearchInput');
      const statusFilter = document.getElementById('transactionsStatusFilter');
      const dateFrom = document.getElementById('transactionsDateFrom');
      const dateTo = document.getElementById('transactionsDateTo');

      if (searchInput) searchInput.value = '';
      if (statusFilter) statusFilter.value = '';
      if (dateFrom) dateFrom.value = '';
      if (dateTo) dateTo.value = '';

      loadTransactionsData();
    }

    function clearAlertsFilters() {
      const searchInput = document.getElementById('alertsSearchInput');
      const levelFilter = document.getElementById('alertsLevelFilter');
      const categoryFilter = document.getElementById('alertsCategoryFilter');

      if (searchInput) searchInput.value = '';
      if (levelFilter) levelFilter.value = '';
      if (categoryFilter) categoryFilter.value = '';

      loadAlertsData();
    }

    function clearPoliciesFilters() {
      const searchInput = document.getElementById('policiesSearchInput');
      const typeFilter = document.getElementById('policiesTypeFilter');
      const statusFilter = document.getElementById('policiesStatusFilter');

      if (searchInput) searchInput.value = '';
      if (typeFilter) typeFilter.value = '';
      if (statusFilter) statusFilter.value = '';

      loadPoliciesData();
    }

    function clearRecommendationsFilters() {
      const typeFilter = document.getElementById('recommendationsTypeFilter');
      const priorityFilter = document.getElementById('recommendationsPriorityFilter');

      if (typeFilter) typeFilter.value = '';
      if (priorityFilter) priorityFilter.value = '';

      loadRecommendationsData();
    }







  // ============================================================================
  // PAGE INITIALIZATION
  // ============================================================================

  /**
   * Initialize the dashboard on page load
   */
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      if (DEBUG_MODE) {
        console.log('=== DASHBOARD INITIALIZATION ===');
        console.log('Starting dashboard initialization...');
      }

      // Show loading overlay
      showLoading();

      // CORRECTION: Utiliser UserSessionHandler au lieu de loadUserSession()
      const sessionHandler = UserSessionHandler.getInstance();

      // V√©rifier si l'utilisateur est authentifi√©
      if (!sessionHandler.isAuthenticated()) {
        console.error('No valid user session found');
        window.location.href = '/login.html';
        return;
      }

      // Charger l'utilisateur depuis la session
      const user = sessionHandler.getCurrentUser();
      if (!user) {
        console.error('Could not retrieve user data');
        window.location.href = '/login.html';
        return;
      }

      // Assigner √† currentUser pour le reste du code
      currentUser = user;
      authToken = user.token || sessionHandler.getAuthToken();

      if (DEBUG_MODE) {
        console.log('User session loaded:', {
          id: user.id || user.userId,
          email: user.email,
          role: user.role,
          fullName: user.fullName
        });
      }

      // Update UI with user info
      updateProfileDisplay();
      updateCurrentDate();

      // Initialize navigation
      initNavigation();

      // Initialize action buttons
      initActionButtons();

      // Initialize reports listeners
      initReportsListeners();

      // Load initial dashboard data
      await loadDashboardData();

      if (DEBUG_MODE) {
        console.log('Dashboard initialized successfully');
        console.log('=================================');
      }

      // Show success message
      showToast(`Welcome back, ${user.fullName}!`, 'success');

    } catch (error) {
      console.error('Error initializing dashboard:', error);
      showToast('Error loading dashboard. Please refresh the page.', 'error');
    } finally {
      hideLoading();
    }
  });




    /**
     * Handle page visibility change - refresh data when page becomes visible
     */
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && currentUser) {
        // Refresh current section data when page becomes visible
        const activeSection = document.querySelector('.content-section.active');
        if (activeSection) {
          const sectionId = activeSection.id.replace('Section', '');
          loadSectionData(sectionId);
        }
      }
    });

    /**
     * Handle window resize - adjust charts
     */
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        // Resize all charts
        Object.values(charts).forEach(chart => {
          if (chart) {
            chart.resize();
          }
        });
      }, 250);
    });

    /**
     * Cleanup before page unload
     */
    window.addEventListener('beforeunload', () => {
      // Destroy all charts
      Object.values(charts).forEach(chart => {
        if (chart) {
          chart.destroy();
        }
      });
    });

    // ============================================================================
    // ERROR HANDLERS
    // ============================================================================

    /**
     * Global error handler
     */
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      if (DEBUG_MODE) {
        showToast('An unexpected error occurred', 'error');
      }
    });

    /**
     * Global unhandled rejection handler
     */
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      if (DEBUG_MODE) {
        showToast('An unexpected error occurred', 'error');
      }
    });

    // ============================================================================
    // CONSOLE MESSAGE
    // ============================================================================

    if (DEBUG_MODE) {
      console.log('%cüåæ AgriGuard AI - Farmer Dashboard', 'color: #22c55e; font-size: 20px; font-weight: bold;');
      console.log('%cDashboard Version: 1.0.0', 'color: #666; font-size: 12px;');
      console.log('%cAPI Base URL: ' + API_CONFIG.BASE_URL, 'color: #666; font-size: 12px;');
      console.log('%cDebug Mode: ON', 'color: #f59e0b; font-size: 12px; font-weight: bold;');
    }

</script>
</body>
</html>
