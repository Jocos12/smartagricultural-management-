<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Management - AgriGuard AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>



    <style>



        :root {
    --primary-green: #22c55e;
    --primary-dark: #16a34a;
    --secondary-green: #10b981;
    --accent-green: #34d399;
    --light-green: #dcfce7;
    --dark-green: #166534;
    --success-color: #22c55e;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    --bg-primary: #ffffff;
    --bg-secondary: #f8f9fa;
    --bg-sidebar: #e8f5e8;
    --text-primary: #333333;
    --text-secondary: #666666;
    --border-color: #e0e0e0;
    --hover-bg: rgba(34, 197, 94, 0.1);
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 8px 25px rgba(34, 197, 94, 0.15);
    --gradient-primary: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
    --gradient-bg: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
    --card-bg: #ffffff;
    --modal-bg: rgba(0, 0, 0, 0.5);
}

.dark-mode {
    --bg-primary: #1a1a1a;
    --bg-secondary: #2d2d2d;
    --bg-sidebar: #1f2937;
    --text-primary: #ffffff;
    --text-secondary: #cccccc;
    --border-color: #404040;
    --hover-bg: rgba(34, 197, 94, 0.2);
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    --card-bg: #374151;
    --gradient-bg: linear-gradient(135deg, #1f2937 0%, #374151 50%, #4b5563 100%);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: var(--gradient-bg);
    color: var(--text-primary);
    transition: all 0.3s ease;
    overflow-x: hidden;
}

.dashboard-container {
    display: flex;
    height: 100vh;
}

.sidebar {
    width: 280px;
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: fixed;
    height: 100vh;
    z-index: 1000;
    box-shadow: var(--shadow);
}

.sidebar.collapsed {
    width: 70px;
}

.sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo, .logo-fallback {
    width: 45px;
    height: 45px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--gradient-primary);
    color: white;
    font-size: 24px;
    box-shadow: var(--shadow);
}

.logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.company-info {
    flex: 1;
    transition: opacity 0.3s ease;
}

.company-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.company-tagline {
    font-size: 11px;
    color: var(--primary-green);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.sidebar.collapsed .company-info {
    opacity: 0;
    width: 0;
}

.sidebar-nav {
    flex: 1;
    padding: 20px 0;
    overflow-y: auto;
}

.nav-section {
    margin-bottom: 30px;
}

.nav-section-title {
    padding: 0 20px 10px;
    font-size: 11px;
    font-weight: 700;
    color: var(--primary-green);
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: opacity 0.3s ease;
}

.sidebar.collapsed .nav-section-title {
    opacity: 0;
    height: 0;
    margin: 0;
    padding: 0;
}

.nav-menu {
    list-style: none;
}

.nav-item {
    margin-bottom: 4px;
}

.nav-link {
    display: flex;
    align-items: center;
    padding: 14px 20px;
    color: var(--text-primary);
    text-decoration: none;
    border-radius: 0 25px 25px 0;
    margin-right: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.nav-link i {
    width: 22px;
    margin-right: 14px;
    font-size: 18px;
    flex-shrink: 0;
}

.nav-link span {
    transition: opacity 0.3s ease;
    white-space: nowrap;
    font-weight: 500;
}

.sidebar.collapsed .nav-link span {
    opacity: 0;
}

.nav-link:hover {
    background: var(--hover-bg);
    color: var(--primary-green);
    transform: translateX(5px);
}

.nav-item.active .nav-link {
    background: var(--gradient-primary);
    color: white;
    box-shadow: var(--shadow);
}

.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-left: 280px;
    transition: margin-left 0.3s ease;
}

.main-content.sidebar-collapsed {
    margin-left: 70px;
}

.header {
    background: var(--card-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 0 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 80px;
    box-shadow: var(--shadow);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 24px;
}

.sidebar-toggle {
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 20px;
    cursor: pointer;
    padding: 12px;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.sidebar-toggle:hover {
    background: var(--hover-bg);
    color: var(--primary-green);
}

.greeting-section {
    display: flex;
    flex-direction: column;
}

.greeting-text {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
}

.current-date {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
}

.search-container {
    position: relative;
    width: 400px;
}

.search-input {
    width: 100%;
    padding: 12px 50px 12px 20px;
    border: 2px solid var(--border-color);
    border-radius: 25px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 15px;
    transition: all 0.3s ease;
}

.search-input:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
}

.search-icon {
    position: absolute;
    right: 18px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.header-right {
    display: flex;
    align-items: center;
    gap: 20px;
}

.theme-toggle {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    color: var(--text-primary);
    padding: 12px 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.theme-toggle:hover {
    background: var(--hover-bg);
    border-color: var(--primary-green);
}

.notification-btn {
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 20px;
    cursor: pointer;
    position: relative;
    padding: 12px;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.notification-btn:hover {
    background: var(--hover-bg);
    color: var(--primary-green);
}

.notification-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: var(--error-color);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
}

.profile-section {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    padding: 8px 16px;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.profile-section:hover {
    background: var(--hover-bg);
}

.profile-avatar {
    width: 45px;
    height: 45px;
    background: var(--gradient-primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 16px;
    box-shadow: var(--shadow);
}

.profile-info {
    display: flex;
    flex-direction: column;
}

.profile-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
}

.profile-role {
    font-size: 12px;
    color: var(--primary-green);
    font-weight: 500;
}

.logout-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.logout-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error-color);
}

.content {
    flex: 1;
    padding: 32px;
    background: var(--bg-secondary);
    overflow-y: auto;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.stat-card {
    background: var(--card-bg);
    padding: 24px;
    border-radius: 16px;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    border: 1px solid var(--border-color);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    margin-bottom: 12px;
}

.stat-icon.stages { background: linear-gradient(135deg, #22c55e, #16a34a); }
.stat-icon.completed { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
.stat-icon.inprogress { background: linear-gradient(135deg, #f59e0b, #d97706); }
.stat-icon.efficiency { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.stat-label {
    font-size: 14px;
    color: var(--text-secondary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
}

.chart-card {
    background: var(--card-bg);
    padding: 24px;
    border-radius: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.chart-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-primary);
}

.chart-container {
    position: relative;
    height: 300px;
}

.table-section {
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    overflow: hidden;
    margin-bottom: 32px;
}

.table-header {
    padding: 24px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
}

.table-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-primary);
}

.table-actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: var(--gradient-primary);
    color: white;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
}

.btn-secondary {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--hover-bg);
    border-color: var(--primary-green);
}

.btn-info {
    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    color: white;
}

.btn-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
}

.filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.data-table th {
    background: var(--bg-secondary);
    font-weight: 600;
    color: var(--text-primary);
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.data-table td {
    color: var(--text-primary);
    font-size: 14px;
}

.data-table tr:hover {
    background: var(--hover-bg);
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-completed { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
.status-inprogress { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
.quality-excellent { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
.quality-good { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
.quality-fair { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
.quality-poor { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
.quality-rejected { background: rgba(220, 38, 38, 0.1); color: #dc2626; }

.action-buttons {
    display: flex;
    gap: 8px;
}

.action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.action-btn-view { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
.action-btn-view:hover { background: #22c55e; color: white; }

.action-btn-edit { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
.action-btn-edit:hover { background: #3b82f6; color: white; }

.action-btn-delete { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
.action-btn-delete:hover { background: #ef4444; color: white; }

.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: var(--modal-bg);
    backdrop-filter: blur(5px);
}

.modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 32px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
}

.modal-large {
    max-width: 1000px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-color);
}

.modal-title {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 8px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.modal-close:hover {
    background: var(--hover-bg);
    color: var(--primary-green);
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 14px;
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 14px;
    color: var(--text-primary);
    background: var(--bg-secondary);
    transition: all 0.3s ease;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.loading-overlay.show {
    display: flex;
}

.loader {
    border: 8px solid #f3f3f3;
    border-top: 8px solid var(--primary-green);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 3000;
}

.toast {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 12px;
    box-shadow: var(--shadow-lg);
    border-left: 4px solid;
    animation: slideInRight 0.3s ease;
    max-width: 400px;
}

.toast.success { border-left-color: var(--success-color); }
.toast.error { border-left-color: var(--error-color); }
.toast.warning { border-left-color: var(--warning-color); }
.toast.info { border-left-color: var(--primary-green); }

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.toast-message {
    color: var(--text-primary);
    font-weight: 500;
}

.content-section {
    display: none;
}

.content-section.active {
    display: block;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-state p {
    font-size: 18px;
    margin-top: 12px;
}

::-webkit-scrollbar {
    width: 16px;
    height: 16px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #22c55e 0%, #16a34a 50%, #15803d 100%);
    border-radius: 10px;
    border: 3px solid #f1f1f1;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #16a34a 0%, #15803d 50%, #166534 100%);
}

@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
    }
    .main-content {
        margin-left: 0;
    }
    .search-container {
        width: 200px;
    }
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    .charts-section {
        grid-template-columns: 1fr;
    }
}

    </style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
</div>

<div class="toast-container" id="toastContainer"></div>

<div class="dashboard-container">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="images/logo.jpeg" alt="AgriGuard AI" onerror="this.outerHTML='<div class=\'logo-fallback\'>ðŸŒ¾</div>'">
            </div>
            <div class="company-info">
                <div class="company-name">AgriGuard AI</div>
                <div class="company-tagline">Supply Chain</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">Main</h3>
                <ul class="nav-menu">
                    <li class="nav-item active">
                        <a class="nav-link" onclick="showSection('dashboard')">
                            <i class="fas fa-chart-line"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('supplychain')">
                            <i class="fas fa-truck"></i>
                            <span>Supply Chain</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('analytics')">
                            <i class="fas fa-chart-bar"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('tracking')">
                            <i class="fas fa-map-marked-alt"></i>
                            <span>Tracking</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Reports</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('reports')">
                            <i class="fas fa-file-alt"></i>
                            <span>Generate Reports</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <div class="main-content" id="mainContent">
        <header class="header">
            <div class="header-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="greeting-section">
                    <div class="greeting-text" id="greetingText">Good Morning!</div>
                    <div class="current-date" id="currentDate"></div>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search supply chain..." id="globalSearch" onkeyup="handleGlobalSearch()">
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="header-right">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
                    <i class="fas fa-moon"></i>
                    <span>Dark Mode</span>
                </button>
                <button class="notification-btn">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationCount">0</span>
                </button>
                <div class="profile-section">
                    <div class="profile-avatar">U</div>
                    <div class="profile-info">
                        <div class="profile-name">User</div>
                        <div class="profile-role">Admin</div>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()" title="Logout">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="content">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="content-section active">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon stages">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <div class="stat-value" id="totalStages">0</div>
                        <div class="stat-label">Total Stages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon completed">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-value" id="completedStages">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon inprogress">
                            <i class="fas fa-spinner"></i>
                        </div>
                        <div class="stat-value" id="inProgressStages">0</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon efficiency">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-value" id="avgEfficiency">0%</div>
                        <div class="stat-label">Avg Efficiency</div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Stage Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="stageDistributionChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Quality Status Overview</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="qualityStatusChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Loss Analysis</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="lossAnalysisChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Stage Duration Comparison</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="stageDurationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Supply Chain Section -->
            <div id="supplychainSection" class="content-section">
                <div class="table-section">
                    <div class="table-header">
                        <h2 class="table-title">Supply Chain Management</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="showAddSupplyChainModal()">
                                <i class="fas fa-plus"></i>
                                New Stage
                            </button>
                            <button class="btn btn-secondary" onclick="loadAllSupplyChain()">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                            <button class="btn btn-info" onclick="exportSupplyChainToExcel()">
                                <i class="fas fa-file-excel"></i>
                                Export Excel
                            </button>
                        </div>
                    </div>
                    <div style="padding: 0 24px 24px;">
                        <div class="filter-row">
                            <select class="form-select" id="filterStage" onchange="applyFilters()">
                                <option value="">All Stages</option>
                                <option value="HARVEST">Harvest</option>
                                <option value="COLLECTION">Collection</option>
                                <option value="STORAGE">Storage</option>
                                <option value="PROCESSING">Processing</option>
                                <option value="PACKAGING">Packaging</option>
                                <option value="TRANSPORT">Transport</option>
                                <option value="DISTRIBUTION">Distribution</option>
                                <option value="RETAIL">Retail</option>
                            </select>
                            <select class="form-select" id="filterQuality" onchange="applyFilters()">
                                <option value="">All Quality</option>
                                <option value="EXCELLENT">Excellent</option>
                                <option value="GOOD">Good</option>
                                <option value="FAIR">Fair</option>
                                <option value="POOR">Poor</option>
                                <option value="REJECTED">Rejected</option>
                            </select>
                            <input type="text" class="search-input" placeholder="Search..." id="supplyChainSearch" onkeyup="searchSupplyChain()">
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Crop Production</th>
                                <th>Stage</th>
                                <th>Location</th>
                                <th>Quantity In/Out</th>
                                <th>Quality</th>
                                <th>Status</th>
                                <th>Start Date</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="supplyChainTableBody">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading supply chain data...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analyticsSection" class="content-section">
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Efficiency Rate by Stage</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="efficiencyChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Cost Analysis</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="costAnalysisChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Loss Percentage Trend</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="lossTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Stage Performance Scatter</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="performanceScatterChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tracking Section -->
            <div id="trackingSection" class="content-section">
                <div class="chart-card" style="margin-bottom: 24px;">
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">Track Supply Chain</h3>
                    <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                        <input type="text" class="form-input" id="trackingCodeInput" placeholder="Enter Tracking Code">
                        <button class="btn btn-primary" onclick="trackByCode()">
                            <i class="fas fa-search"></i>
                            Track
                        </button>
                    </div>
                    <div id="trackingResult"></div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="content-section">
                <div class="chart-card" style="margin-bottom: 24px;">
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">Report Configuration</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label class="form-label">Report Type</label>
                            <select class="form-select" id="reportType" onchange="toggleDateRange()">
                                <option value="all">All Supply Chain</option>
                                <option value="weekly">Weekly Report</option>
                                <option value="monthly">Monthly Report</option>
                                <option value="yearly">Yearly Report</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div id="customDateRange" style="display: none;">
                            <label class="form-label">Date Range</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="date" class="form-input" id="startDate">
                                <input type="date" class="form-input" id="endDate">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="generatePDFReport()">
                            <i class="fas fa-file-pdf"></i>
                            Generate PDF Report
                        </button>
                        <button class="btn btn-info" onclick="generateExcelReport()">
                            <i class="fas fa-file-excel"></i>
                            Generate Excel Report
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Supply Chain Modal -->
<div class="modal" id="supplyChainModal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 class="modal-title" id="supplyChainModalTitle">New Supply Chain Stage</h2>
            <button class="modal-close" onclick="closeSupplyChainModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="supplyChainForm" onsubmit="submitSupplyChainForm(event)">
            <input type="hidden" id="supplyChainId" name="supplyChainId">

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Crop Production *</label>
                    <select class="form-select" id="cropProductionId" name="cropProductionId" required>
                        <option value="">Select Crop Production</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Transaction ID</label>
                    <select class="form-select" id="transactionId" name="transactionId">
                        <option value="">Select Transaction (Optional)</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Stage *</label>
                    <select class="form-select" id="stage" name="stage" required>
                        <option value="">Select Stage</option>
                        <option value="HARVEST">Harvest</option>
                        <option value="COLLECTION">Collection</option>
                        <option value="STORAGE">Storage</option>
                        <option value="PROCESSING">Processing</option>
                        <option value="PACKAGING">Packaging</option>
                        <option value="TRANSPORT">Transport</option>
                        <option value="DISTRIBUTION">Distribution</option>
                        <option value="RETAIL">Retail</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Stage Order *</label>
                    <input type="number" class="form-input" id="stageOrder" name="stageOrder" required min="1">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Location *</label>
                    <input type="text" class="form-input" id="location" name="location" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Facility Name</label>
                    <input type="text" class="form-input" id="facilityName" name="facilityName">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Quantity In *</label>
                    <input type="number" step="0.01" class="form-input" id="quantityIn" name="quantityIn" required min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Quantity Out</label>
                    <input type="number" step="0.01" class="form-input" id="quantityOut" name="quantityOut" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Unit</label>
                    <input type="text" class="form-input" id="unit" name="unit" value="KG">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Quality Status</label>
                    <select class="form-select" id="qualityStatus" name="qualityStatus">
                        <option value="EXCELLENT">Excellent</option>
                        <option value="GOOD" selected>Good</option>
                        <option value="FAIR">Fair</option>
                        <option value="POOR">Poor</option>
                        <option value="REJECTED">Rejected</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Responsible Party *</label>
                    <input type="text" class="form-input" id="responsibleParty" name="responsibleParty" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Storage Conditions</label>
                    <input type="text" class="form-input" id="storageConditions" name="storageConditions">
                </div>
                <div class="form-group">
                    <label class="form-label">Transport Method</label>
                    <input type="text" class="form-input" id="transportMethod" name="transportMethod">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Cost Incurred</label>
                    <input type="number" step="0.01" class="form-input" id="costIncurred" name="costIncurred" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Loss Quantity</label>
                    <input type="number" step="0.01" class="form-input" id="lossQuantity" name="lossQuantity" min="0">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Loss Reason</label>
                <input type="text" class="form-input" id="lossReason" name="lossReason">
            </div>

            <div class="form-group">
                <label class="form-label">Handling Notes</label>
                <textarea class="form-textarea" id="handlingNotes" name="handlingNotes" rows="3"></textarea>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closeSupplyChainModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="supplyChainSubmitBtn">
                    <i class="fas fa-save"></i>
                    Save Stage
                </button>
            </div>
        </form>
    </div>
</div>

<script src="js/SessionTracker.js"></script>
<script src="js/user_session_handler.js"></script>
<script >



    // Supply Chain Management System JavaScript
const SUPPLY_CHAIN_API_BASE = 'http://localhost:1010/api/supply-chain';
const CROP_PRODUCTION_API_BASE = 'http://localhost:1010/api/v1/crop-productions';
const TRANSACTION_API_BASE = 'http://localhost:1010/api/transactions';

let allSupplyChain = [];
let allCropProductions = [];
let allTransactions = [];
let charts = {};
let sessionHandler = null;
let currentUser = null;
let currentEditingId = null;

const DEBUG = true;
function log(msg, data) { if (DEBUG) console.log(`[SUPPLY CHAIN] ${msg}`, data || ''); }

// Initialize on page load
document.addEventListener('DOMContentLoaded', async function() {
    log('Initializing Supply Chain System');

    allSupplyChain = [];
    allCropProductions = [];
    allTransactions = [];

    if (!initializeSession()) return;

    updateUIWithUser();
    startSessionMonitoring();
    updateDateTime();
    setInterval(updateDateTime, 60000);
    loadSavedTheme();

    showLoading(true);

    try {
        await loadCropProductions();
        await loadTransactions();
        await loadAllSupplyChain();

        if (allSupplyChain.length > 0) {
            initializeCharts();
        } else {
            log('No supply chain data loaded, skipping chart initialization');
        }

        log('Initialization complete');

    } catch (error) {
        log('Initialization error:', error);
        console.error('Full initialization error:', error);
        showToast('Error loading data: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
});

// Session Management
function initializeSession() {
    log('Initializing session');
    try {
        sessionHandler = UserSessionHandler.getInstance();
        currentUser = sessionHandler.getCurrentUser();

        if (!currentUser) {
            log('No user session');
            window.location.href = '/login.html';
            return false;
        }

        log('Session loaded:', currentUser);
        return true;
    } catch (error) {
        log('Session error:', error);
        window.location.href = '/login.html';
        return false;
    }
}

function updateUIWithUser() {
    if (!currentUser) return;

    const hour = new Date().getHours();
    let greeting = hour < 12 ? 'Good Morning' : hour < 18 ? 'Good Afternoon' : 'Good Evening';

    document.getElementById('greetingText').textContent = `${greeting}, ${currentUser.fullName}!`;
    document.querySelector('.profile-name').textContent = currentUser.fullName;
    document.querySelector('.profile-role').textContent = formatRole(currentUser.role);

    const initials = currentUser.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
    document.querySelector('.profile-avatar').textContent = initials;
}

function formatRole(role) {
    return role ? role.split('_').map(w => w.charAt(0) + w.slice(1).toLowerCase()).join(' ') : 'User';
}

function startSessionMonitoring() {
    setInterval(() => {
        if (sessionHandler && sessionHandler.isAuthenticated()) {
            trackActivity();
        } else {
            handleSessionExpired();
        }
    }, 30000);

    ['click', 'keypress', 'mousemove'].forEach(evt => {
        document.addEventListener(evt, trackActivity, { passive: true });
    });
}

function trackActivity() {
    if (currentUser && window.sessionTracker) {
        window.sessionTracker.updateLastActivity(currentUser.userId || currentUser.id);
    }
}

function handleSessionExpired() {
    showToast('Session expired. Please login again.', 'warning');
    setTimeout(() => {
        if (sessionHandler) sessionHandler.logout();
        else window.location.href = '/login.html';
    }, 2000);
}

function handleLogout() {
    if (confirm('Are you sure you want to logout?')) {
        if (currentUser && window.sessionTracker) {
            window.sessionTracker.endSession(currentUser.userId || currentUser.id);
        }
        if (sessionHandler) sessionHandler.logout();
        else window.location.href = '/login.html';
    }
}

// Data Loading Functions
async function loadCropProductions() {
    log('Loading crop productions');
    try {
        const response = await fetch(`${CROP_PRODUCTION_API_BASE}/all`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();

        if (data.success && data.data) {
            allCropProductions = data.data;
        } else if (Array.isArray(data)) {
            allCropProductions = data;
        } else {
            allCropProductions = [];
        }

        log('Crop productions loaded:', allCropProductions.length);
        populateCropProductionDropdown();

    } catch (error) {
        log('Error loading crop productions:', error);
        allCropProductions = [];
        showToast('Error loading crop productions: ' + error.message, 'error');
    }
}

async function loadTransactions() {
    log('Loading transactions');
    try {
        const response = await fetch(`${TRANSACTION_API_BASE}/all`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();

        if (data.content && Array.isArray(data.content)) {
            allTransactions = data.content;
        } else if (Array.isArray(data)) {
            allTransactions = data;
        } else if (data.success && data.data) {
            if (Array.isArray(data.data)) {
                allTransactions = data.data;
            } else if (data.data.content && Array.isArray(data.data.content)) {
                allTransactions = data.data.content;
            } else {
                allTransactions = [];
            }
        } else {
            allTransactions = [];
        }

        log('Transactions loaded:', allTransactions.length);
        populateTransactionDropdown();

    } catch (error) {
        log('Error loading transactions:', error);
        allTransactions = [];
        showToast('Error loading transactions: ' + error.message, 'error');
    }
}

function populateCropProductionDropdown() {
    const cpSelect = document.getElementById('cropProductionId');
    if (!cpSelect) return;

    cpSelect.innerHTML = '<option value="">Select Crop Production</option>';

    if (!allCropProductions || allCropProductions.length === 0) {
        cpSelect.innerHTML += '<option value="" disabled>No crop productions available</option>';
        return;
    }

    allCropProductions.forEach(cp => {
        const option = document.createElement('option');
        option.value = cp.id;
        option.textContent = `${cp.productionCode} - ${cp.year || ''}`;
        cpSelect.appendChild(option);
    });

    log('Crop production dropdown populated with', allCropProductions.length, 'items');
}

function populateTransactionDropdown() {
    const txSelect = document.getElementById('transactionId');
    if (!txSelect) return;

    txSelect.innerHTML = '<option value="">Select Transaction (Optional)</option>';

    if (!allTransactions || allTransactions.length === 0) {
        txSelect.innerHTML += '<option value="" disabled>No transactions available</option>';
        return;
    }

    allTransactions.forEach(tx => {
        const option = document.createElement('option');
        option.value = tx.id;
        option.textContent = tx.transactionCode || tx.id;
        txSelect.appendChild(option);
    });

    log('Transaction dropdown populated with', allTransactions.length, 'items');
}

async function loadAllSupplyChain() {
    log('Loading supply chain data');
    try {
        const response = await fetch(`${SUPPLY_CHAIN_API_BASE}/all`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.content && Array.isArray(data.content)) {
            allSupplyChain = data.content;
        } else if (Array.isArray(data)) {
            allSupplyChain = data;
        } else if (data.success && data.data) {
            if (Array.isArray(data.data)) {
                allSupplyChain = data.data;
            } else if (data.data.content && Array.isArray(data.data.content)) {
                allSupplyChain = data.data.content;
            } else {
                allSupplyChain = [];
            }
        } else {
            allSupplyChain = [];
        }

        log('Supply chain data loaded:', allSupplyChain.length);

        if (!Array.isArray(allSupplyChain)) {
            console.error('allSupplyChain is not an array!', allSupplyChain);
            allSupplyChain = [];
        }

        updateStatistics();
        renderSupplyChainTable(allSupplyChain);
        updateNotificationCount();

    } catch (error) {
        log('Error loading supply chain:', error);
        console.error('Supply chain loading error details:', error);

        allSupplyChain = [];

        document.getElementById('supplyChainTableBody').innerHTML = `
            <tr><td colspan="9" class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading supply chain: ${error.message}</p>
                <p style="font-size: 12px; color: #666;">Please check if the backend server is running</p>
            </td></tr>
        `;

        updateStatistics();
    }
}

function updateStatistics() {
    if (!Array.isArray(allSupplyChain)) {
        console.error('updateStatistics: allSupplyChain is not an array');
        allSupplyChain = [];
    }

    const total = allSupplyChain.length;
    const completed = allSupplyChain.filter(s => s.stageEndDate !== null).length;
    const inProgress = allSupplyChain.filter(s => s.stageStartDate !== null && s.stageEndDate === null).length;

    let avgEfficiency = 0;
    const efficiencies = allSupplyChain
        .filter(s => s.quantityIn && s.quantityOut && s.quantityIn > 0)
        .map(s => (s.quantityOut / s.quantityIn) * 100);

    if (efficiencies.length > 0) {
        avgEfficiency = efficiencies.reduce((a, b) => a + b, 0) / efficiencies.length;
    }

    const totalStagesEl = document.getElementById('totalStages');
    const completedStagesEl = document.getElementById('completedStages');
    const inProgressStagesEl = document.getElementById('inProgressStages');
    const avgEfficiencyEl = document.getElementById('avgEfficiency');

    if (totalStagesEl) totalStagesEl.textContent = total;
    if (completedStagesEl) completedStagesEl.textContent = completed;
    if (inProgressStagesEl) inProgressStagesEl.textContent = inProgress;
    if (avgEfficiencyEl) avgEfficiencyEl.textContent = avgEfficiency.toFixed(1) + '%';

    log('Statistics updated:', { total, completed, inProgress, avgEfficiency });
}

function updateNotificationCount() {
    if (!Array.isArray(allSupplyChain)) {
        allSupplyChain = [];
    }

    const inProgress = allSupplyChain.filter(s => s.stageStartDate !== null && s.stageEndDate === null).length;
    const notificationEl = document.getElementById('notificationCount');

    if (notificationEl) {
        notificationEl.textContent = inProgress;
    }
}

function renderSupplyChainTable(data) {
    const tbody = document.getElementById('supplyChainTableBody');

    if (!tbody) {
        log('Supply chain table body not found');
        return;
    }

    if (!Array.isArray(data)) {
        console.error('renderSupplyChainTable: data is not an array', data);
        data = [];
    }

    if (data.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="9" class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No supply chain data found</p>
                <p style="font-size: 12px; color: #666;">Create your first stage to get started</p>
            </td></tr>
        `;
        return;
    }

    tbody.innerHTML = data.map(s => {
        if (!s) return '';

        const cropProduction = allCropProductions.find(cp => cp.id === s.cropProductionId);
        const statusClass = s.stageEndDate ? 'status-completed' : 'status-inprogress';
        const statusText = s.stageEndDate ? 'Completed' : 'In Progress';
        const qualityClass = `quality-${(s.qualityStatus || 'good').toLowerCase()}`;

        return `
            <tr>
                <td><strong>${s.id || 'N/A'}</strong></td>
                <td>${cropProduction ? cropProduction.productionCode : s.cropProductionId || 'Unknown'}</td>
                <td>${s.stage || 'N/A'}</td>
                <td>${s.location || 'N/A'}</td>
                <td>${s.quantityIn || 0} â†’ ${s.quantityOut || '-'} ${s.unit || 'KG'}</td>
                <td><span class="status-badge ${qualityClass}">${s.qualityStatus || 'Good'}</span></td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>${formatDate(s.stageStartDate)}</td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn action-btn-view" onclick="viewSupplyChain('${s.id}')" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn action-btn-edit" onclick="editSupplyChain('${s.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn action-btn-delete" onclick="deleteSupplyChain('${s.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    log('Supply chain table rendered with', data.length, 'items');
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

// CRUD Operations
function showAddSupplyChainModal() {
    log('Opening add supply chain modal');
    currentEditingId = null;
    document.getElementById('supplyChainModalTitle').textContent = 'New Supply Chain Stage';
    document.getElementById('supplyChainForm').reset();
    document.getElementById('supplyChainModal').classList.add('show');
}

function closeSupplyChainModal() {
    document.getElementById('supplyChainModal').classList.remove('show');
    document.getElementById('supplyChainForm').reset();
    currentEditingId = null;
}



async function submitSupplyChainForm(event) {
    event.preventDefault();
    log('Submitting supply chain form');

    const formData = {
        cropProductionId: document.getElementById('cropProductionId').value,
        stage: document.getElementById('stage').value,
        stageOrder: parseInt(document.getElementById('stageOrder').value),
        location: document.getElementById('location').value,
        quantityIn: parseFloat(document.getElementById('quantityIn').value),
        unit: document.getElementById('unit').value || 'KG',
        qualityStatus: document.getElementById('qualityStatus').value,
        responsibleParty: document.getElementById('responsibleParty').value
    };

    // Get optional values
    const quantityOut = document.getElementById('quantityOut').value;
    const lossQuantity = document.getElementById('lossQuantity').value;

    // IMPROVED VALIDATION - Check before adding to formData
    const qtyIn = formData.quantityIn;
    let qtyOut = 0;
    let loss = 0;

    if (quantityOut && quantityOut.trim() !== '') {
        qtyOut = parseFloat(quantityOut);
        if (isNaN(qtyOut) || qtyOut < 0) {
            showToast('Error: Quantity Out must be a positive number', 'error');
            return;
        }
        if (qtyOut > qtyIn) {
            showToast('Error: Quantity Out cannot exceed Quantity In', 'error');
            return;
        }
    }

    if (lossQuantity && lossQuantity.trim() !== '') {
        loss = parseFloat(lossQuantity);
        if (isNaN(loss) || loss < 0) {
            showToast('Error: Loss Quantity must be a positive number', 'error');
            return;
        }
        if (loss > qtyIn) {
            showToast('Error: Loss Quantity cannot exceed Quantity In', 'error');
            return;
        }
    }

    // Check combined total
    if (qtyOut > 0 && loss > 0) {
        if (qtyOut + loss > qtyIn) {
            showToast(`Error: Quantity Out (${qtyOut}) + Loss (${loss}) = ${qtyOut + loss} exceeds Quantity In (${qtyIn})`, 'error');
            return;
        }
    }

    // Only add valid quantities to formData
    if (qtyOut > 0) {
        formData.quantityOut = qtyOut;
    }
    if (loss > 0) {
        formData.lossQuantity = loss;
    }

    // Add other optional fields
    const transactionId = document.getElementById('transactionId').value;
    if (transactionId) formData.transactionId = transactionId;

    const facilityName = document.getElementById('facilityName').value;
    if (facilityName) formData.facilityName = facilityName;

    const storageConditions = document.getElementById('storageConditions').value;
    if (storageConditions) formData.storageConditions = storageConditions;

    const transportMethod = document.getElementById('transportMethod').value;
    if (transportMethod) formData.transportMethod = transportMethod;

    const costIncurred = document.getElementById('costIncurred').value;
    if (costIncurred) formData.costIncurred = parseFloat(costIncurred);

    const lossReason = document.getElementById('lossReason').value;
    if (lossReason) formData.lossReason = lossReason;

    const handlingNotes = document.getElementById('handlingNotes').value;
    if (handlingNotes) formData.handlingNotes = handlingNotes;

    try {
        showLoading(true);
        let response;
        let url;
        let method;

        if (currentEditingId) {
            // UPDATE MODE - Include ID
            formData.id = currentEditingId;
            url = `${SUPPLY_CHAIN_API_BASE}/${currentEditingId}`;
            method = 'PUT';
            console.log('UPDATE mode - ID:', currentEditingId);
        } else {
            // CREATE MODE - DO NOT include ID
            // Explicitly delete id if it exists
            delete formData.id;
            url = SUPPLY_CHAIN_API_BASE;
            method = 'POST';
            console.log('CREATE mode - No ID');
        }

        console.log('Payload being sent:', JSON.stringify(formData, null, 2));

        response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        console.log('Response status:', response.status);

        if (response.ok) {
            const result = await response.json();
            console.log('Success response:', result);

            showToast(
                currentEditingId ? 'Supply chain stage updated successfully' : 'Supply chain stage created successfully',
                'success'
            );

            closeSupplyChainModal();
            await loadAllSupplyChain();

            if (allSupplyChain.length > 0) {
                destroyAllCharts();
                setTimeout(() => {
                    initializeCharts();
                }, 200);
            }
        } else {
            let errorMessage = 'Operation failed';
            const contentType = response.headers.get('content-type');

            try {
                if (contentType && contentType.includes('application/json')) {
                    const errorData = await response.json();
                    console.error('Full error data:', errorData);

                    if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (errorData.error) {
                        errorMessage = errorData.error;
                    } else if (errorData.errors && Array.isArray(errorData.errors)) {
                        errorMessage = errorData.errors.join(', ');
                    } else if (typeof errorData === 'string') {
                        errorMessage = errorData;
                    }
                } else {
                    const textError = await response.text();
                    console.error('Text error response:', textError);
                    errorMessage = textError || `HTTP ${response.status}: ${response.statusText}`;
                }
            } catch (e) {
                console.error('Error parsing error response:', e);
                errorMessage = `Operation failed with status ${response.status}`;
            }

            console.error('Final error message:', errorMessage);
            showToast('Error: ' + errorMessage, 'error');
        }

    } catch (error) {
        log('Submit error:', error);
        console.error('Full submit error:', error);
        showToast('Error submitting form: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}





async function editSupplyChain(id) {
    log('Editing supply chain:', id);
    try {
        showLoading(true);
        const response = await fetch(`${SUPPLY_CHAIN_API_BASE}/${id}`);

        if (!response.ok) {
            throw new Error('Failed to load supply chain stage');
        }

        const stage = await response.json();
        console.log('Loaded stage for editing:', stage);

        currentEditingId = id;
        document.getElementById('supplyChainModalTitle').textContent = 'Edit Supply Chain Stage';

        document.getElementById('cropProductionId').value = stage.cropProductionId || '';
        document.getElementById('transactionId').value = stage.transactionId || '';
        document.getElementById('stage').value = stage.stage || '';
        document.getElementById('stageOrder').value = stage.stageOrder || '';
        document.getElementById('location').value = stage.location || '';
        document.getElementById('facilityName').value = stage.facilityName || '';
        document.getElementById('quantityIn').value = stage.quantityIn || '';
        document.getElementById('quantityOut').value = stage.quantityOut || '';
        document.getElementById('unit').value = stage.unit || 'KG';
        document.getElementById('qualityStatus').value = stage.qualityStatus || 'GOOD';
        document.getElementById('responsibleParty').value = stage.responsibleParty || '';
        document.getElementById('storageConditions').value = stage.storageConditions || '';
        document.getElementById('transportMethod').value = stage.transportMethod || '';
        document.getElementById('costIncurred').value = stage.costIncurred || '';
        document.getElementById('lossQuantity').value = stage.lossQuantity || '';
        document.getElementById('lossReason').value = stage.lossReason || '';
        document.getElementById('handlingNotes').value = stage.handlingNotes || '';

        document.getElementById('supplyChainModal').classList.add('show');

    } catch (error) {
        console.error('Edit error:', error);
        showToast('Error loading supply chain stage: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

async function viewSupplyChain(id) {
    await editSupplyChain(id);
    document.querySelectorAll('#supplyChainForm input, #supplyChainForm select, #supplyChainForm textarea').forEach(el => {
        el.disabled = true;
    });
    document.getElementById('supplyChainSubmitBtn').style.display = 'none';
    document.getElementById('supplyChainModalTitle').textContent = 'View Supply Chain Details';
}

async function deleteSupplyChain(id) {
    if (!confirm('Are you sure you want to delete this supply chain stage?')) return;

    try {
        showLoading(true);
        const response = await fetch(`${SUPPLY_CHAIN_API_BASE}/${id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast('Supply chain stage deleted successfully', 'success');
            await loadAllSupplyChain();
            initializeCharts();
        } else {
            showToast('Error deleting supply chain stage', 'error');
        }
    } catch (error) {
        log('Delete error:', error);
        showToast('Error deleting supply chain stage', 'error');
    } finally {
        showLoading(false);
    }
}

// Filter and Search Functions
function applyFilters() {
    const stage = document.getElementById('filterStage').value;
    const quality = document.getElementById('filterQuality').value;

    let filtered = [...allSupplyChain];

    if (stage) {
        filtered = filtered.filter(s => s.stage === stage);
    }

    if (quality) {
        filtered = filtered.filter(s => s.qualityStatus === quality);
    }

    renderSupplyChainTable(filtered);
}

function searchSupplyChain() {
    const searchTerm = document.getElementById('supplyChainSearch').value.toLowerCase();
    const filtered = allSupplyChain.filter(s => {
        const cropProduction = allCropProductions.find(cp => cp.id === s.cropProductionId);

        return (s.id || '').toLowerCase().includes(searchTerm) ||
               (s.location || '').toLowerCase().includes(searchTerm) ||
               (s.responsibleParty || '').toLowerCase().includes(searchTerm) ||
               (s.stage || '').toLowerCase().includes(searchTerm) ||
               (cropProduction ? cropProduction.productionCode.toLowerCase().includes(searchTerm) : false);
    });

    renderSupplyChainTable(filtered);
}

function handleGlobalSearch() {
    searchSupplyChain();
}

// Tracking Function
async function trackByCode() {
    const trackingCode = document.getElementById('trackingCodeInput').value.trim();
    const resultDiv = document.getElementById('trackingResult');

    if (!trackingCode) {
        showToast('Please enter a tracking code', 'warning');
        return;
    }

    try {
        showLoading(true);
        const response = await fetch(`${SUPPLY_CHAIN_API_BASE}/track/${trackingCode}`);

        if (!response.ok) {
            throw new Error('Tracking code not found');
        }

        const stage = await response.json();
        const cropProduction = allCropProductions.find(cp => cp.id === stage.cropProductionId);

        resultDiv.innerHTML = `
            <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                <h4 style="margin-bottom: 16px; color: var(--primary-green);">Tracking Result</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div>
                        <strong>Stage:</strong> ${stage.stage || 'N/A'}
                    </div>
                    <div>
                        <strong>Location:</strong> ${stage.location || 'N/A'}
                    </div>
                    <div>
                        <strong>Crop Production:</strong> ${cropProduction ? cropProduction.productionCode : 'Unknown'}
                    </div>
                    <div>
                        <strong>Quality:</strong> <span class="status-badge quality-${(stage.qualityStatus || 'good').toLowerCase()}">${stage.qualityStatus || 'Good'}</span>
                    </div>
                    <div>
                        <strong>Quantity In:</strong> ${stage.quantityIn || 0} ${stage.unit || 'KG'}
                    </div>
                    <div>
                        <strong>Quantity Out:</strong> ${stage.quantityOut || '-'} ${stage.unit || 'KG'}
                    </div>
                    <div>
                        <strong>Status:</strong> <span class="status-badge ${stage.stageEndDate ? 'status-completed' : 'status-inprogress'}">${stage.stageEndDate ? 'Completed' : 'In Progress'}</span>
                    </div>
                    <div>
                        <strong>Responsible:</strong> ${stage.responsibleParty || 'N/A'}
                    </div>
                </div>
                ${stage.handlingNotes ? `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);"><strong>Notes:</strong><br>${stage.handlingNotes}</div>` : ''}
            </div>
        `;

        showToast('Tracking information retrieved successfully', 'success');

    } catch (error) {
        log('Tracking error:', error);
        resultDiv.innerHTML = `
            <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--error-color); color: var(--error-color);">
                <i class="fas fa-exclamation-circle"></i> ${error.message}
            </div>
        `;
        showToast('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// Chart Functions
function initializeCharts() {
    log('Initializing charts');
    destroyAllCharts();
    setTimeout(() => {
        initializeStageDistributionChart();
        initializeQualityStatusChart();
        initializeLossAnalysisChart();
        initializeStageDurationChart();
        initializeEfficiencyChart();
        initializeCostAnalysisChart();
        initializeLossTrendChart();
        initializePerformanceScatterChart();
    }, 100);
}

function destroyAllCharts() {
    Object.keys(charts).forEach(key => {
        if (charts[key]) {
            try {
                charts[key].destroy();
            } catch (e) {
                console.warn(`Error destroying chart ${key}:`, e);
            }
            charts[key] = null;
        }
    });
}

function initializeStageDistributionChart() {
    const ctx = document.getElementById('stageDistributionChart');
    if (!ctx) return;

    const stageCounts = {};
    allSupplyChain.forEach(s => {
        stageCounts[s.stage] = (stageCounts[s.stage] || 0) + 1;
    });

    if (charts.stageDistribution) charts.stageDistribution.destroy();

    charts.stageDistribution = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(stageCounts),
            datasets: [{
                data: Object.values(stageCounts),
                backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function initializeQualityStatusChart() {
    const ctx = document.getElementById('qualityStatusChart');
    if (!ctx) return;

    const qualityCounts = {
        'EXCELLENT': 0,
        'GOOD': 0,
        'FAIR': 0,
        'POOR': 0,
        'REJECTED': 0
    };

    allSupplyChain.forEach(s => {
        if (qualityCounts.hasOwnProperty(s.qualityStatus)) {
            qualityCounts[s.qualityStatus]++;
        }
    });

    if (charts.qualityStatus) charts.qualityStatus.destroy();

    charts.qualityStatus = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(qualityCounts),
            datasets: [{
                label: 'Quality Count',
                data: Object.values(qualityCounts),
                backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#dc2626']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, ticks: { precision: 0 } }
            }
        }
    });
}

function initializeLossAnalysisChart() {
    const ctx = document.getElementById('lossAnalysisChart');
    if (!ctx) return;

    const stageLoss = {};
    allSupplyChain.forEach(s => {
        if (s.lossQuantity && s.lossQuantity > 0) {
            stageLoss[s.stage] = (stageLoss[s.stage] || 0) + parseFloat(s.lossQuantity);
        }
    });

    if (charts.lossAnalysis) charts.lossAnalysis.destroy();

    charts.lossAnalysis = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(stageLoss),
            datasets: [{
                label: 'Loss Quantity (KG)',
                data: Object.values(stageLoss),
                backgroundColor: '#ef4444'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function initializeStageDurationChart() {
    const ctx = document.getElementById('stageDurationChart');
    if (!ctx) return;

    const stageDurations = {};
    allSupplyChain.forEach(s => {
        if (s.stageStartDate && s.stageEndDate) {
            const start = new Date(s.stageStartDate);
            const end = new Date(s.stageEndDate);
            const duration = (end - start) / (1000 * 60 * 60 * 24);
            stageDurations[s.stage] = (stageDurations[s.stage] || []);
            stageDurations[s.stage].push(duration);
        }
    });

    const avgDurations = {};
    Object.keys(stageDurations).forEach(stage => {
        const durations = stageDurations[stage];
        avgDurations[stage] = durations.reduce((a, b) => a + b, 0) / durations.length;
    });

    if (charts.stageDuration) charts.stageDuration.destroy();

    charts.stageDuration = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(avgDurations),
            datasets: [{
                label: 'Average Duration (Days)',
                data: Object.values(avgDurations),
                backgroundColor: '#8b5cf6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true }
            }
        }
    });
}

function initializeEfficiencyChart() {
    const ctx = document.getElementById('efficiencyChart');
    if (!ctx) return;

    const stageEfficiency = {};
    allSupplyChain.forEach(s => {
        if (s.quantityIn && s.quantityOut && s.quantityIn > 0) {
            const efficiency = (s.quantityOut / s.quantityIn) * 100;
            stageEfficiency[s.stage] = (stageEfficiency[s.stage] || []);
            stageEfficiency[s.stage].push(efficiency);
        }
    });

    const avgEfficiency = {};
    Object.keys(stageEfficiency).forEach(stage => {
        const efficiencies = stageEfficiency[stage];
        avgEfficiency[stage] = efficiencies.reduce((a, b) => a + b, 0) / efficiencies.length;
    });

    if (charts.efficiency) charts.efficiency.destroy();

    charts.efficiency = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Object.keys(avgEfficiency),
            datasets: [{
                label: 'Efficiency Rate (%)',
                data: Object.values(avgEfficiency),
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, max: 100 }
            }
        }
    });
}

function initializeCostAnalysisChart() {
    const ctx = document.getElementById('costAnalysisChart');
    if (!ctx) return;

    const stageCosts = {};
    allSupplyChain.forEach(s => {
        if (s.costIncurred && s.costIncurred > 0) {
            stageCosts[s.stage] = (stageCosts[s.stage] || 0) + parseFloat(s.costIncurred);
        }
    });

    if (charts.costAnalysis) charts.costAnalysis.destroy();

    charts.costAnalysis = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(stageCosts),
            datasets: [{
                data: Object.values(stageCosts),
                backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function initializeLossTrendChart() {
    const ctx = document.getElementById('lossTrendChart');
    if (!ctx) return;

    const lossData = allSupplyChain
        .filter(s => s.lossPercentage && s.lossPercentage > 0)
        .sort((a, b) => new Date(a.stageStartDate) - new Date(b.stageStartDate))
        .slice(-20);

    const labels = lossData.map((s, i) => `Stage ${i + 1}`);
    const losses = lossData.map(s => parseFloat(s.lossPercentage));

    if (charts.lossTrend) charts.lossTrend.destroy();

    charts.lossTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Loss Percentage (%)',
                data: losses,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function initializePerformanceScatterChart() {
    const ctx = document.getElementById('performanceScatterChart');
    if (!ctx) return;

    const scatterData = allSupplyChain
        .filter(s => s.quantityIn && s.quantityOut && s.costIncurred)
        .map(s => ({
            x: parseFloat(s.quantityIn),
            y: parseFloat(s.costIncurred),
            stage: s.stage
        }));

    if (charts.performanceScatter) charts.performanceScatter.destroy();

    charts.performanceScatter = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Quantity vs Cost',
                data: scatterData,
                backgroundColor: '#3b82f6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Quantity In (KG)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Cost Incurred (RWF)'
                    }
                }
            }
        }
    });
}

// Report Functions
function toggleDateRange() {
    const reportType = document.getElementById('reportType').value;
    const customRange = document.getElementById('customDateRange');
    customRange.style.display = reportType === 'custom' ? 'block' : 'none';
}

function filterByReportType(reportType) {
    const now = new Date();
    let filtered = [...allSupplyChain];

    if (reportType === 'weekly') {
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        filtered = allSupplyChain.filter(s => new Date(s.stageStartDate) >= weekAgo);
    } else if (reportType === 'monthly') {
        const monthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
        filtered = allSupplyChain.filter(s => new Date(s.stageStartDate) >= monthAgo);
    } else if (reportType === 'yearly') {
        const yearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
        filtered = allSupplyChain.filter(s => new Date(s.stageStartDate) >= yearAgo);
    } else if (reportType === 'custom') {
        const startDate = new Date(document.getElementById('startDate').value);
        const endDate = new Date(document.getElementById('endDate').value);
        filtered = allSupplyChain.filter(s => {
            const date = new Date(s.stageStartDate);
            return date >= startDate && date <= endDate;
        });
    }

    return filtered;
}

function getReportTitle(reportType) {
    const titles = {
        'all': 'All Supply Chain Stages Report',
        'weekly': 'Weekly Supply Chain Report',
        'monthly': 'Monthly Supply Chain Report',
        'yearly': 'Yearly Supply Chain Report',
        'custom': 'Custom Range Supply Chain Report'
    };
    return titles[reportType] || 'Supply Chain Report';
}

async function generatePDFReport() {
    log('Generating PDF report');
    const reportType = document.getElementById('reportType').value;

    if (allSupplyChain.length === 0) {
        showToast('No data to generate report', 'warning');
        return;
    }

    showLoading(true);

    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();

        let filtered = filterByReportType(reportType);
        let title = getReportTitle(reportType);

        pdf.setFontSize(20);
        pdf.text(title, 105, 20, { align: 'center' });

        pdf.setFontSize(12);
        pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
        pdf.text(`Total Stages: ${filtered.length}`, 105, 38, { align: 'center' });

        const completed = filtered.filter(s => s.stageEndDate).length;
        pdf.text(`Completed: ${completed}`, 105, 46, { align: 'center' });

        let yPos = 60;
        pdf.setFontSize(10);

        filtered.slice(0, 30).forEach((s, idx) => {
            if (yPos > 270) {
                pdf.addPage();
                yPos = 20;
            }

            const cropProduction = allCropProductions.find(cp => cp.id === s.cropProductionId);

            pdf.text(`${idx + 1}. ${s.stage} - ${s.location}`, 20, yPos);
            pdf.text(`Crop Production: ${cropProduction ? cropProduction.productionCode : 'Unknown'}`, 30, yPos + 6);
            pdf.text(`Quantity: ${s.quantityIn} â†’ ${s.quantityOut || '-'} ${s.unit}`, 30, yPos + 12);
            pdf.text(`Quality: ${s.qualityStatus} | Status: ${s.stageEndDate ? 'Completed' : 'In Progress'}`, 30, yPos + 18);
            pdf.text(`Responsible: ${s.responsibleParty}`, 30, yPos + 24);

            yPos += 32;
        });

        pdf.save(`supply_chain_report_${reportType}_${Date.now()}.pdf`);
        showToast('PDF report generated successfully', 'success');
    } catch (error) {
        log('PDF error:', error);
        showToast('Error generating PDF report', 'error');
    } finally {
        showLoading(false);
    }
}

async function generateExcelReport() {
    log('Generating Excel report');
    const reportType = document.getElementById('reportType').value;

    if (allSupplyChain.length === 0) {
        showToast('No data to export', 'warning');
        return;
    }

    const filtered = filterByReportType(reportType);

    const exportData = filtered.map(s => {
        const cropProduction = allCropProductions.find(cp => cp.id === s.cropProductionId);

        return {
            'ID': s.id || 'N/A',
            'Crop Production': cropProduction ? cropProduction.productionCode : 'Unknown',
            'Stage': s.stage || 'N/A',
            'Stage Order': s.stageOrder || 'N/A',
            'Location': s.location || 'N/A',
            'Facility': s.facilityName || 'N/A',
            'Quantity In': s.quantityIn || 0,
            'Quantity Out': s.quantityOut || 0,
            'Unit': s.unit || 'KG',
            'Loss Quantity': s.lossQuantity || 0,
            'Loss %': s.lossPercentage || 0,
            'Quality Status': s.qualityStatus || 'N/A',
            'Responsible Party': s.responsibleParty || 'N/A',
            'Cost Incurred': s.costIncurred || 0,
            'Status': s.stageEndDate ? 'Completed' : 'In Progress',
            'Start Date': formatDate(s.stageStartDate),
            'End Date': s.stageEndDate ? formatDate(s.stageEndDate) : 'N/A'
        };
    });

    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Supply Chain');
    XLSX.writeFile(wb, `supply_chain_${reportType}_${Date.now()}.xlsx`);

    showToast('Excel file exported successfully', 'success');
}

function exportSupplyChainToExcel() {
    generateExcelReport();
}

// UI Functions
function showSection(sectionName) {
    log('Showing section:', sectionName);

    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });

    const section = document.getElementById(sectionName + 'Section');
    if (section) {
        section.classList.add('active');
    }

    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.nav-item').classList.add('active');

    if (sectionName === 'supplychain') {
        loadAllSupplyChain();
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');

    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('sidebar-collapsed');
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');

    document.getElementById('themeToggle').innerHTML = isDark
        ? '<i class="fas fa-sun"></i><span>Light Mode</span>'
        : '<i class="fas fa-moon"></i><span>Dark Mode</span>';

    localStorage.setItem('theme', isDark ? 'dark' : 'light');
}

function loadSavedTheme() {
    if (localStorage.getItem('theme') === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i><span>Light Mode</span>';
    }
}

function updateDateTime() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    const dateEl = document.getElementById('currentDate');
    if (dateEl) dateEl.textContent = dateStr;

    if (currentUser) {
        const hour = now.getHours();
        let greeting = hour < 12 ? 'Good Morning' : hour < 18 ? 'Good Afternoon' : 'Good Evening';
        const greetingEl = document.getElementById('greetingText');
        if (greetingEl) greetingEl.textContent = `${greeting}, ${currentUser.fullName}!`;
    }
}

function showLoading(show) {
    document.getElementById('loadingOverlay').classList.toggle('show', show);
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<p class="toast-message">${message}</p>`;

    document.getElementById('toastContainer').appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 5000);
}

log('Supply Chain System JavaScript loaded successfully');


</script>
</body>
</html>
