<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Policy Data Management - AgriGuard AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-green: #22c55e;
            --primary-dark: #16a34a;
            --secondary-green: #10b981;
            --accent-green: #34d399;
            --light-green: #dcfce7;
            --dark-green: #166534;
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-sidebar: #e8f5e8;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --hover-bg: rgba(34, 197, 94, 0.1);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 25px rgba(34, 197, 94, 0.15);
            --gradient-primary: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            --gradient-bg: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
            --card-bg: #ffffff;
            --modal-bg: rgba(0, 0, 0, 0.5);
        }

        .dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-sidebar: #1f2937;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #404040;
            --hover-bg: rgba(34, 197, 94, 0.2);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --card-bg: #374151;
            --gradient-bg: linear-gradient(135deg, #1f2937 0%, #374151 50%, #4b5563 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gradient-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        .dashboard-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            height: 100vh;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            color: white;
            font-size: 24px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .company-info {
            flex: 1;
            transition: opacity 0.3s ease;
        }

        .company-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .company-tagline {
            font-size: 11px;
            color: var(--primary-green);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar.collapsed .company-info {
            opacity: 0;
            width: 0;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 30px;
        }

        .nav-section-title {
            padding: 0 20px 10px;
            font-size: 11px;
            font-weight: 700;
            color: var(--primary-green);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-section-title {
            opacity: 0;
            height: 0;
            margin: 0;
            padding: 0;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 0 25px 25px 0;
            margin-right: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-link i {
            width: 22px;
            margin-right: 14px;
            font-size: 18px;
            flex-shrink: 0;
        }

        .nav-link span {
            transition: opacity 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
        }

        .sidebar.collapsed .nav-link span {
            opacity: 0;
        }

        .nav-link:hover {
            background: var(--hover-bg);
            color: var(--primary-green);
            transform: translateX(5px);
        }

        .nav-item.active .nav-link {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: 280px;
            transition: margin-left 0.3s ease;
        }

        .main-content.sidebar-collapsed {
            margin-left: 70px;
        }

        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 80px;
            box-shadow: var(--shadow);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            padding: 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: var(--hover-bg);
            color: var(--primary-green);
        }

        .greeting-section {
            display: flex;
            flex-direction: column;
        }

        .greeting-text {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .current-date {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .search-container {
            position: relative;
            width: 380px;
        }

        .search-input {
            width: 100%;
            padding: 12px 50px 12px 20px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .theme-toggle {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover {
            background: var(--hover-bg);
            border-color: var(--primary-green);
        }

        .content {
            flex: 1;
            padding: 32px;
            background: var(--bg-secondary);
            overflow-y: auto;
            overflow-x: hidden;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 12px;
        }

        .stat-icon.total { background: linear-gradient(135deg, #22c55e, #16a34a); }
        .stat-icon.active { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .stat-icon.budget { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .stat-icon.beneficiaries { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .stat-icon.subsidy { background: linear-gradient(135deg, #ec4899, #db2777); }
        .stat-icon.credit { background: linear-gradient(135deg, #14b8a6, #0d9488); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .table-section {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 32px;
            max-width: 100%;
            overflow: hidden;
        }

        .table-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .table-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
            border-color: var(--primary-green);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .data-table-wrapper {
            width: 100%;
            overflow-x: auto !important;
            overflow-y: visible;
            padding: 0 24px 24px 24px;
            position: relative;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            max-width: calc(100vw - 380px);
        }

        .data-table {
            min-width: 1400px !important;
            width: max-content !important;
            table-layout: fixed !important;
            border-collapse: collapse;
            margin-bottom: 0;
        }

        .data-table th,
        .data-table td {
            white-space: nowrap !important;
            padding: 14px 16px !important;
            border-bottom: 1px solid var(--border-color);
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg-secondary);
        }

        .data-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-draft { background: rgba(156, 163, 175, 0.1); color: #6b7280; }
        .status-active { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
        .status-suspended { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .status-expired { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .status-under_review { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn-view { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
        .action-btn-edit { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .action-btn-delete { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-green);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 3000;
        }

        .toast {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid;
            animation: slideInRight 0.3s ease;
            max-width: 420px;
        }

        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--error-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.info { border-left-color: var(--primary-green); }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast-message {
            color: var(--text-primary);
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 1100px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-secondary);
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .report-card {
            background: #ffffff;
            border: 1px solid #c7e8d1;
            border-radius: 12px;
            padding: 16px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #25c15f;
            color: white;
            padding: 16px 20px;
            border-radius: 12px 12px 0 0;
        }

        .report-header h2 {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .report-body {
            padding: 16px 20px 20px;
        }

        .report-metrics {
            border: 1px solid #25c15f;
            border-radius: 10px;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            background: #f8fffb;
            margin-bottom: 16px;
        }

        .report-metric {
            text-align: center;
        }

        .report-metric .value {
            font-weight: 700;
            color: #0f8f44;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .report-table th,
        .report-table td {
            padding: 8px 6px;
            border-bottom: 1px solid #e5e7eb;
            text-align: left;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                padding: 0 16px;
            }

            .search-container {
                width: 200px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .content {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
</div>
<div class="toast-container" id="toastContainer"></div>

<div class="dashboard-container">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="images/logo.jpeg" alt="AgriGuard AI Logo">
            </div>
            <div class="company-info">
                <div class="company-name">AgriGuard AI</div>
                <div class="company-tagline">Policy Management</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">Main</h3>
                <ul class="nav-menu">
                    <li class="nav-item active">
                        <a class="nav-link" onclick="showSection('dashboard')">
                            <i class="fas fa-chart-line"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('policies')">
                            <i class="fas fa-file-contract"></i>
                            <span>Policies</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('analytics')">
                            <i class="fas fa-chart-bar"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('performance')">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Performance</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Government</h3>
                <ul class="nav-menu">
                    <li class="nav-item"><a class="nav-link" onclick="showSection('budget')"><i class="fas fa-money-bill-wave"></i><span>Budget Management</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('compliance')"><i class="fas fa-shield-alt"></i><span>Compliance</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('audit')"><i class="fas fa-search-dollar"></i><span>Audit Trail</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('approvals')"><i class="fas fa-check-double"></i><span>Approvals</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('stakeholders')"><i class="fas fa-handshake"></i><span>Stakeholders</span></a></li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Monitoring</h3>
                <ul class="nav-menu">
                    <li class="nav-item"><a class="nav-link" onclick="showSection('monitoring')"><i class="fas fa-eye"></i><span>Real-time Monitoring</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('alerts')"><i class="fas fa-exclamation-triangle"></i><span>Alerts & Warnings</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('impact')"><i class="fas fa-chart-area"></i><span>Impact Assessment</span></a></li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Reports</h3>
                <ul class="nav-menu">
                    <li class="nav-item"><a class="nav-link" onclick="showSection('reports')"><i class="fas fa-file-alt"></i><span>Generate Reports</span></a></li>
                    <li class="nav-item"><a class="nav-link" onclick="showSection('exports')"><i class="fas fa-download"></i><span>Data Exports</span></a></li>
                </ul>
            </div>
        </nav>
    </div>

    <div class="main-content" id="mainContent">
        <header class="header">
            <div class="header-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="greeting-section">
                    <div class="greeting-text" id="greetingText">Good Morning!</div>
                    <div class="current-date" id="currentDate"></div>
                </div>
            </div>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search policies..." id="globalSearch">
                <i class="fas fa-search search-icon"></i>
            </div>
            <div class="header-right">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
                    <i class="fas fa-moon"></i><span>Dark Mode</span>
                </button>
            </div>
        </header>

        <div class="content">
            <!-- DASHBOARD -->
            <div id="dashboardSection" class="content-section active">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon total"><i class="fas fa-file-contract"></i></div>
                        <div class="stat-value" id="totalPolicies">0</div>
                        <div class="stat-label">Total Policies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon active"><i class="fas fa-check-circle"></i></div>
                        <div class="stat-value" id="activePolicies">0</div>
                        <div class="stat-label">Active Policies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon budget"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="stat-value" id="totalBudget">0</div>
                        <div class="stat-label">Total Budget</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon beneficiaries"><i class="fas fa-users"></i></div>
                        <div class="stat-value" id="totalBeneficiaries">0</div>
                        <div class="stat-label">Beneficiaries</div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Policy Status Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Policy Types</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="typeChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Policy Categories</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- POLICIES -->
            <div id="policiesSection" class="content-section">
                <div class="table-section">
                    <div class="table-header">
                        <h2 class="table-title">Policies</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="openPolicyModal()"><i class="fas fa-plus"></i>Add Policy</button>
                            <button class="btn btn-secondary" onclick="loadAllPolicies()"><i class="fas fa-sync"></i>Refresh</button>
                            <button class="btn btn-info" onclick="generatePoliciesPdf()"><i class="fas fa-file-pdf"></i>PDF</button>
                            <button class="btn btn-secondary" onclick="exportPoliciesToExcel()"><i class="fas fa-file-excel"></i>Excel</button>
                        </div>
                    </div>
                    <div style="padding: 0 24px 12px;">
                        <input type="text" class="search-input" id="policySearch" placeholder="Search policies...">
                    </div>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Budget</th>
                                    <th>Utilized</th>
                                    <th>Scope</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="policiesTableBody">
                                <tr><td colspan="9" class="empty-state">Loading policies...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS -->
            <div id="analyticsSection" class="content-section">
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header"><h3 class="chart-title">Budget vs Utilized (Top 10)</h3></div>
                        <div class="chart-container"><canvas id="budgetComparisonChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header"><h3 class="chart-title">Performance by Category</h3></div>
                        <div class="chart-container"><canvas id="performanceChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- PERFORMANCE -->
            <div id="performanceSection" class="content-section">
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header"><h3 class="chart-title">Top Performing Policies</h3></div>
                        <div class="chart-container"><canvas id="topPerformingChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header"><h3 class="chart-title">Low Performing Policies</h3></div>
                        <div class="chart-container"><canvas id="lowPerformingChart"></canvas></div>
                    </div>
                </div>
                <div class="table-section">
                    <div class="table-header">
                        <h2 class="table-title">Policies Requiring Review</h2>
                        <div class="table-actions">
                            <button class="btn btn-secondary" onclick="loadPoliciesRequiringReview()"><i class="fas fa-sync"></i>Refresh</button>
                        </div>
                    </div>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Next Review</th>
                                    <th>Agency</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reviewTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- BUDGET -->
            <div id="budgetSection" class="content-section">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon budget"><i class="fas fa-coins"></i></div>
                        <div class="stat-value" id="totalBudgetAllocated">0</div>
                        <div class="stat-label">Allocated</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon active"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-value" id="totalBudgetUtilized">0</div>
                        <div class="stat-label">Utilized</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning"><i class="fas fa-balance-scale"></i></div>
                        <div class="stat-value" id="remainingBudget">0</div>
                        <div class="stat-label">Remaining</div>
                    </div>
                </div>
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header"><h3 class="chart-title">Budget Allocation vs Utilized</h3></div>
                        <div class="chart-container"><canvas id="budgetManagementChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- COMPLIANCE -->
            <div id="complianceSection" class="content-section">
                <div class="table-section">
                    <div class="table-header">
                        <h2 class="table-title">Policy Compliance Status</h2>
                        <div class="table-actions">
                            <button class="btn btn-secondary" onclick="loadComplianceData()"><i class="fas fa-sync"></i>Refresh</button>
                        </div>
                    </div>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Last Review</th>
                                    <th>Next Review</th>
                                    <th>Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="complianceTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- AUDIT -->
            <div id="auditSection" class="content-section">
                <div class="table-section">
                    <div class="table-header">
                        <h2 class="table-title">Audit Trail</h2>
                        <div class="table-actions">
                            <button class="btn btn-secondary" onclick="loadAuditTrail()"><i class="fas fa-sync"></i>Refresh</button>
                        </div>
                    </div>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Policy</th>
                                    <th>Details</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody id="auditTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- APPROVALS -->
            <div id="approvalsSection" class="content-section">
                <div class="table-section">
                    <div class="table-header">
                        <h2 class="table-title">Pending Approvals</h2>
                        <div class="table-actions">
                            <button class="btn btn-secondary" onclick="loadApprovals()"><i class="fas fa-sync"></i>Refresh</button>
                        </div>
                    </div>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Requested By</th>
                                    <th>Request Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="approvalsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- STAKEHOLDERS -->
            <div id="stakeholdersSection" class="content-section">
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header"><h3 class="chart-title">Top Stakeholders</h3></div>
                        <div class="chart-container"><canvas id="stakeholdersChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- MONITORING -->
            <div id="monitoringSection" class="content-section">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon total"><i class="fas fa-eye"></i></div>
                        <div class="stat-value" id="activeMonitoring">0</div>
                        <div class="stat-label">Active Monitoring</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon active"><i class="fas fa-clock"></i></div>
                        <div class="stat-value" id="lastUpdate">--:--</div>
                        <div class="stat-label">Last Update</div>
                    </div>
                </div>
            </div>

            <!-- ALERTS -->
            <div id="alertsSection" class="content-section">
                <div class="table-section">
                    <div class="table-header">
                        <h2 class="table-title">Alerts & Warnings</h2>
                        <div class="table-actions">
                            <button class="btn btn-secondary" onclick="loadAlerts()"><i class="fas fa-sync"></i>Refresh</button>
                        </div>
                    </div>
                    <div class="data-table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Message</th>
                                    <th>Severity</th>
                                    <th>Date</th>
                                    <th>Policy Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="alertsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- IMPACT -->
            <div id="impactSection" class="content-section">
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header"><h3 class="chart-title">Impact Assessment (Last 12 Months)</h3></div>
                        <div class="chart-container"><canvas id="impactChart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- REPORTS -->
            <div id="reportsSection" class="content-section">
                <div class="table-section">
                    <div class="table-header">
                        <h2 class="table-title">Generate Reports</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="generatePoliciesPdf()"><i class="fas fa-file-pdf"></i>Generate PDF</button>
                            <button class="btn btn-secondary" onclick="exportPoliciesToExcel()"><i class="fas fa-file-excel"></i>Excel</button>
                        </div>
                    </div>
                    <div style="padding: 24px;">
                        <div class="report-card">
                            <div class="report-header">
                                <div>
                                    <h2>All Policies Report</h2>
                                    <div>Policy Management System</div>
                                </div>
                                <div style="text-align:right">
                                    <div id="reportDate">Generated on: --</div>
                                    <div id="reportTotal">Total Policies: 0</div>
                                </div>
                            </div>
                            <div class="report-body">
                                <div class="report-metrics">
                                    <div class="report-metric">
                                        <div>Total Budget</div>
                                        <div class="value" id="reportTotalBudget">0</div>
                                    </div>
                                    <div class="report-metric">
                                        <div>Avg Utilization</div>
                                        <div class="value" id="reportAvgUtilization">0%</div>
                                    </div>
                                    <div class="report-metric">
                                        <div>Beneficiaries</div>
                                        <div class="value" id="reportBeneficiaries">0</div>
                                    </div>
                                    <div class="report-metric">
                                        <div>Active Policies</div>
                                        <div class="value" id="reportActivePolicies">0</div>
                                    </div>
                                </div>
                                <div>Use the PDF button to generate a full report.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXPORTS -->
            <div id="exportsSection" class="content-section">
                <div class="table-section">
                    <div class="table-header">
                        <h2 class="table-title">Data Exports</h2>
                        <div class="table-actions">
                            <button class="btn btn-secondary" onclick="exportPoliciesToExcel()"><i class="fas fa-file-excel"></i>Export Excel</button>
                            <button class="btn btn-primary" onclick="generatePoliciesPdf()"><i class="fas fa-file-pdf"></i>Export PDF</button>
                        </div>
                    </div>
                    <div style="padding: 24px;">
                        <p>Export all policies and statistics to professional formats.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="policyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="policyModalTitle">Add Policy</h2>
            <button class="modal-close" onclick="closePolicyModal()"><i class="fas fa-times"></i></button>
        </div>
        <form id="policyForm" onsubmit="submitPolicyForm(event)">
            <input type="hidden" id="policyId">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Policy Code *</label>
                    <input class="form-input" id="policyCode" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Policy Name *</label>
                    <input class="form-input" id="policyName" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Type *</label>
                    <select class="form-select" id="policyType" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select class="form-select" id="policyCategory" required></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Status *</label>
                    <select class="form-select" id="policyStatus" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Geographic Scope</label>
                    <select class="form-select" id="geographicScope"></select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Implementing Agency</label>
                    <input class="form-input" id="implementingAgency">
                </div>
                <div class="form-group">
                    <label class="form-label">Ministry Responsible</label>
                    <input class="form-input" id="ministryResponsible">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Total Budget (RWF)</label>
                    <input class="form-input" type="number" id="totalBudgetInput" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Budget Utilized (RWF)</label>
                    <input class="form-input" type="number" id="budgetUtilizedInput" min="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Effective Date</label>
                    <input class="form-input" type="date" id="effectiveDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Expiry Date</label>
                    <input class="form-input" type="date" id="expiryDate">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" id="description"></textarea>
            </div>
            <div style="display:flex; gap:12px; justify-content:flex-end;">
                <button class="btn btn-secondary" type="button" onclick="closePolicyModal()">Cancel</button>
                <button class="btn btn-primary" type="submit"><i class="fas fa-save"></i>Save</button>
            </div>
        </form>
    </div>
</div>

<div id="pdfContainer" style="position:absolute; left:-9999px; top:-9999px;"></div>

<script>
const CONFIG = {
    API_BASE_URL: 'http://localhost:1010/api/policies',
    DEFAULT_PAGE_SIZE: 20,
    TOAST_DURATION: 3000,
    CACHE_DURATION: 60000,
    DEBOUNCE_DELAY: 300,
    LAZY_LOAD_DELAY: 100
};

const SECTION_MAP = {
    dashboard: 'dashboardSection',
    policies: 'policiesSection',
    analytics: 'analyticsSection',
    performance: 'performanceSection',
    budget: 'budgetSection',
    compliance: 'complianceSection',
    audit: 'auditSection',
    approvals: 'approvalsSection',
    stakeholders: 'stakeholdersSection',
    monitoring: 'monitoringSection',
    alerts: 'alertsSection',
    impact: 'impactSection',
    reports: 'reportsSection',
    exports: 'exportsSection'
};

const AppState = {
    currentSection: 'dashboard',
    policies: [],
    statistics: null,
    charts: {},
    pagination: {
        currentPage: 0,
        totalPages: 0,
        totalElements: 0
    },
    cache: {
        lastFetch: {},
        fetchPromises: {},
        data: {}
    }
};

const CacheManager = {
    set(key, data) {
        AppState.cache.data[key] = { data, timestamp: Date.now() };
    },
    get(key, maxAge = CONFIG.CACHE_DURATION) {
        const cached = AppState.cache.data[key];
        if (!cached) return null;
        return (Date.now() - cached.timestamp) < maxAge ? cached.data : null;
    }
};

const ApiService = {
    pendingRequests: new Map(),
    async request(endpoint, options = {}) {
        const url = `${CONFIG.API_BASE_URL}${endpoint}`;
        const requestKey = `${options.method || 'GET'}_${url}`;
        if (this.pendingRequests.has(requestKey)) {
            return this.pendingRequests.get(requestKey);
        }
        const defaultOptions = { headers: { 'Content-Type': 'application/json' } };
        const promise = (async () => {
            const response = await fetch(url, { ...defaultOptions, ...options });
            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
                throw new Error(data.message || 'Request failed');
            }
            return data;
        })();
        this.pendingRequests.set(requestKey, promise);
        try {
            return await promise;
        } finally {
            this.pendingRequests.delete(requestKey);
        }
    },
    // CRUD
    createPolicy(payload, createdBy) {
        return this.request(`?createdBy=${encodeURIComponent(createdBy || '')}`, {
            method: 'POST',
            body: JSON.stringify(payload)
        });
    },
    updatePolicy(id, payload, updatedBy) {
        return this.request(`/${id}?updatedBy=${encodeURIComponent(updatedBy || '')}`, {
            method: 'PUT',
            body: JSON.stringify(payload)
        });
    },
    getPolicyById(id) { return this.request(`/${id}`); },
    getPolicyByCode(code) { return this.request(`/code/${encodeURIComponent(code)}`); },
    getAllPolicies(page = 0, size = CONFIG.DEFAULT_PAGE_SIZE, sortBy = 'lastUpdated', sortDir = 'desc') {
        return this.request(`?page=${page}&size=${size}&sortBy=${sortBy}&sortDir=${sortDir}`);
    },
    deletePolicy(id) { return this.request(`/${id}`, { method: 'DELETE' }); },
    // Status management
    updatePolicyStatus(id, status, updatedBy) {
        return this.request(`/${id}/status?status=${status}&updatedBy=${encodeURIComponent(updatedBy || '')}`, { method: 'PUT' });
    },
    activatePolicy(id, updatedBy) {
        return this.request(`/${id}/activate?updatedBy=${encodeURIComponent(updatedBy || '')}`, { method: 'PUT' });
    },
    suspendPolicy(id, reason, updatedBy) {
        return this.request(`/${id}/suspend?reason=${encodeURIComponent(reason)}&updatedBy=${encodeURIComponent(updatedBy || '')}`, { method: 'PUT' });
    },
    renewPolicy(id, newExpiryDate, updatedBy) {
        return this.request(`/${id}/renew?newExpiryDate=${newExpiryDate}&updatedBy=${encodeURIComponent(updatedBy || '')}`, { method: 'PUT' });
    },
    updateExpiredPolicies() { return this.request(`/update-expired`, { method: 'PUT' }); },
    // Search & filter
    searchPolicies(keyword) { return this.request(`/search?keyword=${encodeURIComponent(keyword)}`); },
    getPoliciesByType(type) { return this.request(`/filter/type/${type}`); },
    getPoliciesByCategory(category) { return this.request(`/filter/category/${category}`); },
    getPoliciesByStatus(status) { return this.request(`/filter/status/${status}`); },
    getActivePolicies() { return this.request(`/active`); },
    getExpiredPolicies() { return this.request(`/expired`); },
    getPoliciesExpiringSoon(days = 90) { return this.request(`/expiring-soon?days=${days}`); },
    getPoliciesByImplementingAgency(agency) { return this.request(`/filter/agency?agency=${encodeURIComponent(agency)}`); },
    getPoliciesByGeographicScope(scope) { return this.request(`/filter/scope/${scope}`); },
    getPoliciesByBudgetRange(minBudget, maxBudget) { return this.request(`/filter/budget-range?minBudget=${minBudget}&maxBudget=${maxBudget}`); },
    getPoliciesRequiringReview() { return this.request(`/requiring-review`); },
    getClimateSmartPolicies() { return this.request(`/climate-smart`); },
    getYouthFocusedPolicies() { return this.request(`/youth-focused`); },
    getRecentPolicies(days = 30) { return this.request(`/recent?days=${days}`); },
    advancedSearch(criteria) { return this.request(`/search/advanced`, { method: 'POST', body: JSON.stringify(criteria) }); },
    // Performance
    getHighPerformingPolicies(minUtilizationRate = 80) { return this.request(`/performance/high-performing?minUtilizationRate=${minUtilizationRate}`); },
    getLowPerformingPolicies(threshold = 40) { return this.request(`/performance/low-performing?threshold=${threshold}`); },
    getTopPerformingPolicies() { return this.request(`/performance/top`); },
    assessPolicyEffectiveness(id) { return this.request(`/${id}/effectiveness`); },
    // Statistics
    getPolicyStatistics() { return this.request(`/statistics`); },
    getPolicyCountByStatus() { return this.request(`/statistics/by-status`); },
    getPolicyCountByType() { return this.request(`/statistics/by-type`); },
    getPolicyCountByCategory() { return this.request(`/statistics/by-category`); },
    getTotalActiveBudget() { return this.request(`/statistics/total-budget`); },
    getAverageUtilizationRate() { return this.request(`/statistics/average-utilization`); },
    // Enums
    getPolicyTypes() { return this.request(`/enums/policy-types`); },
    getPolicyCategories() { return this.request(`/enums/policy-categories`); },
    getPolicyStatuses() { return this.request(`/enums/policy-statuses`); },
    getGeographicScopes() { return this.request(`/enums/geographic-scopes`); },
    // Health
    healthCheck() { return this.request(`/health`); }
};

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<div class="toast-message">${message}</div>`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), CONFIG.TOAST_DURATION);
}

function showLoading(show = true) {
    document.getElementById('loadingOverlay').classList.toggle('show', show);
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const themeBtn = document.getElementById('themeToggle');
    if (document.body.classList.contains('dark-mode')) {
        themeBtn.innerHTML = '<i class="fas fa-sun"></i><span>Light Mode</span>';
    } else {
        themeBtn.innerHTML = '<i class="fas fa-moon"></i><span>Dark Mode</span>';
    }
    updateAllCharts();
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('sidebar-collapsed');
}

function updateDateTime() {
    const now = new Date();
    const hours = now.getHours();
    let greeting = 'Good Morning';
    if (hours >= 12 && hours < 17) greeting = 'Good Afternoon';
    else if (hours >= 17) greeting = 'Good Evening';
    document.getElementById('greetingText').textContent = greeting + '!';
    document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

function showSection(sectionName) {
    if (AppState.currentSection === sectionName) return;
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
    const mapId = SECTION_MAP[sectionName];
    if (mapId) {
        document.getElementById(mapId).classList.add('active');
        const activeLink = [...document.querySelectorAll('.nav-link')].find(link => link.getAttribute('onclick')?.includes(sectionName));
        if (activeLink) activeLink.closest('.nav-item').classList.add('active');
        AppState.currentSection = sectionName;
        setTimeout(() => loadSectionData(sectionName), CONFIG.LAZY_LOAD_DELAY);
    }
}

function formatNumber(value) {
    return new Intl.NumberFormat('en-US').format(value || 0);
}

function formatCurrency(value) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'RWF', maximumFractionDigits: 0 }).format(value || 0);
}

function formatDate(value) {
    if (!value) return 'N/A';
    return new Date(value).toLocaleDateString();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function runWhenIdle(task) {
    return new Promise(resolve => {
        const runner = () => resolve(task());
        if ('requestIdleCallback' in window) {
            requestIdleCallback(runner, { timeout: 200 });
        } else {
            setTimeout(runner, 0);
        }
    });
}

function renderTableInBatches(tbody, rows, batchSize = 120) {
    tbody.innerHTML = '';
    let index = 0;
    return new Promise(resolve => {
        const renderBatch = () => {
            const slice = rows.slice(index, index + batchSize);
            if (slice.length === 0) {
                resolve();
                return;
            }
            tbody.insertAdjacentHTML('beforeend', slice.join(''));
            index += batchSize;
            requestAnimationFrame(renderBatch);
        };
        requestAnimationFrame(renderBatch);
    });
}

function destroyChart(chartId) {
    if (AppState.charts[chartId]) {
        AppState.charts[chartId].destroy();
        delete AppState.charts[chartId];
    }
}

async function initializeApp() {
    updateDateTime();
    setInterval(updateDateTime, 60000);
    await preloadEnums();
    loadDashboardData();
    setupEventListeners();
}

function setupEventListeners() {
    const searchInput = document.getElementById('globalSearch');
    let debounceTimer = null;
    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            const value = searchInput.value.trim();
            if (AppState.currentSection === 'policies') {
                handlePolicySearch(value);
            }
        }, CONFIG.DEBOUNCE_DELAY);
    });

    const policySearch = document.getElementById('policySearch');
    policySearch.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            handlePolicySearch(policySearch.value.trim());
        }, CONFIG.DEBOUNCE_DELAY);
    });
}

async function preloadEnums() {
    try {
        const [types, categories, statuses, scopes] = await Promise.all([
            ApiService.getPolicyTypes(),
            ApiService.getPolicyCategories(),
            ApiService.getPolicyStatuses(),
            ApiService.getGeographicScopes()
        ]);
        fillSelect('policyType', types.data || []);
        fillSelect('policyCategory', categories.data || []);
        fillSelect('policyStatus', statuses.data || []);
        fillSelect('geographicScope', scopes.data || [], true);
    } catch (e) {
        console.error('Failed loading enums', e);
    }
}

function fillSelect(id, items, allowEmpty = false) {
    const select = document.getElementById(id);
    if (!select) return;
    select.innerHTML = allowEmpty ? '<option value="">Select</option>' : '';
    items.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item;
        opt.textContent = formatEnumValue(item);
        select.appendChild(opt);
    });
}

function formatEnumValue(value) {
    if (!value) return 'N/A';
    return String(value).toLowerCase().replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

async function loadSectionData(sectionName) {
    try {
        switch (sectionName) {
            case 'dashboard': await loadDashboardData(); break;
            case 'policies': await loadAllPolicies(); break;
            case 'analytics': await updateAllCharts(); break;
            case 'performance': await loadPerformanceSection(); break;
            case 'budget': await loadBudgetManagement(); break;
            case 'compliance': await loadComplianceData(); break;
            case 'audit': await loadAuditTrail(); break;
            case 'approvals': await loadApprovals(); break;
            case 'stakeholders': await loadStakeholdersData(); break;
            case 'monitoring': await loadRealTimeMonitoring(); break;
            case 'alerts': await loadAlerts(); break;
            case 'impact': await loadImpactData(); break;
            case 'reports': await updateReportCards(); break;
            case 'exports': break;
            default: break;
        }
    } catch (e) {
        showToast('Failed to load section', 'error');
    }
}

async function loadDashboardData() {
    try {
        showLoading(true);
        const statsResponse = await ApiService.getPolicyStatistics();
        const stats = statsResponse.data || {};
        AppState.statistics = stats;
        document.getElementById('totalPolicies').textContent = formatNumber(stats.totalPolicies || 0);
        document.getElementById('activePolicies').textContent = formatNumber(stats.activePolicies || 0);
        document.getElementById('totalBudget').textContent = formatCurrency(stats.totalBudget || 0);
        document.getElementById('totalBeneficiaries').textContent = formatNumber(stats.totalBeneficiaries || 0);
        await updateAllCharts();
        updateReportCards();
    } catch (e) {
        showToast('Dashboard load failed', 'error');
    } finally {
        showLoading(false);
    }
}

async function updateAllCharts() {
    const section = AppState.currentSection;
    if (section === 'dashboard') {
        await Promise.all([
            renderStatusChart(),
            renderTypeChart(),
            renderCategoryChart()
        ]);
    }
    if (section === 'analytics') {
        await Promise.all([
            renderBudgetComparisonChart(),
            renderPerformanceComparisonChart()
        ]);
    }
    if (section === 'performance') {
        await Promise.all([
            renderTopPerformingChart(),
            renderLowPerformingChart()
        ]);
    }
    if (section === 'budget') {
        await renderBudgetManagementChart();
    }
    if (section === 'stakeholders') {
        await renderStakeholdersChart();
    }
    if (section === 'impact') {
        await renderImpactChart();
    }
}

async function renderStatusChart() {
    const ctx = document.getElementById('statusChart');
    if (!ctx) return;
    const response = await ApiService.getPolicyCountByStatus();
    const data = response.data || {};
    destroyChart('statusChart');
    AppState.charts.statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(data).map(formatEnumValue),
            datasets: [{ data: Object.values(data), backgroundColor: ['#22c55e','#3b82f6','#f59e0b','#ef4444','#6b7280','#8b5cf6'] }]
        }
    });
}

async function renderTypeChart() {
    const ctx = document.getElementById('typeChart');
    if (!ctx) return;
    const response = await ApiService.getPolicyCountByType();
    const data = response.data || {};
    destroyChart('typeChart');
    AppState.charts.typeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(data).map(formatEnumValue),
            datasets: [{ label: 'Policies', data: Object.values(data), backgroundColor: '#3b82f6' }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

async function renderCategoryChart() {
    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;
    const response = await ApiService.getPolicyCountByCategory();
    const data = response.data || {};
    destroyChart('categoryChart');
    AppState.charts.categoryChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(data).map(formatEnumValue),
            datasets: [{ data: Object.values(data), backgroundColor: ['#22c55e','#3b82f6','#f59e0b','#ef4444','#6b7280','#8b5cf6','#14b8a6'] }]
        }
    });
}

async function loadAllPolicies() {
    try {
        showLoading(true);
        const response = await ApiService.getAllPolicies(AppState.pagination.currentPage, CONFIG.DEFAULT_PAGE_SIZE);
        const page = response.data || {};
        AppState.policies = page.content || [];
        AppState.pagination.totalPages = page.totalPages || 0;
        AppState.pagination.totalElements = page.totalElements || 0;
        renderPolicyTable(AppState.policies);
    } catch (e) {
        showToast('Error loading policies', 'error');
    } finally {
        showLoading(false);
    }
}

function renderPolicyTable(policies) {
    const tbody = document.getElementById('policiesTableBody');
    if (!policies || policies.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="empty-state"><i class="fas fa-info-circle"></i><p>No policies found</p></td></tr>`;
        return;
    }
    const rows = policies.map(p => `
        <tr>
            <td><strong>${escapeHtml(p.policyCode || 'N/A')}</strong></td>
            <td>${escapeHtml(p.policyName || '')}</td>
            <td>${formatEnumValue(p.policyType)}</td>
            <td>${formatEnumValue(p.policyCategory)}</td>
            <td><span class="status-badge status-${(p.status || 'draft').toLowerCase()}">${formatEnumValue(p.status)}</span></td>
            <td>${formatCurrency(p.totalBudget || 0)}</td>
            <td>${formatCurrency(p.budgetUtilized || 0)}</td>
            <td>${formatEnumValue(p.geographicScope)}</td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn action-btn-view" onclick="viewPolicy('${p.id}')"><i class="fas fa-eye"></i></button>
                    <button class="action-btn action-btn-edit" onclick="editPolicy('${p.id}')"><i class="fas fa-edit"></i></button>
                    <button class="action-btn action-btn-delete" onclick="deletePolicy('${p.id}')"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        </tr>
    `);
    renderTableInBatches(tbody, rows);
}

async function handlePolicySearch(keyword) {
    if (!keyword) {
        renderPolicyTable(AppState.policies);
        return;
    }
    try {
        const response = await ApiService.searchPolicies(keyword);
        renderPolicyTable(response.data || []);
    } catch (e) {
        showToast('Search failed', 'error');
    }
}

async function loadPerformanceSection() {
    await Promise.all([loadPoliciesRequiringReview(), updateAllCharts()]);
}

async function loadPoliciesRequiringReview() {
    const tbody = document.getElementById('reviewTableBody');
    try {
        const response = await ApiService.getPoliciesRequiringReview();
        const data = response.data || [];
        if (!data.length) {
            tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><i class="fas fa-info-circle"></i><p>No policies requiring review</p></td></tr>`;
            return;
        }
        const rows = data.map(p => `
            <tr>
                <td>${escapeHtml(p.policyCode || 'N/A')}</td>
                <td>${escapeHtml(p.policyName || '')}</td>
                <td><span class="status-badge status-${(p.status || 'draft').toLowerCase()}">${formatEnumValue(p.status)}</span></td>
                <td>${formatDate(p.nextReviewDate)}</td>
                <td>${escapeHtml(p.implementingAgency || '')}</td>
                <td><button class="action-btn action-btn-view" onclick="viewPolicy('${p.id}')"><i class="fas fa-eye"></i></button></td>
            </tr>
        `);
        renderTableInBatches(tbody, rows);
    } catch (e) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Error loading review data</p></td></tr>`;
    }
}

async function loadBudgetManagement() {
    await ensurePoliciesLoaded();
    const totalAllocated = AppState.policies.reduce((sum, p) => sum + (parseFloat(p.totalBudget || 0)), 0);
    const totalUtilized = AppState.policies.reduce((sum, p) => sum + (parseFloat(p.budgetUtilized || 0)), 0);
    const remaining = totalAllocated - totalUtilized;
    document.getElementById('totalBudgetAllocated').textContent = formatCurrency(totalAllocated);
    document.getElementById('totalBudgetUtilized').textContent = formatCurrency(totalUtilized);
    document.getElementById('remainingBudget').textContent = formatCurrency(remaining);
    await renderBudgetManagementChart();
}

async function loadComplianceData() {
    const tbody = document.getElementById('complianceTableBody');
    await ensurePoliciesLoaded();
    const today = new Date();
    const data = AppState.policies.map(p => {
        let score = 100;
        let status = 'COMPLIANT';
        if (p.expiryDate) {
            const exp = new Date(p.expiryDate);
            if (exp < today) { score -= 50; status = 'NON_COMPLIANT'; }
            else if ((exp - today) / 86400000 < 30) { score -= 20; status = 'WARNING'; }
        }
        if (p.totalBudget > 0) {
            const rate = (p.budgetUtilized || 0) / p.totalBudget * 100;
            if (rate < 30) { score -= 15; if (status === 'COMPLIANT') status = 'WARNING'; }
        }
        if (p.nextReviewDate && new Date(p.nextReviewDate) < today) { score -= 25; status = 'NON_COMPLIANT'; }
        return { ...p, complianceScore: Math.max(0, score), complianceStatus: status };
    });
    const rows = data.map(p => `
        <tr>
            <td>${escapeHtml(p.policyCode || 'N/A')}</td>
            <td>${escapeHtml(p.policyName || '')}</td>
            <td><span class="status-badge status-${p.complianceStatus.toLowerCase()}">${formatEnumValue(p.complianceStatus)}</span></td>
            <td>${formatDate(p.lastUpdated || p.createdDate)}</td>
            <td>${formatDate(p.nextReviewDate)}</td>
            <td>${p.complianceScore.toFixed(0)}%</td>
            <td><button class="action-btn action-btn-view" onclick="viewPolicy('${p.id}')"><i class="fas fa-eye"></i></button></td>
        </tr>
    `);
    renderTableInBatches(tbody, rows);
}

async function loadAuditTrail() {
    const tbody = document.getElementById('auditTableBody');
    await ensurePoliciesLoaded();
    const entries = [];
    AppState.policies.forEach(p => {
        if (p.createdDate) entries.push({ date: new Date(p.createdDate), user: p.createdBy || 'System', action: 'CREATED', policy: p.policyName || p.policyCode, details: `Policy "${p.policyName}" created`, ip: 'N/A' });
        if (p.lastUpdated && p.lastUpdated !== p.createdDate) entries.push({ date: new Date(p.lastUpdated), user: p.updatedBy || 'System', action: 'UPDATED', policy: p.policyName || p.policyCode, details: `Policy "${p.policyName}" updated`, ip: 'N/A' });
    });
    entries.sort((a, b) => b.date - a.date);
    const rows = entries.map(e => `
        <tr>
            <td>${formatDate(e.date)} ${e.date.toLocaleTimeString()}</td>
            <td>${escapeHtml(e.user)}</td>
            <td><span class="status-badge status-${e.action.toLowerCase()}">${e.action}</span></td>
            <td>${escapeHtml(e.policy)}</td>
            <td>${escapeHtml(e.details)}</td>
            <td>${escapeHtml(e.ip)}</td>
        </tr>
    `);
    renderTableInBatches(tbody, rows);
}

async function loadApprovals() {
    const tbody = document.getElementById('approvalsTableBody');
    await ensurePoliciesLoaded();
    const pending = AppState.policies.filter(p => ['DRAFT','UNDER_REVIEW'].includes(p.status));
    const rows = pending.map(p => `
        <tr>
            <td>${escapeHtml(p.policyCode || 'N/A')}</td>
            <td>${escapeHtml(p.policyName || '')}</td>
            <td>${escapeHtml(p.createdBy || 'System')}</td>
            <td>${formatDate(p.createdDate || p.lastUpdated)}</td>
            <td><span class="status-badge status-${(p.status || 'draft').toLowerCase()}">${formatEnumValue(p.status)}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn action-btn-view" onclick="viewPolicy('${p.id}')"><i class="fas fa-eye"></i></button>
                    <button class="action-btn action-btn-edit" onclick="approvePolicy('${p.id}')"><i class="fas fa-check"></i></button>
                </div>
            </td>
        </tr>
    `);
    renderTableInBatches(tbody, rows);
}

async function loadStakeholdersData() {
    await ensurePoliciesLoaded();
    await renderStakeholdersChart();
}

async function loadRealTimeMonitoring() {
    const stats = await ApiService.getPolicyStatistics();
    const activePolicies = stats.data?.activePolicies || 0;
    document.getElementById('activeMonitoring').textContent = formatNumber(activePolicies);
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
}

async function loadAlerts() {
    const tbody = document.getElementById('alertsTableBody');
    await ensurePoliciesLoaded();
    const alerts = [];
    const today = new Date();
    AppState.policies.forEach(p => {
        if (p.expiryDate && new Date(p.expiryDate) < today) {
            alerts.push({ type: 'EXPIRED', severity: 'HIGH', policy: p, message: `Policy "${p.policyName}" expired` });
        }
        if (p.nextReviewDate && new Date(p.nextReviewDate) < today) {
            alerts.push({ type: 'REVIEW_REQUIRED', severity: 'MEDIUM', policy: p, message: `Policy "${p.policyName}" requires review` });
        }
    });
    const rows = alerts.map(a => `
        <tr>
            <td><span class="status-badge status-${a.severity.toLowerCase()}">${formatEnumValue(a.type)}</span></td>
            <td>${escapeHtml(a.policy.policyCode || 'N/A')}</td>
            <td>${escapeHtml(a.policy.policyName || '')}</td>
            <td>${escapeHtml(a.message)}</td>
            <td>${a.severity}</td>
            <td>${formatDate(a.policy.expiryDate || a.policy.nextReviewDate)}</td>
            <td>${formatEnumValue(a.policy.policyType)}</td>
            <td><span class="status-badge status-${(a.policy.status || 'draft').toLowerCase()}">${formatEnumValue(a.policy.status)}</span></td>
            <td><button class="action-btn action-btn-view" onclick="viewPolicy('${a.policy.id}')"><i class="fas fa-eye"></i></button></td>
        </tr>
    `);
    renderTableInBatches(tbody, rows);
}

async function loadImpactData() {
    await ensurePoliciesLoaded();
    await renderImpactChart();
}

async function ensurePoliciesLoaded() {
    if (AppState.policies && AppState.policies.length > 0) return;
    const response = await ApiService.getAllPolicies(0, 500);
    AppState.policies = response.data?.content || [];
}

async function renderBudgetComparisonChart() {
    const ctx = document.getElementById('budgetComparisonChart');
    if (!ctx) return;
    await ensurePoliciesLoaded();
    const top = [...AppState.policies].slice(0, 10);
    destroyChart('budgetComparisonChart');
    AppState.charts.budgetComparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top.map(p => p.policyName || p.policyCode),
            datasets: [
                { label: 'Budget', data: top.map(p => p.totalBudget || 0), backgroundColor: '#3b82f6' },
                { label: 'Utilized', data: top.map(p => p.budgetUtilized || 0), backgroundColor: '#22c55e' }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

async function renderPerformanceComparisonChart() {
    const ctx = document.getElementById('performanceChart');
    if (!ctx) return;
    await ensurePoliciesLoaded();
    const categoryMap = {};
    AppState.policies.forEach(p => {
        const cat = p.policyCategory || 'UNKNOWN';
        if (!categoryMap[cat]) categoryMap[cat] = { count: 0, utilization: 0 };
        categoryMap[cat].count += 1;
        if (p.totalBudget > 0) categoryMap[cat].utilization += (p.budgetUtilized || 0) / p.totalBudget * 100;
    });
    const labels = Object.keys(categoryMap);
    const data = labels.map(c => (categoryMap[c].utilization / categoryMap[c].count).toFixed(2));
    destroyChart('performanceChart');
    AppState.charts.performanceChart = new Chart(ctx, {
        type: 'line',
        data: { labels: labels.map(formatEnumValue), datasets: [{ label: 'Avg Utilization %', data, borderColor: '#22c55e' }] },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

async function renderTopPerformingChart() {
    const ctx = document.getElementById('topPerformingChart');
    if (!ctx) return;
    const response = await ApiService.getTopPerformingPolicies();
    const data = response.data || [];
    destroyChart('topPerformingChart');
    AppState.charts.topPerformingChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: data.map(p => p.policyName || p.policyCode), datasets: [{ label: 'Utilization', data: data.map(p => p.utilizationRate || 0), backgroundColor: '#22c55e' }] },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

async function renderLowPerformingChart() {
    const ctx = document.getElementById('lowPerformingChart');
    if (!ctx) return;
    const response = await ApiService.getLowPerformingPolicies();
    const data = response.data || [];
    destroyChart('lowPerformingChart');
    AppState.charts.lowPerformingChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: data.map(p => p.policyName || p.policyCode), datasets: [{ label: 'Utilization', data: data.map(p => p.utilizationRate || 0), backgroundColor: '#ef4444' }] },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

async function renderBudgetManagementChart() {
    const ctx = document.getElementById('budgetManagementChart');
    if (!ctx) return;
    await ensurePoliciesLoaded();
    const grouped = {};
    AppState.policies.forEach(p => {
        const type = p.policyType || 'UNKNOWN';
        if (!grouped[type]) grouped[type] = { allocated: 0, utilized: 0 };
        grouped[type].allocated += parseFloat(p.totalBudget || 0);
        grouped[type].utilized += parseFloat(p.budgetUtilized || 0);
    });
    const labels = Object.keys(grouped);
    destroyChart('budgetManagementChart');
    AppState.charts.budgetManagementChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(formatEnumValue),
            datasets: [
                { label: 'Allocated', data: labels.map(l => grouped[l].allocated), backgroundColor: '#3b82f6' },
                { label: 'Utilized', data: labels.map(l => grouped[l].utilized), backgroundColor: '#22c55e' }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

async function renderStakeholdersChart() {
    const ctx = document.getElementById('stakeholdersChart');
    if (!ctx) return;
    await ensurePoliciesLoaded();
    const map = {};
    AppState.policies.forEach(p => {
        const agency = p.implementingAgency || 'Unknown';
        map[agency] = (map[agency] || 0) + 1;
    });
    const labels = Object.keys(map).slice(0, 10);
    destroyChart('stakeholdersChart');
    AppState.charts.stakeholdersChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Policies', data: labels.map(l => map[l]), backgroundColor: '#22c55e' }] },
        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
    });
}

async function renderImpactChart() {
    const ctx = document.getElementById('impactChart');
    if (!ctx) return;
    await ensurePoliciesLoaded();
    const last12 = [...Array(12)].map((_, i) => {
        const d = new Date();
        d.setMonth(d.getMonth() - (11 - i));
        return d.toLocaleString('en-US', { month: 'short' });
    });
    const values = last12.map(() => Math.floor(Math.random() * 100));
    destroyChart('impactChart');
    AppState.charts.impactChart = new Chart(ctx, {
        type: 'line',
        data: { labels: last12, datasets: [{ label: 'Impact Score', data: values, borderColor: '#3b82f6', fill: false }] },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function openPolicyModal(policy = null) {
    document.getElementById('policyModal').classList.add('show');
    if (!policy) {
        document.getElementById('policyModalTitle').textContent = 'Add Policy';
        document.getElementById('policyForm').reset();
        document.getElementById('policyId').value = '';
        return;
    }
    document.getElementById('policyModalTitle').textContent = 'Edit Policy';
    document.getElementById('policyId').value = policy.id || '';
    document.getElementById('policyCode').value = policy.policyCode || '';
    document.getElementById('policyName').value = policy.policyName || '';
    document.getElementById('policyType').value = policy.policyType || '';
    document.getElementById('policyCategory').value = policy.policyCategory || '';
    document.getElementById('policyStatus').value = policy.status || '';
    document.getElementById('geographicScope').value = policy.geographicScope || '';
    document.getElementById('implementingAgency').value = policy.implementingAgency || '';
    document.getElementById('ministryResponsible').value = policy.ministryResponsible || '';
    document.getElementById('totalBudgetInput').value = policy.totalBudget || 0;
    document.getElementById('budgetUtilizedInput').value = policy.budgetUtilized || 0;
    document.getElementById('effectiveDate').value = policy.effectiveDate || '';
    document.getElementById('expiryDate').value = policy.expiryDate || '';
    document.getElementById('description').value = policy.description || '';
}

function closePolicyModal() {
    document.getElementById('policyModal').classList.remove('show');
}

async function submitPolicyForm(event) {
    event.preventDefault();
    const payload = {
        policyCode: document.getElementById('policyCode').value.trim(),
        policyName: document.getElementById('policyName').value.trim(),
        policyType: document.getElementById('policyType').value,
        policyCategory: document.getElementById('policyCategory').value,
        status: document.getElementById('policyStatus').value,
        geographicScope: document.getElementById('geographicScope').value || null,
        implementingAgency: document.getElementById('implementingAgency').value || null,
        ministryResponsible: document.getElementById('ministryResponsible').value || null,
        totalBudget: parseFloat(document.getElementById('totalBudgetInput').value || 0),
        budgetUtilized: parseFloat(document.getElementById('budgetUtilizedInput').value || 0),
        effectiveDate: document.getElementById('effectiveDate').value || null,
        expiryDate: document.getElementById('expiryDate').value || null,
        description: document.getElementById('description').value || null
    };
    try {
        showLoading(true);
        const id = document.getElementById('policyId').value;
        if (id) {
            await ApiService.updatePolicy(id, payload, 'Admin');
            showToast('Policy updated successfully', 'success');
        } else {
            await ApiService.createPolicy(payload, 'Admin');
            showToast('Policy created successfully', 'success');
        }
        closePolicyModal();
        await loadAllPolicies();
        await loadDashboardData();
    } catch (e) {
        showToast(e.message || 'Error saving policy', 'error');
    } finally {
        showLoading(false);
    }
}

async function viewPolicy(id) {
    try {
        const response = await ApiService.getPolicyById(id);
        openPolicyModal(response.data);
    } catch (e) {
        showToast('Error loading policy', 'error');
    }
}

async function editPolicy(id) {
    await viewPolicy(id);
}

async function deletePolicy(id) {
    if (!confirm('Delete this policy?')) return;
    try {
        await ApiService.deletePolicy(id);
        showToast('Policy deleted', 'success');
        await loadAllPolicies();
        await loadDashboardData();
    } catch (e) {
        showToast('Delete failed', 'error');
    }
}

async function approvePolicy(id) {
    try {
        await ApiService.activatePolicy(id, 'Admin');
        showToast('Policy approved', 'success');
        await loadApprovals();
        await loadDashboardData();
    } catch (e) {
        showToast('Approval failed', 'error');
    }
}

async function generatePoliciesPdf() {
    try {
        showLoading(true);
        await ensurePoliciesLoaded();
        const stats = AppState.statistics || {};

        const container = document.getElementById('pdfContainer');
        container.innerHTML = `
            <div class="report-card" id="policyReport">
                <div class="report-header">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="width:42px;height:42px;border-radius:8px;background:#fff;display:flex;align-items:center;justify-content:center;">
                            <img src="images/logo.jpeg" style="width:36px;height:36px;object-fit:contain;">
                        </div>
                        <div>
                            <h2>AgriGuard AI</h2>
                            <div>Policy Management System</div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div>Generated on: ${new Date().toLocaleDateString()}</div>
                        <div>Total Policies: ${formatNumber(stats.totalPolicies || AppState.policies.length)}</div>
                    </div>
                </div>
                <div class="report-body">
                    <h3>All Policies Report</h3>
                    <div class="report-metrics">
                        <div class="report-metric">
                            <div>Total Budget</div>
                            <div class="value">${formatCurrency(stats.totalBudget || 0)}</div>
                        </div>
                        <div class="report-metric">
                            <div>Avg Utilization</div>
                            <div class="value">${(stats.averageUtilizationRate || 0).toFixed(1)}%</div>
                        </div>
                        <div class="report-metric">
                            <div>Total Beneficiaries</div>
                            <div class="value">${formatNumber(stats.totalBeneficiaries || 0)}</div>
                        </div>
                        <div class="report-metric">
                            <div>Active Policies</div>
                            <div class="value">${formatNumber(stats.activePolicies || 0)}</div>
                        </div>
                    </div>
                    <div style="margin-top:12px; font-weight:600;">Policy Details</div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Budget (RWF)</th>
                                <th>Utilization %</th>
                                <th>Beneficiaries</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${AppState.policies.slice(0, 12).map(p => `
                                <tr>
                                    <td>${escapeHtml(p.policyCode || 'N/A')}</td>
                                    <td>${escapeHtml(p.policyName || '')}</td>
                                    <td>${formatEnumValue(p.policyType)}</td>
                                    <td>${formatEnumValue(p.status)}</td>
                                    <td>${formatNumber(p.totalBudget || 0)}</td>
                                    <td>${p.totalBudget > 0 ? ((p.budgetUtilized || 0) / p.totalBudget * 100).toFixed(1) : '0.0'}%</td>
                                    <td>${formatNumber(p.beneficiariesCount || 0)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        const report = document.getElementById('policyReport');
        const canvas = await html2canvas(report, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        pdf.save(`All_Policies_Report_${Date.now()}.pdf`);
        showToast('PDF generated successfully', 'success');
    } catch (e) {
        showToast('PDF generation failed', 'error');
    } finally {
        showLoading(false);
    }
}

function exportPoliciesToExcel() {
    if (!AppState.policies.length) {
        showToast('No policies to export', 'warning');
        return;
    }
    const data = AppState.policies.map(p => ({
        'Policy Code': p.policyCode || 'N/A',
        'Policy Name': p.policyName || '',
        'Type': formatEnumValue(p.policyType),
        'Category': formatEnumValue(p.policyCategory),
        'Status': formatEnumValue(p.status),
        'Budget (RWF)': p.totalBudget || 0,
        'Budget Utilized (RWF)': p.budgetUtilized || 0,
        'Beneficiaries': p.beneficiariesCount || 0
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Policies');
    XLSX.writeFile(wb, `Policies_${Date.now()}.xlsx`);
    showToast('Excel exported successfully', 'success');
}

function updateReportCards() {
    const stats = AppState.statistics || {};
    document.getElementById('reportDate').textContent = `Generated on: ${new Date().toLocaleDateString()}`;
    document.getElementById('reportTotal').textContent = `Total Policies: ${formatNumber(stats.totalPolicies || AppState.policies.length || 0)}`;
    document.getElementById('reportTotalBudget').textContent = formatCurrency(stats.totalBudget || 0);
    document.getElementById('reportAvgUtilization').textContent = `${(stats.averageUtilizationRate || 0).toFixed(1)}%`;
    document.getElementById('reportBeneficiaries').textContent = formatNumber(stats.totalBeneficiaries || 0);
    document.getElementById('reportActivePolicies').textContent = formatNumber(stats.activePolicies || 0);
}

window.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
