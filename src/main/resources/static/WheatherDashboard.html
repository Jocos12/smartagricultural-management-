<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Analytics Dashboard - AgriGuard AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>


    <style>


        /* ==================== CSS Variables for Light/Dark Mode ==================== */
        :root {
            /* Primary Green Colors */
            --primary-green: #22c55e;
            --primary-dark: #16a34a;
            --secondary-green: #10b981;
            --accent-green: #34d399;
            --light-green: #dcfce7;
            --dark-green: #166534;
            --forest-green: #065f46;

            /* Status Colors */
            --success-color: #22c55e;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;

            /* Background Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-sidebar: #e8f5e8;
            --card-bg: #ffffff;

            /* Text Colors */
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #9ca3af;

            /* Border & Shadow */
            --border-color: #e0e0e0;
            --hover-bg: rgba(34, 197, 94, 0.1);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 25px rgba(34, 197, 94, 0.15);
            --shadow-xl: 0 20px 40px rgba(34, 197, 94, 0.2);

            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #22c55e, #10b981);
            --gradient-bg: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
            --gradient-card: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);

            /* Modal */
            --modal-bg: rgba(0, 0, 0, 0.5);
        }

        .dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-sidebar: #1f2937;
            --card-bg: #374151;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #9ca3af;
            --border-color: #404040;
            --hover-bg: rgba(34, 197, 94, 0.2);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --gradient-bg: linear-gradient(135deg, #1f2937 0%, #374151 50%, #4b5563 100%);
            --gradient-card: linear-gradient(135deg, #374151 0%, #1f2937 100%);
        }

        /* ==================== Global Styles ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gradient-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* ==================== Loading Overlay ==================== */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        .loading-overlay.show {
            display: flex;
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        .loader-text {
            color: white;
            margin-top: 20px;
            font-weight: 600;
            font-size: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ==================== Toast Notifications ==================== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid;
            animation: slideInRight 0.3s ease;
            min-width: 300px;
            max-width: 400px;
        }

        .toast.success { border-left-color: var(--success-color); }
        .toast.error { border-left-color: var(--error-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.info { border-left-color: var(--primary-green); }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-message {
            color: var(--text-primary);
            font-weight: 500;
            margin: 0;
        }

        /* ==================== Dashboard Container ==================== */
        .dashboard-container {
            display: flex;
            height: 100vh;
        }

        /* ==================== Sidebar Styles ==================== */
        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            color: white;
            font-size: 24px;
            flex-shrink: 0;
            box-shadow: var(--shadow);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .company-info {
            flex: 1;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .company-info {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        .company-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .company-tagline {
            font-size: 11px;
            color: var(--primary-green);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ==================== Sidebar Navigation ==================== */
        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 30px;
        }

        .nav-section-title {
            padding: 0 20px 10px;
            font-size: 11px;
            font-weight: 700;
            color: var(--primary-green);
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .sidebar.collapsed .nav-section-title {
            opacity: 0;
            height: 0;
            padding: 0;
            margin: 0;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 0 25px 25px 0;
            margin-right: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .nav-link:hover::before {
            left: 100%;
        }

        .nav-link i {
            width: 22px;
            margin-right: 14px;
            font-size: 18px;
            flex-shrink: 0;
        }

        .nav-link span {
            transition: opacity 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
        }

        .nav-link:hover {
            background: var(--hover-bg);
            color: var(--primary-green);
            transform: translateX(5px);
        }

        .nav-item.active .nav-link {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow);
        }

        .nav-item.active .nav-link:hover {
            background: var(--gradient-primary);
            color: white;
        }

        .sidebar.collapsed .nav-link {
            justify-content: center;
            margin-right: 0;
            border-radius: 0;
        }

        .sidebar.collapsed .nav-link span {
            display: none;
        }

        /* ==================== Main Content ==================== */
        .main-content {
            flex: 1;
            margin-left: 280px;
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s ease;
        }

        .main-content.collapsed {
            margin-left: 70px;
        }

        /* ==================== Header ==================== */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 80px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);

             z-index: 9999; /* Ajout√© */
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            padding: 12px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: var(--hover-bg);
            color: var(--primary-green);
            transform: scale(1.1);
        }

        .greeting-section {
            display: flex;
            flex-direction: column;
        }

        .greeting-text {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .current-date {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .location-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .location-selector:hover {
            border-color: var(--primary-green);
        }

        .location-selector i {
            color: var(--primary-green);
            font-size: 16px;
        }

        .location-select {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }

        .location-select:focus {
            outline: none;
        }

        .theme-toggle,
        .refresh-btn {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-toggle:hover,
        .refresh-btn:hover {
            background: var(--hover-bg);
            border-color: var(--primary-green);
            color: var(--primary-green);
            transform: translateY(-2px);
        }

        .profile-section {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .profile-section:hover {
            background: var(--hover-bg);
        }

        .profile-avatar {
            width: 45px;
            height: 45px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            box-shadow: var(--shadow);
        }

        .profile-info {
            display: flex;
            flex-direction: column;
        }

        .profile-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .profile-role {
            font-size: 12px;
            color: var(--primary-green);
            font-weight: 500;
            text-transform: capitalize;
        }

        /* ==================== Content Area ==================== */
        .content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            background: var(--bg-secondary);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .section-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .section-actions .form-select {
            min-width: 140px;
        }

        .section-actions .btn {
            white-space: nowrap;
        }

        /* ==================== Statistics Grid ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 55px;
            height: 55px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 26px;
            flex-shrink: 0;
            box-shadow: var(--shadow);
        }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* ==================== Charts ==================== */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .chart-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-actions {
            display: flex;
            gap: 8px;
        }

        .chart-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .chart-btn:hover {
            background: var(--hover-bg);
            border-color: var(--primary-green);
            color: var(--primary-green);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-empty {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 14px;
            text-align: center;
            padding: 16px;
        }

        /* ==================== Buttons ==================== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #047857);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
            border-color: var(--primary-green);
            color: var(--primary-green);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        /* ==================== Form Elements ==================== */
        .date-input,
        .form-select,
        .form-input {
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .date-input:focus,
        .form-select:focus,
        .form-input:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
        }

        .form-group.full-width,
        .button-group.full-width {
            grid-column: 1 / -1;
        }

        .date-input,
        .form-select,
        .form-input {
            width: 100%;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        /* ==================== Tables ==================== */
        .table-container {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .data-table td {
            color: var(--text-primary);
            font-size: 14px;
        }

        .data-table tr:hover {
            background: var(--hover-bg);
        }

        /* ==================== Weather Cards ==================== */
        .weather-grid,
        .extreme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .weather-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .weather-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .weather-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .weather-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .weather-icon {
            font-size: 48px;
        }

        .weather-temp {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .weather-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .weather-detail i {
            color: var(--primary-green);
        }

        .current-weather-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 24px;
        }

        .current-subgrid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .current-main-card .weather-temp {
            font-size: 48px;
        }

        .weather-condition {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-green);
            margin-top: 6px;
        }

        .weather-timestamp {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .weather-card.rainy::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: repeating-linear-gradient(
                -15deg,
                rgba(255, 255, 255, 0.25),
                rgba(255, 255, 255, 0.25) 2px,
                transparent 2px,
                transparent 14px
            );
            background-size: 140% 140%;
            opacity: 0.35;
            animation: rainFall 1.2s linear infinite;
            pointer-events: none;
        }

        @keyframes rainFall {
            0% { background-position: 0 -60px; }
            100% { background-position: 0 80px; }
        }

        /* ==================== Badges ==================== */
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-excellent {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
        }

        .badge-good {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .badge-fair {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .badge-poor {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }

        /* ==================== Action Buttons ==================== */
        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 4px;
            font-size: 14px;
            transition: all 0.3s ease;
            color: white;
        }

        .action-btn.edit {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .action-btn.delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* ==================== Prediction Cards ==================== */
        .prediction-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .info-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .info-card i {
            font-size: 36px;
            color: var(--primary-green);
        }

        .info-card h4 {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-card p {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .prediction-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 32px;
        }

        .prediction-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
        }

        .prediction-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .prediction-date {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .prediction-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-green);
        }

        .prediction-meta {
            margin-top: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.4px;
        }

        .prediction-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .prediction-details i {
            color: var(--primary-green);
            margin-right: 6px;
        }

        .prediction-empty {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px dashed var(--border-color);
        }

        .prediction-empty h3 {
            margin: 8px 0 6px;
        }

        /* ==================== Statistics Summary ==================== */
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .summary-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .summary-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* ==================== Quality Metrics ==================== */
        .quality-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
        }

        .quality-card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
        }

        .quality-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .quality-score {
            font-size: 48px;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
        }

        .quality-score.excellent { color: #10b981; }
        .quality-score.good { color: #3b82f6; }
        .quality-score.fair { color: #f59e0b; }
        .quality-score.poor { color: #ef4444; }

        /* ==================== Report Configuration ==================== */
        .report-config {
            background: var(--card-bg);
            padding: 32px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .date-range {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* ==================== Modal Styles ==================== */
        #weatherModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-bg);
            z-index: 10001;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        #weatherModal.show {
            display: flex !important;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--hover-bg);
            color: var(--primary-green);
            transform: scale(1.1);
        }

        /* ==================== Empty State ==================== */
        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
            color: var(--primary-green);
        }

        .empty-state p {
            font-size: 16px;
            font-weight: 500;
            margin-top: 12px;
        }

        /* ==================== Pagination ==================== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 32px;
            padding: 20px;
        }

        .pagination-info {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .pagination-btn {
            padding: 10px 16px;
            border: 2px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary-green);
            color: white;
            border-color: var(--primary-green);
            transform: translateY(-2px);
        }

        .pagination-btn.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary-green);
            box-shadow: var(--shadow);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #pageInfo {
            margin: 0 16px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 14px;
        }

        /* ==================== Custom Scrollbar ==================== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-green);
            border-radius: 5px;
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* ==================== Responsive Design ==================== */
        @media (max-width: 1400px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1200px) {
            .weather-grid,
            .extreme-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 992px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }

            .prediction-results {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .main-content.collapsed {
                margin-left: 0;
            }

            .header {
                padding: 0 16px;
                height: 70px;
            }

            .header-left {
                gap: 12px;
            }

            .greeting-text {
                font-size: 18px;
            }

            .current-date {
                font-size: 12px;
            }

            .header-right {
                gap: 12px;
            }

            .location-selector {
                padding: 8px 12px;
            }

            .location-selector span {
                display: none;
            }

            .profile-info {
                display: none;
            }

            .content {
                padding: 20px 16px;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .section-header h2 {
                font-size: 22px;
            }

            .section-actions {
                width: 100%;
                flex-wrap: wrap;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .charts-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .weather-grid,
            .extreme-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .prediction-info {
                grid-template-columns: 1fr;
            }

            .stats-summary {
                grid-template-columns: 1fr;
            }

            .quality-metrics {
                grid-template-columns: 1fr;
            }

            .current-weather-grid {
                grid-template-columns: 1fr;
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 10px 8px;
            }

            .button-group {
                flex-direction: column;
                width: 100%;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 24px;
            }

            .date-range {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media (max-width: 576px) {
            .greeting-text {
                font-size: 16px;
            }

            .section-header h2 {
                font-size: 20px;
            }

            .stat-value {
                font-size: 24px;
            }

            .chart-title {
                font-size: 16px;
            }

            .weather-temp {
                font-size: 28px;
            }

            .prediction-value {
                font-size: 24px;
            }

            .summary-value {
                font-size: 24px;
            }

            .quality-score {
                font-size: 36px;
            }

            .theme-toggle span,
            .refresh-btn span {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .header {
                height: 60px;
            }

            .sidebar-toggle {
                padding: 8px;
            }

            .theme-toggle,
            .refresh-btn {
                padding: 10px;
            }

            .profile-avatar {
                width: 38px;
                height: 38px;
                font-size: 14px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-icon {
                width: 45px;
                height: 45px;
                font-size: 22px;
            }

            .chart-card {
                padding: 16px;
            }

            .weather-card {
                padding: 16px;
            }

            .modal-title {
                font-size: 20px;
            }

            .form-label {
                font-size: 13px;
            }

            .date-input,
            .form-select,
            .form-input {
                padding: 10px 12px;
                font-size: 13px;
            }
        }

        /* ==================== Print Styles ==================== */
        @media print {
            .sidebar,
            .header,
            .section-actions,
            .chart-actions,
            .action-btn,
            .pagination,
            .modal,
            .toast-container,
            .loading-overlay {
                display: none !important;
            }

            .main-content {
                margin-left: 0 !important;
            }

            .content {
                padding: 0 !important;
            }

            .chart-card,
            .stat-card,
            .weather-card,
            .table-container {
                break-inside: avoid;
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }

            body {
                background: white !important;
                color: black !important;
            }
        }

        /* ==================== Animation Classes ==================== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.5s ease;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .bounce {
            animation: bounce 1s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        .shimmer {
            background: linear-gradient(
                to right,
                var(--bg-secondary) 4%,
                var(--hover-bg) 25%,
                var(--bg-secondary) 36%
            );
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }

        /* ==================== Utility Classes ==================== */
        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-left {
            text-align: left;
        }

        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 16px; }
        .mt-3 { margin-top: 24px; }
        .mt-4 { margin-top: 32px; }

        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .mb-4 { margin-bottom: 32px; }

        .p-1 { padding: 8px; }
        .p-2 { padding: 16px; }
        .p-3 { padding: 24px; }
        .p-4 { padding: 32px; }

        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .flex {
            display: flex;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flex-between {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .gap-1 { gap: 8px; }
        .gap-2 { gap: 16px; }
        .gap-3 { gap: 24px; }
        .gap-4 { gap: 32px; }

        .rounded {
            border-radius: 8px;
        }

        .rounded-lg {
            border-radius: 12px;
        }

        .rounded-xl {
            border-radius: 16px;
        }

        .shadow {
            box-shadow: var(--shadow);
        }

        .shadow-lg {
            box-shadow: var(--shadow-lg);
        }

        .shadow-xl {
            box-shadow: var(--shadow-xl);
        }

        /* ==================== Focus Visible ==================== */
        *:focus-visible {
            outline: 2px solid var(--primary-green);
            outline-offset: 2px;
        }

        /* ==================== Selection ==================== */
        ::selection {
            background: var(--primary-green);
            color: white;
        }

        ::-moz-selection {
            background: var(--primary-green);
            color: white;
        }




        /* ==================== Food Security Specific Styles ==================== */
.risk-indicator {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 8px;
    margin-bottom: 12px;
}

.risk-indicator-label {
    flex: 1;
    font-weight: 500;
    color: var(--text-primary);
}

.risk-indicator-value {
    font-weight: 700;
    font-size: 18px;
}

.risk-bar {
    width: 100%;
    height: 8px;
    background: var(--bg-secondary);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 8px;
}

.risk-bar-fill {
    height: 100%;
    transition: width 0.5s ease, background 0.3s ease;
}

.risk-critical { color: #dc2626; background: #dc2626; }
.risk-high { color: #f59e0b; background: #f59e0b; }
.risk-medium { color: #3b82f6; background: #3b82f6; }
.risk-low { color: #10b981; background: #10b981; }

.recommendation-item {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: 12px;
    margin-bottom: 12px;
    border-left: 4px solid var(--primary-green);
    transition: all 0.3s ease;
}

.recommendation-item:hover {
    transform: translateX(5px);
    box-shadow: var(--shadow);
}

.recommendation-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-green);
    color: white;
    flex-shrink: 0;
}

.recommendation-text {
    flex: 1;
    color: var(--text-primary);
    line-height: 1.6;
}

.alert-card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    border-left: 4px solid;
    margin-bottom: 16px;
    transition: all 0.3s ease;
}

.alert-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.alert-card.critical { border-left-color: #dc2626; }
.alert-card.high { border-left-color: #f59e0b; }
.alert-card.medium { border-left-color: #3b82f6; }
.alert-card.low { border-left-color: #10b981; }

.alert-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

        .alert-type i {
            margin-right: 6px;
            color: var(--primary-green);
        }

.food-alerts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
    padding: 16px;
}

.food-alert-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 14px;
    padding: 16px;
    box-shadow: var(--shadow);
    border-left: 4px solid var(--primary-green);
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.food-alert-card.alert-critical { border-left-color: #dc2626; }
.food-alert-card.alert-high { border-left-color: #f59e0b; }
.food-alert-card.alert-medium { border-left-color: #3b82f6; }
.food-alert-card.alert-low { border-left-color: #10b981; }

.food-alert-card .food-alert-title {
    font-weight: 700;
    color: var(--text-primary);
}

.food-alert-card .food-alert-meta {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.alert-type {
    font-weight: 700;
    font-size: 16px;
    color: var(--text-primary);
}

.alert-severity {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.alert-severity.critical {
    background: rgba(220, 38, 38, 0.1);
    color: #dc2626;
}

.alert-severity.high {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
}

.alert-severity.medium {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

.alert-message {
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 12px;
}

.alert-timestamp {
    font-size: 12px;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 6px;
}

.metric-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

.metric-item {
    text-align: center;
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: 12px;
}

.metric-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary-green);
    margin-bottom: 4px;
}

.metric-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}







/* Notification Dropdown Styles - REMPLACER COMPL√àTEMENT */
.notification-btn {
    position: relative;
    cursor: pointer;
}

.header-right {
    position: relative;
}

.notification-dropdown {
    position: fixed;
    top: 70px;
    right: 20px;
    width: 400px;
    max-height: 600px;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    z-index: 10000;
    display: none;
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.notification-dropdown.show {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.notification-dropdown-header {
    padding: 18px 20px;
    border-bottom: 2px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
    color: white;
}

.notification-dropdown-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: white;
    display: flex;
    align-items: center;
    gap: 8px;
}

.notification-dropdown-header h3 i {
    font-size: 16px;
}

.mark-all-read-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 8px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.mark-all-read-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
}

.notification-list {
    max-height: 400px;
    overflow-y: auto;
}

.notification-list::-webkit-scrollbar {
    width: 6px;
}

.notification-list::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

.notification-list::-webkit-scrollbar-thumb {
    background: var(--border-color);
    border-radius: 3px;
}

.notification-list::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}

.notification-empty {
    padding: 40px 20px;
    text-align: center;
    color: var(--text-secondary);
}

.notification-empty i {
    font-size: 48px;
    margin-bottom: 12px;
    opacity: 0.3;
}

.notification-empty p {
    margin: 0;
    font-size: 14px;
}

.notification-item {
    display: flex;
    align-items: flex-start;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    background: var(--card-bg);
}

.notification-item:hover {
    background: var(--hover-bg);
    transform: translateX(4px);
}

.notification-item:active {
    transform: translateX(2px);
}

.notification-item:last-child {
    border-bottom: none;
}

.notification-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    flex-shrink: 0;
}

.notification-success .notification-icon {
    background: rgba(34, 197, 94, 0.1);
    color: var(--success-color);
}

.notification-info .notification-icon {
    background: rgba(59, 130, 246, 0.1);
    color: var(--info-color);
}

.notification-danger .notification-icon {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error-color);
}

.notification-warning .notification-icon {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
}

.notification-default .notification-icon {
    background: var(--bg-secondary);
    color: var(--text-secondary);
}

.notification-content {
    flex: 1;
    min-width: 0;
}

.notification-message {
    margin: 0 0 4px 0;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    line-height: 1.4;
    word-wrap: break-word;
}

.notification-time {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 4px;
}

.notification-time i {
    font-size: 10px;
}

.notification-mark-read {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 8px;
    border-radius: 6px;
    transition: all 0.3s ease;
    opacity: 0;
    margin-left: 8px;
}

.notification-item:hover .notification-mark-read {
    opacity: 1;
}

.notification-mark-read:hover {
    background: var(--hover-bg);
    color: var(--primary-green);
}

.notification-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ef4444;
    color: white;
    border-radius: 12px;
    padding: 3px 7px;
    font-size: 11px;
    font-weight: 700;
    min-width: 22px;
    height: 22px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--card-bg);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
}

.dark-mode .notification-dropdown {
    background: var(--card-bg);
    border-color: var(--border-color);
}

.dark-mode .notification-dropdown-header {
    background: var(--bg-secondary);
}

.dark-mode .notification-item:hover {
    background: var(--hover-bg);
}

@media (max-width: 768px) {
    .notification-dropdown {
        width: calc(100vw - 40px);
        right: 20px;
        left: 20px;
        max-width: 400px;
    }
}

/* Animation for new notifications */
@keyframes notificationSlideIn {
    from {
        opacity: 0;
        transform: translateX(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.notification-item {
    animation: notificationSlideIn 0.3s ease;
}




    </style>


</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
    <div class="loader-text">Loading Weather Data...</div>
</div>

<div class="toast-container" id="toastContainer"></div>

<div class="dashboard-container">









    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo" style="width: 45px; height: 45px; background: none; animation: none; box-shadow: none;">
                <img src="images/logo.jpeg" alt="AgriGuard AI Logo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
            </div>
            <div class="company-info">
                <div class="company-name">Weather Analytics</div>
                <div class="company-tagline">AgriGuard AI</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">Main</h3>
                <ul class="nav-menu">
                    <li class="nav-item active">
                        <a class="nav-link" data-section="overview">
                            <i class="fas fa-chart-line"></i>
                            <span>Overview</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="current">
                            <i class="fas fa-cloud-sun"></i>
                            <span>Current Weather</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="historical">
                            <i class="fas fa-history"></i>
                            <span>Historical Data</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="predictions">
                            <i class="fas fa-brain"></i>
                            <span>AI Predictions</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Analytics</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="statistics">
                            <i class="fas fa-chart-bar"></i>
                            <span>Statistics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="trends">
                            <i class="fas fa-arrow-trend-up"></i>
                            <span>Trends</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="extreme">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Extreme Weather</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="foodSecurity">
                            <i class="fas fa-shield-alt"></i>
                            <span>Food Security</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="alerts">
                            <i class="fas fa-bell"></i>
                            <span>Weather Alerts</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Management</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="crud">
                            <i class="fas fa-database"></i>
                            <span>Data Management</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Reports</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" data-section="reports">
                            <i class="fas fa-file-alt"></i>
                            <span>Generate Reports</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-section="quality">
                            <i class="fas fa-check-circle"></i>
                            <span>Data Quality</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="AllSystemReports.html">
                            <i class="fas fa-file-chart-line"></i>
                            <span>All System Reports</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Dashboards</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" href="adminDashboard.html">
                            <i class="fas fa-user-shield"></i>
                            <span>Admin Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="CropDashboard.html">
                            <i class="fas fa-seedling"></i>
                            <span>Crop Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="CropProductionDashboard.html">
                            <i class="fas fa-chart-bar"></i>
                            <span>Crop Production</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="FarmDashboard.html">
                            <i class="fas fa-home"></i>
                            <span>Farm Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="FertilizerDashboard.html">
                            <i class="fas fa-flask"></i>
                            <span>Fertilizer Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="InventoryDashboard.html">
                            <i class="fas fa-boxes"></i>
                            <span>Inventory Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="IrrigationDashboard.html">
                            <i class="fas fa-tint"></i>
                            <span>Irrigation Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ProductPrediction.html">
                            <i class="fas fa-brain"></i>
                            <span>Product Prediction</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="TransactionDashboard.html">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Transactions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="MarketPriceDashboard.html">
                            <i class="fas fa-dollar-sign"></i>
                            <span>Market Prices</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="SupplyChain.html">
                            <i class="fas fa-truck"></i>
                            <span>Supply Chain</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Soil.html">
                            <i class="fas fa-mountain"></i>
                            <span>Soil Data</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="FoodAlertDashboard.html">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Food Security Alerts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ResourceRecommendation.html">
                            <i class="fas fa-lightbulb"></i>
                            <span>Resource Recommendations</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="WhatsApp.html">
                            <i class="fab fa-whatsapp"></i>
                            <span>Chat</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </aside>














    <div class="main-content" id="mainContent">
        <header class="header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="greeting-section">
                    <div class="greeting-text" id="greetingText">Weather Dashboard</div>
                    <div class="current-date" id="currentDate"></div>
                </div>
            </div>

            <div class="header-right">
                <div class="location-selector">
                    <i class="fas fa-map-marker-alt"></i>
                    <select id="locationFilter" class="location-select">
                        <option value="">All Locations</option>
                    </select>
                </div>
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-moon"></i>
                </button>





                <button class="refresh-btn" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                </button>







                <!-- Notification Icon avec dropdown -->
                <div class="notification-container" style="position: relative;">
                    <button class="notification-btn" onclick="toggleNotifications()" style="background: none; border: none; cursor: pointer; position: relative; padding: 10px;">
                        <i class="fas fa-bell" style="font-size: 20px; color: var(--text-primary);"></i>
                        <span class="notification-badge" id="notificationBadge">0</span>
                    </button>

                    <!-- Dropdown de notifications -->
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-dropdown-header">
                            <h3><i class="fas fa-bell"></i> Notifications</h3>
                            <button class="mark-all-read-btn" onclick="markAllAsRead()">
                                <i class="fas fa-check-double"></i> Mark all read
                            </button>
                        </div>
                        <div class="notification-list" id="notificationList">
                            <div class="notification-empty">
                                <i class="fas fa-bell-slash"></i>
                                <p>No notifications yet</p>
                            </div>
                        </div>
                    </div>
                </div>



                <div class="profile-section">
                    <div class="profile-avatar" id="profileAvatar">U</div>
                    <div class="profile-info">
                        <div class="profile-name" id="profileName">User</div>
                        <div class="profile-role">Weather Analyst</div>
                    </div>
                </div>
            </div>
        </header>

        <main class="content">
            <!-- Overview Section -->
            <div id="overviewSection" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="totalRecords">0</div>
                            <div class="stat-label">Total Records</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <i class="fas fa-temperature-high"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="avgTemperature">-¬∞C</div>
                            <div class="stat-label">Avg Temperature</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="avgHumidity">-%</div>
                            <div class="stat-label">Avg Humidity</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            <i class="fas fa-cloud-rain"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="totalRainfall">- mm</div>
                            <div class="stat-label">Total Rainfall</div>
                        </div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Temperature Trends (Last 30 Days)</h3>
                            <div class="chart-actions">
                                <button class="chart-btn" onclick="refreshChart('temperatureChart')">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="temperatureChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Humidity & Rainfall Distribution</h3>
                            <div class="chart-actions">
                                <button class="chart-btn" onclick="refreshChart('humidityRainfallChart')">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="humidityRainfallChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Weather Conditions Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="conditionsChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Data Sources</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="dataSourceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Weather Section -->
            <div id="currentSection" class="content-section">
                <div class="section-header">
                    <h2>Current Weather Conditions</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="loadCurrentWeather()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <div id="currentWeatherGrid" class="weather-grid"></div>
            </div>

            <!-- Historical Data Section -->
            <div id="historicalSection" class="content-section">
                <div class="section-header">
                    <h2>Historical Weather Data</h2>
                    <div class="section-actions">
                        <input type="date" id="startDate" class="date-input">
                        <input type="date" id="endDate" class="date-input">
                        <button class="btn btn-primary" onclick="loadHistoricalData()">
                            <i class="fas fa-search"></i>
                            Search
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="historicalTable">
                        <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Location</th>
                            <th>Temperature</th>
                            <th>Humidity</th>
                            <th>Rainfall</th>
                            <th>Wind Speed</th>
                            <th>Condition</th>
                            <th>Quality</th>
                        </tr>
                        </thead>
                        <tbody id="historicalTableBody">
                        <tr>
                            <td colspan="8" class="empty-state">
                                <i class="fas fa-info-circle"></i>
                                <p>Select date range to view historical data</p>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="pagination" id="historicalPagination"></div>
            </div>

            <!-- AI Predictions Section -->
            <div id="predictionsSection" class="content-section">
                <div class="section-header">
                    <h2>AI Weather Predictions for Chad</h2>
                    <div class="section-actions">
                        <select id="predictionDays" class="form-select">
                            <option value="7">7 Days</option>
                            <option value="14">14 Days</option>
                            <option value="30">30 Days</option>
                        </select>
                        <button class="btn btn-primary" onclick="generatePredictions()">
                            <i class="fas fa-brain"></i>
                            Generate Predictions
                        </button>
                    </div>
                </div>

                <div class="prediction-info">
                    <div class="info-card">
                        <i class="fas fa-robot"></i>
                        <div>
                            <h4>AI Model Status</h4>
                            <p id="modelStatus">Ready</p>
                        </div>
                    </div>
                    <div class="info-card">
                        <i class="fas fa-chart-line"></i>
                        <div>
                            <h4>Model Accuracy</h4>
                            <p id="modelAccuracy">Training...</p>
                        </div>
                    </div>
                    <div class="info-card">
                        <i class="fas fa-database"></i>
                        <div>
                            <h4>Training Data</h4>
                            <p id="trainingDataCount">0 records</p>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Temperature Predictions</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="predictionChart"></canvas>
                    </div>
                </div>

                <div id="predictionResults" class="prediction-results"></div>
            </div>

            <!-- Statistics Section -->
            <div id="statisticsSection" class="content-section">
                <div class="section-header">
                    <h2>Weather Statistics</h2>
                    <div class="section-actions">
                        <input type="date" id="statsStartDate" class="date-input">
                        <input type="date" id="statsEndDate" class="date-input">
                        <button class="btn btn-primary" onclick="loadStatistics()">
                            <i class="fas fa-chart-bar"></i>
                            Load Statistics
                        </button>
                    </div>
                </div>

                <div class="stats-summary" id="statsSummary"></div>

                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Temperature Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="tempDistributionChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Humidity Box Plot</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="humidityBoxPlot"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Temperature vs Humidity Scatter Plot</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="scatterPlot"></canvas>
                    </div>
                </div>
            </div>

            <!-- Trends Section -->
            <div id="trendsSection" class="content-section">
                <div class="section-header">
                    <h2>Weather Trends Analysis</h2>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Monthly Temperature Trends</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlyTrendsChart"></canvas>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Daily Average Temperature</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="dailyAvgChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Wind Speed Trends</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="windTrendsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Extreme Weather Section -->
            <div id="extremeSection" class="content-section">
                <div class="section-header">
                    <h2>Extreme Weather Conditions</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="loadExtremeWeather()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <div id="extremeWeatherGrid" class="extreme-grid"></div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Extreme Weather Events Timeline</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="extremeTimelineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Food Security Analysis Section -->
            <div id="foodSecuritySection" class="content-section">
                <div class="section-header">
                    <h2>Food Security Risk Analysis</h2>
                    <div class="section-actions">
                        <select id="securityDays" class="form-select">
                            <option value="7">Last 7 Days</option>
                            <option value="14">Last 14 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="60">Last 60 Days</option>
                        </select>
                        <button class="btn btn-primary" onclick="analyzeFoodSecurity()">
                            <i class="fas fa-exclamation-triangle"></i>
                            Analyze Risk
                        </button>
                    </div>
                </div>

                <!-- Overall Risk Card -->
                <div class="chart-card" style="margin-bottom: 32px;">
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="font-size: 18px; color: var(--text-secondary); margin-bottom: 20px;">
                            Overall Food Security Risk
                        </h3>
                        <div id="overallRiskScore" class="quality-score" style="font-size: 72px; margin: 20px 0;">
                            --
                        </div>
                        <div id="riskLevelBadge" style="display: inline-block; padding: 10px 24px; border-radius: 20px; font-weight: 600; font-size: 16px; text-transform: uppercase;">
                            Analyzing...
                        </div>
                    </div>
                </div>

                <!-- Risk Breakdown -->
                <div class="stats-grid" style="margin-bottom: 32px;">
                    <div class="stat-card" id="droughtRiskCard">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-sun"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="droughtRiskScore">--</div>
                            <div class="stat-label">Drought Risk</div>
                        </div>
                    </div>

                    <div class="stat-card" id="floodRiskCard">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            <i class="fas fa-water"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="floodRiskScore">--</div>
                            <div class="stat-label">Flood Risk</div>
                        </div>
                    </div>

                    <div class="stat-card" id="heatStressCard">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <i class="fas fa-temperature-high"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="heatStressScore">--</div>
                            <div class="stat-label">Heat Stress</div>
                        </div>
                    </div>

                    <div class="stat-card" id="cropConditionCard">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="cropConditionScore">--</div>
                            <div class="stat-label">Crop Favorability</div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analysis Cards -->
                <div class="charts-row" style="margin-bottom: 32px;">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Drought Analysis</h3>
                        </div>
                        <div id="droughtDetails" style="padding: 20px;">
                            <p style="text-align: center; color: var(--text-secondary);">
                                Click "Analyze Risk" to view details
                            </p>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Flood Risk Analysis</h3>
                        </div>
                        <div id="floodDetails" style="padding: 20px;">
                            <p style="text-align: center; color: var(--text-secondary);">
                                Click "Analyze Risk" to view details
                            </p>
                        </div>
                    </div>
                </div>

                <div class="charts-row" style="margin-bottom: 32px;">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Heat Stress Analysis</h3>
                        </div>
                        <div id="heatStressDetails" style="padding: 20px;">
                            <p style="text-align: center; color: var(--text-secondary);">
                                Click "Analyze Risk" to view details
                            </p>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Crop Conditions</h3>
                        </div>
                        <div id="cropConditionDetails" style="padding: 20px;">
                            <p style="text-align: center; color: var(--text-secondary);">
                                Click "Analyze Risk" to view details
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Active Food Security Alerts -->
                <div class="chart-card" style="margin-bottom: 32px;">
                    <div class="chart-header">
                        <h3 class="chart-title">Active Food Security Alerts</h3>
                        <button class="chart-btn" onclick="loadFoodSecurityAlerts()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div id="foodSecurityAlertsGrid" class="food-alerts-grid"></div>
                </div>

                <!-- Recommendations -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i class="fas fa-lightbulb"></i>
                            Recommendations
                        </h3>
                    </div>
                    <div id="securityRecommendations" style="padding: 20px;">
                        <p style="text-align: center; color: var(--text-secondary);">
                            Recommendations will appear after analysis
                        </p>
                    </div>
                </div>

                <!-- Historical Risk Trend Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Risk Trend Over Time</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="riskTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Weather Alerts Section -->
            <div id="alertsSection" class="content-section">
                <div class="section-header">
                    <h2>Weather Alerts & Warnings</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="checkWeatherAlerts()">
                            <i class="fas fa-bell"></i>
                            Check Alerts
                        </button>
                    </div>
                </div>

                <div id="activeAlertsGrid" class="extreme-grid"></div>

                <div class="chart-card" style="margin-top: 32px;">
                    <div class="chart-header">
                        <h3 class="chart-title">Alert Timeline</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="alertTimelineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="content-section">
                <div class="section-header">
                    <h2>Generate Reports</h2>
                </div>

                <div class="report-config">
                    <div class="form-group">
                        <label class="form-label">Report Type</label>
                        <select id="reportType" class="form-select">
                            <option value="summary">Weather Summary</option>
                            <option value="detailed">Detailed Analysis</option>
                            <option value="trends">Trends Report</option>
                            <option value="extreme">Extreme Weather Report</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Date Range</label>
                        <div class="date-range">
                            <input type="date" id="reportStartDate" class="date-input">
                            <span>to</span>
                            <input type="date" id="reportEndDate" class="date-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Format</label>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="generatePDFReport()">
                                <i class="fas fa-file-pdf"></i>
                                Generate PDF
                            </button>
                            <button class="btn btn-success" onclick="generateExcelReport()">
                                <i class="fas fa-file-excel"></i>
                                Generate Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Quality Section -->
            <div id="qualitySection" class="content-section">
                <div class="section-header">
                    <h2>Data Quality Analysis</h2>
                </div>

                <div class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Data Quality Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="qualityDistributionChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Quality by Data Source</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="qualityBySourceChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="qualityMetrics" class="quality-metrics"></div>
            </div>



            <!-- CRUD Management Section -->
            <div id="crudSection" class="content-section">
                <div class="section-header">
                    <h2>Weather Data Management</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" onclick="showAddWeatherModal()">
                            <i class="fas fa-plus"></i>
                            Add New Record
                        </button>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="chart-card" style="margin-bottom: 20px;">
                    <div class="chart-header">
                        <h3 class="chart-title">Filter Records</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; padding: 10px 0;">
                        <input type="text" id="searchFilter" class="date-input" placeholder="Search by condition...">
                        <select id="sourceFilter" class="form-select">
                            <option value="">All Sources</option>
                            <option value="API">API</option>
                            <option value="STATION">Station</option>
                            <option value="SATELLITE">Satellite</option>
                        </select>
                        <select id="qualityFilter" class="form-select">
                            <option value="">All Quality</option>
                            <option value="EXCELLENT">Excellent</option>
                            <option value="GOOD">Good</option>
                            <option value="FAIR">Fair</option>
                            <option value="POOR">Poor</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadCrudData()">
                            <i class="fas fa-filter"></i>
                            Apply Filters
                        </button>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="table-container">
                    <table class="data-table" id="crudTable">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date/Time</th>
                            <th>Location</th>
                            <th>Temperature</th>
                            <th>Humidity</th>
                            <th>Rainfall</th>
                            <th>Wind Speed</th>
                            <th>Condition</th>
                            <th>Source</th>
                            <th>Quality</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="crudTableBody">
                        <tr>
                            <td colspan="11" class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>No weather data found</p>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="pagination" id="crudPagination">
                    <button class="pagination-btn" onclick="changePage('prev')">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="pageInfo" style="margin: 0 16px; color: var(--text-secondary);">Page 1</span>
                    <button class="pagination-btn" onclick="changePage('next')">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Modal for Add/Edit Weather Data -->
            <div id="weatherModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modalTitle" class="modal-title">Add Weather Data</h2>
                        <button onclick="closeWeatherModal()" class="modal-close" title="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <form id="weatherForm" onsubmit="saveWeatherData(event)" class="form-grid">
                        <input type="hidden" id="weatherId">

                        <div class="form-group">
                            <label class="form-label">Latitude *</label>
                            <input type="number" id="weatherLatitude" class="date-input" step="0.000001" min="-90" max="90" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Longitude *</label>
                            <input type="number" id="weatherLongitude" class="date-input" step="0.000001" min="-180" max="180" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Temperature (¬∞C) *</label>
                            <input type="number" id="weatherTemperature" class="date-input" step="0.1" min="-50" max="60" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Humidity (%)</label>
                            <input type="number" id="weatherHumidity" class="date-input" step="0.1" min="0" max="100">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Rainfall (mm)</label>
                            <input type="number" id="weatherRainfall" class="date-input" step="0.01" min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Wind Speed (m/s)</label>
                            <input type="number" id="weatherWindSpeed" class="date-input" step="0.1" min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Wind Direction (¬∞)</label>
                            <input type="number" id="weatherWindDirection" class="date-input" min="0" max="360">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Weather Condition</label>
                            <select id="weatherCondition" class="form-select">
                                <option value="">Select condition</option>
                                <option value="SUNNY">Sunny</option>
                                <option value="PARTLY_CLOUDY">Partly Cloudy</option>
                                <option value="CLOUDY">Cloudy</option>
                                <option value="OVERCAST">Overcast</option>
                                <option value="LIGHT_RAIN">Light Rain</option>
                                <option value="RAIN">Rain</option>
                                <option value="HEAVY_RAIN">Heavy Rain</option>
                                <option value="THUNDERSTORM">Thunderstorm</option>
                                <option value="SNOW">Snow</option>
                                <option value="FOG">Fog</option>
                                <option value="WINDY">Windy</option>
                                <option value="HAIL">Hail</option>
                                <option value="DRIZZLE">Drizzle</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Atmospheric Pressure (hPa)</label>
                            <input type="number" id="weatherPressure" class="date-input" step="0.01" min="800" max="1200">
                        </div>

                        <div class="form-group">
                            <label class="form-label">UV Index</label>
                            <input type="number" id="weatherUvIndex" class="date-input" min="0" max="15">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Data Source *</label>
                            <select id="weatherDataSource" class="form-select" required>
                                <option value="">Select source</option>
                                <option value="API">API</option>
                                <option value="STATION">Station</option>
                                <option value="SATELLITE">Satellite</option>
                                <option value="MANUAL">Manual Entry</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Data Quality</label>
                            <select id="weatherQuality" class="form-select">
                                <option value="EXCELLENT">Excellent</option>
                                <option value="GOOD" selected>Good</option>
                                <option value="FAIR">Fair</option>
                                <option value="POOR">Poor</option>
                            </select>
                        </div>

                        <div class="button-group full-width" style="margin-top: 16px;">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                            <button type="button" class="btn" onclick="closeWeatherModal()" style="background: var(--bg-secondary);">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
</div>







<script src="js/SessionTracker.js"></script>
<script src="js/user_session_handler.js"></script>

<script src="js/Notification.js"></script>
<script >


    function formatISODateTime(date) {
        // Enl√®ve les millisecondes ET le 'Z' √† la fin
        return date.toISOString().split('.')[0];
    }

    function normalizeApiArray(raw) {
        if (Array.isArray(raw)) return raw;
        if (raw && Array.isArray(raw.data)) return raw.data;
        if (raw && Array.isArray(raw.content)) return raw.content;
        return [];
    }

    function getRecordDate(item) {
        return item?.recordDate || item?.timestamp || item?.createdAt || item?.date || null;
    }

    function loadImageAsDataUrl(src) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg'));
                } catch (err) {
                    reject(err);
                }
            };
            img.onerror = reject;
            img.src = src;
        });
    }


            // Weather Dashboard JavaScript
        // API Configuration
        const API_BASE_URL = 'http://localhost:1010/api/weather-data';
        const CHAD_COORDINATES = {
            latitude: 15.4542,
            longitude: 18.7322
        };

        // Global Variables
        let currentUser = null;
        let sessionHandler = null;
        let weatherData = [];
        let charts = {};
        let predictionModel = null;
        let trainingData = [];
        let historicalDataCache = [];
        let historicalPage = 1;
        const historicalPageSize = 10;
        const PREDICTION_MIN_RECORDS = 5;

        // ==================== INITIALIZATION ====================

        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            try {
                showLoading(true);

                // Initialize session
                if (!initializeSession()) {
                    return;
                }

                // Setup event listeners
                setupEventListeners();

                // Load initial data
                await loadDashboardData();

                // Update date/time
                updateDateTime();
                setInterval(updateDateTime, 60000);

                // Load theme
                loadTheme();

                showToast('Dashboard loaded successfully', 'success');
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Error initializing dashboard', 'error');
            } finally {
                showLoading(false);
            }
        }

        function initializeSession() {
            try {
                sessionHandler = UserSessionHandler.getInstance();
                currentUser = sessionHandler.getCurrentUser();

                if (!currentUser) {
                    window.location.href = '/login.html';
                    return false;
                }

                updateUserProfile();
                startSessionMonitoring();
                return true;
            } catch (error) {
                console.error('Session initialization error:', error);
                window.location.href = '/login.html';
                return false;
            }
        }

        function updateUserProfile() {
            if (!currentUser) return;

            const profileName = document.getElementById('profileName');
            const profileAvatar = document.getElementById('profileAvatar');

            if (profileName) {
                profileName.textContent = currentUser.fullName || 'User';
            }

            if (profileAvatar && currentUser.fullName) {
                const initials = currentUser.fullName
                    .split(' ')
                    .map(n => n[0])
                    .join('')
                    .toUpperCase();
                profileAvatar.textContent = initials;
            }
        }

        function startSessionMonitoring() {
            setInterval(() => {
                if (sessionHandler && !sessionHandler.isAuthenticated()) {
                    showToast('Session expired. Redirecting to login...', 'warning');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                }
            }, 30000);
        }

        function setupEventListeners() {
            // Sidebar toggle
            document.getElementById('sidebarToggle')?.addEventListener('click', toggleSidebar);

            // Theme toggle
            document.getElementById('themeToggle')?.addEventListener('click', toggleTheme);

            // Refresh button
            document.getElementById('refreshBtn')?.addEventListener('click', () => {
                loadDashboardData();
            });

            // Navigation links
// Remplacez cette partie dans setupEventListeners()
document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function(e) {
        const section = this.getAttribute('data-section');
        const href = this.getAttribute('href');

        // ‚úÖ Ne bloquer que si c'est une navigation interne
        if (section && !href) {
            e.preventDefault();
            showSection(section);
        } else if (section && href && href.startsWith('#')) {
            e.preventDefault();
            showSection(section);
        }
        // ‚úÖ Laisser les vrais liens href fonctionner normalement
    });
});

            // Location filter
            document.getElementById('locationFilter')?.addEventListener('change', handleLocationFilter);
        }

        // ==================== DATA LOADING ====================

        async function loadDashboardData() {
            try {
                showLoading(true);

                await Promise.all([
                    loadOverviewData(),
                    loadLocations(),
                    loadWeatherStatistics()
                ]);

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Error loading dashboard data', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadOverviewData() {
            try {
                // Get total records count
                const countResponse = await fetch(`${API_BASE_URL}/count`);
                const countData = await countResponse.json();
                document.getElementById('totalRecords').textContent = countData.count || 0;

                // Get recent data for overview charts
        const recentResponse = await fetch(`${API_BASE_URL}/recent?days=30`);
        const recentRaw = await recentResponse.json();
        weatherData = normalizeApiArray(recentRaw);

                // Calculate averages
                if (weatherData.length > 0) {
                    const avgTemp = calculateAverage(weatherData, 'temperature');
                    const avgHumidity = calculateAverage(weatherData, 'humidity');
                    const totalRain = calculateSum(weatherData, 'rainfall');

                    document.getElementById('avgTemperature').textContent = formatMetric(avgTemp, '¬∞C', 1, '0¬∞C');
                    document.getElementById('avgHumidity').textContent = formatMetric(avgHumidity, '%', 1, '0%');
                    document.getElementById('totalRainfall').textContent = formatMetric(totalRain, ' mm', 1, '0 mm');
                } else {
                    document.getElementById('avgTemperature').textContent = '0¬∞C';
                    document.getElementById('avgHumidity').textContent = '0%';
                    document.getElementById('totalRainfall').textContent = '0 mm';
                }

                // Initialize overview charts
                initializeOverviewCharts();

            } catch (error) {
                console.error('Error loading overview data:', error);
                throw error;
            }
        }

        async function loadLocations() {
            try {
        const response = await fetch(`${API_BASE_URL}/location-averages`);
        const locationsRaw = await response.json();
        const locations = normalizeApiArray(locationsRaw);

                const locationFilter = document.getElementById('locationFilter');
                if (locationFilter) {
                    locationFilter.innerHTML = '<option value="">All Locations</option>';

                    locations.forEach(loc => {
                        const option = document.createElement('option');
                        option.value = `${loc.latitude},${loc.longitude}`;
                        option.textContent = `Location (${loc.latitude.toFixed(4)}, ${loc.longitude.toFixed(4)})`;
                        locationFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }



        async function loadWeatherStatistics() {
            try {
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 30);

                // Format ISO sans millisecondes
                const startISO = startDate.toISOString().split('.')[0];
                const endISO = endDate.toISOString().split('.')[0];

                const response = await fetch(
                    `${API_BASE_URL}/analytics/statistics?startDate=${startISO}&endDate=${endISO}`
                );
                const statsRaw = await response.json();
                const stats = statsRaw?.data || statsRaw;

                // Store statistics for later use
                window.weatherStats = stats;

            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }





        // ==================== CHART INITIALIZATION ====================

        function initializeOverviewCharts() {
            initializeTemperatureChart();
            initializeHumidityRainfallChart();
            initializeConditionsChart();
            initializeDataSourceChart();
        }

        function initializeTemperatureChart() {
            const ctx = document.getElementById('temperatureChart');
            if (!ctx) return;

            if (charts.temperature) {
                charts.temperature.destroy();
            }

            const sortedData = [...weatherData].sort((a, b) =>
                new Date(a.recordDate) - new Date(b.recordDate)
            );

            const labels = sortedData.map(d => formatDate(d.recordDate));
            const temperatures = sortedData.map(d => d.temperature);
            const tempMin = sortedData.map(d => d.temperatureMin || d.temperature);
            const tempMax = sortedData.map(d => d.temperatureMax || d.temperature);

            charts.temperature = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Temperature',
                            data: temperatures,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Min Temperature',
                            data: tempMin,
                            borderColor: '#3b82f6',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.4
                        },
                        {
                            label: 'Max Temperature',
                            data: tempMax,
                            borderColor: '#f59e0b',
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return value + '¬∞C';
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializeHumidityRainfallChart() {
            const ctx = document.getElementById('humidityRainfallChart');
            if (!ctx) return;

            if (charts.humidityRainfall) {
                charts.humidityRainfall.destroy();
            }

            const sortedData = [...weatherData].sort((a, b) =>
                new Date(a.recordDate) - new Date(b.recordDate)
            );

            const labels = sortedData.map(d => formatDate(d.recordDate));
            const humidity = sortedData.map(d => d.humidity);
            const rainfall = sortedData.map(d => d.rainfall);

            charts.humidityRainfall = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Humidity (%)',
                            data: humidity,
                            backgroundColor: 'rgba(6, 182, 212, 0.7)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Rainfall (mm)',
                            data: rainfall,
                            backgroundColor: 'rgba(139, 92, 246, 0.7)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Humidity (%)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Rainfall (mm)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        async function initializeConditionsChart() {
            const ctx = document.getElementById('conditionsChart');
            if (!ctx) return;

            if (charts.conditions) {
                charts.conditions.destroy();
            }

            try {
                const response = await fetch(`${API_BASE_URL}/analytics/weather-condition-stats`);
                const conditionStats = await response.json();

                const labels = Object.keys(conditionStats);
                const data = Object.values(conditionStats);

                charts.conditions = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#3b82f6',
                                '#10b981',
                                '#f59e0b',
                                '#ef4444',
                                '#8b5cf6',
                                '#06b6d4'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading conditions chart:', error);
            }
        }

        async function initializeDataSourceChart() {
            const ctx = document.getElementById('dataSourceChart');
            if (!ctx) return;

            if (charts.dataSource) {
                charts.dataSource.destroy();
            }

            try {
                const response = await fetch(`${API_BASE_URL}/analytics/data-source-stats`);
                const sourceStats = await response.json();

                const labels = Object.keys(sourceStats);
                const data = Object.values(sourceStats);

                charts.dataSource = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#3b82f6',
                                '#10b981',
                                '#f59e0b'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading data source chart:', error);
            }
        }

        // ==================== CURRENT WEATHER ====================

        async function loadCurrentWeather() {
            try {
                showLoading(true);

            const response = await fetch(`${API_BASE_URL}/recent?days=1`);
            const currentRaw = await response.json();

                const weatherGrid = document.getElementById('currentWeatherGrid');
                if (!weatherGrid) return;

            let cleanData = normalizeApiArray(currentRaw)
                .filter(d => d && getRecordDate(d));

            if (cleanData.length === 0) {
                const fallbackResponse = await fetch(`${API_BASE_URL}/recent?days=7`);
                const fallbackRaw = await fallbackResponse.json();
                cleanData = normalizeApiArray(fallbackRaw)
                    .filter(d => d && getRecordDate(d));
            }

                if (cleanData.length === 0) {
                    weatherGrid.innerHTML = '<div class="empty-state"><i class="fas fa-cloud"></i><p>No current weather data available</p></div>';
                    return;
                }

            const sorted = cleanData.sort((a, b) => new Date(getRecordDate(b)) - new Date(getRecordDate(a)));
                const latest = sorted[0];
                const secondary = sorted.slice(1, 6);

                const mainCard = renderCurrentWeatherCard(latest, true);
                const secondaryCards = secondary.length
                    ? secondary.map(item => renderCurrentWeatherCard(item, false)).join('')
                    : '<div class="empty-state"><i class="fas fa-cloud-sun"></i><p>No additional recent records</p></div>';

                weatherGrid.innerHTML = `
                    <div class="current-weather-grid">
                        ${mainCard}
                        <div class="current-subgrid">
                            ${secondaryCards}
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading current weather:', error);
                showToast('Error loading current weather', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderCurrentWeatherCard(weather, isMain) {
            const condition = formatCondition(weather.weatherCondition);
            const isRainy = isRainCondition(weather.weatherCondition, weather.rainfall);
            const cardClass = `weather-card ${isMain ? 'current-main-card' : ''} ${isRainy ? 'rainy' : ''}`;
            const temp = formatMetric(weather.temperature, '¬∞C');
            const humidity = formatMetric(weather.humidity, '%');
            const wind = formatMetric(weather.windSpeed, ' m/s');
            const rainfall = formatMetric(weather.rainfall, ' mm', 1, '0 mm');
            const pressure = formatMetric(weather.atmosphericPressure, ' hPa');
            const uvIndex = formatMetric(weather.uvIndex, '');
            const lat = weather.latitude != null ? weather.latitude.toFixed(4) : 'N/A';
            const lon = weather.longitude != null ? weather.longitude.toFixed(4) : 'N/A';

            const recordDate = getRecordDate(weather);
            return `
                <div class="${cardClass}">
                    <div class="weather-card-header">
                        <div>
                            <div class="weather-icon">${getWeatherIcon(weather.weatherCondition)}</div>
                            <div class="weather-condition">${condition}</div>
                            <div class="weather-timestamp">${formatDateTime(recordDate)}</div>
                        </div>
                        <div class="weather-temp">${temp}</div>
                    </div>
                    <div class="weather-details">
                        <div class="weather-detail"><i class="fas fa-tint"></i><span>${humidity} Humidity</span></div>
                        <div class="weather-detail"><i class="fas fa-wind"></i><span>${wind}</span></div>
                        <div class="weather-detail"><i class="fas fa-cloud-rain"></i><span>${rainfall}</span></div>
                        <div class="weather-detail"><i class="fas fa-compress-arrows-alt"></i><span>${pressure}</span></div>
                        <div class="weather-detail"><i class="fas fa-sun"></i><span>UV ${uvIndex}</span></div>
                        <div class="weather-detail"><i class="fas fa-map-marker-alt"></i><span>${lat}, ${lon}</span></div>
                    </div>
                </div>
            `;
        }

        // ==================== HISTORICAL DATA ====================



        async function loadHistoricalData() {
    try {
        showLoading(true);

        const startDate = document.getElementById('startDate')?.value;
        const endDate = document.getElementById('endDate')?.value;

        if (!startDate || !endDate) {
            showToast('Please select both start and end dates', 'warning');
            return;
        }

        // CORRECTION ICI
        const startDateTime = formatISODateTime(new Date(startDate + 'T00:00:00'));
        const endDateTime = formatISODateTime(new Date(endDate + 'T23:59:59'));

        const response = await fetch(
            `${API_BASE_URL}/date-range?startDate=${startDateTime}&endDate=${endDateTime}`
        );
        const historicalRaw = await response.json();
        historicalDataCache = normalizeApiArray(historicalRaw);
        historicalPage = 1;
        renderHistoricalPage();

    } catch (error) {
        console.error('Error loading historical data:', error);
        showToast('Error loading historical data', 'error');
    } finally {
        showLoading(false);
    }
}






        function renderHistoricalTable(data) {
            const tbody = document.getElementById('historicalTableBody');
            if (!tbody) return;

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fas fa-inbox"></i><p>No historical data found</p></td></tr>';
                return;
            }

            tbody.innerHTML = data.map(weather => `
                <tr>
                    <td>${formatDateTime(getRecordDate(weather))}</td>
                    <td>${weather.latitude?.toFixed(4)}, ${weather.longitude?.toFixed(4)}</td>
                    <td>${formatMetric(weather.temperature, '¬∞C')}</td>
                    <td>${formatMetric(weather.humidity, '%')}</td>
                    <td>${formatMetric(weather.rainfall, ' mm', 1, '0 mm')}</td>
                    <td>${formatMetric(weather.windSpeed, ' m/s')}</td>
                    <td>${weather.weatherCondition || 'N/A'}</td>
                    <td><span class="badge badge-${weather.dataQuality?.toLowerCase()}">${weather.dataQuality || 'N/A'}</span></td>
                </tr>
            `).join('');
        }

        function renderHistoricalPage() {
            const total = historicalDataCache.length;
            if (total === 0) {
                renderHistoricalTable([]);
                renderHistoricalPagination(0);
                return;
            }

            const start = (historicalPage - 1) * historicalPageSize;
            const pageData = historicalDataCache.slice(start, start + historicalPageSize);
            renderHistoricalTable(pageData);
            renderHistoricalPagination(Math.ceil(total / historicalPageSize));
        }

        function renderHistoricalPagination(totalPages) {
            const pagination = document.getElementById('historicalPagination');
            if (!pagination) return;

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            const prevDisabled = historicalPage === 1 ? 'disabled' : '';
            const nextDisabled = historicalPage === totalPages ? 'disabled' : '';

            pagination.innerHTML = `
                <button class="pagination-btn" ${prevDisabled} onclick="changeHistoricalPage(${historicalPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span class="pagination-info">Page ${historicalPage} of ${totalPages}</span>
                <button class="pagination-btn" ${nextDisabled} onclick="changeHistoricalPage(${historicalPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
        }

        function changeHistoricalPage(page) {
            const totalPages = Math.ceil(historicalDataCache.length / historicalPageSize);
            if (page < 1 || page > totalPages) return;
            historicalPage = page;
            renderHistoricalPage();
        }

        // ==================== HELPER FUNCTIONS ====================

        function calculateAverage(data, field) {
            const values = data.filter(d => d[field] != null).map(d => parseFloat(d[field]));
            if (values.length === 0) return 0;
            return values.reduce((a, b) => a + b, 0) / values.length;
        }

        function calculateSum(data, field) {
            return data.filter(d => d[field] != null).map(d => parseFloat(d[field])).reduce((a, b) => a + b, 0);
        }

        function hasValidStats(stats) {
            if (!stats) return false;
        const normalized = normalizeStats(stats);
        const values = [
            normalized.avgTemperature,
            normalized.maxTemperature,
            normalized.minTemperature,
            normalized.avgHumidity,
            normalized.totalRainfall,
            normalized.avgWindSpeed
        ];
            return values.some(v => v != null && !isNaN(parseFloat(v)));
        }

    function normalizeStats(stats) {
        if (!stats) return {};
        return {
            avgTemperature: stats.avgTemperature ?? stats.avgTemp ?? stats.averageTemperature,
            maxTemperature: stats.maxTemperature ?? stats.maxTemp ?? stats.maximumTemperature,
            minTemperature: stats.minTemperature ?? stats.minTemp ?? stats.minimumTemperature,
            avgHumidity: stats.avgHumidity ?? stats.averageHumidity,
            totalRainfall: stats.totalRainfall ?? stats.rainfallTotal,
            avgWindSpeed: stats.avgWindSpeed ?? stats.averageWindSpeed
        };
    }

        function computeStatsFromRecords(records) {
            if (!records || records.length === 0) {
                return null;
            }
            const temps = records.map(r => parseFloat(r.temperature)).filter(v => !isNaN(v));
            return {
                avgTemperature: calculateAverage(records, 'temperature'),
                maxTemperature: temps.length ? Math.max(...temps) : null,
                minTemperature: temps.length ? Math.min(...temps) : null,
                avgHumidity: calculateAverage(records, 'humidity'),
                totalRainfall: calculateSum(records, 'rainfall'),
                avgWindSpeed: calculateAverage(records, 'windSpeed')
            };
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'N/A';
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getWeatherIcon(condition) {
            const icons = {
                'SUNNY': '‚òÄÔ∏è',
                'PARTLY_CLOUDY': '‚õÖ',
                'CLOUDY': '‚òÅÔ∏è',
                'OVERCAST': '‚òÅÔ∏è',
                'LIGHT_RAIN': 'üå¶Ô∏è',
                'RAIN': 'üåßÔ∏è',
                'HEAVY_RAIN': '‚õàÔ∏è',
                'THUNDERSTORM': '‚õàÔ∏è',
                'SNOW': '‚ùÑÔ∏è',
                'FOG': 'üå´Ô∏è',
                'WINDY': 'üí®',
                'HAIL': 'üå®Ô∏è',
                'DRIZZLE': 'üå¶Ô∏è'
            };
            return icons[condition] || 'üå§Ô∏è';
        }

        function formatCondition(condition) {
            if (!condition) return 'Unknown';
            return condition
                .toString()
                .toLowerCase()
                .replace(/_/g, ' ')
                .replace(/\b\w/g, c => c.toUpperCase());
        }

        function isRainCondition(condition, rainfall) {
            const cond = (condition || '').toString().toUpperCase();
            return cond.includes('RAIN') || cond.includes('THUNDER') || parseFloat(rainfall || 0) > 0;
        }

        function deriveWeatherCondition(temp, humidity, rainfall) {
            const t = parseFloat(temp);
            const h = parseFloat(humidity);
            const r = parseFloat(rainfall);

            if (!isNaN(r) && r >= 10) return 'HEAVY_RAIN';
            if (!isNaN(r) && r >= 2) return 'RAIN';
            if (!isNaN(r) && r > 0) return 'LIGHT_RAIN';
            if (!isNaN(h) && h >= 85) return 'OVERCAST';
            if (!isNaN(h) && h >= 70) return 'CLOUDY';
            if (!isNaN(t) && t >= 35) return 'SUNNY';
            if (!isNaN(t) && t <= 10) return 'FOG';
            return 'PARTLY_CLOUDY';
        }

        function formatMetric(value, suffix = '', decimals = 1, fallback = 'N/A') {
            if (value == null || value === '' || isNaN(parseFloat(value))) {
                return fallback;
            }
            const num = Number(value);
            const formatted = Number.isFinite(num) ? num.toFixed(decimals) : value;
            return `${formatted}${suffix}`;
        }

        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            const section = document.getElementById(sectionName + 'Section');
            if (section) {
                section.classList.add('active');
            }

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const activeLink = document.querySelector(`.nav-link[data-section="${sectionName}"]`);
            if (activeLink) {
                activeLink.closest('.nav-item').classList.add('active');
            }

            // Load section-specific data
            loadSectionData(sectionName);
        }





    // Ajoutez ce case dans la fonction loadSectionData existante
    async function loadSectionData(sectionName) {
        switch(sectionName) {
            case 'current':
                await loadCurrentWeather();
                break;
            case 'predictions':
                await initializePredictions();
                break;
            case 'statistics':
                await loadStatisticsSection();
                break;
            case 'trends':
                await loadTrendsSection();
                break;
            case 'extreme':
                await loadExtremeWeather();
                break;
            case 'quality':
                await loadDataQuality();
                break;
            case 'crud':  // AJOUTEZ CETTE LIGNE
                await loadCrudData();
                break;
        }
    }





        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('collapsed');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');

            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            }

            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                }
            }
        }

        function updateDateTime() {
            const now = new Date();
            const dateElement = document.getElementById('currentDate');

            if (dateElement) {
                dateElement.textContent = now.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }

        function handleLocationFilter(event) {
            const value = event.target.value;
            if (value) {
                const [lat, lon] = value.split(',');
                loadLocationSpecificData(parseFloat(lat), parseFloat(lon));
            } else {
                loadDashboardData();
            }
        }

        async function loadLocationSpecificData(latitude, longitude) {
            try {
                showLoading(true);

                const response = await fetch(
                    `${API_BASE_URL}/location/latest?latitude=${latitude}&longitude=${longitude}&limit=30`
                );
                weatherData = await response.json();

                initializeOverviewCharts();

            } catch (error) {
                console.error('Error loading location data:', error);
                showToast('Error loading location data', 'error');
            } finally {
                showLoading(false);
            }
        }

        function refreshChart(chartName) {
            switch(chartName) {
                case 'temperatureChart':
                    initializeTemperatureChart();
                    break;
                case 'humidityRainfallChart':
                    initializeHumidityRainfallChart();
                    break;
            }
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.toggle('show', show);
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<p>${message}</p>`;

            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function setChartEmptyState(canvasId, message) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const container = canvas.parentElement;
            if (!container) return;
            let empty = container.querySelector('.chart-empty');
            if (!empty) {
                empty = document.createElement('div');
                empty.className = 'chart-empty';
                container.appendChild(empty);
            }
            empty.textContent = message;
            canvas.style.display = 'none';
        }

        function clearChartEmptyState(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const container = canvas.parentElement;
            if (!container) return;
            const empty = container.querySelector('.chart-empty');
            if (empty) empty.remove();
            canvas.style.display = '';
        }




// ==================== IMPROVED AI PREDICTIONS ====================

async function initializePredictions() {
    try {
        showLoading(true);

        // Load training data
        await loadTrainingData();

        const dataCount = trainingData.length;
        document.getElementById('trainingDataCount').textContent = `${dataCount} records`;

        if (dataCount < PREDICTION_MIN_RECORDS) {
            document.getElementById('modelStatus').textContent = 'Insufficient Data';
            document.getElementById('modelAccuracy').textContent = 'N/A';

            const resultsContainer = document.getElementById('predictionResults');
            if (resultsContainer) {
                resultsContainer.innerHTML = `
                    <div class="empty-state prediction-empty">
                        <i class="fas fa-info-circle"></i>
                        <h3>Insufficient Training Data</h3>
                        <p>At least ${PREDICTION_MIN_RECORDS} weather records are needed for predictions.</p>
                        <p>Current records: <strong>${dataCount}</strong></p>
                        <p>Please add more weather data to enable AI predictions.</p>
                    </div>
                `;
            }

            showToast(`Need at least ${PREDICTION_MIN_RECORDS} records for predictions. Currently: ${dataCount}`, 'info');
            return;
        }

        document.getElementById('modelStatus').textContent = 'Training model...';
        await trainPredictionModel();
        document.getElementById('modelStatus').textContent = 'Ready';

        showToast('Prediction model ready!', 'success');

    } catch (error) {
        console.error('Error initializing predictions:', error);
        document.getElementById('modelStatus').textContent = 'Error';
        document.getElementById('modelAccuracy').textContent = 'N/A';
        showToast('Error initializing predictions', 'error');
    } finally {
        showLoading(false);
    }
}

async function loadTrainingData() {
    try {
        console.log('Loading training data...');

        // Try to get recent comprehensive data
        let response = await fetch(`${API_BASE_URL}/recent?days=90`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const trainingRaw = await response.json();
        trainingData = normalizeApiArray(trainingRaw);
        console.log('Training data loaded:', trainingData.length, 'records');

        // Filter and clean data
        trainingData = trainingData
            .filter(d => d.temperature != null && !isNaN(parseFloat(d.temperature)))
            .filter(d => d.recordDate != null)
            .sort((a, b) => new Date(a.recordDate) - new Date(b.recordDate));

        console.log('Cleaned training data:', trainingData.length, 'records');

        return trainingData;

    } catch (error) {
        console.error('Error loading training data:', error);
        trainingData = [];
        throw error;
    }
}

async function trainPredictionModel() {
    try {
        const minRequiredRecords = PREDICTION_MIN_RECORDS;

        if (trainingData.length < minRequiredRecords) {
            throw new Error(`Insufficient training data. Found ${trainingData.length} records, need at least ${minRequiredRecords}.`);
        }

        // Extract features
        const temperatures = trainingData.map(d => parseFloat(d.temperature));
        const humidity = trainingData.map(d => d.humidity ? parseFloat(d.humidity) : 50);
        const rainfall = trainingData.map(d => d.rainfall ? parseFloat(d.rainfall) : 0);

        console.log('Training with', temperatures.length, 'temperature records');

        // Calculate normalization parameters
        const tempMean = temperatures.reduce((a, b) => a + b, 0) / temperatures.length;
        const tempStd = Math.sqrt(
            temperatures.reduce((sq, n) => sq + Math.pow(n - tempMean, 2), 0) / temperatures.length
        );

        const humMean = humidity.reduce((a, b) => a + b, 0) / humidity.length;
        const humStd = Math.sqrt(
            humidity.reduce((sq, n) => sq + Math.pow(n - humMean, 2), 0) / humidity.length
        ) || 1;

        console.log('Normalization params:', { tempMean, tempStd, humMean, humStd });

        if (tempStd === 0 || isNaN(tempStd)) {
            throw new Error('Temperature data has no variance. Cannot train model.');
        }

        // Store normalization parameters
        window.normalizationParams = { tempMean, tempStd, humMean, humStd };

        // Create sequences with multiple features
        const sequenceLength = Math.min(10, Math.floor(temperatures.length / 5));
        const sequences = [];
        const targets = [];

        for (let i = 0; i < temperatures.length - sequenceLength; i++) {
            const sequence = [];

            for (let j = 0; j < sequenceLength; j++) {
                sequence.push(
                    (temperatures[i + j] - tempMean) / tempStd,
                    (humidity[i + j] - humMean) / humStd,
                    rainfall[i + j] / 100  // Normalize rainfall
                );
            }

            sequences.push(sequence);
            targets.push((temperatures[i + sequenceLength] - tempMean) / tempStd);
        }

        console.log('Created', sequences.length, 'sequences with length', sequenceLength);

        if (sequences.length < 20) {
            throw new Error(`Not enough sequences for training. Need at least 20, found ${sequences.length}.`);
        }

        // Build enhanced model
        predictionModel = tf.sequential({
            layers: [
                tf.layers.dense({
                    inputShape: [sequenceLength * 3],
                    units: 64,
                    activation: 'relu',
                    kernelInitializer: 'heNormal'
                }),
                tf.layers.dropout({ rate: 0.2 }),
                tf.layers.dense({ units: 32, activation: 'relu' }),
                tf.layers.dropout({ rate: 0.1 }),
                tf.layers.dense({ units: 16, activation: 'relu' }),
                tf.layers.dense({ units: 1 })
            ]
        });

        predictionModel.compile({
            optimizer: tf.train.adam(0.001),
            loss: 'meanSquaredError',
            metrics: ['mae']
        });

        // Convert to tensors
        const xs = tf.tensor2d(sequences);
        const ys = tf.tensor2d(targets, [targets.length, 1]);

        console.log('Training model...');

        // Train with early stopping
        const batchSize = Math.max(8, Math.min(32, Math.floor(sequences.length / 4)));
        const history = await predictionModel.fit(xs, ys, {
            epochs: 100,
            batchSize: batchSize,
            validationSplit: 0.2,
            verbose: 0,
            callbacks: {
                onEpochEnd: (epoch, logs) => {
                    if (epoch % 10 === 0) {
                        const loss = logs.loss || 0;
                        const valLoss = logs.val_loss || loss;
                        const accuracy = Math.max(0, Math.min(100, (1 - valLoss) * 100));
                        document.getElementById('modelAccuracy').textContent = `${accuracy.toFixed(2)}%`;
                        console.log(`Epoch ${epoch}: loss=${loss.toFixed(4)}, val_loss=${valLoss.toFixed(4)}, accuracy=${accuracy.toFixed(2)}%`);
                    }
                }
            }
        });

        // Clean up tensors
        xs.dispose();
        ys.dispose();

        // Calculate final accuracy
        const finalValLoss = history.history.val_loss[history.history.val_loss.length - 1] || 0;
        const finalAccuracy = Math.max(0, Math.min(100, (1 - finalValLoss) * 100));
        document.getElementById('modelAccuracy').textContent = `${finalAccuracy.toFixed(2)}%`;

        console.log('Model trained successfully. Final accuracy:', finalAccuracy.toFixed(2) + '%');

        // Store sequence length
        window.predictionSequenceLength = sequenceLength;

    } catch (error) {
        console.error('Error training model:', error);
        throw error;
    }
}

async function generatePredictions() {
    try {
        if (!predictionModel) {
            showToast('Please wait for model to initialize', 'warning');
            return;
        }

        if (trainingData.length < PREDICTION_MIN_RECORDS) {
            showToast(`Insufficient training data for predictions. Need at least ${PREDICTION_MIN_RECORDS} records.`, 'error');
            return;
        }

        showLoading(true);

        const days = parseInt(document.getElementById('predictionDays')?.value || 7);
        const sequenceLength = window.predictionSequenceLength || 10;

        // Get recent data
        const recentTemps = trainingData
            .slice(-sequenceLength)
            .map(d => parseFloat(d.temperature));

        const recentHumidity = trainingData
            .slice(-sequenceLength)
            .map(d => d.humidity ? parseFloat(d.humidity) : 50);

        const recentRainfall = trainingData
            .slice(-sequenceLength)
            .map(d => d.rainfall ? parseFloat(d.rainfall) : 0);

        console.log('Generating predictions from', recentTemps.length, 'recent records');

        if (recentTemps.length < sequenceLength) {
            showToast(`Insufficient recent data. Found ${recentTemps.length} records, need ${sequenceLength}.`, 'error');
            return;
        }

        // Get normalization parameters
        const { tempMean, tempStd, humMean, humStd } = window.normalizationParams;

        // Generate predictions
        const predictions = [];
        let currentTemps = [...recentTemps];
        let currentHum = [...recentHumidity];
        let currentRain = [...recentRainfall];

        for (let i = 0; i < days; i++) {
            // Prepare input sequence
            const inputSequence = [];
            for (let j = 0; j < sequenceLength; j++) {
                inputSequence.push(
                    (currentTemps[j] - tempMean) / tempStd,
                    (currentHum[j] - humMean) / humStd,
                    currentRain[j] / 100
                );
            }

            const inputTensor = tf.tensor2d([inputSequence]);
            const predictionTensor = predictionModel.predict(inputTensor);
            const normalizedPred = await predictionTensor.data();

            // Denormalize prediction
            const prediction = normalizedPred[0] * tempStd + tempMean;
            predictions.push(prediction);

            // Update sequences for next prediction
            currentTemps.shift();
            currentTemps.push(prediction);

            // Predict humidity and rainfall based on temperature trend
            const tempTrend = prediction - currentTemps[currentTemps.length - 2];
            const newHum = Math.max(20, Math.min(100,
                currentHum[currentHum.length - 1] - (tempTrend * 2)
            ));
            currentHum.shift();
            currentHum.push(newHum);

            // Rainfall estimate based on humidity and recent average (no random)
            const avgRecentRain = recentRainfall.reduce((a, b) => a + b, 0) / Math.max(1, recentRainfall.length);
            const rainProb = newHum > 70 ? avgRecentRain * 0.7 : avgRecentRain * 0.2;
            currentRain.shift();
            currentRain.push(rainProb);

            // Clean up tensors
            inputTensor.dispose();
            predictionTensor.dispose();
        }

        console.log('Predictions generated:', predictions);

        // Display predictions
        displayPredictions(predictions);
        displayPredictionChart(predictions, recentTemps);

        showToast('Predictions generated successfully', 'success');

    } catch (error) {
        console.error('Error generating predictions:', error);
        showToast('Error generating predictions: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function displayPredictions(predictions) {
    const resultsContainer = document.getElementById('predictionResults');
    if (!resultsContainer) return;

    const today = new Date();

    resultsContainer.innerHTML = predictions.map((pred, index) => {
        const date = new Date(today);
        date.setDate(date.getDate() + index + 1);

        const temp = typeof pred === 'number' ? pred : pred.temperature;
        const humidity = typeof pred === 'number' ? null : pred.humidity;
        const rainfall = typeof pred === 'number' ? null : pred.rainfall;
        const windSpeed = typeof pred === 'number' ? null : pred.windSpeed;
        const condition = typeof pred === 'number' ? null : pred.condition;
        const tempClass = temp > 35 ? 'error' : temp > 30 ? 'warning' : temp > 20 ? 'success' : 'info';

        return `
            <div class="prediction-card">
                <div class="prediction-date">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', weekday: 'short' })}</div>
                <div class="prediction-value" style="color: var(--${tempClass}-color);">${temp.toFixed(1)}¬∞C</div>
                <div class="prediction-meta">
                    <span>${condition ? formatCondition(condition) : getTemperatureDescription(temp)}</span>
                </div>
                <div class="prediction-details">
                    <div><i class="fas fa-tint"></i> ${humidity != null ? humidity.toFixed(0) + '%' : 'N/A'}</div>
                    <div><i class="fas fa-cloud-rain"></i> ${rainfall != null ? rainfall.toFixed(1) + ' mm' : 'N/A'}</div>
                    <div><i class="fas fa-wind"></i> ${windSpeed != null ? windSpeed.toFixed(1) + ' m/s' : 'N/A'}</div>
                </div>
            </div>
        `;
    }).join('');
}

function displayPredictionChart(predictions, historicalTemps) {
    const ctx = document.getElementById('predictionChart');
    if (!ctx) return;

    if (charts.prediction) {
        charts.prediction.destroy();
    }

    const today = new Date();

    // Historical labels and data
    const historicalLabels = historicalTemps.map((_, index) => {
        const date = new Date(today);
        date.setDate(date.getDate() - (historicalTemps.length - index));
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    // Prediction labels
    const predictionLabels = predictions.map((_, index) => {
        const date = new Date(today);
        date.setDate(date.getDate() + index + 1);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    const predTemps = predictions.map(p => typeof p === 'number' ? p : p.temperature);

    // Calculate confidence intervals
    const upperBound = predictions.map(p => p + 2);
    const lowerBound = predictions.map(p => p - 2);

    charts.prediction = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [...historicalLabels, ...predictionLabels],
            datasets: [
                {
                    label: 'Historical Temperature',
                    data: [...historicalTemps, ...Array(predictions.length).fill(null)],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3
                },
                {
                    label: 'Predicted Temperature',
                data: [...Array(historicalTemps.length).fill(null), ...predTemps],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderDash: [5, 5],
                    pointRadius: 4,
                    pointBackgroundColor: '#10b981'
                },
                {
                    label: 'Upper Confidence',
                    data: [...Array(historicalTemps.length).fill(null), ...upperBound],
                    borderColor: 'rgba(16, 185, 129, 0.3)',
                    backgroundColor: 'transparent',
                    borderDash: [2, 2],
                    pointRadius: 0,
                    fill: false
                },
                {
                    label: 'Lower Confidence',
                    data: [...Array(historicalTemps.length).fill(null), ...lowerBound],
                    borderColor: 'rgba(16, 185, 129, 0.3)',
                    backgroundColor: 'transparent',
                    borderDash: [2, 2],
                    pointRadius: 0,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1) + '¬∞C';
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return value + '¬∞C';
                            }
                        }
                    }
                }
            }
        });
    }

    function getTemperatureDescription(temp) {
        if (temp < 10) return 'Cold';
        if (temp < 20) return 'Cool';
        if (temp < 25) return 'Mild';
        if (temp < 30) return 'Warm';
        if (temp < 35) return 'Hot';
        return 'Very Hot';
    }

    // ==================== FOOD SECURITY SECTION ====================

    async function analyzeFoodSecurity() {
        try {
            showLoading(true);

            const days = parseInt(document.getElementById('securityDays')?.value || 30);

    const response = await fetch(`${API_BASE_URL}/analytics/food-security-risk?days=${days}`);
    const data = await response.json();
    console.log('[FoodSecurity] /analytics/food-security-risk response:', data);
    const payload = data?.data || data;

    if (data?.success === false) {
        showToast(data.message || 'Error analyzing food security', 'error');
        return;
    }

    displayFoodSecurityAnalysis(payload);
    await loadFoodSecurityAlerts();

        } catch (error) {
            console.error('Error analyzing food security:', error);
            showToast('Error analyzing food security', 'error');
        } finally {
            showLoading(false);
        }
    }

async function loadFoodSecurityAlerts() {
    const grid = document.getElementById('foodSecurityAlertsGrid');
    if (!grid) return;

    try {
        const url = 'http://localhost:1010/api/food-security-alerts/active?size=6';
        const response = await fetch(url);
        const data = await response.json();
        console.log('[FoodSecurity] GET', url, 'response:', data);
        const alerts = normalizeFoodSecurityAlerts(data);
        console.log('[FoodSecurity] normalized alerts:', alerts);

        if (alerts.length === 0) {
            grid.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>No active food security alerts</p></div>';
            return;
        }

        grid.innerHTML = alerts.map(alert => {
            const level = (alert.alertLevel || 'INFO').toUpperCase();
            const levelClass = getAlertLevelClass(level);
            const region = alert.affectedRegion || 'Unknown region';
            const dateLabel = formatAlertDate(alert.alertDate || alert.createdAt);
            const population = alert.affectedPopulation ? `Population: ${alert.affectedPopulation}` : 'Population: N/A';

            return `
                <div class="food-alert-card alert-${levelClass}">
                    <div class="food-alert-title">${alert.alertTitle || 'Food Security Alert'}</div>
                    <div class="food-alert-meta">
                        <span><i class="fas fa-bolt"></i> ${level}</span>
                        <span><i class="fas fa-map-marker-alt"></i> ${region}</span>
                        <span><i class="fas fa-calendar"></i> ${dateLabel}</span>
                    </div>
                    <div class="food-alert-message">${alert.description || 'No description available.'}</div>
                    <div class="food-alert-meta">
                        <span><i class="fas fa-users"></i> ${population}</span>
                        <span><i class="fas fa-bullseye"></i> ${alert.alertCategory || 'N/A'}</span>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Error loading food security alerts:', error);
        grid.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><p>Unable to load alerts</p></div>';
    }
}

function normalizeFoodSecurityAlerts(raw) {
    const payload = raw?.data || raw;
    if (Array.isArray(payload)) return payload;
    if (payload?.content && Array.isArray(payload.content)) return payload.content;
    if (payload?.data && Array.isArray(payload.data)) return payload.data;
    if (raw?.data?.content && Array.isArray(raw.data.content)) return raw.data.content;
    if (raw?.data?.data && Array.isArray(raw.data.data)) return raw.data.data;
    return [];
}

function getAlertLevelClass(level) {
    if (level === 'CRITICAL') return 'critical';
    if (level === 'HIGH') return 'high';
    if (level === 'MEDIUM') return 'medium';
    if (level === 'LOW') return 'low';
    return 'info';
}

function formatAlertDate(dateValue) {
    if (!dateValue) return 'N/A';
    const date = new Date(dateValue);
    if (isNaN(date.getTime())) return 'N/A';
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

    function displayFoodSecurityAnalysis(data) {
        if (!data) {
            const riskBadge = document.getElementById('riskLevelBadge');
            if (riskBadge) {
                riskBadge.textContent = 'N/A';
                riskBadge.style.cssText = 'display: inline-block; padding: 10px 24px; border-radius: 20px; font-weight: 600; font-size: 16px; background: var(--bg-secondary); color: var(--text-secondary);';
            }
            document.getElementById('overallRiskScore').textContent = '0';
            showToast('No food security data available', 'info');
            return;
        }

        // Display overall risk score
        const riskScore = data.overallRiskScore || 0;
        const riskLevel = data.riskLevel || 'Unknown';

        document.getElementById('overallRiskScore').textContent = riskScore.toFixed(0);
        document.getElementById('overallRiskScore').className = `quality-score ${getRiskClass(riskLevel)}`;

        const badge = document.getElementById('riskLevelBadge');
        badge.textContent = riskLevel;
        badge.className = '';
        badge.style.cssText = `display: inline-block; padding: 10px 24px; border-radius: 20px; font-weight: 600; font-size: 16px; text-transform: uppercase; background: ${getRiskColor(riskLevel)}; color: white;`;

        // Display individual risk scores
        document.getElementById('droughtRiskScore').textContent = (data.droughtRisk?.score || 0).toFixed(0);
        document.getElementById('floodRiskScore').textContent = (data.floodRisk?.score || 0).toFixed(0);
        document.getElementById('heatStressScore').textContent = (data.heatStress?.score || 0).toFixed(0);
        document.getElementById('cropConditionScore').textContent = (data.cropCondition?.score || 0).toFixed(0);

        // Display detailed analysis
        displayDetailedRiskAnalysis(data);

        // Display recommendations
        displaySecurityRecommendations(data.recommendations || []);

        // Display risk trend chart
        displayRiskTrendChart(data.historicalRisk || []);
    }

    function displayDetailedRiskAnalysis(data) {
        // Drought details
        const droughtDetails = document.getElementById('droughtDetails');
        if (droughtDetails && data.droughtRisk) {
            droughtDetails.innerHTML = `
                <div class="risk-indicator">
                    <span class="risk-indicator-label">Consecutive Dry Days</span>
                    <span class="risk-indicator-value risk-${data.droughtRisk.level?.toLowerCase()}">${data.droughtRisk.dryDays || 0}</span>
                </div>
                <div class="risk-indicator">
                    <span class="risk-indicator-label">Average Rainfall</span>
                    <span class="risk-indicator-value">${(data.droughtRisk.avgRainfall || 0).toFixed(1)} mm</span>
                </div>
                <div class="risk-bar">
                    <div class="risk-bar-fill risk-${data.droughtRisk.level?.toLowerCase()}" style="width: ${data.droughtRisk.score}%"></div>
                </div>
                <p style="margin-top: 16px; color: var(--text-secondary); font-size: 14px;">
                    ${data.droughtRisk.description || 'Analysis in progress...'}
                </p>
            `;
        }

        // Flood details
        const floodDetails = document.getElementById('floodDetails');
        if (floodDetails && data.floodRisk) {
            floodDetails.innerHTML = `
                <div class="risk-indicator">
                    <span class="risk-indicator-label">Heavy Rain Days</span>
                    <span class="risk-indicator-value risk-${data.floodRisk.level?.toLowerCase()}">${data.floodRisk.heavyRainDays || 0}</span>
                </div>
                <div class="risk-indicator">
                    <span class="risk-indicator-label">Max Daily Rainfall</span>
                    <span class="risk-indicator-value">${(data.floodRisk.maxRainfall || 0).toFixed(1)} mm</span>
                </div>
                <div class="risk-bar">
                    <div class="risk-bar-fill risk-${data.floodRisk.level?.toLowerCase()}" style="width: ${data.floodRisk.score}%"></div>
                </div>
                <p style="margin-top: 16px; color: var(--text-secondary); font-size: 14px;">
                    ${data.floodRisk.description || 'Analysis in progress...'}
                </p>
            `;
        }

        // Heat stress details
        const heatDetails = document.getElementById('heatStressDetails');
        if (heatDetails && data.heatStress) {
            heatDetails.innerHTML = `
                <div class="risk-indicator">
                    <span class="risk-indicator-label">Hot Days (>35¬∞C)</span>
                    <span class="risk-indicator-value risk-${data.heatStress.level?.toLowerCase()}">${data.heatStress.hotDays || 0}</span>
                </div>
                <div class="risk-indicator">
                    <span class="risk-indicator-label">Max Temperature</span>
                    <span class="risk-indicator-value">${(data.heatStress.maxTemp || 0).toFixed(1)}¬∞C</span>
                </div>
                <div class="risk-bar">
                    <div class="risk-bar-fill risk-${data.heatStress.level?.toLowerCase()}" style="width: ${data.heatStress.score}%"></div>
                </div>
                <p style="margin-top: 16px; color: var(--text-secondary); font-size: 14px;">
                    ${data.heatStress.description || 'Analysis in progress...'}
                </p>
            `;
        }

        // Crop condition details
        const cropDetails = document.getElementById('cropConditionDetails');
        if (cropDetails && data.cropCondition) {
            cropDetails.innerHTML = `
                <div class="metric-grid">
                    <div class="metric-item">
                        <div class="metric-value">${(data.cropCondition.avgTemp || 0).toFixed(1)}¬∞C</div>
                        <div class="metric-label">Avg Temp</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">${(data.cropCondition.avgHumidity || 0).toFixed(0)}%</div>
                        <div class="metric-label">Avg Humidity</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">${(data.cropCondition.totalRainfall || 0).toFixed(1)} mm</div>
                        <div class="metric-label">Total Rain</div>
                    </div>
                </div>
                <div class="risk-bar" style="margin-top: 16px;">
                    <div class="risk-bar-fill risk-${data.cropCondition.level?.toLowerCase()}" style="width: ${data.cropCondition.score}%"></div>
                </div>
                <p style="margin-top: 16px; color: var(--text-secondary); font-size: 14px;">
                    ${data.cropCondition.description || 'Analysis in progress...'}
                </p>
            `;
        }
    }

    function displaySecurityRecommendations(recommendations) {
        const container = document.getElementById('securityRecommendations');
        if (!container) return;

        if (recommendations.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No specific recommendations at this time.</p>';
            return;
        }

        container.innerHTML = recommendations.map(rec => `
            <div class="recommendation-item">
                <div class="recommendation-icon">
                    <i class="fas ${getRecommendationIcon(rec.type)}"></i>
                </div>
                <div class="recommendation-text">${rec.message}</div>
            </div>
        `).join('');
    }

    function displayRiskTrendChart(historicalData) {
        const ctx = document.getElementById('riskTrendChart');
        if (!ctx) return;

        if (charts.riskTrend) {
            charts.riskTrend.destroy();
        }

        const labels = historicalData.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        const droughtRisk = historicalData.map(d => d.droughtRisk || 0);
        const floodRisk = historicalData.map(d => d.floodRisk || 0);
        const heatStress = historicalData.map(d => d.heatStress || 0);

        charts.riskTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Drought Risk',
                        data: droughtRisk,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Flood Risk',
                        data: floodRisk,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Heat Stress',
                        data: heatStress,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    function getRiskClass(level) {
        const classes = {
            'CRITICAL': 'risk-critical',
            'HIGH': 'risk-high',
            'MEDIUM': 'risk-medium',
            'LOW': 'risk-low'
        };
        return classes[level] || 'risk-medium';
    }

    function getRiskColor(level) {
        const colors = {
            'CRITICAL': '#dc2626',
            'HIGH': '#f59e0b',
            'MEDIUM': '#3b82f6',
            'LOW': '#10b981'
        };
        return colors[level] || '#3b82f6';
    }

    function getRecommendationIcon(type) {
        const icons = {
            'irrigation': 'fa-tint',
            'drainage': 'fa-water',
            'protection': 'fa-shield-alt',
            'harvest': 'fa-cut',
            'planting': 'fa-seedling',
            'monitoring': 'fa-eye'
        };
        return icons[type] || 'fa-info-circle';
    }

    function getAlertIcon(type) {
        const t = (type || '').toString().toLowerCase();
        if (t.includes('temperature') || t.includes('heat')) return 'fa-thermometer-half';
        if (t.includes('rain')) return 'fa-cloud-showers-heavy';
        if (t.includes('wind')) return 'fa-wind';
        if (t.includes('humidity')) return 'fa-tint';
        return 'fa-exclamation-triangle';
    }

    // ==================== WEATHER ALERTS ====================

    async function checkWeatherAlerts() {
        try {
            showLoading(true);

        const response = await fetch(`${API_BASE_URL}/analytics/check-alert-triggers`, {
            method: 'POST'
        });
        const data = await response.json();
        const payload = data?.data || data;
        const alerts = payload?.triggeredAlerts || payload?.alerts || (Array.isArray(payload) ? payload : []);

        if (data?.success === false) {
            showToast(data.message || 'Error checking weather alerts', 'error');
            return;
        }

        displayWeatherAlerts(alerts);
        displayAlertTimeline(alerts);

        } catch (error) {
            console.error('Error checking alerts:', error);
            showToast('Error checking weather alerts', 'error');
        } finally {
            showLoading(false);
        }
    }

    function displayWeatherAlerts(alerts) {
        const grid = document.getElementById('activeAlertsGrid');
        if (!grid) return;

        if (alerts.length === 0) {
            grid.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>No active weather alerts</p></div>';
            return;
        }

        grid.innerHTML = alerts.map(alert => `
            <div class="alert-card ${alert.severity?.toLowerCase()}">
                <div class="alert-header">
                    <span class="alert-type"><i class="fas ${getAlertIcon(alert.type)}"></i> ${alert.type || 'Weather Alert'}</span>
                    <span class="alert-severity ${alert.severity?.toLowerCase()}">${alert.severity || 'Medium'}</span>
                </div>
                <div class="alert-message">${alert.message || 'Weather conditions require attention'}</div>
                <div class="alert-timestamp">
                    <i class="fas fa-clock"></i>
                    ${new Date(alert.timestamp || Date.now()).toLocaleString()}
                </div>
            </div>
        `).join('');
    }

    function displayAlertTimeline(alerts) {
        const ctx = document.getElementById('alertTimelineChart');
        if (!ctx) return;

        if (charts.alertTimeline) {
            charts.alertTimeline.destroy();
        }

        const alertTypes = ['Temperature', 'Rainfall', 'Wind', 'Humidity'];
        const alertCounts = alertTypes.map(type =>
            alerts.filter(a => a.type?.includes(type)).length
        );

        charts.alertTimeline = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: alertTypes,
                datasets: [{
                    label: 'Active Alerts',
                    data: alertCounts,
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.7)',
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(16, 185, 129, 0.7)',
                        'rgba(245, 158, 11, 0.7)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }

    // ==================== INITIALIZE SECTIONS ====================

    // Add food security and alerts to section data loading
    const originalLoadSectionData = loadSectionData;
    loadSectionData = async function(sectionName) {
        if (sectionName === 'foodSecurity') {
            await loadFoodSecurityAlerts();
            return;
        } else if (sectionName === 'alerts') {
            await checkWeatherAlerts();
        } else {
            await originalLoadSectionData(sectionName);
        }
    };






    async function loadTrainingData() {
        try {
            // Try to get data from multiple sources to maximize data availability
            console.log('Loading training data...');

            // First, try to get recent data (last 90 days)
            let response = await fetch(`${API_BASE_URL}/recent?days=90`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const trainingRaw = await response.json();
            trainingData = normalizeApiArray(trainingRaw);
            console.log('Initial data loaded:', trainingData.length, 'records');

            // If we don't have enough data, try to get all available data
            if (trainingData.length < 10) {
                console.log('Trying to load all available data...');
                response = await fetch(`${API_BASE_URL}?page=0&size=1000&sortBy=recordDate&sortDir=desc`);

                if (response.ok) {
                    const pageData = await response.json();
                    trainingData = pageData.content || pageData;
                    console.log('All data loaded:', trainingData.length, 'records');
                }
            }

            // Sort by date
            if (trainingData.length > 0) {
                trainingData.sort((a, b) => new Date(a.recordDate) - new Date(b.recordDate));
            }

            return trainingData;

        } catch (error) {
            console.error('Error loading training data:', error);
            trainingData = [];
            throw error;
        }
    }

    async function trainPredictionModel() {
        try {
            const minRequiredRecords = PREDICTION_MIN_RECORDS;

            if (trainingData.length < minRequiredRecords) {
                throw new Error(`Insufficient training data. Found ${trainingData.length} records, need at least ${minRequiredRecords}.`);
            }

            // Extract and validate temperature data
            const temperatures = trainingData
                .map(d => {
                    const temp = parseFloat(d.temperature);
                    return (!isNaN(temp) && temp !== null && temp !== undefined) ? temp : null;
                })
                .filter(t => t !== null);

            console.log('Valid temperature records:', temperatures.length);

            if (temperatures.length < minRequiredRecords) {
                throw new Error(`Insufficient valid temperature data. Found ${temperatures.length} valid records, need at least ${minRequiredRecords}.`);
            }

            // Calculate statistics for normalization
            const tempMean = temperatures.reduce((a, b) => a + b, 0) / temperatures.length;
            const tempVariance = temperatures.reduce((sq, n) => sq + Math.pow(n - tempMean, 2), 0) / temperatures.length;
            const tempStd = Math.sqrt(tempVariance);

            console.log('Temperature stats:', { mean: tempMean, std: tempStd });

            // Check for zero variance
            if (tempStd === 0 || isNaN(tempStd)) {
                throw new Error('Temperature data has no variance. Cannot train model.');
            }

            // Store normalization parameters
            window.normalizationParams = { tempMean, tempStd };

            // Create sequences - adapt sequence length to available data
            const maxSequenceLength = 7;
            const sequenceLength = Math.min(maxSequenceLength, Math.max(3, Math.floor(temperatures.length / 2)));

            if (sequenceLength < 3) {
                throw new Error(`Not enough data for meaningful sequences. Need at least ${PREDICTION_MIN_RECORDS} temperature records.`);
            }

            console.log('Using sequence length:', sequenceLength);

            const sequences = [];
            const targets = [];

            for (let i = 0; i < temperatures.length - sequenceLength; i++) {
                sequences.push(temperatures.slice(i, i + sequenceLength));
                targets.push(temperatures[i + sequenceLength]);
            }

            console.log('Created sequences:', sequences.length);

            if (sequences.length < 2) {
                throw new Error(`Not enough sequences for training. Need at least 2, found ${sequences.length}.`);
            }

            // Normalize data
            const normalizedSequences = sequences.map(seq =>
                seq.map(t => (t - tempMean) / tempStd)
            );
            const normalizedTargets = targets.map(t => (t - tempMean) / tempStd);

            // Build TensorFlow model
            predictionModel = tf.sequential({
                layers: [
                    tf.layers.dense({ inputShape: [sequenceLength], units: 32, activation: 'relu' }),
                    tf.layers.dropout({ rate: 0.2 }),
                    tf.layers.dense({ units: 16, activation: 'relu' }),
                    tf.layers.dense({ units: 1 })
                ]
            });

            predictionModel.compile({
                optimizer: tf.train.adam(0.001),
                loss: 'meanSquaredError',
                metrics: ['mae']
            });

            // Convert to tensors
            const xs = tf.tensor2d(normalizedSequences);
            const ys = tf.tensor2d(normalizedTargets, [normalizedTargets.length, 1]);

            console.log('Training model...');

            // Train model
            const batchSize = Math.max(4, Math.min(16, Math.floor(sequences.length / 4)));
            const history = await predictionModel.fit(xs, ys, {
                epochs: 50,
                batchSize: batchSize,
                validationSplit: 0.2,
                verbose: 0,
                callbacks: {
                    onEpochEnd: (epoch, logs) => {
                        if (epoch % 10 === 0) {
                            const loss = logs.loss || 0;
                            const accuracy = Math.max(0, Math.min(100, (1 - loss) * 100));
                            document.getElementById('modelAccuracy').textContent = `${accuracy.toFixed(2)}%`;
                            console.log(`Epoch ${epoch}: loss=${loss.toFixed(4)}, accuracy=${accuracy.toFixed(2)}%`);
                        }
                    }
                }
            });

            // Clean up tensors
            xs.dispose();
            ys.dispose();

            // Calculate final accuracy
            const finalLoss = history.history.loss[history.history.loss.length - 1] || 0;
            const finalAccuracy = Math.max(0, Math.min(100, (1 - finalLoss) * 100));
            document.getElementById('modelAccuracy').textContent = `${finalAccuracy.toFixed(2)}%`;

            console.log('Model trained successfully. Final accuracy:', finalAccuracy.toFixed(2) + '%');

            // Store sequence length for predictions
            window.predictionSequenceLength = sequenceLength;

        } catch (error) {
            console.error('Error training model:', error);
            throw error;
        }
    }

    async function generatePredictions() {
        try {
            if (!predictionModel) {
                showToast('Please wait for model to initialize', 'warning');
                return;
            }

            if (trainingData.length < PREDICTION_MIN_RECORDS) {
                showToast(`Insufficient training data for predictions. Need at least ${PREDICTION_MIN_RECORDS} records.`, 'error');
                return;
            }

            showLoading(true);

            const days = parseInt(document.getElementById('predictionDays')?.value || 7);
            const sequenceLength = window.predictionSequenceLength || 7;

            // Get recent temperature data
            const recentTemps = trainingData
                .slice(-sequenceLength)
                .map(d => parseFloat(d.temperature))
                .filter(t => !isNaN(t) && t !== null && t !== undefined);

            console.log('Recent temps for prediction:', recentTemps.length);

            if (recentTemps.length < sequenceLength) {
                showToast(`Insufficient recent data. Found ${recentTemps.length} records, need ${sequenceLength}.`, 'error');
                return;
            }

            // Get normalization parameters
            const { tempMean, tempStd } = window.normalizationParams;

            // Normalize input
            const normalizedInput = recentTemps.map(t => (t - tempMean) / tempStd);

            // Recent averages for realistic derived metrics (from real data)
            const recentRecords = trainingData.slice(-Math.max(sequenceLength, 10));
            const avgHumidity = calculateAverage(recentRecords, 'humidity') || 50;
            const avgRainfall = calculateAverage(recentRecords, 'rainfall') || 0;
            const avgWind = calculateAverage(recentRecords, 'windSpeed') || 2;

            // Generate predictions
            const predictions = [];
            let currentSequence = [...normalizedInput];

            for (let i = 0; i < days; i++) {
                const inputTensor = tf.tensor2d([currentSequence]);
                const predictionTensor = predictionModel.predict(inputTensor);
                const normalizedPred = await predictionTensor.data();

                // Denormalize prediction
                const prediction = normalizedPred[0] * tempStd + tempMean;
                const humidity = Math.max(20, Math.min(100, avgHumidity - (prediction - tempMean) * 0.4));
                const rainfall = humidity > 70 ? Math.max(0, avgRainfall * (humidity / 100)) : avgRainfall * 0.3;
                const windSpeed = Math.max(0, avgWind + (prediction - tempMean) * 0.05);
                const condition = deriveWeatherCondition(prediction, humidity, rainfall);

                predictions.push({
                    temperature: prediction,
                    humidity,
                    rainfall,
                    windSpeed,
                    condition
                });

                // Update sequence for next prediction
                currentSequence.shift();
                currentSequence.push(normalizedPred[0]);

                // Clean up tensors
                inputTensor.dispose();
                predictionTensor.dispose();
            }

            console.log('Predictions generated:', predictions);

            // Display predictions
            displayPredictions(predictions);
            displayPredictionChart(predictions);

            showToast('Predictions generated successfully', 'success');

        } catch (error) {
            console.error('Error generating predictions:', error);
            showToast('Error generating predictions: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    function displayPredictions(predictions) {
        const resultsContainer = document.getElementById('predictionResults');
        if (!resultsContainer) return;

        const today = new Date();

        resultsContainer.innerHTML = predictions.map((pred, index) => {
            const date = new Date(today);
            date.setDate(date.getDate() + index + 1);

            const temp = typeof pred === 'number' ? pred : pred.temperature;
            const humidity = typeof pred === 'number' ? null : pred.humidity;
            const rainfall = typeof pred === 'number' ? null : pred.rainfall;
            const windSpeed = typeof pred === 'number' ? null : pred.windSpeed;
            const condition = typeof pred === 'number' ? null : pred.condition;

            return `
                <div class="prediction-card">
                    <div class="prediction-date">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', weekday: 'short' })}</div>
                    <div class="prediction-value">${temp.toFixed(1)}¬∞C</div>
                    <div class="prediction-meta">
                        <span>${condition ? formatCondition(condition) : getTemperatureDescription(temp)}</span>
                    </div>
                    <div class="prediction-details">
                        <div><i class="fas fa-tint"></i> ${humidity != null ? humidity.toFixed(0) + '%' : 'N/A'}</div>
                        <div><i class="fas fa-cloud-rain"></i> ${rainfall != null ? rainfall.toFixed(1) + ' mm' : 'N/A'}</div>
                        <div><i class="fas fa-wind"></i> ${windSpeed != null ? windSpeed.toFixed(1) + ' m/s' : 'N/A'}</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function displayPredictionChart(predictions) {
        const ctx = document.getElementById('predictionChart');
        if (!ctx) return;

        if (charts.prediction) {
            charts.prediction.destroy();
        }

        const today = new Date();
        const labels = predictions.map((_, index) => {
            const date = new Date(today);
            date.setDate(date.getDate() + index + 1);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        // Get recent actual temperatures
        const sequenceLength = window.predictionSequenceLength || 7;
        const recentTemps = trainingData.slice(-sequenceLength).map(d => parseFloat(d.temperature));
        const recentLabels = trainingData.slice(-sequenceLength).map(d => formatDate(getRecordDate(d)));

        const predTemps = predictions.map(p => typeof p === 'number' ? p : p.temperature);

        charts.prediction = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [...recentLabels, ...labels],
                datasets: [
                    {
                        label: 'Historical',
                        data: [...recentTemps, ...Array(predictions.length).fill(null)],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Predicted',
                        data: [...Array(recentTemps.length).fill(null), ...predTemps],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderDash: [5, 5]
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return value + '¬∞C';
                            }
                        }
                    }
                }
            }
        });
    }

    function getTemperatureDescription(temp) {
        if (temp < 10) return 'Cold';
        if (temp < 20) return 'Cool';
        if (temp < 25) return 'Mild';
        if (temp < 30) return 'Warm';
        if (temp < 35) return 'Hot';
        return 'Very Hot';
    }

        // ==================== STATISTICS SECTION ====================



        async function loadStatisticsSection() {
            try {
                showLoading(true);

                const startDate = document.getElementById('statsStartDate')?.value;
                const endDate = document.getElementById('statsEndDate')?.value;

                if (!startDate || !endDate) {
                    const end = new Date();
                    const start = new Date();
                    start.setDate(start.getDate() - 30);

                    document.getElementById('statsStartDate').value = start.toISOString().split('T')[0];
                    document.getElementById('statsEndDate').value = end.toISOString().split('T')[0];

                    await loadStatisticsSection();
                    return;
                }

                // Format ISO sans millisecondes
                const startISO = new Date(startDate).toISOString().split('.')[0];
                const endISO = new Date(endDate).toISOString().split('.')[0];

    const response = await fetch(
        `${API_BASE_URL}/analytics/statistics?startDate=${startISO}&endDate=${endISO}`
    );
    const statsResponse = await response.json();
    let stats = statsResponse?.data || statsResponse;

                if (!hasValidStats(stats)) {
                    const rangeResponse = await fetch(
                        `${API_BASE_URL}/date-range?startDate=${startISO}&endDate=${endISO}`
                    );
                    const rangeData = await rangeResponse.json();
                    stats = computeStatsFromRecords(Array.isArray(rangeData) ? rangeData : []);
                }

                displayStatisticsSummary(stats);
                displayStatisticsCharts(stats);

            } catch (error) {
                console.error('Error loading statistics:', error);
                showToast('Error loading statistics', 'error');
            } finally {
                showLoading(false);
            }
        }





        function displayStatisticsSummary(stats) {
            const container = document.getElementById('statsSummary');
            if (!container) return;

            if (!stats || !hasValidStats(stats)) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-info-circle"></i><p>No statistics available for the selected period</p></div>';
                return;
            }

            const normalized = normalizeStats(stats);

            container.innerHTML = `
                <div class="summary-card">
                    <div class="summary-label">Average Temperature</div>
                    <div class="summary-value">${formatMetric(normalized.avgTemperature, '¬∞C')}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Max Temperature</div>
                    <div class="summary-value">${formatMetric(normalized.maxTemperature, '¬∞C')}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Min Temperature</div>
                    <div class="summary-value">${formatMetric(normalized.minTemperature, '¬∞C')}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Average Humidity</div>
                    <div class="summary-value">${formatMetric(normalized.avgHumidity, '%')}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Total Rainfall</div>
                    <div class="summary-value">${formatMetric(normalized.totalRainfall, ' mm', 1, '0 mm')}</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">Average Wind Speed</div>
                    <div class="summary-value">${formatMetric(normalized.avgWindSpeed, ' m/s')}</div>
                </div>
            `;
        }

        async function displayStatisticsCharts(stats) {
            // Temperature distribution histogram
            await displayTemperatureDistribution();

            // Humidity box plot
            await displayHumidityBoxPlot();

            // Temperature vs Humidity scatter plot
            await displayScatterPlot();
        }





async function displayTemperatureDistribution() {
    const ctx = document.getElementById('tempDistributionChart');
    if (!ctx) return;

    if (charts.tempDistribution) {
        charts.tempDistribution.destroy();
    }

    try {
        const startDate = document.getElementById('statsStartDate')?.value;
        const endDate = document.getElementById('statsEndDate')?.value;

        // CORRECTION ICI
        const startDateTime = formatISODateTime(new Date(startDate + 'T00:00:00'));
        const endDateTime = formatISODateTime(new Date(endDate + 'T23:59:59'));

        const response = await fetch(
            `${API_BASE_URL}/date-range?startDate=${startDateTime}&endDate=${endDateTime}`
        );

        const result = await response.json();

        // CORRECTION: V√©rifier si c'est un objet d'erreur
        if (!response.ok || result.success === false) {
            console.error('Error response:', result);
            showToast(result.message || 'Error loading temperature data', 'error');
            return;
        }

        const data = Array.isArray(result) ? result : [];

        if (data.length === 0) {
            showToast('No data available for the selected period', 'info');
            return;
        }

        const temperatures = data.map(d => parseFloat(d.temperature)).filter(t => !isNaN(t));

        if (temperatures.length === 0) {
            showToast('No valid temperature data', 'info');
            return;
        }

        // Create histogram bins
        const bins = 10;
        const min = Math.min(...temperatures);
        const max = Math.max(...temperatures);
        const binSize = (max - min) / bins;

        const histogram = Array(bins).fill(0);
        temperatures.forEach(temp => {
            const binIndex = Math.min(Math.floor((temp - min) / binSize), bins - 1);
            histogram[binIndex]++;
        });

        const labels = Array(bins).fill(0).map((_, i) => {
            const start = min + i * binSize;
            const end = start + binSize;
            return `${start.toFixed(1)}-${end.toFixed(1)}¬∞C`;
        });

        charts.tempDistribution = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Frequency',
                    data: histogram,
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: '#3b82f6',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Temperature Distribution'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error displaying temperature distribution:', error);
        showToast('Error loading temperature distribution', 'error');
    }
}



async function displayHumidityBoxPlot() {
    const ctx = document.getElementById('humidityBoxPlot');
    if (!ctx) return;

    if (charts.humidityBox) {
        charts.humidityBox.destroy();
    }

    try {
        const startDate = document.getElementById('statsStartDate')?.value;
        const endDate = document.getElementById('statsEndDate')?.value;

        // CORRECTION ICI
        const startDateTime = formatISODateTime(new Date(startDate + 'T00:00:00'));
        const endDateTime = formatISODateTime(new Date(endDate + 'T23:59:59'));

        const response = await fetch(
            `${API_BASE_URL}/date-range?startDate=${startDateTime}&endDate=${endDateTime}`
        );

        const result = await response.json();

        // CORRECTION: V√©rifier si c'est un objet d'erreur
        if (!response.ok || result.success === false) {
            console.error('Error response:', result);
            return;
        }

        const data = Array.isArray(result) ? result : [];

        if (data.length === 0) {
            return;
        }

        const humidity = data.map(d => parseFloat(d.humidity)).filter(h => !isNaN(h)).sort((a, b) => a - b);

        if (humidity.length === 0) {
            return;
        }

        // Calculate quartiles
        const q1 = humidity[Math.floor(humidity.length * 0.25)];
        const median = humidity[Math.floor(humidity.length * 0.5)];
        const q3 = humidity[Math.floor(humidity.length * 0.75)];
        const min = humidity[0];
        const max = humidity[humidity.length - 1];

        charts.humidityBox = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Min', 'Q1', 'Median', 'Q3', 'Max'],
                datasets: [{
                    label: 'Humidity (%)',
                    data: [min, q1, median, q3, max],
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.7)',
                        'rgba(251, 191, 36, 0.7)',
                        'rgba(34, 197, 94, 0.7)',
                        'rgba(251, 191, 36, 0.7)',
                        'rgba(239, 68, 68, 0.7)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Humidity Statistics'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error displaying humidity box plot:', error);
    }
}


async function displayScatterPlot() {
    const ctx = document.getElementById('scatterPlot');
    if (!ctx) return;

    if (charts.scatter) {
        charts.scatter.destroy();
    }

    try {
        const startDate = document.getElementById('statsStartDate')?.value;
        const endDate = document.getElementById('statsEndDate')?.value;

        // CORRECTION ICI
        const startDateTime = formatISODateTime(new Date(startDate + 'T00:00:00'));
        const endDateTime = formatISODateTime(new Date(endDate + 'T23:59:59'));

        const response = await fetch(
            `${API_BASE_URL}/date-range?startDate=${startDateTime}&endDate=${endDateTime}`
        );

        const result = await response.json();

        // CORRECTION: V√©rifier si c'est un objet d'erreur
        if (!response.ok || result.success === false) {
            console.error('Error response:', result);
            return;
        }

        const data = Array.isArray(result) ? result : [];

        if (data.length === 0) {
            return;
        }

        const scatterData = data
            .filter(d => d.temperature != null && d.humidity != null)
            .map(d => ({
                x: parseFloat(d.temperature),
                y: parseFloat(d.humidity)
            }));

        if (scatterData.length === 0) {
            return;
        }

        charts.scatter = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Temperature vs Humidity',
                    data: scatterData,
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: '#3b82f6',
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Temp: ${context.parsed.x.toFixed(1)}¬∞C, Humidity: ${context.parsed.y.toFixed(1)}%`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Temperature (¬∞C)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Humidity (%)'
                        },
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error displaying scatter plot:', error);
    }
}

        // ==================== TRENDS SECTION ====================

        async function loadTrendsSection() {
            try {
                showLoading(true);

                await Promise.all([
                    loadMonthlyTrends(),
                    loadDailyAverages(),
                    loadWindTrends()
                ]);

            } catch (error) {
                console.error('Error loading trends:', error);
                showToast('Error loading trends', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadMonthlyTrends() {
            const ctx = document.getElementById('monthlyTrendsChart');
            if (!ctx) return;

            if (charts.monthlyTrends) {
                charts.monthlyTrends.destroy();
            }

            try {
            const response = await fetch(`${API_BASE_URL}/analytics/monthly-stats`);
            const monthlyRaw = await response.json();
            const monthlyStats = normalizeApiArray(monthlyRaw);

                if (!Array.isArray(monthlyStats) || monthlyStats.length === 0) {
                    setChartEmptyState('monthlyTrendsChart', 'No monthly trend data available');
                    return;
                }
                clearChartEmptyState('monthlyTrendsChart');

                const labels = monthlyStats.map(m => `${m.year}-${String(m.month).padStart(2, '0')}`);
                const avgTemps = monthlyStats.map(m => m.avgTemperature);
                const avgHumidity = monthlyStats.map(m => m.avgHumidity);
                const totalRainfall = monthlyStats.map(m => m.totalRainfall);

                charts.monthlyTrends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Avg Temperature (¬∞C)',
                                data: avgTemps,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                yAxisID: 'y',
                                tension: 0.4
                            },
                            {
                                label: 'Avg Humidity (%)',
                                data: avgHumidity,
                                borderColor: '#06b6d4',
                                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                                yAxisID: 'y',
                                tension: 0.4
                            },
                            {
                                label: 'Total Rainfall (mm)',
                                data: totalRainfall,
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                yAxisID: 'y1',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (¬∞C) / Humidity (%)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Rainfall (mm)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading monthly trends:', error);
            }
        }



        async function loadDailyAverages() {
    const ctx = document.getElementById('dailyAvgChart');
    if (!ctx) return;

    if (charts.dailyAvg) {
        charts.dailyAvg.destroy();
    }

    try {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - 30);

        // CORRECTION ICI
        const startISO = formatISODateTime(startDate);
        const endISO = formatISODateTime(endDate);

        const response = await fetch(
            `${API_BASE_URL}/analytics/daily-stats?startDate=${startISO}&endDate=${endISO}`
        );
        const dailyRaw = await response.json();
        const dailyStats = normalizeApiArray(dailyRaw);

        if (!Array.isArray(dailyStats) || dailyStats.length === 0) {
            setChartEmptyState('dailyAvgChart', 'No daily average data available');
            return;
        }
        clearChartEmptyState('dailyAvgChart');

        const labels = dailyStats.map(d => {
            const dateValue = getRecordDate(d) || d.date;
            return new Date(dateValue).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const avgTemps = dailyStats.map(d => d.avgTemperature);

        charts.dailyAvg = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Daily Avg Temperature',
                    data: avgTemps,
                    backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    borderColor: '#ef4444',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return value + '¬∞C';
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading daily averages:', error);
        setChartEmptyState('dailyAvgChart', 'Unable to load daily averages');
    }
}



        async function loadWindTrends() {
            const ctx = document.getElementById('windTrendsChart');
            if (!ctx) return;

            if (charts.windTrends) {
                charts.windTrends.destroy();
            }

            try {
                const response = await fetch(`${API_BASE_URL}/recent?days=30`);
                const dataRaw = await response.json();
                const data = normalizeApiArray(dataRaw);

                if (!Array.isArray(data) || data.length === 0) {
                    setChartEmptyState('windTrendsChart', 'No wind trend data available');
                    return;
                }
                clearChartEmptyState('windTrendsChart');

                const sortedData = data.sort((a, b) => new Date(getRecordDate(a)) - new Date(getRecordDate(b)));
                const labels = sortedData.map(d => formatDate(getRecordDate(d)));
                const windSpeed = sortedData.map(d => d.windSpeed || 0);

                charts.windTrends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Wind Speed (m/s)',
                            data: windSpeed,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + ' m/s';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading wind trends:', error);
                setChartEmptyState('windTrendsChart', 'Unable to load wind trends');
            }
        }

        // ==================== EXTREME WEATHER ====================

        async function loadExtremeWeather() {
            try {
                showLoading(true);

                const response = await fetch(
                    `${API_BASE_URL}/extreme-weather?hotThreshold=35&coldThreshold=5&windThreshold=20&rainThreshold=50`
                );
                const extremeData = await response.json();

                displayExtremeWeatherGrid(extremeData);
                displayExtremeTimeline(extremeData);

            } catch (error) {
                console.error('Error loading extreme weather:', error);
                showToast('Error loading extreme weather', 'error');
            } finally {
                showLoading(false);
            }
        }

        function displayExtremeWeatherGrid(data) {
            const grid = document.getElementById('extremeWeatherGrid');
            if (!grid) return;

            if (data.length === 0) {
                grid.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>No extreme weather conditions detected</p></div>';
                return;
            }

            grid.innerHTML = data.map(weather => {
                const extremeType = getExtremeType(weather);
                const severity = getSeverity(weather);

                return `
                    <div class="weather-card" style="border-left: 4px solid ${severity.color}">
                        <div class="weather-card-header">
                            <div>
                                <div style="font-size: 14px; font-weight: 600; color: ${severity.color}; margin-bottom: 4px;">
                                    ${extremeType}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    ${formatDateTime(weather.recordDate)}
                                </div>
                            </div>
                            <div class="weather-icon" style="font-size: 36px;">${severity.icon}</div>
                        </div>
                        <div class="weather-details">
                            <div class="weather-detail">
                                <i class="fas fa-temperature-high"></i>
                                <span>${weather.temperature || 'N/A'}¬∞C</span>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-wind"></i>
                                <span>${weather.windSpeed || 'N/A'} m/s</span>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-cloud-rain"></i>
                                <span>${weather.rainfall || 0} mm</span>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${weather.latitude?.toFixed(4)}, ${weather.longitude?.toFixed(4)}</span>
                            </div>
                        </div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); font-size: 12px; color: var(--text-secondary);">
                            <strong>Severity:</strong> ${severity.level}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getExtremeType(weather) {
            const types = [];
            if (weather.temperature > 35) types.push('Extreme Heat');
            if (weather.temperature < 5) types.push('Extreme Cold');
            if (weather.windSpeed > 20) types.push('Strong Winds');
            if (weather.rainfall > 50) types.push('Heavy Rainfall');
            return types.join(', ') || 'Extreme Condition';
        }

        function getSeverity(weather) {
            let severity = { level: 'Moderate', color: '#f59e0b', icon: '‚ö†Ô∏è' };

            if (weather.temperature > 40 || weather.temperature < 0 || weather.windSpeed > 30 || weather.rainfall > 100) {
                severity = { level: 'Severe', color: '#ef4444', icon: 'üö®' };
            } else if (weather.temperature > 38 || weather.temperature < 3 || weather.windSpeed > 25 || weather.rainfall > 75) {
                severity = { level: 'High', color: '#f59e0b', icon: '‚ö†Ô∏è' };
            }

            return severity;
        }

        function displayExtremeTimeline(data) {
            const ctx = document.getElementById('extremeTimelineChart');
            if (!ctx) return;

            if (charts.extremeTimeline) {
                charts.extremeTimeline.destroy();
            }

            const sortedData = [...data].sort((a, b) => new Date(a.recordDate) - new Date(b.recordDate));
            const labels = sortedData.map(d => formatDateTime(d.recordDate));
            const temperatures = sortedData.map(d => d.temperature);
            const windSpeeds = sortedData.map(d => d.windSpeed);
            const rainfall = sortedData.map(d => d.rainfall);

            charts.extremeTimeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Temperature (¬∞C)',
                            data: temperatures,
                            borderColor: '#ef4444',
                            backgroundColor: 'transparent',
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'Wind Speed (m/s)',
                            data: windSpeeds,
                            borderColor: '#10b981',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1',
                            tension: 0.4
                        },
                        {
                            label: 'Rainfall (mm)',
                            data: rainfall,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'transparent',
                            yAxisID: 'y2',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperature (¬∞C)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Wind Speed (m/s)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: false,
                            position: 'right'
                        }
                    }
                }
            });
        }



async function generatePDFReport() {
    try {
        showLoading(true);

        const reportType = document.getElementById('reportType')?.value;
        const startDate = document.getElementById('reportStartDate')?.value;
        const endDate = document.getElementById('reportEndDate')?.value;

        if (!startDate || !endDate) {
            showToast('Please select date range', 'warning');
            return;
        }

        const startDateTime = formatISODateTime(new Date(startDate + 'T00:00:00'));
        const endDateTime = formatISODateTime(new Date(endDate + 'T23:59:59'));

        const response = await fetch(
            `${API_BASE_URL}/date-range?startDate=${startDateTime}&endDate=${endDateTime}`
        );
        const reportData = await response.json();

        if (!Array.isArray(reportData) || reportData.length === 0) {
            showToast('No data available for selected date range', 'warning');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const logoDataUrl = await loadImageAsDataUrl('images/logo.jpeg').catch(() => null);

        // Header
        doc.setFillColor(34, 197, 94);
        doc.rect(0, 0, 210, 28, 'F');
        if (logoDataUrl) {
            doc.addImage(logoDataUrl, 'JPEG', 12, 6, 16, 16);
        }
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.text('AgriGuard AI', 34, 14);
        doc.setFontSize(9);
        doc.text('Smart Agriculture Management System', 34, 20);
        doc.setFontSize(11);
        doc.text('Weather Analytics Report', 34, 25);

        // Report summary box
        doc.setFillColor(220, 252, 231);
        doc.roundedRect(15, 34, 180, 20, 3, 3, 'F');
        doc.setTextColor(22, 163, 74);
        doc.setFontSize(9);
        doc.text('Report Generated:', 22, 42);
        doc.text('Analysis Period:', 22, 49);
        doc.text('Report Type:', 110, 42);
        doc.text('Total Records:', 110, 49);
        doc.setTextColor(0, 0, 0);
        doc.text(new Date().toLocaleDateString(), 60, 42);
        doc.text(`${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`, 60, 49);
        doc.text(reportType.toUpperCase(), 148, 42);
        doc.text(String(reportData.length), 148, 49);

        // Summary statistics
        const stats = calculateReportStatistics(reportData);
        doc.setFillColor(34, 197, 94);
        doc.rect(15, 60, 180, 8, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(11);
        doc.text('Weather Summary & Insights', 20, 66);

        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        let yPos = 75;
        doc.text(`Average Temperature: ${stats.avgTemp.toFixed(2)}¬∞C`, 20, yPos);
        yPos += 6;
        doc.text(`Max Temperature: ${stats.maxTemp.toFixed(2)}¬∞C`, 20, yPos);
        yPos += 6;
        doc.text(`Min Temperature: ${stats.minTemp.toFixed(2)}¬∞C`, 20, yPos);
        yPos += 6;
        doc.text(`Average Humidity: ${stats.avgHumidity.toFixed(2)}%`, 20, yPos);
        yPos += 6;
        doc.text(`Total Rainfall: ${stats.totalRainfall.toFixed(2)} mm`, 20, yPos);
        yPos += 6;
        doc.text(`Average Wind Speed: ${stats.avgWindSpeed.toFixed(2)} m/s`, 20, yPos);

        // Table
        const tableData = reportData.slice(0, 50).map(d => [
            formatDateTime(d.recordDate),
            `${d.temperature ?? 'N/A'}¬∞C`,
            `${d.humidity ?? 'N/A'}%`,
            `${d.rainfall ?? 0} mm`,
            `${d.windSpeed ?? 'N/A'} m/s`,
            d.weatherCondition || 'N/A'
        ]);

        doc.autoTable({
            head: [['Date/Time', 'Temp', 'Humidity', 'Rainfall', 'Wind', 'Condition']],
            body: tableData,
            startY: yPos + 8,
            styles: { fontSize: 8 },
            headStyles: { fillColor: [34, 197, 94] }
        });

        doc.save(`weather_report_${Date.now()}.pdf`);
        showToast('PDF report generated successfully', 'success');

    } catch (error) {
        console.error('Error generating PDF report:', error);
        showToast('Error generating PDF report', 'error');
    } finally {
        showLoading(false);
    }
}




async function generateExcelReport() {
    try {
        showLoading(true);

        const startDate = document.getElementById('reportStartDate')?.value;
        const endDate = document.getElementById('reportEndDate')?.value;

        if (!startDate || !endDate) {
            showToast('Please select date range', 'warning');
            return;
        }

        // CORRECTION ICI
        const startDateTime = formatISODateTime(new Date(startDate + 'T00:00:00'));
        const endDateTime = formatISODateTime(new Date(endDate + 'T23:59:59'));

        const response = await fetch(
            `${API_BASE_URL}/date-range?startDate=${startDateTime}&endDate=${endDateTime}`
        );
        const reportData = await response.json();

        if (reportData.length === 0) {
            showToast('No data available for selected date range', 'warning');
            return;
        }

        // Prepare data for Excel
        const excelData = reportData.map(d => ({
            'Date/Time': formatDateTime(d.recordDate),
            'Latitude': d.latitude || 'N/A',
            'Longitude': d.longitude || 'N/A',
            'Temperature (¬∞C)': d.temperature || 'N/A',
            'Min Temp (¬∞C)': d.temperatureMin || 'N/A',
            'Max Temp (¬∞C)': d.temperatureMax || 'N/A',
            'Humidity (%)': d.humidity || 'N/A',
            'Rainfall (mm)': d.rainfall || 0,
            'Wind Speed (m/s)': d.windSpeed || 'N/A',
            'Wind Direction': d.windDirection || 'N/A',
            'Atmospheric Pressure (hPa)': d.atmosphericPressure || 'N/A',
            'Weather Condition': d.weatherCondition || 'N/A',
            'Data Source': d.dataSource || 'N/A',
            'Data Quality': d.dataQuality || 'N/A',
            'UV Index': d.uvIndex || 'N/A'
        }));

        // Create workbook and worksheet
        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Weather Data');

        // Add statistics sheet
        const stats = calculateReportStatistics(reportData);
        const statsData = [
            { Metric: 'Average Temperature', Value: `${stats.avgTemp.toFixed(2)}¬∞C` },
            { Metric: 'Max Temperature', Value: `${stats.maxTemp.toFixed(2)}¬∞C` },
            { Metric: 'Min Temperature', Value: `${stats.minTemp.toFixed(2)}¬∞C` },
            { Metric: 'Average Humidity', Value: `${stats.avgHumidity.toFixed(2)}%` },
            { Metric: 'Total Rainfall', Value: `${stats.totalRainfall.toFixed(2)} mm` },
            { Metric: 'Average Wind Speed', Value: `${stats.avgWindSpeed.toFixed(2)} m/s` },
            { Metric: 'Total Records', Value: reportData.length }
        ];

        const wsStats = XLSX.utils.json_to_sheet(statsData);
        XLSX.utils.book_append_sheet(wb, wsStats, 'Statistics');

        // Save file
        XLSX.writeFile(wb, `weather_report_${Date.now()}.xlsx`);
        showToast('Excel report generated successfully', 'success');

    } catch (error) {
        console.error('Error generating Excel report:', error);
        showToast('Error generating Excel report', 'error');
    } finally {
        showLoading(false);
    }
}




        function calculateReportStatistics(data) {
            const temps = data.filter(d => d.temperature != null).map(d => parseFloat(d.temperature));
            const humidity = data.filter(d => d.humidity != null).map(d => parseFloat(d.humidity));
            const rainfall = data.filter(d => d.rainfall != null).map(d => parseFloat(d.rainfall));
            const windSpeed = data.filter(d => d.windSpeed != null).map(d => parseFloat(d.windSpeed));

            return {
                avgTemp: temps.length > 0 ? temps.reduce((a, b) => a + b, 0) / temps.length : 0,
                maxTemp: temps.length > 0 ? Math.max(...temps) : 0,
                minTemp: temps.length > 0 ? Math.min(...temps) : 0,
                avgHumidity: humidity.length > 0 ? humidity.reduce((a, b) => a + b, 0) / humidity.length : 0,
                totalRainfall: rainfall.reduce((a, b) => a + b, 0),
                avgWindSpeed: windSpeed.length > 0 ? windSpeed.reduce((a, b) => a + b, 0) / windSpeed.length : 0
            };
        }

        // ==================== DATA QUALITY ====================

        async function loadDataQuality() {
            try {
                showLoading(true);

                await Promise.all([
                    displayQualityDistribution(),
                    displayQualityBySource(),
                    displayQualityMetrics()
                ]);

            } catch (error) {
                console.error('Error loading data quality:', error);
                showToast('Error loading data quality', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function displayQualityDistribution() {
            const ctx = document.getElementById('qualityDistributionChart');
            if (!ctx) return;

            if (charts.qualityDistribution) {
                charts.qualityDistribution.destroy();
            }

            try {
                const response = await fetch(`${API_BASE_URL}/analytics/data-quality-stats`);
                const qualityStats = await response.json();

                const labels = Object.keys(qualityStats || {});
                const data = Object.values(qualityStats || {});

                if (labels.length === 0) {
                    setChartEmptyState('qualityDistributionChart', 'No data quality stats available');
                    return;
                }
                clearChartEmptyState('qualityDistributionChart');

                charts.qualityDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: [
                                '#10b981',
                                '#3b82f6',
                                '#f59e0b',
                                '#ef4444'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error displaying quality distribution:', error);
                setChartEmptyState('qualityDistributionChart', 'Unable to load quality distribution');
            }
        }

        async function displayQualityBySource() {
            const ctx = document.getElementById('qualityBySourceChart');
            if (!ctx) return;

            if (charts.qualityBySource) {
                charts.qualityBySource.destroy();
            }

            try {
                const response = await fetch(`${API_BASE_URL}/data-quality-by-source`);
                const qualityData = await response.json();

                if (!Array.isArray(qualityData) || qualityData.length === 0) {
                    setChartEmptyState('qualityBySourceChart', 'No data quality by source available');
                    return;
                }
                clearChartEmptyState('qualityBySourceChart');

                const sources = [...new Set(qualityData.map(d => d.dataSource))];
                const qualities = ['EXCELLENT', 'GOOD', 'FAIR', 'POOR'];

                const datasets = qualities.map((quality, index) => {
                    const colors = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'];
                    return {
                        label: quality,
                        data: sources.map(source => {
                            const item = qualityData.find(d => d.dataSource === source && d.dataQuality === quality);
                            return item ? item.count : 0;
                        }),
                        backgroundColor: colors[index]
                    };
                });

                charts.qualityBySource = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sources,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error displaying quality by source:', error);
                setChartEmptyState('qualityBySourceChart', 'Unable to load quality by source');
            }
        }

        async function displayQualityMetrics() {
            const container = document.getElementById('qualityMetrics');
            if (!container) return;

            try {
                const response = await fetch(`${API_BASE_URL}/analytics/data-quality-stats`);
                const qualityStats = await response.json();

                const total = Object.values(qualityStats || {}).reduce((a, b) => a + b, 0);
                if (!total) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-info-circle"></i><p>No data quality metrics available</p></div>';
                    return;
                }

                const metrics = Object.entries(qualityStats).map(([quality, count]) => {
                    const percentage = ((count / total) * 100).toFixed(1);
                    const colorClass = quality.toLowerCase();

                    return `
                        <div class="quality-card">
                            <h4>${quality}</h4>
                            <div class="quality-score ${colorClass}">${percentage}%</div>
                            <div style="font-size: 14px; color: var(--text-secondary); text-align: center;">
                                ${count} records
                            </div>
                            <div style="margin-top: 16px; width: 100%; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: var(--primary-blue); transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = metrics;

            } catch (error) {
                console.error('Error displaying quality metrics:', error);
            }
        }

        async function loadStatistics() {
            await loadStatisticsSection();
        }



        // ==================== CRUD OPERATIONS ====================

    let currentPage = 0;
    let totalPages = 0;
    let pageSize = 10;
    let currentFilters = {};

    async function loadCrudData() {
        try {
            showLoading(true);

            const searchTerm = document.getElementById('searchFilter')?.value || '';
            const source = document.getElementById('sourceFilter')?.value || '';
            const quality = document.getElementById('qualityFilter')?.value || '';

            currentFilters = {
                page: currentPage,
                size: pageSize,
                sortBy: 'recordDate',
                sortDir: 'desc'
            };

            if (source) currentFilters.dataSource = source;
            if (quality) currentFilters.dataQuality = quality;

            const queryString = new URLSearchParams(currentFilters).toString();
            const response = await fetch(`${API_BASE_URL}?${queryString}`);
            const data = await response.json();

            totalPages = data.totalPages || 0;
            renderCrudTable(data.content || data);
            updatePaginationInfo();

        } catch (error) {
            console.error('Error loading CRUD data:', error);
            showToast('Error loading data', 'error');
        } finally {
            showLoading(false);
        }
    }

    function renderCrudTable(data) {
        const tbody = document.getElementById('crudTableBody');
        if (!tbody) return;

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="empty-state"><i class="fas fa-inbox"></i><p>No weather data found</p></td></tr>';
            return;
        }

        tbody.innerHTML = data.map(weather => `
            <tr>
                <td style="font-size: 12px; font-family: monospace;">${weather.id}</td>
                <td>${formatDateTime(weather.recordDate)}</td>
                <td>${weather.latitude?.toFixed(4)}, ${weather.longitude?.toFixed(4)}</td>
                <td>${weather.temperature || 'N/A'}¬∞C</td>
                <td>${weather.humidity || 'N/A'}%</td>
                <td>${weather.rainfall || 0} mm</td>
                <td>${weather.windSpeed || 'N/A'} m/s</td>
                <td>${weather.weatherCondition || 'N/A'}</td>
                <td>${weather.dataSource || 'N/A'}</td>
                <td><span class="badge badge-${weather.dataQuality?.toLowerCase()}">${weather.dataQuality || 'N/A'}</span></td>
                <td>
                    <button class="action-btn edit" onclick="editWeatherData('${weather.id}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete" onclick="deleteWeatherData('${weather.id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function showAddWeatherModal() {
        document.getElementById('modalTitle').textContent = 'Add Weather Data';
        document.getElementById('weatherForm').reset();
        document.getElementById('weatherId').value = '';
        document.getElementById('weatherModal').classList.add('show');
        document.getElementById('weatherModal').style.display = 'flex';
    }

    function closeWeatherModal() {
        document.getElementById('weatherModal').classList.remove('show');
        document.getElementById('weatherModal').style.display = 'none';
        document.getElementById('weatherForm').reset();
    }


    async function saveWeatherData(event) {
        event.preventDefault();

        try {
            showLoading(true);

            // Validate required fields
            const latitude = document.getElementById('weatherLatitude')?.value?.trim();
            const longitude = document.getElementById('weatherLongitude')?.value?.trim();
            const temperature = document.getElementById('weatherTemperature')?.value?.trim();
            const dataSource = document.getElementById('weatherDataSource')?.value?.trim();
            const dataQuality = document.getElementById('weatherQuality')?.value;

            if (!latitude || !longitude || !temperature || !dataSource || !dataQuality) {
                showToast('Please fill in all required fields', 'warning');
                showLoading(false);
                return;
            }

            // Validate numeric fields
            const latNum = parseFloat(latitude);
            const lonNum = parseFloat(longitude);
            const tempNum = parseFloat(temperature);

            if (isNaN(latNum) || latNum < -90 || latNum > 90) {
                showToast('Latitude must be between -90 and 90', 'error');
                showLoading(false);
                return;
            }

            if (isNaN(lonNum) || lonNum < -180 || lonNum > 180) {
                showToast('Longitude must be between -180 and 180', 'error');
                showLoading(false);
                return;
            }

            if (isNaN(tempNum) || tempNum < -50 || tempNum > 60) {
                showToast('Temperature must be between -50 and 60', 'error');
                showLoading(false);
                return;
            }

            const id = document.getElementById('weatherId').value;
            const recordDate = new Date().toISOString().slice(0, 19);

            // Build weather data object with proper BigDecimal values
            const weatherData = {
                latitude: latNum,  // Send as number, not string
                longitude: lonNum, // Send as number, not string
                recordDate: recordDate,
                temperature: tempNum, // Send as number, not string
                dataSource: dataSource,
                dataQuality: dataQuality
            };

            // Add optional numeric fields
            const addOptionalField = (fieldId, fieldName, min, max) => {
                const value = document.getElementById(fieldId)?.value?.trim();
                if (value && value !== '') {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue) && numValue >= min && numValue <= max) {
                        weatherData[fieldName] = numValue; // Send as number
                    }
                }
            };

            // Add optional integer fields
            const addOptionalIntField = (fieldId, fieldName, min, max) => {
                const value = document.getElementById(fieldId)?.value?.trim();
                if (value && value !== '') {
                    const numValue = parseInt(value);
                    if (!isNaN(numValue) && numValue >= min && numValue <= max) {
                        weatherData[fieldName] = numValue;
                    }
                }
            };

            addOptionalField('weatherHumidity', 'humidity', 0, 100);
            addOptionalField('weatherRainfall', 'rainfall', 0, 10000);
            addOptionalField('weatherWindSpeed', 'windSpeed', 0, 200);
            addOptionalIntField('weatherWindDirection', 'windDirection', 0, 360);
            addOptionalField('weatherPressure', 'atmosphericPressure', 800, 1200);
            addOptionalIntField('weatherUvIndex', 'uvIndex', 0, 15);

            const weatherCondition = document.getElementById('weatherCondition')?.value?.trim();
            if (weatherCondition && weatherCondition !== '') {
                weatherData.weatherCondition = weatherCondition;
            }

            console.log('Sending weather data:', JSON.stringify(weatherData, null, 2));

            const url = id ? `${API_BASE_URL}/${id}` : API_BASE_URL;
            const method = id ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(weatherData)
            });

            if (response.ok) {
                const responseData = await response.json();
                showToast(id ? 'Weather data updated successfully' : 'Weather data added successfully', 'success');
                closeWeatherModal();
                await loadCrudData();
            } else {
                const errorData = await response.json();
                console.error('Error response:', errorData);
                const errorMessage = errorData.message || `Error: ${response.status} ${response.statusText}`;
                showToast(errorMessage, 'error');
            }

        } catch (error) {
            console.error('Error saving weather data:', error);
            showToast(`Error: ${error.message}`, 'error');
        } finally {
            showLoading(false);
        }
    }









    async function editWeatherData(id) {
        try {
            showLoading(true);

            const response = await fetch(`${API_BASE_URL}/${id}`);
            const weather = await response.json();

            document.getElementById('modalTitle').textContent = 'Edit Weather Data';
            document.getElementById('weatherId').value = weather.id;
            document.getElementById('weatherLatitude').value = weather.latitude;
            document.getElementById('weatherLongitude').value = weather.longitude;
            document.getElementById('weatherTemperature').value = weather.temperature;
            document.getElementById('weatherHumidity').value = weather.humidity || '';
            document.getElementById('weatherRainfall').value = weather.rainfall || '';
            document.getElementById('weatherWindSpeed').value = weather.windSpeed || '';
            document.getElementById('weatherWindDirection').value = weather.windDirection || '';
            document.getElementById('weatherCondition').value = weather.weatherCondition || '';
            document.getElementById('weatherPressure').value = weather.atmosphericPressure || '';
            document.getElementById('weatherUvIndex').value = weather.uvIndex || '';
            document.getElementById('weatherDataSource').value = weather.dataSource;
            document.getElementById('weatherQuality').value = weather.dataQuality;

            document.getElementById('weatherModal').classList.add('show');
            document.getElementById('weatherModal').style.display = 'flex';

        } catch (error) {
            console.error('Error loading weather data:', error);
            showToast('Error loading weather data', 'error');
        } finally {
            showLoading(false);
        }
    }

    async function deleteWeatherData(id) {
        if (!confirm('Are you sure you want to delete this weather record? This action cannot be undone.')) {
            return;
        }

        try {
            showLoading(true);

            const response = await fetch(`${API_BASE_URL}/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('Weather data deleted successfully', 'success');
                await loadCrudData();
            } else {
                const error = await response.json();
                showToast(error.message || 'Error deleting weather data', 'error');
            }

        } catch (error) {
            console.error('Error deleting weather data:', error);
            showToast('Error deleting weather data', 'error');
        } finally {
            showLoading(false);
        }
    }

    function changePage(direction) {
        if (direction === 'prev' && currentPage > 0) {
            currentPage--;
        } else if (direction === 'next' && currentPage < totalPages - 1) {
            currentPage++;
        }
        loadCrudData();
    }

    function updatePaginationInfo() {
        const pageInfo = document.getElementById('pageInfo');
        if (pageInfo) {
            pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages || 1}`;
        }
    }


</script>
</body>
</html>
