<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Price Dashboard - AgriGuard AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>


        :root {
          --primary-green: #22c55e;
          --primary-dark: #16a34a;
          --secondary-green: #10b981;
          --accent-green: #34d399;
          --light-green: #dcfce7;
          --dark-green: #166534;
          --forest-green: #065f46;
          --success-color: #22c55e;
          --warning-color: #f59e0b;
          --error-color: #ef4444;
          --info-color: #3b82f6;
          --bg-primary: #ffffff;
          --bg-secondary: #f8f9fa;
          --bg-sidebar: #e8f5e8;
          --text-primary: #333333;
          --text-secondary: #666666;
          --border-color: #e0e0e0;
          --hover-bg: rgba(34, 197, 94, 0.1);
          --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
          --shadow-lg: 0 8px 25px rgba(34, 197, 94, 0.15);
          --gradient-primary: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
          --gradient-bg: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #bbf7d0 100%);
          --card-bg: #ffffff;
          --modal-bg: rgba(0, 0, 0, 0.5);
      }

      .dark-mode {
          --bg-primary: #1a1a1a;
          --bg-secondary: #2d2d2d;
          --bg-sidebar: #1f2937;
          --text-primary: #ffffff;
          --text-secondary: #cccccc;
          --border-color: #404040;
          --hover-bg: rgba(34, 197, 94, 0.2);
          --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          --card-bg: #374151;
          --gradient-bg: linear-gradient(135deg, #1f2937 0%, #374151 50%, #4b5563 100%);
      }

      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Inter', sans-serif;
          background: var(--gradient-bg);
          color: var(--text-primary);
          transition: all 0.3s ease;
          overflow-x: hidden;
      }

      .dashboard-container {
          display: flex;
          height: 100vh;
      }

      .sidebar {
          width: 280px;
          background: var(--bg-sidebar);
          border-right: 1px solid var(--border-color);
          display: flex;
          flex-direction: column;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          position: fixed;
          height: 100vh;
          z-index: 1000;
          box-shadow: var(--shadow);
      }

      .sidebar.collapsed {
          width: 70px;
      }

      .sidebar-header {
          padding: 20px;
          border-bottom: 1px solid var(--border-color);
          display: flex;
          align-items: center;
          gap: 12px;
      }

      .logo {
          width: 45px;
          height: 45px;
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
          box-shadow: var(--shadow);
          flex-shrink: 0;
      }

      .logo img {
          width: 100%;
          height: 100%;
          object-fit: cover;
      }

      .company-info {
          flex: 1;
          transition: opacity 0.3s ease;
          overflow: hidden;
      }

      .company-name {
          font-size: 18px;
          font-weight: 700;
          color: var(--text-primary);
          margin-bottom: 2px;
          white-space: nowrap;
      }

      .company-tagline {
          font-size: 11px;
          color: var(--primary-green);
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          white-space: nowrap;
      }

      .sidebar.collapsed .company-info {
          opacity: 0;
          width: 0;
      }

      .sidebar-nav {
          flex: 1;
          padding: 20px 0;
          overflow-y: auto;
      }

      .nav-section {
          margin-bottom: 30px;
      }

      .nav-section-title {
          padding: 0 20px 10px;
          font-size: 11px;
          font-weight: 700;
          color: var(--primary-green);
          text-transform: uppercase;
          letter-spacing: 1px;
          transition: opacity 0.3s ease;
      }

      .sidebar.collapsed .nav-section-title {
          opacity: 0;
          height: 0;
          margin: 0;
          padding: 0;
      }

      .nav-menu {
          list-style: none;
      }

      .nav-item {
          margin-bottom: 4px;
      }

      .nav-link {
          display: flex;
          align-items: center;
          padding: 14px 20px;
          color: var(--text-primary);
          text-decoration: none;
          border-radius: 0 25px 25px 0;
          margin-right: 20px;
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
          cursor: pointer;
      }

      .nav-link i {
          width: 22px;
          margin-right: 14px;
          font-size: 18px;
          flex-shrink: 0;
          transition: none;
      }

      .sidebar.collapsed .nav-link i {
          margin-right: 0;
      }

      .nav-link span {
          transition: opacity 0.3s ease;
          white-space: nowrap;
          font-weight: 500;
      }

      .sidebar.collapsed .nav-link span {
          opacity: 0;
          width: 0;
      }

      .sidebar.collapsed .nav-link {
          margin-right: 0;
          border-radius: 0;
          justify-content: center;
          padding: 14px;
      }

      .nav-link:hover {
          background: var(--hover-bg);
          color: var(--primary-green);
          transform: translateX(5px);
      }

      .sidebar.collapsed .nav-link:hover {
          transform: translateX(0);
      }

      .nav-item.active .nav-link {
          background: var(--gradient-primary);
          color: white;
          box-shadow: var(--shadow);
      }

      .main-content {
          flex: 1;
          display: flex;
          flex-direction: column;
          margin-left: 280px;
          transition: margin-left 0.3s ease;
      }

      .main-content.sidebar-collapsed {
          margin-left: 70px;
      }

      .header {
          background: var(--card-bg);
          border-bottom: 1px solid var(--border-color);
          padding: 0 32px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          height: 80px;
          box-shadow: var(--shadow);
          backdrop-filter: blur(10px);
      }

      .header-left {
          display: flex;
          align-items: center;
          gap: 24px;
      }

      .sidebar-toggle {
          background: none;
          border: none;
          color: var(--text-primary);
          font-size: 20px;
          cursor: pointer;
          padding: 12px;
          border-radius: 12px;
          transition: all 0.3s ease;
      }

      .sidebar-toggle:hover {
          background: var(--hover-bg);
          color: var(--primary-green);
          transform: scale(1.1);
      }

      .page-title-section {
          display: flex;
          align-items: center;
          gap: 12px;
      }

      .page-icon {
          width: 45px;
          height: 45px;
          border-radius: 12px;
          background: var(--gradient-primary);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
      }

      .page-title {
          font-size: 24px;
          font-weight: 700;
          color: var(--text-primary);
      }

      .header-right {
          display: flex;
          align-items: center;
          gap: 20px;
      }

      .theme-toggle {
          background: var(--card-bg);
          border: 2px solid var(--border-color);
          color: var(--text-primary);
          padding: 12px 16px;
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 16px;
          display: flex;
          align-items: center;
          gap: 8px;
      }

      .theme-toggle:hover {
          background: var(--hover-bg);
          border-color: var(--primary-green);
          transform: translateY(-2px);
      }

      .profile-section {
          display: flex;
          align-items: center;
          gap: 12px;
          cursor: pointer;
          padding: 8px 16px;
          border-radius: 12px;
          transition: all 0.3s ease;
      }

      .profile-section:hover {
          background: var(--hover-bg);
      }

      .profile-avatar {
          width: 45px;
          height: 45px;
          background: var(--gradient-primary);
          color: white;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
          font-size: 16px;
          transition: all 0.3s ease;
          box-shadow: var(--shadow);
      }

      .profile-info {
          display: flex;
          flex-direction: column;
      }

      .profile-name {
          font-size: 14px;
          font-weight: 600;
          color: var(--text-primary);
      }

      .profile-role {
          font-size: 12px;
          color: var(--primary-green);
          font-weight: 500;
      }

      .content {
          flex: 1;
          padding: 32px;
          background: var(--bg-secondary);
          overflow-y: auto;
          min-height: calc(100vh - 80px);
      }

      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 24px;
          margin-bottom: 32px;
          animation: fadeInUp 0.6s ease;
      }

      @keyframes fadeInUp {
          from {
              opacity: 0;
              transform: translateY(20px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      .stat-card {
          background: var(--card-bg);
          padding: 24px;
          border-radius: 16px;
          box-shadow: var(--shadow);
          transition: all 0.3s ease;
          border: 1px solid var(--border-color);
          position: relative;
          overflow: hidden;
      }

      .stat-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: var(--gradient-primary);
      }

      .stat-card:hover {
          transform: translateY(-5px);
          box-shadow: var(--shadow-lg);
      }

      .stat-icon {
          width: 50px;
          height: 50px;
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 24px;
          color: white;
          margin-bottom: 12px;
      }

      .stat-icon.total { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
      .stat-icon.markets { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
      .stat-icon.crops { background: linear-gradient(135deg, #10b981, #047857); }
      .stat-icon.avg-price { background: linear-gradient(135deg, #f59e0b, #d97706); }
      .stat-icon.high-demand { background: linear-gradient(135deg, #ef4444, #dc2626); }
      .stat-icon.opportunities { background: linear-gradient(135deg, #06b6d4, #0891b2); }

      .stat-value {
          font-size: 32px;
          font-weight: 700;
          color: var(--text-primary);
          margin-bottom: 4px;
      }

      .stat-label {
          font-size: 14px;
          color: var(--text-secondary);
          font-weight: 500;
          text-transform: uppercase;
          letter-spacing: 0.5px;
      }

      .charts-section {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
          gap: 24px;
          margin-bottom: 32px;
          animation: fadeInUp 0.8s ease;
      }

      .chart-card {
          background: var(--card-bg);
          padding: 24px;
          border-radius: 16px;
          box-shadow: var(--shadow);
          border: 1px solid var(--border-color);
      }

      .chart-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
      }

      .chart-title {
          font-size: 18px;
          font-weight: 600;
          color: var(--text-primary);
      }

      .chart-container {
          position: relative;
          height: 350px;
      }

      .table-section {
          background: var(--card-bg);
          border-radius: 16px;
          box-shadow: var(--shadow);
          border: 1px solid var(--border-color);
          overflow: hidden;
          margin-bottom: 32px;
          animation: fadeInUp 1s ease;
      }

      .table-header {
          padding: 24px;
          border-bottom: 1px solid var(--border-color);
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: 16px;
      }

      .table-title {
          font-size: 20px;
          font-weight: 600;
          color: var(--text-primary);
      }

      .table-actions {
          display: flex;
          gap: 12px;
          flex-wrap: wrap;
      }

      .btn {
          padding: 10px 20px;
          border: none;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 8px;
          text-decoration: none;
      }

      .btn-primary {
          background: var(--gradient-primary);
          color: white;
          box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
      }

      .btn-secondary {
          background: var(--bg-secondary);
          color: var(--text-primary);
          border: 1px solid var(--border-color);
      }

      .btn-secondary:hover {
          background: var(--hover-bg);
          border-color: var(--primary-green);
      }

      .btn-info {
          background: linear-gradient(135deg, #3b82f6, #1d4ed8);
          color: white;
      }

      .filter-bar {
          padding: 20px 24px;
          border-bottom: 1px solid var(--border-color);
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 16px;
      }

      .filter-group {
          display: flex;
          flex-direction: column;
          gap: 8px;
      }

      .filter-label {
          font-size: 13px;
          font-weight: 600;
          color: var(--text-primary);
      }

      .filter-select {
          padding: 10px 14px;
          border: 2px solid var(--border-color);
          border-radius: 8px;
          background: var(--bg-secondary);
          color: var(--text-primary);
          font-size: 14px;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .filter-select:focus {
          outline: none;
          border-color: var(--primary-green);
          box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
      }

      .data-table {
          width: 100%;
          border-collapse: collapse;
      }

      .data-table th,
      .data-table td {
          padding: 16px;
          text-align: left;
          border-bottom: 1px solid var(--border-color);
      }

      .data-table th {
          background: var(--bg-secondary);
          font-weight: 600;
          color: var(--text-primary);
          font-size: 13px;
          text-transform: uppercase;
          letter-spacing: 0.5px;
      }

      .data-table td {
          color: var(--text-primary);
          font-size: 14px;
      }

      .data-table tr:hover {
          background: var(--hover-bg);
      }

      .status-badge {
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 11px;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.5px;
      }

      .demand-low { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
      .demand-medium { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
      .demand-high { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
      .demand-very_high { background: rgba(153, 27, 27, 0.1); color: #991b1b; }

      .trend-increasing { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
      .trend-stable { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
      .trend-decreasing { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }

      .action-buttons {
          display: flex;
          gap: 8px;
      }

      .action-btn {
          padding: 6px 12px;
          border: none;
          border-radius: 6px;
          font-size: 12px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 4px;
      }

      .action-btn-view {
          background: rgba(34, 197, 94, 0.1);
          color: #22c55e;
      }

      .action-btn-view:hover {
          background: #22c55e;
          color: white;
      }

      .action-btn-edit {
          background: rgba(59, 130, 246, 0.1);
          color: #3b82f6;
      }

      .action-btn-edit:hover {
          background: #3b82f6;
          color: white;
      }

      .action-btn-delete {
          background: rgba(239, 68, 68, 0.1);
          color: #ef4444;
      }

      .action-btn-delete:hover {
          background: #ef4444;
          color: white;
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 2000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background: var(--modal-bg);
          backdrop-filter: blur(5px);
          animation: fadeIn 0.3s ease;
      }

      .modal.show {
          display: flex;
          align-items: center;
          justify-content: center;
      }

      .modal-content {
          background: var(--card-bg);
          border-radius: 16px;
          padding: 32px;
          width: 90%;
          max-width: 900px;
          max-height: 90vh;
          overflow-y: auto;
          box-shadow: var(--shadow-lg);
          animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
          from {
              opacity: 0;
              transform: translateY(50px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 24px;
          padding-bottom: 16px;
          border-bottom: 1px solid var(--border-color);
      }

      .modal-title {
          font-size: 24px;
          font-weight: 700;
          color: var(--text-primary);
      }

      .modal-close {
          background: none;
          border: none;
          font-size: 24px;
          color: var(--text-secondary);
          cursor: pointer;
          padding: 8px;
          border-radius: 8px;
          transition: all 0.3s ease;
      }

      .modal-close:hover {
          background: var(--hover-bg);
          color: var(--primary-green);
      }

      .form-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: var(--text-primary);
          font-size: 14px;
      }

      .form-input,
      .form-select,
      .form-textarea {
          width: 100%;
          padding: 12px 16px;
          border: 2px solid var(--border-color);
          border-radius: 8px;
          font-size: 14px;
          color: var(--text-primary);
          background: var(--bg-secondary);
          transition: all 0.3s ease;
      }

      .form-input:focus,
      .form-select:focus,
      .form-textarea:focus {
          outline: none;
          border-color: var(--primary-green);
          box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1);
      }

      .form-textarea {
          resize: vertical;
          min-height: 100px;
      }

      .loading-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          z-index: 9999;
          align-items: center;
          justify-content: center;
      }

      .loading-overlay.show {
          display: flex;
      }

      .loader {
          border: 8px solid #f3f3f3;
          border-top: 8px solid var(--primary-green);
          border-radius: 50%;
          width: 60px;
          height: 60px;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          to { transform: rotate(360deg); }
      }

      .toast-container {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 3000;
      }

      .toast {
          background: var(--card-bg);
          border-radius: 12px;
          padding: 16px 20px;
          margin-bottom: 12px;
          box-shadow: var(--shadow-lg);
          border-left: 4px solid;
          animation: slideInRight 0.3s ease;
          max-width: 400px;
      }

      .toast.success { border-left-color: var(--success-color); }
      .toast.error { border-left-color: var(--error-color); }
      .toast.warning { border-left-color: var(--warning-color); }
      .toast.info { border-left-color: var(--info-color); }

      @keyframes slideInRight {
          from {
              opacity: 0;
              transform: translateX(100%);
          }
          to {
              opacity: 1;
              transform: translateX(0);
          }
      }

      .empty-state {
          text-align: center;
          padding: 60px 20px;
          color: var(--text-secondary);
      }

      .empty-state i {
          font-size: 64px;
          margin-bottom: 20px;
          opacity: 0.5;
      }

      .pagination {
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 8px;
          padding: 20px;
      }

      .pagination button {
          padding: 8px 12px;
          border: 1px solid var(--border-color);
          background: var(--bg-secondary);
          color: var(--text-primary);
          border-radius: 6px;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .pagination button:hover:not(:disabled) {
          background: var(--primary-green);
          color: white;
          border-color: var(--primary-green);
      }

      .pagination button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
      }

      .pagination .page-info {
          padding: 0 16px;
          color: var(--text-secondary);
          font-weight: 600;
      }

      ::-webkit-scrollbar {
          width: 8px;
          height: 8px;
      }

      ::-webkit-scrollbar-track {
          background: var(--bg-secondary);
      }

      ::-webkit-scrollbar-thumb {
          background: var(--primary-green);
          border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
          background: var(--primary-dark);
      }

      @media (max-width: 1200px) {
          .charts-section {
              grid-template-columns: 1fr;
          }
      }

      @media (max-width: 768px) {
          .sidebar {
              transform: translateX(-100%);
          }

          .sidebar.mobile-open {
              transform: translateX(0);
          }

          .main-content {
              margin-left: 0;
          }

          .header {
              padding: 0 16px;
          }

          .content {
              padding: 20px 16px;
          }

          .stats-grid {
              grid-template-columns: 1fr;
          }

          .profile-info {
              display: none;
          }

          .form-grid {
              grid-template-columns: 1fr;
          }
      }

    </style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
    <div class="loader"></div>
</div>

<div class="toast-container" id="toastContainer"></div>

<div class="dashboard-container">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <img src="images/logo.jpeg" alt="AgriGuard AI Logo" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2270%22%3EðŸŒ¾%3C/text%3E%3C/svg%3E'">
            </div>
            <div class="company-info">
                <div class="company-name">AgriGuard AI</div>
                <div class="company-tagline">Market Intelligence</div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3 class="nav-section-title">Market Analytics</h3>
                <ul class="nav-menu">
                    <li class="nav-item active">
                        <a class="nav-link" onclick="showSection('dashboard')">
                            <i class="fas fa-chart-line"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('prices')">
                            <i class="fas fa-tags"></i>
                            <span>Market Prices</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('analytics')">
                            <i class="fas fa-chart-bar"></i>
                            <span>Analytics</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('comparison')">
                            <i class="fas fa-balance-scale"></i>
                            <span>Price Comparison</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="nav-section">
                <h3 class="nav-section-title">Reports</h3>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('reports')">
                            <i class="fas fa-file-alt"></i>
                            <span>Generate Reports</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>

    <div class="main-content" id="mainContent">
        <header class="header">
            <div class="header-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="page-title-section">
                    <div class="page-icon">
                        <i class="fas fa-tags"></i>
                    </div>
                    <h1 class="page-title">Market Price Dashboard</h1>
                </div>
            </div>

            <div class="header-right">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
                    <i class="fas fa-moon"></i>
                    <span>Dark</span>
                </button>
                <div class="profile-section">
                    <div class="profile-avatar" id="profileAvatar">U</div>
                    <div class="profile-info">
                        <div class="profile-name" id="profileName">User</div>
                        <div class="profile-role" id="profileRole">Administrator</div>
                    </div>
                </div>
            </div>
        </header>

        <main class="content">
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon total">
                            <i class="fas fa-database"></i>
                        </div>
                        <div class="stat-value" id="totalPrices">0</div>
                        <div class="stat-label">Total Price Records</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon markets">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="stat-value" id="totalMarkets">0</div>
                        <div class="stat-label">Active Markets</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon crops">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-value" id="totalCrops">0</div>
                        <div class="stat-label">Tracked Crops</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon avg-price">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-value" id="avgPrice">0</div>
                        <div class="stat-label">Average Price/Kg</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon high-demand">
                            <i class="fas fa-arrow-trend-up"></i>
                        </div>
                        <div class="stat-value" id="highDemand">0</div>
                        <div class="stat-label">High Demand Items</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon opportunities">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="stat-value" id="opportunities">0</div>
                        <div class="stat-label">Market Opportunities</div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Market Type Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="marketTypeChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Price Trends</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="priceTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Demand vs Supply</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="demandSupplyChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Top 10 Markets by Volume</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="topMarketsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prices Section -->
            <div id="pricesSection" class="content-section" style="display:none;">
                <div class="table-section">
                    <div class="table-header">
                        <h2 class="table-title">Market Price Records</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="showAddPriceModal()">
                                <i class="fas fa-plus"></i>
                                Add Price
                            </button>
                            <button class="btn btn-secondary" onclick="loadMarketPrices()">
                                <i class="fas fa-sync-alt"></i>
                                Refresh
                            </button>
                            <button class="btn btn-info" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i>
                                Export
                            </button>
                        </div>
                    </div>

                    <div class="filter-bar">
                        <div class="filter-group">
                            <label class="filter-label">Crop</label>
                            <select class="filter-select" id="filterCrop" onchange="applyFilters()">
                                <option value="">All Crops</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Market Type</label>
                            <select class="filter-select" id="filterMarketType" onchange="applyFilters()">
                                <option value="">All Types</option>
                                <option value="WHOLESALE">Wholesale</option>
                                <option value="RETAIL">Retail</option>
                                <option value="FARM_GATE">Farm Gate</option>
                                <option value="EXPORT">Export</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Location</label>
                            <select class="filter-select" id="filterLocation" onchange="applyFilters()">
                                <option value="">All Locations</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Demand Level</label>
                            <select class="filter-select" id="filterDemand" onchange="applyFilters()">
                                <option value="">All Levels</option>
                                <option value="LOW">Low</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="HIGH">High</option>
                                <option value="VERY_HIGH">Very High</option>
                            </select>
                        </div>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                            <tr>
                                <th>Price ID</th>
                                <th>Crop</th>
                                <th>Market</th>
                                <th>Location</th>
                                <th>Price/Kg</th>
                                <th>Date</th>
                                <th>Demand</th>
                                <th>Trend</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="pricesTableBody">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Loading market prices...</p>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination" id="pagination">
                        <button onclick="previousPage()" id="prevBtn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="page-info" id="pageInfo">Page 1 of 1</span>
                        <button onclick="nextPage()" id="nextBtn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analyticsSection" class="content-section" style="display:none;">
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Monthly Average Prices</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="monthlyPricesChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Regional Price Analysis</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="regionalPricesChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Price Volatility</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="volatilityChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Market Type Comparison</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="marketComparisonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Section -->
            <div id="comparisonSection" class="content-section" style="display:none;">
                <div class="chart-card" style="margin-bottom: 24px;">
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">Price Comparison Tool</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Select Crop</label>
                            <select class="form-select" id="comparisonCrop">
                                <option value="">Select a crop</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="comparisonDate">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="comparePrices()" style="margin-top: 24px;">
                                <i class="fas fa-search"></i>
                                Compare Prices
                            </button>
                        </div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Price Comparison Results</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="comparisonChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Seasonal Price Patterns</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="seasonalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reportsSection" class="content-section" style="display:none;">
                <div class="chart-card" style="margin-bottom: 24px;">
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">Report Configuration</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Report Type</label>
                            <select class="form-select" id="reportType">
                                <option value="all">All Market Prices</option>
                                <option value="crop">By Crop</option>
                                <option value="market">By Market</option>
                                <option value="high-demand">High Demand</option>
                                <option value="opportunities">Market Opportunities</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Time Period</label>
                            <select class="form-select" id="reportPeriod">
                                <option value="7">Last 7 Days</option>
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="generatePDFReport()">
                            <i class="fas fa-file-pdf"></i>
                            Generate PDF
                        </button>
                        <button class="btn btn-info" onclick="generateExcelReport()">
                            <i class="fas fa-file-excel"></i>
                            Generate Excel
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Add/Edit Price Modal -->
<div class="modal" id="priceModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="priceModalTitle">Add Market Price</h2>
            <button class="modal-close" onclick="closePriceModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="priceForm" onsubmit="submitPriceForm(event)">
            <input type="hidden" id="priceId">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Crop *</label>
                    <select class="form-select" id="cropId" required>
                        <option value="">Select Crop</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Market Name *</label>
                    <input type="text" class="form-input" id="marketName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Market Type *</label>
                    <select class="form-select" id="marketType" required>
                        <option value="">Select Type</option>
                        <option value="WHOLESALE">Wholesale</option>
                        <option value="RETAIL">Retail</option>
                        <option value="FARM_GATE">Farm Gate</option>
                        <option value="EXPORT">Export</option>
                        <option value="COMMODITY_EXCHANGE">Commodity Exchange</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Location *</label>
                    <input type="text" class="form-input" id="location" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Price Date *</label>
                    <input type="date" class="form-input" id="priceDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Price per Kg (RWF) *</label>
                    <input type="number" class="form-input" id="pricePerKg" step="0.01" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Quality Grade</label>
                    <input type="text" class="form-input" id="qualityGrade">
                </div>
                <div class="form-group">
                    <label class="form-label">Demand Level</label>
                    <select class="form-select" id="demandLevel">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM" selected>Medium</option>
                        <option value="HIGH">High</option>
                        <option value="VERY_HIGH">Very High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Supply Level</label>
                    <select class="form-select" id="supplyLevel">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM" selected>Medium</option>
                        <option value="HIGH">High</option>
                        <option value="EXCESS">Excess</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Price Trend</label>
                    <select class="form-select" id="priceTrend">
                        <option value="INCREASING">Increasing</option>
                        <option value="STABLE" selected>Stable</option>
                        <option value="DECREASING">Decreasing</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Data Source *</label>
                    <input type="text" class="form-input" id="dataSource" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Reliability Score (1-5)</label>
                    <input type="number" class="form-input" id="reliabilityScore" min="1" max="5" value="5">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-textarea" id="notes"></textarea>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button type="button" class="btn btn-secondary" onclick="closePriceModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Price
                </button>
            </div>
        </form>
    </div>
</div>

<script src="js/SessionTracker.js"></script>
<script src="js/user_session_handler.js"></script>
<script >



    // Market Price Dashboard JavaScript
  // API Configuration
  const API_BASE_URL = 'http://localhost:1010/api/market-prices';
  const CROP_API_URL = 'http://localhost:1010/api/v1/crops';

  // Global State
  let allPrices = [];
  let filteredPrices = [];
  let allCrops = [];
  let charts = {};
  let currentPage = 1;
  let itemsPerPage = 10;
  let sessionHandler = null;
  let currentUser = null;

  // Initialize Session
  function initializeSession() {
      try {
          sessionHandler = UserSessionHandler.getInstance();
          currentUser = sessionHandler.getCurrentUser();

          if (!currentUser) {
              window.location.href = '/login.html';
              return false;
          }

          updateUIWithUser();
          return true;
      } catch (error) {
          console.error('Session error:', error);
          window.location.href = '/login.html';
          return false;
      }
  }

  function updateUIWithUser() {
      if (!currentUser) return;

      document.getElementById('profileName').textContent = currentUser.fullName || 'User';
      document.getElementById('profileRole').textContent = formatRole(currentUser.role);

      const initials = currentUser.fullName ? currentUser.fullName.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
      document.getElementById('profileAvatar').textContent = initials;

      if (currentUser.photo || currentUser.profileImageUrl) {
          const photoUrl = currentUser.photo || currentUser.profileImageUrl;
          const avatar = document.getElementById('profileAvatar');
          avatar.style.backgroundImage = `url(${photoUrl})`;
          avatar.style.backgroundSize = 'cover';
          avatar.textContent = '';
      }
  }

  function formatRole(role) {
      if (!role) return 'User';
      return role.split('_').map(w => w.charAt(0) + w.slice(1).toLowerCase()).join(' ');
  }

  // Initialize Dashboard
  document.addEventListener('DOMContentLoaded', function() {
      if (!initializeSession()) return;

      initializeDashboard();
      loadSavedTheme();
  });

  async function initializeDashboard() {
      showLoading(true);
      try {
          await Promise.all([
              loadAllCrops(),
              loadMarketPrices(),
              loadStatistics()
          ]);
          initializeCharts();
          populateFilters();
      } catch (error) {
          console.error('Error initializing dashboard:', error);
          showToast('Error loading dashboard data', 'error');
      } finally {
          showLoading(false);
      }
  }

  // Load All Crops for Dropdowns
  async function loadAllCrops() {
      try {
          const response = await fetch(`${CROP_API_URL}/all`);
          const result = await response.json();
          allCrops = result.data || [];
          populateCropDropdowns();
      } catch (error) {
          console.error('Error loading crops:', error);
          allCrops = [];
      }
  }

  function populateCropDropdowns() {
      const selects = ['cropId', 'filterCrop', 'comparisonCrop'];
      selects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
              const currentValue = select.value;
              select.innerHTML = selectId === 'cropId' ? '<option value="">Select Crop</option>' : '<option value="">All Crops</option>';
              allCrops.forEach(crop => {
                  const option = document.createElement('option');
                  option.value = crop.id;
                  option.textContent = `${crop.cropName} ${crop.variety ? '(' + crop.variety + ')' : ''}`;
                  select.appendChild(option);
              });
              if (currentValue) select.value = currentValue;
          }
      });
  }



// Load Market Prices
async function loadMarketPrices() {
    try {
        const response = await fetch(API_BASE_URL);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        // Handle both array and paginated response formats
        if (Array.isArray(data)) {
            allPrices = data;
        } else if (data.content && Array.isArray(data.content)) {
            allPrices = data.content;
        } else if (data.data && Array.isArray(data.data)) {
            allPrices = data.data;
        } else {
            console.error('Unexpected response format:', data);
            allPrices = [];
        }

        filteredPrices = [...allPrices];
        renderPricesTable();
    } catch (error) {
        console.error('Error loading prices:', error);
        allPrices = [];
        filteredPrices = [];
        document.getElementById('pricesTableBody').innerHTML = `
            <tr><td colspan="9" class="empty-state">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading market prices. Please check your API connection.</p>
            </td></tr>
        `;
    }
}
// Load Statistics
async function loadStatistics() {
    try {
        // Ensure allPrices is an array
        if (!Array.isArray(allPrices)) {
            allPrices = [];
        }

        // Get total count
        document.getElementById('totalPrices').textContent = allPrices.length;

        // Get unique markets
        const uniqueMarkets = [...new Set(allPrices.map(p => p.marketName))];
        document.getElementById('totalMarkets').textContent = uniqueMarkets.length;

        // Get unique crops
        const uniqueCrops = [...new Set(allPrices.map(p => p.cropId))];
        document.getElementById('totalCrops').textContent = uniqueCrops.length;

        // Calculate average price
        const avgPrice = allPrices.length > 0
            ? allPrices.reduce((sum, p) => sum + (p.pricePerKg || 0), 0) / allPrices.length
            : 0;
        document.getElementById('avgPrice').textContent = formatCurrency(avgPrice);

        // Count high demand
        const highDemandCount = allPrices.filter(p => p.demandLevel === 'HIGH' || p.demandLevel === 'VERY_HIGH').length;
        document.getElementById('highDemand').textContent = highDemandCount;

        // Count opportunities
        try {
            const response = await fetch(`${API_BASE_URL}/opportunities`);
            if (response.ok) {
                const opportunities = await response.json();
                const oppCount = Array.isArray(opportunities) ? opportunities.length : 0;
                document.getElementById('opportunities').textContent = oppCount;
            } else {
                document.getElementById('opportunities').textContent = '0';
            }
        } catch (error) {
            console.error('Error loading opportunities:', error);
            document.getElementById('opportunities').textContent = '0';
        }

    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}




  // Render Prices Table
  function renderPricesTable() {
      const tbody = document.getElementById('pricesTableBody');
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageData = filteredPrices.slice(start, end);

      if (pageData.length === 0) {
          tbody.innerHTML = `
              <tr><td colspan="9" class="empty-state">
                  <i class="fas fa-inbox"></i>
                  <p>No market prices found</p>
              </td></tr>
          `;
          return;
      }

      tbody.innerHTML = pageData.map(price => {
          const crop = allCrops.find(c => c.id === price.cropId);
          const cropName = crop ? crop.cropName : price.cropId;

          return `
              <tr>
                  <td><strong>${price.id}</strong></td>
                  <td>${cropName}</td>
                  <td>${price.marketName}</td>
                  <td>${price.location}</td>
                  <td><strong>${formatCurrency(price.pricePerKg)}</strong></td>
                  <td>${formatDate(price.priceDate)}</td>
                  <td><span class="status-badge demand-${price.demandLevel.toLowerCase()}">${formatEnum(price.demandLevel)}</span></td>
                  <td><span class="status-badge trend-${price.priceTrend.toLowerCase()}">${formatEnum(price.priceTrend)}</span></td>
                  <td>
                      <div class="action-buttons">
                          <button class="action-btn action-btn-view" onclick="viewPrice('${price.id}')" title="View">
                              <i class="fas fa-eye"></i>
                          </button>
                          <button class="action-btn action-btn-edit" onclick="editPrice('${price.id}')" title="Edit">
                              <i class="fas fa-edit"></i>
                          </button>
                          <button class="action-btn action-btn-delete" onclick="deletePrice('${price.id}')" title="Delete">
                              <i class="fas fa-trash"></i>
                          </button>
                      </div>
                  </td>
              </tr>
          `;
      }).join('');

      updatePagination();
  }

  // Pagination
  function updatePagination() {
      const totalPages = Math.ceil(filteredPrices.length / itemsPerPage);
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages;
  }

  function previousPage() {
      if (currentPage > 1) {
          currentPage--;
          renderPricesTable();
      }
  }

  function nextPage() {
      const totalPages = Math.ceil(filteredPrices.length / itemsPerPage);
      if (currentPage < totalPages) {
          currentPage++;
          renderPricesTable();
      }
  }

  // Populate Filters
  function populateFilters() {
      // Populate locations
      const locations = [...new Set(allPrices.map(p => p.location))].sort();
      const locationSelect = document.getElementById('filterLocation');
      locationSelect.innerHTML = '<option value="">All Locations</option>' +
          locations.map(l => `<option value="${l}">${l}</option>`).join('');
  }

  // Apply Filters
  function applyFilters() {
      const cropId = document.getElementById('filterCrop').value;
      const marketType = document.getElementById('filterMarketType').value;
      const location = document.getElementById('filterLocation').value;
      const demandLevel = document.getElementById('filterDemand').value;

      filteredPrices = allPrices.filter(price => {
          if (cropId && price.cropId !== cropId) return false;
          if (marketType && price.marketType !== marketType) return false;
          if (location && price.location !== location) return false;
          if (demandLevel && price.demandLevel !== demandLevel) return false;
          return true;
      });

      currentPage = 1;
      renderPricesTable();
  }






// Initialize Charts
function initializeCharts() {
    // Destroy existing charts before creating new ones
    Object.keys(charts).forEach(key => {
        if (charts[key] && typeof charts[key].destroy === 'function') {
            charts[key].destroy();
        }
    });
    charts = {};

    initializeMarketTypeChart();
    initializePriceTrendChart();
    initializeDemandSupplyChart();
    initializeTopMarketsChart();
    initializeMonthlyPricesChart();
    initializeRegionalPricesChart();
    initializeVolatilityChart();
    initializeMarketComparisonChart();
}

function initializeMarketTypeChart() {
    const ctx = document.getElementById('marketTypeChart');
    if (!ctx) return;

    // Destroy existing chart
    if (charts.marketType) {
        charts.marketType.destroy();
    }

    // Ensure allPrices is an array
    if (!Array.isArray(allPrices) || allPrices.length === 0) {
        return;
    }

    const marketTypeCounts = {};
    allPrices.forEach(price => {
        if (price.marketType) {
            marketTypeCounts[price.marketType] = (marketTypeCounts[price.marketType] || 0) + 1;
        }
    });

    if (Object.keys(marketTypeCounts).length === 0) {
        return;
    }

    charts.marketType = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(marketTypeCounts).map(formatEnum),
            datasets: [{
                data: Object.values(marketTypeCounts),
                backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function initializePriceTrendChart() {
    const ctx = document.getElementById('priceTrendChart');
    if (!ctx) return;

    // Destroy existing chart
    if (charts.priceTrend) {
        charts.priceTrend.destroy();
    }

    if (!Array.isArray(allPrices) || allPrices.length === 0) {
        return;
    }

    // Get last 30 days of data
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    const recentPrices = allPrices
        .filter(p => new Date(p.priceDate) >= thirtyDaysAgo)
        .sort((a, b) => new Date(a.priceDate) - new Date(b.priceDate));

    const dates = [...new Set(recentPrices.map(p => p.priceDate))].sort();
    const avgPrices = dates.map(date => {
        const dayPrices = recentPrices.filter(p => p.priceDate === date);
        return dayPrices.reduce((sum, p) => sum + p.pricePerKg, 0) / dayPrices.length;
    });

    charts.priceTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates.map(d => formatDate(d)),
            datasets: [{
                label: 'Average Price',
                data: avgPrices,
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function initializeDemandSupplyChart() {
    const ctx = document.getElementById('demandSupplyChart');
    if (!ctx) return;

    // Destroy existing chart
    if (charts.demandSupply) {
        charts.demandSupply.destroy();
    }

    if (!Array.isArray(allPrices) || allPrices.length === 0) {
        return;
    }

    const demandCounts = { LOW: 0, MEDIUM: 0, HIGH: 0, VERY_HIGH: 0 };
    const supplyCounts = { LOW: 0, MEDIUM: 0, HIGH: 0, EXCESS: 0 };

    allPrices.forEach(price => {
        if (price.demandLevel) demandCounts[price.demandLevel]++;
        if (price.supplyLevel) supplyCounts[price.supplyLevel]++;
    });

    charts.demandSupply = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Low', 'Medium', 'High', 'Very High/Excess'],
            datasets: [{
                label: 'Demand',
                data: Object.values(demandCounts),
                backgroundColor: '#22c55e'
            }, {
                label: 'Supply',
                data: [supplyCounts.LOW, supplyCounts.MEDIUM, supplyCounts.HIGH, supplyCounts.EXCESS],
                backgroundColor: '#3b82f6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function initializeTopMarketsChart() {
    const ctx = document.getElementById('topMarketsChart');
    if (!ctx) return;

    // Destroy existing chart
    if (charts.topMarkets) {
        charts.topMarkets.destroy();
    }

    if (!Array.isArray(allPrices) || allPrices.length === 0) {
        return;
    }

    const marketCounts = {};
    allPrices.forEach(price => {
        if (price.marketName) {
            marketCounts[price.marketName] = (marketCounts[price.marketName] || 0) + 1;
        }
    });

    const topMarkets = Object.entries(marketCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

    if (topMarkets.length === 0) return;

    charts.topMarkets = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: topMarkets.map(m => m[0]),
            datasets: [{
                label: 'Price Records',
                data: topMarkets.map(m => m[1]),
                backgroundColor: '#22c55e'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true }
            }
        }
    });
}

async function initializeMonthlyPricesChart() {
    const ctx = document.getElementById('monthlyPricesChart');
    if (!ctx) return;

    // Destroy existing chart
    if (charts.monthlyPrices) {
        charts.monthlyPrices.destroy();
    }

    if (!Array.isArray(allPrices) || allPrices.length === 0) {
        return;
    }

    try {
        const cropCounts = {};
        allPrices.forEach(p => {
            if (p.cropId) {
                cropCounts[p.cropId] = (cropCounts[p.cropId] || 0) + 1;
            }
        });

        const topCropId = Object.entries(cropCounts).sort((a, b) => b[1] - a[1])[0]?.[0];

        if (topCropId) {
            const response = await fetch(`${API_BASE_URL}/crop/${topCropId}/monthly-prices?year=2024`);
            if (!response.ok) return;

            const monthlyData = await response.json();

            charts.monthlyPrices = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Monthly Average',
                        data: monthlyData.map(m => m[1] || 0),
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading monthly prices:', error);
    }
}

async function initializeRegionalPricesChart() {
    const ctx = document.getElementById('regionalPricesChart');
    if (!ctx) return;

    // Destroy existing chart
    if (charts.regionalPrices) {
        charts.regionalPrices.destroy();
    }

    if (!Array.isArray(allPrices) || allPrices.length === 0) {
        return;
    }

    const locationAvgs = {};
    allPrices.forEach(price => {
        if (price.location && price.pricePerKg) {
            if (!locationAvgs[price.location]) {
                locationAvgs[price.location] = { sum: 0, count: 0 };
            }
            locationAvgs[price.location].sum += price.pricePerKg;
            locationAvgs[price.location].count++;
        }
    });

    const locations = Object.keys(locationAvgs).slice(0, 10);
    if (locations.length === 0) return;

    const avgPrices = locations.map(loc => locationAvgs[loc].sum / locationAvgs[loc].count);

    charts.regionalPrices = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: locations,
            datasets: [{
                label: 'Average Price',
                data: avgPrices,
                backgroundColor: '#3b82f6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

async function initializeVolatilityChart() {
    const ctx = document.getElementById('volatilityChart');
    if (!ctx) return;

    // Destroy existing chart
    if (charts.volatility) {
        charts.volatility.destroy();
    }

    if (!Array.isArray(allPrices) || allPrices.length === 0) {
        return;
    }

    try {
        const cropVolatility = {};
        const cropsByCrop = {};

        allPrices.forEach(price => {
            if (price.cropId && price.pricePerKg) {
                if (!cropsByCrop[price.cropId]) {
                    cropsByCrop[price.cropId] = [];
                }
                cropsByCrop[price.cropId].push(price.pricePerKg);
            }
        });

        Object.keys(cropsByCrop).forEach(cropId => {
            const prices = cropsByCrop[cropId];
            if (prices.length > 1) {
                const avg = prices.reduce((a, b) => a + b, 0) / prices.length;
                const variance = prices.reduce((sum, price) => sum + Math.pow(price - avg, 2), 0) / prices.length;
                const stdDev = Math.sqrt(variance);
                cropVolatility[cropId] = (stdDev / avg) * 100;
            }
        });

        const topVolatile = Object.entries(cropVolatility)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);

        if (topVolatile.length === 0) return;

        const cropNames = topVolatile.map(([cropId]) => {
            const crop = allCrops.find(c => c.id === cropId);
            return crop ? crop.cropName : cropId;
        });

        charts.volatility = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: cropNames,
                datasets: [{
                    label: 'Volatility (%)',
                    data: topVolatile.map(v => v[1]),
                    backgroundColor: '#ef4444'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    } catch (error) {
        console.error('Error loading volatility chart:', error);
    }
}

async function initializeMarketComparisonChart() {
    const ctx = document.getElementById('marketComparisonChart');
    if (!ctx) return;

    // Destroy existing chart
    if (charts.marketComparison) {
        charts.marketComparison.destroy();
    }

    if (!Array.isArray(allPrices) || allPrices.length === 0) {
        return;
    }

    const marketTypeAvgs = {};
    const marketTypeCounts = {};

    allPrices.forEach(price => {
        if (price.marketType && price.pricePerKg) {
            if (!marketTypeAvgs[price.marketType]) {
                marketTypeAvgs[price.marketType] = 0;
                marketTypeCounts[price.marketType] = 0;
            }
            marketTypeAvgs[price.marketType] += price.pricePerKg;
            marketTypeCounts[price.marketType]++;
        }
    });

    const marketTypes = Object.keys(marketTypeAvgs);
    if (marketTypes.length === 0) return;

    const avgPrices = marketTypes.map(type => marketTypeAvgs[type] / marketTypeCounts[type]);

    charts.marketComparison = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: marketTypes.map(formatEnum),
            datasets: [{
                label: 'Average Price',
                data: avgPrices,
                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                borderColor: '#22c55e'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}




  // Price Comparison
  async function comparePrices() {
      const cropId = document.getElementById('comparisonCrop').value;
      const date = document.getElementById('comparisonDate').value;

      if (!cropId || !date) {
          showToast('Please select both crop and date', 'warning');
          return;
      }

      try {
          showLoading(true);
          const response = await fetch(`${API_BASE_URL}/crop/${cropId}/price-comparison?date=${date}`);
          const comparisonData = await response.json();

          if (comparisonData.length === 0) {
              showToast('No price data found for comparison', 'info');
              return;
          }

          // Update comparison chart
          const ctx = document.getElementById('comparisonChart');
          if (charts.comparison) {
              charts.comparison.destroy();
          }

          charts.comparison = new Chart(ctx, {
              type: 'bar',
              data: {
                  labels: comparisonData.map(d => d[0]), // Market names
                  datasets: [{
                      label: 'Price per Kg',
                      data: comparisonData.map(d => d[1]), // Prices
                      backgroundColor: '#22c55e'
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      y: { beginAtZero: true }
                  }
              }
          });

          // Load seasonal data
          await loadSeasonalChart(cropId);

          showToast('Price comparison loaded successfully', 'success');
      } catch (error) {
          console.error('Error comparing prices:', error);
          showToast('Error loading price comparison', 'error');
      } finally {
          showLoading(false);
      }
  }

  async function loadSeasonalChart(cropId) {
      try {
          const response = await fetch(`${API_BASE_URL}/crop/${cropId}/seasonal-prices`);
          const seasonalData = await response.json();

          const ctx = document.getElementById('seasonalChart');
          if (charts.seasonal) {
              charts.seasonal.destroy();
          }

          const monthlyAvgs = Array(12).fill(0);
          const monthlyCounts = Array(12).fill(0);

          seasonalData.forEach(price => {
              const month = new Date(price.priceDate).getMonth();
              monthlyAvgs[month] += price.pricePerKg;
              monthlyCounts[month]++;
          });

          const avgPrices = monthlyAvgs.map((sum, i) =>
              monthlyCounts[i] > 0 ? sum / monthlyCounts[i] : 0
          );

          charts.seasonal = new Chart(ctx, {
              type: 'line',
              data: {
                  labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                  datasets: [{
                      label: 'Seasonal Average',
                      data: avgPrices,
                      borderColor: '#3b82f6',
                      backgroundColor: 'rgba(59, 130, 246, 0.1)',
                      tension: 0.4,
                      fill: true
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                      y: { beginAtZero: true }
                  }
              }
          });
      } catch (error) {
          console.error('Error loading seasonal chart:', error);
      }
  }

  // Modal Functions
  function showAddPriceModal() {
      document.getElementById('priceModalTitle').textContent = 'Add Market Price';
      document.getElementById('priceForm').reset();
      document.getElementById('priceId').value = '';
      document.getElementById('priceDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('priceModal').classList.add('show');
  }

  function closePriceModal() {
      document.getElementById('priceModal').classList.remove('show');
  }

  async function submitPriceForm(event) {
      event.preventDefault();

      const formData = {
          cropId: document.getElementById('cropId').value,
          marketName: document.getElementById('marketName').value.trim(),
          marketType: document.getElementById('marketType').value,
          location: document.getElementById('location').value.trim(),
          priceDate: document.getElementById('priceDate').value,
          pricePerKg: parseFloat(document.getElementById('pricePerKg').value),
          qualityGrade: document.getElementById('qualityGrade').value.trim() || null,
          demandLevel: document.getElementById('demandLevel').value,
          supplyLevel: document.getElementById('supplyLevel').value,
          priceTrend: document.getElementById('priceTrend').value,
          dataSource: document.getElementById('dataSource').value.trim(),
          reliabilityScore: parseInt(document.getElementById('reliabilityScore').value),
          notes: document.getElementById('notes').value.trim() || null
      };

      const priceId = document.getElementById('priceId').value;

      try {
          showLoading(true);
          const url = priceId ? `${API_BASE_URL}/${priceId}` : API_BASE_URL;
          const method = priceId ? 'PUT' : 'POST';

          const response = await fetch(url, {
              method: method,
              headers: {
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
              },
              body: JSON.stringify(formData)
          });

          if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
          }

          showToast(priceId ? 'Price updated successfully' : 'Price created successfully', 'success');
          closePriceModal();
          await loadMarketPrices();
          await loadStatistics();
          initializeCharts();
      } catch (error) {
          console.error('Error saving price:', error);
          showToast('Error saving price', 'error');
      } finally {
          showLoading(false);
      }
  }

  async function editPrice(id) {
      try {
          const price = allPrices.find(p => p.id === id);
          if (!price) return;

          document.getElementById('priceModalTitle').textContent = 'Edit Market Price';
          document.getElementById('priceId').value = price.id;
          document.getElementById('cropId').value = price.cropId || '';
          document.getElementById('marketName').value = price.marketName || '';
          document.getElementById('marketType').value = price.marketType || '';
          document.getElementById('location').value = price.location || '';
          document.getElementById('priceDate').value = price.priceDate || '';
          document.getElementById('pricePerKg').value = price.pricePerKg || '';
          document.getElementById('qualityGrade').value = price.qualityGrade || '';
          document.getElementById('demandLevel').value = price.demandLevel || 'MEDIUM';
          document.getElementById('supplyLevel').value = price.supplyLevel || 'MEDIUM';
          document.getElementById('priceTrend').value = price.priceTrend || 'STABLE';
          document.getElementById('dataSource').value = price.dataSource || '';
          document.getElementById('reliabilityScore').value = price.reliabilityScore || 5;
          document.getElementById('notes').value = price.notes || '';

          document.getElementById('priceModal').classList.add('show');
      } catch (error) {
          console.error('Error loading price:', error);
          showToast('Error loading price', 'error');
      }
  }

  async function viewPrice(id) {
      await editPrice(id);
      document.querySelectorAll('#priceForm input, #priceForm select, #priceForm textarea').forEach(el => {
          el.disabled = true;
      });
      document.getElementById('priceModalTitle').textContent = 'View Market Price';
  }

  async function deletePrice(id) {
      if (!confirm('Are you sure you want to delete this price record?')) return;

      try {
          showLoading(true);
          const response = await fetch(`${API_BASE_URL}/${id}`, { method: 'DELETE' });

          if (response.ok) {
              showToast('Price deleted successfully', 'success');
              await loadMarketPrices();
              await loadStatistics();
              initializeCharts();
          } else {
              showToast('Error deleting price', 'error');
          }
      } catch (error) {
          console.error('Error deleting price:', error);
          showToast('Error deleting price', 'error');
      } finally {
          showLoading(false);
      }
  }

  // Export Functions
  async function exportToExcel() {
      try {
          if (filteredPrices.length === 0) {
              showToast('No data to export', 'warning');
              return;
          }

          const exportData = await Promise.all(filteredPrices.map(async (price, index) => {
              const crop = allCrops.find(c => c.id === price.cropId);
              return {
                  '#': index + 1,
                  'Price ID': price.id,
                  'Crop': crop ? crop.cropName : price.cropId,
                  'Market Name': price.marketName,
                  'Market Type': formatEnum(price.marketType),
                  'Location': price.location,
                  'Price per Kg': price.pricePerKg,
                  'Date': formatDate(price.priceDate),
                  'Quality': price.qualityGrade || 'N/A',
                  'Demand': formatEnum(price.demandLevel),
                  'Supply': formatEnum(price.supplyLevel),
                  'Trend': formatEnum(price.priceTrend),
                  'Reliability': price.reliabilityScore
              };
          }));

          const ws = XLSX.utils.json_to_sheet(exportData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Market Prices');
          XLSX.writeFile(wb, `market_prices_${Date.now()}.xlsx`);

          showToast('Excel file exported successfully', 'success');
      } catch (error) {
          console.error('Error exporting to Excel:', error);
          showToast('Error exporting to Excel', 'error');
      }
  }

  async function generatePDFReport() {
      try {
          showLoading(true);

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          const reportType = document.getElementById('reportType').value;
          let reportData = await getReportData(reportType);

          doc.setFontSize(20);
          doc.text('Market Price Report', 105, 25, { align: 'center' });

          doc.setFontSize(12);
          doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 35, { align: 'center' });
          doc.text(`Generated by: ${currentUser.fullName}`, 105, 42, { align: 'center' });
          doc.text(`Total Records: ${reportData.length}`, 105, 49, { align: 'center' });

          const tableData = await Promise.all(reportData.map(async (price, index) => {
              const crop = allCrops.find(c => c.id === price.cropId);
              return [
                  index + 1,
                  price.id.substring(0, 8),
                  crop ? crop.cropName : 'N/A',
                  price.marketName,
                  formatCurrency(price.pricePerKg),
                  formatDate(price.priceDate),
                  formatEnum(price.demandLevel)
              ];
          }));

          doc.autoTable({
              startY: 55,
              head: [['#', 'ID', 'Crop', 'Market', 'Price', 'Date', 'Demand']],
              body: tableData,
              theme: 'grid',
              headStyles: { fillColor: [34, 197, 94] }
          });

          doc.save(`market_price_report_${Date.now()}.pdf`);
          showToast('PDF report generated successfully', 'success');
      } catch (error) {
          console.error('Error generating PDF:', error);
          showToast('Error generating PDF report', 'error');
      } finally {
          showLoading(false);
      }
  }

  async function generateExcelReport() {
      await exportToExcel();
  }

  async function getReportData(type) {
      let data = [...allPrices];
      const period = document.getElementById('reportPeriod').value;

      switch(type) {
          case 'crop':
              // Group by crop
              break;
          case 'market':
              // Group by market
              break;
          case 'high-demand':
              data = data.filter(p => p.demandLevel === 'HIGH' || p.demandLevel === 'VERY_HIGH');
              break;
          case 'opportunities':
              const response = await fetch(`${API_BASE_URL}/opportunities`);
              data = await response.json();
              break;
      }

      if (period !== 'custom') {
          const days = parseInt(period);
          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - days);
          data = data.filter(p => new Date(p.priceDate) >= cutoffDate);
      }

      return data;
  }

  // Navigation
  function showSection(section) {
      document.querySelectorAll('.content-section').forEach(el => {
          el.style.display = 'none';
      });
      document.getElementById(section + 'Section').style.display = 'block';

      document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
      });
      event.target.closest('.nav-item').classList.add('active');
  }

  function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('collapsed');
      document.getElementById('mainContent').classList.toggle('sidebar-collapsed');
  }

  function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      document.getElementById('themeToggle').innerHTML = isDark ?
          '<i class="fas fa-sun"></i><span>Light</span>' :
          '<i class="fas fa-moon"></i><span>Dark</span>';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
  }

  function loadSavedTheme() {
      if (localStorage.getItem('theme') === 'dark') {
          document.body.classList.add('dark-mode');
          document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i><span>Light</span>';
      }
  }

  // Utility Functions
  function formatEnum(value) {
      if (!value) return 'N/A';
      return value.split('_').map(w => w.charAt(0) + w.slice(1).toLowerCase()).join(' ');
  }

  function formatDate(dateString) {
      if (!dateString) return 'N/A';
      return new Date(dateString).toLocaleDateString();
  }

  function formatCurrency(value) {
      if (!value) return 'RWF 0';
      return `RWF ${value.toFixed(2)}`;
  }

  function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('show', show);
  }

  function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<p>${message}</p>`;
      document.getElementById('toastContainer').appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
  }

</script>
</body>
</html>
